/*
 * Playcanvas Engine v1.27.4 revision f191d82
 * Copyright 2011-2020 PlayCanvas Ltd. All rights reserved.
 */
;(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    } else if (typeof module === 'object' && module.exports) {
        module.exports = factory();
    } else {
        root.pc = factory();
    }
}(this, function () {

Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(d,b){if(null==this)throw TypeError('"this" is null or not defined');var a=Object(this),c=a.length>>>0;if("function"!==typeof d)throw TypeError("predicate must be a function");for(var e=0;e<c;){var f=a[e];if(d.call(b,f,e,a))return f;e++}},configurable:!0,writable:!0});Math.log2=Math.log2||function(d){return Math.log(d)*Math.LOG2E};Math.sign||(Math.sign=function(d){return(0<d)-(0>d)||+d});"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(d,b){if(null==d)throw new TypeError("Cannot convert undefined or null to object");for(var a=Object(d),c=1;c<arguments.length;c++){var e=arguments[c];if(null!=e)for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(a[f]=e[f])}return a},writable:!0,configurable:!0});(function(){if("undefined"!==typeof navigator&&"undefined"!==typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var d=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",d,!1);document.addEventListener("webkitpointerlocklost",
d,!1);document.addEventListener("mozpointerlockchange",d,!1);document.addEventListener("mozpointerlocklost",d,!1);document.addEventListener("webkitpointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&
navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,d,b)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}})();(function(){if("undefined"!==typeof window){for(var d=0,b=["ms","moz","webkit","o"],a=0;a<b.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[b[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[a]+"CancelAnimationFrame"]||window[b[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,b){var c=(new Date).getTime(),e=Math.max(0,16-(c-d));b=window.setTimeout(function(){a(c+e)},e);d=c+e;return b});window.cancelAnimationFrame||
(window.cancelAnimationFrame=function(a){clearTimeout(a)})}})();String.prototype.endsWith||(String.prototype.endsWith=function(d,b){if(void 0===b||b>this.length)b=this.length;return this.substring(b-d.length,b)===d});String.prototype.includes||(String.prototype.includes=function(d,b){"number"!==typeof b&&(b=0);return b+d.length>this.length?!1:-1!==this.indexOf(d,b)});String.prototype.startsWith||(String.prototype.startsWith=function(d,b){return this.substr(!b||0>b?0:+b,d.length)===d});var _typeLookup=function(){for(var d={},b="Array Object Function Date RegExp Float32Array".split(" "),a=0;a<b.length;a++)d["[object "+b[a]+"]"]=b[a].toLowerCase();return d}(),pc={version:"1.27.4",revision:"f191d82",config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(d){var b,a=[],c=d.length;for(b=0;b<c;++b)a.push(d[b]);return a},type:function(d){if(null===
d)return"null";var b=typeof d;return"undefined"===b||"number"===b||"string"===b||"boolean"===b?b:_typeLookup[Object.prototype.toString.call(d)]},extend:function(d,b){var a;for(a in b){var c=b[a];"object"==pc.type(c)?d[a]=pc.extend({},c):"array"==pc.type(c)?d[a]=pc.extend([],c):d[a]=c}return d},isDefined:function(d){return void 0!==d}};"undefined"!==typeof exports&&(exports.pc=pc);Object.assign(pc,function(){var d=function(b,a,c,e){var f=b&&b.length;3===f||4===f?(this.r=b[0],this.g=b[1],this.b=b[2],this.a=void 0!==b[3]?b[3]:1):(this.r=b||0,this.g=a||0,this.b=c||0,this.a=void 0!==e?e:1)};Object.assign(d.prototype,{clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(b){this.r=b.r;this.g=b.g;this.b=b.b;this.a=b.a;return this},set:function(b,a,c,e){this.r=b;this.g=a;this.b=c;this.a=void 0===e?1:e;return this},lerp:function(b,a,c){this.r=b.r+c*(a.r-
b.r);this.g=b.g+c*(a.g-b.g);this.b=b.b+c*(a.b-b.b);this.a=b.a+c*(a.a-b.a);return this},fromString:function(b){var a=parseInt(b.replace("#","0x"),16);7<b.length?b=pc.math.intToBytes32(a):(b=pc.math.intToBytes24(a),b[3]=255);this.set(b[0]/255,b[1]/255,b[2]/255,b[3]/255);return this},toString:function(b){var a="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);!0===b&&(b=Math.round(255*this.a).toString(16),a=this.a<16/255?a+("0"+b):a+
b);return a}});return{Color:d}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=16*Math.random()|0;return("x"==d?b:b&3|8).toString(16)})}}}();Object.assign(pc,function(){var d=function(){this._isRunning=!1;this._b=this._a=0};Object.assign(d.prototype,{start:function(){this._isRunning=!0;this._a=pc.now()},stop:function(){this._isRunning=!1;this._b=pc.now()},getMilliseconds:function(){return this._b-this._a}});return{Timer:d,now:"undefined"!==typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now}}());Object.assign(pc,function(){return{hashCode:function(d){for(var b=0,a=0,c=d.length;a<c;a++)b=(b<<5)-b+d.charCodeAt(a),b|=0;return b}}}());Object.assign(pc,function(){return{createURI:function(d){var b="";if((d.authority||d.scheme)&&(d.host||d.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(d.host&&d.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(d.path&&d.hostpath)throw Error("Can't have 'path' and 'hostpath' option");d.scheme&&(b+=d.scheme+":");d.authority&&(b+="//"+d.authority);d.host&&(b+=d.host);d.path&&(b+=d.path);d.hostpath&&(b+=d.hostpath);d.query&&(b+="?"+d.query);
d.fragment&&(b+="#"+d.fragment);return b},URI:function(d){d=d.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=d[2];this.authority=d[4];this.path=d[5];this.query=d[7];this.fragment=d[9];this.toString=function(){var b="";this.scheme&&(b+=this.scheme+":");this.authority&&(b+="//"+this.authority);b+=this.path;this.query&&(b+="?"+this.query);this.fragment&&(b+="#"+this.fragment);return b};this.getQuery=function(){var b,a={};if(this.query){var c=decodeURIComponent(this.query).split("&");
c.forEach(function(c,f,g){b=c.split("=");a[b[0]]=b[1]},this)}return a};this.setQuery=function(b){var a="",c;for(c in b)b.hasOwnProperty(c)&&(""!==a&&(a+="&"),a+=encodeURIComponent(c)+"="+encodeURIComponent(b[c]));this.query=a}}}}());Object.assign(pc,function(){return{log:{write:function(d){console.log(d)},open:function(){pc.log.write("Powered by PlayCanvas "+pc.version+" "+pc.revision)},info:function(d){console.info("INFO:    "+d)},debug:function(d){console.debug("DEBUG:   "+d)},error:function(d){console.error("ERROR:   "+d)},warning:function(d){console.warn("WARNING: "+d)},alert:function(d){pc.log.write("ALERT:   "+d);alert(d)},assert:function(d,b){!1===d&&pc.log.write("ASSERT:  "+b)}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;pc.path=function(){return{delimiter:"/",join:function(){var d,b=arguments.length,a=arguments[0];for(d=0;d<b-1;++d){var c=arguments[d],e=arguments[d+1];if(!pc.isDefined(c)||!pc.isDefined(e))throw Error("undefined argument to pc.path.join");a=e[0]===pc.path.delimiter?e:c&&e&&c[c.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?a+(pc.path.delimiter+e):a+e}return a},normalize:function(d){var b=d.startsWith(pc.path.delimiter),a=d.endsWith(pc.path.delimiter);d=d.split("/");for(var c=[],e=0;e<d.length;e++)""!==
d[e]&&"."!==d[e]&&(".."===d[e]&&0<c.length?c=c.slice(0,c.length-2):(0<e&&c.push(pc.path.delimiter),c.push(d[e])));d=c.join("");b||d[0]!==pc.path.delimiter||(d=d.slice(1));a&&d[d.length-1]!==pc.path.delimiter&&(d+=pc.path.delimiter);return d},split:function(d){d=d.split(pc.path.delimiter);var b=d.slice(d.length-1)[0];return[d.slice(0,d.length-1).join(pc.path.delimiter),b]},getBasename:function(d){return pc.path.split(d)[1]},getDirectory:function(d){d=d.split(pc.path.delimiter);return d.slice(0,d.length-
1).join(pc.path.delimiter)},getExtension:function(d){var b=d.split("?")[0].split(".").pop();return b!==d?"."+b:""},isRelativePath:function(d){return"/"!==d.charAt(0)&&null===d.match(/:\/\//)},extractPath:function(d){var b="",a=d.split("/");if(1<a.length)if(pc.path.isRelativePath(d))if("."===a[0])for(d=0;d<a.length-1;++d)b+=0===d?a[d]:"/"+a[d];else if(".."===a[0])for(d=0;d<a.length-1;++d)b+=0===d?a[d]:"/"+a[d];else for(b=".",d=0;d<a.length-1;++d)b+="/"+a[d];else for(d=0;d<a.length-1;++d)b+=0===d?a[d]:
"/"+a[d];return b}}}();pc.string=function(){function d(a,b){var c=a.length;b=b||0;if(0>b||b>=c)return null;var f=a.charCodeAt(b);return 1<c&&55296<=f&&56319>=f&&(a=a.charCodeAt(b+1),56320<=a&&57343>=a)?{code:1024*(f-55296)+a-56320+65536,long:!0}:{code:f,long:!1}}function b(a,b,e){return a?(a=d(a))?(a=a.code,a>=b&&a<=e):!1:!1}return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(a){var b,e=pc.makeArray(arguments);
e.shift();for(b=0;b<e.length;b++){var f=new RegExp("\\{"+b+"\\}","gi");a=a.replace(f,e[b])}return a},toBool:function(a,b){if("true"===a)return!0;if(b){if("false"===a)return!1;throw new TypeError("Not a boolean string");}return!1},getCodePoint:function(a,b){return(a=d(a,b))&&a.code},getCodePoints:function(a){if("string"!==typeof a)throw new TypeError("Not a string");for(var b=0,e=[],f;f=d(a,b);)e.push(f.code),b+=f.long?2:1;return e},getSymbols:function(a){if("string"!==typeof a)throw new TypeError("Not a string");
for(var c=0,e=a.length,f=[],g=0,d;c<e;){d=g;var k=a,h=c+g;h===k.length-1?g=1:b(k[h],55296,56319)?(g=k.substring(h,h+2),k=k.substring(h+2,h+4),g=b(k,127995,127999)||b(g,127462,127487)&&b(k,127462,127487)?4:b(k,65024,65039)?3:2):g=b(k[h+1],65024,65039)?2:1;g=d+g;d=a[c+g];b(d,8400,8447)&&(d=a[c+g++]);b(d,65024,65039)&&(d=a[c+g++]);d&&8205===d.charCodeAt(0)?g++:(d=a.substring(c,c+g),f.push(d),c+=g,g=0)}return f},fromCodePoint:function(){for(var a=[],b,e,f=0;f<arguments.length;++f)b=Number(arguments[f]),
e=b-65536,b=65535<b?[(e>>10)+55296,e%1024+56320]:[b],a.push(String.fromCharCode.apply(null,b));return a.join("")}}}();pc.debug=function(){var d=null,b=null,a=null,c=null;return{display:function(e){d||(d=document.createElement("table"),b=document.createElement("tr"),a=document.createElement("td"),c=document.createElement("td"),d.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",d.style.top="0px",d.style.left="0px",d.style.border="thin solid #cccccc",document.body.appendChild(d));d.innerHTML="";for(var f in e){var g=b.cloneNode(),n=a.cloneNode(),k=c.cloneNode();n.textContent=f;k.textContent=
e[f];g.appendChild(n);g.appendChild(k);d.appendChild(g)}}}}();Object.assign(pc,function(){var d=function(){this._callbacks={};this._callbackActive={}};Object.assign(d.prototype,{_addCallback:function(b,a,c,e){b&&"string"===typeof b&&a&&(this._callbacks[b]||(this._callbacks[b]=[]),this._callbackActive[b]&&this._callbackActive[b]===this._callbacks[b]&&(this._callbackActive[b]=this._callbackActive[b].slice()),this._callbacks[b].push({callback:a,scope:c||this,once:e||!1}))},on:function(b,a,c){this._addCallback(b,a,c,!1);return this},off:function(b,a,c){if(b)this._callbackActive[b]&&
this._callbackActive[b]===this._callbacks[b]&&(this._callbackActive[b]=this._callbackActive[b].slice());else for(var e in this._callbackActive)this._callbacks[e]&&this._callbacks[e]===this._callbackActive[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());if(b)if(a){b=this._callbacks[b];if(!b)return this;e=b.length;for(var f=0;f<e;f++)b[f].callback===a&&(c&&b[f].scope!==c||(b[f--]=b[--e]));b.length=e}else this._callbacks[b]&&(this._callbacks[b]=[]);else this._callbacks={};return this},
fire:function(b,a,c,e,f,g,d,k,h){if(!b||!this._callbacks[b])return this;if(this._callbackActive[b]){this._callbackActive[b]===this._callbacks[b]&&(this._callbackActive[b]=this._callbackActive[b].slice());var n=this._callbacks[b].slice()}else this._callbackActive[b]=this._callbacks[b];for(var l=0;(n||this._callbackActive[b])&&l<(n||this._callbackActive[b]).length;l++){var p=(n||this._callbackActive[b])[l];p.callback.call(p.scope,a,c,e,f,g,d,k,h);p.once&&(p=this._callbacks[b].indexOf(p),-1!==p&&(this._callbackActive[b]===
this._callbacks[b]&&(this._callbackActive[b]=this._callbackActive[b].slice()),this._callbacks[b].splice(p,1)))}n||(this._callbackActive[b]=null);return this},once:function(b,a,c){this._addCallback(b,a,c,!0);return this},hasEvent:function(b){return this._callbacks[b]&&0!==this._callbacks[b].length||!1}});return{EventHandler:d}}());pc.events={attach:function(d){var b=pc.events;d._addCallback=b._addCallback;d.on=b.on;d.off=b.off;d.fire=b.fire;d.once=b.once;d.hasEvent=b.hasEvent;d._callbacks={};d._callbackActive={};return d},_addCallback:pc.EventHandler.prototype._addCallback,on:pc.EventHandler.prototype.on,off:pc.EventHandler.prototype.off,fire:pc.EventHandler.prototype.fire,once:pc.EventHandler.prototype.once,hasEvent:pc.EventHandler.prototype.hasEvent};Object.assign(pc,function(){var d=function(a){this._index={};this._key=a||null};Object.assign(d.prototype,{addItem:function(a){for(var b=a.tags._list,e=0;e<b.length;e++)this.add(b[e],a)},removeItem:function(a){for(var b=a.tags._list,e=0;e<b.length;e++)this.remove(b[e],a)},add:function(a,b){this._index[a]&&-1!==this._index[a].list.indexOf(b)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(b),this._key&&(this._index[a].keys[b[this._key]]=b))},
remove:function(a,b){if(this._index[a]&&(!this._key||this._index[a].keys[b[this._key]])){var c=this._index[a].indexOf(b);-1!==c&&(this._index[a].list.splice(c,1),this._key&&delete this._index[a].keys[b[this._key]],0===this._index[a].list.length&&delete this._index[a])}},find:function(a){var b=this,e={},f=[],g,d,k=function(a,c){return b._index[a].list.length-b._index[c].list.length};for(g=0;g<a.length;g++){var h=a[g];if(h instanceof Array){if(0===h.length)continue;if(1===h.length)h=h[0];else{var m=
!1;for(d=0;d<h.length;d++)if(!this._index[h[d]]){m=!0;break}if(m)continue;h=h.slice(0).sort(k);var l=h.slice(1);1===l.length&&(l=l[0]);for(d=0;d<this._index[h[0]].list.length;d++)m=this._index[h[0]].list[d],(this._key?!e[m[this._key]]:-1===f.indexOf(m))&&m.tags.has(l)&&(this._key&&(e[m[this._key]]=!0),f.push(m));continue}}if(h&&"string"===typeof h&&this._index[h])for(d=0;d<this._index[h].list.length;d++)m=this._index[h].list[d],this._key?e[m[this._key]]||(e[m[this._key]]=!0,f.push(m)):-1===f.indexOf(m)&&
f.push(m)}return f}});var b=function(a){pc.EventHandler.call(this);this._index={};this._list=[];this._parent=a};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;Object.assign(b.prototype,{add:function(){var a=!1,b=this._processArguments(arguments,!0);if(!b.length)return a;for(var e=0;e<b.length;e++)this._index[b[e]]||(a=!0,this._index[b[e]]=!0,this._list.push(b[e]),this.fire("add",b[e],this._parent));a&&this.fire("change",this._parent);return a},remove:function(){var a=
!1;if(!this._list.length)return a;var b=this._processArguments(arguments,!0);if(!b.length)return a;for(var e=0;e<b.length;e++)this._index[b[e]]&&(a=!0,delete this._index[b[e]],this._list.splice(this._list.indexOf(b[e]),1),this.fire("remove",b[e],this._parent));a&&this.fire("change",this._parent);return a},clear:function(){if(this._list.length){var a=this._list.slice(0);this._list=[];this._index={};for(var b=0;b<a.length;b++)this.fire("remove",a[b],this._parent);this.fire("change",this._parent)}},
has:function(){return this._list.length?this._has(this._processArguments(arguments)):!1},_has:function(a){if(!this._list.length||!a.length)return!1;for(var b=0;b<a.length;b++)if(1===a[b].length){if(this._index[a[b][0]])return!0}else{for(var e=!0,f=0;f<a[b].length;f++)if(!this._index[a[b][f]]){e=!1;break}if(e)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(a,b){var c=[],f=[];if(!a||!a.length)return c;for(var g=0;g<a.length;g++)if(a[g]instanceof Array){b||(f=
[]);for(var d=0;d<a[g].length;d++)"string"===typeof a[g][d]&&(b?c.push(a[g][d]):f.push(a[g][d]));!b&&f.length&&c.push(f)}else"string"===typeof a[g]&&(b?c.push(a[g]):c.push([a[g]]));return c}});Object.defineProperty(b.prototype,"size",{get:function(){return this._list.length}});return{TagsCache:d,Tags:b}}());Object.assign(pc,function(){var d=function(b,a){this._constructor=b;this._pool=[];this._count=0;this._resize(a)};Object.assign(d.prototype,{_resize:function(b){if(b>this._pool.length)for(var a=this._pool.length;a<b;a++)this._pool[a]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}});return{AllocatePool:d}}());Object.assign(pc,function(){var d={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!==typeof navigator){var b=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(b)&&(d.desktop=!0);/xbox/i.test(b)&&(d.xbox=!0);/(windows phone|iemobile|wpdesktop)/i.test(b)?(d.desktop=!1,d.mobile=!0,d.windows=!0):/android/i.test(b)?(d.desktop=!1,d.mobile=!0,d.android=!0):/ip([ao]d|hone)/i.test(b)&&(d.desktop=!1,d.mobile=!0,d.ios=!0);"undefined"!==
typeof window&&(d.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints);d.gamepads="getGamepads"in navigator;d.workers="undefined"!==typeof Worker;try{var a=Object.defineProperty({},"passive",{get:function(){d.passiveEvents=!0;return!1}});window.addEventListener("testpassive",null,a);window.removeEventListener("testpassive",null,a)}catch(c){}}return{platform:d}}());Object.assign(pc,function(){var d=function(){this._list=[];this._index={}};Object.assign(d.prototype,{push:function(b,a){if(this._index[b])throw Error("Key already in index "+b);a=this._list.push(a)-1;this._index[b]=a},has:function(b){return void 0!==this._index[b]},get:function(b){b=this._index[b];return void 0!==b?this._list[b]:null},remove:function(b){var a=this._index[b];if(void 0!==a){this._list.splice(a,1);delete this._index[b];for(b in this._index){var c=this._index[b];c>a&&(this._index[b]=
c-1)}return!0}return!1},list:function(){return this._list},clear:function(){this._list.length=0;for(var b in this._index)delete this._index[b]}});return{IndexedList:d}}());pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(d,b,a){return d>=a?a:d<=b?b:d},intToBytes24:function(d){return[d>>16&255,d>>8&255,d&255]},intToBytes32:function(d){return[d>>24&255,d>>16&255,d>>8&255,d&255]},bytesToInt24:function(d,b,a){d.length&&(a=d[2],b=d[1],d=d[0]);return d<<16|b<<8|a},bytesToInt32:function(d,b,a,c){d.length&&(c=d[3],a=d[2],b=d[1],d=d[0]);return(d<<24|b<<16|a<<8|c)>>>32},lerp:function(d,b,a){return d+(b-d)*pc.math.clamp(a,0,1)},lerpAngle:function(d,b,a){180<
b-d&&(b-=360);-180>b-d&&(b+=360);return pc.math.lerp(d,b,pc.math.clamp(a,0,1))},powerOfTwo:function(d){return 0!==d&&!(d&d-1)},nextPowerOfTwo:function(d){d--;d|=d>>1;d|=d>>2;d|=d>>4;d|=d>>8;d|=d>>16;d++;return d},random:function(d,b){return Math.random()*(b-d)+d},smoothstep:function(d,b,a){if(a<=d)return 0;if(a>=b)return 1;a=(a-d)/(b-d);return a*a*(3-2*a)},smootherstep:function(d,b,a){if(a<=d)return 0;if(a>=b)return 1;a=(a-d)/(b-d);return a*a*a*(a*(6*a-15)+10)},roundUp:function(d,b){return 0===b?
d:Math.ceil(d/b)*b}};Object.assign(pc,function(){var d=function(b,a){b&&2===b.length?(this.x=b[0],this.y=b[1]):(this.x=b||0,this.y=a||0)};Object.assign(d.prototype,{add:function(b){this.x+=b.x;this.y+=b.y;return this},add2:function(b,a){this.x=b.x+a.x;this.y=b.y+a.y;return this},clone:function(){return(new d).copy(this)},copy:function(b){this.x=b.x;this.y=b.y;return this},distance:function(b){var a=this.x-b.x;b=this.y-b.y;return Math.sqrt(a*a+b*b)},dot:function(b){return this.x*b.x+this.y*b.y},equals:function(b){return this.x===
b.x&&this.y===b.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(b,a,c){this.x=b.x+c*(a.x-b.x);this.y=b.y+c*(a.y-b.y);return this},mul:function(b){this.x*=b.x;this.y*=b.y;return this},mul2:function(b,a){this.x=b.x*a.x;this.y=b.y*a.y;return this},normalize:function(){var b=this.x*this.x+this.y*this.y;0<b&&(b=1/Math.sqrt(b),this.x*=b,this.y*=b);return this},scale:function(b){this.x*=b;this.y*=b;return this},set:function(b,
a){this.x=b;this.y=a;return this},sub:function(b){this.x-=b.x;this.y-=b.y;return this},sub2:function(b,a){this.x=b.x-a.x;this.y=b.y-a.y;return this},toString:function(){return"["+this.x+", "+this.y+"]"}});Object.defineProperties(d,{ZERO:{value:new d(0,0)},ONE:{value:new d(1,1)},UP:{value:new d(0,1)},DOWN:{value:new d(0,-1)},RIGHT:{value:new d(1,0)},LEFT:{value:new d(-1,0)}});return{Vec2:d}}());Object.assign(pc,function(){var d=function(b,a,c){b&&3===b.length?(this.x=b[0],this.y=b[1],this.z=b[2]):(this.x=b||0,this.y=a||0,this.z=c||0)};Object.assign(d.prototype,{add:function(b){this.x+=b.x;this.y+=b.y;this.z+=b.z;return this},add2:function(b,a){this.x=b.x+a.x;this.y=b.y+a.y;this.z=b.z+a.z;return this},clone:function(){return(new d).copy(this)},copy:function(b){this.x=b.x;this.y=b.y;this.z=b.z;return this},cross:function(b,a){var c=b.x,e=b.y;b=b.z;var f=a.x,g=a.y;a=a.z;this.x=e*a-g*b;this.y=
b*f-a*c;this.z=c*g-f*e;return this},distance:function(b){var a=this.x-b.x,c=this.y-b.y;b=this.z-b.z;return Math.sqrt(a*a+c*c+b*b)},dot:function(b){return this.x*b.x+this.y*b.y+this.z*b.z},equals:function(b){return this.x===b.x&&this.y===b.y&&this.z===b.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(b,a,c){this.x=b.x+c*(a.x-b.x);this.y=b.y+c*(a.y-b.y);this.z=b.z+c*(a.z-b.z);return this},
mul:function(b){this.x*=b.x;this.y*=b.y;this.z*=b.z;return this},mul2:function(b,a){this.x=b.x*a.x;this.y=b.y*a.y;this.z=b.z*a.z;return this},normalize:function(){var b=this.x*this.x+this.y*this.y+this.z*this.z;0<b&&(b=1/Math.sqrt(b),this.x*=b,this.y*=b,this.z*=b);return this},project:function(b){var a=(this.x*b.x+this.y*b.y+this.z*b.z)/(b.x*b.x+b.y*b.y+b.z*b.z);this.x=b.x*a;this.y=b.y*a;this.z=b.z*a;return this},scale:function(b){this.x*=b;this.y*=b;this.z*=b;return this},set:function(b,a,c){this.x=
b;this.y=a;this.z=c;return this},sub:function(b){this.x-=b.x;this.y-=b.y;this.z-=b.z;return this},sub2:function(b,a){this.x=b.x-a.x;this.y=b.y-a.y;this.z=b.z-a.z;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}});Object.defineProperties(d,{ZERO:{value:new d(0,0,0)},ONE:{value:new d(1,1,1)},UP:{value:new d(0,1,0)},DOWN:{value:new d(0,-1,0)},RIGHT:{value:new d(1,0,0)},LEFT:{value:new d(-1,0,0)},FORWARD:{value:new d(0,0,-1)},BACK:{value:new d(0,0,1)}});return{Vec3:d}}());Object.assign(pc,function(){var d=function(b,a,c,e){b&&4===b.length?(this.x=b[0],this.y=b[1],this.z=b[2],this.w=b[3]):(this.x=b||0,this.y=a||0,this.z=c||0,this.w=e||0)};Object.assign(d.prototype,{add:function(b){this.x+=b.x;this.y+=b.y;this.z+=b.z;this.w+=b.w;return this},add2:function(b,a){this.x=b.x+a.x;this.y=b.y+a.y;this.z=b.z+a.z;this.w=b.w+a.w;return this},clone:function(){return(new d).copy(this)},copy:function(b){this.x=b.x;this.y=b.y;this.z=b.z;this.w=b.w;return this},dot:function(b){return this.x*
b.x+this.y*b.y+this.z*b.z+this.w*b.w},equals:function(b){return this.x===b.x&&this.y===b.y&&this.z===b.z&&this.w===b.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(b,a,c){this.x=b.x+c*(a.x-b.x);this.y=b.y+c*(a.y-b.y);this.z=b.z+c*(a.z-b.z);this.w=b.w+c*(a.w-b.w);return this},mul:function(b){this.x*=b.x;this.y*=b.y;this.z*=b.z;this.w*=b.w;return this},mul2:function(b,
a){this.x=b.x*a.x;this.y=b.y*a.y;this.z=b.z*a.z;this.w=b.w*a.w;return this},normalize:function(){var b=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;0<b&&(b=1/Math.sqrt(b),this.x*=b,this.y*=b,this.z*=b,this.w*=b);return this},scale:function(b){this.x*=b;this.y*=b;this.z*=b;this.w*=b;return this},set:function(b,a,c,e){this.x=b;this.y=a;this.z=c;this.w=e;return this},sub:function(b){this.x-=b.x;this.y-=b.y;this.z-=b.z;this.w-=b.w;return this},sub2:function(b,a){this.x=b.x-a.x;this.y=b.y-a.y;
this.z=b.z-a.z;this.w=b.w-a.w;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(d,{ZERO:{value:new d(0,0,0,0)},ONE:{value:new d(1,1,1,1)}});return{Vec4:d}}());Object.assign(pc,function(){var d=function(){var b=new Float32Array(9);b[0]=b[4]=b[8]=1;this.data=b};Object.assign(d.prototype,{clone:function(){return(new pc.Mat3).copy(this)},copy:function(b){b=b.data;var a=this.data;a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];return this},set:function(b){var a=this.data;a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];return this},equals:function(b){var a=this.data;b=b.data;
return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]},isIdentity:function(){var b=this.data;return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&1===b[4]&&0===b[5]&&0===b[6]&&0===b[7]&&1===b[8]},setIdentity:function(){var b=this.data;b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=1;b[5]=0;b[6]=0;b[7]=0;b[8]=1;return this},toString:function(){for(var b="[",a=0;9>a;a++)b+=this.data[a],b+=8!==a?", ":"";return b+"]"},transpose:function(){var b=this.data;
var a=b[1];b[1]=b[3];b[3]=a;a=b[2];b[2]=b[6];b[6]=a;a=b[5];b[5]=b[7];b[7]=a;return this}});Object.defineProperties(d,{ZERO:{value:(new d).set([0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new d}});return{Mat3:d}}());Object.assign(pc,function(){var d=function(){var b=new Float32Array(16);b[0]=b[5]=b[10]=b[15]=1;this.data=b};Object.assign(d.prototype,{add2:function(b,a){b=b.data;a=a.data;var c=this.data;c[0]=b[0]+a[0];c[1]=b[1]+a[1];c[2]=b[2]+a[2];c[3]=b[3]+a[3];c[4]=b[4]+a[4];c[5]=b[5]+a[5];c[6]=b[6]+a[6];c[7]=b[7]+a[7];c[8]=b[8]+a[8];c[9]=b[9]+a[9];c[10]=b[10]+a[10];c[11]=b[11]+a[11];c[12]=b[12]+a[12];c[13]=b[13]+a[13];c[14]=b[14]+a[14];c[15]=b[15]+a[15];return this},add:function(b){return this.add2(this,b)},
clone:function(){return(new pc.Mat4).copy(this)},copy:function(b){b=b.data;var a=this.data;a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return this},equals:function(b){var a=this.data;b=b.data;return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]&&a[9]===b[9]&&a[10]===b[10]&&a[11]===b[11]&&a[12]===b[12]&&
a[13]===b[13]&&a[14]===b[14]&&a[15]===b[15]},isIdentity:function(){var b=this.data;return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&0===b[12]&&0===b[13]&&0===b[14]&&1===b[15]},mul2:function(b,a){var c=b.data;var e=a.data,f=this.data;a=c[0];b=c[1];var g=c[2];var d=c[3];var k=c[4];var h=c[5];var m=c[6];var l=c[7];var p=c[8];var q=c[9];var r=c[10];var t=c[11];var u=c[12];var x=c[13];var v=c[14];c=c[15];var y=e[0];var A=e[1];
var z=e[2];var E=e[3];f[0]=a*y+k*A+p*z+u*E;f[1]=b*y+h*A+q*z+x*E;f[2]=g*y+m*A+r*z+v*E;f[3]=d*y+l*A+t*z+c*E;y=e[4];A=e[5];z=e[6];E=e[7];f[4]=a*y+k*A+p*z+u*E;f[5]=b*y+h*A+q*z+x*E;f[6]=g*y+m*A+r*z+v*E;f[7]=d*y+l*A+t*z+c*E;y=e[8];A=e[9];z=e[10];E=e[11];f[8]=a*y+k*A+p*z+u*E;f[9]=b*y+h*A+q*z+x*E;f[10]=g*y+m*A+r*z+v*E;f[11]=d*y+l*A+t*z+c*E;y=e[12];A=e[13];z=e[14];E=e[15];f[12]=a*y+k*A+p*z+u*E;f[13]=b*y+h*A+q*z+x*E;f[14]=g*y+m*A+r*z+v*E;f[15]=d*y+l*A+t*z+c*E;return this},mul:function(b){return this.mul2(this,
b)},transformPoint:function(b,a){var c=this.data;var e=b.x;var f=b.y;b=b.z;a=void 0===a?new pc.Vec3:a;a.x=e*c[0]+f*c[4]+b*c[8]+c[12];a.y=e*c[1]+f*c[5]+b*c[9]+c[13];a.z=e*c[2]+f*c[6]+b*c[10]+c[14];return a},transformVector:function(b,a){var c=this.data;var e=b.x;var f=b.y;b=b.z;a=void 0===a?new pc.Vec3:a;a.x=e*c[0]+f*c[4]+b*c[8];a.y=e*c[1]+f*c[5]+b*c[9];a.z=e*c[2]+f*c[6]+b*c[10];return a},transformVec4:function(b,a){var c=this.data;var e=b.x;var f=b.y;var g=b.z;b=b.w;a=void 0===a?new pc.Vec4:a;a.x=
e*c[0]+f*c[4]+g*c[8]+b*c[12];a.y=e*c[1]+f*c[5]+g*c[9]+b*c[13];a.z=e*c[2]+f*c[6]+g*c[10]+b*c[14];a.w=e*c[3]+f*c[7]+g*c[11]+b*c[15];return a},setLookAt:function(){var b=new pc.Vec3;var a=new pc.Vec3;var c=new pc.Vec3;return function(e,f,g){c.sub2(e,f).normalize();a.copy(g).normalize();b.cross(a,c).normalize();a.cross(c,b);f=this.data;f[0]=b.x;f[1]=b.y;f[2]=b.z;f[3]=0;f[4]=a.x;f[5]=a.y;f[6]=a.z;f[7]=0;f[8]=c.x;f[9]=c.y;f[10]=c.z;f[11]=0;f[12]=e.x;f[13]=e.y;f[14]=e.z;f[15]=1;return this}}(),setFrustum:function(b,
a,c,e,f,g){var d=2*f;var k=a-b;var h=e-c;var m=g-f;var l=this.data;l[0]=d/k;l[1]=0;l[2]=0;l[3]=0;l[4]=0;l[5]=d/h;l[6]=0;l[7]=0;l[8]=(a+b)/k;l[9]=(e+c)/h;l[10]=(-g-f)/m;l[11]=-1;l[12]=0;l[13]=0;l[14]=-d*g/m;l[15]=0;return this},setPerspective:function(b,a,c,e,f){f?(b=c*Math.tan(b*Math.PI/360),f=b/a):(f=c*Math.tan(b*Math.PI/360),b=f*a);return this.setFrustum(-b,b,-f,f,c,e)},setOrtho:function(b,a,c,e,f,g){var d=this.data;d[0]=2/(a-b);d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=2/(e-c);d[6]=0;d[7]=0;d[8]=0;d[9]=
0;d[10]=-2/(g-f);d[11]=0;d[12]=-(a+b)/(a-b);d[13]=-(e+c)/(e-c);d[14]=-(g+f)/(g-f);d[15]=1;return this},setFromAxisAngle:function(b,a){a*=pc.math.DEG_TO_RAD;var c=b.x;var e=b.y;b=b.z;var f=Math.cos(a);a=Math.sin(a);var g=1-f;var d=g*c;var k=g*e;var h=this.data;h[0]=d*c+f;h[1]=d*e+a*b;h[2]=d*b-a*e;h[3]=0;h[4]=d*e-a*b;h[5]=k*e+f;h[6]=k*b+a*c;h[7]=0;h[8]=d*b+a*e;h[9]=k*b-c*a;h[10]=g*b*b+f;h[11]=0;h[12]=0;h[13]=0;h[14]=0;h[15]=1;return this},setTranslate:function(b,a,c){var e=this.data;e[0]=1;e[1]=0;e[2]=
0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=b;e[13]=a;e[14]=c;e[15]=1;return this},setScale:function(b,a,c){var e=this.data;e[0]=b;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=a;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return this},invert:function(){var b=this.data;var a=b[0];var c=b[1];var e=b[2];var f=b[3];var g=b[4];var d=b[5];var k=b[6];var h=b[7];var m=b[8];var l=b[9];var p=b[10];var q=b[11];var r=b[12];var t=b[13];var u=b[14];var x=b[15];var v=
a*d-c*g;var y=a*k-e*g;var A=a*h-f*g;var z=c*k-e*d;var E=c*h-f*d;var C=e*h-f*k;var D=m*t-l*r;var F=m*u-p*r;var I=m*x-q*r;var G=l*u-p*t;var B=l*x-q*t;var w=p*x-q*u;var H=v*w-y*B+A*G+z*I-E*F+C*D;0===H?this.setIdentity():(H=1/H,b[0]=(d*w-k*B+h*G)*H,b[1]=(-c*w+e*B-f*G)*H,b[2]=(t*C-u*E+x*z)*H,b[3]=(-l*C+p*E-q*z)*H,b[4]=(-g*w+k*I-h*F)*H,b[5]=(a*w-e*I+f*F)*H,b[6]=(-r*C+u*A-x*y)*H,b[7]=(m*C-p*A+q*y)*H,b[8]=(g*B-d*I+h*D)*H,b[9]=(-a*B+c*I-f*D)*H,b[10]=(r*E-t*A+x*v)*H,b[11]=(-m*E+l*A-q*v)*H,b[12]=(-g*G+d*F-k*
D)*H,b[13]=(a*G-c*F+e*D)*H,b[14]=(-r*z+t*y-u*v)*H,b[15]=(m*z-l*y+p*v)*H);return this},set:function(b){var a=this.data;a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return this},setIdentity:function(){var b=this.data;b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=0;b[5]=1;b[6]=0;b[7]=0;b[8]=0;b[9]=0;b[10]=1;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return this},setTRS:function(b,a,c){var e=
b.x;var f=b.y;b=b.z;var g=a.x;var d=a.y;var k=a.z;var h=a.w;a=c.x;var m=c.y;c=c.z;var l=g+g;var p=d+d;var q=k+k;var r=g*l;var t=g*p;g*=q;var u=d*p;d*=q;k*=q;l*=h;p*=h;h*=q;q=this.data;q[0]=(1-(u+k))*a;q[1]=(t+h)*a;q[2]=(g-p)*a;q[3]=0;q[4]=(t-h)*m;q[5]=(1-(r+k))*m;q[6]=(d+l)*m;q[7]=0;q[8]=(g+p)*c;q[9]=(d-l)*c;q[10]=(1-(r+u))*c;q[11]=0;q[12]=e;q[13]=f;q[14]=b;q[15]=1;return this},transpose:function(){var b=this.data;var a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];
b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},invertTo3x3:function(b){var a=this.data;b=b.data;var c=a[0],e=a[1],f=a[2],g=a[4],d=a[5],k=a[6],h=a[8],m=a[9],l=a[10];a=l*d-k*m;var p=-l*g+k*h;var q=m*g-d*h;var r=c*a+e*p+f*q;if(0===r)return this;r=1/r;b[0]=r*a;b[1]=r*(-l*e+f*m);b[2]=r*(k*e-f*d);b[3]=r*p;b[4]=r*(l*c-f*h);b[5]=r*(-k*c+f*g);b[6]=r*q;b[7]=r*(-m*c+e*h);b[8]=r*(d*c-e*g);return this},getTranslation:function(b){b=void 0===b?new pc.Vec3:b;return b.set(this.data[12],
this.data[13],this.data[14])},getX:function(b){b=void 0===b?new pc.Vec3:b;return b.set(this.data[0],this.data[1],this.data[2])},getY:function(b){b=void 0===b?new pc.Vec3:b;return b.set(this.data[4],this.data[5],this.data[6])},getZ:function(b){b=void 0===b?new pc.Vec3:b;return b.set(this.data[8],this.data[9],this.data[10])},getScale:function(){var b=new pc.Vec3;var a=new pc.Vec3;var c=new pc.Vec3;return function(e){e=void 0===e?new pc.Vec3:e;this.getX(b);this.getY(a);this.getZ(c);e.set(b.length(),
a.length(),c.length());return e}}(),setFromEulerAngles:function(b,a,c){b*=pc.math.DEG_TO_RAD;a*=pc.math.DEG_TO_RAD;c*=pc.math.DEG_TO_RAD;var e=Math.sin(-b);b=Math.cos(-b);var f=Math.sin(-a);a=Math.cos(-a);var g=Math.sin(-c);c=Math.cos(-c);var d=this.data;d[0]=a*c;d[1]=-a*g;d[2]=f;d[3]=0;d[4]=b*g+c*e*f;d[5]=b*c-e*f*g;d[6]=-a*e;d[7]=0;d[8]=e*g-b*c*f;d[9]=c*e+b*f*g;d[10]=b*a;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},getEulerAngles:function(){var b=new pc.Vec3;return function(a){a=void 0===
a?new pc.Vec3:a;this.getScale(b);var c=b.x;var e=b.y;var f=b.z;var g=this.data;var d=Math.asin(-g[2]/c);var k=.5*Math.PI;d<k?d>-k?(e=Math.atan2(g[6]/e,g[10]/f),c=Math.atan2(g[1]/c,g[0]/c)):(c=0,e=-Math.atan2(g[4]/e,g[5]/e)):(c=0,e=Math.atan2(g[4]/e,g[5]/e));return a.set(e,d,c).scale(pc.math.RAD_TO_DEG)}}(),toString:function(){var b;var a="[";for(b=0;16>b;b+=1)a+=this.data[b],a+=15!==b?", ":"";return a+"]"}});Object.defineProperties(d,{ZERO:{value:(new d).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new d}});
return{Mat4:d}}());Object.assign(pc,function(){var d=function(b,a,c,e){b&&4===b.length?(this.x=b[0],this.y=b[1],this.z=b[2],this.w=b[3]):(this.x=void 0===b?0:b,this.y=void 0===a?0:a,this.z=void 0===c?0:c,this.w=void 0===e?1:e)};Object.assign(d.prototype,{clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(b){this.x=b.x;this.y=b.y;this.z=b.z;this.w=b.w;return this},equals:function(b){return this.x===b.x&&this.y===b.y&&this.z===
b.z&&this.w===b.w},getAxisAngle:function(b){var a=2*Math.acos(this.w),c=Math.sin(a/2);if(0!==c){if(b.x=this.x/c,b.y=this.y/c,b.z=this.z/c,0>b.x||0>b.y||0>b.z)b.x*=-1,b.y*=-1,b.z*=-1,a*=-1}else b.x=1,b.y=0,b.z=0;return a*pc.math.RAD_TO_DEG},getEulerAngles:function(b){b=void 0===b?new pc.Vec3:b;var a=this.x;var c=this.y;var e=this.z;var f=this.w;var g=2*(f*c-a*e);if(-.99999>=g){var d=2*Math.atan2(a,f);g=-Math.PI/2;a=0}else.99999<=g?(d=2*Math.atan2(a,f),g=Math.PI/2,a=0):(d=Math.atan2(2*(f*a+c*e),1-2*
(a*a+c*c)),g=Math.asin(g),a=Math.atan2(2*(f*e+a*c),1-2*(c*c+e*e)));return b.set(d,g,a).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(b){var a=this.x;var c=this.y;var e=this.z;var f=this.w;var g=b.x;var d=b.y;var k=b.z;b=b.w;this.x=f*g+a*b+c*k-e*d;this.y=f*d+c*b+e*g-a*k;this.z=
f*k+e*b+a*d-c*g;this.w=f*b-a*g-c*d-e*k;return this},mul2:function(b,a){var c=b.x;var e=b.y;var f=b.z;b=b.w;var g=a.x;var d=a.y;var k=a.z;a=a.w;this.x=b*g+c*a+e*k-f*d;this.y=b*d+e*a+f*g-c*k;this.z=b*k+f*a+c*d-e*g;this.w=b*a-c*g-e*d-f*k;return this},normalize:function(){var b=this.length();0===b?(this.x=this.y=this.z=0,this.w=1):(b=1/b,this.x*=b,this.y*=b,this.z*=b,this.w*=b);return this},set:function(b,a,c,e){this.x=b;this.y=a;this.z=c;this.w=e;return this},setFromAxisAngle:function(b,a){a*=.5*pc.math.DEG_TO_RAD;
var c=Math.sin(a);a=Math.cos(a);this.x=c*b.x;this.y=c*b.y;this.z=c*b.z;this.w=a;return this},setFromEulerAngles:function(b,a,c){var e=.5*pc.math.DEG_TO_RAD;b*=e;a*=e;c*=e;e=Math.sin(b);b=Math.cos(b);var f=Math.sin(a);a=Math.cos(a);var g=Math.sin(c);c=Math.cos(c);this.x=e*a*c-b*f*g;this.y=b*f*c+e*a*g;this.z=b*a*g-e*f*c;this.w=b*a*c+e*f*g;return this},setFromMat4:function(b){b=b.data;var a=b[0];var c=b[1];var e=b[2];var f=b[4];var g=b[5];var d=b[6];var k=b[8];var h=b[9];b=b[10];var m=a*a+c*c+e*e;if(0===
m)return this;m=1/Math.sqrt(m);var l=f*f+g*g+d*d;if(0===l)return this;l=1/Math.sqrt(l);var p=k*k+h*h+b*b;if(0===p)return this;p=1/Math.sqrt(p);a*=m;c*=m;e*=m;f*=l;g*=l;d*=l;k*=p;h*=p;b*=p;m=a+g+b;0<=m?(a=Math.sqrt(m+1),this.w=.5*a,a=.5/a,this.x=(d-h)*a,this.y=(k-e)*a,this.z=(c-f)*a):a>g?a>b?(a=Math.sqrt(a-(g+b)+1),this.x=.5*a,a=.5/a,this.w=(d-h)*a,this.y=(c+f)*a,this.z=(e+k)*a):(a=Math.sqrt(b-(a+g)+1),this.z=.5*a,a=.5/a,this.w=(c-f)*a,this.x=(k+e)*a,this.y=(h+d)*a):g>b?(a=Math.sqrt(g-(b+a)+1),this.y=
.5*a,a=.5/a,this.w=(k-e)*a,this.z=(d+h)*a,this.x=(f+c)*a):(a=Math.sqrt(b-(a+g)+1),this.z=.5*a,a=.5/a,this.w=(c-f)*a,this.x=(k+e)*a,this.y=(h+d)*a);return this},slerp:function(b,a,c){var e=b.x;var f=b.y;var g=b.z;b=b.w;var d=a.x;var k=a.y;var h=a.z;a=a.w;var m=b*a+e*d+f*k+g*h;0>m&&(a=-a,d=-d,k=-k,h=-h,m=-m);if(1<=Math.abs(m))return this.w=b,this.x=e,this.y=f,this.z=g,this;var l=Math.acos(m),p=Math.sqrt(1-m*m);if(.001>Math.abs(p))return this.w=.5*b+.5*a,this.x=.5*e+.5*d,this.y=.5*f+.5*k,this.z=.5*g+
.5*h,this;m=Math.sin((1-c)*l)/p;c=Math.sin(c*l)/p;this.w=b*m+a*c;this.x=e*m+d*c;this.y=f*m+k*c;this.z=g*m+h*c;return this},transformVector:function(b,a){void 0===a&&(a=new pc.Vec3);var c=b.x,e=b.y,f=b.z;b=this.x;var g=this.y,d=this.z,k=this.w,h=k*c+g*f-d*e,m=k*e+d*c-b*f,l=k*f+b*e-g*c;c=-b*c-g*e-d*f;a.x=h*k+c*-b+m*-d-l*-g;a.y=m*k+c*-g+l*-b-h*-d;a.z=l*k+c*-d+h*-g-m*-b;return a},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(d,{ZERO:{value:new d(0,
0,0,0)},IDENTITY:{value:new d(0,0,0,1)}});return{Quat:d}}());Object.assign(pc,function(){var d=function(b){this.keys=[];this.type=1;this.tension=.5;this._eval=new pc.CurveEvaluator(this);if(b)for(var a=0;a<b.length-1;a+=2)this.keys.push([b[a],b[a+1]]);this.sort()};Object.assign(d.prototype,{add:function(b,a){for(var c=this.keys,e=c.length,f=0;f<e&&!(c[f][0]>b);f++);b=[b,a];this.keys.splice(f,0,b);return b},get:function(b){return this.keys[b]},sort:function(){this.keys.sort(function(b,a){return b[0]-a[0]})},value:function(b){return this._eval.evaluate(b,!0)},
closest:function(b){for(var a=this.keys,c=a.length,e=2,f=null,g=0;g<c;g++){var d=Math.abs(b-a[g][0]);if(e>=d)e=d,f=a[g];else break}return f},clone:function(){var b=new pc.Curve;b.keys=pc.extend(b.keys,this.keys);b.type=this.type;b.tension=this.tension;return b},quantize:function(b){b=Math.max(b,2);var a=new Float32Array(b),c=1/(b-1);a[0]=this._eval.evaluate(0,!0);for(var e=1;e<b;e++)a[e]=this._eval.evaluate(c*e);return a},quantizeClamped:function(b,a,c){b=this.quantize(b);for(var e=0;e<b.length;++e)b[e]=
Math.min(c,Math.max(a,b[e]));return b}});Object.defineProperty(d.prototype,"length",{get:function(){return this.keys.length}});return{Curve:d,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3,CURVE_SPLINE:4,CURVE_STEP:5}}());Object.assign(pc,function(){var d=function(){var b;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(b=0;b<arguments.length;b++)this.curves.push(new pc.Curve(arguments[b]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var a=arguments[0];if("number"===pc.type(a))for(b=0;b<a;b++)this.curves.push(new pc.Curve);else for(b=0;b<a.length;b++)this.curves.push(new pc.Curve(a[b]))}};Object.assign(d.prototype,{get:function(b){return this.curves[b]},value:function(b,
a){var c=this.curves.length;a=a||[];a.length=c;for(var e=0;e<c;e++)a[e]=this.curves[e].value(b);return a},clone:function(){var b=new pc.CurveSet;b.curves=[];for(var a=0;a<this.curves.length;a++)b.curves.push(this.curves[a].clone());b._type=this._type;return b},quantize:function(b){b=Math.max(b,2);for(var a=this.curves.length,c=new Float32Array(b*a),e=1/(b-1),f=0;f<a;f++)for(var g=new pc.CurveEvaluator(this.curves[f]),d=0;d<b;d++)c[d*a+f]=g.evaluate(e*d);return c},quantizeClamped:function(b,a,c){b=
this.quantize(b);for(var e=0;e<b.length;++e)b[e]=Math.min(c,Math.max(a,b[e]));return b}});Object.defineProperty(d.prototype,"length",{get:function(){return this.curves.length}});Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(b){this._type=b;for(var a=0;a<this.curves.length;a++)this.curves[a].type=b}});return{CurveSet:d}}());Object.assign(pc,function(){var d=function(b,a){this._curve=b;this._left=-Infinity;this._right=Infinity;this._m1=this._m0=this._p1=this._p0=this._recip=0;this._reset(a||0)};Object.assign(d.prototype,{evaluate:function(b,a){(a||b<this._left||b>=this._right)&&this._reset(b);a=this._curve.type;a===pc.CURVE_STEP?b=this._p0:(b=0===this._recip?0:(b-this._left)*this._recip,b=a===pc.CURVE_LINEAR?pc.math.lerp(this._p0,this._p1,b):a===pc.CURVE_SMOOTHSTEP?pc.math.lerp(this._p0,this._p1,b*b*(3-2*b)):this._evaluateHermite(this._p0,
this._p1,this._m0,this._m1,b));return b},_reset:function(b){var a=this._curve.keys,c=a.length;if(c)if(b<a[0][0])this._left=-Infinity,this._right=a[0][0],this._recip=0,this._p0=this._p1=a[0][1],this._m0=this._m1=0;else if(b>=a[c-1][0])this._left=a[c-1][0],this._right=Infinity,this._recip=0,this._p0=this._p1=a[c-1][1],this._m0=this._m1=0;else{for(c=0;b>=a[c+1][0];)c++;this._left=a[c][0];this._right=a[c+1][0];b=1/(this._right-this._left);this._recip=isFinite(b)?b:0;this._p0=a[c][1];this._p1=a[c+1][1];
this._isHermite()&&this._calcTangents(a,c)}else this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return this._curve.type===pc.CURVE_CATMULL||this._curve.type===pc.CURVE_CARDINAL||this._curve.type===pc.CURVE_SPLINE},_calcTangents:function(b,a){var c=b[a],e=b[a+1];var f=0===a?[b[0][0]+(b[0][0]-b[1][0]),b[0][1]+(b[0][1]-b[1][1])]:b[a-1];b=a==b.length-2?[b[a+1][0]+(b[a+1][0]-b[a][0]),b[a+1][1]+(b[a+1][1]-b[a][1])]:b[a+2];if(this._curve.type===
pc.CURVE_SPLINE){a=2*(e[0]-c[0])/(e[0]-f[0]);var g=2*(e[0]-c[0])/(b[0]-c[0]);this._m0=this._curve.tension*(isFinite(a)?a:0)*(e[1]-f[1]);this._m1=this._curve.tension*(isFinite(g)?g:0)*(b[1]-c[1])}else g=(e[0]-c[0])/(c[0]-f[0]),a=(e[0]-c[0])/(b[0]-e[0]),f=c[1]+(f[1]-c[1])*(isFinite(g)?g:0),b=e[1]+(b[1]-e[1])*(isFinite(a)?a:0),a=this._curve.type===pc.CURVE_CATMULL?.5:this._curve.tension,this._m0=a*(e[1]-f),this._m1=a*(b-c[1])},_evaluateHermite:function(b,a,c,e,f){var g=f*f,d=f+f,k=1-f;k*=k;return b*
(1+d)*k+c*f*k+a*g*(3-d)+e*g*(f-1)}});return{CurveEvaluator:d}}());Object.assign(pc,function(){var d=new pc.Vec3,b=new pc.Vec3,a=new pc.Vec3,c=new pc.Vec3,e=new pc.Vec3,f=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(.5,.5,.5);this._min=new pc.Vec3;this._max=new pc.Vec3};Object.assign(f.prototype,{add:function(a){var b=this.center,c=b.x,e=b.y,f=b.z,g=this.halfExtents,d=g.x,q=g.y,r=g.z,t=c-d;c+=d;d=e-q;e+=q;q=f-r;f+=r;r=a.center;var u=r.x,x=r.y;r=r.z;a=a.halfExtents;var v=a.x,y=a.y,A=a.z;a=u-v;u+=v;v=x-y;x+=y;y=r-A;r+=A;a<t&&(t=a);
u>c&&(c=u);v<d&&(d=v);x>e&&(e=x);y<q&&(q=y);r>f&&(f=r);b.x=.5*(t+c);b.y=.5*(d+e);b.z=.5*(q+f);g.x=.5*(c-t);g.y=.5*(e-d);g.z=.5*(f-q)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},clone:function(){return new pc.BoundingBox(this.center.clone(),this.halfExtents.clone())},intersects:function(a){var b=this.getMax(),c=this.getMin(),e=a.getMax();a=a.getMin();return c.x<=e.x&&b.x>=a.x&&c.y<=e.y&&b.y>=a.y&&c.z<=e.z&&b.z>=a.z},_intersectsRay:function(e,
f){var g=d.copy(this.getMin()).sub(e.origin),h=b.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(g.x=0>g.x?-Number.MAX_VALUE:Number.MAX_VALUE,h.x=0>h.x?-Number.MAX_VALUE:Number.MAX_VALUE):(g.x/=n.x,h.x/=n.x);0===n.y?(g.y=0>g.y?-Number.MAX_VALUE:Number.MAX_VALUE,h.y=0>h.y?-Number.MAX_VALUE:Number.MAX_VALUE):(g.y/=n.y,h.y/=n.y);0===n.z?(g.z=0>g.z?-Number.MAX_VALUE:Number.MAX_VALUE,h.z=0>h.z?-Number.MAX_VALUE:Number.MAX_VALUE):(g.z/=n.z,h.z/=n.z);n=a.set(Math.min(g.x,h.x),Math.min(g.y,h.y),
Math.min(g.z,h.z));g=c.set(Math.max(g.x,h.x),Math.max(g.y,h.y),Math.max(g.z,h.z));h=Math.max(Math.max(n.x,n.y),n.z);(g=Math.min(Math.min(g.x,g.y),g.z)>=h&&0<=h)&&f.copy(e.direction).scale(h).add(e.origin);return g},_fastIntersectsRay:function(f){var g=f.direction;d.sub2(f.origin,this.center);c.set(Math.abs(d.x),Math.abs(d.y),Math.abs(d.z));a.mul2(d,g);if(c.x>this.halfExtents.x&&0<=a.x||c.y>this.halfExtents.y&&0<=a.y||c.z>this.halfExtents.z&&0<=a.z)return!1;e.set(Math.abs(g.x),Math.abs(g.y),Math.abs(g.z));
b.cross(g,d);b.set(Math.abs(b.x),Math.abs(b.y),Math.abs(b.z));return b.x>this.halfExtents.y*e.z+this.halfExtents.z*e.y||b.y>this.halfExtents.x*e.z+this.halfExtents.z*e.x||b.z>this.halfExtents.x*e.y+this.halfExtents.y*e.x?!1:!0},intersectsRay:function(a,b){return b?this._intersectsRay(a,b):this._fastIntersectsRay(a)},setMinMax:function(a,b){this.center.add2(b,a).scale(.5);this.halfExtents.sub2(b,a).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},
containsPoint:function(a){var b=this.getMin(),c=this.getMax();return a.x<b.x||a.x>c.x||a.y<b.y||a.y>c.y||a.z<b.z||a.z>c.z?!1:!0},setFromTransformedAabb:function(a,b){var c=this.center,e=this.halfExtents,f=a.center;a=a.halfExtents;b=b.data;var g=b[0],d=b[4],n=b[8],r=b[1],t=b[5],u=b[9],x=b[2],v=b[6],y=b[10],A=Math.abs(g),z=Math.abs(d),E=Math.abs(n),C=Math.abs(r),D=Math.abs(t),F=Math.abs(u),I=Math.abs(x),G=Math.abs(v),B=Math.abs(y);c.set(b[12]+g*f.x+d*f.y+n*f.z,b[13]+r*f.x+t*f.y+u*f.z,b[14]+x*f.x+v*
f.y+y*f.z);e.set(A*a.x+z*a.y+E*a.z,C*a.x+D*a.y+F*a.z,I*a.x+G*a.y+B*a.z)},compute:function(a,c){c=void 0===c?a.length/3:c;if(0<c){for(var e=d.set(a[0],a[1],a[2]),f=b.set(a[0],a[1],a[2]),g=1;g<c;g++){var n=a[3*g],p=a[3*g+1],q=a[3*g+2];n<e.x&&(e.x=n);p<e.y&&(e.y=p);q<e.z&&(e.z=q);n>f.x&&(f.x=n);p>f.y&&(f.y=p);q>f.z&&(f.z=q)}this.setMinMax(e,f)}},intersectsBoundingSphere:function(a){return this._distanceToBoundingSphereSq(a)<=a.radius*a.radius?!0:!1},_distanceToBoundingSphereSq:function(a){for(var b=
this.getMin(),c=this.getMax(),e=0,f=["x","y","z"],g=0;3>g;++g){var d=0,q=a.center[f[g]],r=b[f[g]],t=c[f[g]];q<r&&(r-=q,d+=r*r);q>t&&(r=q-t,d+=r*r);e+=d}return e}});return{BoundingBox:f}}());Object.assign(pc,function(){function d(a,b){this.center=a||new pc.Vec3(0,0,0);this.radius=void 0===b?.5:b}var b=new pc.Vec3,a=new pc.Vec3,c=new pc.Vec3,e=new pc.Vec3;Object.assign(d.prototype,{containsPoint:function(a){a=b.sub2(a,this.center).lengthSq();var c=this.radius;return a<c*c},compute:function(f){var g,d=f.length/3;for(g=0;g<d;g++)b.set(f[3*g],f[3*g+1],f[3*g+2]),c.addSelf(b),0===g%100&&(c.scale(1/d),a.add(c),c.set(0,0,0));c.scale(1/d);a.add(c);this.center.copy(a);var k=0;for(g=0;g<d;g++)b.set(f[3*
g],f[3*g+1],f[3*g+2]),e.sub2(b,this.center),k=Math.max(e.lengthSq(),k);this.radius=Math.sqrt(k)},intersectsRay:function(c,e){var f=b.copy(c.origin).sub(this.center),g=f.dot(a.copy(c.direction).normalize());f=f.dot(f)-this.radius*this.radius;if(0<f&&0<g)return null;f=g*g-f;if(0>f)return!1;g=Math.abs(-g-Math.sqrt(f));e&&e.copy(c.direction).scale(g).add(c.origin);return!0},intersectsBoundingSphere:function(a){b.sub2(a.center,this.center);a=a.radius+this.radius;return b.lengthSq()<=a*a?!0:!1}});return{BoundingSphere:d}}());Object.assign(pc,function(){var d=new pc.Mat4,b=function(a,b){a=a||(new pc.Mat4).setPerspective(90,16/9,.1,1E3);b=b||new pc.Mat4;this.planes=[];for(var c=0;6>c;c++)this.planes[c]=[];this.update(a,b)};Object.assign(b.prototype,{update:function(a,b){d.mul2(a,b);a=d.data;this.planes[0][0]=a[3]-a[0];this.planes[0][1]=a[7]-a[4];this.planes[0][2]=a[11]-a[8];this.planes[0][3]=a[15]-a[12];b=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);
this.planes[0][0]/=b;this.planes[0][1]/=b;this.planes[0][2]/=b;this.planes[0][3]/=b;this.planes[1][0]=a[3]+a[0];this.planes[1][1]=a[7]+a[4];this.planes[1][2]=a[11]+a[8];this.planes[1][3]=a[15]+a[12];b=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=b;this.planes[1][1]/=b;this.planes[1][2]/=b;this.planes[1][3]/=b;this.planes[2][0]=a[3]+a[1];this.planes[2][1]=a[7]+a[5];this.planes[2][2]=a[11]+a[9];this.planes[2][3]=
a[15]+a[13];b=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=b;this.planes[2][1]/=b;this.planes[2][2]/=b;this.planes[2][3]/=b;this.planes[3][0]=a[3]-a[1];this.planes[3][1]=a[7]-a[5];this.planes[3][2]=a[11]-a[9];this.planes[3][3]=a[15]-a[13];b=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=b;this.planes[3][1]/=b;this.planes[3][2]/=
b;this.planes[3][3]/=b;this.planes[4][0]=a[3]-a[2];this.planes[4][1]=a[7]-a[6];this.planes[4][2]=a[11]-a[10];this.planes[4][3]=a[15]-a[14];b=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=b;this.planes[4][1]/=b;this.planes[4][2]/=b;this.planes[4][3]/=b;this.planes[5][0]=a[3]+a[2];this.planes[5][1]=a[7]+a[6];this.planes[5][2]=a[11]+a[10];this.planes[5][3]=a[15]+a[14];b=Math.sqrt(this.planes[5][0]*this.planes[5][0]+
this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=b;this.planes[5][1]/=b;this.planes[5][2]/=b;this.planes[5][3]/=b},containsPoint:function(a){for(var b=0;6>b;b++)if(0>=this.planes[b][0]*a.x+this.planes[b][1]*a.y+this.planes[b][2]*a.z+this.planes[b][3])return!1;return!0},containsSphere:function(a){var b=0,e=a.radius;var f=a.center;a=f.x;var g=f.y,d=f.z,k=this.planes;for(f=0;6>f;f++){var h=k[f];h=h[0]*a+h[1]*g+h[2]*d+h[3];if(h<=-e)return 0;h>e&&b++}return 6===
b?2:1}});return{Frustum:b}}());Object.assign(pc,function(){var d=new pc.Vec3,b=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0)};Object.assign(b.prototype,{intersectsLine:function(a,b,e){var c=-this.normal.dot(this.point),g=this.normal.dot(a)+c;c=this.normal.dot(b)+c;g/=g-c;(c=0<=g&&1>=g)&&e&&e.lerp(a,b,g);return c},intersectsRay:function(a,b){var c=d.sub2(this.point,a.origin);c=this.normal.dot(c)/this.normal.dot(a.direction);var f=0<=c;f&&b&&b.copy(a.direction).scale(c).add(a.origin);return f}});
return{Plane:b}}());Object.assign(pc,function(){var d=function(b,a){this.origin=b||new pc.Vec3(0,0,0);this.direction=a||new pc.Vec3(0,0,-1)};d.prototype.set=function(b,a){this.origin.copy(b);this.direction.copy(a);return this};return{Ray:d}}());Object.assign(pc,function(){var d=new pc.Ray,b=new pc.Vec3,a=new pc.BoundingSphere,c=new pc.Mat4,e=function(a,b){this.halfExtents=b||new pc.Vec3(.5,.5,.5);a=a||c.setIdentity();this._modelTransform=a.clone().invert();this._worldTransform=a.clone();this._aabb=new pc.BoundingBox(new pc.Vec3,this.halfExtents)};Object.assign(e.prototype,{intersectsRay:function(a,b){this._modelTransform.transformPoint(a.origin,d.origin);this._modelTransform.transformVector(a.direction,d.direction);return b?(a=this._aabb._intersectsRay(d,
b),c.copy(this._modelTransform).invert().transformPoint(b,b),a):this._aabb._fastIntersectsRay(d)},containsPoint:function(a){this._modelTransform.transformPoint(a,b);return this._aabb.containsPoint(b)},intersectsBoundingSphere:function(b){this._modelTransform.transformPoint(b.center,a.center);a.radius=b.radius;return this._aabb.intersectsBoundingSphere(a)?!0:!1}});Object.defineProperty(e.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(a){this._worldTransform.copy(a);
this._modelTransform.copy(a).invert()}});return{OrientedBox:e}}());(function(){var d={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BLENDEQUATION_MIN:3,BLENDEQUATION_MAX:4,BUFFER_STATIC:0,
BUFFER_DYNAMIC:1,BUFFER_STREAM:2,BUFFER_GPUDYNAMIC:3,CLEARFLAG_COLOR:1,CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,TYPE_INT8:0,TYPE_UINT8:1,TYPE_INT16:2,TYPE_UINT16:3,TYPE_INT32:4,TYPE_UINT32:5,TYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,
FUNC_NEVER:0,FUNC_LESS:1,FUNC_EQUAL:2,FUNC_LESSEQUAL:3,FUNC_GREATER:4,FUNC_NOTEQUAL:5,FUNC_GREATEREQUAL:6,FUNC_ALWAYS:7,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,
PIXELFORMAT_R32F:15,PIXELFORMAT_DEPTH:16,PIXELFORMAT_DEPTHSTENCIL:17,PIXELFORMAT_111110F:18,PIXELFORMAT_SRGB:19,PIXELFORMAT_SRGBA:20,PIXELFORMAT_ETC1:21,PIXELFORMAT_ETC2_RGB:22,PIXELFORMAT_ETC2_RGBA:23,PIXELFORMAT_PVRTC_2BPP_RGB_1:24,PIXELFORMAT_PVRTC_2BPP_RGBA_1:25,PIXELFORMAT_PVRTC_4BPP_RGB_1:26,PIXELFORMAT_PVRTC_4BPP_RGBA_1:27,PIXELFORMAT_ASTC_4x4:28,PIXELFORMAT_ATC_RGB:29,PIXELFORMAT_ATC_RGBA:30,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,
PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",
SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",SHADERTAG_MATERIAL:1,STENCILOP_KEEP:0,STENCILOP_ZERO:1,STENCILOP_REPLACE:2,STENCILOP_INCREMENT:3,STENCILOP_INCREMENTWRAP:4,STENCILOP_DECREMENT:5,
STENCILOP_DECREMENTWRAP:6,STENCILOP_INVERT:7,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,TEXHINT_NONE:0,TEXHINT_SHADOWMAP:1,TEXHINT_ASSET:2,TEXHINT_LIGHTMAP:3,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,
UNIFORMTYPE_FLOATARRAY:17,UNIFORMTYPE_TEXTURE2D_SHADOW:18,UNIFORMTYPE_TEXTURECUBE_SHADOW:19,UNIFORMTYPE_TEXTURE3D:20};Object.assign(pc,d);pc.typedArrayTypes=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array];pc.typedArrayTypesByteSize=[1,1,2,2,4,4,4];pc.typedArrayIndexFormats=[Uint8Array,Uint16Array,Uint32Array];pc.typedArrayIndexFormatsByteSize=[1,2,4];pc.gfx={};Object.assign(pc.gfx,d)})();Object.assign(pc,function(){var d=function(b){this.name=b;this.value=null;this.versionObject=new pc.VersionedObject};Object.assign(d.prototype,{setValue:function(b){this.value=b;this.versionObject.increment()},getValue:function(){return this.value}});return{ScopeId:d}}());Object.assign(pc,function(){var d=function(b){this.name=b;this.variables={};this.namespaces={}};Object.assign(d.prototype,{resolve:function(b){this.variables.hasOwnProperty(b)||(this.variables[b]=new pc.ScopeId(b));return this.variables[b]},getSubSpace:function(b){this.namespaces.hasOwnProperty(b)||(this.namespaces[b]=new pc.ScopeSpace(b));return this.namespaces[b]}});return{ScopeSpace:d}}());Object.assign(pc,function(){var d=function(){this.revision=this.globalId=0};Object.assign(d.prototype,{equals:function(b){return this.globalId===b.globalId&&this.revision===b.revision},notequals:function(b){return this.globalId!==b.globalId||this.revision!==b.revision},copy:function(b){this.globalId=b.globalId;this.revision=b.revision},reset:function(){this.revision=this.globalId=0}});return{Version:d}}());Object.assign(pc,function(){var d=0,b=function(){d++;this.version=new pc.Version;this.version.globalId=d};Object.assign(b.prototype,{increment:function(){this.version.revision++}});return{VersionedObject:b}}());Object.assign(pc,function(){function d(d,q,u){this.index=0;this.numComponents=q.numComponents;this.array=u.interleaved?new pc.typedArrayTypes[q.dataType](d,q.offset):new pc.typedArrayTypes[q.dataType](d,q.offset,u.vertexCount*q.numComponents);this.stride=q.stride/this.array.constructor.BYTES_PER_ELEMENT;switch(q.numComponents){case 1:this.set=b;this.getToArray=h;this.setFromArray=f;break;case 2:this.set=a;this.getToArray=m;this.setFromArray=g;break;case 3:this.set=c;this.getToArray=l;this.setFromArray=
n;break;case 4:this.set=e,this.getToArray=p,this.setFromArray=k}}function b(a){this.array[this.index]=a}function a(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function e(a,b,c,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c;this.array[this.index+3]=e}function f(a,b,c){this.array[a]=b[c]}function g(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1]}function n(a,
b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2]}function k(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2];this.array[a+3]=b[c+3]}function h(a,b,c){b[c]=this.array[a]}function m(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1]}function l(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1];b[c+2]=this.array[a+2]}function p(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1];b[c+2]=this.array[a+2];b[c+3]=this.array[a+3]}function q(a){this.vertexBuffer=a;this.vertexFormatSize=
a.getFormat().size;this.buffer=this.vertexBuffer.lock();this.accessors=[];this.element={};a=this.vertexBuffer.getFormat();for(var b=0;b<a.elements.length;b++){var c=a.elements[b];this.accessors[b]=new d(this.buffer,c,a);this.element[c.name]=this.accessors[b]}}d.prototype.get=function(a){return this.array[this.index+a]};d.prototype.set=function(a,b,c,e){};d.prototype.setFromArray=function(a,b,c){};d.prototype.getToArray=function(a,b,c){};Object.assign(q.prototype,{next:function(a){void 0===a&&(a=1);
for(var b=0,c=this.accessors,e=this.accessors.length;b<e;){var f=c[b++];f.index+=a*f.stride}},end:function(){this.vertexBuffer.unlock()},writeData:function(a,b,c){if(a=this.element[a]){c>this.vertexBuffer.numVertices&&(c=this.vertexBuffer.numVertices);var e,f=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){var g=0;for(e=0;e<c;e++)a.setFromArray(g,b,e*f),g+=a.stride}else if(b.length>c*f)if(c*=f,ArrayBuffer.isView(b))b=b.subarray(0,c),a.array.set(b);else for(e=0;e<c;e++)a.array[e]=b[e];
else a.array.set(b)}},readData:function(a,b){a=this.element[a];var c=0;if(a){c=this.vertexBuffer.numVertices;var e,f=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(b)&&(b.length=0);var g=a.index=0;for(e=0;e<c;e++)a.getToArray(g,b,e*f),g+=a.stride}else if(ArrayBuffer.isView(b))b.set(a.array);else for(b.length=0,f*=c,e=0;e<f;e++)b[e]=a.array[e]}return c}});return{VertexIteratorAccessor:d,VertexIterator:q}}());Object.assign(pc,function(){var d=[];d[pc.TYPE_INT8]=1;d[pc.TYPE_UINT8]=1;d[pc.TYPE_INT16]=2;d[pc.TYPE_UINT16]=2;d[pc.TYPE_INT32]=4;d[pc.TYPE_UINT32]=4;d[pc.TYPE_FLOAT32]=4;var b=function(a,b,e){var c;this.elements=[];this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1;this._defaultInstancingFormat=null;this.verticesByteSize=0;this.vertexCount=e;this.interleaved=!e;this.size=b.reduce(function(a,b){return a+4*Math.ceil(b.components*d[b.type]/4)},0);var g=0;var n=0;for(c=b.length;n<c;n++){var k=
b[n];var h=k.components*d[k.type];e&&(g=pc.math.roundUp(g,h));var m={name:k.semantic,offset:e?g:k.hasOwnProperty("offset")?k.offset:g,stride:e?h:k.hasOwnProperty("stride")?k.stride:this.size,stream:-1,scopeId:a.scope.resolve(k.semantic),dataType:k.type,numComponents:k.components,normalize:void 0===k.normalize?!1:k.normalize,size:h};this.elements.push(m);g=e?g+h*e:g+4*Math.ceil(h/4);k.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:k.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:k.semantic===pc.SEMANTIC_COLOR?
this.hasColor=!0:k.semantic===pc.SEMANTIC_TANGENT&&(this.hasTangents=!0)}e&&(this.verticesByteSize=g);this.batchingHash=this._evaluateBatchingHash()};b.init=function(a){this._defaultInstancingFormat=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,components:4,type:pc.TYPE_FLOAT32}])};Object.defineProperty(b,
"defaultInstancingFormat",{get:function(){return function(){return this._defaultInstancingFormat}}()});Object.assign(b.prototype,{_evaluateBatchingHash:function(){var a=[],b,e=this.elements.length;for(b=0;b<e;b++){var f=this.elements[b];var g=f.name;g+=f.dataType;g+=f.numComponents;g+=f.normalize;a.push(g)}a.sort();return pc.hashCode(a.join())}});return{VertexFormat:b}}());Object.assign(pc,function(){var d=function(b,a,c,e,f){this.usage=e||pc.BUFFER_STATIC;this.format=a;this.numVertices=c;this.numBytes=a.verticesByteSize?a.verticesByteSize:a.size*c;b._vram.vb+=this.numBytes;this.device=b;f?this.setData(f):this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)};Object.assign(d.prototype,{destroy:function(){var b=this.device,a=b.buffers.indexOf(this);-1!==a&&b.buffers.splice(a,1);if(this.bufferId){a=b.gl;a.deleteBuffer(this.bufferId);b._vram.vb-=this.storage.byteLength;
this.bufferId=null;b.boundBuffer=null;b.vertexBuffers.length=0;b.vbOffsets.length=0;b.attributesInvalidated=!0;for(var c in b.enabledAttributes)a.disableVertexAttribArray(Number(c));b.enabledAttributes={}}},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var b=this.device.gl;this.bufferId||(this.bufferId=b.createBuffer());switch(this.usage){case pc.BUFFER_STATIC:var a=
b.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:a=b.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:a=b.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:a=this.device.webgl2?b.DYNAMIC_COPY:b.STATIC_DRAW}b.bindBuffer(b.ARRAY_BUFFER,this.bufferId);b.bufferData(b.ARRAY_BUFFER,this.storage,a)},setData:function(b){if(b.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+b.byteLength),!1;this.storage=b;this.unlock();return!0}});return{VertexBuffer:d}}());Object.assign(pc,function(){var d=function(b,a,c,e,f){this.usage=e||pc.BUFFER_STATIC;this.format=a;this.numIndices=c;this.device=b;c=this.device.gl;if(a===pc.INDEXFORMAT_UINT8){var g=1;this.glFormat=c.UNSIGNED_BYTE}else a===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=c.UNSIGNED_SHORT):a===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=c.UNSIGNED_INT);this.bytesPerIndex=g;this.numBytes=this.numIndices*g;f?this.setData(f):this.storage=new ArrayBuffer(this.numBytes);b._vram.ib+=this.numBytes;this.device.buffers.push(this)};
Object.assign(d.prototype,{destroy:function(){var b=this.device,a=b.buffers.indexOf(this);-1!==a&&b.buffers.splice(a,1);this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var b=this.device.gl;this.bufferId||(this.bufferId=
b.createBuffer());switch(this.usage){case pc.BUFFER_STATIC:var a=b.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:a=b.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:a=b.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:a=this.device.webgl2?b.DYNAMIC_COPY:b.STATIC_DRAW}b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.bufferId);b.bufferData(b.ELEMENT_ARRAY_BUFFER,this.storage,a)},setData:function(b){if(b.byteLength!==this.numBytes)return console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+
b.byteLength),!1;this.storage=b;this.unlock();return!0},_lockTypedArray:function(){var b=this.lock();return this.format===pc.INDEXFORMAT_UINT32?new Uint32Array(b):this.format===pc.INDEXFORMAT_UINT16?new Uint16Array(b):new Uint8Array(b)},writeData:function(b,a){var c=this._lockTypedArray();if(b.length>a)if(ArrayBuffer.isView(b))b=b.subarray(0,a),c.set(b);else{var e;for(e=0;e<a;e++)c[e]=b[e]}else c.set(b);this.unlock()},readData:function(b){var a=this._lockTypedArray(),c=this.numIndices;if(ArrayBuffer.isView(b))b.set(a);
else{b.length=0;var e;for(e=0;e<c;e++)b[e]=a[e]}return c}});return{IndexBuffer:d}}());Object.assign(pc,function(){var d=function(b,a){a=a||pc.BUFFER_GPUDYNAMIC;this.device=b.device;var c=this.device.gl;this._inputBuffer=b;a===pc.BUFFER_GPUDYNAMIC&&b.usage!==a&&(c.bindBuffer(c.ARRAY_BUFFER,b.bufferId),c.bufferData(c.ARRAY_BUFFER,b.storage,c.DYNAMIC_COPY));this._outputBuffer=new pc.VertexBuffer(b.device,b.format,b.numVertices,a,b.storage)};d.createShader=function(b,a,c){return pc.shaderChunks.createShaderFromCode(b,a,null,c,!0)};Object.assign(d.prototype,{destroy:function(){this._outputBuffer.destroy()},
process:function(b,a){void 0===a&&(a=!0);var c=this.device;c.setRenderTarget(null);c.updateBegin();c.setVertexBuffer(this._inputBuffer,0);c.setRaster(!1);c.setTransformFeedbackBuffer(this._outputBuffer);c.setShader(b);c.draw({type:pc.PRIMITIVE_POINTS,base:0,count:this._inputBuffer.numVertices,indexed:!1});c.setTransformFeedbackBuffer(null);c.setRaster(!0);c.updateEnd();a&&(b=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=b)}});Object.defineProperty(d.prototype,
"inputBuffer",{get:function(){return this._inputBuffer}});Object.defineProperty(d.prototype,"outputBuffer",{get:function(){return this._outputBuffer}});return{TransformFeedback:d}}());Object.assign(pc,function(){var d=function(a,b){this.device=a;this.name=null;this._height=this._width=4;this._depth=1;this._format=pc.PIXELFORMAT_R8_G8_B8_A8;this.fixCubemapSeams=this._volume=this._cubemap=this.swizzleGGGR=this.rgbm=!1;this._flipY=!0;this._premultiplyAlpha=!1;this._mipmaps=!0;this._minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._addressW=this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._compareOnRead=!1;this._compareFunc=pc.FUNC_LESS;
void 0!==b&&(void 0!==b.name&&(this.name=b.name),this._width=void 0!==b.width?b.width:this._width,this._height=void 0!==b.height?b.height:this._height,this._format=void 0!==b.format?b.format:this._format,this.rgbm=void 0!==b.rgbm?b.rgbm:this.rgbm,this.swizzleGGGR=void 0!==b.swizzleGGGR?b.swizzleGGGR:this.swizzleGGGR,this._mipmaps=void 0!==b.mipmaps?b.mipmaps:void 0!==b.autoMipmap?b.autoMipmap:this._mipmaps,this._levels=b.levels,this._cubemap=void 0!==b.cubemap?b.cubemap:this._cubemap,this.fixCubemapSeams=
void 0!==b.fixCubemapSeams?b.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==b.minFilter?b.minFilter:this._minFilter,this._magFilter=void 0!==b.magFilter?b.magFilter:this._magFilter,this._anisotropy=void 0!==b.anisotropy?b.anisotropy:this._anisotropy,this._addressU=void 0!==b.addressU?b.addressU:this._addressU,this._addressV=void 0!==b.addressV?b.addressV:this._addressV,this._compareOnRead=void 0!==b.compareOnRead?b.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==b._compareFunc?
b._compareFunc:this._compareFunc,this._flipY=void 0!==b.flipY?b.flipY:this._flipY,this._premultiplyAlpha=void 0!==b.premultiplyAlpha?b.premultiplyAlpha:this._premultiplyAlpha,a.webgl2&&(this._depth=void 0!==b.depth?b.depth:this._depth,this._volume=void 0!==b.volume?b.volume:this._volume,this._addressW=void 0!==b.addressW?b.addressW:this._addressW));this._compressed=this._format===pc.PIXELFORMAT_DXT1||this._format===pc.PIXELFORMAT_DXT3||this._format===pc.PIXELFORMAT_DXT5||this._format>=pc.PIXELFORMAT_ETC1;
this._invalid=!1;this._lockedLevel=-1;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]);this.dirtyAll();this._gpuSize=0};Object.defineProperty(d.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){this._minFilter!==a&&(this._minFilter=a,this._parameterFlags|=1)}});Object.defineProperty(d.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){this._magFilter!==a&&(this._magFilter=a,this._parameterFlags|=2)}});Object.defineProperty(d.prototype,
"addressU",{get:function(){return this._addressU},set:function(a){this._addressU!==a&&(this._addressU=a,this._parameterFlags|=4)}});Object.defineProperty(d.prototype,"addressV",{get:function(){return this._addressV},set:function(a){this._addressV!==a&&(this._addressV=a,this._parameterFlags|=8)}});Object.defineProperty(d.prototype,"addressW",{get:function(){return this._addressW},set:function(a){this.device.webgl2&&this._volume&&a!==this._addressW&&(this._addressW=a,this._parameterFlags|=16)}});Object.defineProperty(d.prototype,
"compareOnRead",{get:function(){return this._compareOnRead},set:function(a){this._compareOnRead!==a&&(this._compareOnRead=a,this._parameterFlags|=32)}});Object.defineProperty(d.prototype,"compareFunc",{get:function(){return this._compareFunc},set:function(a){this._compareFunc!==a&&(this._compareFunc=a,this._parameterFlags|=64)}});Object.defineProperty(d.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(a){this._anisotropy!==a&&(this._anisotropy=a,this._parameterFlags|=128)}});
Object.defineProperty(d.prototype,"autoMipmap",{get:function(){return this._mipmaps},set:function(a){this._mipmaps=a}});Object.defineProperty(d.prototype,"mipmaps",{get:function(){return this._mipmaps},set:function(a){this._mipmaps!==a&&(this._mipmaps=a,this._minFilterDirty=!0,a&&(this._needsMipmapsUpload=!0))}});Object.defineProperty(d.prototype,"width",{get:function(){return this._width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._height}});Object.defineProperty(d.prototype,
"depth",{get:function(){return this._depth}});Object.defineProperty(d.prototype,"format",{get:function(){return this._format}});Object.defineProperty(d.prototype,"cubemap",{get:function(){return this._cubemap}});Object.defineProperty(d.prototype,"gpuSize",{get:function(){return d.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&(this._mipmaps||this._minFilter===pc.FILTER_NEAREST_MIPMAP_NEAREST||this._minFilter===pc.FILTER_NEAREST_MIPMAP_LINEAR||this._minFilter===pc.FILTER_LINEAR_MIPMAP_NEAREST||
this._minFilter===pc.FILTER_LINEAR_MIPMAP_LINEAR)&&!(this._compressed&&1===this._levels.length),this._cubemap)}});Object.defineProperty(d.prototype,"volume",{get:function(){return this._volume}});Object.defineProperty(d.prototype,"flipY",{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._needsUpload=!0)}});Object.defineProperty(d.prototype,"premultiplyAlpha",{get:function(){return this._premultiplyAlpha},set:function(a){this._premultiplyAlpha!==a&&(this._premultiplyAlpha=
a,this._needsUpload=!0)}});Object.defineProperty(d.prototype,"pot",{get:function(){return pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)}});var b=null,a=null;Object.assign(d,{calcGpuSize:function(c,e,f,g,d,k){b||(b=[],b[pc.PIXELFORMAT_A8]=1,b[pc.PIXELFORMAT_L8]=1,b[pc.PIXELFORMAT_L8_A8]=1,b[pc.PIXELFORMAT_R5_G6_B5]=2,b[pc.PIXELFORMAT_R5_G5_B5_A1]=2,b[pc.PIXELFORMAT_R4_G4_B4_A4]=2,b[pc.PIXELFORMAT_R8_G8_B8]=4,b[pc.PIXELFORMAT_R8_G8_B8_A8]=4,b[pc.PIXELFORMAT_RGB16F]=8,b[pc.PIXELFORMAT_RGBA16F]=
8,b[pc.PIXELFORMAT_RGB32F]=16,b[pc.PIXELFORMAT_RGBA32F]=16,b[pc.PIXELFORMAT_R32F]=4,b[pc.PIXELFORMAT_DEPTH]=4,b[pc.PIXELFORMAT_DEPTHSTENCIL]=4,b[pc.PIXELFORMAT_111110F]=4,b[pc.PIXELFORMAT_SRGB]=4,b[pc.PIXELFORMAT_SRGBA]=4);a||(a=[],a[pc.PIXELFORMAT_ETC1]=8,a[pc.PIXELFORMAT_ETC2_RGB]=8,a[pc.PIXELFORMAT_PVRTC_2BPP_RGB_1]=8,a[pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1]=8,a[pc.PIXELFORMAT_PVRTC_4BPP_RGB_1]=8,a[pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1]=8,a[pc.PIXELFORMAT_DXT1]=8,a[pc.PIXELFORMAT_ATC_RGB]=8,a[pc.PIXELFORMAT_ETC2_RGBA]=
16,a[pc.PIXELFORMAT_DXT3]=16,a[pc.PIXELFORMAT_DXT5]=16,a[pc.PIXELFORMAT_ASTC_4x4]=16,a[pc.PIXELFORMAT_ATC_RGBA]=16);for(var h=b.hasOwnProperty(g)?b[g]:0,n=a.hasOwnProperty(g)?a[g]:0,l=0;;){if(0<h)l+=c*e*f*h;else{var p=Math.floor((c+3)/4),q=Math.floor((e+3)/4),r=Math.floor((f+3)/4);if(g===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||g===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1)p=Math.floor(p/2,1);l+=p*q*r*n}if(!d||1===c&&1===e&&1===f)break;c=Math.max(Math.floor(c/2),1);e=Math.max(Math.floor(e/2),1);f=Math.max(Math.floor(f/
2),1)}return l*(k?6:1)}});Object.assign(d.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this);this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0];this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=!1;this._parameterFlags=255},lock:function(a){a=a||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);
this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=
new Uint8Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case pc.PIXELFORMAT_RGB16F:this._levels[a.level]=
new Uint16Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGBA16F:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[a.level]},setSource:function(a,b){var c,e=!1;b=b||0;if(this._cubemap){if(a[0]){var d=a[0].width||
0;var k=a[0].height||0;for(c=0;6>c;c++){var h=a[c];if(!h||h.width!==d||h.height!==k||!("undefined"!==typeof HTMLImageElement&&h instanceof HTMLImageElement||"undefined"!==typeof HTMLCanvasElement&&h instanceof HTMLCanvasElement||"undefined"!==typeof HTMLVideoElement&&h instanceof HTMLVideoElement)){e=!0;break}}}else e=!0;if(!e)for(c=0;6>c;c++)this._levels[b][c]!==a[c]&&(this._levelsUpdated[b][c]=!0)}else"undefined"!==typeof HTMLImageElement&&a instanceof HTMLImageElement||"undefined"!==typeof HTMLCanvasElement&&
a instanceof HTMLCanvasElement||"undefined"!==typeof HTMLVideoElement&&a instanceof HTMLVideoElement||(e=!0),e||(a!==this._levels[b]&&(this._levelsUpdated[b]=!0),d=a.width,k=a.height);if(e)if(this._height=this._width=4,this._cubemap)for(c=0;6>c;c++)this._levels[b][c]=null,this._levelsUpdated[b][c]=!0;else this._levels[b]=null,this._levelsUpdated[b]=!0;else 0===b&&(this._width=d,this._height=k),this._levels[b]=a;this._invalid===e&&e||(this._invalid=e,this.upload())},getSource:function(a){return this._levels[a||
0]},unlock:function(){this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");for(var a=128,b=0,f,g;this._levels[b];){if(this.cubemap)for(g=0;6>g;g++){if(!this._levels[b][g]){console.error("No level data for mip "+b+", face "+g);return}f=this._levels[b][g].length;if(!f){console.error("No byte array for mip "+b+", face "+g);return}a+=
f}else{f=this._levels[b].length;if(!f){console.error("No byte array for mip "+b);return}a+=f}a+=this._levels[b].length;b++}a=new ArrayBuffer(a);g=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);f=4096;1<this._levels.length&&(f|=4194304);if(1<this._levels.length||this.cubemap)f|=8;var d=this.cubemap?65024:0;g[0]=542327876;g[1]=124;g[2]=b;g[3]=this.height;g[4]=this.width;g[5]=this.width*this.height*4;g[6]=0;g[7]=this._levels.length;for(b=0;11>b;b++)g[8+b]=0;g[19]=32;g[20]=65;g[21]=
0;g[22]=32;g[23]=16711680;g[24]=65280;g[25]=255;g[26]=4278190080;g[27]=f;g[28]=d;g[29]=0;g[30]=0;g[31]=0;d=128;if(this.cubemap)for(g=0;6>g;g++)for(b=0;b<this._levels.length;b++){var k=this._levels[b][g];var h=new Uint8Array(a,d,k.length);for(f=0;f<k.length;f++)h[f]=k[f];d+=k.length}else for(b=0;b<this._levels.length;b++){k=this._levels[b];h=new Uint8Array(a,d,k.length);for(f=0;f<k.length;f++)h[f]=k[f];d+=k.length}return a}});return{Texture:d}}());Object.assign(pc,function(){var d={depth:!0,face:0},b=function(a,b,e){a instanceof pc.GraphicsDevice?(this._colorBuffer=b,a=e):this._colorBuffer=a.colorBuffer;this._glDepthBuffer=this._glFrameBuffer=null;a=void 0!==a?a:d;this._depthBuffer=a.depthBuffer;this._face=void 0!==a.face?a.face:0;this._depthBuffer?(b=this._depthBuffer._format,b===pc.PIXELFORMAT_DEPTH?(this._depth=!0,this._stencil=!1):this._stencil=b===pc.PIXELFORMAT_DEPTHSTENCIL?this._depth=!0:this._depth=!1):(this._depth=void 0!==a.depth?
a.depth:!0,this._stencil=void 0!==a.stencil?a.stencil:!1);this._samples=void 0!==a.samples?a.samples:1;this.autoResolve=void 0!==a.autoResolve?a.autoResolve:!0;this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};Object.assign(b.prototype,{destroy:function(){if(this._device){var a=this._device,b=a.targets.indexOf(this);-1!==b&&a.targets.splice(b,1);a=a.gl;this._glFrameBuffer&&(a.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null);this._glDepthBuffer&&(a.deleteRenderbuffer(this._glDepthBuffer),
this._glDepthBuffer=null);this._glResolveFrameBuffer&&(a.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null);this._glMsaaColorBuffer&&(a.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null);this._glMsaaDepthBuffer&&(a.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(a,b){if(this._device&&this._device.webgl2){var c=this._device.gl;void 0===a&&(a=!0);void 0===b&&this._depthBuffer&&(b=!0);c.bindFramebuffer(c.READ_FRAMEBUFFER,
this._glFrameBuffer);c.bindFramebuffer(c.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);c.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(a?c.COLOR_BUFFER_BIT:0)|(b?c.DEPTH_BUFFER_BIT:0),c.NEAREST);c.bindFramebuffer(c.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(a,b,e){if(!this._device)if(a._device)this._device=a._device;else return!1;return this._device.copyRenderTarget(a,this,b,e)}});Object.defineProperty(b.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});
Object.defineProperty(b.prototype,"depthBuffer",{get:function(){return this._depthBuffer}});Object.defineProperty(b.prototype,"face",{get:function(){return this._face}});Object.defineProperty(b.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}});Object.defineProperty(b.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});return{RenderTarget:b}}());Object.assign(pc,function(){return{ShaderInput:function(d,b,a,c){this.locationId=c;this.scopeId=d.scope.resolve(b);this.version=new pc.Version;a===pc.UNIFORMTYPE_FLOAT&&"[0]"===b.substr(b.length-3)&&(a=pc.UNIFORMTYPE_FLOATARRAY);this.dataType=a;this.value=[null,null,null,null];this.array=[]}}}());Object.assign(pc,function(){var d=function(b,a){this.device=b;this.definition=a;this.attributes=[];this.uniforms=[];this.samplers=[];this.ready=!1;this.device.createShader(this)};Object.assign(d.prototype,{destroy:function(){this.device.destroyShader(this)}});return{Shader:d}}());Object.assign(pc,function(){var d=function(b){this._device=b;this._cache={};this._generators={};this._precached=this._isClearingCache=!1;this._programsCollection=[];this._defaultStdMatOption={};this._defaultStdMatOptionMin={};var a=new pc.StandardMaterial;a.shaderOptBuilder.updateRef(this._defaultStdMatOption,b,{},a,null,[],pc.SHADER_FORWARD,null,null);a.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,b,{},a,null,[],pc.SHADER_SHADOW,null,null)};d.prototype.register=function(b,a){this.isRegistered(b)||
(this._generators[b]=a)};d.prototype.unregister=function(b){this.isRegistered(b)&&delete this._generators[b]};d.prototype.isRegistered=function(b){return void 0!==this._generators[b]};d.prototype.getProgram=function(b,a){var c=this._generators[b];if(void 0===c)return null;var e=this._device,f=c.generateKey(a),g=this._cache[f];if(!g){if(a.lights){var d=a.lights;a.lights=d.map(function(a){var b=a.clone?a.clone():a;b.key=a.key;return b})}this.storeNewProgram(b,a);a.lights&&(a.lights=d);this._precached&&
console.warn("ProgramLibrary#getProgram: Cache miss for shader",b,"key",f,"after shaders precaching");b=c.createShaderDefinition(e,a);g=this._cache[f]=new pc.Shader(e,b)}return g};d.prototype.storeNewProgram=function(b,a){var c={};if("standard"===b){var e=this._getDefaultStdMatOptions(a.pass),f;for(f in a)if(a.hasOwnProperty(f)&&e[f]!==a[f]||"pass"===f)c[f]=a[f]}else c=a;this._programsCollection.push(JSON.stringify({name:b,options:c}))};d.prototype.dumpPrograms=function(){var b="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";
this._programsCollection[0]&&(b+="\n\t"+this._programsCollection[0]);for(var a=1;a<this._programsCollection.length;++a)b+=",\n\t"+this._programsCollection[a];b=b+'\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "'+(pc.version+'" || pc.revision != "'+pc.revision+'")\n');b+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(b));
a.setAttribute("download","precompile-shaders.js");a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a)};d.prototype.clearCache=function(){var b=this._cache;this._isClearingCache=!0;for(var a in b)b.hasOwnProperty(a)&&b[a].destroy();this._cache={};this._isClearingCache=!1};d.prototype.removeFromCache=function(b){if(!this._isClearingCache){var a=this._cache,c;for(c in a)if(a.hasOwnProperty(c)&&a[c]===b){delete a[c];break}}};d.prototype._getDefaultStdMatOptions=
function(b){return b>pc.SHADER_FORWARDHDR&&b<=pc.SHADER_PICK?this._defaultStdMatOptionMin:this._defaultStdMatOption};d.prototype.precompile=function(b){if(b)for(var a=Array(b.length),c=0;c<b.length;c++){if("standard"===b[c].name){var e=b[c].options,f=this._getDefaultStdMatOptions(e.pass),g;for(g in f)f.hasOwnProperty(g)&&void 0===e[g]&&(e[g]=f[g]);e.useTexCubeLod=this._device.useTexCubeLod}a[c]=this.getProgram(b[c].name,b[c].options)}this._precached=!0};return{ProgramLibrary:d}}());Object.assign(pc,function(){function d(a,b){var c=!0,e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,b,null);b=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b);a.framebufferTexture2D(a.FRAMEBUFFER,
a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE&&(c=!1);a.bindTexture(a.TEXTURE_2D,null);a.deleteTexture(e);a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteFramebuffer(b);return c}var b=function(a,b){var c=a.width,e=a.height;if(c>b||e>b){var d=b/Math.max(c,e),k=Math.floor(c*d);d=Math.floor(e*d);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+c+", "+e+" to "+k+", "+d+".");b=document.createElement("canvas");
b.width=k;b.height=d;b.getContext("2d").drawImage(a,0,0,c,e,0,0,k,d);return b}return a},a=function(a,b){pc.EventHandler.call(this);var c;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.vbOffsets=[];this._enableAutoInstancing=!1;this.autoInstancingMaxObjects=16384;this.attributesInvalidated=!0;this.boundElementBuffer=this.boundBuffer=this.defaultFramebuffer=null;this.instancedAttribs={};this.enabledAttributes={};this.activeFramebuffer=this.transformFeedbackBuffer=null;this.textureUnit=
0;this.textureUnits=[];this._maxPixelRatio=1;this.feedback=this.renderTarget=null;this._tempEnableSafariTextureUnitWorkaround=!!window.safari;this._height=this._width=0;this.updateClientRect();this.vertexShaderCache={};this.fragmentShaderCache={};this.shaders=[];this.buffers=[];this.textures=[];this.targets=[];this.contextLost=!1;this._contextLostHandler=function(a){a.preventDefault();this.contextLost=!0;this.fire("devicelost")}.bind(this);this._contextRestoredHandler=function(){this.initializeContext();
this.contextLost=!1;this.fire("devicerestored")}.bind(this);a.addEventListener("webglcontextlost",this._contextLostHandler,!1);a.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);var e=b&&void 0!==b.preferWebGl2?b.preferWebGl2:!0,n=e?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],k=null;b=b||{};b.stencil=!0;for(c=0;c<n.length;c++){try{k=a.getContext(n[c],b)}catch(t){}if(k){this.webgl2=e&&2>c;break}}if(!k)throw Error("WebGL not supported");
this.gl=k;this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();for(c=0;c<this.maxCombinedTextures;c++)this.textureUnits.push([null,null,null]);this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[k.REPEAT,k.CLAMP_TO_EDGE,k.MIRRORED_REPEAT];this.glBlendEquation=[k.FUNC_ADD,k.FUNC_SUBTRACT,k.FUNC_REVERSE_SUBTRACT,this.webgl2?k.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:k.FUNC_ADD,this.webgl2?
k.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:k.FUNC_ADD];this.glBlendFunction=[k.ZERO,k.ONE,k.SRC_COLOR,k.ONE_MINUS_SRC_COLOR,k.DST_COLOR,k.ONE_MINUS_DST_COLOR,k.SRC_ALPHA,k.SRC_ALPHA_SATURATE,k.ONE_MINUS_SRC_ALPHA,k.DST_ALPHA,k.ONE_MINUS_DST_ALPHA];this.glComparison=[k.NEVER,k.LESS,k.EQUAL,k.LEQUAL,k.GREATER,k.NOTEQUAL,k.GEQUAL,k.ALWAYS];this.glStencilOp=[k.KEEP,k.ZERO,k.REPLACE,k.INCR,k.INCR_WRAP,k.DECR,k.DECR_WRAP,k.INVERT];this.glClearFlag=[0,k.COLOR_BUFFER_BIT,k.DEPTH_BUFFER_BIT,k.COLOR_BUFFER_BIT|
k.DEPTH_BUFFER_BIT,k.STENCIL_BUFFER_BIT,k.STENCIL_BUFFER_BIT|k.COLOR_BUFFER_BIT,k.STENCIL_BUFFER_BIT|k.DEPTH_BUFFER_BIT,k.STENCIL_BUFFER_BIT|k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT];this.glCull=[0,k.BACK,k.FRONT,k.FRONT_AND_BACK];this.glFilter=[k.NEAREST,k.LINEAR,k.NEAREST_MIPMAP_NEAREST,k.NEAREST_MIPMAP_LINEAR,k.LINEAR_MIPMAP_NEAREST,k.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[k.POINTS,k.LINES,k.LINE_LOOP,k.LINE_STRIP,k.TRIANGLES,k.TRIANGLE_STRIP,k.TRIANGLE_FAN];this.glType=[k.BYTE,k.UNSIGNED_BYTE,k.SHORT,
k.UNSIGNED_SHORT,k.INT,k.UNSIGNED_INT,k.FLOAT];this.pcUniformType={};this.pcUniformType[k.BOOL]=pc.UNIFORMTYPE_BOOL;this.pcUniformType[k.INT]=pc.UNIFORMTYPE_INT;this.pcUniformType[k.FLOAT]=pc.UNIFORMTYPE_FLOAT;this.pcUniformType[k.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;this.pcUniformType[k.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;this.pcUniformType[k.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4;this.pcUniformType[k.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;this.pcUniformType[k.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;this.pcUniformType[k.INT_VEC4]=
pc.UNIFORMTYPE_IVEC4;this.pcUniformType[k.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;this.pcUniformType[k.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;this.pcUniformType[k.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;this.pcUniformType[k.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;this.pcUniformType[k.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;this.pcUniformType[k.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;this.pcUniformType[k.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;this.pcUniformType[k.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;this.webgl2&&(this.pcUniformType[k.SAMPLER_2D_SHADOW]=
pc.UNIFORMTYPE_TEXTURE2D_SHADOW,this.pcUniformType[k.SAMPLER_CUBE_SHADOW]=pc.UNIFORMTYPE_TEXTURECUBE_SHADOW,this.pcUniformType[k.SAMPLER_3D]=pc.UNIFORMTYPE_TEXTURE3D);this.targetToSlot={};this.targetToSlot[k.TEXTURE_2D]=0;this.targetToSlot[k.TEXTURE_CUBE_MAP]=1;this.targetToSlot[k.TEXTURE_3D]=2;var h,m,l,p,q;this.commitFunction=[];this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){a.value!==b&&(k.uniform1i(a.locationId,b),a.value=b)};this.commitFunction[pc.UNIFORMTYPE_INT]=this.commitFunction[pc.UNIFORMTYPE_BOOL];
this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(a,b){a.value!==b&&(k.uniform1f(a.locationId,b),a.value=b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(a,b){q=a.value;h=b[0];m=b[1];if(q[0]!==h||q[1]!==m)k.uniform2fv(a.locationId,b),q[0]=h,q[1]=m};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(a,b){q=a.value;h=b[0];m=b[1];l=b[2];if(q[0]!==h||q[1]!==m||q[2]!==l)k.uniform3fv(a.locationId,b),q[0]=h,q[1]=m,q[2]=l};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(a,b){q=a.value;h=b[0];m=b[1];
l=b[2];p=b[3];if(q[0]!==h||q[1]!==m||q[2]!==l||q[3]!==p)k.uniform4fv(a.locationId,b),q[0]=h,q[1]=m,q[2]=l,q[3]=p};this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(a,b){q=a.value;h=b[0];m=b[1];if(q[0]!==h||q[1]!==m)k.uniform2iv(a.locationId,b),q[0]=h,q[1]=m};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=this.commitFunction[pc.UNIFORMTYPE_IVEC2];this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(a,b){q=a.value;h=b[0];m=b[1];l=b[2];if(q[0]!==h||q[1]!==m||q[2]!==l)k.uniform3iv(a.locationId,b),q[0]=h,q[1]=
m,q[2]=l};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=this.commitFunction[pc.UNIFORMTYPE_IVEC3];this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(a,b){q=a.value;h=b[0];m=b[1];l=b[2];p=b[3];if(q[0]!==h||q[1]!==m||q[2]!==l||q[3]!==p)k.uniform4iv(a.locationId,b),q[0]=h,q[1]=m,q[2]=l,q[3]=p};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=this.commitFunction[pc.UNIFORMTYPE_IVEC4];this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,b){k.uniformMatrix2fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=
function(a,b){k.uniformMatrix3fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(a,b){k.uniformMatrix4fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_FLOATARRAY]=function(a,b){k.uniform1fv(a.locationId,b)};this.scope=new pc.ScopeSpace("Device");this.programLib=new pc.ProgramLibrary(this);for(var r in pc.programlib)this.programLib.register(r,pc.programlib[r]);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.useTexCubeLod=this.extTextureLod&&
16>this.maxTextures;this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/4);this.boneLimit=Math.min(this.boneLimit,128);"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34);this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0;this._primsPerFrame=[];for(c=pc.PRIMITIVE_POINTS;c<=pc.PRIMITIVE_TRIFAN;c++)this._primsPerFrame[c]=0;this._renderTargetCreationTime=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};this.constantTexSource=
this.scope.resolve("source");this.textureFloatRenderable=this.extTextureFloat?this.webgl2?!!this.extColorBufferFloat:d(k,k.FLOAT):!1;this.textureHalfFloatRenderable=this.extTextureHalfFloat?this.webgl2?!!this.extColorBufferFloat:d(k,this.extTextureHalfFloat.HALF_FLOAT_OES):!1;this._textureFloatHighPrecision=void 0;this.createGrabPass(b.alpha);pc.VertexFormat.init(this)};a.prototype=Object.create(pc.EventHandler.prototype);a.prototype.constructor=a;Object.assign(a.prototype,{getPrecision:function(){var a=
this.gl,b="highp";if(a.getShaderPrecisionFormat){var f=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.HIGH_FLOAT),g=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.MEDIUM_FLOAT),d=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT);a=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT);g=0<g.precision&&0<a.precision;0<f.precision&&0<d.precision||(b=g?"mediump":"lowp")}return b},initializeExtensions:function(){var a=this.gl,b=a.getSupportedExtensions(),f=function(){for(var c=null,e=0;e<arguments.length;e++)-1!==
b.indexOf(arguments[e])&&(c=a.getExtension(arguments[e]));return c};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=f("EXT_color_buffer_float"),this.extDisjointTimerQuery=f("EXT_disjoint_timer_query_webgl2")||f("EXT_disjoint_timer_query");else{this.extBlendMinmax=f("EXT_blend_minmax");
this.extDrawBuffers=f("EXT_draw_buffers");if(this.extInstancing=f("ANGLE_instanced_arrays")){var g=this.extInstancing;a.drawArraysInstanced=g.drawArraysInstancedANGLE.bind(g);a.drawElementsInstanced=g.drawElementsInstancedANGLE.bind(g);a.vertexAttribDivisor=g.vertexAttribDivisorANGLE.bind(g)}this.extStandardDerivatives=f("OES_standard_derivatives");this.extTextureFloat=f("OES_texture_float");this.extTextureHalfFloat=f("OES_texture_half_float");this.extTextureHalfFloatLinear=f("OES_texture_half_float_linear");
this.extTextureLod=f("EXT_shader_texture_lod");this.extUintElement=f("OES_element_index_uint");if(this.extVertexArrayObject=f("OES_vertex_array_object"))g=this.extVertexArrayObject,a.createVertexArray=g.createVertexArrayOES.bind(g),a.deleteVertexArray=g.deleteVertexArrayOES.bind(g),a.isVertexArray=g.isVertexArrayOES.bind(g),a.bindVertexArray=g.bindVertexArrayOES.bind(g);this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=f("WEBGL_debug_renderer_info");this.extTextureFloatLinear=
f("OES_texture_float_linear");this.extTextureFilterAnisotropic=f("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic");this.extCompressedTextureETC1=f("WEBGL_compressed_texture_etc1");this.extCompressedTextureETC=f("WEBGL_compressed_texture_etc");this.extCompressedTexturePVRTC=f("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc");this.extCompressedTextureS3TC=f("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc");this.extCompressedTextureATC=
f("WEBGL_compressed_texture_atc");this.extCompressedTextureASTC=f("WEBGL_compressed_texture_astc");this.extParallelShaderCompile=f("KHR_parallel_shader_compile");this.supportsInstancing=!!this.extInstancing},initializeCapabilities:function(){var a=this.gl;this.maxPrecision=this.precision=this.getPrecision();var b=a.getContextAttributes();this.supportsMsaa=b.antialias;this.supportsStencil=b.stencil;this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);
this.maxRenderBufferSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.maxTextures=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.maxCombinedTextures=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.webgl2?(this.maxDrawBuffers=a.getParameter(a.MAX_DRAW_BUFFERS),this.maxColorAttachments=
a.getParameter(a.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(b=this.extDrawBuffers)?a.getParameter(b.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=b?a.getParameter(b.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1);this.unmaskedRenderer=(b=this.extDebugRendererInfo)?a.getParameter(b.UNMASKED_RENDERER_WEBGL):"";this.unmaskedVendor=b?a.getParameter(b.UNMASKED_VENDOR_WEBGL):"";this.maxAnisotropy=(b=this.extTextureFilterAnisotropic)?a.getParameter(b.MAX_TEXTURE_MAX_ANISOTROPY_EXT):
1;this.samples=a.getParameter(a.SAMPLES)},initializeRenderState:function(){var a=this.gl;this.blending=!1;a.disable(a.BLEND);this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendSrcAlpha=pc.BLENDMODE_ONE;this.blendDstAlpha=pc.BLENDMODE_ZERO;this.separateAlphaBlend=!1;this.blendAlphaEquation=this.blendEquation=pc.BLENDEQUATION_ADD;this.separateAlphaEquation=!1;a.blendFunc(a.ONE,a.ZERO);a.blendEquation(a.FUNC_ADD);this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0;a.colorMask(!0,
!0,!0,!0);this.cullMode=pc.CULLFACE_BACK;a.enable(a.CULL_FACE);a.cullFace(a.BACK);this.depthTest=!0;a.enable(a.DEPTH_TEST);this.depthFunc=pc.FUNC_LESSEQUAL;a.depthFunc(a.LEQUAL);this.depthWrite=!0;a.depthMask(!0);this.stencil=!1;a.disable(a.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=pc.FUNC_ALWAYS;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=255;a.stencilFunc(a.ALWAYS,0,255);this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=
this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=pc.STENCILOP_KEEP;this.stencilWriteMaskBack=this.stencilWriteMaskFront=255;a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.stencilMask(255);this.alphaToCoverage=!1;this.raster=!0;this.webgl2&&(a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.disable(a.RASTERIZER_DISCARD));this.depthBiasEnabled=!1;a.disable(a.POLYGON_OFFSET_FILL);this.clearDepth=1;a.clearDepth(1);this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0;a.clearColor(0,0,0,0);this.clearStencil=
0;a.clearStencil(0);this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0;this.webgl2?a.hint(a.FRAGMENT_SHADER_DERIVATIVE_HINT,a.NICEST):this.extStandardDerivatives&&a.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,a.NICEST);a.enable(a.SCISSOR_TEST);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.NONE);this.unpackFlipY=!1;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);this.unpackPremultiplyAlpha=!1;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){this.initializeExtensions();
this.initializeCapabilities();this.initializeRenderState();var a;var b=0;for(a=this.shaders.length;b<a;b++)this.compileAndLinkShader(this.shaders[b]);this.shader=null;b=0;for(a=this.buffers.length;b<a;b++)this.buffers[b].bufferId=void 0,this.buffers[b].unlock();this.indexBuffer=this.boundElementBuffer=this.boundBuffer=null;this.attributesInvalidated=!0;this.enabledAttributes={};this.vertexBuffers=[];b=0;for(a=this.textures.length;b<a;b++){var f=this.textures[b];this.destroyTexture(f);f.dirtyAll()}this.textureUnit=
0;for(b=this.textureUnits.length=0;b<this.maxCombinedTextures;b++)this.textureUnits.push([null,null,null]);b=0;for(a=this.targets.length;b<a;b++)this.targets[b]._glFrameBuffer=void 0,this.targets[b]._glDepthBuffer=void 0,this.targets[b]._glResolveFrameBuffer=void 0,this.targets[b]._glMsaaColorBuffer=void 0,this.targets[b]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},createGrabPass:function(a){if(!this.grabPassTexture){a=new pc.Texture(this,
{format:a?pc.PIXELFORMAT_R8_G8_B8_A8:pc.PIXELFORMAT_R8_G8_B8,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,mipmaps:!1});a.name="texture_grabPass";var b=this.scope.resolve(a.name);b.setValue(a);this.grabPassRenderTarget=new pc.RenderTarget({colorBuffer:a,depth:!1});this.grabPassTextureId=b;this.grabPassTexture=a}},updateGrabPass:function(){var a=this.gl,b=this.renderTarget,f=b&&b._glResolveFrameBuffer,g=this.grabPassTexture,
d=this.width,k=this.height;this.webgl2&&d===g._width&&k===g._height?(f&&b.resolve(!0),f=b?b._glFrameBuffer:null,b=b?b._glResolveFrameBuffer||b._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),g=this.grabPassRenderTarget._glFrameBuffer,a.bindFramebuffer(a.READ_FRAMEBUFFER,b),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,g),a.blitFramebuffer(0,0,d,k,0,0,d,k,a.COLOR_BUFFER_BIT,a.NEAREST),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,f)):(f&&(b.resolve(!0),a.bindFramebuffer(a.FRAMEBUFFER,b._glResolveFrameBuffer)),
a.copyTexImage2D(a.TEXTURE_2D,0,g._glFormat,0,0,d,k,0),g._width=d,g._height=k,f&&a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer))},destroyGrabPass:function(){this.grabPassRenderTarget.destroy();this.grabPassTextureId=this.grabPassRenderTarget=null;this.grabPassTexture.destroy();this.grabPassTexture=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(a,b,f,g){if(this.vx!==a||this.vy!==b||this.vw!==f||this.vh!==g)this.gl.viewport(a,b,f,g),this.vx=
a,this.vy=b,this.vw=f,this.vh=g},setScissor:function(a,b,f,g){if(this.sx!==a||this.sy!==b||this.sw!==f||this.sh!==g)this.gl.scissor(a,b,f,g),this.sx=a,this.sy=b,this.sw=f,this.sh=g},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},setFramebuffer:function(a){this.activeFramebuffer!==a&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.activeFramebuffer=a)},_checkFbo:function(){var a=this.gl;switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(a,b,f,g){var c=this.gl;if(!this.webgl2&&g)return!1;if(f)if(!b){if(!a._colorBuffer)return!1}else if(!a._colorBuffer||!b._colorBuffer||a._colorBuffer._format!==b._colorBuffer._format)return!1;
if(g&&(!a._depthBuffer||!b._depthBuffer||a._depthBuffer._format!==b._depthBuffer._format))return!1;if(this.webgl2&&b){var e=this.renderTarget;this.renderTarget=b;this.updateBegin();c.bindFramebuffer(c.READ_FRAMEBUFFER,a?a._glFrameBuffer:null);c.bindFramebuffer(c.DRAW_FRAMEBUFFER,b._glFrameBuffer);var d=a?a.width:b.width;a=a?a.height:b.height;c.blitFramebuffer(0,0,d,a,0,0,d,a,(f?c.COLOR_BUFFER_BIT:0)|(g?c.DEPTH_BUFFER_BIT:0),c.NEAREST);this.renderTarget=e;c.bindFramebuffer(c.FRAMEBUFFER,e?e._glFrameBuffer:
null)}else f=this.getCopyShader(),this.constantTexSource.setValue(a._colorBuffer),pc.drawQuadWithShader(this,b,f);return!0},initRenderTarget:function(a){if(!a._glFrameBuffer){a._device=this;var b=this.gl;a._glFrameBuffer=b.createFramebuffer();this.setFramebuffer(a._glFrameBuffer);var c=a._colorBuffer;c&&(c._glTexture||(c._width=Math.min(c.width,this.maxRenderBufferSize),c._height=Math.min(c.height,this.maxRenderBufferSize),this.setTexture(c,0)),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,
c._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,c._glTexture,0));var g=a._depthBuffer;g&&this.webgl2?(g._glTexture||(g._width=Math.min(g.width,this.maxRenderBufferSize),g._height=Math.min(g.height,this.maxRenderBufferSize),this.setTexture(g,0)),a._stencil?b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,g._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0):b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,g._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+
a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0)):!a._depth||1<a._samples&&this.webgl2||(a._glDepthBuffer||(a._glDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glDepthBuffer),a._stencil?(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_STENCIL,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)):(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,
b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)),b.bindRenderbuffer(b.RENDERBUFFER,null));this.webgl2&&1<a._samples&&(a._glResolveFrameBuffer=a._glFrameBuffer,a._glFrameBuffer=b.createFramebuffer(),this.setFramebuffer(a._glFrameBuffer),c&&(a._glMsaaColorBuffer||(a._glMsaaColorBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glMsaaColorBuffer),b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,c._glInternalFormat,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,
b.COLOR_ATTACHMENT0,b.RENDERBUFFER,a._glMsaaColorBuffer)),a._depth&&(a._glMsaaDepthBuffer||(a._glMsaaDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glMsaaDepthBuffer),a._stencil?(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,b.DEPTH24_STENCIL8,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a._glMsaaDepthBuffer)):(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,b.DEPTH_COMPONENT32F,a.width,a.height),
b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glMsaaDepthBuffer))));this.targets.push(a)}},getCopyShader:function(){if(!this._copyShader){var a=pc.shaderChunks;this._copyShader=a.createShaderFromCode(this,a.fullscreenQuadVS,a.outputTex2DPS,"outputTex2D")}return this._copyShader},updateBegin:function(){this.boundElementBuffer=this.boundBuffer=null;if(this._tempEnableSafariTextureUnitWorkaround)for(var a=0;a<this.textureUnits.length;++a)for(var b=0;3>b;++b)this.textureUnits[a][b]=
null;(a=this.renderTarget)?a._glFrameBuffer?this.setFramebuffer(a._glFrameBuffer):this.initRenderTarget(a):this.setFramebuffer(this.defaultFramebuffer)},updateEnd:function(){var a=this.gl,b=this.renderTarget;if(b){var f=b._colorBuffer;f&&f._glTexture&&f.mipmaps&&f.pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(f),a.generateMipmap(f._glTarget));this.webgl2&&1<b._samples&&b.autoResolve&&b.resolve()}},initializeTexture:function(a){var b=this.gl;a._glTexture=b.createTexture();a._glTarget=
a._cubemap?b.TEXTURE_CUBE_MAP:a._volume?b.TEXTURE_3D:b.TEXTURE_2D;switch(a._format){case pc.PIXELFORMAT_A8:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:a._glFormat=b.RGB;a._glInternalFormat=
b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB8:b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?
b.RGBA8:b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:var c=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_ETC1:c=this.extCompressedTextureETC1;
a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ETC1_WEBGL;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;
break;case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_ETC2_RGB:c=this.extCompressedTextureETC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB8_ETC2;break;case pc.PIXELFORMAT_ETC2_RGBA:c=this.extCompressedTextureETC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA8_ETC2_EAC;break;case pc.PIXELFORMAT_ASTC_4x4:c=this.extCompressedTextureASTC;a._glFormat=b.RGBA;a._glInternalFormat=
c.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case pc.PIXELFORMAT_ATC_RGB:c=this.extCompressedTextureATC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ATC_WEBGL;break;case pc.PIXELFORMAT_ATC_RGBA:c=this.extCompressedTextureATC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case pc.PIXELFORMAT_RGB16F:c=this.extTextureHalfFloat;a._glFormat=b.RGB;this.webgl2?(a._glInternalFormat=b.RGB16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGB,a._glPixelType=
c.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGBA16F:c=this.extTextureHalfFloat;a._glFormat=b.RGBA;this.webgl2?(a._glInternalFormat=b.RGBA16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGBA,a._glPixelType=c.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB32F:b.RGB;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA32F:b.RGBA;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_R32F:a._glFormat=
b.RED;a._glInternalFormat=b.R32F;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_DEPTH:this.webgl2?(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT32F,a._glPixelType=b.FLOAT):(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT,a._glPixelType=b.UNSIGNED_SHORT);break;case pc.PIXELFORMAT_DEPTHSTENCIL:a._glFormat=b.DEPTH_STENCIL;a._glInternalFormat=b.DEPTH24_STENCIL8;a._glPixelType=b.UNSIGNED_INT_24_8;break;case pc.PIXELFORMAT_111110F:a._glFormat=b.RGB;a._glInternalFormat=
b.R11F_G11F_B10F;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_SRGB:a._glFormat=b.RGB;a._glInternalFormat=b.SRGB8;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_SRGBA:a._glFormat=b.RGBA,a._glInternalFormat=b.SRGB8_ALPHA8,a._glPixelType=b.UNSIGNED_BYTE}this.textures.push(a)},destroyTexture:function(a){if(a._glTexture){var b=this.textures.indexOf(a);-1!==b&&this.textures.splice(b,1);for(var c in this.scope.variables)b=this.scope.variables[c],b.value===a&&(b.value=null);for(c=0;c<this.textureUnits.length;c++){b=
this.textureUnits[c];for(var g=0;g<b.length;g++)b[g]===a._glTexture&&(b[g]=null)}this.gl.deleteTexture(a._glTexture);delete a._glTexture;delete a._glTarget;delete a._glFormat;delete a._glInternalFormat;delete a._glPixelType;this._vram.tex-=a._gpuSize}},setUnpackFlipY:function(a){if(this.unpackFlipY!==a){this.unpackFlipY=a;var b=this.gl;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a)}},setUnpackPremultiplyAlpha:function(a){if(this.unpackPremultiplyAlpha!==a){this.unpackPremultiplyAlpha=a;var b=this.gl;b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,
a)}},uploadTexture:function(a){var c=this.gl;if(a._needsUpload||!(a._needsMipmapsUpload&&a._mipmapsUploaded||!a.pot)){for(var f=0,g,d,k=Math.log2(Math.max(a._width,a._height))+1;a._levels[f]||0===f;){if(a._needsUpload||0!==f){if(f&&(!a._needsMipmapsUpload||!a._mipmaps))break;g=a._levels[f];1==f&&!a._compressed&&a._levels.length<k&&(c.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);if(a._cubemap){var h;if(g[0]instanceof HTMLCanvasElement||g[0]instanceof HTMLImageElement||g[0]instanceof HTMLVideoElement)for(h=
0;6>h;h++)a._levelsUpdated[0][h]&&(d=g[h],d instanceof HTMLImageElement&&(d.width>this.maxCubeMapSize||d.height>this.maxCubeMapSize)&&(d=b(d,this.maxCubeMapSize),0===f&&(a.width=d.width,a.height=d.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+h,f,a._glInternalFormat,a._glFormat,a._glPixelType,d));else for(d=1/Math.pow(2,f),h=0;6>h;h++)if(a._levelsUpdated[0][h]){var m=g[h];a._compressed?c.compressedTexImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+
h,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),0,m):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+h,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),0,a._glFormat,a._glPixelType,m))}}else a._volume?(d=1/Math.pow(2,f),a._compressed?c.compressedTexImage3D(c.TEXTURE_3D,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),Math.max(a._depth*d,1),0,g):(this.setUnpackFlipY(!1),
this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage3D(c.TEXTURE_3D,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),Math.max(a._depth*d,1),0,a._glFormat,a._glPixelType,g))):(g instanceof HTMLCanvasElement||g instanceof HTMLImageElement||g instanceof HTMLVideoElement?(g instanceof HTMLImageElement&&(g.width>this.maxTextureSize||g.height>this.maxTextureSize)&&(g=b(g,this.maxTextureSize),0===f&&(a.width=g.width,a.height=g.height)),this.setUnpackFlipY(a._flipY),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),
c.texImage2D(c.TEXTURE_2D,f,a._glInternalFormat,a._glFormat,a._glPixelType,g)):(d=1/Math.pow(2,f),a._compressed?c.compressedTexImage2D(c.TEXTURE_2D,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),0,g):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_2D,f,a._glInternalFormat,Math.max(a._width*d,1),Math.max(a._height*d,1),0,a._glFormat,a._glPixelType,g))),a._mipmapsUploaded=0===f?!1:!0)}f++}if(a._needsUpload)if(a._cubemap)for(f=
0;6>f;f++)a._levelsUpdated[0][f]=!1;else a._levelsUpdated[0]=!1;!a._compressed&&a._mipmaps&&a._needsMipmapsUpload&&a.pot&&1===a._levels.length&&(c.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);a._gpuSize&&(this._vram.tex-=a._gpuSize);a._gpuSize=a.gpuSize;this._vram.tex+=a._gpuSize}},activeTexture:function(a){this.textureUnit!==a&&(this.gl.activeTexture(this.gl.TEXTURE0+a),this.textureUnit=a)},bindTexture:function(a){var b=a._glTarget;a=a._glTexture;var c=this.textureUnit,g=this.targetToSlot[b];
this.textureUnits[c][g]!==a&&(this.gl.bindTexture(b,a),this.textureUnits[c][g]=a)},bindTextureOnUnit:function(a,b){var c=a._glTarget;a=a._glTexture;var e=this.targetToSlot[c];this.textureUnits[b][e]!==a&&(this.activeTexture(b),this.gl.bindTexture(c,a),this.textureUnits[b][e]=a)},setTextureParameters:function(a){var b=this.gl,c=a._parameterFlags,g=a._glTarget;if(c&1){var d=a._minFilter;if(!a.pot||!a._mipmaps||a._compressed&&1===a._levels.length)if(d===pc.FILTER_NEAREST_MIPMAP_NEAREST||d===pc.FILTER_NEAREST_MIPMAP_LINEAR)d=
pc.FILTER_NEAREST;else if(d===pc.FILTER_LINEAR_MIPMAP_NEAREST||d===pc.FILTER_LINEAR_MIPMAP_LINEAR)d=pc.FILTER_LINEAR;b.texParameteri(g,b.TEXTURE_MIN_FILTER,this.glFilter[d])}c&2&&b.texParameteri(g,b.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);c&4&&(this.webgl2?b.texParameteri(g,b.TEXTURE_WRAP_S,this.glAddress[a._addressU]):b.texParameteri(g,b.TEXTURE_WRAP_S,this.glAddress[a.pot?a._addressU:pc.ADDRESS_CLAMP_TO_EDGE]));c&8&&(this.webgl2?b.texParameteri(g,b.TEXTURE_WRAP_T,this.glAddress[a._addressV]):
b.texParameteri(g,b.TEXTURE_WRAP_T,this.glAddress[a.pot?a._addressV:pc.ADDRESS_CLAMP_TO_EDGE]));c&16&&this.webgl2&&b.texParameteri(g,b.TEXTURE_WRAP_R,this.glAddress[a._addressW]);c&32&&this.webgl2&&b.texParameteri(g,b.TEXTURE_COMPARE_MODE,a._compareOnRead?b.COMPARE_REF_TO_TEXTURE:b.NONE);c&64&&this.webgl2&&b.texParameteri(g,b.TEXTURE_COMPARE_FUNC,this.glComparison[a._compareFunc]);c&128&&(c=this.extTextureFilterAnisotropic)&&b.texParameterf(g,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(a._anisotropy),
this.maxAnisotropy)))},setTexture:function(a,b){a._glTexture||this.initializeTexture(a);if(0<a._parameterFlags||a._needsUpload||a._needsMipmapsUpload||a===this.grabPassTexture)if(this.activeTexture(b),this.bindTexture(a),a._parameterFlags&&(this.setTextureParameters(a),a._parameterFlags=0),a===this.grabPassTexture)this.updateGrabPass();else{if(a._needsUpload||a._needsMipmapsUpload)this.uploadTexture(a),a._needsUpload=!1,a._needsMipmapsUpload=!1}else this.bindTextureOnUnit(a,b)},setBuffers:function(a){var b=
this.gl,c=this.shader.attributes;if(this.attributesInvalidated){for(var g=0,d=c.length;g<d;g++){var k=c[g];var h=k.scopeId.value;if(null!==h){var m=this.vertexBuffers[h.stream];var l=this.vbOffsets[h.stream]||0;m=m.bufferId;this.boundBuffer!==m&&(b.bindBuffer(b.ARRAY_BUFFER,m),this.boundBuffer=m);k=k.locationId;this.enabledAttributes[k]||(b.enableVertexAttribArray(k),this.enabledAttributes[k]=!0);b.vertexAttribPointer(k,h.numComponents,this.glType[h.dataType],h.normalize,h.stride,h.offset+l);1===
h.stream&&0<a?this.instancedAttribs[k]||(b.vertexAttribDivisor(k,1),this.instancedAttribs[k]=!0):this.instancedAttribs[k]&&(b.vertexAttribDivisor(k,0),this.instancedAttribs[k]=!1)}}this.attributesInvalidated=!1}m=this.indexBuffer?this.indexBuffer.bufferId:null;this.boundElementBuffer!==m&&(b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,m),this.boundElementBuffer=m)},draw:function(a,b){var c=this.gl,e,d,k;var h=this.shader;var m=h.samplers;var l=h.uniforms;0<b&&(this.boundBuffer=null,this.attributesInvalidated=
!0);this.setBuffers(b);var p=0;h=0;for(d=m.length;h<d;h++){var q=m[h];if(k=q.scopeId.value)if(k instanceof pc.Texture){var r=k;this.setTexture(r,p);q.slot!==p&&(c.uniform1i(q.locationId,p),q.slot=p);p++}else{q.array.length=0;var t=k.length;for(e=0;e<t;e++)r=k[e],this.setTexture(r,p),q.array[e]=p,p++;c.uniform1iv(q.locationId,q.array)}}h=0;for(d=l.length;h<d;h++)if(m=l[h],e=m.scopeId,q=m.version,k=e.versionObject.version,q.globalId!==k.globalId||q.revision!==k.revision)if(q.globalId=k.globalId,q.revision=
k.revision,null!==e.value)this.commitFunction[m.dataType](m,e.value);this.webgl2&&this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),c.beginTransformFeedback(c.POINTS));h=this.glPrimitive[a.type];d=a.count;a.indexed?(m=this.indexBuffer,l=m.glFormat,a=a.base*m.bytesPerIndex,0<b?c.drawElementsInstanced(h,d,l,a,b):c.drawElements(h,d,l,a)):(a=a.base,0<b?c.drawArraysInstanced(h,a,d,b):c.drawArrays(h,a,d));this.webgl2&&this.transformFeedbackBuffer&&
(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(a){var b=this.defaultClearOptions;a=a||b;var c=void 0==a.flags?b.flags:a.flags;if(0!==c){var g=this.gl;if(c&pc.CLEARFLAG_COLOR){var d=void 0==a.color?b.color:a.color;this.setClearColor(d[0],d[1],d[2],d[3])}c&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void 0==a.depth?b.depth:a.depth),this.depthWrite||g.depthMask(!0));c&pc.CLEARFLAG_STENCIL&&this.setClearStencil(void 0==a.stencil?b.stencil:a.stencil);g.clear(this.glClearFlag[c]);
c&pc.CLEARFLAG_DEPTH&&(this.depthWrite||g.depthMask(!1))}},readPixels:function(a,b,f,g,d){var c=this.gl;c.readPixels(a,b,f,g,c.RGBA,c.UNSIGNED_BYTE,d)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,f,g){if(a!==this.clearRed||b!==this.clearGreen||f!==this.clearBlue||g!==this.clearAlpha)this.gl.clearColor(a,b,f,g),this.clearRed=a,this.clearGreen=b,this.clearBlue=f,this.clearAlpha=g},setClearStencil:function(a){a!==this.clearStencil&&
(this.gl.clearStencil(a),this.clearStencil=a)},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},setDepthFunc:function(a){this.depthFunc!==a&&(this.gl.depthFunc(this.glComparison[a]),this.depthFunc=a)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==
a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,f,g){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==f||this.writeAlpha!==g)this.gl.colorMask(a,b,f,g),this.writeRed=a,this.writeGreen=b,this.writeBlue=f,this.writeAlpha=g},setAlphaToCoverage:function(a){this.webgl2&&this.alphaToCoverage!==a&&((this.alphaToCoverage=a)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(a){if(this.transformFeedbackBuffer!==
a&&(this.transformFeedbackBuffer=a,this.webgl2)){var b=this.gl;a?(this.feedback||(this.feedback=b.createTransformFeedback()),b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,this.feedback)):b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,null)}},setRaster:function(a){this.raster!==a&&(this.raster=a,this.webgl2&&(a?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(a){this.depthBiasEnabled!==a&&((this.depthBiasEnabled=a)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):
this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(a,b){this.gl.polygonOffset(b,a)},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setStencilTest:function(a){if(this.stencil!==a){var b=this.gl;a?b.enable(b.STENCIL_TEST):b.disable(b.STENCIL_TEST);this.stencil=a}},setStencilFunc:function(a,b,f){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==
f||this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==f)this.gl.stencilFunc(this.glComparison[a],b,f),this.stencilFuncFront=this.stencilFuncBack=a,this.stencilRefFront=this.stencilRefBack=b,this.stencilMaskFront=this.stencilMaskBack=f},setStencilFuncFront:function(a,b,f){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==f){var c=this.gl;c.stencilFuncSeparate(c.FRONT,this.glComparison[a],b,f);this.stencilFuncFront=a;this.stencilRefFront=b;this.stencilMaskFront=
f}},setStencilFuncBack:function(a,b,f){if(this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==f){var c=this.gl;c.stencilFuncSeparate(c.BACK,this.glComparison[a],b,f);this.stencilFuncBack=a;this.stencilRefBack=b;this.stencilMaskBack=f}},setStencilOperation:function(a,b,f,g){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==f||this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==f)this.gl.stencilOp(this.glStencilOp[a],this.glStencilOp[b],
this.glStencilOp[f]),this.stencilFailFront=this.stencilFailBack=a,this.stencilZfailFront=this.stencilZfailBack=b,this.stencilZpassFront=this.stencilZpassBack=f;if(this.stencilWriteMaskFront!==g||this.stencilWriteMaskBack!==g)this.gl.stencilMask(g),this.stencilWriteMaskBack=this.stencilWriteMaskFront=g},setStencilOperationFront:function(a,b,f,g){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==f)this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[a],this.glStencilOp[b],
this.glStencilOp[f]),this.stencilFailFront=a,this.stencilZfailFront=b,this.stencilZpassFront=f;this.stencilWriteMaskFront!==g&&(this.gl.stencilMaskSeparate(this.gl.FRONT,g),this.stencilWriteMaskFront=g)},setStencilOperationBack:function(a,b,f,g){if(this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==f)this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[f]),this.stencilFailBack=a,this.stencilZfailBack=b,this.stencilZpassBack=f;this.stencilWriteMaskBack!==
g&&(this.gl.stencilMaskSeparate(this.gl.BACK,g),this.stencilWriteMaskBack=g)},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b||this.separateAlphaBlend)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b,this.separateAlphaBlend=!1},setBlendFunctionSeparate:function(a,b,f,g){this.blendSrc===a&&this.blendDst===b&&this.blendSrcAlpha===f&&this.blendDstAlpha===g&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[a],
this.glBlendFunction[b],this.glBlendFunction[f],this.glBlendFunction[g]),this.blendSrc=a,this.blendDst=b,this.blendSrcAlpha=f,this.blendDstAlpha=g,this.separateAlphaBlend=!0)},setBlendEquation:function(a){if(this.blendEquation!==a||this.separateAlphaEquation)this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a,this.separateAlphaEquation=!1},setBlendEquationSeparate:function(a,b){this.blendEquation===a&&this.blendAlphaEquation===b&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[a],
this.glBlendEquation[b]),this.blendEquation=a,this.blendAlphaEquation=b,this.separateAlphaEquation=!0)},setCullMode:function(a){if(this.cullMode!==a){if(a===pc.CULLFACE_NONE)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===pc.CULLFACE_NONE&&this.gl.enable(this.gl.CULL_FACE);var b=this.glCull[a];this.cullFace!==b&&(this.gl.cullFace(b),this.cullFace=b)}this.cullMode=a}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(a){this.indexBuffer=a},setVertexBuffer:function(a,b,f){if(this.vertexBuffers[b]!==
a||this.vbOffsets[b]!==f){this.vertexBuffers[b]=a;this.vbOffsets[b]=f;f=0;a=a.getFormat().elements;for(var c=a.length;f<c;){var e=a[f++];e.stream=b;e.scopeId.setValue(e)}this.attributesInvalidated=!0}},compileShaderSource:function(a,b){var c=this.gl,e=b?this.vertexShaderCache[a]:this.fragmentShaderCache[a];e||(e=c.createShader(b?c.VERTEX_SHADER:c.FRAGMENT_SHADER),c.shaderSource(e,a),c.compileShader(e),b?this.vertexShaderCache[a]=e:this.fragmentShaderCache[a]=e);return e},compileAndLinkShader:function(a){var b=
this.gl,c=a.definition,g=this.compileShaderSource(c.vshader,!0),d=this.compileShaderSource(c.fshader,!1),k=b.createProgram();b.attachShader(k,g);b.attachShader(k,d);if(this.webgl2&&c.useTransformFeedback){c=c.attributes;var h=[],m;for(m in c)c.hasOwnProperty(m)&&h.push("out_"+m);b.transformFeedbackVaryings(k,h,b.INTERLEAVED_ATTRIBS)}b.linkProgram(k);a._glVertexShader=g;a._glFragmentShader=d;a._glProgram=k},createShader:function(a){this.compileAndLinkShader(a);this.shaders.push(a)},destroyShader:function(a){var b=
this.shaders.indexOf(a);-1!==b&&this.shaders.splice(b,1);a._glProgram&&(this.gl.deleteProgram(a._glProgram),a._glProgram=null,this.removeShaderFromCache(a))},_addLineNumbers:function(a){a=a.split("\n");for(var b=0,c=a.length;b<c;b++)a[b]=b+1+":\t"+a[b];return a.join("\n")},postLink:function(a){var b=this.gl,c=a._glVertexShader,g=a._glFragmentShader,d=a._glProgram,k=a.definition;if(!b.getShaderParameter(c,b.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(k.vshader)+
"\n\n"+b.getShaderInfoLog(c)),!1;if(!b.getShaderParameter(g,b.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(k.fshader)+"\n\n"+b.getShaderInfoLog(g)),!1;if(!b.getProgramParameter(d,b.LINK_STATUS))return console.error("Failed to link shader program. Error: "+b.getProgramInfoLog(d)),!1;c=0;for(var h=b.getProgramParameter(d,b.ACTIVE_ATTRIBUTES);c<h;){g=b.getActiveAttrib(d,c++);var m=b.getAttribLocation(d,g.name);void 0===k.attributes[g.name]&&console.error('Vertex shader attribute "'+
g.name+'" is not mapped to a semantic in shader definition.');m=new pc.ShaderInput(this,k.attributes[g.name],this.pcUniformType[g.type],m);a.attributes.push(m)}c=0;for(k=b.getProgramParameter(d,b.ACTIVE_UNIFORMS);c<k;)g=b.getActiveUniform(d,c++),m=b.getUniformLocation(d,g.name),m=new pc.ShaderInput(this,g.name,this.pcUniformType[g.type],m),g.type===b.SAMPLER_2D||g.type===b.SAMPLER_CUBE||this.webgl2&&(g.type===b.SAMPLER_2D_SHADOW||g.type===b.SAMPLER_CUBE_SHADOW||g.type===b.SAMPLER_3D)?a.samplers.push(m):
a.uniforms.push(m);return a.ready=!0},setShader:function(a){if(a!==this.shader){if(!a.ready&&!this.postLink(a))return!1;this.shader=a;this.gl.useProgram(a._glProgram);this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.textureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},resizeCanvas:function(a,b){this._width=a;
this._height=b;var c=Math.min(this._maxPixelRatio,window.devicePixelRatio);a*=c;b*=c;if(this.canvas.width!==a||this.canvas.height!==b)this.canvas.width=a,this.canvas.height=b,this.fire("resizecanvas",a,b)},setResolution:function(a,b){this._width=a;this._height=b;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)},clearShaderCache:function(){var a=this.gl,b;for(b in this.fragmentShaderCache)a.deleteShader(this.fragmentShaderCache[b]),delete this.fragmentShaderCache[b];for(b in this.vertexShaderCache)a.deleteShader(this.vertexShaderCache[b]),
delete this.vertexShaderCache[b];this.programLib.clearCache()},removeShaderFromCache:function(a){this.programLib.removeFromCache(a)},destroy:function(){var a=this.gl;this.destroyGrabPass();this.webgl2&&this.feedback&&a.deleteTransformFeedback(this.feedback);this.clearShaderCache();this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1);this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1);this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=
null}});Object.defineProperty(a.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(a.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(a.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},
set:function(a){this._enableAutoInstancing=a&&this.extInstancing}});Object.defineProperty(a.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});Object.defineProperty(a.prototype,"textureFloatHighPrecision",{get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var a=pc.shaderChunks;var b=a.createShaderFromCode(this,a.fullscreenQuadVS,a.precisionTestPS,"ptest1"),
f=a.createShaderFromCode(this,a.fullscreenQuadVS,a.precisionTest2PS,"ptest2"),g={format:pc.PIXELFORMAT_RGBA32F,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST};a=new pc.Texture(this,g);a.name="testFHP";var d=new pc.RenderTarget(this,a,{depth:!1});pc.drawQuadWithShader(this,d,b);g.format=pc.PIXELFORMAT_R8_G8_B8_A8;b=new pc.Texture(this,g);b.name="testFHP";g=new pc.RenderTarget(this,b,{depth:!1});this.constantTexSource.setValue(a);pc.drawQuadWithShader(this,g,f);
f=this.activeFramebuffer;this.setFramebuffer(g._glFrameBuffer);var k=new Uint8Array(4);this.readPixels(0,0,1,1,k);this.setFramebuffer(f);f=k[0]/255/16777216+k[1]/255/65536+k[2]/255/256+k[3]/255;a.destroy();d.destroy();b.destroy();g.destroy();a=0===f}else a=!1;this._textureFloatHighPrecision=a}return this._textureFloatHighPrecision}});return{GraphicsDevice:a}}());Object.assign(pc,function(){var d={},b={vertex_position:pc.SEMANTIC_POSITION,vertex_normal:pc.SEMANTIC_NORMAL,vertex_tangent:pc.SEMANTIC_TANGENT,vertex_texCoord0:pc.SEMANTIC_TEXCOORD0,vertex_texCoord1:pc.SEMANTIC_TEXCOORD1,vertex_texCoord2:pc.SEMANTIC_TEXCOORD2,vertex_texCoord3:pc.SEMANTIC_TEXCOORD3,vertex_texCoord4:pc.SEMANTIC_TEXCOORD4,vertex_texCoord5:pc.SEMANTIC_TEXCOORD5,vertex_texCoord6:pc.SEMANTIC_TEXCOORD6,vertex_texCoord7:pc.SEMANTIC_TEXCOORD7,vertex_color:pc.SEMANTIC_COLOR,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,
vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT};d.collectAttribs=function(a){for(var c={},e=0,f=a.indexOf("attribute");0<=f&&!(0<f&&"/"===a[f-1]);){var g=a.indexOf(";",f),d=a.lastIndexOf(" ",g);g=a.substr(d+1,g-(d+1));d=b[g];void 0!==d?c[g]=d:(c[g]="ATTR"+e,e++);f=a.indexOf("attribute",f+1)}return c};d.createShader=function(a,b,e,f){b=d[b];e=pc.programlib.precisionCode(a)+"\n"+d[e];var c=this.collectAttribs(b);a.webgl2&&(b=pc.programlib.versionCode(a)+this.gles3VS+b,e=pc.programlib.versionCode(a)+this.gles3PS+
e);return new pc.Shader(a,{attributes:c,vshader:b,fshader:e,useTransformFeedback:f})};d.createShaderFromCode=function(a,b,e,f,g){var c=a.programLib._cache,d=c[f];if(void 0!==d)return d;e=pc.programlib.precisionCode(a)+"\n"+(e||pc.programlib.dummyFragmentCode());d=this.collectAttribs(b);a.webgl2&&(b=pc.programlib.versionCode(a)+this.gles3VS+b,e=pc.programlib.versionCode(a)+this.gles3PS+e);c[f]=new pc.Shader(a,{attributes:d,vshader:b,fshader:e,useTransformFeedback:g});return c[f]};return{shaderChunks:d}}());Object.assign(pc,function(){function d(c,e,f,g,d,k){if(null===b){var h=new pc.VertexFormat(c,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);b=new pc.VertexBuffer(c,h,4);h=new pc.VertexIterator(b);h.element[pc.SEMANTIC_POSITION].set(-1,-1);h.next();h.element[pc.SEMANTIC_POSITION].set(1,-1);h.next();h.element[pc.SEMANTIC_POSITION].set(-1,1);h.next();h.element[pc.SEMANTIC_POSITION].set(1,1);h.end()}h=c.renderTarget;c.setRenderTarget(e);c.updateBegin();if(g){var n=g.x;var l=g.y;
var p=g.z;var q=g.w}else p=e?e.width:c.width,q=e?e.height:c.height,l=n=0;if(d){var r=d.x;var t=d.y;var u=d.z;var x=d.w}else r=n,t=l,u=p,x=q;d=c.vx;g=c.vy;e=c.vw;var v=c.vh;c.setViewport(n,l,p,q);p=c.sx;n=c.sy;l=c.sw;q=c.sh;c.setScissor(r,t,u,x);r=c.getDepthTest();t=c.getDepthWrite();u=c.getCullMode();x=c.writeRed;var y=c.writeGreen,A=c.writeBlue,z=c.writeAlpha;c.setDepthTest(!1);c.setDepthWrite(!1);c.setCullMode(pc.CULLFACE_NONE);c.setColorWrite(!0,!0,!0,!0);k||c.setBlending(!1);c.setVertexBuffer(b,
0);c.setShader(f);c.draw(a);c.setDepthTest(r);c.setDepthWrite(t);c.setCullMode(u);c.setColorWrite(x,y,A,z);c.updateEnd();c.setRenderTarget(h);c.updateBegin();c.setViewport(d,g,e,v);c.setScissor(p,n,l,q)}var b=null,a={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1};return{drawQuadWithShader:d,destroyPostEffectQuad:function(){b&&(b.destroy(),b=null)},drawTexture:function(a,b,f,g,n,k,h){g=g||a.getCopyShader();a.constantTexSource.setValue(b);d(a,f,g,n,k,h)}}}());Object.assign(pc,function(){function d(a,b,e){var c=b._colorBuffer;if(c.format==pc.PIXELFORMAT_R8_G8_B8_A8){var g=new Uint8Array(c.width*c.height*4),d=a.gl;a.setFramebuffer(b._glFrameBuffer);d.readPixels(0,0,c.width,c.height,d.RGBA,d.UNSIGNED_BYTE,g);c._levels||(c._levels=[]);c._levels[0]||(c._levels[0]=[]);c._levels[0][e]=g}}function b(a,b){return Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}return{prefilterCubemap:function(a){var b=a.device,e=a.sourceCubemap,f=a.method,g=a.samples,n=a.cpuSync;if(n&&!e._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");
else{var k=pc.shaderChunks,h=e.rgbm;g=k.createShaderFromCode(b,k.fullscreenQuadVS,k.rgbmPS+k.prefilterCubemapPS.replace(/\$METHOD/g,0===f?"cos":"phong").replace(/\$NUMSAMPLES/g,g).replace(/\$textureCube/g,h?"textureCubeRGBM":"textureCube"),"prefilter"+f+g+h);var m=k.createShaderFromCode(b,k.fullscreenQuadVS,k.outputCubemapPS,"outputCubemap"),l=b.scope.resolve("source"),p=b.scope.resolve("params"),q=new pc.Vec4,r=e.width;k=e.format;var t=[[],a.filteredFixed,a.filteredRgbm,a.filteredFixedRgbm],u=0===
f?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],x=[64,32,16,8,4,2,1],v;var y=k===pc.PIXELFORMAT_R8_G8_B8;var A=!1;n&&(A=e._levels[0][0]instanceof HTMLImageElement);if((y||A)&&n){k=pc.PIXELFORMAT_R8_G8_B8_A8;var z=new pc.Texture(b,{cubemap:!0,rgbm:h,format:k,width:r,height:r,mipmaps:!1});z.name="prefiltered-cube";for(v=0;6>v;v++)A=new pc.RenderTarget(b,z,{face:v,depth:!1}),q.x=v,q.y=0,l.setValue(e),p.setValue(q.data),pc.drawQuadWithShader(b,A,m),d(b,A,v);e=z}if(128<r){var E=Math.round(Math.log2(r))-
Math.round(Math.log2(128));for(y=0;y<E;y++){r=.5*e.width;var C=0===f?1:Math.pow(2,Math.round(Math.log2(u[0])+2*(E-y)));z=new pc.Texture(b,{cubemap:!0,rgbm:h,format:k,width:r,height:r,mipmaps:!1});z.name="prefiltered-cube";for(v=0;6>v;v++)A=new pc.RenderTarget(b,z,{face:v,depth:!1}),q.x=v,q.y=C,q.z=r,q.w=h?3:0,l.setValue(e),p.setValue(q.data),pc.drawQuadWithShader(b,A,m),y===E-1&&n&&d(b,A,v);e=z}}a.sourceCubemap=e;z=null;if(!h&&a.filteredFixedRgbm)for(z=new pc.Texture(b,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,
width:r,height:r,mipmaps:!1}),z.name="prefiltered-cube",v=0;6>v;v++)A=new pc.RenderTarget(b,z,{face:v,depth:!1}),q.x=v,q.w=2,l.setValue(e),p.setValue(q.data),pc.drawQuadWithShader(b,A,m),d(b,A,v);r=0===f?1:2048;A=0===f?0:-1;t[A]=[];for(y=0;7>y;y++)for(m=A;m<t.length;m++)null!=t[m]&&(t[m][y]=new pc.Texture(b,{cubemap:!0,rgbm:2>m?h:!0,format:2>m?k:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===m||3===m,width:x[y],height:x[y],mipmaps:!1}),t[m][y].name="prefiltered-cube");for(m=A;m<t.length;m++)if(null!=
t[m])if(1<m&&h)t[m]=t[m-2];else for(y=0;7>y;y++)for(v=0;6>v;v++)A=new pc.RenderTarget(b,t[m][y],{face:v,depth:!1}),q.x=v,q.y=0>m?r:u[y],q.z=x[y],q.w=h?3:m,l.setValue(0===y?e:0===f?t[0][y-1]:t[-1][y-1]),p.setValue(q.data),pc.drawQuadWithShader(b,A,g),n&&d(b,A,v);a.filtered=t[0];if(n&&a.singleFilteredFixed){e=[e].concat(a.filteredFixed);h=new pc.Texture(b,{cubemap:!0,rgbm:h,fixCubemapSeams:!0,format:k,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});h.name=
"prefiltered-cube";for(y=0;y<e.length;y++)h._levels[y]=e[y]._levels[0];h.upload();h._prefilteredMips=!0;a.singleFilteredFixed=h}if(n&&a.singleFilteredFixedRgbm&&a.filteredFixedRgbm){e=[z].concat(a.filteredFixedRgbm);h=new pc.Texture(b,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});h.name="prefiltered-cube";for(y=0;y<e.length;y++)h._levels[y]=e[y]._levels[0];h.upload();h._prefilteredMips=
!0;a.singleFilteredFixedRgbm=h}}},shFromCubemap:function(a,c){var e=a.width;if(a.format!=pc.PIXELFORMAT_R8_G8_B8_A8)console.error("ERROR: SH: cubemap must be RGBA8");else{if(a._levels[0]){if(!a._levels[0][0].length)if(a._levels[0][0]instanceof HTMLImageElement){var f=pc.Application.getApplication().graphicsDevice;var g=f.gl;var d=pc.shaderChunks;var k=d.createShaderFromCode(f,d.fullscreenQuadVS,d.fullscreenQuadPS,"fsQuadSimple"),h=f.scope.resolve("source");for(d=0;6>d;d++){var m=a._levels[0][d],l=
new pc.Texture(f,{cubemap:!1,rgbm:!1,format:a.format,width:e,height:e,mipmaps:!1});l.name="prefiltered-cube";l._levels[0]=m;l.upload();m=new pc.Texture(f,{cubemap:!1,rgbm:!1,format:a.format,width:e,height:e,mipmaps:!1});m.name="prefiltered-cube";m=new pc.RenderTarget(f,m,{depth:!1});h.setValue(l);pc.drawQuadWithShader(f,m,k);var p=new Uint8Array(e*e*4);g.bindFramebuffer(g.FRAMEBUFFER,m._glFrameBuffer);g.readPixels(0,0,l.width,l.height,g.RGBA,g.UNSIGNED_BYTE,p);a._levels[0][d]=p}}else{console.error("ERROR: SH: cubemap must be composed of arrays or images");
return}k=[];for(g=0;g<e;g++)for(f=0;f<e;f++)k[g*e+f]=(new pc.Vec3(f/(e-1)*2-1,g/(e-1)*2-1,1)).normalize();h=new Float32Array(27);for(d=m=0;6>d;d++)for(g=0;g<e;g++)for(f=0;f<e;f++){l=g*e+f;p=f;var q=g;var r=e;var t=(2*(p+.5)/r-1)*(1-1/r);var u=(2*(q+.5)/r-1)*(1-1/r);var x=1/r;var v=t-x;var y=u-x;t+=x;u+=x;v=b(v,y)-b(v,u)-b(t,y)+b(t,u);if(0===p&&0===q||p===r-1&&0===q||0===p&&q===r-1||p===r-1&&q===r-1)v/=3;else if(0===p||0===q||p===r-1||q===r-1)v*=.5;p=v;q=4*p/17;r=8*p/17;v=15*p/17;y=5*p/68;u=15*p/68;
x=k[l];if(0==d){var A=x.z;var z=-x.y;var E=-x.x}else 1==d?(A=-x.z,z=-x.y,E=x.x):2==d?(A=x.x,z=x.z,E=x.y):3==d?(A=x.x,z=-x.z,E=-x.y):4==d?(A=x.x,z=-x.y,E=x.z):5==d&&(A=-x.x,z=-x.y,E=-x.z);c||(A=-A);t=a._levels[0][d][4*l+3]/255;for(x=0;3>x;x++){var C=a._levels[0][d][4*l+x]/255;a.rgbm?(C*=8*t,C*=C):C=Math.pow(C,2.2);h[0+x]+=C*q;h[3+x]+=C*r*A;h[6+x]+=C*r*z;h[9+x]+=C*r*E;h[12+x]+=C*v*A*E;h[15+x]+=C*v*E*z;h[18+x]+=C*v*z*A;h[21+x]+=C*y*(3*E*E-1);h[24+x]+=C*u*(A*A-z*z);m+=p}}for(x=0;x<h.length;x++)h[x]*=
4*Math.PI/m;return h}console.error("ERROR: SH: cubemap must be synced to CPU")}}}}());Object.assign(pc,function(){return{paraboloidFromCubemap:function(d,b,a,c){var e=pc.shaderChunks;e=e.createShaderFromCode(d,e.fullscreenQuadVS,(b.fixCubemapSeams?e.fixCubemapSeamsStretchPS:e.fixCubemapSeamsNonePS)+e.genParaboloidPS,"genParaboloid");var f=d.scope.resolve("source"),g=d.scope.resolve("params"),n=new pc.Vec4,k=b.width,h=b.rgbm,m=b.format;k=2*Math.max(k,8);k=new pc.Texture(d,{rgbm:h,format:m,width:2*k,height:k,mipmaps:!1});k.name="paraboloid";h=new pc.RenderTarget(d,k,{depth:!1});n.x=
a;n.y=c?-1:1;f.setValue(b);g.setValue(n.data);pc.drawQuadWithShader(d,h,e);return k},generateDpAtlas:function(d,b,a){var c=new pc.Vec4;var e=new pc.Vec4,f=4*b[0].width,g=pc.shaderChunks;g=g.createShaderFromCode(d,g.fullscreenQuadVS,g.dpAtlasQuadPS,"dpAtlasQuad");var n=d.scope.resolve("source"),k=d.scope.resolve("params"),h=new pc.Texture(d,{rgbm:b[0].rgbm,format:b[0].format,width:f,height:f,mipmaps:!1});h.name="paraboloid";for(var m=new pc.RenderTarget(d,h,{depth:!1}),l=(f+2)/f-1,p=0;6>p;p++){var q=
pc.paraboloidFromCubemap(d,b[p],p,a);n.setValue(q);q=c;var r=p;q.x=.5*pc.math.clamp(r-2,0,1);r-=6*q.x;var t=1-q.x;q.y=Math.min(.5*r,.75)*t+q.x;q.z=(1-.5*pc.math.clamp(r,0,1))*t;q.w=.5*q.z;q=1/q.z;e.x=q*l;e.y=2*e.x;e.x+=1;e.y+=1;k.setValue(e.data);c.x*=f;c.y*=f;c.z*=f;c.w*=f;pc.drawQuadWithShader(d,m,g,c)}return h}}}());pc.shaderChunks.TBNPS="void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n";pc.shaderChunks.TBNObjectSpacePS="void getTBN() {\n    vec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n    vec3 T = cross(dVertexNormalW, B);\n    if (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW dVertexNormalW are parallel\n    {\n        float major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n        if (dVertexNormalW.x==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,1,0));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.y==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,0,1));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.z==major)\n        {\n            B=cross(dVertexNormalW, vec3(1,0,0));\n            T=cross(dVertexNormalW, B);\n        }\n    }\n    dTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n";
pc.shaderChunks.TBNderivativePS="// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n    vec2 uv = $UV;\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( vPositionW );\n    vec3 dp2 = dFdy( vPositionW );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, dVertexNormalW );\n    vec3 dp1perp = cross( dVertexNormalW, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    // construct a scale-invariant frame\n    float invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n    dTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n";
pc.shaderChunks.TBNfastPS="void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n";pc.shaderChunks.alphaTestPS="uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n";pc.shaderChunks.ambientConstantPS="\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n";pc.shaderChunks.ambientPrefilteredCubePS="#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n";
pc.shaderChunks.ambientPrefilteredCubeLodPS="#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n";pc.shaderChunks.ambientSHPS="uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n";
pc.shaderChunks.aoPS="#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n    dAo = 1.0;\n    #ifdef MAPTEXTURE\n        dAo *= texture2D(texture_aoMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAo *= saturate(vVertexColor.$VC);\n    #endif\n    dDiffuseLight *= dAo;\n}\n";pc.shaderChunks.aoSpecOccPS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoSpecOccConstPS="void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";pc.shaderChunks.aoSpecOccConstSimplePS="void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoSpecOccSimplePS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";pc.shaderChunks.bakeDirLmEndPS="\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n";
pc.shaderChunks.bakeLmEndPS="\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n";pc.shaderChunks.basePS="\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n    return x*x;\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n";
pc.shaderChunks.baseVS="\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n";pc.shaderChunks.baseNineSlicedPS="#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n";
pc.shaderChunks.baseNineSlicedVS="#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n";pc.shaderChunks.baseNineSlicedTiledPS="#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n";pc.shaderChunks.biasConstPS="#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n";
pc.shaderChunks.blurVSMPS="\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n";
pc.shaderChunks.combineClearCoatPS="vec3 combineColorCC() {\n    return combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n";pc.shaderChunks.combineDiffusePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n";pc.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n";pc.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n";
pc.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n";pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n";pc.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n";
pc.shaderChunks.cookiePS="vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n";
pc.shaderChunks.cubeMapProjectBoxPS="uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n";
pc.shaderChunks.cubeMapProjectNonePS="vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n";pc.shaderChunks.detailModesPS="vec3 detailMode_mul(vec3 c1, vec3 c2) {\n    return c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n    return c1 + c2;\n}\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n    return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n    return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n    return min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n    return max(c1, c2);\n}\n";
pc.shaderChunks.diffusePS="#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n    #ifdef MAPCOLOR\n        dAlbedo *= material_diffuse.rgb;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n    #endif\n    #ifdef MAPVERTEX\n        dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n";
pc.shaderChunks.diffuseDetailMapPS="#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n    #ifdef MAPTEXTURE\n        vec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n        return detailMode_$DETAILMODE(albedo, albedoDetail);\n    #else\n        return albedo;\n    #endif\n}\n";pc.shaderChunks.dilatePS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n";
pc.shaderChunks.dpAtlasQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n";pc.shaderChunks.emissivePS="#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n    vec3 emission = vec3(1.0);\n    #ifdef MAPFLOAT\n        emission *= material_emissiveIntensity;\n    #endif\n    #ifdef MAPCOLOR\n        emission *= material_emissive;\n    #endif\n    #ifdef MAPTEXTURE\n        emission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        emission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n    return emission;\n}\n";
pc.shaderChunks.endPS="  #ifdef CLEARCOAT\n   gl_FragColor.rgb = combineColorCC();\n  #else\n   gl_FragColor.rgb = combineColor();\n  #endif \n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n";pc.shaderChunks.envConstPS="vec3 processEnvironment(vec3 color) {\n    return color;\n}\n";pc.shaderChunks.envMultiplyPS="uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n";
pc.shaderChunks.extensionPS="";pc.shaderChunks.extensionVS="\n";pc.shaderChunks.falloffInvSquaredPS="float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n    return falloff;\n}\n";pc.shaderChunks.falloffLinearPS="float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n";
pc.shaderChunks.fixCubemapSeamsNonePS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n";pc.shaderChunks.fixCubemapSeamsStretchPS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n";
pc.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.fogNonePS="vec3 addFog(vec3 color) {\n    return color;\n}\n";
pc.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n    #ifdef CLEARCOAT\n        fresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n        fresnel2 = fresnel * fresnel;\n        fresnel *= fresnel2 * fresnel2;\n        fresnel *= ccGlossiness * ccGlossiness;\n        ccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n    #endif\n}\n";
pc.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";pc.shaderChunks.fullscreenQuadVS="attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n";pc.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\nfloat gammaCorrectInput(float color) {\n    return color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n";
pc.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    vec4 rgba = texture2D(tex, uv, bias);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n";
pc.shaderChunks.genParaboloidPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params; // x = mip\nvoid main(void) {\n    vec2 uv = vUv0;\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n    dir = fixSeams(dir, params.x);\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n";
pc.shaderChunks.gles3PS="#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n";pc.shaderChunks.gles3VS="#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n";
pc.shaderChunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatGlossiness;\n#endif\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n    #ifdef MAPFLOAT\n        dGlossiness *= material_shininess;\n    #endif\n    #ifdef MAPTEXTURE\n        dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n    dGlossiness += 0.0000001;\n    #ifdef CLEARCOAT\n        ccGlossiness = 1.0;\n        ccGlossiness *= material_clearCoatGlossiness;\n        ccGlossiness += 0.0000001;\n    #endif\n}\n";
pc.shaderChunks.instancingVS="\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n";pc.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n";pc.shaderChunks.lightDirPointPS="void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n";
pc.shaderChunks.lightSpecularAnisoGGXPS="// Anisotropic GGX\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    float PI = 3.141592653589793;\n    float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n    float anisotropy = material_anisotropy * roughness;\n \n    float at = max((roughness + anisotropy), roughness / 4.0);\n    float ab = max((roughness - anisotropy), roughness / 4.0);\n    vec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n    float NoH = dot(tNormalW, h);\n    float ToH = dot(dTBN[0], h);\n    float BoH = dot(dTBN[1], h);\n    float a2 = at * ab;\n    vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n    float v2 = dot(v, v);\n    float w2 = a2 / v2;\n    float D = a2 * w2 * w2 * (1.0 / PI);\n    float ToV = dot(dTBN[0], dViewDirW);\n    float BoV = dot(dTBN[1], dViewDirW);\n    float ToL = dot(dTBN[0], -dLightDirNormW);\n    float BoL = dot(dTBN[1], -dLightDirNormW);\n    float NoV = dot(tNormalW, dViewDirW);\n    float NoL = dot(tNormalW, -dLightDirNormW);\n    float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n    float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n    float G = 0.5 / (lambdaV + lambdaL);\n    return D * G;\n}\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n";
pc.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, tNormalW ), 0.0 );\n    float specPow = exp2(tGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n";
pc.shaderChunks.lightSpecularPhongPS="float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n    float specPow = tGlossiness;\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n";
pc.shaderChunks.lightmapDirPS="uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n    dDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n";
pc.shaderChunks.lightmapSinglePS="#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n    vec3 lm = vec3(1.0);\n    #ifdef MAPTEXTURE\n        lm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        lm *= saturate(vVertexColor.$VC);\n    #endif\n    \n    dDiffuseLight += lm;\n}\n";pc.shaderChunks.lightmapSingleVertPS="void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n";pc.shaderChunks.metalnessPS="void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\nvoid getSpecularity() {\n    float metalness = 1.0;\n    #ifdef MAPFLOAT\n        metalness *= material_metalness;\n    #endif\n    #ifdef MAPTEXTURE\n        metalness *= texture2D(texture_metalnessMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        metalness *= saturate(vVertexColor.$VC);\n    #endif\n    processMetalness(metalness);\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n";
pc.shaderChunks.msdfPS="uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    vec2 uvShdw = vUv0 - shadow_offset;\n    vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n    #else\n        float font_size = 16.0; // TODO fix this\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n        float smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n    // remap to a smaller range (used on smaller font sizes)\n    float sigDistInner = map(mapMin, mapMax, sigDist);\n    float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n    sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n    float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n    float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n    vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n    tcolor = mix(tcolor, color, inside);\n    vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n    tcolor = mix(scolor, tcolor, outline);\n    \n    return tcolor;\n}";
pc.shaderChunks.normalVS="vec3 getNormal() {\n    #ifdef SKIN\n        dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n        dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n        dNormalMatrix = matrix_normal;\n    #endif\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";pc.shaderChunks.normalDetailMapPS="#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n    // https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n    n1 += vec3(0, 0, 1);\n    n2 *= vec3(-1, -1, 1);\n    return normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n    #ifdef MAPTEXTURE\n        vec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n        normalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n        return blendNormals(normalMap, normalDetailMap);\n    #else\n        return normalMap;\n    #endif\n}\n";
pc.shaderChunks.normalInstancedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";pc.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n";
pc.shaderChunks.normalMapFastPS="uniform sampler2D texture_normalMap;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n";pc.shaderChunks.normalSkinnedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
pc.shaderChunks.normalVertexPS="void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n    #ifdef CLEARCOAT\n        ccNormalW = dNormalW;\n    #endif\n}\n";pc.shaderChunks.normalXYPS="vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n";pc.shaderChunks.normalXYZPS="vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n";pc.shaderChunks.opacityPS="#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n    dAlpha = 1.0;\n    #ifdef MAPFLOAT\n        dAlpha *= material_opacity;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n    #endif\n}\n";
pc.shaderChunks.outputAlphaPS="gl_FragColor.a = dAlpha;\n";pc.shaderChunks.outputAlphaOpaquePS="gl_FragColor.a = 1.0;\n";pc.shaderChunks.outputAlphaPremulPS="gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n";pc.shaderChunks.outputCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n    color.rgb /= color.a;\n    return color;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n";
pc.shaderChunks.outputTex2DPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";pc.shaderChunks.packDepthPS="// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";
pc.shaderChunks.packDepthMaskPS="vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";pc.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n";
pc.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n    ramp.a += texCoordsAlphaLife.z;\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n";
pc.shaderChunks.particleVS="\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n   vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n   return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\nvec2 safeNormalize(vec2 v) {\n    float l = length(v);\n    return (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n    float uv = id / numParticlesPot;\n    readInput(uv);\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    float particleLifetime = lifetime;\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n    texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n    mat2 rotMatrix;\n";
pc.shaderChunks.particleAnimFrameClampVS="\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n";pc.shaderChunks.particleAnimFrameLoopVS="\n    float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n";pc.shaderChunks.particleAnimTexVS="\n    float animationIndex;\n    if (animTexIndexParams.y == 1.0) {\n        animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n    } else {\n        animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n    }\n    float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n    float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n    atlasX = fract(atlasX);\n    texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n";
pc.shaderChunks.particleInputFloatPS="void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n";pc.shaderChunks.particleInputRgba8PS="//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n";
pc.shaderChunks.particleOutputFloatPS="void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n";pc.shaderChunks.particleOutputRgba8PS="uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n";
pc.shaderChunks.particleUpdaterAABBPS="uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    vec3 pos = inBounds - vec3(0.5);\n    vec3 posAbs = abs(pos);\n    vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n    vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n    //pos = edge * mix(2.0 * pos, sign(pos), equal(maxPos, posAbs));\n    pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n    pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n    pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n    return emitterPos + spawnBounds * pos;\n#else\n    return spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n";
pc.shaderChunks.particleUpdaterEndPS="\n    writeOutput();\n}\n";pc.shaderChunks.particleUpdaterInitPS="varying vec2 vUv0;\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n";
pc.shaderChunks.particleUpdaterNoRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n";pc.shaderChunks.particleUpdaterOnStopPS="    visMode = outLife < 0.0? -1.0: visMode;\n";pc.shaderChunks.particleUpdaterRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n";
pc.shaderChunks.particleUpdaterSpherePS="uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n    float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n    return emitterPos + norm * r * spawnBoundsSphere;\n#else\n    return norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n";
pc.shaderChunks.particleUpdaterStartPS="float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n    float particleRate = rate + rateDiv * rndFactor.x;\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n    vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n    float radialSpeed = radialParams.x;\n    float radialSpeedDiv = radialParams.y;\n    bool respawn = inLife <= 0.0 || outLife >= lifetime;\n    inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n    inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n    vec3 radialVel = inPos - emitterPos;\n#else\n    vec3 radialVel = inPos;\n#endif\n    radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n    radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n    outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n    outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n";
pc.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n";pc.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n";pc.shaderChunks.particle_blendAddPS="\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n";
pc.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n";pc.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4;     // particle id\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;     // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n    float id = floor(particle_vertexData4);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    vec2 quadXY = vertPos.xy;\n    \n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n    texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n    mat2 rotMatrix;\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n";
pc.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n";pc.shaderChunks.particle_customFaceVS="\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = customFace(particlePos, quadXY);\n";pc.shaderChunks.particle_endPS="    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";
pc.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n";pc.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n";pc.shaderChunks.particle_initVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n";
pc.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n";pc.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n    rgb *= light;\n";pc.shaderChunks.particle_localShiftVS="    particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n";
pc.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n    billboard(particlePos, quadXY);\n";pc.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n";pc.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n";
pc.shaderChunks.particle_pointAlongVS="    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n";pc.shaderChunks.particle_softPS="\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n";pc.shaderChunks.particle_softVS="\n    vDepth = getLinearDepth(localPos);\n";pc.shaderChunks.particle_stretchVS="    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = particlePos - moveDir;\n    posPrev += particlePosMoved;\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n    particlePos = mix(particlePos, posPrev, interpolation);\n";
pc.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n";pc.shaderChunks.precisionTestPS="void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n";pc.shaderChunks.precisionTest2PS="uniform sampler2D source;\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n";
pc.shaderChunks.prefilterCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n";
pc.shaderChunks.reflDirPS="void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n";pc.shaderChunks.reflDirAnisoPS="void getReflDir() {\n    float roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n    float anisotropy = material_anisotropy * roughness;\n    vec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n    vec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n    vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n    vec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n    dReflDirW = reflect(-dViewDirW, bentNormal);\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n";
pc.shaderChunks.reflectionCCPS="#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {    \n    ccReflection += calcReflection(ccReflDirW, ccGlossiness, material_clearCoatReflectivity); \n}\n#endif\n";pc.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    vec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n    lookupVec.x *= -1.0;\n    return vec4($textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb, tmaterial_reflectivity);\n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionDpAtlasPS="uniform sampler2D texture_sphereMap;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n    uv = uv * rect.zw + rect.xy;\n    return uv;\n}\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    vec3 reflDir = normalize(cubeMapProject(tReflDirW));\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n    return vec4(tex1, tmaterial_reflectivity);\n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n    return vec4(refl, tmaterial_reflectivity);\n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionPrefilteredCubeLodPS="\n#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n    return vec4(refl, tmaterial_reflectivity);\n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionSpherePS="#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    vec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n    return vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, tmaterial_reflectivity);\n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nvec4 calcReflection(vec3 tReflDirW, float tGlossiness, float tmaterial_reflectivity) {\n    vec3 reflDirV = vNormalV;\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    return vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, tmaterial_reflectivity);      \n}\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += calcReflection(dReflDirW, dGlossiness, material_reflectivity);\n}\n";
pc.shaderChunks.refractionPS="uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\nvoid addRefraction() {\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n    addReflection();\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n";
pc.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n";pc.shaderChunks.screenDepthPS="uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     (1 - f / n) / 2,        (1 + f / n) / 2\n#endif\n#ifdef GL2\n    float linearizeDepth(float z) {\n        z = z * 2.0 - 1.0;\n        return 1.0 / (camera_params.z * z + camera_params.w);\n    }\n#else\n    #ifndef UNPACKFLOAT\n    #define UNPACKFLOAT\n    float unpackFloat(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n    #endif\n#endif\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n    #else\n        return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n    #endif\n}\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n";
pc.shaderChunks.shadowCommonPS="void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n";pc.shaderChunks.shadowCoordPS="void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
pc.shaderChunks.shadowCoordVS="void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
pc.shaderChunks.shadowCoordPerspZbufferPS="void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n";
pc.shaderChunks.shadowEVSMPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
pc.shaderChunks.shadowEVSMnPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
pc.shaderChunks.shadowStandardPS="vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n// ----- Direct/Spot Sampling -----\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n        float sum = 0.0;\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n// ----- Point Sampling -----\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n    mat3 shadowKernel;\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n";
pc.shaderChunks.shadowStandardGL2PS="float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n    float sum = 0.0;\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n    sum *= 1.0f / 144.0;\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n    return sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n";
pc.shaderChunks.shadowStandardGL2VSPS="float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n";pc.shaderChunks.shadowStandardVSPS="#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n";
pc.shaderChunks.shadowVSM8PS="float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n";
pc.shaderChunks.shadowVSMVSPS="float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n";pc.shaderChunks.shadowVSM_commonPS="float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n";
pc.shaderChunks.skinBatchConstVS="attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";pc.shaderChunks.skinBatchTexVS="attribute float vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
pc.shaderChunks.skinConstVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";pc.shaderChunks.skinTexVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
pc.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n";pc.shaderChunks.skyboxVS="attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n";
pc.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";pc.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";
pc.shaderChunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n    #ifdef MAPTEXTURE\n        dSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n";
pc.shaderChunks.specularAaNonePS="float antiAliasGlossiness(float power) {\n    return power;\n}\n";pc.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n";pc.shaderChunks.specularAaToksvigFastPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n";
pc.shaderChunks.spotPS="float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n";pc.shaderChunks.startPS="\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n    #ifdef CLEARCOAT\n        ccSpecularLight = vec3(0);\n        ccReflection = vec4(0);\n        ccSpecularity = vec3(0);\n    #endif\n    ";
pc.shaderChunks.startVS="\nvoid main(void) {\n    gl_Position = getPosition();\n";pc.shaderChunks.startNineSlicedPS="    nineSlicedUv = vUv0;\n";pc.shaderChunks.startNineSlicedTiledPS="\n    vec2 tileMask = step(vMask, vec2(0.99999));\n    vec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n    clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n    nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n";pc.shaderChunks.storeEVSMPS="float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n";
pc.shaderChunks.tangentBinormalVS="\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n    return normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n";pc.shaderChunks.tonemappingAcesPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n";
pc.shaderChunks.tonemappingAces2PS="uniform float exposure;\n// ACES approximation by Stephen Hill\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n    return color;\n}\n";
pc.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n    return color;\n}\n";
pc.shaderChunks.tonemappingHejlPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n";pc.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n";
pc.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n";pc.shaderChunks.transformVS="#ifdef PIXELSNAP\n    uniform vec4 uScreenSize;\n#endif\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n        return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n        return matrix_model * (getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n               getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n               getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n               getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w);\n    #elif defined(INSTANCING)\n        return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n        return matrix_model;\n    #endif\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= outerScale;\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n        vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n        localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n        vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n        posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n        screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n        #else\n            screenPos = matrix_viewProjection * posW;\n        #endif\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n    return screenPos;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformDeclVS="attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n";pc.shaderChunks.uv0VS="#ifdef NINESLICED\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n    vMask = vertex_texCoord0.xy;\n    return uv;\n}\n#else\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n#endif\n";
pc.shaderChunks.uv1VS="\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n";pc.shaderChunks.viewDirPS="void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n";pc.shaderChunks.viewNormalVS="\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.programlib={gammaCode:function(d,b){b||(b=pc.shaderChunks);return d===pc.GAMMA_SRGB||d===pc.GAMMA_SRGBFAST?b.gamma2_2PS?b.gamma2_2PS:pc.shaderChunks.gamma2_2PS:d===pc.GAMMA_SRGBHDR?"#define HDR\n"+(b.gamma2_2PS?b.gamma2_2PS:pc.shaderChunks.gamma2_2PS):b.gamma1_0PS?b.gamma1_0PS:pc.shaderChunks.gamma1_0PS},tonemapCode:function(d,b){b||(b=pc.shaderChunks);return d===pc.TONEMAP_FILMIC?b.tonemappingFilmicPS?b.tonemappingFilmicPS:pc.shaderChunks.tonemappingFilmicPS:d===pc.TONEMAP_LINEAR?b.tonemappingLinearPS?
b.tonemappingLinearPS:pc.shaderChunks.tonemappingLinearPS:d===pc.TONEMAP_HEJL?b.tonemappingHejlPS?b.tonemappingHejlPS:pc.shaderChunks.tonemappingHejlPS:d===pc.TONEMAP_ACES?b.tonemappingAcesPS?b.tonemappingAcesPS:pc.shaderChunks.tonemappingAcesPS:d===pc.TONEMAP_ACES2?b.tonemappingAces2PS?b.tonemappingAces2PS:pc.shaderChunks.tonemappingAces2PS:b.tonemapingNonePS?b.tonemapingNonePS:pc.shaderChunks.tonemappingNonePS},fogCode:function(d,b){b||(b=pc.shaderChunks);return"linear"===d?b.fogLinearPS?b.fogLinearPS:
pc.shaderChunks.fogLinearPS:"exp"===d?b.fogExpPS?b.fogExpPS:pc.shaderChunks.fogExpPS:"exp2"===d?b.fogExp2PS?b.fogExp2PS:pc.shaderChunks.fogExp2PS:b.fogNonePS?b.fogNonePS:pc.shaderChunks.fogNonePS},skinCode:function(d,b){b||(b=pc.shaderChunks);return d.supportsBoneTextures?b.skinTexVS:"#define BONE_LIMIT "+d.getBoneLimit()+"\n"+b.skinConstVS},precisionCode:function(d){var b="precision "+d.precision+" float;\n";d.webgl2&&(b+="#ifdef GL2\nprecision "+d.precision+" sampler2DShadow;\n#endif\n");return b},
versionCode:function(d){return d.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"}};pc.programlib.basic={generateKey:function(d){var b="basic";d.fog&&(b+="_fog");d.alphaTest&&(b+="_atst");d.vertexColors&&(b+="_vcol");d.diffuseMap&&(b+="_diff");return b+="_"+d.pass},createShaderDefinition:function(d,b){var a={vertex_position:pc.SEMANTIC_POSITION};b.skin&&(a.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,a.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);b.vertexColors&&(a.vertex_color=pc.SEMANTIC_COLOR);b.diffuseMap&&(a.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.shaderChunks;var e=
""+c.transformDeclVS;b.skin?(e+=pc.programlib.skinCode(d),e+=c.transformSkinnedVS):e+=c.transformVS;b.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");b.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n");b.pass===pc.SHADER_DEPTH&&(e+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n");e+=pc.programlib.begin();e+="   gl_Position = getPosition();\n";
b.pass===pc.SHADER_DEPTH&&(e+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n");b.vertexColors&&(e+="    vColor = vertex_color;\n");b.diffuseMap&&(e+="    vUv0 = vertex_texCoord0;\n");var f=e+=pc.programlib.end();e=pc.programlib.precisionCode(d);e=b.vertexColors?e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";b.diffuseMap&&(e+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n");b.fog&&(e+=pc.programlib.fogCode(b.fog));b.alphatest&&(e+=c.alphaTestPS);
b.pass===pc.SHADER_DEPTH&&(e=e+"varying float vDepth;\n"+c.packDepthPS);e+=pc.programlib.begin();e=b.vertexColors?e+"    gl_FragColor = vColor;\n":e+"    gl_FragColor = uColor;\n";b.diffuseMap&&(e+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");b.alphatest&&(e+="   alphaTest(gl_FragColor.a);\n");b.pass!==pc.SHADER_PICK&&(b.pass===pc.SHADER_DEPTH?e+="    gl_FragColor = packFloat(vDepth);\n":b.fog&&(e+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n"));e+=pc.programlib.end();return{attributes:a,
vshader:f,fshader:e}}};pc.programlib.particle={generateKey:function(d){var b="particle",a;for(a in d)d.hasOwnProperty(a)&&(b+=d[a]);return b},_animTex:function(d,b){d=""+(d.animTexLoop?b.particleAnimFrameLoopVS:b.particleAnimFrameClampVS);return d+=b.particleAnimTexVS},createShaderDefinition:function(d,b){var a=pc.shaderChunks,c="",e=pc.programlib.precisionCode(d)+"\n";d.webgl2&&(c+="#define GL2\n",e+="#define GL2\n");c+="#define VERTEXSHADER\n";b.mesh&&(c+="#define USE_MESH\n");b.localSpace&&(c+="#define LOCAL_SPACE\n");
b.animTex&&(c+="\nuniform vec2 animTexTilesParams;\n");b.animTex&&(c+="\nuniform vec4 animTexParams;\n");b.animTex&&(c+="\nuniform vec2 animTexIndexParams;\n");2==b.normal&&(c+="\nvarying mat3 ParticleMat;\n");1==b.normal&&(c+="\nvarying vec3 Normal;\n");b.soft&&(c+="\nvarying float vDepth;\n");d=b.customFace?a.particle_customFaceVS:a.particle_billboardVS;b.useCpu?(0<b.soft&&(c+=a.screenDepthPS),c+=a.particle_cpuVS,b.localSpace&&(c+=a.particle_localShiftVS),b.animTex&&(c+=this._animTex(b,a)),b.alignToMotion&&
(c+=a.particle_pointAlongVS),c+=b.mesh?a.particle_meshVS:d,1==b.normal&&(c+=a.particle_normalVS),2==b.normal&&(c+=a.particle_TBNVS),0<b.stretch&&(c+=a.particle_stretchVS),c+=a.particle_cpu_endVS):(c+=a.particle_initVS,c+=b.pack8?a.particleInputRgba8PS:a.particleInputFloatPS,0<b.soft&&(c+=a.screenDepthPS),c+=a.particleVS,b.localSpace&&(c+=a.particle_localShiftVS),b.animTex&&(c+=this._animTex(b,a)),b.wrap&&(c+=a.particle_wrapVS),b.alignToMotion&&(c+=a.particle_pointAlongVS),c+=b.mesh?a.particle_meshVS:
d,1==b.normal&&(c+=a.particle_normalVS),2==b.normal&&(c+=a.particle_TBNVS),0<b.stretch&&(c+=a.particle_stretchVS),c+=a.particle_endVS);0<b.soft&&(c+=a.particle_softVS);c+="}\n";0<b.normal&&(1==b.normal?e+="\nvarying vec3 Normal;\n":2==b.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+="\nuniform vec3 lightCube[6];\n");b.soft&&(e+="\nvarying float vDepth;\n");0===b.normal&&"none"===b.fog&&(b.srgb=!1);e+=pc.programlib.gammaCode(b.gamma);e+=pc.programlib.tonemapCode(b.toneMap);e="linear"===b.fog?e+a.fogLinearPS:
"exp"===b.fog?e+a.fogExpPS:"exp2"===b.fog?e+a.fogExp2PS:e+a.fogNonePS;2==b.normal&&(e+="\nuniform sampler2D normalMap;\n");0<b.soft&&(e+=a.screenDepthPS);e+=a.particlePS;0<b.soft&&(e+=a.particle_softPS);1==b.normal&&(e+="\nvec3 normal = Normal;\n");2==b.normal&&(e+=a.particle_normalMapPS);0<b.normal&&(e+=b.halflambert?a.particle_halflambertPS:a.particle_lambertPS);0<b.normal&&(e+=a.particle_lightingPS);b.blend==pc.BLEND_NORMAL?e+=a.particle_blendNormalPS:b.blend==pc.BLEND_ADDITIVE?e+=a.particle_blendAddPS:
b.blend==pc.BLEND_MULTIPLICATIVE&&(e+=a.particle_blendMultiplyPS);e+=a.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(c),vshader:c,fshader:e}}};var _oldChunkWarn=function(d,b){},_oldChunkFloat=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef MAPFLOAT\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkColor=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef MAPCOLOR\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTex=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef MAPTEXTURE\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTexColor=function(d,b,a){_oldChunkWarn(a,b);return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+
d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTexFloat=function(d,b,a){_oldChunkWarn(a,b);return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkVert=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef MAPVERTEX\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkVertColor=function(d,b,a){_oldChunkWarn(a,b);return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+
d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkVertFloat=function(d,b,a){_oldChunkWarn(a,b);return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformSkin=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef SKIN\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformDynbatch=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef DYNAMICBATCH\n"+
d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformInstanced=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef INSTANCING\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformPixelSnap=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef PIXELSNAP\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformScreenSpace=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef SCREENSPACE\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformScreenSpaceBatch=
function(d,b,a){_oldChunkWarn(a,b);return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"},_oldChunkTransformUv1=function(d,b,a){_oldChunkWarn(a,b);return"\n#ifdef UV1LAYOUT\n"+d+"\n#else\n"+pc.shaderChunks[b]+"\n#endif\n"};
pc.programlib.standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:_oldChunkTex},aoVertPS:{n:"aoPS",f:_oldChunkVert},diffuseConstPS:{n:"diffusePS",f:_oldChunkColor},diffuseTexPS:{n:"diffusePS",f:_oldChunkTex},diffuseTexConstPS:{n:"diffusePS",f:_oldChunkTexColor},diffuseVertPS:{n:"diffusePS",f:_oldChunkVert},diffuseVertConstPS:{n:"diffusePS",f:_oldChunkVertColor},emissiveConstPS:{n:"emissivePS",f:_oldChunkColor},emissiveTexPS:{n:"emissivePS",f:_oldChunkTex},emissiveTexConstPS:{n:"emissivePS",f:_oldChunkTexColor},
emissiveTexConstFloatPS:{n:"emissivePS",f:_oldChunkTexFloat},emissiveVertPS:{n:"emissivePS",f:_oldChunkVert},emissiveVertConstPS:{n:"emissivePS",f:_oldChunkVertColor},emissiveVertConstFloatPS:{n:"emissivePS",f:_oldChunkVertFloat},glossConstPS:{n:"glossPS",f:_oldChunkFloat},glossTexPS:{n:"glossPS",f:_oldChunkTex},glossTexConstPS:{n:"glossPS",f:_oldChunkTexFloat},glossVertPS:{n:"glossPS",f:_oldChunkVert},glossVertConstPS:{n:"glossPS",f:_oldChunkVertFloat},metalnessConstPS:{n:"metalnessPS",f:_oldChunkFloat},
metalnessTexPS:{n:"metalnessPS",f:_oldChunkTex},metalnessTexConstPS:{n:"metalnessPS",f:_oldChunkTexFloat},metalnessVertPS:{n:"metalnessPS",f:_oldChunkVert},metalnessVertConstPS:{n:"metalnessPS",f:_oldChunkVertFloat},opacityConstPS:{n:"opacityPS",f:_oldChunkFloat},opacityTexPS:{n:"opacityPS",f:_oldChunkTex},opacityTexConstPS:{n:"opacityPS",f:_oldChunkTexFloat},opacityVertPS:{n:"opacityPS",f:_oldChunkVert},opacityVertConstPS:{n:"opacityPS",f:_oldChunkVertFloat},specularConstPS:{n:"specularPS",f:_oldChunkColor},
specularTexPS:{n:"specularPS",f:_oldChunkTex},specularTexConstPS:{n:"specularPS",f:_oldChunkTexColor},specularVertPS:{n:"specularPS",f:_oldChunkVert},specularVertConstPS:{n:"specularPS",f:_oldChunkVertColor},transformBatchSkinnedVS:{n:"transformVS",f:_oldChunkTransformDynbatch},transformInstancedVS:{n:"transformVS",f:_oldChunkTransformInstanced},transformPixelSnapVS:{n:"transformVS",f:_oldChunkTransformPixelSnap},transformScreenSpaceVS:{n:"transformVS",f:_oldChunkTransformScreenSpace},transformScreenSpaceBatchSkinned:{n:"transformVS",
f:_oldChunkTransformScreenSpaceBatch},transformSkinned:{n:"transformVS",f:_oldChunkTransformSkin},transformUv1:{n:"transformVS",f:_oldChunkTransformUv1}},optionsContext:{},optionsContextMin:{},generateKey:function(d){var b=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&"chunks"!==c&&"lights"!==c&&b.push(c);return b.sort()};if(d===this.optionsContextMin){this.propsMin||(this.propsMin=b(d));var a=this.propsMin}else d===this.optionsContext?(this.props||(this.props=b(d)),a=this.props):a=b(d);
b="standard";var c;for(c=0;c<a.length;c++)d[a[c]]&&(b+=a[c]+d[a[c]]);if(d.chunks){a=[];for(var e in d.chunks)d.chunks.hasOwnProperty(e)&&a.push(e+d.chunks[e]);a.sort();b+=a}if(d.lights)for(c=0;c<d.lights.length;c++)b+=d.lights[c].key;return pc.hashCode(b)},_correctChannel:function(d,b){if(0<pc._matTex2D[d]){if(pc._matTex2D[d]<b.length)return b.substring(0,pc._matTex2D[d]);if(pc._matTex2D[d]>b.length){var a=b.charAt(b.length-1);d=pc._matTex2D[d]-b.length;for(var c=0;c<d;c++)b+=a}return b}},_setMapTransform:function(d,
b,a,c){d[0]+="uniform vec4 texture_"+b+"MapTransform;\n";var e=a+100*c;d[3][e]||(d[1]+="varying vec2 vUV"+c+"_"+a+";\n",d[2]+="   vUV"+c+"_"+a+" = uv"+c+" * texture_"+b+"MapTransform.xy + texture_"+b+"MapTransform.zw;\n",d[3][e]=!0);return d},_getUvSourceExpression:function(d,b,a){var c=a[d];b=a[b];var e=a.pass===pc.SHADER_FORWARD||a.pass===pc.SHADER_FORWARDHDR;e&&a.nineSlicedMode===pc.SPRITE_RENDERMODE_SLICED?c="nineSlicedUv":e&&a.nineSlicedMode===pc.SPRITE_RENDERMODE_TILED?c="nineSlicedUv, -1000.0":
(c=0===c?"vUv"+b:"vUV"+b+"_"+c,a.heightMap&&"heightMapTransform"!==d&&(c+=" + dUvOffset"));return c},_addMapDef:function(d,b){var a="\n#undef "+d+"\n";b&&(a+=" #define "+d+"\n");return a},_addMapDefs:function(d,b,a,c){d=""+this._addMapDef("MAPFLOAT",d);d+=this._addMapDef("MAPCOLOR",b);d+=this._addMapDef("MAPVERTEX",a);return d+=this._addMapDef("MAPTEXTURE",c)},_addMap:function(d,b,a,c,e){var f=d+"Map",g=f+"Uv",n=f+"Transform",k=f+"Channel",h=d+"VertexColorChannel",m=a[d+"Tint"],l=a[d+"VertexColor"];
f=a[f];d=a[d+"Mode"];b=c[b];f&&(g=this._getUvSourceExpression(n,g,a),b=b.replace(/\$UV/g,g).replace(/\$CH/g,a[k]),void 0!==e&&(b=b.replace(/\$texture2DSAMPLE/g,0===e?"texture2DSRGB":1===e?"texture2DRGBM":"texture2D")));l&&(b=b.replace(/\$VC/g,a[h]));d&&(b=b.replace(/\$DETAILMODE/g,d));b=this._addMapDefs(1===m,3===m,l,f)+b;return b.replace(/\$/g,"")},_nonPointShadowMapProjection:function(d,b,a){return!b._normalOffsetBias||b._isVsm?b._type===pc.LIGHTTYPE_SPOT?b._isPcf&&(d.webgl2||d.extStandardDerivatives)?
"       getShadowCoordPerspZbuffer"+a:"       getShadowCoordPersp"+a:"       getShadowCoordOrtho"+a:b._type===pc.LIGHTTYPE_SPOT?b._isPcf&&(d.webgl2||d.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+a:"       getShadowCoordPerspNormalOffset"+a:"       getShadowCoordOrthoNormalOffset"+a},_addVaryingIfNeeded:function(d,b,a){return 0<=d.indexOf(a)?"varying "+b+" "+a+";\n":""},_vsAddTransformCode:function(d,b,a,c){return d+=a.transformVS},_vsAddBaseCode:function(d,b,a,c){d+=a.baseVS;
if(c.nineSlicedMode===pc.SPRITE_RENDERMODE_SLICED||c.nineSlicedMode===pc.SPRITE_RENDERMODE_TILED)d+=a.baseNineSlicedVS;return d},_fsAddBaseCode:function(d,b,a,c){d+=a.basePS;c.nineSlicedMode===pc.SPRITE_RENDERMODE_SLICED?d+=a.baseNineSlicedPS:c.nineSlicedMode===pc.SPRITE_RENDERMODE_TILED&&(d+=a.baseNineSlicedTiledPS);return d},_fsAddStartCode:function(d,b,a,c){d+=a.startPS;c.nineSlicedMode===pc.SPRITE_RENDERMODE_SLICED?d+=a.startNineSlicedPS:c.nineSlicedMode===pc.SPRITE_RENDERMODE_TILED&&(d+=a.startNineSlicedTiledPS);
return d},createShaderDefinition:function(d,b){var a,c=0<b.lights.length;b.dirLightMap&&(c=!0,b.useSpecular=!0);b.shadingModel===pc.SPECULAR_PHONG?(b.fresnelModel=0,b.specularAntialias=!1,b.prefilteredCubemap=!1,b.dpAtlas=!1,b.ambientSH=!1):b.fresnelModel=0===b.fresnelModel?pc.FRESNEL_SCHLICK:b.fresnelModel;var e=(b.cubeMap||b.prefilteredCubemap&&b.useSpecular)&&!b.sphereMap&&!b.dpAtlas,f=b.sphereMap||e||b.dpAtlas,g=b.useTexCubeLod;b.cubeMap&&(b.sphereMap=null);b.dpAtlas&&(b.prefilteredCubemap=null);
b.useSpecular||(b.specularMap=b.glossMap=null);var n=c||f||b.ambientSH||b.prefilteredCubemap||b.heightMap||b.enableGGXSpecular,k=b.pass>=pc.SHADER_SHADOW&&17>=b.pass;this.options=b;var h="",m="",l="",p=pc.shaderChunks,q={vertex_position:pc.SEMANTIC_POSITION};if(b.chunks){var r={};for(A in p)if(p.hasOwnProperty(A))if(b.chunks[A]){var t=b.chunks[A];0<=t.indexOf("vertex_normal")&&(q.vertex_normal=pc.SEMANTIC_NORMAL);0<=t.indexOf("vertex_tangent")&&(q.vertex_tangent=pc.SEMANTIC_TANGENT);0<=t.indexOf("vertex_texCoord0")&&
(q.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);0<=t.indexOf("vertex_texCoord1")&&(q.vertex_texCoord1=pc.SEMANTIC_TEXCOORD1);0<=t.indexOf("vertex_color")&&(q.vertex_color=pc.SEMANTIC_COLOR);0<=t.indexOf("vertex_boneWeights")&&(q.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT);0<=t.indexOf("vertex_boneIndices")&&(q.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);r[A]=t}else r[A]=p[A];for(A in b.chunks)(p=this._oldChunkToNew[A])&&(r[p.n]=p.f(b.chunks[A],p.n,A));p=r}h=this._vsAddBaseCode(h,d,p,b);r=-1;if(!b.noShadow&&
!b.twoSidedLighting){for(a=0;a<b.lights.length;a++)if(t=b.lights[a]._type,b.lights[a].castShadows&&t===pc.LIGHTTYPE_DIRECTIONAL){h+="uniform mat4 light"+a+"_shadowMatrixVS;\n";h+="uniform vec3 light"+a+"_shadowParamsVS;\n";h+="uniform vec3 light"+a+(t===pc.LIGHTTYPE_DIRECTIONAL?"_directionVS":"_positionVS")+";\n";r=a;break}0<=r&&(h+=p.shadowCoordVS)}m+="   vPositionW    = getWorldPosition();\n";b.pass===pc.SHADER_DEPTH&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",
m+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n");b.useInstancing&&(q.instance_line1=pc.SEMANTIC_TEXCOORD2,q.instance_line2=pc.SEMANTIC_TEXCOORD3,q.instance_line3=pc.SEMANTIC_TEXCOORD4,q.instance_line4=pc.SEMANTIC_TEXCOORD5,h+=p.instancingVS);n&&(q.vertex_normal=pc.SEMANTIC_NORMAL,m+="   vNormalW    = dNormalW = getNormal();\n",b.sphereMap&&16>=d.fragmentUniformsCount&&(h+=p.viewNormalVS,m+="   vNormalV    = getViewNormal();\n"),(b.heightMap||b.normalMap||b.enableGGXSpecular)&&
b.hasTangents?(q.vertex_tangent=pc.SEMANTIC_TANGENT,h+=p.tangentBinormalVS,m+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"):b.enableGGXSpecular&&(h+=p.tangentBinormalVS,m+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"),0<=r&&(t=b.lights[r]._type,m=t===pc.LIGHTTYPE_DIRECTIONAL?m+("   dLightDirNormW = light"+r+"_directionVS;\n"):m+("   getLightDirPoint(light"+r+"_positionVS);\n"),m+=this._nonPointShadowMapProjection(d,b.lights[r],"(light"+r+"_shadowMatrixVS, light"+r+"_shadowParamsVS);\n")));
t=[];var u=[];for(A in pc._matTex2D){a=A+"Map";if(b[A+"VertexColor"]){var x=A+"VertexColorChannel";b[x]=this._correctChannel(A,b[x])}if(b[a]){x=a+"Channel";var v=a+"Transform";var y=a+"Uv";b[y]=Math.min(b[y],1);b[x]=this._correctChannel(A,b[x]);y=b[y];t[y]=!0;u[y]=u[y]||b[a]&&!b[v]}}b.forceUv1&&(t[1]=!0);for(a=0;2>a;a++)t[a]&&(q["vertex_texCoord"+a]=pc["SEMANTIC_TEXCOORD"+a],h+=p["uv"+a+"VS"],m+="   vec2 uv"+a+" = getUv"+a+"();\n"),u[a]&&(m+="   vUv"+a+" = uv"+a+";\n");t=[h,l,m,[]];for(A in pc._matTex2D)a=
A+"Map",b[a]&&(v=a+"Transform",b[v]&&(y=a+"Uv",this._setMapTransform(t,A,b[v],b[y])));h=t[0];l=t[1];m=t[2];b.vertexColors&&(q.vertex_color=pc.SEMANTIC_COLOR,m+="   vVertexColor = vertex_color;\n");b.skin?(q.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,q.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES,h+=pc.programlib.skinCode(d,p),h+="#define SKIN\n"):b.useInstancing&&(h+="#define INSTANCING\n");b.screenSpace&&(h+="#define SCREENSPACE\n");b.pixelSnap&&(h+="#define PIXELSNAP\n");h=this._vsAddTransformCode(h,
d,p,b);n&&(h+=p.normalVS);h=h+"\n"+p.startVS;var A=h=h+m+"}";t=l;l=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv");l+=this._addVaryingIfNeeded(h,"vec4","vVertexColor");l+=this._addVaryingIfNeeded(h,"vec3","vPositionW");l+=this._addVaryingIfNeeded(h,"vec3","vNormalV");l+=this._addVaryingIfNeeded(h,"vec3","vNormalW");l+=this._addVaryingIfNeeded(h,"vec3","vTangentW");l+=this._addVaryingIfNeeded(h,"vec3","vBinormalW");l+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW");l+=this._addVaryingIfNeeded(h,
"vec2","vUv0");l+=this._addVaryingIfNeeded(h,"vec2","vUv1");l+=t;A=l+A;h="";d.webgl2?(h=pc.programlib.versionCode(d),p.extensionVS&&(h+=p.extensionVS+"\n"),A=h+p.gles3VS+A):(p.extensionVS&&(h=p.extensionVS+"\n"),A=h+A);b.forceFragmentPrecision&&"highp"!=b.forceFragmentPrecision&&"mediump"!==b.forceFragmentPrecision&&"lowp"!==b.forceFragmentPrecision&&(b.forceFragmentPrecision=null);b.forceFragmentPrecision&&("highp"===b.forceFragmentPrecision&&"highp"!==d.maxPrecision&&(b.forceFragmentPrecision="mediump"),
"mediump"===b.forceFragmentPrecision&&"lowp"===d.maxPrecision&&(b.forceFragmentPrecision="lowp"));h="";d.webgl2&&(h+=pc.programlib.versionCode(d));d.extStandardDerivatives&&!d.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n");p.extensionPS&&(h+=p.extensionPS+"\n");d.webgl2&&(h+=p.gles3PS);h+=b.forceFragmentPrecision?"precision "+b.forceFragmentPrecision+" float;\n\n":pc.programlib.precisionCode(d);if(b.pass===pc.SHADER_PICK)return h=h+"uniform vec4 uColor;\n"+l,b.alphaTest&&(h=h+
"float dAlpha;\n"+this._addMap("opacity","opacityPS",b,p),h+=p.alphaTestPS),h+=pc.programlib.begin(),b.alphaTest&&(h+="   getOpacity();\n   alphaTest(dAlpha);\n"),h=h+"    gl_FragColor = uColor;\n"+pc.programlib.end(),{attributes:q,vshader:A,fshader:h};if(b.pass===pc.SHADER_DEPTH)return h=h+"varying float vDepth;\n"+l+p.packDepthPS,b.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",b,p),h+=p.alphaTestPS),h+=pc.programlib.begin(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),
h+="    gl_FragColor = packFloat(vDepth);\n",h+=pc.programlib.end(),{attributes:q,vshader:A,fshader:h};if(k)return e=b.pass-pc.SHADER_SHADOW,t=Math.floor(e/5),e-=5*t,d.extStandardDerivatives&&!d.webgl2&&(h+="uniform vec2 polygonOffset;\n"),e===pc.SHADOW_VSM32?h=d.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":e===pc.SHADOW_VSM16&&(h+="#define VSM_EXPONENT 5.54\n\n"),t!==pc.LIGHTTYPE_DIRECTIONAL&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),
h+=l,b.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",b,p),h+=p.alphaTestPS),e!==pc.SHADOW_PCF3||d.webgl2&&t!==pc.LIGHTTYPE_POINT?e===pc.SHADOW_VSM8&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="    vec2 enc = vec2(1.0, 255.0) * v;\n",h+="    enc = fract(enc);\n",h+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="    return enc;\n",h+="}\n\n"):h+=p.packDepthPS,h+=pc.programlib.begin(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),b=e===pc.SHADOW_VSM8||
e===pc.SHADOW_VSM16||e===pc.SHADOW_VSM32,h=t===pc.LIGHTTYPE_POINT||b&&t!==pc.LIGHTTYPE_DIRECTIONAL?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n",e!==pc.SHADOW_PCF3||d.webgl2&&t!==pc.LIGHTTYPE_POINT?h=e===pc.SHADOW_PCF3||e===pc.SHADOW_PCF5?h+"   gl_FragColor = vec4(1.0);\n":e===pc.SHADOW_VSM8?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+p.storeEVSMPS:(d.extStandardDerivatives&&!d.webgl2&&
(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="   gl_FragColor = packFloat(depth);\n"),h+=pc.programlib.end(),{attributes:q,vshader:A,fshader:h};if(b.customFragmentShader)return d=h+b.customFragmentShader,{attributes:q,vshader:A,fshader:d,tag:pc.SHADERTAG_MATERIAL};h=this._fsAddBaseCode(h+l,d,p,b);b.detailModes&&(h+=p.detailModesPS);l=h;h=
"";0<b.clearCoat&&(h+="#define CLEARCOAT\n");u=0;v=[];x=y=!1;for(a=0;a<b.lights.length;a++)if(m=b.lights[a],t=m._type,h+="uniform vec3 light"+a+"_color;\n",t===pc.LIGHTTYPE_DIRECTIONAL?h+="uniform vec3 light"+a+"_direction;\n":(h+="uniform vec3 light"+a+"_position;\n",h+="uniform float light"+a+"_radius;\n",t===pc.LIGHTTYPE_SPOT&&(h+="uniform vec3 light"+a+"_direction;\n",h+="uniform float light"+a+"_innerConeAngle;\n",h+="uniform float light"+a+"_outerConeAngle;\n")),m.castShadows&&!b.noShadow&&
(h+="uniform mat4 light"+a+"_shadowMatrix;\n",h=t!==pc.LIGHTTYPE_DIRECTIONAL?h+("uniform vec4 light"+a+"_shadowParams;\n"):h+("uniform vec3 light"+a+"_shadowParams;\n"),h=t===pc.LIGHTTYPE_POINT?h+("uniform samplerCube light"+a+"_shadowMap;\n"):m._isPcf&&d.webgl2?h+("uniform sampler2DShadow light"+a+"_shadowMap;\n"):h+("uniform sampler2D light"+a+"_shadowMap;\n"),u++,v[m._shadowType]=!0,m._isVsm&&(y=!0),m._isPcf&&(d.webgl2||d.extStandardDerivatives)&&t===pc.LIGHTTYPE_SPOT&&(x=!0)),m._cookie)if(m._cookie._cubemap)t===
pc.LIGHTTYPE_POINT&&(h+="uniform samplerCube light"+a+"_cookie;\n",h+="uniform float light"+a+"_cookieIntensity;\n",!m.castShadows||b.noShadow)&&(h+="uniform mat4 light"+a+"_shadowMatrix;\n");else if(t===pc.LIGHTTYPE_SPOT){h+="uniform sampler2D light"+a+"_cookie;\n";h+="uniform float light"+a+"_cookieIntensity;\n";if(!m.castShadows||b.noShadow)h+="uniform mat4 light"+a+"_shadowMatrix;\n";m._cookieTransform&&(h+="uniform vec4 light"+a+"_cookieMatrix;\n",h+="uniform vec2 light"+a+"_cookieOffset;\n")}h+=
"\n";t=!b.hasTangents&&d.extStandardDerivatives?p.TBNderivativePS:b.fastTbn?p.TBNfastPS:p.TBNPS;n&&(b.normalMap?(h+=b.packedNormal?p.normalXYPS:p.normalXYZPS,b.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",b,p)),k=this._getUvSourceExpression("normalMapTransform","normalMapUv",b),h=b.normalizeNormalMap?h+p.normalMapPS.replace(/\$UV/g,k):h+p.normalMapFastPS.replace(/\$UV/g,k),b.hasTangents||(t=t.replace(/\$UV/g,k)),h+=t):(h+=p.normalVertexPS,b.enableGGXSpecular&&(h+=p.TBNObjectSpacePS)));
h+=pc.programlib.gammaCode(b.gamma,p);h+=pc.programlib.tonemapCode(b.toneMap,p);h+=pc.programlib.fogCode(b.fog,p);b.useRgbm&&(h+=p.rgbmPS);if(e||b.prefilteredCubemap)h+=b.fixSeams?p.fixCubemapSeamsStretchPS:p.fixCubemapSeamsNonePS;n&&(h+=0<b.cubeMapProjection?p.cubeMapProjectBoxPS:p.cubeMapProjectNonePS,h+=b.skyboxIntensity?p.envMultiplyPS:p.envConstPS);b.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",b,p));h+=this._addMap("diffuse","diffusePS",b,p);if(b.blendType!==pc.BLEND_NONE||
b.alphaTest||b.alphaToCoverage)h+=this._addMap("opacity","opacityPS",b,p);h+=this._addMap("emissive","emissivePS",b,p,b.emissiveFormat);b.useSpecular&&(c||f)&&(h=b.specularAntialias&&b.normalMap?b.normalizeNormalMap&&n?h+p.specularAaToksvigPS:h+p.specularAaToksvigFastPS:h+p.specularAaNonePS,k=b.useMetalness?"metalness":"specular",h+=this._addMap(k,k+"PS",b,p),h+=this._addMap("gloss","glossPS",b,p),0<b.fresnelModel&&(b.fresnelModel===pc.FRESNEL_SIMPLE?h+=p.fresnelSimplePS:b.fresnelModel===pc.FRESNEL_SCHLICK?
h+=p.fresnelSchlickPS:b.fresnelModel===pc.FRESNEL_COMPLEX&&(h+=p.fresnelComplexPS)));b.heightMap&&(b.normalMap||(k=this._getUvSourceExpression("heightMapTransform","heightMapUv",b),b.hasTangents||(t=t.replace(/\$UV/g,k)),h+=t),h+=this._addMap("height","parallaxPS",b,p));if(k=b.aoMap||b.aoVertexColor)h+=this._addMap("ao","aoPS",b,p),b.occludeSpecular&&(h=b.occludeSpecular===pc.SPECOCC_AO?h+(b.occludeSpecularFloat?p.aoSpecOccSimplePS:p.aoSpecOccConstSimplePS):h+(b.occludeSpecularFloat?p.aoSpecOccPS:
p.aoSpecOccConstPS));t=b.rgbmReflection?"decodeRGBM":b.hdrReflection?"":"gammaCorrectInput";b.sphereMap?(t=16<d.fragmentUniformsCount?p.reflectionSpherePS:p.reflectionSphereLowPS,t=t.replace(/\$texture2DSAMPLE/g,b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"),h+=t):e?h=b.prefilteredCubemap?g?h+p.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,t):h+p.reflectionPrefilteredCubePS.replace(/\$DECODE/g,t):h+p.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,b.rgbmReflection?
"textureCubeRGBM":b.hdrReflection?"textureCube":"textureCubeSRGB"):b.dpAtlas&&(h+=p.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"));if(e||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+=p.reflectionCCPS),b.refraction&&(h+=p.refractionPS);0<u&&(v[pc.SHADOW_PCF3]&&(h+=p.shadowStandardPS),v[pc.SHADOW_PCF5]&&(h+=p.shadowStandardGL2PS),y&&(h+=p.shadowVSM_commonPS,v[pc.SHADOW_VSM8]&&(h+=p.shadowVSM8PS),v[pc.SHADOW_VSM16]&&(h+=d.extTextureHalfFloatLinear?
p.shadowEVSMPS.replace(/\$/g,"16"):p.shadowEVSMnPS.replace(/\$/g,"16")),v[pc.SHADOW_VSM32]&&(h+=d.extTextureFloatLinear?p.shadowEVSMPS.replace(/\$/g,"32"):p.shadowEVSMnPS.replace(/\$/g,"32"))),d.webgl2||d.extStandardDerivatives||(h+=p.biasConstPS),h+=p.shadowCoordPS+p.shadowCommonPS,x&&(h+=p.shadowCoordPerspZbufferPS),0<=r&&(v[pc.SHADOW_PCF3]&&(h+=p.shadowStandardVSPS),v[pc.SHADOW_PCF5]&&(h+=p.shadowStandardGL2VSPS),y&&(v[pc.SHADOW_VSM8]&&(h+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,
"8")),v[pc.SHADOW_VSM16]&&(h+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),v[pc.SHADOW_VSM32]&&(h+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")))));b.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n");c&&(h+=p.lightDiffuseLambertPS);t=!1;b.useSpecular?(c&&(h+=b.shadingModel===pc.SPECULAR_PHONG?p.lightSpecularPhongPS:b.enableGGXSpecular?p.lightSpecularAnisoGGXPS:p.lightSpecularBlinnPS),b.sphereMap||e||b.dpAtlas||0<b.fresnelModel?h=0<b.fresnelModel?b.conserveEnergy?
h+p.combineDiffuseSpecularPS:h+p.combineDiffuseSpecularNoConservePS:h+p.combineDiffuseSpecularOldPS:b.diffuseMap?h+=p.combineDiffuseSpecularNoReflPS:(h+=p.combineDiffuseSpecularNoReflSeparateAmbientPS,t=!0)):h+=p.combineDiffusePS;0<b.clearCoat&&(h+=p.combineClearCoatPS);a=!0;if(b.lightMap||b.lightVertexColor)h+=this._addMap("light",b.dirLightMap?"lightmapDirPS":"lightmapSinglePS",b,p,b.lightMapFormat),a=b.lightMapWithoutAmbient;a&&(m=b.rgbmAmbient?"decodeRGBM":b.hdrAmbient?"":"gammaCorrectInput",
h=b.ambientSH?h+p.ambientSHPS:b.prefilteredCubemap?g?h+p.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,m):h+p.ambientPrefilteredCubePS.replace(/\$DECODE/g,m):h+p.ambientConstantPS);b.ambientTint&&!t&&(h+="uniform vec3 material_ambient;\n");b.alphaTest&&(h+=p.alphaTestPS);b.msdf&&(h+=p.msdfPS);n&&(h+=p.viewDirPS,b.useSpecular&&(h+=b.enableGGXSpecular?p.reflDirAnisoPS:p.reflDirPS));x=y=v=u=g=!1;h=this._fsAddStartCode(h,d,p,b);n&&(h=b.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":
h+"   dVertexNormalW = vNormalW;\n",(b.heightMap||b.normalMap)&&b.hasTangents&&(b.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",h+="   dBinormalW = vBinormalW;\n")));m=!1;b.blendType!==pc.BLEND_NONE||b.alphaTest||b.alphaToCoverage?b.heightMap&&b.opacityMap?m=!0:(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";var z=!1;
if(n){h+="   getViewDir();\n";if(b.heightMap||b.normalMap||b.enableGGXSpecular)h+="   getTBN();\n";b.heightMap&&(h+="   getParallax();\n");m&&(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n"));h+="   getNormal();\n";b.useSpecular&&(b.enableGGXSpecular&&(h+="   getGlossiness();\n",z=!0),h+="   getReflDir();\n")}h+="   getAlbedo();\n";if(c&&b.useSpecular||f)h+="   getSpecularity();\n",z||(h+="   getGlossiness();\n"),0<b.fresnelModel&&(h+="   getFresnel();\n");a&&(h+="   addAmbient();\n");
b.ambientTint&&!t&&(h+="   dDiffuseLight *= material_ambient;\n");k&&!b.occludeDirect&&(h+="    applyAO();\n");if(b.lightMap||b.lightVertexColor)h+="   addLightMap();\n";if(c||f){if(e||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+="   addReflectionCC();\n"),h+="   addReflection();\n";b.dirLightMap&&(h+="   addDirLightMap();\n");for(a=0;a<b.lights.length;a++){m=b.lights[a];t=m._type;f=!1;t===pc.LIGHTTYPE_DIRECTIONAL?(h+="   dLightDirNormW = light"+a+"_direction;\n",h+="   dAtten = 1.0;\n"):(m._cookie&&
(t!==pc.LIGHTTYPE_SPOT||m._cookie._cubemap?t===pc.LIGHTTYPE_POINT&&m._cookie._cubemap&&(f=x=!0):f=x=!0),h+="   getLightDirPoint(light"+a+"_position);\n",g=!0,f&&(h=t===pc.LIGHTTYPE_SPOT?h+("   dAtten3 = getCookie2D"+(m._cookieFalloff?"":"Clip")+(m._cookieTransform?"Xform":"")+"(light"+a+"_cookie, light"+a+"_shadowMatrix, light"+a+"_cookieIntensity"+(m._cookieTransform?", light"+a+"_cookieMatrix, light"+a+"_cookieOffset":"")+")."+m._cookieChannel+";\n"):h+("   dAtten3 = getCookieCube(light"+a+"_cookie, light"+
a+"_shadowMatrix, light"+a+"_cookieIntensity)."+m._cookieChannel+";\n")),m._falloffMode===pc.LIGHTFALLOFF_LINEAR?(h+="   dAtten = getFalloffLinear(light"+a+"_radius);\n",u=!0):(h+="   dAtten = getFalloffInvSquared(light"+a+"_radius);\n",v=!0),h+="   if (dAtten > 0.00001) {\n",t!==pc.LIGHTTYPE_SPOT||f&&!m._cookieFalloff||(h+="       dAtten *= getSpotEffect(light"+a+"_direction, light"+a+"_innerConeAngle, light"+a+"_outerConeAngle);\n",y=!0));h+="       dAtten *= getLightDiffuse();\n";if(m.castShadows&&
!b.noShadow){if(m._shadowType===pc.SHADOW_VSM8){n="VSM8";var E="0.0"}else m._shadowType===pc.SHADOW_VSM16?(n="VSM16",E="5.54"):m._shadowType===pc.SHADOW_VSM32?(n="VSM32",E=d.textureFloatHighPrecision?"15.0":"5.54"):n=m._shadowType===pc.SHADOW_PCF5?"PCF5x5":"PCF3x3";null!==n&&(t===pc.LIGHTTYPE_POINT?(c="(light"+a+"_shadowMap, light"+a+"_shadowParams);\n",m._normalOffsetBias&&(h+="       normalOffsetPointShadow(light"+a+"_shadowParams);\n"),h+="       dAtten *= getShadowPoint"+n+c):(r===a?n+="VS":(c=
"(light"+a+"_shadowMatrix, light"+a+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(d,b.lights[a],c)),t===pc.LIGHTTYPE_SPOT&&(n="Spot"+n),h+="       dAtten *= getShadow"+n+"(light"+a+"_shadowMap, light"+a+"_shadowParams"+(m._isVsm?", "+E:"")+");\n"))}h+="       dDiffuseLight += dAtten * light"+a+"_color"+(f?" * dAtten3":"")+";\n";0<b.clearCoat&&(h+="       ccSpecularLight += getLightSpecularCC() * dAtten * light"+a+"_color"+(f?" * dAtten3":"")+";\n");b.useSpecular&&(h+="       dAtten *= getLightSpecular();\n",
h+="       dSpecularLight += dAtten * light"+a+"_color"+(f?" * dAtten3":"")+";\n");t!==pc.LIGHTTYPE_DIRECTIONAL&&(h+="   }\n");h+="\n"}(e||b.sphereMap||b.dpAtlas)&&b.refraction&&(h+="   addRefraction();\n")}h+="\n";k&&(b.occludeDirect&&(h+="    applyAO();\n"),b.occludeSpecular&&(h+="    occludeSpecular();\n"));h+=p.endPS;h=b.blendType===pc.BLEND_NORMAL||b.blendType===pc.BLEND_ADDITIVEALPHA||b.alphaToCoverage?h+p.outputAlphaPS:b.blendType===pc.BLEND_PREMULTIPLIED?h+p.outputAlphaPremulPS:h+p.outputAlphaOpaquePS;
b.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n");h+="\n";h+=pc.programlib.end();g&&(h=p.lightDirPointPS+h);u&&(h=p.falloffLinearPS+h);v&&(h=p.falloffInvSquaredPS+h);y&&(h=p.spotPS+h);x&&(h=p.cookiePS+h);d="";h.includes("dReflection")&&(d+="vec4 dReflection;\n");h.includes("dTBN")&&(d+="mat3 dTBN;\n");h.includes("dAlbedo")&&(d+="vec3 dAlbedo;\n");h.includes("dEmission")&&(d+="vec3 dEmission;\n");h.includes("dNormalW")&&(d+="vec3 dNormalW;\n");h.includes("dVertexNormalW")&&(d+="vec3 dVertexNormalW;\n");
h.includes("dTangentW")&&(d+="vec3 dTangentW;\n");h.includes("dBinormalW")&&(d+="vec3 dBinormalW;\n");h.includes("dViewDirW")&&(d+="vec3 dViewDirW;\n");h.includes("dReflDirW")&&(d+="vec3 dReflDirW;\n");h.includes("dDiffuseLight")&&(d+="vec3 dDiffuseLight;\n");h.includes("dSpecularLight")&&(d+="vec3 dSpecularLight;\n");h.includes("dLightDirNormW")&&(d+="vec3 dLightDirNormW;\n");h.includes("dLightDirW")&&(d+="vec3 dLightDirW;\n");h.includes("dLightPosW")&&(d+="vec3 dLightPosW;\n");h.includes("dShadowCoord")&&
(d+="vec3 dShadowCoord;\n");h.includes("dNormalMap")&&(d+="vec3 dNormalMap;\n");h.includes("dSpecularity")&&(d+="vec3 dSpecularity;\n");h.includes("dUvOffset")&&(d+="vec2 dUvOffset;\n");h.includes("dGlossiness")&&(d+="float dGlossiness;\n");h.includes("dAlpha")&&(d+="float dAlpha;\n");h.includes("dAtten")&&(d+="float dAtten;\n");h.includes("dAtten3")&&(d+="vec3 dAtten3;\n");h.includes("dAo")&&(d+="float dAo;\n");h.includes("dMsdf")&&(d+="vec4 dMsdf;\n");h.includes("ccReflection")&&(d+="vec4 ccReflection;\n");
h.includes("ccNormalW")&&(d+="vec3 ccNormalW;\n");h.includes("ccReflDirW")&&(d+="vec3 ccReflDirW;\n");h.includes("ccSpecularLight")&&(d+="vec3 ccSpecularLight;\n");h.includes("ccSpecularity")&&(d+="vec3 ccSpecularity;\n");h.includes("ccGlossiness")&&(d+="float ccGlossiness=0.9;\n");d=h=l+d+h;return{attributes:q,vshader:A,fshader:d,tag:pc.SHADERTAG_MATERIAL}}};pc.programlib.skybox={generateKey:function(d){return"skybox"+d.rgbm+" "+d.hdr+" "+d.fixSeams+d.toneMapping+d.gamma+d.useIntensity+d.mip},createShaderDefinition:function(d,b){var a=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:a.skyboxVS,fshader:pc.programlib.precisionCode(d)+(b.mip?a.fixCubemapSeamsStretchPS:a.fixCubemapSeamsNonePS)+(b.useIntensity?a.envMultiplyPS:a.envConstPS)+pc.programlib.gammaCode(b.gamma)+pc.programlib.tonemapCode(b.toneMapping)+a.rgbmPS+a.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,
b.rgbm?"textureCubeRGBM":b.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][b.mip]+"")}}};Object.assign(pc,function(){var d={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},b=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.createFullscreenQuad(a);this.needsDepthBuffer=!1};Object.assign(b.prototype,{render:function(a,b,e){}});return{PostEffect:b,createFullscreenQuad:function(a){var b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);a=new pc.VertexBuffer(a,b,4);b=new pc.VertexIterator(a);b.element[pc.SEMANTIC_POSITION].set(-1,
-1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,-1);b.next();b.element[pc.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,1);b.end();return a},drawFullscreenQuad:function(a,b,e,f,g){var c=a.getRenderTarget();a.setRenderTarget(b);a.updateBegin();var k=null!==b?b.width:a.width,h=null!==b?b.height:a.height,m=0,l=0;g&&(m=g.x*k,l=g.y*h,k*=g.z,h*=g.w);g=a.vx;b=a.vy;var p=a.vw,q=a.vh;a.setViewport(m,l,k,h);var r=a.sx,t=a.sy,u=a.sw,x=a.sh;a.setScissor(m,l,k,h);k=a.getBlending();
h=a.getDepthTest();m=a.getDepthWrite();l=a.getCullMode();var v=a.writeRed,y=a.writeGreen,A=a.writeBlue,z=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);a.setCullMode(pc.CULLFACE_NONE);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(e,0);a.setShader(f);a.draw(d);a.setBlending(k);a.setDepthTest(h);a.setDepthWrite(m);a.setCullMode(l);a.setColorWrite(v,y,A,z);a.updateEnd();a.setRenderTarget(c);a.updateBegin();a.setViewport(g,b,p,q);a.setScissor(r,t,u,x)}}}());(function(){var d={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,BLEND_MIN:9,BLEND_MAX:10,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:15,LAYERID_WORLD:0,LAYERID_DEPTH:1,LAYERID_SKYBOX:2,LAYERID_IMMEDIATE:3,LAYERID_UI:4,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,
LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_PCF3:0,SHADOW_DEPTH:0,SHADOW_VSM8:1,SHADOW_VSM16:2,SHADOW_VSM32:3,SHADOW_PCF5:4,BLUR_BOX:0,BLUR_GAUSSIAN:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PARTICLEORIENTATION_SCREEN:0,PARTICLEORIENTATION_WORLD:1,PARTICLEORIENTATION_EMITTER:2,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,
RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,DETAILMODE_MUL:"mul",DETAILMODE_ADD:"add",DETAILMODE_SCREEN:"screen",DETAILMODE_OVERLAY:"overlay",DETAILMODE_MIN:"min",DETAILMODE_MAX:"max",GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,GAMMA_SRGBHDR:3,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,TONEMAP_HEJL:2,TONEMAP_ACES:3,TONEMAP_ACES2:4,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,
SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,SHADERDEF_DIRLM:128,SHADERDEF_SCREENSPACE:256,SHADERDEF_TANGENTS:512,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2,SORTKEY_FORWARD:0,SORTKEY_DEPTH:1,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4,SHADER_FORWARD:0,SHADER_FORWARDHDR:1,SHADER_DEPTH:2,SHADER_SHADOW:3,SHADER_PICK:18,BAKE_COLOR:0,BAKE_COLORDIR:1,VIEW_CENTER:0,VIEW_LEFT:1,VIEW_RIGHT:2,SORTMODE_NONE:0,SORTMODE_MANUAL:1,
SORTMODE_MATERIALMESH:2,SORTMODE_BACK2FRONT:3,SORTMODE_FRONT2BACK:4,SORTMODE_CUSTOM:5,COMPUPDATED_INSTANCES:1,COMPUPDATED_LIGHTS:2,COMPUPDATED_CAMERAS:4,COMPUPDATED_BLEND:8,ASPECT_AUTO:0,ASPECT_MANUAL:1,ORIENTATION_HORIZONTAL:0,ORIENTATION_VERTICAL:1};Object.assign(pc,d);pc.scene={};Object.assign(pc.scene,d)})();
Object.assign(pc,function(){var d=function(){pc.EventHandler.call(this);this.root=null;this._gravity=new pc.Vec3(0,-9.8,0);this._layers=null;this._fog=pc.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._gammaCorrection=pc.GAMMA_NONE;this._toneMapping=0;this.exposure=1;this._skyboxPrefiltered=[null,null,null,null,null,null];this._firstUpdateSkybox=!0;this.skyboxModel=this._skyboxCubeMap=null;this._skyboxIntensity=
1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=2048;this.lightmapMode=pc.BAKE_COLORDIR;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0};this.updateSkybox=this.updateShaders=!0;this._shaderVersion=0;this._statsUpdated=!1;this._models=[];this.defaultMaterial=new pc.StandardMaterial;this.defaultMaterial.name=
"Default Material";this.defaultMaterial.shadingModel=pc.SPECULAR_BLINN};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype.destroy=function(){this.root=null;this.defaultMaterial.destroy();this.defaultMaterial=null;this.off()};Object.defineProperty(d.prototype,"fog",{get:function(){return this._fog},set:function(b){b!==this._fog&&(this._fog=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},
set:function(b){b!==this._gammaCorrection&&(this._gammaCorrection=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(b){b!==this._toneMapping&&(this._toneMapping=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(b){this._skyboxCubeMap=b;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(d.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},
set:function(b){this._skyboxIntensity=b;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(d.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(b){this._skyboxMip=b;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(d.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},set:function(b){this._skyboxPrefiltered[0]!==b&&(this._skyboxPrefiltered[0]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,
"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(b){this._skyboxPrefiltered[1]!==b&&(this._skyboxPrefiltered[1]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(b){this._skyboxPrefiltered[2]!==b&&(this._skyboxPrefiltered[2]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(b){this._skyboxPrefiltered[3]!==
b&&(this._skyboxPrefiltered[3]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(b){this._skyboxPrefiltered[4]!==b&&(this._skyboxPrefiltered[4]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(b){this._skyboxPrefiltered[5]!==b&&(this._skyboxPrefiltered[5]=b,this.updateShaders=!0)}});Object.defineProperty(d.prototype,
"drawCalls",{get:function(){var b=this.layers._meshInstances;b.length||(this.layers._update(),b=this.layers._meshInstances);return b},set:function(b){}});Object.defineProperty(d.prototype,"layers",{get:function(){return this._layers},set:function(b){var a=this._layers;this._layers=b;this.fire("set:layers",a,b)}});d.prototype.applySettings=function(b){this._gravity.set(b.physics.gravity[0],b.physics.gravity[1],b.physics.gravity[2]);this.ambientLight.set(b.render.global_ambient[0],b.render.global_ambient[1],
b.render.global_ambient[2]);this._fog=b.render.fog;this.fogColor.set(b.render.fog_color[0],b.render.fog_color[1],b.render.fog_color[2]);this.fogStart=b.render.fog_start;this.fogEnd=b.render.fog_end;this.fogDensity=b.render.fog_density;this._gammaCorrection=b.render.gamma_correction;this._toneMapping=b.render.tonemapping;this.lightmapSizeMultiplier=b.render.lightmapSizeMultiplier;this.lightmapMaxResolution=b.render.lightmapMaxResolution;this.lightmapMode=b.render.lightmapMode;this.exposure=b.render.exposure;
this._skyboxIntensity=void 0===b.render.skyboxIntensity?1:b.render.skyboxIntensity;this._skyboxMip=void 0===b.render.skyboxMip?0:b.render.skyboxMip;this._resetSkyboxModel();this.updateShaders=!0};d.prototype._updateSkybox=function(b){if(this._skyboxCubeMap&&!this.skyboxModel){var a=new pc.Material,c=this;a.updateShader=function(a,e,f,g,d){this.shader=b.getProgramLibrary().getProgram("skybox",{rgbm:c._skyboxCubeMap.rgbm,hdr:c._skyboxCubeMap.rgbm||c._skyboxCubeMap.format===pc.PIXELFORMAT_RGBA32F,useIntensity:1!==
c.skyboxIntensity,mip:c._skyboxCubeMap.fixCubemapSeams?c.skyboxMip:0,fixSeams:c._skyboxCubeMap.fixCubemapSeams,gamma:d===pc.SHADER_FORWARDHDR?c.gammaCorrection?pc.GAMMA_SRGBHDR:pc.GAMMA_NONE:c.gammaCorrection,toneMapping:d===pc.SHADER_FORWARDHDR?pc.TONEMAP_LINEAR:c.toneMapping})};a.updateShader();var e;if(this._skyboxCubeMap.fixCubemapSeams&&c._skyboxMip){var f=this["skyboxPrefiltered"+[null,"64","16","8","4"][c._skyboxMip]];f&&(e=f)}else e=this._skyboxCubeMap;a.setParameter("texture_cubeMap",e);
a.cull=pc.CULLFACE_FRONT;a.depthWrite=!1;if(f=this.layers.getLayerById(pc.LAYERID_SKYBOX)){var g=new pc.GraphNode,d=pc.createBox(b);a=new pc.MeshInstance(g,d,a);a.cull=!1;a._noDepthDrawGl1=!0;d=new pc.Model;d.graph=g;d.meshInstances=[a];this.skyboxModel=d;f.addMeshInstances(d.meshInstances);this.skyLayer=f;this._firstUpdateSkybox&&(f.enabled=!0,this._firstUpdateSkybox=!1);this.fire("set:skybox",e)}}};d.prototype._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),
this.skyboxModel.destroy());this.skyboxModel=null;this.updateSkybox=!0};d.prototype.setSkybox=function(b){var a;b||(b=[null,null,null,null,null,null,null]);var c=!1;this._skyboxCubeMap!==b[0]&&(c=!0);if(!c)for(a=0;6>a&&!c;a++)this._skyboxPrefiltered[a]!==b[a+1]&&(c=!0);if(c){for(a=0;6>a;a++)this._skyboxPrefiltered[a]=b[a+1];this.skybox=b[0]}};d.prototype.destroy=function(){this.skybox=null};d.prototype.addModel=function(b){if(!this.containsModel(b)){var a=this.layers.getLayerById(pc.LAYERID_WORLD);
a&&(a.addMeshInstances(b.meshInstances),this._models.push(b))}};d.prototype.addShadowCaster=function(b){var a=this.layers.getLayerById(pc.LAYERID_WORLD);a&&a.addShadowCasters(b.meshInstances)};d.prototype.removeModel=function(b){var a=this._models.indexOf(b);if(-1!==a){var c=this.layers.getLayerById(pc.LAYERID_WORLD);c&&(c.removeMeshInstances(b.meshInstances),this._models.splice(a,1))}};d.prototype.removeShadowCasters=function(b){var a=this.layers.getLayerById(pc.LAYERID_WORLD);a&&a.removeShadowCasters(b.meshInstances)};
d.prototype.containsModel=function(b){return 0<=this._models.indexOf(b)};d.prototype.getModels=function(b){return this._models};return{Scene:d}}());Object.assign(pc,function(){function d(a,b){if(b!==pc.SHADOW_PCF3||a.webgl2){if(b===pc.SHADOW_VSM32)return a.extTextureFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST;if(b===pc.SHADOW_VSM16)return a.extTextureHalfFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST}else return pc.FILTER_NEAREST;return pc.FILTER_LINEAR}function b(a,b,c,e){var f=e===pc.SHADOW_VSM32?pc.PIXELFORMAT_RGBA32F:e===pc.SHADOW_VSM16?pc.PIXELFORMAT_RGBA16F:e===pc.SHADOW_PCF5||e===pc.SHADOW_PCF3&&a.webgl2?pc.PIXELFORMAT_DEPTH:pc.PIXELFORMAT_R8_G8_B8_A8,
g=d(a,e);b=new pc.Texture(a,{format:f,width:b,height:c,mipmaps:!1,minFilter:g,magFilter:g,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});b.name="shadowmap";return e===pc.SHADOW_PCF5||e===pc.SHADOW_PCF3&&a.webgl2?(b.compareOnRead=!0,b.compareFunc=pc.FUNC_LESS,new pc.RenderTarget({depthBuffer:b})):new pc.RenderTarget({colorBuffer:b,depth:!0})}function a(a,b){a=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:b,cubemap:!0,mipmaps:!1,minFilter:pc.FILTER_NEAREST,
magFilter:pc.FILTER_NEAREST,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});a.name="shadowcube";b=[];for(var c,e=0;6>e;e++)c=new pc.RenderTarget({colorBuffer:a,face:e,depth:!0}),b.push(c);return b}function c(a){25<a&&(a=25);var b=(a-1)/6,c,e;var f=.5*(a-1);var g=Array(a);for(c=e=0;c<a;++c){var d=c-f;g[c]=Math.exp(-(d*d)/(2*b*b));e+=g[c]}for(c=0;c<a;++c)g[c]/=e;return g}function e(a,c,e,f){f||(f=0);f=1E4*f+c;var g=l[e][f];g||(g=b(a,c,c,e?e:pc.SHADOW_PCF3),l[e][f]=g);return g}
function f(c,f){if(f._type===pc.LIGHTTYPE_POINT){f._shadowType>pc.SHADOW_PCF3&&(f._shadowType=pc.SHADOW_PCF3);if(f._cacheShadowMap){var g=Q[f._shadowResolution];g||(g=a(c,f._shadowResolution),Q[f._shadowResolution]=g)}else g=a(c,f._shadowResolution);f._shadowCamera.renderTarget=g[0];f._shadowCubeMap=g}else g=f._cacheShadowMap?e(c,f._shadowResolution,f._shadowType):b(c,f._shadowResolution,f._shadowResolution,f._shadowType),f._shadowCamera.renderTarget=g;f._isCachedShadowMap=f._cacheShadowMap}function g(a){a=
this.device=a;this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0;this.library=a.getProgramLibrary();a=a.scope;this.projId=a.resolve("matrix_projection");this.projSkyboxId=a.resolve("matrix_projectionSkybox");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");
this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPos=new Float32Array(3);this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.cameraParamsId=a.resolve("camera_params");this.shadowMapLightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");
this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.alphaTestId=a.resolve("alpha_ref");this.opacityMapId=a.resolve("texture_opacityMap");this.ambientId=a.resolve("light_globalAmbient");this.exposureId=a.resolve("exposure");this.skyboxIntensityId=a.resolve("skyboxIntensity");this.lightColorId=[];this.lightDir=
[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=[];this.lightDirVs=[];this.lightDirVsId=[];this.lightRadiusId=[];this.lightPos=[];this.lightPosId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=a.resolve("uDepthMap");this.screenSizeId=a.resolve("uScreenSize");
this._screenSize=new Float32Array(4);this.sourceId=a.resolve("source");this.pixelOffsetId=a.resolve("pixelOffset");this.weightId=a.resolve("weight[0]");var b=pc.shaderChunks;this.blurVsmShaderCode=[b.blurVSMPS,"#define GAUSS\n"+b.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.polygonOffsetId=a.resolve("polygonOffset");this.polygonOffset=
new Float32Array(2);this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}function n(a,b){a.data[0]=b.data[0];a.data[1]=b.data[1];a.data[2]=b.data[2];a.data[3]=b.data[4];a.data[4]=b.data[5];a.data[5]=b.data[6];a.data[6]=b.data[8];a.data[7]=b.data[9];a.data[8]=b.data[10]}for(var k=(new pc.Mat4).mul2((new pc.Mat4).setTranslate(.5,.5,.5),(new pc.Mat4).setScale(.5,.5,.5)),h={r:1,g:2,b:3,a:4},m=[(new pc.Quat).setFromEulerAngles(0,90,180),(new pc.Quat).setFromEulerAngles(0,-90,180),(new pc.Quat).setFromEulerAngles(90,
0,0),(new pc.Quat).setFromEulerAngles(-90,0,0),(new pc.Quat).setFromEulerAngles(0,180,180),(new pc.Quat).setFromEulerAngles(0,0,180)],l=[{},{},{},{},{}],p=new Float32Array(2),q={x:1,y:1,z:0,w:0},r=new pc.Mat4,t=new pc.Mat4,u=new pc.Mat4,x=new pc.Mat4,v=new pc.Mat4,y=new pc.Mat3,A=new pc.Mat4,z,E=new pc.Mat4,C=new pc.Mat4,D=new pc.Mat4,F=new pc.Mat4,I=new pc.Vec3,G=new pc.Vec3,B,w,H=new pc.Mat4,M=new pc.Mat4,aa=new pc.Mat4,R=new pc.Mat4,T=new pc.Vec3,ea=new pc.Vec3,J=new pc.Vec3,Z=new pc.Vec3,N={center:null,
radius:0},S,P=new pc.BoundingBox,Y=[0,0],U,K,V,L,Q={},X,ba,O=[],ca=0;8>ca;ca++)O.push(new pc.Vec3);var W=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];Object.assign(g.prototype,{sortCompare:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist;if(a.zdist2&&b.zdist2)return a.zdist2-b.zdist2}return b._key[pc.SORTKEY_FORWARD]-a._key[pc.SORTKEY_FORWARD]},sortCompareMesh:function(a,
b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist}X=a._key[pc.SORTKEY_FORWARD];ba=b._key[pc.SORTKEY_FORWARD];return X===ba&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:ba-X},depthSortCompare:function(a,b){X=a._key[pc.SORTKEY_DEPTH];ba=b._key[pc.SORTKEY_DEPTH];return X===ba&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:ba-X},lightCompare:function(a,b){return a.key-b.key},_isVisible:function(a,b){if(!b.visible)return!1;if(b.isVisibleFunc)return b.isVisibleFunc(a);
S=b.aabb.center;b._aabb._radiusVer!==b._aabbVer&&(b._aabb._radius=b._aabb.halfExtents.length(),b._aabb._radiusVer=b._aabbVer);N.radius=b._aabb._radius;N.center=S;return a.frustum.containsSphere(N)},getShadowCamera:function(a,b){var c=b._shadowCamera;if(null===c){c=b._shadowType;var e=pc.CLEARFLAG_DEPTH;var g=c===pc.SHADOW_PCF5||c===pc.SHADOW_PCF3&&a.webgl2;b._type===pc.LIGHTTYPE_POINT&&(g=!1);g||(e|=pc.CLEARFLAG_COLOR);g=new pc.Camera;c>=pc.SHADOW_VSM8&&c<=pc.SHADOW_VSM32?(g.clearColor[0]=0,g.clearColor[1]=
0,g.clearColor[2]=0,g.clearColor[3]=0):(g.clearColor[0]=1,g.clearColor[1]=1,g.clearColor[2]=1,g.clearColor[3]=1);g.clearDepth=1;g.clearFlags=e;g.clearStencil=null;g._node=new pc.GraphNode;c=b._shadowCamera=g;f(a,b)}else e=c.renderTarget,e.width===b._shadowResolution&&e.height===b._shadowResolution||f(a,b);return c},updateCameraFrustum:function(a){if(a.vrDisplay&&a.vrDisplay.presenting){z=a.vrDisplay.combinedProj;var b=a._node.parent;b?v.copy(b.getWorldTransform()).mul(a.vrDisplay.combinedViewInv).invert():
v.copy(a.vrDisplay.combinedView);x.copy(v).invert();this.viewInvId.setValue(x.data);a.frustum.update(z,v)}else if(a.xr&&a.xr.views.length){b=a.xr.views[0];a.frustum.update(b.projMat,b.viewOffMat);return}z=a.getProjectionMatrix();a.overrideCalculateProjection&&a.calculateProjection(z,pc.VIEW_CENTER);if(a.overrideCalculateTransform)a.calculateTransform(x,pc.VIEW_CENTER);else{b=a._node.getPosition();var c=a._node.getRotation();x.setTRS(b,c,pc.Vec3.ONE);this.viewInvId.setValue(x.data)}v.copy(x).invert();
a.frustum.update(z,v)},setCamera:function(a,b,c,e){var f=a.vrDisplay,g;if(f&&f.presenting){B=f.leftProj;w=f.rightProj;z=f.combinedProj;a.overrideCalculateProjection&&(a.calculateProjection(B,pc.VIEW_LEFT),a.calculateProjection(w,pc.VIEW_RIGHT),a.calculateProjection(z,pc.VIEW_CENTER));if(a.overrideCalculateTransform)a.calculateTransform(E,pc.VIEW_LEFT),a.calculateTransform(C,pc.VIEW_RIGHT),a.calculateTransform(x,pc.VIEW_CENTER),D.copy(E).invert(),F.copy(C).invert(),v.copy(x).invert();else if(g=a._node.parent){var d=
g.getWorldTransform();E.mul2(d,f.leftViewInv);C.mul2(d,f.rightViewInv);D.copy(E).invert();F.copy(C).invert();v.copy(g.getWorldTransform()).mul(f.combinedViewInv).invert()}else E.copy(f.leftViewInv),C.copy(f.rightViewInv),D.copy(f.leftView),F.copy(f.rightView),v.copy(f.combinedView);n(H,D);n(M,F);aa.mul2(B,D);R.mul2(w,F);I.x=E.data[12];I.y=E.data[13];I.z=E.data[14];G.x=C.data[12];G.y=C.data[13];G.z=C.data[14];a.frustum.update(z,v)}else if(a.xr&&a.xr.session){(g=a._node.parent)&&(d=g.getWorldTransform());
f=a.xr.views;for(var h=0;h<f.length;h++){var k=f[h];g?(k.viewInvOffMat.mul2(d,k.viewInvMat),k.viewOffMat.copy(k.viewInvOffMat).invert()):(k.viewInvOffMat.copy(k.viewInvMat),k.viewOffMat.copy(k.viewMat));n(k.viewMat3,k.viewOffMat);k.projViewOffMat.mul2(k.projMat,k.viewOffMat);k.position[0]=k.viewInvOffMat.data[12];k.position[1]=k.viewInvOffMat.data[13];k.position[2]=k.viewInvOffMat.data[14];a.frustum.update(k.projMat,k.viewOffMat)}}else z=a.getProjectionMatrix(),a.overrideCalculateProjection&&a.calculateProjection(z,
pc.VIEW_CENTER),this.projId.setValue(z.data),this.projSkyboxId.setValue(a.getProjectionMatrixSkybox().data),a.overrideCalculateTransform?a.calculateTransform(x,pc.VIEW_CENTER):(g=a._node.getPosition(),d=a._node.getRotation(),x.setTRS(g,d,pc.Vec3.ONE)),this.viewInvId.setValue(x.data),v.copy(x).invert(),this.viewId.setValue(v.data),n(y,v),this.viewId3.setValue(y.data),A.mul2(z,v),this.viewProjId.setValue(A.data),g=a._node.getPosition(),this.viewPos[0]=g.x,this.viewPos[1]=g.y,this.viewPos[2]=g.z,this.viewPosId.setValue(this.viewPos),
a.frustum.update(z,v);this.nearClipId.setValue(a._nearClip);this.farClipId.setValue(a._farClip);this.cameraParamsId.setValue(a._shaderParams);g=this.device;g.setRenderTarget(b);g.updateBegin();f=a.getRect();d=b?b.width:g.width;b=b?b.height:g.height;h=Math.floor(f.x*d);k=Math.floor(f.y*b);var m=Math.floor(f.width*d);f=Math.floor(f.height*b);g.setViewport(h,k,m,f);g.setScissor(h,k,m,f);c&&g.clear(a._clearOptions);f=a._scissorRect;h=Math.floor(f.x*d);k=Math.floor(f.y*b);m=Math.floor(f.width*d);f=Math.floor(f.height*
b);g.setScissor(h,k,m,f);e&&g.setScissor(1,1,d-2,b-2)},dispatchGlobalLights:function(a){var b;this.mainLight=-1;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);this.ambientId.setValue(this.ambientColor);this.exposureId.setValue(a.exposure);a.skyboxModel&&this.skyboxIntensityId.setValue(a.skyboxIntensity)},_resolveLight:function(a,b){var c="light"+
b;this.lightColorId[b]=a.resolve(c+"_color");this.lightDir[b]=new Float32Array(3);this.lightDirId[b]=a.resolve(c+"_direction");this.lightShadowMapId[b]=a.resolve(c+"_shadowMap");this.lightShadowMatrixId[b]=a.resolve(c+"_shadowMatrix");this.lightShadowParamsId[b]=a.resolve(c+"_shadowParams");this.lightShadowMatrixVsId[b]=a.resolve(c+"_shadowMatrixVS");this.lightShadowParamsVsId[b]=a.resolve(c+"_shadowParamsVS");this.lightDirVs[b]=new Float32Array(3);this.lightDirVsId[b]=a.resolve(c+"_directionVS");
this.lightRadiusId[b]=a.resolve(c+"_radius");this.lightPos[b]=new Float32Array(3);this.lightPosId[b]=a.resolve(c+"_position");this.lightInAngleId[b]=a.resolve(c+"_innerConeAngle");this.lightOutAngleId[b]=a.resolve(c+"_outerConeAngle");this.lightPosVsId[b]=a.resolve(c+"_positionVS");this.lightCookieId[b]=a.resolve(c+"_cookie");this.lightCookieIntId[b]=a.resolve(c+"_cookieIntensity");this.lightCookieMatrixId[b]=a.resolve(c+"_cookieMatrix");this.lightCookieOffsetId[b]=a.resolve(c+"_cookieOffset")},dispatchDirectLights:function(a,
b,c){var e=a.length,f,g=0;this.mainLight=-1;var d=this.device.scope;for(f=0;f<e;f++)if(a[f].mask&c){var h=a[f];var k=h._node.getWorldTransform();this.lightColorId[g]||this._resolveLight(d,g);this.lightColorId[g].setValue(b.gammaCorrection?h._linearFinalColor:h._finalColor);k.getY(h._direction).scale(-1);h._direction.normalize();this.lightDir[g][0]=h._direction.x;this.lightDir[g][1]=h._direction.y;this.lightDir[g][2]=h._direction.z;this.lightDirId[g].setValue(this.lightDir[g]);if(h.castShadows){var m=
h._isPcf&&this.device.webgl2?h._shadowCamera.renderTarget.depthBuffer:h._shadowCamera.renderTarget.colorBuffer;h._isVsm?k=-2E-4:(k=h.shadowBias/h._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(k*=-100));var n=h._isVsm?h.vsmBias/(h._shadowCamera._farClip/7):h._normalOffsetBias;this.lightShadowMapId[g].setValue(m);this.lightShadowMatrixId[g].setValue(h._shadowMatrix.data);m=h._rendererParams;3!==m.length&&(m.length=3);m[0]=h._shadowResolution;m[1]=n;m[2]=k;this.lightShadowParamsId[g].setValue(m);
0>this.mainLight&&(this.lightShadowMatrixVsId[g].setValue(h._shadowMatrix.data),this.lightShadowParamsVsId[g].setValue(m),h._direction.normalize(),this.lightDirVs[g][0]=h._direction.x,this.lightDirVs[g][1]=h._direction.y,this.lightDirVs[g][2]=h._direction.z,this.lightDirVsId[g].setValue(this.lightDirVs[g]),this.mainLight=f)}g++}return g},dispatchPointLight:function(a,b,c,e){var f=c._node.getWorldTransform();this.lightColorId[e]||this._resolveLight(b,e);this.lightRadiusId[e].setValue(c.attenuationEnd);
this.lightColorId[e].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);f.getTranslation(c._position);this.lightPos[e][0]=c._position.x;this.lightPos[e][1]=c._position.y;this.lightPos[e][2]=c._position.z;this.lightPosId[e].setValue(this.lightPos[e]);c.castShadows&&(this.lightShadowMapId[e].setValue(c._shadowCamera.renderTarget.colorBuffer),a=c._rendererParams,4!==a.length&&(a.length=4),a[0]=c._shadowResolution,a[1]=c._normalOffsetBias,a[2]=c.shadowBias,a[3]=1/c.attenuationEnd,this.lightShadowParamsId[e].setValue(a));
c._cookie&&(this.lightCookieId[e].setValue(c._cookie),this.lightShadowMatrixId[e].setValue(f.data),this.lightCookieIntId[e].setValue(c.cookieIntensity))},dispatchSpotLight:function(a,b,c,e){var f=c._node.getWorldTransform();this.lightColorId[e]||this._resolveLight(b,e);this.lightInAngleId[e].setValue(c._innerConeAngleCos);this.lightOutAngleId[e].setValue(c._outerConeAngleCos);this.lightRadiusId[e].setValue(c.attenuationEnd);this.lightColorId[e].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);
f.getTranslation(c._position);this.lightPos[e][0]=c._position.x;this.lightPos[e][1]=c._position.y;this.lightPos[e][2]=c._position.z;this.lightPosId[e].setValue(this.lightPos[e]);f.getY(c._direction).scale(-1);c._direction.normalize();this.lightDir[e][0]=c._direction.x;this.lightDir[e][1]=c._direction.y;this.lightDir[e][2]=c._direction.z;this.lightDirId[e].setValue(this.lightDir[e]);c.castShadows&&(c._isVsm?a=-2E-4:(a=20*c.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(a*=-100)),
b=c._isVsm?c.vsmBias/(c.attenuationEnd/7):c._normalOffsetBias,this.lightShadowMapId[e].setValue(c._isPcf&&this.device.webgl2?c._shadowCamera.renderTarget.depthBuffer:c._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[e].setValue(c._shadowMatrix.data),f=c._rendererParams,4!==f.length&&(f.length=4),f[0]=c._shadowResolution,f[1]=b,f[2]=a,f[3]=1/c.attenuationEnd,this.lightShadowParamsId[e].setValue(f));c._cookie&&(this.lightCookieId[e].setValue(c._cookie),c.castShadows||(a=this.getShadowCamera(this.device,
c),b=a._node,b.setPosition(c._node.getPosition()),b.setRotation(c._node.getRotation()),b.rotateLocal(-90,0,0),a.projection=pc.PROJECTION_PERSPECTIVE,a.aspectRatio=1,a.fov=2*c._outerConeAngle,r.setTRS(b.getPosition(),b.getRotation(),pc.Vec3.ONE).invert(),t.mul2(a.getProjectionMatrix(),r),c._shadowMatrix.mul2(k,t)),this.lightShadowMatrixId[e].setValue(c._shadowMatrix.data),this.lightCookieIntId[e].setValue(c.cookieIntensity),c._cookieTransform&&(c._cookieTransformUniform[0]=c._cookieTransform.x,c._cookieTransformUniform[1]=
c._cookieTransform.y,c._cookieTransformUniform[2]=c._cookieTransform.z,c._cookieTransformUniform[3]=c._cookieTransform.w,this.lightCookieMatrixId[e].setValue(c._cookieTransformUniform),c._cookieOffsetUniform[0]=c._cookieOffset.x,c._cookieOffsetUniform[1]=c._cookieOffset.y,this.lightCookieOffsetId[e].setValue(c._cookieOffsetUniform)))},dispatchLocalLights:function(a,b,c,e,f){var g=a[pc.LIGHTTYPE_POINT];a=a[pc.LIGHTTYPE_SPOT];var d=g.length,h=a.length,k=e,m=this.device.scope;for(e=0;e<d;e++){var n=
g[e];n.mask&c&&!n.isStatic&&(this.dispatchPointLight(b,m,n,k),k++)}g=0;if(f)for(n=f[g];n&&n._type===pc.LIGHTTYPE_POINT;)this.dispatchPointLight(b,m,n,k),k++,g++,n=f[g];for(e=0;e<h;e++)n=a[e],n.mask&c&&!n.isStatic&&(this.dispatchSpotLight(b,m,n,k),k++);if(f)for(n=f[g];n&&n._type===pc.LIGHTTYPE_SPOT;)this.dispatchSpotLight(b,m,n,k),k++,g++,n=f[g]},cull:function(a,b,c){var e=0,f,g=b.length,d=a.cullingMask||4294967295;if(!a.frustumCulling){for(f=0;f<g;f++){var h=b[f];if(h.visible||h.command)h.mask&&0===
(h.mask&d)||(c[e]=h,e++,h.visibleThisFrame=!0)}return e}for(f=0;f<g;f++)if(h=b[f],h.command)c[e]=h,e++,h.visibleThisFrame=!0;else if(h.visible){var k=!0;h.mask&&0===(h.mask&d)||(h.cull&&(k=this._isVisible(a,h)),k&&(c[e]=h,e++,h.visibleThisFrame=!0))}return e},cullLights:function(a,b){var c;for(c=0;c<b.length;c++){var e=b[c];var f=e._type;e.castShadows&&e.enabled&&e.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&f!==pc.LIGHTTYPE_DIRECTIONAL&&(e.getBoundingSphere(N),a.frustum.containsSphere(N)&&(e.visibleThisFrame=
!0))}},updateCpuSkinMatrices:function(a){var b=a.length;if(0!==b){var c,e;for(c=0;c<b;c++)if(e=a[c].skinInstance)e.updateMatrices(a[c].node),e._dirty=!0}},updateGpuSkinMatrices:function(a){var b,c,e=a.length;for(b=0;b<e;b++)a[b].visibleThisFrame&&(c=a[b].skinInstance)&&c._dirty&&(c.updateMatrixPalette(),c._dirty=!1)},updateMorphedBounds:function(a){var b,c,e=a.length;for(b=0;b<e;b++)(c=a[b].morphInstance)&&c._dirty&&c.updateBounds(a[b].mesh)},updateMorphing:function(a){var b,c,e=a.length;for(b=0;b<
e;b++)a[b].visibleThisFrame&&(c=a[b].morphInstance)&&c._dirty&&(c.update(a[b].mesh),c._dirty=!1)},setBaseConstants:function(a,b){a.setCullMode(b.cull);b.opacityMap&&(this.opacityMapId.setValue(b.opacityMap),this.alphaTestId.setValue(b.alphaTest))},setSkinning:function(a,b,c){b.skinInstance&&(this._skinDrawCalls++,a.supportsBoneTextures?(U=b.skinInstance.boneTexture,this.boneTextureId.setValue(U),Y[0]=U.width,Y[1]=U.height,this.boneTextureSizeId.setValue(Y)):this.poseMatrixId.setValue(b.skinInstance.matrixPalette))},
drawInstance:function(a,b,c,e,f){if(K=b.instancingData){if(0<K.count&&(this._instancedDrawCalls++,this._removedByInstancing+=K.count,a.setVertexBuffer(K.vertexBuffer,1,K.offset),a.draw(c.primitive[e],K.count),K.vertexBuffer===pc._autoInstanceBuffer))return b.instancingData=null,K.count-1}else V=b.node.worldTransform,this.modelMatrixId.setValue(V.data),f&&(L=b.node.normalMatrix,b.node._dirtyNormal&&(V.invertTo3x3(L),L.transpose(),b.node._dirtyNormal=!1),this.normalMatrixId.setValue(L.data)),a.draw(c.primitive[e]);
return 0},drawInstance2:function(a,b,c,e){if(K=b.instancingData){if(0<K.count&&(this._instancedDrawCalls++,this._removedByInstancing+=K.count,a.setVertexBuffer(K.vertexBuffer,1,K.offset),a.draw(c.primitive[e],K.count),K.vertexBuffer===pc._autoInstanceBuffer))return b.instancingData=null,K.count-1}else a.draw(c.primitive[e]);return 0},renderShadows:function(a,b){var f=this.device,g,d=1<<pc.SHADER_SHADOW,n;for(g=0;g<a.length;g++){var l=a[g];var w=l._type;if(l.castShadows&&l.enabled&&(l._shadowCamera||
this.getShadowCamera(f,l),l.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&l.visibleThisFrame)){var u=this.getShadowCamera(f,l);var y=u._node;var H=0;var x=1;if(w===pc.LIGHTTYPE_DIRECTIONAL){if(0>l._visibleLength[b])continue;H=l._visibleCameraSettings[b];y.setPosition(H.x,H.y,H.z);u.orthoHeight=H.orthoHeight;u.farClip=H.farClip;H=b}else if(w===pc.LIGHTTYPE_SPOT){var v=y.getPosition();this.viewPos[0]=v.x;this.viewPos[1]=v.y;this.viewPos[2]=v.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(l.attenuationEnd)}else w===
pc.LIGHTTYPE_POINT&&(v=y.getPosition(),this.viewPos[0]=v.x,this.viewPos[1]=v.y,this.viewPos[2]=v.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(l.attenuationEnd),x=6);w!==pc.LIGHTTYPE_POINT&&(r.setTRS(y.getPosition(),y.getRotation(),pc.Vec3.ONE).invert(),t.mul2(u.getProjectionMatrix(),r),l._shadowMatrix.mul2(k,t));f.webgl2?w===pc.LIGHTTYPE_POINT?f.setDepthBias(!1):(f.setDepthBias(!0),f.setDepthBiasValues(-1E3*l.shadowBias,-1E3*l.shadowBias)):f.extStandardDerivatives&&
(w===pc.LIGHTTYPE_POINT?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1E3*l.shadowBias,this.polygonOffset[1]=-1E3*l.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset));l.shadowUpdateMode===pc.SHADOWUPDATE_THISFRAME&&(l.shadowUpdateMode=pc.SHADOWUPDATE_NONE);this._shadowMapUpdates+=x;f.setBlending(!1);f.setDepthWrite(!0);f.setDepthTest(!0);l._isPcf&&f.webgl2&&w!==pc.LIGHTTYPE_POINT?f.setColorWrite(!1,!1,!1,!1):f.setColorWrite(!0,!0,!0,!0);for(H?x=H+1:H=0;H<x;){w===
pc.LIGHTTYPE_POINT&&(y.setRotation(m[H]),u.renderTarget=l._shadowCubeMap[H]);this.setCamera(u,u.renderTarget,!0,w!==pc.LIGHTTYPE_POINT);v=l._visibleList[H];var B=l._visibleLength[H];var A=l._shadowType;var M=A+5*w;for(A=0;A<B;A++){var z=v[A];var C=z.mesh;var R=z.material;this.setBaseConstants(f,R);this.setSkinning(f,z,R);R.dirty&&(R.updateUniforms(),R.dirty=!1);if(R.chunks){var aa=R.parameters;for(n in aa)R=aa[n],R.passFlags&d&&(R.scopeId||(R.scopeId=f.scope.resolve(n)),R.scopeId.setValue(R.data));
this.setCullMode(!0,!1,z);aa=z.parameters;for(n in aa)R=aa[n],R.passFlags&d&&(R.scopeId||(R.scopeId=f.scope.resolve(n)),R.scopeId.setValue(R.data))}R=z._shader[pc.SHADER_SHADOW+M];if(!R){this.updateShader(z,z._shaderDefs,null,pc.SHADER_SHADOW+M);R=z._shader[pc.SHADER_SHADOW+M];aa=z._key;var E=pc.SORTKEY_DEPTH,G=z.material,I=z.skinInstance?10:0,D=0;G.opacityMap&&(G=G.opacityMapChannel)&&(D=h[G]);aa[E]=I+D}f.setShader(R);R=z.renderStyle;f.setVertexBuffer(z.morphInstance&&z.morphInstance._vertexBuffer?
z.morphInstance._vertexBuffer:C.vertexBuffer,0);f.setIndexBuffer(C.indexBuffer[R]);A+=this.drawInstance(f,z,C,R);this._shadowDrawCalls++}H++;w===pc.LIGHTTYPE_DIRECTIONAL&&(l._visibleLength[b]=-1)}l._isVsm&&(w=l._vsmBlurSize,1<w&&(u=u.renderTarget,y=e(f,l._shadowResolution,l._shadowType,1),x=l._shadowType===pc.SHADOW_VSM8,H=l.vsmBlurMode,v=(x?this.blurPackedVsmShader:this.blurVsmShader)[H][w],v||(this.blurVsmWeights[w]=c(w),v=pc.shaderChunks.fullscreenQuadVS,A="#define SAMPLES "+w+"\n",A=x?A+this.blurPackedVsmShaderCode[H]:
A+this.blurVsmShaderCode[H],v=pc.shaderChunks.createShaderFromCode(this.device,v,A,"blurVsm"+H+w+x),x?this.blurPackedVsmShader[H][w]=v:this.blurVsmShader[H][w]=v),q.z=l._shadowResolution-2,q.w=q.z,this.sourceId.setValue(u.colorBuffer),p[0]=1/l._shadowResolution,p[1]=0,this.pixelOffsetId.setValue(p),H===pc.BLUR_GAUSSIAN&&this.weightId.setValue(this.blurVsmWeights[w]),pc.drawQuadWithShader(f,y,v,null,q),this.sourceId.setValue(y.colorBuffer),p[1]=p[0],p[0]=0,this.pixelOffsetId.setValue(p),pc.drawQuadWithShader(f,
u,v,null,q)))}}f.webgl2?f.setDepthBias(!1):f.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(a,b,c,e,f){a.material._scene=this.scene;a.material.updateShader(this.device,this.scene,b,c,e,f);a._shader[e]=a.material.shader},setCullMode:function(a,b,c){var e=c.material,f=pc.CULLFACE_NONE;a&&(a=1,e.cull>pc.CULLFACE_NONE&&e.cull<pc.CULLFACE_FRONTANDBACK&&(c.flipFaces&&(a*=-1),b&&(a*=-1),b=c.node.worldTransform,
b.getX(T),b.getY(ea),b.getZ(J),T.cross(T,ea),0>T.dot(J)&&(a*=-1)),f=0>a?e.cull===pc.CULLFACE_FRONT?pc.CULLFACE_BACK:pc.CULLFACE_FRONT:e.cull);this.device.setCullMode(f)},renderForward:function(a,b,c,e,f,g,d,h){var k=this.device,n=this.scene,m=a.vrDisplay,l=1<<f;h=h?h._lightHash:0;var q,p=null,r,t=.5*k.width;for(q=0;q<c;q++){var u=b[q];if(!g||!u.mask||g&u.mask)if(u.command)u.command();else{var y=u.mesh;var x=u.material;var v=u._shaderDefs;var A=u.mask;this.setSkinning(k,u,x);x&&x===p&&v!==z&&(p=null);
if(u.isStatic||T)p=null;if(x!==p){this._materialSwitches++;x.dirty&&(x.updateUniforms(),x.dirty=!1);if(!u._shader[f]||u._shaderDefs!==v||u._lightHash!==h){if(u.isStatic)this.updateShader(u,v,u._staticLightList,f,e);else{var z=f+"_"+v+"_"+h;u._shader[f]=x.variants[z];u._shader[f]||(this.updateShader(u,v,null,f,e),x.variants[z]=u._shader[f])}u._shaderDefs=v;u._lightHash=h}k.setShader(u._shader[f]);z=x.parameters;for(r in z){var T=z[r];T.passFlags&l&&(T.scopeId||(T.scopeId=k.scope.resolve(r)),T.scopeId.setValue(T.data))}if(!p||
A!==J){var J=this.dispatchDirectLights(e[pc.LIGHTTYPE_DIRECTIONAL],n,A);this.dispatchLocalLights(e,n,A,J,u._staticLightList)}this.alphaTestId.setValue(x.alphaTest);k.setBlending(x.blend);x.blend&&(x.separateAlphaBlend?(k.setBlendFunctionSeparate(x.blendSrc,x.blendDst,x.blendSrcAlpha,x.blendDstAlpha),k.setBlendEquationSeparate(x.blendEquation,x.blendAlphaEquation)):(k.setBlendFunction(x.blendSrc,x.blendDst),k.setBlendEquation(x.blendEquation)));k.setColorWrite(x.redWrite,x.greenWrite,x.blueWrite,x.alphaWrite);
k.setDepthWrite(x.depthWrite);k.setDepthTest(x.depthTest);k.setAlphaToCoverage(x.alphaToCoverage);x.depthBias||x.slopeDepthBias?(k.setDepthBias(!0),k.setDepthBiasValues(x.depthBias,x.slopeDepthBias)):k.setDepthBias(!1)}this.setCullMode(a._cullFaces,a._flipFaces,u);J=u.stencilFront||x.stencilFront;z=u.stencilBack||x.stencilBack;J||z?(k.setStencilTest(!0),J===z?(k.setStencilFunc(J.func,J.ref,J.readMask),k.setStencilOperation(J.fail,J.zfail,J.zpass,J.writeMask)):(J?(k.setStencilFuncFront(J.func,J.ref,
J.readMask),k.setStencilOperationFront(J.fail,J.zfail,J.zpass,J.writeMask)):(k.setStencilFuncFront(pc.FUNC_ALWAYS,0,255),k.setStencilOperationFront(pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,pc.STENCILOP_KEEPP,255)),z?(k.setStencilFuncBack(z.func,z.ref,z.readMask),k.setStencilOperationBack(z.fail,z.zfail,z.zpass,z.writeMask)):(k.setStencilFuncBack(pc.FUNC_ALWAYS,0,255),k.setStencilOperationBack(pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,255)))):k.setStencilTest(!1);z=u.parameters;for(r in z)T=
z[r],T.passFlags&l&&(T.scopeId||(T.scopeId=k.scope.resolve(r)),T.scopeId.setValue(T.data));k.setVertexBuffer(u.morphInstance&&u.morphInstance._vertexBuffer?u.morphInstance._vertexBuffer:y.vertexBuffer,0);J=u.renderStyle;k.setIndexBuffer(y.indexBuffer[J]);d&&d(u,q);if(m&&m.presenting)k.setViewport(0,0,t,k.height),this.projId.setValue(B.data),this.projSkyboxId.setValue(B.data),this.viewInvId.setValue(E.data),this.viewId.setValue(D.data),this.viewId3.setValue(H.data),this.viewProjId.setValue(aa.data),
this.viewPos[0]=I.x,this.viewPos[1]=I.y,this.viewPos[2]=I.z,this.viewPosId.setValue(this.viewPos),q+=this.drawInstance(k,u,y,J,!0),this._forwardDrawCalls++,k.setViewport(t,0,t,k.height),this.projId.setValue(w.data),this.projSkyboxId.setValue(w.data),this.viewInvId.setValue(C.data),this.viewId.setValue(F.data),this.viewId3.setValue(M.data),this.viewProjId.setValue(R.data),this.viewPos[0]=G.x,this.viewPos[1]=G.y,this.viewPos[2]=G.z,this.viewPosId.setValue(this.viewPos),q+=this.drawInstance2(k,u,y,J),
this._forwardDrawCalls++;else if(a.xr&&a.xr.session&&a.xr.views.length)for(p=a.xr.views,T=0;T<p.length;T++){var N=p[T];k.setViewport(N.viewport.x,N.viewport.y,N.viewport.z,N.viewport.w);this.projId.setValue(N.projMat.data);this.projSkyboxId.setValue(N.projMat.data);this.viewId.setValue(N.viewOffMat.data);this.viewInvId.setValue(N.viewInvOffMat.data);this.viewId3.setValue(N.viewMat3.data);this.viewProjId.setValue(N.projViewOffMat.data);this.viewPosId.setValue(N.position);q=0===T?q+this.drawInstance(k,
u,y,J,!0):q+this.drawInstance2(k,u,y,J,!0);this._forwardDrawCalls++}else q+=this.drawInstance(k,u,y,J,!0),this._forwardDrawCalls++;if(q<c-1&&b[q+1].material===x)for(r in z)if(T=x.parameters[r])T.scopeId||(T.scopeId=k.scope.resolve(r)),T.scopeId.setValue(T.data);p=x;z=v;J=A;T=u.isStatic}}k.updateEnd()},setupInstancing:function(a){a.enableAutoInstancing&&!pc._autoInstanceBuffer&&(pc._autoInstanceBuffer=new pc.VertexBuffer(a,pc.VertexFormat.defaultInstancingFormat,a.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),
pc._autoInstanceBufferData=new Float32Array(pc._autoInstanceBuffer.lock()))},revertStaticMeshes:function(a){var b,c=a.length,e=[];for(b=0;b<c;b++){var f=a[b];if(f._staticSource){if(f._staticSource!==g){e.push(f._staticSource);var g=f._staticSource}}else e.push(f)}a.length=e.length;for(b=0;b<e.length;b++)a[b]=e[b]},prepareStaticMeshes:function(a,b){var c,e,f,g,d=this.device,h=a.length,k=[],n,m,l,q=new pc.Vec3,p=new pc.Vec3,r=new pc.BoundingBox,t=new pc.Mat4,w=[],u,y=[],x=[],H=[];for(c=0;c<h;c++){var v=
a[c];if(v.isStatic){var z=v.aabb;H.length=0;for(u=pc.LIGHTTYPE_POINT;u<=pc.LIGHTTYPE_SPOT;u++)for(e=0;e<b.length;e++){var B=b[e];B._type===u&&B.enabled&&B.mask&v.mask&&B.isStatic&&(y[e]||(y[e]=new pc.BoundingBox,B._node.getWorldTransform(),B.getBoundingSphere(N),y[e].center.copy(N.center),y[e].halfExtents.x=N.radius,y[e].halfExtents.y=N.radius,y[e].halfExtents.z=N.radius),y[e].intersects(z)&&H.push(e))}if(0===H.length)k.push(v);else{z=v.mesh;u=z.vertexBuffer;B=z.indexBuffer[v.renderStyle];var A=2===
B.bytesPerIndex?new Uint16Array(B.lock()):new Uint32Array(B.lock());var M=z.primitive[v.renderStyle].count/3;var C=z.primitive[v.renderStyle].base;var R=u.format.elements;var aa=u.format.size/4;z=new Float32Array(u.storage);for(f=0;f<R.length;f++)R[f].name===pc.SEMANTIC_POSITION&&(n=R[f].offset/4);w.length=M;for(f=0;f<M;f++)w[f]=0;R=!1;x.length=6*M;for(f=0;f<M;f++){var E=l=m=Number.MAX_VALUE;var G=-Number.MAX_VALUE;var I=-Number.MAX_VALUE;var D=-Number.MAX_VALUE;for(g=0;3>g;g++){e=A[3*f+g+C];e=e*
aa+n;var F=z[e];var T=z[e+1];e=z[e+2];F<m&&(m=F);T<l&&(l=T);e<E&&(E=e);F>G&&(G=F);T>I&&(I=T);e>D&&(D=e)}e=6*f;x[e]=m;x[e+1]=l;x[e+2]=E;x[e+3]=G;x[e+4]=I;x[e+5]=D}for(F=0;F<H.length;F++)for(e=H[F],t.copy(v.node.worldTransform).invert(),r.setFromTransformedAabb(y[e],t),T=r.getMin(),m=r.getMax(),g=1<<F,f=0;f<M;f++)e=6*f,x[e]<=m.x&&x[e+3]>=T.x&&x[e+1]<=m.y&&x[e+4]>=T.y&&x[e+2]<=m.z&&x[e+5]>=T.z&&(w[f]|=g,R=!0);if(R){R={};for(f=0;f<M;f++){e=3*f+C;var J=w[f];R[J]||(R[J]=[]);g=R[J];g.push(A[e]);g.push(A[e+
1]);g.push(A[e+2])}for(J in R){g=R[J];A=new pc.IndexBuffer(d,B.format,g.length,B.usage);(2===A.bytesPerIndex?new Uint16Array(A.lock()):new Uint32Array(A.lock())).set(g);A.unlock();E=l=m=Number.MAX_VALUE;G=-Number.MAX_VALUE;I=-Number.MAX_VALUE;D=-Number.MAX_VALUE;for(f=0;f<g.length;f++)e=g[f],F=z[e*aa+n],T=z[e*aa+n+1],e=z[e*aa+n+2],F<m&&(m=F),T<l&&(l=T),e<E&&(E=e),F>G&&(G=F),T>I&&(I=T),e>D&&(D=e);q.set(m,l,E);p.set(G,I,D);f=new pc.BoundingBox;f.setMinMax(q,p);M=new pc.Mesh(d);M.vertexBuffer=u;M.indexBuffer[0]=
A;M.primitive[0].type=pc.PRIMITIVE_TRIANGLES;M.primitive[0].base=0;M.primitive[0].count=g.length;M.primitive[0].indexed=!0;M.aabb=f;A=new pc.MeshInstance(v.node,M,v.material);A.isStatic=v.isStatic;A.visible=v.visible;A.layer=v.layer;A.castShadow=v.castShadow;A._receiveShadow=v._receiveShadow;A.cull=v.cull;A.pick=v.pick;A.mask=v.mask;A.parameters=v.parameters;A._shaderDefs=v._shaderDefs;A._staticSource=v;A._staticLightList=v._staticLightList?v._staticLightList:[];for(f=0;f<H.length;f++)g=1<<f,J&g&&
(M=b[H[f]],0>A._staticLightList.indexOf(M)&&A._staticLightList.push(M));A._staticLightList.sort(this.lightCompare);k.push(A)}}else k.push(v)}}else k.push(v)}a.length=k.length;for(c=0;c<k.length;c++)a[c]=k[c]},updateShaders:function(a){var b,c=[];for(b=0;b<a.length;b++){var e=a[b];void 0!==e.material&&-1===c.indexOf(e.material)&&c.push(e.material)}for(b=0;b<c.length;b++)a=c[b],a.updateShader!==pc.Material.prototype.updateShader&&(a.clearVariants(),a.shader=null)},updateLitShaders:function(a){for(var b=
0;b<a.length;b++){var c=a[b];void 0!==c.material&&(c=c.material,c.updateShader===pc.Material.prototype.updateShader||!1===c.useLighting||c.emitter&&!c.emitter.lighting||(c.clearVariants(),c.shader=null))}},beginFrame:function(a){var b=this.device,c=this.scene,e=a._meshInstances;a=a._lights;c.updateSkybox&&(c._updateSkybox(b),c.updateSkybox=!1);c.updateShaders?(this.updateShaders(e),c.updateShaders=!1,c.updateLitShaders=!1,c._shaderVersion++):c.updateLitShaders&&(this.updateLitShaders(e),c.updateLitShaders=
!1,c._shaderVersion++);this.updateCpuSkinMatrices(e);this.updateMorphedBounds(e);c=e.length;for(b=0;b<c;b++)e[b].visibleThisFrame=!1;c=a.length;for(b=0;b<c;b++)a[b].visibleThisFrame=a[b]._type===pc.LIGHTTYPE_DIRECTIONAL},beginLayers:function(a){var b=this.scene,c=a.layerList.length,e,f=this.scene._shaderVersion;for(e=0;e<c;e++)a.layerList[e]._postRenderCounter=0;for(e=0;e<c;e++){var g=a.layerList[e];g._shaderVersion=f;g._preRenderCalledForCameras=0;g._postRenderCalledForCameras=0;var d=a.subLayerList[e];
g._postRenderCounter=d?g._postRenderCounter|2:g._postRenderCounter|1;g._postRenderCounterMax=g._postRenderCounter;for(d=0;d<g.cameras.length;d++)g.instances.visibleOpaque[d]||(g.instances.visibleOpaque[d]=new pc.VisibleInstanceList),g.instances.visibleTransparent[d]||(g.instances.visibleTransparent[d]=new pc.VisibleInstanceList),g.instances.visibleOpaque[d].done=!1,g.instances.visibleTransparent[d].done=!1;g.cameras.length<g.instances.visibleOpaque.length&&g.instances.visibleOpaque.splice(g.cameras.length,
1);g.cameras.length<g.instances.visibleTransparent.length&&g.instances.visibleTransparent.splice(g.cameras.length,1);g._needsStaticPrepare&&g._staticLightHash&&(g._staticPrepareDone&&(this.revertStaticMeshes(g.opaqueMeshInstances),this.revertStaticMeshes(g.transparentMeshInstances)),this.prepareStaticMeshes(g.opaqueMeshInstances,g._lights),this.prepareStaticMeshes(g.transparentMeshInstances,g._lights),a._dirty=!0,b.updateShaders=!0,g._needsStaticPrepare=!1,g._staticPrepareDone=!0)}},cullLocalShadowmap:function(a,
b){var c,e,f,g;var d=a._type;if(d!==pc.LIGHTTYPE_DIRECTIONAL){a.visibleThisFrame=!0;var h=this.getShadowCamera(this.device,a);h.projection=pc.PROJECTION_PERSPECTIVE;h.nearClip=a.attenuationEnd/1E3;h.farClip=a.attenuationEnd;h.aspectRatio=1;if(d===pc.LIGHTTYPE_SPOT){h.fov=2*a._outerConeAngle;var k=1}else h.fov=90,k=6;var n=h._node;var l=a._node;n.setPosition(l.getPosition());d===pc.LIGHTTYPE_SPOT&&(n.setRotation(l.getRotation()),n.rotateLocal(-90,0,0));for(c=0;c<k;c++){d===pc.LIGHTTYPE_POINT&&(n.setRotation(m[c]),
h.renderTarget=a._shadowCubeMap[c]);this.updateCameraFrustum(h);(f=a._visibleList[c])||(f=a._visibleList[c]=[]);l=g=a._visibleLength[c]=0;for(e=b.length;l<e;l++){var q=b[l];var p=!0;q.cull&&(p=this._isVisible(h,q));p&&(f[g]=q,g++,q.visibleThisFrame=!0)}a._visibleLength[c]=g;f.length!==g&&(f.length=g);f.sort(this.depthSortCompare)}}},cullDirectionalShadowmap:function(a,b,c,e){var f=this.device;a.visibleThisFrame=!0;f=this.getShadowCamera(f,a);var g=f._node;var d=a._node;g.setPosition(d.getPosition());
g.setRotation(d.getRotation());g.rotateLocal(-90,0,0);var h=a.shadowDistance||c._farClip;var k=c._nearClip;var n=c._fov*Math.PI/180;var m=c._aspect;var l=c._projection;var q=l===pc.PROJECTION_PERSPECTIVE?Math.tan(n/2)*k:c._orthoHeight;var p=q*m;O[0].x=p;O[0].y=-q;O[0].z=-k;O[1].x=p;O[1].y=q;O[1].z=-k;O[2].x=-p;O[2].y=q;O[2].z=-k;O[3].x=-p;O[3].y=-q;O[3].z=-k;l===pc.PROJECTION_PERSPECTIVE&&(q=Math.tan(n/2)*h,p=q*m);O[4].x=p;O[4].y=-q;O[4].z=-h;O[5].x=p;O[5].y=q;O[5].z=-h;O[6].x=-p;O[6].y=q;O[6].z=
-h;O[7].x=-p;O[7].y=-q;O[7].z=-h;m=Z.sub2(O[0],O[6]).length();m=Math.max(m,Z.sub2(O[4],O[6]).length());r.copy(g.getWorldTransform()).invert();u.copy(r).mul(c._node.getWorldTransform());for(n=0;8>n;n++)u.transformPoint(O[n],O[n]);h=k=c=1E6;p=q=l=-1E6;for(n=0;8>n;n++){var t=O[n];t.x<h&&(h=t.x);t.x>p&&(p=t.x);t.y<k&&(k=t.y);t.y>q&&(q=t.y);t.z<c&&(c=t.z);t.z>l&&(l=t.z)}n=m/a._shadowResolution;h=Math.floor((h-.5*(m-(p-h)))/n)*n;k=Math.floor((k-.5*(m-(q-k)))/n)*n;h=.5*(h+m+h);k=.5*(k+m+k);g.translateLocal(h,
k,1E5);f.projection=pc.PROJECTION_ORTHOGRAPHIC;f.nearClip=0;f.farClip=2E5;f.aspectRatio=1;f.orthoHeight=.5*m;this.updateCameraFrustum(f);q=!0;(l=a._visibleList[e])||(l=a._visibleList[e]=[]);n=m=a._visibleLength[e]=0;for(p=b.length;n<p;n++){var w=b[n];t=!0;w.cull&&(t=this._isVisible(f,w));t&&(l[m]=w,m++,w.visibleThisFrame=!0,t=w.aabb,q?(P.copy(t),q=!1):P.add(t))}a._visibleLength[e]=m;l.length!==m&&(l.length=m);l.sort(this.depthSortCompare);b=P.getMin();n=P.getMax();W[0].x=W[1].x=W[2].x=W[3].x=b.x;
W[1].y=W[3].y=W[7].y=W[5].y=b.y;W[2].z=W[3].z=W[6].z=W[7].z=b.z;W[4].x=W[5].x=W[6].x=W[7].x=n.x;W[0].y=W[2].y=W[4].y=W[6].y=n.y;W[0].z=W[1].z=W[4].z=W[5].z=n.z;n=9999999999;b=-9999999999;for(l=0;8>l;++l)r.transformPoint(W[l],W[l]),m=W[l].z,m<n&&(n=m),m>b&&(b=m);l=b;n>c&&(c=n);g.setPosition(d.getPosition());g.translateLocal(h,k,l+.01);f.farClip=l-c;(d=a._visibleCameraSettings[e])||(d=a._visibleCameraSettings[e]={});a=g.getPosition();d.x=a.x;d.y=a.y;d.z=a.z;d.orthoHeight=f.orthoHeight;d.farClip=f.farClip},
gpuUpdate:function(a){this.updateGpuSkinMatrices(a);this.updateMorphing(a)},clearView:function(a,b,c){a=a.camera;var e=this.device;e.setRenderTarget(b);e.updateBegin();e.setColorWrite(!0,!0,!0,!0);e.setDepthWrite(!0);var f=a.getRect(),g=b?b.width:e.width,d=b?b.height:e.height;b=Math.floor(f.x*g);var h=Math.floor(f.y*d);g=Math.floor(f.width*g);f=Math.floor(f.height*d);e.setViewport(b,h,g,f);e.setScissor(b,h,g,f);e.clear(c?c:a._clearOptions)},setSceneConstants:function(){var a,b=this.device,c=this.scene;
this.dispatchGlobalLights(c);if(c.fog!==pc.FOG_NONE){this.fogColor[0]=c.fogColor.r;this.fogColor[1]=c.fogColor.g;this.fogColor[2]=c.fogColor.b;if(c.gammaCorrection)for(a=0;3>a;a++)this.fogColor[a]=Math.pow(this.fogColor[a],2.2);this.fogColorId.setValue(this.fogColor);c.fog===pc.FOG_LINEAR?(this.fogStartId.setValue(c.fogStart),this.fogEndId.setValue(c.fogEnd)):this.fogDensityId.setValue(c.fogDensity)}this._screenSize[0]=b.width;this._screenSize[1]=b.height;this._screenSize[2]=1/b.width;this._screenSize[3]=
1/b.height;this.screenSizeId.setValue(this._screenSize)},renderComposition:function(a){var b=this.device,c,e=a._renderedRt,f=a._renderedByCam,g=a._renderedLayer,d,h,k,n;this.beginLayers(a);a._update()&pc.COMPUPDATED_LIGHTS&&(this.scene.updateLitShaders=!0);this.beginFrame(a);this.setSceneConstants();var m=0;for(d=0;d<a.layerList.length;d++){var l=a.layerList[d];if(l.enabled&&a.subLayerEnabled[d]){var q=a.subLayerList[d];var p=l.instances;var r=l.cameras;for(h=0;h<r.length;h++)if(c=r[h]){c.frameBegin(l.renderTarget);
var t=q?l.transparentMeshInstances:l.opaqueMeshInstances;var w=n=!1;for(k=0;k<m;k++)if(f[k]===c&&(n=!0,g[k]===l)){w=!0;break}n||(this.updateCameraFrustum(c.camera),this._camerasRendered++);w||this.cullLights(c.camera,l._lights);n&&w||(f[m]=c,g[m]=l,m++);k=q?p.visibleTransparent[h]:p.visibleOpaque[h];if(!k.done){if(l.onPreCull)l.onPreCull(h);k.length=this.cull(c.camera,t,k.list);k.done=!0;if(l.onPostCull)l.onPostCull(h)}c.frameEnd()}}}for(d=0;d<a._lights.length;d++)c=a._lights[d],c.visibleThisFrame&&
c._type!==pc.LIGHTTYPE_DIRECTIONAL&&c.castShadows&&c.enabled&&c.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&(l=a._lightShadowCasters[d],this.cullLocalShadowmap(c,l));q=-1;for(d=0;d<a._lights.length;d++)if(c=a._lights[d],c._type===pc.LIGHTTYPE_DIRECTIONAL&&(q++,c.castShadows&&c.enabled&&c.shadowUpdateMode!==pc.SHADOWUPDATE_NONE))for(l=a._lightShadowCasters[d],r=a._globalLightCameras[q],h=0;h<r.length;h++)this.cullDirectionalShadowmap(c,l,r[h].camera,a._globalLightCameraIds[q][h]);this.gpuUpdate(a._meshInstances);
this.renderShadows(a._sortedLights[pc.LIGHTTYPE_SPOT]);this.renderShadows(a._sortedLights[pc.LIGHTTYPE_POINT]);for(d=m=0;d<a._renderList.length;d++)if(l=a.layerList[a._renderList[d]],l.enabled&&a.subLayerEnabled[a._renderList[d]]){p=l.instances;q=a.subLayerList[a._renderList[d]];r=a._renderListCamera[d];(c=l.cameras[r])&&c.frameBegin(l.renderTarget);if(!q&&l.onPreRenderOpaque)l.onPreRenderOpaque(r);else if(q&&l.onPreRenderTransparent)l.onPreRenderTransparent(r);if(!(l._preRenderCalledForCameras&1<<
r)){if(l.onPreRender)l.onPreRender(r);l._preRenderCalledForCameras|=1<<r;l.overrideClear&&this.clearView(c,l.renderTarget,l._clearOptions)}if(c){h=l.renderTarget;g=!1;for(k=0;k<m;k++)if(e[k]===h&&f[k]===c){g=!0;break}g||(l.overrideClear||this.clearView(c,l.renderTarget),e[m]=h,f[m]=c,m++);this.renderShadows(l._sortedLights[pc.LIGHTTYPE_DIRECTIONAL],r);l._sortVisible(q,c.node,r);k=q?p.visibleTransparent[r]:p.visibleOpaque[r];this.scene._activeCamera=c.camera;this.setCamera(c.camera,l.renderTarget);
this.renderForward(c.camera,k.list,k.length,l._sortedLights,l.shaderPass,l.cullingMask,l.onDrawCall,l);b.setColorWrite(!0,!0,!0,!0);b.setStencilTest(!1);b.setAlphaToCoverage(!1);b.setDepthBias(!1);c.frameEnd()}if(!q&&l.onPostRenderOpaque)l.onPostRenderOpaque(r);else if(q&&l.onPostRenderTransparent)l.onPostRenderTransparent(r);!l.onPostRender||l._postRenderCalledForCameras&1<<r||(l._postRenderCounter&=~(q?2:1),0===l._postRenderCounter&&(l.onPostRender(r),l._postRenderCalledForCameras|=1<<r,l._postRenderCounter=
l._postRenderCounterMax))}}});return{ForwardRenderer:g,gaussWeights:c}}());Object.assign(pc,function(){var d=new pc.Mat4,b=new pc.Vec3,a=new pc.Quat,c=new pc.Quat,e=new pc.Vec3,f=new pc.Vec3,g=new pc.Mat4,n=new pc.Quat,k=function(a){pc.EventHandler.call(this);this.name="string"===typeof a?a:"Untitled";this.tags=new pc.Tags(this);this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=
new pc.Vec3(0,0,0);this._scale=null;this.localTransform=new pc.Mat4;this._dirtyLocal=!1;this._aabbVer=0;this._frozen=!1;this.worldTransform=new pc.Mat4;this._dirtyWorld=!1;this.normalMatrix=new pc.Mat3;this._dirtyNormal=!0;this._parent=this._forward=this._up=this._right=null;this._children=[];this._graphDepth=0;this._enabled=!0;this.scaleCompensation=this._enabledInHierarchy=!1};k.prototype=Object.create(pc.EventHandler.prototype);k.prototype.constructor=k;Object.defineProperty(k.prototype,"right",
{get:function(){this._right||(this._right=new pc.Vec3);return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(k.prototype,"up",{get:function(){this._up||(this._up=new pc.Vec3);return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(k.prototype,"forward",{get:function(){this._forward||(this._forward=new pc.Vec3);return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(k.prototype,"enabled",{get:function(){return this._enabled&&
this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,a))}});Object.defineProperty(k.prototype,"parent",{get:function(){return this._parent}});Object.defineProperty(k.prototype,"path",{get:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""}});Object.defineProperty(k.prototype,"root",{get:function(){var a=this._parent;
if(!a)return this;for(;a._parent;)a=a._parent;return a}});Object.defineProperty(k.prototype,"children",{get:function(){return this._children}});Object.defineProperty(k.prototype,"graphDepth",{get:function(){return this._graphDepth}});Object.assign(k.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);a=a._children;for(var c=0,e=a.length;c<e;c++)a[c]._enabled&&this._notifyHierarchyStateChanged(a[c],b)},_onHierarchyStateChanged:function(a){(this._enabledInHierarchy=a)&&
!this._frozen&&this._unfreezeParentToRoot()},_cloneInternal:function(a){a.name=this.name;for(var b=this.tags._list,c=0;c<b.length;c++)a.tags.add(b[c]);a._labels=Object.assign({},this._labels);a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a._dirtyLocal=
this._dirtyLocal;a.worldTransform.copy(this.worldTransform);a._dirtyWorld=this._dirtyWorld;a._dirtyNormal=this._dirtyNormal;a._aabbVer=this._aabbVer+1;a._enabled=this._enabled;a.scaleCompensation=this.scaleCompensation;a._enabledInHierarchy=!1},clone:function(){var a=new pc.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c=[],e=this._children.length,f;if(a instanceof Function)for((b=a(this))&&c.push(this),f=0;f<e;f++){var g=this._children[f].find(a);g.length&&(c=c.concat(g))}else for(this[a]&&
(f=this[a]instanceof Function?this[a]():this[a],f===b&&c.push(this)),f=0;f<e;++f)g=this._children[f].find(a,b),g.length&&(c=c.concat(g));return c},findOne:function(a,b){var c,e=this._children.length,f;if(a instanceof Function){if(f=a(this))return this;for(c=0;c<e;c++)if(f=this._children[c].findOne(a))return f}else{if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<e;c++)if(f=this._children[c].findOne(a,b),null!==f)return f}return null},findByTag:function(){var a=
this.tags._processArguments(arguments);return this._findByTag(a)},_findByTag:function(a){var b=[],c,e=this._children.length;for(c=0;c<e;c++){this._children[c].tags._has(a)&&b.push(this._children[c]);var f=this._children[c]._findByTag(a);f.length&&(b=b.concat(f))}return b},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){a=a.split("/");for(var b=this,c=null,e=0,
f=a.length;e<f&&b;e++){var g=a[e];c=null;b=b._children;for(var d=0,h=b.length;d<h;d++)if(b[d].name==g){c=b[d];break}b=c}return c},forEach:function(a,b){a.call(b,this);for(var c=this._children,e=0;e<c.length;e++)c[e].forEach(a,b)},isDescendantOf:function(a){for(var b=this._parent;b;){if(b===a)return!0;b=b._parent}return!1},isAncestorOf:function(a){return a.isDescendantOf(this)},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);
return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);return this.localTransform},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());
return this.rotation},getScale:function(){this._scale||(this._scale=new pc.Vec3);return this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;this._parent&&this._parent.getWorldTransform();this._sync();return this.worldTransform},reparent:function(a,b){var c=this._parent;c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(a,b,c){a instanceof pc.Vec3?this.localRotation.setFromEulerAngles(a.x,
a.y,a.z):this.localRotation.setFromEulerAngles(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(a,b,c){a instanceof pc.Vec3?this.localPosition.copy(a):this.localPosition.set(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(a,b,c,e){a instanceof pc.Quat?this.localRotation.copy(a):this.localRotation.set(a,b,c,e);this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(a,b,c){a instanceof pc.Vec3?this.localScale.copy(a):this.localScale.set(a,b,c);
this._dirtyLocal||this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var a=this._parent;a;)a._frozen=!1,a=a._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot();this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1;this._dirtyWorld=!0;for(var a=0;a<this._children.length;a++)this._children[a]._dirtyWorld||this._children[a]._dirtifyWorldInternal()}this._dirtyNormal=
!0;this._aabbVer++},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(c,e,f){c instanceof pc.Vec3?a.copy(c):a.set(c,e,f);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this._dirtyLocal||this._dirtifyLocal()}}(),setRotation:function(){var a=new pc.Quat,b=new pc.Quat;return function(c,e,f,g){c instanceof pc.Quat?a.copy(c):a.set(c,e,f,g);null===this._parent?this.localRotation.copy(a):(c=this._parent.getRotation(),
b.copy(c).invert(),this.localRotation.copy(b).mul(a));this._dirtyLocal||this._dirtifyLocal()}}(),setEulerAngles:function(){var a=new pc.Quat;return function(b,c,e){b instanceof pc.Vec3?this.localRotation.setFromEulerAngles(b.x,b.y,b.z):this.localRotation.setFromEulerAngles(b,c,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this._dirtyLocal||this._dirtifyLocal()}}(),addChild:function(a){if(null!==a._parent)throw Error("GraphNode is already parented");
this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),e=a._parent;e&&e.removeChild(a);a.setPosition(g.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(n.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=
this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a._updateGraphDepth();a._dirtifyWorld();this._frozen&&a._unfreezeParentToRoot();a.fire&&a.fire("insert",this);this.fire&&this.fire("childinsert",a)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var a=0,b=this._children.length;a<b;a++)this._children[a]._updateGraphDepth()},removeChild:function(a){var b,c=this._children.length;for(b=
0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);a._parent=null;a.fire&&a.fire("remove",this);this.fire&&this.fire("childremove",a);break}},_sync:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var g=this._parent,k=this.localScale,n=g;if(n){for(;n&&n.scaleCompensation;)n=n._parent;
if(n&&(n=n._parent)){var p=n.worldTransform.getScale();e.mul2(p,this.localScale);k=e}}c.setFromMat4(g.worldTransform);a.mul2(c,this.localRotation);n=g.worldTransform;g.scaleCompensation&&(f.mul2(p,g.getLocalScale()),d.setTRS(g.worldTransform.getTranslation(b),c,f),n=d);n.transformPoint(this.localPosition,b);this.worldTransform.setTRS(b,a,k)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=
!0;(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var a=this._children,b=0,c=a.length;b<c;b++)a[b].syncHierarchy()}},lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,e=new pc.Quat;return function(f,g,d,k,h,n){if(f instanceof pc.Vec3)b.copy(f),g instanceof pc.Vec3?c.copy(g):c.copy(pc.Vec3.UP);else{if(void 0===d)return;b.set(f,g,d);void 0!==k?c.set(k,h,n):c.copy(pc.Vec3.UP)}a.setLookAt(this.getPosition(),b,c);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var a=
new pc.Vec3;return function(b,c,e){b instanceof pc.Vec3?a.copy(b):a.set(b,c,e);a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(b,c,e){b instanceof pc.Vec3?a.copy(b):a.set(b,c,e);this.localRotation.transformVector(a,a);this.localPosition.add(a);this._dirtyLocal||this._dirtifyLocal()}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(c,e,f){c instanceof pc.Vec3?a.setFromEulerAngles(c.x,c.y,c.z):a.setFromEulerAngles(c,e,
f);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this._dirtyLocal||this._dirtifyLocal()}}(),rotateLocal:function(){var a=new pc.Quat;return function(b,c,e){b instanceof pc.Vec3?a.setFromEulerAngles(b.x,b.y,b.z):a.setFromEulerAngles(b,c,e);this.localRotation.mul(a);this._dirtyLocal||this._dirtifyLocal()}}()});return{GraphNode:k}}());Object.assign(pc,function(){var d=new pc.Vec3,b=new pc.Vec3,a=new pc.Vec3,c=new pc.Mat4,e=function(){this._projection=pc.PROJECTION_PERSPECTIVE;this._nearClip=.1;this._farClip=1E4;this._shaderParams=new Float32Array(4);this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._aspectRatioMode=pc.ASPECT_AUTO;this.frustumCulling=this._horizontalFov=!1;this.cullingMask=4294967295;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._projMatSkybox=new pc.Mat4;this._viewMatDirty=
!0;this._viewMat=new pc.Mat4;this._viewProjMatDirty=!0;this._viewProjMat=new pc.Mat4;this.vrDisplay=null;this._rect={x:0,y:0,width:1,height:1};this._scissorRect={x:0,y:0,width:1,height:1};this.frustum=new pc.Frustum(this._projMat,this._viewMat);this._depthTarget=this.renderTarget=null;this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH|pc.CLEARFLAG_STENCIL};this.calculateTransform=this._node=null;this.overrideCalculateTransform=!1;this.calculateProjection=
null;this.overrideCalculateProjection=!1;this._cullFaces=!0;this._flipFaces=!1;this._component=null};Object.assign(e.prototype,{clone:function(){var a=new pc.Camera;a.projection=this._projection;a.nearClip=this._nearClip;a.farClip=this._farClip;a._shaderParams=this._shaderParams.slice();a.fov=this._fov;a.aspectRatio=this._aspect;a._aspectRatioMode=this._aspectRatioMode;a.renderTarget=this.renderTarget;a.setClearOptions(this.getClearOptions());a.frustumCulling=this.frustumCulling;a.cullingMask=this.cullingMask;
return a},worldToScreen:function(a,b,c,e){void 0===e&&(e=new pc.Vec3);if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var f=this.getProjectionMatrix(),g=this.getViewMatrix();this._viewProjMat.mul2(f,g);this._viewProjMatDirty=!1}this._viewProjMat.transformPoint(a,e);f=this._viewProjMat.data;a=a.x*f[3]+a.y*f[7]+a.z*f[11]+1*f[15];e.x=.5*(e.x/a+1)*b;e.y=.5*(1-e.y/a)*c;return e},screenToWorld:function(e,g,n,k,h,m){void 0===m&&(m=new pc.Vec3);if(this._projMatDirty||this._viewMatDirty||
this._viewProjMatDirty){var f=this.getProjectionMatrix(),p=this.getViewMatrix();this._viewProjMat.mul2(f,p);this._viewProjMatDirty=!1}c.copy(this._viewProjMat).invert();this._projection===pc.PROJECTION_PERSPECTIVE?(b.set(e/k*2-1,(h-g)/h*2-1,1),c.transformPoint(b,a),a.scale(1/(b.x*c.data[3]+b.y*c.data[7]+b.z*c.data[11]+c.data[15])),e=n/this._farClip,m.lerp(this._node.getPosition(),a,e)):(d.set(e/k,(h-g)/h,n/(this._farClip-this._nearClip)),d.scale(2),d.sub(pc.Vec3.ONE),c.transformPoint(d,m));return m},
getClearOptions:function(){return this._clearOptions},_evaluateProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip);this._projMatSkybox.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip)}a=
this._nearClip;b=this._farClip;this._shaderParams[0]=1/b;this._shaderParams[1]=b;this._shaderParams[2]=(1-b/a)/2;this._shaderParams[3]=(1+b/a)/2;this._projMatDirty=!1}},getProjectionMatrix:function(){this._evaluateProjectionMatrix();return this._projMat},getProjectionMatrixSkybox:function(){this._evaluateProjectionMatrix();return this._projMatSkybox},getViewMatrix:function(){if(this._viewMatDirty){var a=this._node.getWorldTransform();this._viewMat.copy(a).invert();this._viewMatDirty=!1}return this._viewMat},
getRect:function(){return this._rect},setClearOptions:function(a){this._clearOptions.color[0]=a.color[0];this._clearOptions.color[1]=a.color[1];this._clearOptions.color[2]=a.color[2];this._clearOptions.color[3]=a.color[3];this._clearOptions.depth=a.depth;this._clearOptions.stencil=a.stencil;this._clearOptions.flags=a.flags},setRect:function(a,b,c,e){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=e},setScissorRect:function(a,b,c,e){this._scissorRect.x=a;this._scissorRect.y=b;this._scissorRect.width=
c;this._scissorRect.height=e},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}});Object.defineProperty(e.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(a){this._aspect!==a&&(this._aspect=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"projection",{get:function(){return this._projection},set:function(a){this._projection!==a&&(this._projection=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,
"nearClip",{get:function(){return this._nearClip},set:function(a){this._nearClip!==a&&(this._nearClip=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"farClip",{get:function(){return this._farClip},set:function(a){this._farClip!==a&&(this._farClip=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!==a&&(this._fov=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"horizontalFov",{get:function(){return this._horizontalFov},
set:function(a){this._horizontalFov!==a&&(this._horizontalFov=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(a){this._orthoHeight!==a&&(this._orthoHeight=a,this._projMatDirty=!0)}});Object.defineProperty(e.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(a){this._clearOptions.color[0]=a[0];this._clearOptions.color[1]=a[1];this._clearOptions.color[2]=a[2];this._clearOptions.color[3]=
a[3]}});Object.defineProperty(e.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(a){this._clearOptions.depth=a}});Object.defineProperty(e.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(a){this._clearOptions.stencil=a}});Object.defineProperty(e.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(a){this._clearOptions.flags=a}});return{Camera:e}}());Object.assign(pc,function(){var d=new pc.Vec3,b=new pc.Vec3,a=new pc.Vec3,c={r:0,g:1,b:2,a:3},e=function(){this._type=pc.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(.8,.8,.8);this._intensity=1;this.enabled=this._castShadows=!1;this.mask=1;this.isStatic=!1;this.key=0;this.bakeDir=!0;this.attenuationEnd=this.attenuationStart=10;this._falloffMode=0;this._shadowType=pc.SHADOW_PCF3;this._vsmBlurSize=11;this.vsmBlurMode=pc.BLUR_GAUSSIAN;this.vsmBias=.0025;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=
!0;this._cookieChannel="rgb";this._cookieTransform=null;this._cookieTransformUniform=new Float32Array(4);this._cookieOffset=null;this._cookieOffsetUniform=new Float32Array(2);this._cookieOffsetSet=this._cookieTransformSet=!1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new Float32Array([.8,.8,.8]);var a=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([a,a,a]);this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=
Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this._node=this._scene=null;this._rendererParams=[];this._isVsm=!1;this._isPcf=!0;this._isCachedShadowMap=this._cacheShadowMap=!1;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=
[]};Object.assign(e.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var a=new pc.Light;a.type=this._type;a.setColor(this._color);a.intensity=this._intensity;a.castShadows=this.castShadows;a.enabled=this.enabled;a.attenuationStart=this.attenuationStart;a.attenuationEnd=this.attenuationEnd;a.falloffMode=this._falloffMode;a.shadowType=this._shadowType;a.vsmBlurSize=this._vsmBlurSize;a.vsmBlurMode=this.vsmBlurMode;a.vsmBias=this.vsmBias;a.shadowUpdateMode=this.shadowUpdateMode;
a.mask=this.mask;a.innerConeAngle=this._innerConeAngle;a.outerConeAngle=this._outerConeAngle;a.shadowBias=this.shadowBias;a.normalOffsetBias=this._normalOffsetBias;a.shadowResolution=this._shadowResolution;a.shadowDistance=this.shadowDistance;return a},getColor:function(){return this._color},getBoundingSphere:function(c){if(this._type===pc.LIGHTTYPE_SPOT){var e=this.attenuationEnd,f=this._outerConeAngle,k=Math.cos(f*pc.math.DEG_TO_RAD),h=this._node;d.copy(h.up);d.scale(.5*-e*k);d.add(h.getPosition());
c.center=d;b.copy(h.up);b.scale(-e);a.copy(h.right);a.scale(Math.sin(f*pc.math.DEG_TO_RAD)*e);b.add(a);c.radius=.5*b.length()}else this._type===pc.LIGHTTYPE_POINT&&(c.center=this._node.getPosition(),c.radius=this.attenuationEnd)},getBoundingBox:function(a){if(this._type===pc.LIGHTTYPE_SPOT){var b=this.attenuationEnd,c=this._node,e=Math.abs(Math.sin(this._outerConeAngle*pc.math.DEG_TO_RAD)*b);a.center.set(0,.5*-b,0);a.halfExtents.set(e,.5*b,e);a.setFromTransformedAabb(a,c.getWorldTransform())}else this._type===
pc.LIGHTTYPE_POINT&&(a.center.copy(this._node.getPosition()),a.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var a=this._color,b=a.r,c=a.g;a=a.b;var e=this._intensity,d=this._finalColor,m=this._linearFinalColor;d[0]=b*e;d[1]=c*e;d[2]=a*e;1<=e?(m[0]=Math.pow(b,2.2)*e,m[1]=Math.pow(c,2.2)*e,m[2]=Math.pow(a,2.2)*e):(m[0]=Math.pow(d[0],2.2),m[1]=Math.pow(d[1],2.2),m[2]=Math.pow(d[2],2.2))},setColor:function(){if(1===arguments.length){var a=
arguments[0].r;var b=arguments[0].g;var c=arguments[0].b}else 3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var a=this._shadowCamera.renderTarget,b;if(a)if(a.length)for(b=0;b<a.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else a.colorBuffer&&a.colorBuffer.destroy(),a.depthBuffer&&a.depthBuffer.destroy(),a.destroy()}this._shadowCubeMap=
this._shadowCamera=this._shadowCamera.renderTarget=null;this.shadowUpdateMode===pc.SHADOWUPDATE_NONE&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)},updateKey:function(){var a=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|c[this._cookieChannel.charAt(0)]<<
18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(a|=c[this._cookieChannel.charAt(1)]<<16,a|=c[this._cookieChannel.charAt(2)]<<14);a!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0);this.key=a}});Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,this._destroyShadowMap(),this.updateKey(),a=this._shadowType,this._shadowType=null,this.shadowType=a)}});Object.defineProperty(e.prototype,"shadowType",
{get:function(){return this._shadowType},set:function(a){if(this._shadowType!==a){var b=pc.Application.getApplication().graphicsDevice;this._type===pc.LIGHTTYPE_POINT&&(a=pc.SHADOW_PCF3);a!==pc.SHADOW_PCF5||b.webgl2||(a=pc.SHADOW_PCF3);a!==pc.SHADOW_VSM32||b.textureFloatRenderable||(a=pc.SHADOW_VSM16);a!==pc.SHADOW_VSM16||b.textureHalfFloatRenderable||(a=pc.SHADOW_VSM8);this._isVsm=a>=pc.SHADOW_VSM8&&a<=pc.SHADOW_VSM32;this._isPcf=a===pc.SHADOW_PCF5||a===pc.SHADOW_PCF3;this._shadowType=a;this._destroyShadowMap();
this.updateKey()}}});Object.defineProperty(e.prototype,"castShadows",{get:function(){return this._castShadows&&this.mask!==pc.MASK_LIGHTMAP&&0!==this.mask},set:function(a){this._castShadows!==a&&(this._castShadows=a,this.updateKey())}});Object.defineProperty(e.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(a){if(this._shadowResolution!==a){var b=pc.Application.getApplication().graphicsDevice;this._shadowResolution=a=this._type===pc.LIGHTTYPE_POINT?Math.min(a,
b.maxCubeMapSize):Math.min(a,b.maxTextureSize)}}});Object.defineProperty(e.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(a){this._vsmBlurSize!==a&&(0===a%2&&a++,this._vsmBlurSize=a)}});Object.defineProperty(e.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(a){this._normalOffsetBias!==a&&((!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)&&this.updateKey(),this._normalOffsetBias=a)}});Object.defineProperty(e.prototype,
"falloffMode",{get:function(){return this._falloffMode},set:function(a){this._falloffMode!==a&&(this._falloffMode=a,this.updateKey())}});Object.defineProperty(e.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(a){this._innerConeAngle!==a&&(this._innerConeAngle=a,this._innerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(e.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(a){this._outerConeAngle!==a&&(this._outerConeAngle=
a,this._outerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(e.prototype,"intensity",{get:function(){return this._intensity},set:function(a){this._intensity!==a&&(this._intensity=a,this._updateFinalColor())}});Object.defineProperty(e.prototype,"cookie",{get:function(){return this._cookie},set:function(a){this._cookie!==a&&(this._cookie=a,this.updateKey())}});Object.defineProperty(e.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(a){this._cookieFalloff!==
a&&(this._cookieFalloff=a,this.updateKey())}});Object.defineProperty(e.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(a){if(this._cookieChannel!==a){if(3>a.length)for(var b=a.charAt(a.length-1),c=3-a.length,e=0;e<c;e++)a+=b;this._cookieChannel=a;this.updateKey()}}});Object.defineProperty(e.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(a){this._cookieTransform!==a&&(this._cookieTransform=a,this._cookieTransformSet=!!a,a&&
!this._cookieOffset&&(this.cookieOffset=new pc.Vec2,this._cookieOffsetSet=!1),this.updateKey())}});Object.defineProperty(e.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(a){this._cookieOffset!==a&&((this._cookieTransformSet||a)&&!a&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=a,this._cookieOffsetSet=!!a,a&&!this._cookieTransform&&(this.cookieTransform=new pc.Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}});return{Light:e}}());Object.assign(pc,function(){var d=0,b=function(){this.name="Untitled";this.id=d++;this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=this.alphaToCoverage=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.separateAlphaBlend=!1;this.blendSrcAlpha=pc.BLENDMODE_ONE;this.blendDstAlpha=pc.BLENDMODE_ZERO;this.blendAlphaEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.depthWrite=this.depthTest=!0;this.stencilBack=
this.stencilFront=null;this.slopeDepthBias=this.depthBias=0;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=!1;this.dirty=!0};Object.defineProperty(b.prototype,"shader",{get:function(){return this._shader},set:function(a){this._shader=a}});Object.defineProperty(b.prototype,"blendType",{get:function(){if(!this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===
pc.BLENDEQUATION_ADD)return pc.BLEND_NONE;if(!this.blend||this.blendSrc!==pc.BLENDMODE_SRC_ALPHA||this.blendDst!==pc.BLENDMODE_ONE_MINUS_SRC_ALPHA||this.blendEquation!==pc.BLENDEQUATION_ADD){if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_ADDITIVE;if(this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_ADDITIVEALPHA;
if(this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_SRC_COLOR&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_MULTIPLICATIVE2X;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE_MINUS_DST_COLOR&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_SCREEN;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_MIN)return pc.BLEND_MIN;if(this.blend&&this.blendSrc===
pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_MAX)return pc.BLEND_MAX;if(this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_MULTIPLICATIVE;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_PREMULTIPLIED}return pc.BLEND_NORMAL},set:function(a){var b=this.blend;
switch(a){case pc.BLEND_NONE:this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVE:this.blend=
!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVEALPHA:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE2X:this.blend=!0;this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_SRC_COLOR;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_SCREEN:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE_MINUS_DST_COLOR;this.blendDst=
pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE:this.blend=!0;this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MIN:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_MIN;break;case pc.BLEND_MAX:this.blend=!0,this.blendDst=this.blendSrc=pc.BLENDMODE_ONE,this.blendEquation=pc.BLENDEQUATION_MAX}b!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=
!0:this._dirtyBlend=!0);this._updateMeshInstanceKeys()}});b.prototype._cloneInternal=function(a){a.name=this.name;a.shader=this.shader;a.alphaTest=this.alphaTest;a.alphaToCoverage=this.alphaToCoverage;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.separateAlphaBlend=this.separateAlphaBlend;a.blendSrcAlpha=this.blendSrcAlpha;a.blendDstAlpha=this.blendDstAlpha;a.blendAlphaEquation=this.blendAlphaEquation;a.cull=this.cull;a.depthTest=this.depthTest;
a.depthWrite=this.depthWrite;a.depthBias=this.depthBias;a.slopeDepthBias=this.slopeDepthBias;this.stencilFront&&(a.stencilFront=this.stencilFront.clone());this.stencilBack&&(a.stencilBack=this.stencilFront===this.stencilBack?a.stencilFront:this.stencilBack.clone());a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite};b.prototype.clone=function(){var a=new pc.Material;this._cloneInternal(a);return a};b.prototype._updateMeshInstanceKeys=function(){var a,
b=this.meshInstances;for(a=0;a<b.length;a++)b[a].updateKey()};b.prototype.updateUniforms=function(){};b.prototype.updateShader=function(a,b,e){};b.prototype.update=function(){this.dirty=!0};b.prototype.clearParameters=function(){this.parameters={}};b.prototype.getParameters=function(){return this.parameters};b.prototype.clearVariants=function(){this.variants={};for(var a,b=0;b<this.meshInstances.length;b++){var e=this.meshInstances[b];for(a=0;a<e._shader.length;a++)e._shader[a]=null}};b.prototype.getParameter=
function(a){return this.parameters[a]};b.prototype.setParameter=function(a,b,e){void 0===e&&(e=-524285);if(void 0===b&&"object"===typeof a){b=a;if(b.length){for(a=0;a<b.length;a++)this.setParameter(b[a]);return}a=b.name;b=b.value}var c=this.parameters[a];c?(c.data=b,c.passFlags=e):this.parameters[a]={scopeId:null,data:b,passFlags:e}};b.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};b.prototype.setParameters=function(){for(var a in this.parameters){var b=this.parameters[a];
b.scopeId.setValue(b.data)}};b.prototype.destroy=function(){this.variants={};this.shader=null;for(var a,b,e=0;e<this.meshInstances.length;e++){a=this.meshInstances[e];for(b=0;b<a._shader.length;b++)a._shader[b]=null;a._material=null;b=pc.getDefaultMaterial();this!==b&&(a.material=b)}};return{Material:b}}());Object.assign(pc,function(){var d=function(){pc.Material.call(this);this.color=new pc.Color(1,1,1,1);this.colorUniform=new Float32Array(4);this.colorMap=null;this.vertexColors=!1};d.prototype=Object.create(pc.Material.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{clone:function(){var b=new pc.BasicMaterial;pc.Material.prototype._cloneInternal.call(this,b);b.color.copy(this.color);b.colorMap=this.colorMap;b.vertexColors=this.vertexColors;return b},updateUniforms:function(){this.clearParameters();
this.colorUniform[0]=this.color.r;this.colorUniform[1]=this.color.g;this.colorUniform[2]=this.color.b;this.colorUniform[3]=this.color.a;this.setParameter("uColor",this.colorUniform);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(b,a,c,e,f,g){a={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap,pass:f};this.shader=b.getProgramLibrary().getProgram("basic",a)}});return{BasicMaterial:d}}());Object.assign(pc,function(){var d=function(){pc.Material.call(this)};d.prototype=Object.create(pc.Material.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{clone:function(){var b=new pc.DepthMaterial;pc.Material.prototype._cloneInternal.call(this,b);return b},updateShader:function(b){var a={skin:!!this.meshInstances[0].skinInstance};this.shader=b.getProgramLibrary().getProgram("depth",a)}});return{DepthMaterial:d}}());Object.assign(pc,function(){var d=function(){pc.Material.call(this);this._assetReferences={};this._validator=null;this.shaderOptBuilder=new pc.StandardMaterialOptionsBuilder;this.reset()};d.prototype=Object.create(pc.Material.prototype);d.prototype.constructor=d;var b=[],a=[],c=[],e=[],f={},g=function(a,e,g,k,h,n,m){var l="_"+e+"Map",q=l+"Tiling",p=l+"Offset",r=l.substring(1)+"Transform",t=r+"Uniform",u=l+"Uv",y=l+"Channel",w="_"+e+"VertexColor",x="_"+e+"VertexColorChannel",v="_"+e+"Mode";a[l]=null;
a[q]=new pc.Vec2(1,1);a[p]=new pc.Vec2(0,0);a[r]=null;a[t]=null;a[u]=g;0<k&&(g=h?h:1<k?"rgb":"g",a[y]=g,n&&(a[x]=g));n&&(a[w]=!1);m&&(a[v]=pc.DETAILMODE_MUL);pc._matTex2D||(pc._matTex2D=[]);pc._matTex2D[e]=k;Object.defineProperty(d.prototype,l.substring(1),{get:function(){return this[l]},set:function(a){var b=this[l];!!b^!!a&&(this.dirtyShader=!0);b&&a&&(b.rgbm!==a.rgbm||b.fixCubemapSeams!==a.fixCubemapSeams||b.format!==a.format)&&(this.dirtyShader=!0);this[l]=a}});a=q.substring(1);e=p.substring(1);
Object.defineProperty(d.prototype,a,{get:function(){return this[q]},set:function(a){this.dirtyShader=!0;this[q]=a}});f[a]=function(a,b,c){a=a._updateMapTransform(c?a[r]:null,b,a[p]);return{name:"texture_"+r,value:a.data}};Object.defineProperty(d.prototype,e,{get:function(){return this[p]},set:function(a){this.dirtyShader=!0;this[p]=a}});f[e]=function(a,b,c){a=a._updateMapTransform(c?a[r]:null,a[q],b);return{name:"texture_"+r,value:a.data}};Object.defineProperty(d.prototype,u.substring(1),{get:function(){return this[u]},
set:function(a){this[u]!==a&&(this.dirtyShader=!0);this[u]=a}});Object.defineProperty(d.prototype,y.substring(1),{get:function(){return this[y]},set:function(a){this[y]!==a&&(this.dirtyShader=!0);this[y]=a}});n&&(Object.defineProperty(d.prototype,w.substring(1),{get:function(){return this[w]},set:function(a){this.dirtyShader=!0;this[w]=a}}),Object.defineProperty(d.prototype,x.substring(1),{get:function(){return this[x]},set:function(a){this[x]!==a&&(this.dirtyShader=!0);this[x]=a}}));m&&Object.defineProperty(d.prototype,
v.substring(1),{get:function(){return this[v]},set:function(a){this.dirtyShader=!0;this[v]=a}});b.push(l.substring(1));b.push(q.substring(1));b.push(p.substring(1));b.push(u.substring(1));b.push(y.substring(1));n&&(b.push(w.substring(1)),b.push(x.substring(1)));m&&b.push(v.substring(1));c.push(r)},n=[],k=function(a,c,g,k){var h="_"+c,m=c+"Uniform",l=c+"Intensity",q="_"+l;a[h]=g;a[m]=new Float32Array(3);Object.defineProperty(d.prototype,c,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[h]},
set:function(a){var b=this[h];(0===b.r&&0===b.g&&0===b.b||1===b.r&&1===b.g&&1===b.b)^(0===a.r&&0===a.g&&0===a.b||1===a.r&&1===a.g&&1===a.b)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[h]=a}});b.push(c);e.push(m);n.push(c);f[c]=function(a,b,e){e=e?a[m]:new Float32Array(3);var f=!1;a.useGammaTonemap&&(f=(a._scene||pc.Application.getApplication().scene).gammaCorrection);for(var g=0;3>g;g++)e[g]=f?Math.pow(b.data[g],2.2):b.data[g],k&&(e[g]*=a[q]);return{name:"material_"+c,value:e}};k&&(a[q]=1,Object.defineProperty(d.prototype,
l,{get:function(){return this[q]},set:function(a){var b=this[q];(0===b||1===b)^(0===a||1===a)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[q]=a}}),b.push(l),f[l]=function(a,b,e){b=e?a[m]:new Float32Array(3);e=!1;a.useGammaTonemap&&(e=(a._scene||pc.Application.getApplication().scene).gammaCorrection);for(var f=0;3>f;f++)b[f]=e?Math.pow(a[h].data[f],2.2):a[h].data[f],b[f]*=a[q];return{name:"material_"+c,value:b}})},h=function(a,c,e,g){var k="_"+c;a[k]=e;Object.defineProperty(d.prototype,c,{get:function(){return this[k]},
set:function(a){var b=this[k];b!==a&&(this[k]=a,0===b||1===b||0===a||1===a)&&(this.dirtyShader=!0)}});b.push(c);f[c]=void 0!==g?g:function(a,b,e){return{name:"material_"+c,value:b}}},m=function(a,c,e){var g="_"+c;a[g]=null;Object.defineProperty(d.prototype,c,{get:function(){return this[g]},set:function(a){!!this[g]^!!a&&(this.dirtyShader=!0);this[g]=a}});b.push(c);f[c]=e},l=function(a,b,c){Object.defineProperty(d.prototype,c,{get:function(){return this[b]},set:function(a){this[b]=a}})},p=function(a){Object.defineProperty(d.prototype,
"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});b.push("chunks")},q=function(a,c,e){var f="_"+c;a[f]=e;Object.defineProperty(d.prototype,c,{get:function(){return this[f]},set:function(a){this[f]!==a&&(this.dirtyShader=!0);this[f]=a}});b.push(c)},r=function(){};r.prototype.copy=function(a){for(var b in a)a.hasOwnProperty(b)&&"copy"!==b&&(this[b]=a[b])};Object.assign(d.prototype,{reset:function(){var f;for(f=0;f<b.length;f++){var g=
a[f];this[b[f]]=g?g.clone?g.clone():g:g}for(f=0;f<c.length;f++)this[c[f]]=null;for(f=0;f<e.length;f++)this[e[f]]=new Float32Array(3);this._chunks=new r;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var a=new pc.StandardMaterial;pc.Material.prototype._cloneInternal.call(this,a);for(var c,e=0;e<b.length;e++)c=b[e],void 0!==this[c]&&(this[c]&&this[c].copy?a[c]?a[c].copy(this[c]):a[c]=this[c].clone():a[c]=this[c]);return a},_updateMapTransform:function(a,
b,c){a=a||new pc.Vec4;a.set(b.x,b.y,c.x,c.y);return 1===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_setParameter:function(a,b){this.parameters[a]||this._propsSet.push(a);this.setParameter(a,b)},_clearParameters:function(){for(var a=this._propsSet,b=0;b<a.length;b++)delete this.parameters[a[b]];this._propsSet=[]},_updateMap:function(a){a+="Map";if(this[a]){this._setParameter("texture_"+a,this[a]);var b=a+"Transform",c=a+"TransformUniform";this[b]||(this[c]=new Float32Array(4));this[b]=this._updateMapTransform(this[b],
this[a+"Tiling"],this[a+"Offset"]);this[b]&&(this[c][0]=this[b].x,this[c][1]=this[b].y,this[c][2]=this[b].z,this[c][3]=this[b].w,this._setParameter("texture_"+b,this[c]))}},getUniform:function(a,b,c){return(a=f[a])?a(this,b,c):null},updateUniforms:function(){this._clearParameters();this._setParameter("material_ambient",this.ambientUniform);this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?((!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",
this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform);0<this.clearCoat&&(this._setParameter("material_clearCoatSpecularity",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat));var a=this.getUniform("shininess",this.shininess,!0);this._setParameter(a.name,
a.value);this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform);this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity);0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex));this._setParameter("material_opacity",this.opacity);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);
this.cubeMapProjection===pc.CUBEPROJ_BOX&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0));for(var b in pc._matTex2D)this._updateMap(b);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness);this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness);this.heightMap&&(a=this.getUniform("heightMapFactor",this.heightMapFactor,
!0),this._setParameter(a.name,a.value));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]);this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",
this._scene._skyboxPrefiltered[1]);this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]);this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);
this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]);this.sphereMap&&this._setParameter("texture_sphereMap",
this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()},_processColor:function(){var a;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var b=!1;this.useGammaTonemap&&(b=this._scene.gammaCorrection);for(a=0;a<n.length;a++){var c=this["_"+n[a]],e=this[n[a]+"Uniform"];b?(e[0]=Math.pow(c.r,2.2),e[1]=Math.pow(c.g,
2.2),e[2]=Math.pow(c.b,2.2)):(e[0]=c.r,e[1]=c.g,e[2]=c.b)}for(a=0;3>a;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(a,b,c,e,f,g){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var d=a.useTexCubeLod,k=!a.extTextureLod;if(this.useSkybox){var h=b._skyboxPrefiltered[0];var n=b._skyboxPrefiltered[1];var m=b._skyboxPrefiltered[2];var l=b._skyboxPrefiltered[3];var q=b._skyboxPrefiltered[4];var p=b._skyboxPrefiltered[5]}h=
this.prefilteredCubeMap128||h;n=this.prefilteredCubeMap64||n;m=this.prefilteredCubeMap32||m;l=this.prefilteredCubeMap16||l;q=this.prefilteredCubeMap8||q;p=this.prefilteredCubeMap4||p;if(h){var r=h&&n&&m&&l&&q&&p;k&&r?(h.dpAtlas||(h.dpAtlas=pc.generateDpAtlas(a,[h,n,m,l,q,p]),h.sh=pc.shFromCubemap(l)),this.dpAtlas=h.dpAtlas,this.ambientSH=h.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)):d?6>h._levels.length?r?this._setParameter("texture_prefilteredCubeMap128",
h):console.log("Can't use prefiltered cubemap: "+r+", "+d+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):r?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",n),this._setParameter("texture_prefilteredCubeMap32",m),this._setParameter("texture_prefilteredCubeMap16",l),this._setParameter("texture_prefilteredCubeMap8",q),this._setParameter("texture_prefilteredCubeMap4",p)):console.log("Can't use prefiltered cubemap: "+r+", "+
d+", "+h._levels)}k=pc.programlib.standard;k=(d=f>pc.SHADER_FORWARDHDR&&f<=pc.SHADER_PICK)?k.optionsContextMin:k.optionsContext;d?this.shaderOptBuilder.updateMinRef(k,a,b,this,c,e,f,g,h):this.shaderOptBuilder.updateRef(k,a,b,this,c,e,f,g,h);this.onUpdateShader&&(k=this.onUpdateShader(k));this.shader=a.getProgramLibrary().getProgram("standard",k);c||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});(function(c){c.dirtyShader=!0;c.dirtyColor=!0;c._scene=null;c._colorProcessed=
!1;k(c,"ambient",new pc.Color(.7,.7,.7));k(c,"diffuse",new pc.Color(1,1,1));k(c,"specular",new pc.Color(0,0,0));k(c,"emissive",new pc.Color(0,0,0),!0);h(c,"shininess",25,function(a,b){return{name:"material_shininess",value:a.shadingModel===pc.SPECULAR_PHONG?Math.pow(2,.11*b):.01*b}});h(c,"heightMapFactor",1,function(a,b){return{name:"material_heightMapFactor",value:.025*b}});h(c,"opacity",1);h(c,"alphaTest",0);h(c,"bumpiness",1);h(c,"normalDetailMapBumpiness",1);h(c,"reflectivity",1);h(c,"occludeSpecularIntensity",
1);h(c,"refraction",0);h(c,"refractionIndex",1/1.5);h(c,"metalness",1);h(c,"anisotropy",0);h(c,"clearCoat",0);h(c,"clearCoatGlossiness",1);h(c,"aoUvSet",0,null);m(c,"ambientSH",function(a,b,c){return{name:"ambientSH[0]",value:b}});m(c,"cubeMapProjectionBox",function(a,b,c){var e=c?a.cubeMapMinUniform:new Float32Array(3);a=c?a.cubeMapMaxUniform:new Float32Array(3);e[0]=b.center.x-b.halfExtents.x;e[1]=b.center.y-b.halfExtents.y;e[2]=b.center.z-b.halfExtents.z;a[0]=b.center.x+b.halfExtents.x;a[1]=b.center.y+
b.halfExtents.y;a[2]=b.center.z+b.halfExtents.z;return[{name:"envBoxMin",value:e},{name:"envBoxMax",value:a}]});p(c);q(c,"ambientTint",!1);q(c,"diffuseTint",!1);q(c,"specularTint",!1);q(c,"emissiveTint",!1);q(c,"fastTbn",!1);q(c,"specularAntialias",!1);q(c,"useMetalness",!1);q(c,"enableGGXSpecular",!1);q(c,"occludeDirect",!1);q(c,"normalizeNormalMap",!0);q(c,"conserveEnergy",!0);q(c,"occludeSpecular",pc.SPECOCC_AO);q(c,"shadingModel",pc.SPECULAR_BLINN);q(c,"fresnelModel",pc.FRESNEL_NONE);q(c,"cubeMapProjection",
pc.CUBEPROJ_NONE);q(c,"customFragmentShader",null);q(c,"forceFragmentPrecision",null);q(c,"useFog",!0);q(c,"useLighting",!0);q(c,"useGammaTonemap",!0);q(c,"useSkybox",!0);q(c,"forceUv1",!1);q(c,"pixelSnap",!1);q(c,"twoSidedLighting",!1);q(c,"nineSlicedMode",pc.SPRITE_RENDERMODE_SLICED);g(c,"diffuse",0,3,"",!0);g(c,"specular",0,3,"",!0);g(c,"emissive",0,3,"",!0);g(c,"normal",0,-1,"",!1);g(c,"metalness",0,1,"",!0);g(c,"gloss",0,1,"",!0);g(c,"opacity",0,1,"a",!0);g(c,"height",0,1,"",!1);g(c,"ao",0,1,
"",!0);g(c,"light",1,3,"",!0);g(c,"msdf",0,3,"",!1);g(c,"diffuseDetail",0,3,"",!1,!0);g(c,"normalDetail",0,-1,"",!1);m(c,"cubeMap");m(c,"sphereMap");m(c,"dpAtlas");m(c,"prefilteredCubeMap128");m(c,"prefilteredCubeMap64");m(c,"prefilteredCubeMap32");m(c,"prefilteredCubeMap16");m(c,"prefilteredCubeMap8");m(c,"prefilteredCubeMap4");l(c,"diffuseTint","diffuseMapTint");l(c,"specularTint","specularMapTint");l(c,"emissiveTint","emissiveMapTint");l(c,"aoVertexColor","aoMapVertexColor");l(c,"diffuseVertexColor",
"diffuseMapVertexColor");l(c,"specularVertexColor","specularMapVertexColor");l(c,"emissiveVertexColor","emissiveMapVertexColor");l(c,"metalnessVertexColor","metalnessMapVertexColor");l(c,"glossVertexColor","glossMapVertexColor");l(c,"opacityVertexColor","opacityMapVertexColor");l(c,"lightVertexColor","lightMapVertexColor");for(var e=0;e<b.length;e++)a[e]=c[b[e]];c._propsSet=[]})(d.prototype);return{StandardMaterial:d}}());(function(){pc.StandardMaterial.PARAMETER_TYPES={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",
diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",
enableGGXSpecular:"boolean",anisotropy:"number",clearCoat:"number",clearCoatGlossiness:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",
glossMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",
normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",
cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",
prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"};var d;pc.StandardMaterial.TEXTURE_PARAMETERS=[];for(d in pc.StandardMaterial.PARAMETER_TYPES){var b=pc.StandardMaterial.PARAMETER_TYPES[d];"texture"===b&&pc.StandardMaterial.TEXTURE_PARAMETERS.push(d)}pc.StandardMaterial.CUBEMAP_PARAMETERS=[];for(d in pc.StandardMaterial.PARAMETER_TYPES)b=pc.StandardMaterial.PARAMETER_TYPES[d],"cubemap"===b&&pc.StandardMaterial.CUBEMAP_PARAMETERS.push(d)})();Object.assign(pc,function(){var d=function(){this.valid=this.removeInvalid=!0;this.enumValidators={occludeSpecular:this._createEnumValidator([pc.SPECOCC_NONE,pc.SPECOCC_AO,pc.SPECOCC_GLOSSDEPENDENT]),cull:this._createEnumValidator([pc.CULLFACE_NONE,pc.CULLFACE_BACK,pc.CULLFACE_FRONT,pc.CULLFACE_FRONTANDBACK]),blendType:this._createEnumValidator([pc.BLEND_SUBTRACTIVE,pc.BLEND_ADDITIVE,pc.BLEND_NORMAL,pc.BLEND_NONE,pc.BLEND_PREMULTIPLIED,pc.BLEND_MULTIPLICATIVE,pc.BLEND_ADDITIVEALPHA,pc.BLEND_MULTIPLICATIVE2X,
pc.BLEND_SCREEN,pc.BLEND_MIN,pc.BLEND_MAX]),shadingModel:this._createEnumValidator([pc.SPECULAR_PHONG,pc.SPECULAR_BLINN])}};d.prototype.setInvalid=function(b,a){this.valid=!1;this.removeInvalid&&delete a[b]};d.prototype.validate=function(b){var a=pc.StandardMaterial.PARAMETER_TYPES,c,e="path"===b.mappingFormat,f;for(f in b)if(c=a[f])if(c.startsWith("enum"))c=c.split(":")[1],this.enumValidators[c]&&(this.enumValidators[c](b[f])||this.setInvalid(f,b));else if("number"===c)"number"!==typeof b[f]&&this.setInvalid(f,
b);else if("boolean"===c)"boolean"!==typeof b[f]&&this.setInvalid(f,b);else if("string"===c)"string"!==typeof b[f]&&this.setInvalid(f,b);else if("vec2"===c)b[f]instanceof Array&&2===b[f].length||this.setInvalid(f,b);else if("rgb"===c)b[f]instanceof Array&&3===b[f].length||this.setInvalid(f,b);else if("texture"===c)e?"string"===typeof b[f]||b[null===f]||b[f]instanceof pc.Texture||this.setInvalid(f,b):"number"!==typeof b[f]&&null!==b[f]&&(b[f]instanceof pc.Texture||this.setInvalid(f,b));else if("boundingbox"===
c)b[f].center&&b[f].center instanceof Array&&3===b[f].center.length||this.setInvalid(f,b),b[f].halfExtents&&b[f].halfExtents instanceof Array&&3===b[f].halfExtents.length||this.setInvalid(f,b);else if("cubemap"===c)"number"!==typeof b[f]&&null!==b[f]&&void 0!==b[f]&&(b[f]instanceof pc.Texture&&b[f].cubemap||this.setInvalid(f,b));else if("chunks"===c){var g=Object.keys(b[f]);for(c=0;c<g.length;c++)"string"!==typeof b[f][g[c]]&&this.setInvalid(g[c],b[f])}else console.error("Unknown material type: "+
c);else this.valid=!1;b.validated=!0;return this.valid};d.prototype._createEnumValidator=function(b){return function(a){return 0<=b.indexOf(a)}};return{StandardMaterialValidator:d}}());Object.assign(pc,function(){var d=function(){this._mapXForms=null};d.prototype.updateMinRef=function(b,a,c,e,f,g,d,k,h){this._updateSharedOptions(b,e,f,d);this._updateMinOptions(b,e);this._updateUVOptions(b,e,f,!0)};d.prototype.updateRef=function(b,a,c,e,f,g,d,k,h){this._updateSharedOptions(b,e,f,d);b.useTexCubeLod=a.useTexCubeLod;this._updateEnvOptions(b,e,c,h);this._updateMaterialOptions(b,e);d===pc.SHADER_FORWARDHDR&&(b.gamma&&(b.gamma=pc.GAMMA_SRGBHDR),b.toneMap=pc.TONEMAP_LINEAR);b.hasTangents=
f&&e.normalMap&&0!==(f&pc.SHADERDEF_TANGENTS);this._updateLightOptions(b,e,f,k,g);this._updateUVOptions(b,e,f,!1);b.clearCoat=e.clearCoat;b.clearCoatGlossiness=e.clearCoatGlossiness};d.prototype._updateSharedOptions=function(b,a,c,e){b.pass=e;b.alphaTest=0<a.alphaTest;b.forceFragmentPrecision=a.forceFragmentPrecision||"";b.chunks=a.chunks||"";b.blendType=a.blendType;b.forceUv1=a.forceUv1;b.screenSpace=c&&0!==(c&pc.SHADERDEF_SCREENSPACE);b.skin=c&&0!==(c&pc.SHADERDEF_SKIN);b.useInstancing=c&&0!==(c&
pc.SHADERDEF_INSTANCING);b.nineSlicedMode=a.nineSlicedMode||0};d.prototype._updateUVOptions=function(b,a,c,e){var f=!1,g=!1,d=!1;c&&(f=0!==(c&pc.SHADERDEF_UV0),g=0!==(c&pc.SHADERDEF_UV1),d=0!==(c&pc.SHADERDEF_VCOLOR));b.vertexColors=!1;this._mapXForms=[];for(var k in pc._matTex2D)this._updateTexOptions(b,a,k,f,g,d,e);this._mapXForms=null};d.prototype._updateMinOptions=function(b,a){b.opacityTint=1!==a.opacity&&a.blendType!==pc.BLEND_NONE;b.lights=[]};d.prototype._updateMaterialOptions=function(b,
a){var c=1===a.diffuse.r&&1===a.diffuse.g&&1===a.diffuse.b||!a.diffuseTint&&(a.diffuseMap||a.diffuseVertexColor)?0:3,e=!1,f=(a.useMetalness?!0:!!a.specularMap)||!!a.sphereMap||!!a.cubeMap||!!a.dpAtlas;(f=(f=(f=f||(a.useMetalness?!0:!(0===a.specular.r&&0===a.specular.g&&0===a.specular.b)))||a.enableGGXSpecular)||0<a.clearCoat)&&(!a.specularTint&&(a.specularMap||a.specularVertexColor)||a.useMetalness||(e=1!==a.specular.r||1!==a.specular.g||1!==a.specular.b));var g=a.emissiveMap?0:3;g||(g=(g=(1!==a.emissive.r||
1!==a.emissive.g||1!==a.emissive.b||1!==a.emissiveIntensity)&&a.emissiveTint)?3:1!==a.emissiveIntensity?1:0);var d=a.normalMap?a.normalMap.format===pc.PIXELFORMAT_DXT5||a.normalMap.swizzleGGGR:!1;b.opacityTint=1!==a.opacity&&a.blendType!==pc.BLEND_NONE?1:0;b.blendMapsWithColors=!0;b.ambientTint=a.ambientTint;b.diffuseTint=c;b.specularTint=e?3:0;b.metalnessTint=a.useMetalness&&1>a.metalness?1:0;b.glossTint=1;b.emissiveTint=g;b.alphaToCoverage=a.alphaToCoverage;b.normalizeNormalMap=a.normalizeNormalMap;
b.sphereMap=!!a.sphereMap;b.cubeMap=!!a.cubeMap;b.dpAtlas=!!a.dpAtlas;b.ambientSH=!!a.ambientSH;b.useSpecular=f;b.emissiveFormat=a.emissiveMap?a.emissiveMap.rgbm?1:a.emissiveMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null;b.lightMapFormat=a.lightMap?a.lightMap.rgbm?1:a.lightMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null;b.specularAntialias=a.specularAntialias&&!!a.normalMap&&!!a.normalMap.mipmaps&&!d;b.conserveEnergy=a.conserveEnergy;b.occludeSpecular=a.occludeSpecular;b.occludeSpecularFloat=1!==a.occludeSpecularIntensity;
b.occludeDirect=a.occludeDirect;b.shadingModel=a.shadingModel;b.fresnelModel=a.fresnelModel;b.packedNormal=d;b.fastTbn=a.fastTbn;b.cubeMapProjection=a.cubeMapProjection;b.customFragmentShader=a.customFragmentShader;b.refraction=!!a.refraction;b.useMetalness=a.useMetalness;b.enableGGXSpecular=a.enableGGXSpecular;b.msdf=!!a.msdfMap;b.twoSidedLighting=a.twoSidedLighting;b.pixelSnap=a.pixelSnap;b.aoMapUv=a.aoUvSet;b.diffuseDetail=!!a.diffuseMap;b.normalDetail=!!a.normalMap;b.diffuseDetailMode=a.diffuseDetailMode;
b.detailModes=!!b.diffuseDetail};d.prototype._updateEnvOptions=function(b,a,c,e){var f=(e?e.rgbm:!1)||(a.cubeMap?a.cubeMap.rgbm:!1)||(a.dpAtlas?a.dpAtlas.rgbm:!1),g=(e?e.rgbm||e.format===pc.PIXELFORMAT_RGBA32F:!1)||(a.cubeMap?a.cubeMap.rgbm||a.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(a.dpAtlas?a.dpAtlas.rgbm||a.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:!1),d=(!e||a.cubeMap||a.sphereMap||a.dpAtlas?!1:e.rgbm)||(a.cubeMap?a.cubeMap.rgbm:!1)||(a.sphereMap?a.sphereMap.rgbm:!1)||(a.dpAtlas?a.dpAtlas.rgbm:
!1),k=(!e||a.cubeMap||a.sphereMap||a.dpAtlas?!1:e.rgbm||e.format===pc.PIXELFORMAT_RGBA32F)||(a.cubeMap?a.cubeMap.rgbm||a.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(a.sphereMap?a.sphereMap.rgbm||a.sphereMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(a.dpAtlas?a.dpAtlas.rgbm||a.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:!1),h;a.useSkybox&&c._skyboxPrefiltered&&(h=c._skyboxPrefiltered[0]);b.fog=a.useFog?c.fog:"none";b.gamma=a.useGammaTonemap?c.gammaCorrection:pc.GAMMA_NONE;b.toneMap=a.useGammaTonemap?c.toneMapping:
-1;b.rgbmAmbient=f;b.hdrAmbient=g;b.rgbmReflection=d;b.hdrReflection=k;b.useRgbm=d||f||(a.emissiveMap?a.emissiveMap.rgbm:!1)||(a.lightMap?a.lightMap.rgbm:!1);b.fixSeams=e?e.fixCubemapSeams:a.cubeMap?a.cubeMap.fixCubemapSeams:!1;b.prefilteredCubemap=!!e;b.skyboxIntensity=e&&h&&e===h&&1!==c.skyboxIntensity};d.prototype._updateLightOptions=function(b,a,c,e,f){b.lightMap=!1;b.lightMapChannel="";b.lightMapUv=0;b.lightMapTransform=0;b.lightMapWithoutAmbient=!1;b.dirLightMap=!1;c&&(b.noShadow=0!==(c&pc.SHADERDEF_NOSHADOW),
0!==(c&pc.SHADERDEF_LM)&&(b.lightMapFormat=1,b.lightMap=!0,b.lightMapChannel="rgb",b.lightMapUv=1,b.lightMapTransform=0,b.lightMapWithoutAmbient=!a.lightMap,b.useRgbm=!0,0!==(c&pc.SHADERDEF_DIRLM)&&(b.dirLightMap=!0)));a.useLighting?(a=[],c=c?c>>16:1,e&&(this._collectLights(pc.LIGHTTYPE_DIRECTIONAL,e[pc.LIGHTTYPE_DIRECTIONAL],a,c),this._collectLights(pc.LIGHTTYPE_POINT,e[pc.LIGHTTYPE_POINT],a,c,f),this._collectLights(pc.LIGHTTYPE_SPOT,e[pc.LIGHTTYPE_SPOT],a,c,f)),b.lights=a):b.lights=[];0===b.lights.length&&
(b.noShadow=!0)};d.prototype._updateTexOptions=function(b,a,c,e,f,g,d){var k=c+"Map",h=c+"VertexColor",n=c+"VertexColorChannel",l=k+"Channel",p=k+"Transform",q=k+"Uv";"light"!==c&&(b[k]=!1,b[l]="",b[p]=0,b[q]=0);b[h]=!1;b[n]="";var r="opacity"===c;if(r&&a.blendType===pc.BLEND_NONE&&0===a.alphaTest&&!a.alphaToCoverage)return b;if(!d||r)"height"!==c&&a[h]&&g&&(b[h]=a[h],b[n]=a[n],b.vertexColors=!0),a[k]&&(c=!0,0!==a[q]||e||(c=!1),1!==a[q]||f||(c=!1),c&&(b[k]=!!a[k],b[p]=this._getMapTransformID(a[p],
a[q]),b[l]=a[l],b[q]=a[q]))};d.prototype._collectLights=function(b,a,c,e,f){var g;for(g=0;g<a.length;g++){var d=a[g];d.enabled&&d.mask&e&&(b===pc.LIGHTTYPE_DIRECTIONAL||!d.isStatic)&&c.push(d)}if(f)for(g=0;g<f.length;g++)d=f[g],d._type===b&&c.push(d)};d.prototype._getMapTransformID=function(b,a){if(!b)return 0;this._mapXForms[a]||(this._mapXForms[a]=[]);var c;for(c=0;c<this._mapXForms[a].length&&this._mapXForms[a][c][0]==b.x&&this._mapXForms[a][c][1]==b.y&&this._mapXForms[a][c][2]==b.z&&this._mapXForms[a][c][3]==
b.w;)return c+1;c=this._mapXForms[a].length;this._mapXForms[a][c]=[];this._mapXForms[a][c][0]=b.x;this._mapXForms[a][c][1]=b.y;this._mapXForms[a][c][2]=b.z;this._mapXForms[a][c][3]=b.w;return c+1};return{StandardMaterialOptionsBuilder:d}}());Object.assign(pc,function(){var d=0,b=function(){this.initDefaults()};Object.assign(b.prototype,{initDefaults:function(){this.recreate=!1;this.indicesUsage=this.verticesUsage=pc.BUFFER_STATIC;this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=0;this.indexStreamUpdated=this.vertexStreamsUpdated=!1;this.vertexStreamDictionary={};this.indices=null},_validateVertexCount:function(a,b){},_changeVertexCount:function(a,b){this.vertexCount?this._validateVertexCount(a,b):this.vertexCount=a}});
Object.defineProperties(b,{DEFAULT_COMPONENTS_POSITION:{value:3},DEFAULT_COMPONENTS_NORMAL:{value:3},DEFAULT_COMPONENTS_UV:{value:2},DEFAULT_COMPONENTS_COLORS:{value:4}});var a=function(a){this._refCount=0;this.id=d++;this.device=a||pc.Application.getApplication().graphicsDevice;this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this._geometryData=this.morph=this.skin=null;this._aabb=new pc.BoundingBox;this.boneAabb=null};Object.defineProperty(a.prototype,"aabb",
{get:function(){return this.morph?this.morph.aabb:this._aabb},set:function(a){this.morph?(this._aabb=this.morph._baseAabb=a,this.morph._calculateAabb()):this._aabb=a}});Object.defineProperty(a.prototype,"refCount",{get:function(){return this._refCount}});Object.assign(a.prototype,{incReference:function(){this._refCount++},decReference:function(){this._refCount--},destroy:function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var a,b;for(a=0;a<this.indexBuffer.length;a++)(b=
this.indexBuffer[a])&&b.destroy();this.indexBuffer.length=0;this._geometryData=null},_initGeometryData:function(){this._geometryData||(this._geometryData=new pc.GeometryData,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},clear:function(a,
b,f,g){this._initGeometryData();this._geometryData.initDefaults();this._geometryData.recreate=!0;this._geometryData.maxVertices=f||0;this._geometryData.maxIndices=g||0;this._geometryData.verticesUsage=a?pc.BUFFER_STATIC:pc.BUFFER_DYNAMIC;this._geometryData.indicesUsage=b?pc.BUFFER_STATIC:pc.BUFFER_DYNAMIC},setVertexStream:function(a,b,f,g,d,k){this._initGeometryData();this._geometryData._changeVertexCount(g||b.length/f,a);this._geometryData.vertexStreamsUpdated=!0;this._geometryData.vertexStreamDictionary[a]=
new pc.GeometryVertexStream(b,f,d||pc.TYPE_FLOAT32,k||!1)},getVertexStream:function(a,b){var c=0,e=!1;if(this._geometryData){var d=this._geometryData.vertexStreamDictionary[a];d&&(e=!0,c=this._geometryData.vertexCount,ArrayBuffer.isView(b)?b.set(d.data):(b.length=0,b.push(d.data)))}e||this.vertexBuffer&&(c=(new pc.VertexIterator(this.vertexBuffer)).readData(a,b));return c},setPositions:function(a,e,f){this.setVertexStream(pc.SEMANTIC_POSITION,a,e||b.DEFAULT_COMPONENTS_POSITION,f,pc.TYPE_FLOAT32,!1)},
setNormals:function(a,e,f){this.setVertexStream(pc.SEMANTIC_NORMAL,a,e||b.DEFAULT_COMPONENTS_NORMAL,f,pc.TYPE_FLOAT32,!1)},setUvs:function(a,e,f,g){this.setVertexStream(pc.SEMANTIC_TEXCOORD+a,e,f||b.DEFAULT_COMPONENTS_UV,g,pc.TYPE_FLOAT32,!1)},setColors:function(a,e,f){this.setVertexStream(pc.SEMANTIC_COLOR,a,e||b.DEFAULT_COMPONENTS_COLORS,f,pc.TYPE_FLOAT32,!1)},setColors32:function(a,e){this.setVertexStream(pc.SEMANTIC_COLOR,a,b.DEFAULT_COMPONENTS_COLORS,e,pc.TYPE_UINT8,!0)},setIndices:function(a,
b){this._initGeometryData();this._geometryData.indexStreamUpdated=!0;this._geometryData.indices=a;this._geometryData.indexCount=b||a.length},getPositions:function(a){return this.getVertexStream(pc.SEMANTIC_POSITION,a)},getNormals:function(a){return this.getVertexStream(pc.SEMANTIC_NORMAL,a)},getUvs:function(a,b){return this.getVertexStream(pc.SEMANTIC_TEXCOORD+a,b)},getColors:function(a){return this.getVertexStream(pc.SEMANTIC_COLOR,a)},getIndices:function(a){var b=0;if(this._geometryData&&this._geometryData.indices){var c=
this._geometryData.indices;b=this._geometryData.indexCount;ArrayBuffer.isView(a)?a.set(c):(a.length=0,a.push(c))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(b=this.indexBuffer[0].readData(a));return b},update:function(a,b){this._geometryData&&((b||void 0===b)&&(b=this._geometryData.vertexStreamDictionary[pc.SEMANTIC_POSITION])&&3==b.componentCount&&this._aabb.compute(b.data,this._geometryData.vertexCount),b=this._geometryData.recreate,this._geometryData.vertexCount>this._geometryData.maxVertices&&
(b=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),b&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),b=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(b=!0,this._geometryData.maxIndices=this._geometryData.indexCount),b&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&
this._updateIndexBuffer(),this.primitive[0].type=void 0===a?pc.PRIMITIVE_TRIANGLES:a,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=
!1,this._geometryData.recreate=!1)},_buildVertexFormat:function(a){var b=[],c;for(c in this._geometryData.vertexStreamDictionary){var g=this._geometryData.vertexStreamDictionary[c];b.push({semantic:c,components:g.componentCount,type:g.dataType,normalize:g.dataTypeNormalize})}return new pc.VertexFormat(this.device,b,a)},_updateVertexBuffer:function(){if(!this.vertexBuffer){var a=this._geometryData.maxVertices,b=this._buildVertexFormat(a);this.vertexBuffer=new pc.VertexBuffer(this.device,b,a,this._geometryData.verticesUsage)}a=
new pc.VertexIterator(this.vertexBuffer);b=this._geometryData.vertexCount;for(var f in this._geometryData.vertexStreamDictionary)a.writeData(f,this._geometryData.vertexStreamDictionary[f].data,b),delete this._geometryData.vertexStreamDictionary[f];a.end()},_updateIndexBuffer:function(){if(0>=this.indexBuffer.length||!this.indexBuffer[0])this.indexBuffer[0]=new pc.IndexBuffer(this.device,65535<this._geometryData.maxVertices?pc.INDEXFORMAT_UINT32:pc.INDEXFORMAT_UINT16,this._geometryData.maxIndices,
this._geometryData.indicesUsage);var a=this._geometryData.indices;a&&(this.indexBuffer[0].writeData(a,this._geometryData.indexCount),this._geometryData.indices=null)},generateWireframe:function(){var a=function(a){switch(a.format){case pc.INDEXFORMAT_UINT8:return new Uint8Array(a.storage);case pc.INDEXFORMAT_UINT16:return new Uint16Array(a.storage);case pc.INDEXFORMAT_UINT32:return new Uint32Array(a.storage);default:return null}},b=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){var f=[[0,1],
[1,2],[2,0]];for(var g=this.primitive[pc.RENDERSTYLE_SOLID].base,d=this.primitive[pc.RENDERSTYLE_SOLID].count,k=this.indexBuffer[pc.RENDERSTYLE_SOLID],h=a(k),m={},l=g;l<g+d;l+=3)for(var p=0;3>p;p++){var q=h[l+f[p][0]],r=h[l+f[p][1]],t=q>r?r<<16|q:q<<16|r;void 0===m[t]&&(m[t]=0,b.push(q,r))}f=k.format}else{for(f=0;f<this.vertexBuffer.numVertices;f+=3)b.push(f,f+1,f+1,f+2,f+2,f);f=65535<b.length?pc.INDEXFORMAT_UINT32:pc.INDEXFORMAT_UINT16}f=new pc.IndexBuffer(this.vertexBuffer.device,f,b.length);a(f).set(b);
f.unlock();this.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:b.length,indexed:!0};this.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=f}});return{GeometryData:b,GeometryVertexStream:function(a,b,f,g){this.data=a;this.componentCount=b;this.dataType=f;this.dataTypeNormalize=g},Mesh:a}}());Object.assign(pc,function(){function d(a,b,c,d){return(a&15)<<27|(b===pc.BLEND_NONE?1:0)<<26|(c?1:0)<<25|(d&33554431)<<0}var b=new pc.BoundingBox,a=function(a,b,c){this._key=[0,0];this._shader=[null,null,null];this.isStatic=!1;this._staticSource=this._staticLightList=null;this.node=a;this._mesh=b;b.incReference();this.material=c;this._shaderDefs=pc.MASK_DYNAMIC<<16;this._shaderDefs|=b.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0;this._shaderDefs|=b.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0;this._shaderDefs|=
b.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0;this._shaderDefs|=b.vertexBuffer.format.hasTangents?pc.SHADERDEF_TANGENTS:0;this._lightHash=0;this.visible=!0;this.layer=pc.LAYER_WORLD;this.renderStyle=pc.RENDERSTYLE_SOLID;this.castShadow=!1;this._receiveShadow=!0;this._noDepthDrawGl1=this._screenSpace=!1;this._updateAabb=this.pick=this.cull=!0;this._calculateSortDistance=this._updateAabbFunc=null;this.updateKey();this.instancingData=this.morphInstance=this._skinInstance=null;this.aabb=new pc.BoundingBox;
this._boneAabb=null;this._aabbVer=-1;this.visibleThisFrame=this.drawOrder=0;this.isVisibleFunc=null;this.parameters={};this.stencilBack=this.stencilFront=null;this.flipFaces=!1};Object.defineProperty(a.prototype,"mesh",{get:function(){return this._mesh},set:function(a){this._mesh&&this._mesh.decReference();(this._mesh=a)&&a.incReference()}});Object.defineProperty(a.prototype,"aabb",{get:function(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);
if(this.skinInstance){var a=this.mesh.skin.boneNames.length,c;if(!this.mesh.boneAabb){this.mesh.boneAabb=[];this.mesh.boneUsed=[];var g=this.mesh.vertexBuffer.format.elements,d=this.mesh.vertexBuffer.numVertices;var k=this.mesh.vertexBuffer.format.size;var h;for(c=0;c<g.length;c++)if(g[c].name===pc.SEMANTIC_POSITION)var m=g[c].offset;else if(g[c].name===pc.SEMANTIC_BLENDINDICES)var l=g[c].offset;else if(g[c].name===pc.SEMANTIC_BLENDWEIGHT)var p=g[c].offset;g=new Uint8Array(this.mesh.vertexBuffer.storage);
var q=new Float32Array(this.mesh.vertexBuffer.storage),r=m/4,t=p/4,u=k/4;p=[];m=[];var x=this.mesh.boneUsed;for(c=0;c<a;c++)p[c]=new pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),m[c]=new pc.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(h=0;h<d;h++)for(c=0;4>c;c++)if(0<q[h*u+t+c]){var v=g[h*k+l+c];var y=q[h*u+r];var A=q[h*u+r+1];var z=q[h*u+r+2];var E=m[v];var C=p[v];C.x>y&&(C.x=y);C.y>A&&(C.y=A);C.z>z&&(C.z=z);E.x<y&&(E.x=y);E.y<A&&(E.y=A);E.z<z&&(E.z=z);x[v]=!0}if(this.morphInstance){x=
this.morphInstance.morph._targets;var D=new Float32Array(3*d),F=new Float32Array(3*d),I;for(h=0;h<d;h++)D[3*h]=F[3*h]=q[h*u+r],D[3*h+1]=F[3*h+1]=q[h*u+r+1],D[3*h+2]=F[3*h+2]=q[h*u+r+2];for(d=0;d<x.length;d++)for(c=x[d],r=c.indices,h=r.length,y=c.deltaPositions,c=0;c<h;c++){var G=r[c];v=y[3*c];E=y[3*c+1];C=y[3*c+2];0>v?D[3*G]+=v:F[3*G]+=v;0>E?D[3*G+1]+=E:F[3*G+1]+=E;0>C?D[3*G+2]+=C:F[3*G+2]+=C}for(d=0;d<x.length;d++)for(c=x[d],r=c.indices,h=r.length,c=0;c<h;c++)for(G=r[c],I=0;4>I;I++)0<q[G*u+t+I]&&
(v=g[G*k+l+I],E=m[v],C=p[v],y=D[3*G],A=D[3*G+1],z=D[3*G+2],C.x>y&&(C.x=y),C.y>A&&(C.y=A),C.z>z&&(C.z=z),y=F[3*G],A=F[3*G+1],z=F[3*G+2],E.x<y&&(E.x=y),E.y<A&&(E.y=A),E.z<z&&(E.z=z))}for(c=0;c<a;c++)k=new pc.BoundingBox,k.setMinMax(p[c],m[c]),this.mesh.boneAabb.push(k)}if(!this._boneAabb)for(this._boneAabb=[],c=0;c<this.mesh.boneAabb.length;c++)this._boneAabb[c]=new pc.BoundingBox;x=this.mesh.boneUsed;for(c=0;c<this.mesh.boneAabb.length;c++)x[c]&&this._boneAabb[c].setFromTransformedAabb(this.mesh.boneAabb[c],
this.skinInstance.matrices[c]);a=this.node.getWorldTransform();k=!0;for(c=0;c<this.mesh.boneAabb.length;c++)x[c]&&(k?(b.center.copy(this._boneAabb[c].center),b.halfExtents.copy(this._boneAabb[c].halfExtents),k=!1):b.add(this._boneAabb[c]));this._aabb.setFromTransformedAabb(b,a)}else this.node._aabbVer!==this._aabbVer&&(k=this.mesh?this.mesh.aabb:this._aabb,this.mesh||(k.center.set(0,0,0),k.halfExtents.set(0,0,0)),this._aabb.setFromTransformedAabb(k,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);
return this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(a.prototype,"material",{get:function(){return this._material},set:function(a){var b;for(b=0;b<this._shader.length;b++)this._shader[b]=null;if(this._material){var c=this._material.meshInstances;b=c.indexOf(this);-1!==b&&c.splice(b,1)}b=this._material;if(this._material=a)this._material.meshInstances.push(this),this.updateKey(),(b&&b.blendType!==pc.BLEND_NONE)!==(this._material.blendType!==pc.BLEND_NONE)&&(a=this._material._scene,
!a&&b&&b._scene&&(a=b._scene),a?a.layers._dirtyBlend=!0:this._material._dirtyBlend=!0)}});Object.defineProperty(a.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(a.prototype,"calculateSortDistance",{get:function(){return this._calculateSortDistance},set:function(a){this._calculateSortDistance=a}});Object.defineProperty(a.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(a){this._shaderDefs=
(this._receiveShadow=a)?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW;this._shader[pc.SHADER_FORWARD]=null;this._shader[pc.SHADER_FORWARDHDR]=null}});Object.defineProperty(a.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;for(a=0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(a.prototype,"screenSpace",
{get:function(){return this._screenSpace},set:function(a){this._shaderDefs=(this._screenSpace=a)?this._shaderDefs|pc.SHADERDEF_SCREENSPACE:this._shaderDefs&~pc.SHADERDEF_SCREENSPACE;this._shader[pc.SHADER_FORWARD]=null}});Object.defineProperty(a.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(a){this._key[pc.SORTKEY_FORWARD]=a}});Object.defineProperty(a.prototype,"mask",{get:function(){return this._shaderDefs>>16},set:function(a){this._shaderDefs=this._shaderDefs&
65535|a<<16;this._shader[pc.SHADER_FORWARD]=null;this._shader[pc.SHADER_FORWARDHDR]=null}});Object.defineProperty(a.prototype,"instancingCount",{get:function(){return this.instancingData?this.instancingData.count:0},set:function(a){this.instancingData&&(this.instancingData.count=a)}});Object.assign(a.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this._key[pc.SORTKEY_FORWARD]=d(this.layer,a.alphaToCoverage||a.alphaTest?pc.BLEND_NORMAL:a.blendType,!1,a.id)},setInstancing:function(a){a?
(this.instancingData=new pc.InstancingData(a.numVertices),this.instancingData.offset=0,this.instancingData.vertexBuffer=a,this.cull=!1):(this.instancingData=null,this.cull=!0)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});var c=function(a,b,
c){this._key=[];this._key[pc.SORTKEY_FORWARD]=d(a,b,!0,0);this.command=c};Object.defineProperty(c.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(a){this._key[pc.SORTKEY_FORWARD]=a}});return{Command:c,MeshInstance:a,InstancingData:function(a){this.count=a;this.vertexBuffer=null;this.offset=0},_getDrawcallSortKey:d}}());Object.assign(pc,function(){var d=new pc.Mat4,b=function(a){this.skin=a;this._dirty=!0;this.bones=[];var b=a.inverseBindPose.length;a=a.device;if(a.supportsBoneTextures){var e=256<b?64:64<b?32:16<b?16:8;this.boneTexture=new pc.Texture(a,{width:e,height:e,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST});this.boneTexture.name="skin";this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(16*b);this.matrices=[];for(a=0;a<b;a++)this.matrices[a]=
new pc.Mat4};Object.assign(b.prototype,{updateMatrices:function(a){d.copy(a.getWorldTransform()).invert();for(a=this.bones.length-1;0<=a;a--)this.matrices[a].mul2(d,this.bones[a].getWorldTransform()),this.matrices[a].mul2(this.matrices[a],this.skin.inverseBindPose[a])},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,e,f=this.bones.length-1;0<=f;f--)a=this.matrices[f].data,e=16*f,b[e]=a[0],b[e+1]=a[1],b[e+2]=a[2],b[e+3]=a[3],b[e+4]=a[4],b[e+5]=a[5],b[e+6]=a[6],b[e+7]=a[7],b[e+8]=a[8],
b[e+9]=a[9],b[e+10]=a[10],b[e+11]=a[11],b[e+12]=a[12],b[e+13]=a[13],b[e+14]=a[14],b[e+15]=a[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}});return{Skin:function(a,b,e){this.device=a;this.inverseBindPose=b;this.boneNames=e},SkinInstance:b}}());Object.assign(pc,function(){function d(){this.index=0;this.boneIndices=[0,0,0,0]}function b(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}function a(a){var b=a.vertices,c=a.skins,e=a.meshes,d=a.meshInstances;for(a=0;a<e.length;a++)e[a].vertices=b[e[a].vertices],void 0!==e[a].skin&&(e[a].skin=c[e[a].skin]);for(a=0;a<d.length;a++)d[a].mesh=e[d[a].mesh]}function c(a){var b=a.vertices,c=a.skins,
e=a.meshes,d=a.meshInstances;for(a=0;a<e.length;a++)e[a].vertices=b.indexOf(e[a].vertices),void 0!==e[a].skin&&(e[a].skin=c.indexOf(e[a].skin));for(a=0;a<d.length;a++)d[a].mesh=e.indexOf(d[a].mesh)}Object.assign(b.prototype,{addVertex:function(a,b,c){if(void 0!==this.indexMap[b])c=this.indexMap[b],this.indices.push(c);else{for(var e=0;4>e;e++)0!==c.blendWeight.data[4*b+e]&&(a.boneIndices[e]=this.getBoneRemap(c.blendIndices.data[4*a.index+e]));c=this.vertices.length;this.indices.push(c);this.vertices.push(a);
this.indexMap[b]=c}},addPrimitive:function(a,b,c,d){var e,f,g=[],n=0,p=a.length;for(e=0;e<p;e++)for(var q=a[e].index,r=0;4>r;r++)if(0<c.blendWeight.data[4*q+r]){var t=c.blendIndices.data[4*q+r],u=!0;for(f=0;f<n;f++)if(g[f]==t){u=!1;break}u&&(g[n]=t,f=this.getBoneRemap(t),n+=-1===f?1:0)}if(this.boneIndices.length+n>d)return!1;for(e=0;e<n;e++)this.boneIndices.push(g[e]);for(e=0;e<p;e++)this.addVertex(a[e],b[e],c);return!0},getBoneRemap:function(a){for(var b=0;b<this.boneIndices.length;b++)if(this.boneIndices[b]===
a)return b;return-1}});return{partitionSkin:function(e,f,g){var n,k;a(e);var h=e.vertices,m=e.skins,l=e.meshes,p=e.meshInstances,q=function(a){var b=new d;b.index=a;return b};for(n=m.length-1;0<=n;n--)if(m[n].boneNames.length>g){var r=m.splice(n,1)[0],t=[];for(k=0;k<l.length;k++)l[k].skin===r&&t.push(l[k]);for(k=0;k<t.length;k++){var u=l.indexOf(t[k]);-1!==u&&l.splice(u,1)}if(0===t.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var x=t[0].vertices;for(k=
1;k<t.length;k++)if(t[k].vertices!==x)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var v=[],y=[];var A=[];var z=0;for(k=0;k<t.length;k++){var E=t[k];for(var C=E.indices,D=E.base;D<E.base+E.count;){u=C[D++];y[0]=q(u);A[0]=u;u=C[D++];y[1]=q(u);A[1]=u;u=C[D++];y[2]=q(u);A[2]=u;for(var F=!1,I=z;I<v.length;I++)if(u=v[I],u.addPrimitive(y,A,x,g)){F=!0;break}F||(u=new b,u.originalMesh=E,u.addPrimitive(y,A,x,g),v.push(u))}z=v.length}E=[];t=[];for(k=0;k<
v.length;k++)if(u=v[k],u.vertices.length&&u.indices.length){y=E.length;A=u.vertices.length;z=t.length;C=u.indices.length;u.partition=k;u.vertexStart=y;u.vertexCount=A;u.indexStart=z;u.indexCount=C;D=0;for(F=y;D<A;)E[F++]=u.vertices[D++];D=0;for(F=z;D<C;)t[F++]=u.indices[D++]+y}y=[];for(k=0;k<v.length;k++){u=v[k];z=[];C=[];for(A=0;A<u.boneIndices.length;A++)z.push(r.inverseBindMatrices[u.boneIndices[A]]),C.push(r.boneNames[u.boneIndices[A]]);u={inverseBindMatrices:z,boneNames:C};y.push(u);m.push(u)}var G;
r={};for(G in x)r[G]={components:x[G].components,data:[],type:x[G].type};for(G in x)if("blendIndices"===G)for(u=r[G].data,k=0;k<E.length;k++)A=E[k].boneIndices,u.push(A[0],A[1],A[2],A[3]);else for(k=x[G],z=k.data,C=k.components,k=0;k<E.length;k++)for(u=E[k].index,A=0;A<C;A++)r[G].data.push(z[u*C+A]);h[h.indexOf(x)]=r;for(k=0;k<v.length;k++)for(u=v[k],E={aabb:{min:[0,0,0],max:[0,0,0]},vertices:r,skin:y[k],indices:t.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount},l.push(E),A=p.length-
1;0<=A;A--)p[A].mesh===u.originalMesh&&(p.push({mesh:E,node:p[A].node}),f&&f.push({material:f[A].material,path:f[A].path}));for(k=0;k<v.length;k++)for(u=v[k],A=p.length-1;0<=A;A--)p[A].mesh===u.originalMesh&&(p.splice(A,1),f&&f.splice(A,1))}c(e)}}}());Object.assign(pc,function(){var d=new pc.Vec3,b=new pc.Vec3,a=function(a){this.aabb=new pc.BoundingBox;this._baseAabb=this._baseBuffer=null;this._targets=a;this._aabbDirty=this._dirty=!0;this._baseData=null;this._vertSizeF=this._offsetTF=this._offsetNF=this._offsetPF=0};Object.assign(a.prototype,{_setBaseMesh:function(a){this._baseBuffer=a.vertexBuffer;this._baseAabb=a._aabb;this._baseData=new Float32Array(this._baseBuffer.storage);for(var b=a=-1,c=-1,e=this._baseBuffer.format.elements,d=this._baseBuffer.format.size,
h=0;h<e.length;h++)e[h].name===pc.SEMANTIC_POSITION?a=e[h].offset:e[h].name===pc.SEMANTIC_NORMAL?b=e[h].offset:e[h].name===pc.SEMANTIC_TANGENT&&(c=e[h].offset);this._offsetPF=a/4;this._offsetNF=b/4;this._offsetTF=c/4;this._vertSizeF=d/4;this._dirty=!0},_calculateAabb:function(){if(this._baseBuffer){this.aabb.copy(this._baseAabb);var a,c;for(a=0;a<this._targets.length;a++){var g=this._targets[a];if(!g.aabb&&0<g.indices.length){g.aabb=this.aabb.clone();d.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
b.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var n=g.indices.length;for(c=0;c<n;c++){var k=g.deltaPositions[3*c];var h=g.deltaPositions[3*c+1];var m=g.deltaPositions[3*c+2];d.x>k&&(d.x=k);d.y>h&&(d.y=h);d.z>m&&(d.z=m);b.x<k&&(b.x=k);b.y<h&&(b.y=h);b.z<m&&(b.z=m)}g.aabb.setMinMax(d,b)}g.aabb&&(n=new pc.Vec3,c=new pc.Vec3,n.add2(this.aabb.getMin(),g.aabb.getMin()),c.add2(this.aabb.getMax(),g.aabb.getMax()),this.aabb.setMinMax(n,c))}this._aabbDirty=!1}},addTarget:function(a){this._targets.push(a);
this._aabbDirty=!0},removeTarget:function(a){a=this._targets.indexOf(a);-1!==a&&(this._targets.splice(a,1),this._aabbDirty=!0)},getTarget:function(a){return this._targets[a]}});var c=function(a){this.morph=a;this._vertexData=this._vertexBuffer=null;this._weights=[];this._dirty=!0};Object.assign(c.prototype,{_setBaseMesh:function(a){this.destroy();this._vertexBuffer=new pc.VertexBuffer(this.morph._baseBuffer.device,this.morph._baseBuffer.format,this.morph._baseBuffer.numVertices,pc.BUFFER_DYNAMIC,
this.morph._baseBuffer.storage.slice(0));this._vertexData=new Float32Array(this._vertexBuffer.storage);this._weights=this.morph._targets.map(function(a){return a.defaultWeight});this._dirty=!0},destroy:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null)},getWeight:function(a){return this._weights[a]},setWeight:function(a,b){this._weights[a]=b;this._dirty=!0},updateBounds:function(a){this.morph._baseBuffer!==a.vertexBuffer&&this.morph._setBaseMesh(a);this._vertexData||
this._setBaseMesh(a);this.morph._aabbDirty&&this.morph._calculateAabb()},update:function(a){this.morph._baseBuffer!==a.vertexBuffer&&this.morph._setBaseMesh(a);this._vertexData||this._setBaseMesh(a);var b=this.morph._targets,c=this._weights,e,d=this.morph._vertSizeF,h=this.morph._offsetPF,m=this.morph._offsetNF,l=this.morph._offsetTF,p=this._vertexData;p.set(this.morph._baseData);for(var q=0;q<b.length;q++){var r=c[q];if(0!==r){var t=b[q];a=t.indices.length;for(e=0;e<a;e++){var u=3*e;var x=t.indices[e];
var v=x*d+h;p[v]+=t.deltaPositions[u]*r;p[v+1]+=t.deltaPositions[u+1]*r;p[v+2]+=t.deltaPositions[u+2]*r;t.deltaNormals&&(v=x*d+m,p[v]+=t.deltaNormals[u]*r,p[v+1]+=t.deltaNormals[u+1]*r,p[v+2]+=t.deltaNormals[u+2]*r,t.deltaTangents&&(u=4*e,v=x*d+l,p[v]+=t.deltaTangents[u]*r,p[v+1]+=t.deltaTangents[u+1]*r,p[v+2]+=t.deltaTangents[u+2]*r,p[v+3]+=t.deltaTangents[u+3]*r,p[v+3]=0<p[v+3]?1:-1))}}}this._vertexBuffer.unlock()}});return{MorphTarget:function(a){if(a.indices)this.indices=a.indices;else{var b=
a.deltaPositions;this.indices=[];this.indices.length=b.length;for(var c=0;c<b.length;c++)this.indices[c]=c}this.deltaPositions=a.deltaPositions;this.deltaNormals=a.deltaNormals;this.deltaTangents=a.deltaTangents;this.name=a.name;this.aabb=a.aabb;this.defaultWeight=a.defaultWeight||0},Morph:a,MorphInstance:c}}());Object.assign(pc,function(){var d=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0;this._immutable=!1};Object.assign(d.prototype,{getGraph:function(){return this.graph},setGraph:function(b){this.graph=b},getCameras:function(){return this.cameras},setCameras:function(b){this.cameras=b},getLights:function(){return this.lights},setLights:function(b){this.lights=b},getMaterials:function(){var b,a=[];for(b=
0;b<this.meshInstances.length;b++){var c=this.meshInstances[b];-1===a.indexOf(c.material)&&a.push(c.material)}return a},clone:function(){var b,a,c=[],e=[],f=function(a){var b=a.clone();c.push(a);e.push(b);for(var g=0;g<a._children.length;g++)b.addChild(f(a._children[g]));return b},g=f(this.graph),d=[],k=[],h=[];for(b=0;b<this.skinInstances.length;b++){var m=this.skinInstances[b].skin,l=new pc.SkinInstance(m),p=[];for(a=0;a<m.boneNames.length;a++){var q=g.findByName(m.boneNames[a]);p.push(q)}l.bones=
p;k.push(l)}for(b=0;b<this.morphInstances.length;b++)a=new pc.MorphInstance(this.morphInstances[b].morph),h.push(a);for(b=0;b<this.meshInstances.length;b++)a=this.meshInstances[b],m=c.indexOf(a.node),m=new pc.MeshInstance(e[m],a.mesh,a.material),a.skinInstance&&(l=this.skinInstances.indexOf(a.skinInstance),m.skinInstance=k[l]),a.morphInstance&&(a=this.morphInstances.indexOf(a.morphInstance),m.morphInstance=h[a]),d.push(m);b=new pc.Model;b.graph=g;b.meshInstances=d;b.skinInstances=k;b.morphInstances=
h;b.getGraph().syncHierarchy();return b},destroy:function(){for(var b=this.meshInstances,a,c,e=0;e<b.length;e++){a=b[e];if(c=a.mesh)a.mesh=null,1>c.refCount&&c.destroy();(c=a.skinInstance)&&(c=c.boneTexture)&&c.destroy();a.skinInstance=null;(c=a.morphInstance)&&c.destroy();a.morphInstance=null;a.material=null}},generateWireframe:function(){var b,a=[];for(b=0;b<this.meshInstances.length;b++){var c=this.meshInstances[b].mesh;-1===a.indexOf(c)&&a.push(c)}for(b=0;b<a.length;++b)c=a[b],c.primitive[pc.RENDERSTYLE_WIREFRAME]||
c.generateWireframe()}});return{Model:d}}());Object.assign(pc,function(){function d(a,b){u[a]=void 0!==x[a]&&null!==x[a]?x[a]:b}function b(a,b){for(var c=a.length/3,e=Array(4*c),f=0;f<c;f++)e[4*f]=a[3*f],e[4*f+1]=a[3*f+1],e[4*f+2]=a[3*f+2],e[4*f+3]=(255*b[3*f]<<16|255*b[3*f+1]<<8|255*b[3*f+2])/16777216;return e}function a(a,b){var c,e,f=b.length,g=a.length/f;for(c=0;c<g;c++)for(e=0;e<f;e++)b[e]=Math.max(b[e],Math.abs(a[c*f+e]))}function c(b,c,e){for(var f=new Float32Array(c.length),g=0;g<c.length;g++)f[g]=c[g]-b[g];a(f,e);b=e.length;var d=f.length/
b;for(c=0;c<d;c++)for(g=0;g<b;g++)f[c*b+g]/=0===e[g]?1:e[g],f[c*b+g]*=.5,f[c*b+g]+=.5;return f}var e=[[-1,-1],[1,-1],[1,1],[-1,1]],f=function(a,b,c,e,f,g,d){f||(f=pc.PIXELFORMAT_RGBA32F);var k=pc.FILTER_NEAREST;d&&f===pc.PIXELFORMAT_R8_G8_B8_A8&&(k=pc.FILTER_LINEAR);a=new pc.Texture(a,{width:b,height:c,format:f,cubemap:!1,mipmaps:!1,minFilter:k,magFilter:k,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});a.name="PSTexture";b=a.lock();if(f===pc.PIXELFORMAT_R8_G8_B8_A8){f=new Uint8Array(e.length);
for(c=0;c<e.length;c++)f[c]=e[c]*g*255;e=f}b.set(e);a.unlock();return a},g=new pc.Curve([0,0,1,0]),n=new pc.Curve([0,1,1,1]),k=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),h=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),m=2,l=new Float32Array(3),p=new pc.Mat4,q=new pc.Vec3,r=new pc.Vec3,t=new pc.Vec3,u,x,v=function(a,b){this.graphicsDevice=a;this.precision=32;this._addTimeTime=0;if(!v.DEFAULT_PARAM_TEXTURE){var c=new Float32Array(1024),e,m;for(m=0;16>m;m++)for(e=0;16>e;e++){var l=e+1-8.5;var q=
m+1-8.5;q=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(l*l+q*q)/16,1),0)-.5,1),0);l=16*m+e;c[4*l]=1;c[4*l+1]=1;c[4*l+2]=1;c[4*l+3]=q}v.DEFAULT_PARAM_TEXTURE=f(a,16,16,c,pc.PIXELFORMAT_R8_G8_B8_A8,1,!0);v.DEFAULT_PARAM_TEXTURE.minFilter=pc.FILTER_LINEAR;v.DEFAULT_PARAM_TEXTURE.magFilter=pc.FILTER_LINEAR}u=this;x=b;d("numParticles",1);this.numParticles>a.maxTextureSize&&(console.warn("WARNING: can't create more than "+a.maxTextureSize+" particles on this device."),this.numParticles=a.maxTextureSize);
d("rate",1);d("rate2",this.rate);d("lifetime",50);d("emitterExtents",new pc.Vec3(0,0,0));d("emitterExtentsInner",new pc.Vec3(0,0,0));d("emitterRadius",0);d("emitterRadiusInner",0);d("emitterShape",pc.EMITTERSHAPE_BOX);d("initialVelocity",1);d("wrap",!1);d("localSpace",!1);d("wrapBounds",null);d("colorMap",v.DEFAULT_PARAM_TEXTURE);d("normalMap",null);d("loop",!0);d("preWarm",!1);d("sort",pc.PARTICLESORT_NONE);d("mode",pc.PARTICLEMODE_GPU);d("scene",null);d("lighting",!1);d("halfLambert",!1);d("intensity",
1);d("stretch",0);d("alignToMotion",!1);d("depthSoftening",0);d("mesh",null);d("particleNormal",new pc.Vec3(0,1,0));d("orientation",pc.PARTICLEORIENTATION_SCREEN);d("depthWrite",!1);d("noFog",!1);d("blendType",pc.BLEND_NORMAL);d("node",null);d("startAngle",0);d("startAngle2",this.startAngle);d("animTilesX",1);d("animTilesY",1);d("animStartFrame",0);d("animNumFrames",1);d("animNumAnimations",1);d("animIndex",0);d("randomizeAnimIndex",!1);d("animSpeed",1);d("animLoop",!0);this._gpuUpdater=new pc.ParticleGPUUpdater(this,
a);this._cpuUpdater=new pc.ParticleCPUUpdater(this);this.constantLightCube=a.scope.resolve("lightCube[0]");this.emitterPosUniform=new Float32Array(3);this.wrapBoundsUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);d("colorGraph",h);d("colorGraph2",this.colorGraph);d("scaleGraph",n);d("scaleGraph2",this.scaleGraph);d("alphaGraph",n);d("alphaGraph2",this.alphaGraph);d("localVelocityGraph",k);d("localVelocityGraph2",this.localVelocityGraph);d("velocityGraph",k);d("velocityGraph2",
this.velocityGraph);d("rotationSpeedGraph",g);d("rotationSpeedGraph2",this.rotationSpeedGraph);d("radialSpeedGraph",g);d("radialSpeedGraph2",this.radialSpeedGraph);this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=new pc.Vec3(0,0,1);this.animTilesParams=new Float32Array(2);
this.animParams=new Float32Array(4);this.animIndexParams=new Float32Array(2);this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.pack8=!0;this.localBounds=new pc.BoundingBox;this.worldBoundsNoTrail=new pc.BoundingBox;this.worldBoundsTrail=[new pc.BoundingBox,new pc.BoundingBox];this.worldBounds=new pc.BoundingBox;this.worldBoundsSize=new pc.Vec3;this.prevWorldBoundsSize=
new pc.Vec3;this.prevWorldBoundsCenter=new pc.Vec3;this.prevEmitterExtents=this.emitterExtents;this.prevEmitterRadius=this.emitterRadius;this.worldBoundsMul=new pc.Vec3;this.worldBoundsAdd=new pc.Vec3;this.timeToSwitchBounds=0;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=Math.random();this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTimeTotal=
this.simTime=0;this.beenReset=!1;this._layer=null;this.rebuild()};Object.assign(v.prototype,{onChangeCamera:function(){this.regenShader();this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize);
this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.useCpu||(this.emitterShape===pc.EMITTERSHAPE_BOX?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var a=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,a);this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);
var b=this.simTimeTotal;b>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=b+this.lifetime);this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,a),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,a)):(this.meshInstance.aabb.copy(this.worldBounds),
this.meshInstance.mesh.aabb.copy(this.worldBounds));this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?pc.Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),
this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=-Number.MAX_VALUE,g=-Number.MAX_VALUE,d=0,k=0,h=this.lifetime/this.precision,n=[this.qVelocity,this.qVelocity2],m=[this.qLocalVelocity,this.qLocalVelocity2],l=[0,0],q=[0,0],p=[0,0],u=[0,0],x=[0,0],v,J;for(v=0;v<this.precision+1;v++){var Z=
Math.min(v,this.precision-1);for(J=0;2>J;J++){var N=m[J][3*Z]*h+l[J];var S=m[J][3*Z+1]*h+q[J];var P=m[J][3*Z+2]*h+p[J];a=Math.min(N,a);b=Math.min(S,b);c=Math.min(P,c);e=Math.max(N,e);f=Math.max(S,f);g=Math.max(P,g);l[J]=N;q[J]=S;p[J]=P}for(J=0;2>J;J++)x[J]+=h*Math.sqrt(n[J][3*Z]*n[J][3*Z]+n[J][3*Z+1]*n[J][3*Z+1]+n[J][3*Z+2]*n[J][3*Z+2]);u[0]+=this.qRadialSpeed[Z]*h;u[1]+=this.qRadialSpeed2[Z]*h;d=Math.max(d,Math.max(Math.abs(u[0]),Math.abs(u[1])));k=Math.max(k,this.qScale[Z])}this.emitterShape===
pc.EMITTERSHAPE_BOX?(N=.5*this.emitterExtents.x,S=.5*this.emitterExtents.y,P=.5*this.emitterExtents.z):P=S=N=this.emitterRadius;h=Math.max(x[0],x[1]);r.x=a-k-N-d-h;r.y=b-k-S-d-h;r.z=c-k-P-d-h;t.x=e+k+N+d+h;t.y=f+k+S+d+h;t.z=g+k+P+d+h;this.localBounds.setMinMax(r,t)},rebuild:function(){var a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=v.DEFAULT_PARAM_TEXTURE);this.spawnBounds=this.emitterShape===pc.EMITTERSHAPE_BOX?this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||this.sort>
pc.PARTICLESORT_NONE||1>=b.maxVertexTextures||64>b.fragmentUniformsCount||b.forceCpuParticles||!b.extTextureFloat;this._destroyResources();this.pack8=(this.pack8||!b.textureFloatRenderable)&&!this.useCpu;m=this.useCpu||this.pack8?4:2;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=
pc.math.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.resetWorldBounds();this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?pc.Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),
this.pack8&&this.calculateBoundsMad());this.vbToSort=Array(this.numParticles);for(a=0;a<this.numParticles;a++)this.vbToSort[a]=[0,0];this.particleDistance=new Float32Array(this.numParticles);this._gpuUpdater.randomize();this.particleTex=new Float32Array(this.numParticlesPot*m*4);var c=null===this.node||this.localSpace?pc.Vec3.ZERO:this.node.getPosition();this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.node||this.localSpace?p.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):p.setTRS(pc.Vec3.ZERO,
this.node.getRotation(),q.copy(this.spawnBounds).mul(this.node.localScale)),l[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,l[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,l[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(a=0;a<this.numParticles;a++)this._cpuUpdater.calcSpawnPosition(this.particleTex,p,l,c,a),this.useCpu&&(this.particleTex[4*a+3+8*this.numParticlesPot]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*
m*4);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.pack8?(this.particleTexIN=f(b,this.numParticlesPot,m,this.particleTex,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexOUT=f(b,this.numParticlesPot,m,this.particleTex,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexStart=f(b,this.numParticlesPot,m,this.particleTexStart,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1)):(this.particleTexIN=f(b,this.numParticlesPot,m,this.particleTex),this.particleTexOUT=
f(b,this.numParticlesPot,m,this.particleTex),this.particleTexStart=f(b,this.numParticlesPot,m,this.particleTexStart)),this.rtParticleTexIN=new pc.RenderTarget(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;c=(this.localSpace?"#define LOCAL_SPACE\n":"")+a.particleUpdaterInitPS+(this.pack8?a.particleInputRgba8PS+a.particleOutputRgba8PS:a.particleInputFloatPS+a.particleOutputFloatPS)+(this.emitterShape===
pc.EMITTERSHAPE_BOX?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS;var e=c+a.particleUpdaterNoRespawnPS+a.particleUpdaterEndPS,g=c+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS,d=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c+a.particleUpdaterRespawnPS+a.particleUpdaterEndPS,"fsQuad0"+d);this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuad1"+d);this.shaderParticleUpdateOnStop=
a.createShaderFromCode(b,a.fullscreenQuadVS,g,"fsQuad2"+d);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new pc.Mesh(b);b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new pc.Material;
this.material.name=this.node.name;this.material.cull=pc.CULLFACE_NONE;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();a=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new pc.MeshInstance(this.node,b,this.material);this.meshInstance.pick=!1;this.meshInstance.updateKey();this.meshInstance.cull=!0;this.meshInstance._noDepthDrawGl1=!0;
this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance._updateAabb=!1;this.meshInstance.visible=a;this._initializeTextures();this.resetTime();this.addTime(0,!1);this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==v.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var e=
this.precision,g=this.graphicsDevice,d;this.qLocalVelocity=this.localVelocityGraph.quantize(e);this.qVelocity=this.velocityGraph.quantize(e);this.qColor=this.colorGraph.quantizeClamped(e,0,1);this.qRotSpeed=this.rotationSpeedGraph.quantize(e);this.qScale=this.scaleGraph.quantize(e);this.qAlpha=this.alphaGraph.quantize(e);this.qRadialSpeed=this.radialSpeedGraph.quantize(e);this.qLocalVelocity2=this.localVelocityGraph2.quantize(e);this.qVelocity2=this.velocityGraph2.quantize(e);this.qColor2=this.colorGraph2.quantizeClamped(e,
0,1);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e);this.qScale2=this.scaleGraph2.quantize(e);this.qAlpha2=this.alphaGraph2.quantize(e);this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(d=0;d<e;d++)this.qRotSpeed[d]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[d]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new Float32Array(3);this.velocityUMax=new Float32Array(3);this.colorUMax=new Float32Array(3);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.radialSpeedUMax=[0];this.qLocalVelocityDiv=
c(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax);this.qVelocityDiv=c(this.qVelocity,this.qVelocity2,this.velocityUMax);this.qColorDiv=c(this.qColor,this.qColor2,this.colorUMax);this.qRotSpeedDiv=c(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=c(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=c(this.qAlpha,this.qAlpha2,this.alphaUMax);this.qRadialSpeedDiv=c(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax);if(this.pack8){var k=[0,0,0];a(this.qVelocity,
k);var h=[0,0,0];a(this.qVelocity2,h);d=[0,0,0];a(this.qLocalVelocity,d);var n=[0,0,0];a(this.qLocalVelocity2,n);var m=[0];a(this.qRadialSpeed,m);var l=[0];a(this.qRadialSpeed2,l);var q=Math.max(k[0],h[0]);q=Math.max(q,k[1]);q=Math.max(q,h[1]);q=Math.max(q,k[2]);q=Math.max(q,h[2]);k=Math.max(d[0],n[0]);k=Math.max(k,d[1]);k=Math.max(k,n[1]);k=Math.max(k,d[2]);k=Math.max(k,n[2]);this.maxVel=q+k+Math.max(m[0],l[0])}if(!this.useCpu){this.internalTex0=f(g,e,1,b(this.qLocalVelocity,this.qLocalVelocityDiv));
this.internalTex1=f(g,e,1,b(this.qVelocity,this.qVelocityDiv));d=this.qRotSpeed;n=this.qScale;m=this.qScaleDiv;l=this.qRotSpeedDiv;q=this.qAlphaDiv;k=Array(4*d.length);for(h=0;h<d.length;h++)k[4*h]=d[h],k[4*h+1]=n[h],k[4*h+2]=0,k[4*h+3]=(255*m[h]<<16|255*l[h]<<8|255*q[h])/16777216;this.internalTex2=f(g,e,1,k);d=this.qRadialSpeed;n=this.qRadialSpeedDiv;m=Array(4*d.length);for(l=0;l<d.length;l++)m[4*l]=d[l],m[4*l+1]=n[l],m[4*l+2]=0,m[4*l+3]=0;this.internalTex3=f(g,e,1,m)}d=this.qColor;n=this.qAlpha;
m=Array(4*n.length);for(l=0;l<n.length;l++)m[4*l]=d[3*l],m[4*l+1]=d[3*l+1],m[4*l+2]=d[3*l+2],m[4*l+3]=n[l];this.colorParam=f(g,e,1,m,pc.PIXELFORMAT_R8_G8_B8_A8,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=
b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());this.shader=a.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:
0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!=pc.PARTICLEORIENTATION_SCREEN})};this.material.updateShader()},resetMaterial:function(){var a=this.material;a.setParameter("stretch",
this.stretch);this._isAnimated()&&(a.setParameter("animTexTilesParams",this.animTilesParams),a.setParameter("animTexParams",this.animParams),a.setParameter("animTexIndexParams",this.animIndexParams));a.setParameter("colorMult",this.intensity);this.useCpu||(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2),a.setParameter("internalTex3",this.internalTex3));a.setParameter("colorParam",this.colorParam);a.setParameter("numParticles",
this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",
new Float32Array([1,1,1]));this.pack8&&(this._gpuUpdater._setInputBounds(),a.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),a.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),a.setParameter("maxVel",this.maxVel));this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,a.setParameter("wrapBounds",this.wrapBoundsUniform));this.colorMap&&a.setParameter("colorMap",
this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&a.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100));0<this.stretch&&(a.cull=pc.CULLFACE_NONE);this._compParticleFaceParams()},_compParticleFaceParams:function(){if(this.orientation==pc.PARTICLEORIENTATION_SCREEN){var a=new Float32Array([1,0,0]);var b=new Float32Array([0,0,1])}else{a=this.orientation==pc.PARTICLEORIENTATION_WORLD?this.particleNormal.normalize():(null===
this.node?pc.Mat4.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var c=new pc.Vec3(1,0,0);1==Math.abs(c.dot(a))&&c.set(0,0,1);b=(new pc.Vec3).cross(a,c).normalize();c.cross(b,a).normalize();a=new Float32Array([c.x,c.y,c.z]);b=new Float32Array([b.x,b.y,b.z])}this.material.setParameter("faceTangent",a);this.material.setParameter("faceBinorm",b)},_allocate:function(a){var b=a*this.numParticleVerts,c=a*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==
b){if(this.useCpu)var f=[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:1,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR4,components:this.useMesh?4:2,type:pc.TYPE_FLOAT32}];else f=[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.TYPE_FLOAT32}],this.useMesh&&f.push({semantic:pc.SEMANTIC_ATTR1,components:2,type:pc.TYPE_FLOAT32});
f=new pc.VertexFormat(this.graphicsDevice,f);this.vertexBuffer=new pc.VertexBuffer(this.graphicsDevice,f,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,c);f=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){var g=new Float32Array(this.mesh.vertexBuffer.lock());var d=g.length/this.mesh.vertexBuffer.numVertices;for(c=0;c<this.mesh.vertexBuffer.format.elements.length;c++)if(this.mesh.vertexBuffer.format.elements[c].name===pc.SEMANTIC_TEXCOORD0){var k=
this.mesh.vertexBuffer.format.elements[c].offset/4;break}}for(c=0;c<b;c++){var h=Math.floor(c/this.numParticleVerts);if(this.useMesh){var n=c%this.numParticleVerts;f[6*c]=g[n*d];f[6*c+1]=g[n*d+1];f[6*c+2]=g[n*d+2];f[6*c+3]=h;f[6*c+4]=g[n*d+k+0];f[6*c+5]=g[n*d+k+1]}else n=c%4,f[4*c]=e[n][0],f[4*c+1]=e[n][1],f[4*c+2]=0,f[4*c+3]=h}this.useCpu&&(this.vbCPU=new Float32Array(f),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;d=
new Uint16Array(this.indexBuffer.lock());this.useMesh&&(g=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(k=0;k<this.numParticleIndices;k++)d[c*this.numParticleIndices+k]=g[k]+c*this.numParticleVerts;else k=4*c,d[b++]=k,d[b++]=k+1,d[b++]=k+2,d[b++]=k,d[b++]=k+2,d[b++]=k+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=
0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetWorldBounds();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0,!1);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision);a/=b;for(var c=0;c<b;c++)this.addTime(a,!1)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+
1E3*a},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(a,b){var c=this.graphicsDevice;this.simTimeTotal+=a;this.calculateWorldBounds();if(this._isAnimated()){var e=this.animTilesParams;e[0]=1/this.animTilesX;e[1]=1/this.animTilesY;e=this.animParams;e[0]=this.animStartFrame;e[1]=this.animNumFrames*this.animSpeed;e[2]=this.animNumFrames-1;e[3]=this.animNumAnimations-1;e=this.animIndexParams;e[0]=this.animIndex;e[1]=this.randomizeAnimIndex}this.scene&&this.camera!=this.scene._activeCamera&&
(this.camera=this.scene._activeCamera,this.onChangeCamera());this.emitterShape===pc.EMITTERSHAPE_BOX&&(l[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,l[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,l[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?p.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.emitterExtents):p.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),q.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));
e=null===this.meshInstance.node?pc.Vec3.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=e.x;this.emitterScaleUniform[1]=e.y;this.emitterScaleUniform[2]=e.z;this.material.setParameter("emitterScale",this.emitterScaleUniform);if(this.localSpace&&this.meshInstance.node){var f=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=f.x;this.emitterPosUniform[1]=f.y;this.emitterPosUniform[2]=f.z;this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams();
this.useCpu?(c=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(c,this.vbToSort,this.particleTex,p,l,f,a,b)):this._gpuUpdater.update(c,p,l,a,b);if(!this.loop&&Date.now()>this.endTime){if(this.onFinished)this.onFinished();this.meshInstance.visible=!1}},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null);this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null);this.particleTexStart&&this.particleTexStart.destroy&&
(this.particleTexStart.destroy(),this.particleTexStart=null);this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null);this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null);this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null);this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null);this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null);this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=
null);this.colorParam&&(this.colorParam.destroy(),this.colorParam=null);this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0);this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0);this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null;this._destroyResources()}});return{ParticleEmitter:v}}());Object.assign(pc,function(){function d(a){return a-Math.floor(a)}function b(a,b){return a-b*Math.floor(a/b)}function a(a){var b=d(a);a=d(255*a);return[b-a/255,a-a/255]}var c,e=1,f=new pc.Mat4,g=new pc.Mat4,n=new pc.Vec3,k=new pc.Vec3,h=new pc.Vec3,m=new pc.Vec3,l=new pc.Vec3,p=new pc.Vec3,q=new pc.Vec3,r=new pc.Vec3,t=new pc.Vec3,u=new pc.Vec3,x=new pc.Vec3,v=new pc.Vec3,y=new pc.Vec3,A=function(a){this._emitter=a};A.prototype.calcSpawnPosition=function(b,c,e,f,g){var h=this._emitter,m=Math.random(),
l=Math.random(),q=Math.random(),p=Math.random();h.useCpu&&(b[4*g+8*h.numParticlesPot]=m,b[4*g+1+8*h.numParticlesPot]=l,b[4*g+2+8*h.numParticlesPot]=q);k.x=m-.5;k.y=l-.5;k.z=q-.5;h.emitterShape===pc.EMITTERSHAPE_BOX?(p=Math.max(Math.abs(k.x),Math.max(Math.abs(k.y),Math.abs(k.z))),l=p+(.5-p)*e[1],q=p+(.5-p)*e[2],k.x=(p+(.5-p)*e[0])*(p==Math.abs(k.x)?Math.sign(k.x):2*k.x),k.y=l*(p==Math.abs(k.y)?Math.sign(k.y):2*k.y),k.z=q*(p==Math.abs(k.z)?Math.sign(k.z):2*k.z),h.localSpace?n.copy(c.transformPoint(k)):
n.copy(f).add(c.transformPoint(k))):(k.normalize(),c=0===h.emitterRadius?0:h.emitterRadiusInner/h.emitterRadius,c=p*(1-c)+c,h.localSpace?n.copy(k.scale(c*h.emitterRadius)):n.copy(f).add(k.scale(c*h.emitterRadius)));f=-pc.math.lerp(h.rate,h.rate2,m)*g;h.pack8?(p=(n.x-h.worldBounds.center.x)/h.worldBoundsSize.x+.5,e=(n.y-h.worldBounds.center.y)/h.worldBoundsSize.y+.5,c=(n.z-h.worldBounds.center.z)/h.worldBoundsSize.z+.5,m=pc.math.lerp(h.startAngle*pc.math.DEG_TO_RAD,h.startAngle2*pc.math.DEG_TO_RAD,
m),m=m%(2*Math.PI)/(2*Math.PI),p=a(p),b[4*g]=p[0],b[4*g+1]=p[1],e=a(e),b[4*g+2]=e[0],b[4*g+3]=e[1],c=a(c),b[4*g+4*h.numParticlesPot]=c[0],b[4*g+1+4*h.numParticlesPot]=c[1],m=a(m),b[4*g+2+4*h.numParticlesPot]=m[0],b[4*g+3+4*h.numParticlesPot]=m[1],b[4*g+3+8*h.numParticlesPot]=1,m=Math.max(h.lifetime,(h.numParticles-1)*Math.max(h.rate,h.rate2)),e=(f+m)/(m+(h.lifetime+1)),m=d(e),f=d(255*e),c=d(65025*e),e=d(160581375*e),m-=f/255,f-=c/255,m=[m,f,c-e/255,e-e/255],b[4*g+12*h.numParticlesPot]=m[0],b[4*g+
1+12*h.numParticlesPot]=m[1],b[4*g+2+12*h.numParticlesPot]=m[2],b[4*g+3+12*h.numParticlesPot]=m[3]):(b[4*g]=n.x,b[4*g+1]=n.y,b[4*g+2]=n.z,b[4*g+3]=pc.math.lerp(h.startAngle*pc.math.DEG_TO_RAD,h.startAngle2*pc.math.DEG_TO_RAD,m),b[4*g+3+4*h.numParticlesPot]=f)};A.prototype.update=function(a,d,n,A,F,I,G,B){var w=this._emitter;if(w.meshInstance.node){var H=w.meshInstance.node.worldTransform;for(I=0;12>I;I++)f.data[I]=H.data[I];g.copy(f);g.invert();c=w.meshInstance.node.localScale;e=Math.max(Math.max(c.x,
c.y),c.z)}I=null===w.meshInstance.node||w.localSpace?pc.Vec3.ZERO:w.meshInstance.node.getPosition();var M=w.camera?w.camera._node.getPosition():pc.Vec3.ZERO,aa=w.useMesh?17:15,R=w.precision-1;for(H=0;H<w.numParticles;H++){var z=Math.floor(w.vbCPU[H*w.numParticleVerts*(w.useMesh?6:4)+3]),C=n[4*z+8*w.numParticlesPot];h.x=C;h.y=n[4*z+1+8*w.numParticlesPot];h.z=n[4*z+2+8*w.numParticlesPot];var J=w.rate+(w.rate2-w.rate)*C,D=w.lifetime,N=n[4*z+3+4*w.numParticlesPot]+G,E=Math.max(Math.min(N/D,1),0),P=0;
var Y=0;(0>=N-G||N>=D)&&this.calcSpawnPosition(n,A,F,I,z);var U=0<N&&N<D;if(U){Y=E*R;var K=Math.floor(Y);var V=Math.ceil(Y);Y%=1;var L=w.qRotSpeed[K];var Q=w.qRotSpeed[V];var X=L+(Q-L)*Y;L=w.qRotSpeed2[K];Q=w.qRotSpeed2[V];var ba=L+(Q-L)*Y;L=w.qScale[K];Q=w.qScale[V];P=L+(Q-L)*Y;L=w.qScale2[K];Q=w.qScale2[V];var O=L+(Q-L)*Y;L=w.qAlpha[K];Q=w.qAlpha[V];var ca=L+(Q-L)*Y;L=w.qAlpha2[K];Q=w.qAlpha2[V];var W=L+(Q-L)*Y;L=w.qRadialSpeed[K];Q=w.qRadialSpeed[V];var da=L+(Q-L)*Y;L=w.qRadialSpeed2[K];Q=w.qRadialSpeed2[V];
L+=(Q-L)*Y;da+=100*C%1*(L-da);m.x=n[4*z];m.y=n[4*z+1];m.z=n[4*z+2];w.localSpace?t.copy(m):t.copy(m).sub(I);t.normalize().scale(da);K*=3;V*=3;L=w.qLocalVelocity[K];Q=w.qLocalVelocity[V];p.x=L+(Q-L)*Y;L=w.qLocalVelocity[K+1];Q=w.qLocalVelocity[V+1];p.y=L+(Q-L)*Y;L=w.qLocalVelocity[K+2];Q=w.qLocalVelocity[V+2];p.z=L+(Q-L)*Y;L=w.qLocalVelocity2[K];Q=w.qLocalVelocity2[V];r.x=L+(Q-L)*Y;L=w.qLocalVelocity2[K+1];Q=w.qLocalVelocity2[V+1];r.y=L+(Q-L)*Y;L=w.qLocalVelocity2[K+2];Q=w.qLocalVelocity2[V+2];r.z=
L+(Q-L)*Y;L=w.qVelocity[K];Q=w.qVelocity[V];l.x=L+(Q-L)*Y;L=w.qVelocity[K+1];Q=w.qVelocity[V+1];l.y=L+(Q-L)*Y;L=w.qVelocity[K+2];Q=w.qVelocity[V+2];l.z=L+(Q-L)*Y;L=w.qVelocity2[K];Q=w.qVelocity2[V];q.x=L+(Q-L)*Y;L=w.qVelocity2[K+1];Q=w.qVelocity2[V+1];q.y=L+(Q-L)*Y;L=w.qVelocity2[K+2];Q=w.qVelocity2[V+2];q.z=L+(Q-L)*Y;p.x+=(r.x-p.x)*h.x;p.y+=(r.y-p.y)*h.y;p.z+=(r.z-p.z)*h.z;0<w.initialVelocity&&(w.emitterShape===pc.EMITTERSHAPE_SPHERE?(k.copy(h).scale(2).sub(pc.Vec3.ONE).normalize(),p.add(k.scale(w.initialVelocity))):
p.add(pc.Vec3.FORWARD.scale(w.initialVelocity)));l.x+=(q.x-l.x)*h.x;l.y+=(q.y-l.y)*h.y;l.z+=(q.z-l.z)*h.z;X+=(ba-X)*h.y;P=(P+1E4*C%1*(O-P))*e;Y=1E3*C%1*(W-ca);w.meshInstance.node&&(w.localSpace?(p.x/=c.x,p.y/=c.y,p.z/=c.z):f.transformPoint(p,p));w.localSpace?(g.transformPoint(l,l),p.add(l).add(t)):(p.add(l.mul(c)),p.add(t.mul(c)));v.copy(p);u.copy(m).add(p.scale(G));x.copy(u);n[4*z]=x.x;n[4*z+1]=x.y;n[4*z+2]=x.z;n[4*z+3]+=X*G;w.wrap&&w.wrapBounds&&(w.localSpace||x.sub(I),x.x=b(x.x,w.wrapBounds.x)-
.5*w.wrapBounds.x,x.y=b(x.y,w.wrapBounds.y)-.5*w.wrapBounds.y,x.z=b(x.z,w.wrapBounds.z)-.5*w.wrapBounds.z,w.localSpace||x.add(I));0<w.sort&&(1===w.sort?(y.copy(x).sub(M),w.particleDistance[z]=-(y.x*y.x+y.y*y.y+y.z*y.z)):2===w.sort?w.particleDistance[z]=N:3===w.sort&&(w.particleDistance[z]=-N))}B?0>N&&(n[4*z+3+8*w.numParticlesPot]=-1):(N>=D&&(N-=Math.max(D,(w.numParticles-1)*J),n[4*z+3+8*w.numParticlesPot]=w.loop?1:-1),0>N&&w.loop&&(n[4*z+3+8*w.numParticlesPot]=1));0>n[4*z+3+8*w.numParticlesPot]&&
(U=!1);n[4*z+3+4*w.numParticlesPot]=N;for(X=0;X<w.numParticleVerts;X++)C=(H*w.numParticleVerts+X)*(w.useMesh?6:4),J=w.vbCPU[C],D=w.vbCPU[C+1],N=w.vbCPU[C+2],U||(J=D=N=0),K=H*w.numParticleVerts*aa+X*aa,a[K]=x.x,a[K+1]=x.y,a[K+2]=x.z,a[K+3]=E,a[K+4]=w.alignToMotion?0:n[4*z+3],a[K+5]=P,a[K+6]=Y,a[K+7]=v.x,a[K+8]=J,a[K+9]=D,a[K+10]=N,a[K+11]=v.y,a[K+12]=z,a[K+13]=v.z,a[K+14]=w.vbCPU[C+3],w.useMesh&&(a[K+15]=w.vbCPU[C+4],a[K+16]=w.vbCPU[C+5])}if(w.sort>pc.PARTICLESORT_NONE&&w.camera){a=w.useMesh?6:4;n=
w.particleDistance;for(H=0;H<w.numParticles;H++)d[H][0]=H,d[H][1]=n[Math.floor(w.vbCPU[H*w.numParticleVerts*a+3])];w.vbOld.set(w.vbCPU);d.sort(function(a,b){return a[1]-b[1]});for(H=0;H<w.numParticles;H++)for(n=d[H][0]*w.numParticleVerts*a,A=H*w.numParticleVerts*a,I=0;I<w.numParticleVerts*a;I++)w.vbCPU[A+I]=w.vbOld[n+I]}};return{ParticleCPUUpdater:A}}());Object.assign(pc,function(){function d(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var b=new pc.Mat3,a=new pc.Mat3,c=new pc.Mat3,e=function(a,b){this._emitter=a;this.frameRandomUniform=new Float32Array(3);this.emitterPosUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);this.worldBoundsMulUniform=new Float32Array(3);this.worldBoundsAddUniform=
new Float32Array(3);this.inBoundsSizeUniform=new Float32Array(3);this.inBoundsCenterUniform=new Float32Array(3);this.constantParticleTexIN=b.scope.resolve("particleTexIN");this.constantParticleTexOUT=b.scope.resolve("particleTexOUT");this.constantEmitterPos=b.scope.resolve("emitterPos");this.constantEmitterScale=b.scope.resolve("emitterScale");this.constantSpawnBounds=b.scope.resolve("spawnBounds");this.constantSpawnPosInnerRatio=b.scope.resolve("spawnPosInnerRatio");this.constantSpawnBoundsSphere=
b.scope.resolve("spawnBoundsSphere");this.constantSpawnBoundsSphereInnerRatio=b.scope.resolve("spawnBoundsSphereInnerRatio");this.constantInitialVelocity=b.scope.resolve("initialVelocity");this.constantFrameRandom=b.scope.resolve("frameRandom");this.constantDelta=b.scope.resolve("delta");this.constantRate=b.scope.resolve("rate");this.constantRateDiv=b.scope.resolve("rateDiv");this.constantLifetime=b.scope.resolve("lifetime");this.constantGraphSampleSize=b.scope.resolve("graphSampleSize");this.constantGraphNumSamples=
b.scope.resolve("graphNumSamples");this.constantInternalTex0=b.scope.resolve("internalTex0");this.constantInternalTex1=b.scope.resolve("internalTex1");this.constantInternalTex2=b.scope.resolve("internalTex2");this.constantInternalTex3=b.scope.resolve("internalTex3");this.constantEmitterMatrix=b.scope.resolve("emitterMatrix");this.constantEmitterMatrixInv=b.scope.resolve("emitterMatrixInv");this.constantNumParticles=b.scope.resolve("numParticles");this.constantNumParticlesPot=b.scope.resolve("numParticlesPot");
this.constantLocalVelocityDivMult=b.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=b.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=b.scope.resolve("rotSpeedDivMult");this.constantSeed=b.scope.resolve("seed");this.constantStartAngle=b.scope.resolve("startAngle");this.constantStartAngle2=b.scope.resolve("startAngle2");this.constantOutBoundsMul=b.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=b.scope.resolve("outBoundsAdd");this.constantInBoundsSize=b.scope.resolve("inBoundsSize");
this.constantInBoundsCenter=b.scope.resolve("inBoundsCenter");this.constantMaxVel=b.scope.resolve("maxVel");this.constantFaceTangent=b.scope.resolve("faceTangent");this.constantFaceBinorm=b.scope.resolve("faceBinorm")};e.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x;this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y;this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z;this.constantInBoundsSize.setValue(this.inBoundsSizeUniform);
this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x;this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y;this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z;this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)};e.prototype.randomize=function(){this.frameRandomUniform[0]=Math.random();this.frameRandomUniform[1]=Math.random();this.frameRandomUniform[2]=Math.random()};e.prototype.update=function(e,g,n,k,h){var f=this._emitter;e.setBlending(!1);
e.setColorWrite(!0,!0,!0,!0);e.setCullMode(pc.CULLFACE_NONE);e.setDepthTest(!1);e.setDepthWrite(!1);this.randomize();this.constantGraphSampleSize.setValue(1/f.precision);this.constantGraphNumSamples.setValue(f.precision);this.constantNumParticles.setValue(f.numParticles);this.constantNumParticlesPot.setValue(f.numParticlesPot);this.constantInternalTex0.setValue(f.internalTex0);this.constantInternalTex1.setValue(f.internalTex1);this.constantInternalTex2.setValue(f.internalTex2);this.constantInternalTex3.setValue(f.internalTex3);
var l=f.meshInstance.node,p=null===l?pc.Vec3.ONE:l.localScale;if(f.pack8){this.worldBoundsMulUniform[0]=f.worldBoundsMul.x;this.worldBoundsMulUniform[1]=f.worldBoundsMul.y;this.worldBoundsMulUniform[2]=f.worldBoundsMul.z;this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform);this.worldBoundsAddUniform[0]=f.worldBoundsAdd.x;this.worldBoundsAddUniform[1]=f.worldBoundsAdd.y;this.worldBoundsAddUniform[2]=f.worldBoundsAdd.z;this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform);this._setInputBounds();
var q=f.maxVel*Math.max(Math.max(p.x,p.y),p.z);q=Math.max(q,1);this.constantMaxVel.setValue(q)}q=null===l||f.localSpace?pc.Vec3.ZERO:l.getPosition();l=null===l?pc.Mat4.IDENTITY:l.getWorldTransform();f.emitterShape===pc.EMITTERSHAPE_BOX?(d(g,b),this.constantSpawnBounds.setValue(b.data),this.constantSpawnPosInnerRatio.setValue(n)):(this.constantSpawnBoundsSphere.setValue(f.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===f.emitterRadius?0:f.emitterRadiusInner/f.emitterRadius));this.constantInitialVelocity.setValue(f.initialVelocity);
d(l,a);l.invertTo3x3(c);this.emitterPosUniform[0]=q.x;this.emitterPosUniform[1]=q.y;this.emitterPosUniform[2]=q.z;this.constantEmitterPos.setValue(this.emitterPosUniform);this.constantFrameRandom.setValue(this.frameRandomUniform);this.constantDelta.setValue(k);this.constantRate.setValue(f.rate);this.constantRateDiv.setValue(f.rate2-f.rate);this.constantStartAngle.setValue(f.startAngle*pc.math.DEG_TO_RAD);this.constantStartAngle2.setValue(f.startAngle2*pc.math.DEG_TO_RAD);this.constantSeed.setValue(f.seed);
this.constantLifetime.setValue(f.lifetime);this.emitterScaleUniform[0]=p.x;this.emitterScaleUniform[1]=p.y;this.emitterScaleUniform[2]=p.z;this.constantEmitterScale.setValue(this.emitterScaleUniform);this.constantEmitterMatrix.setValue(a.data);this.constantEmitterMatrixInv.setValue(c.data);this.constantLocalVelocityDivMult.setValue(f.localVelocityUMax);this.constantVelocityDivMult.setValue(f.velocityUMax);this.constantRotSpeedDivMult.setValue(f.rotSpeedUMax[0]);g=f.swapTex?f.particleTexOUT:f.particleTexIN;
g=f.beenReset?f.particleTexStart:g;n=f.swapTex?f.particleTexIN:f.particleTexOUT;this.constantParticleTexIN.setValue(g);pc.drawQuadWithShader(e,f.swapTex?f.rtParticleTexIN:f.rtParticleTexOUT,h?f.shaderParticleUpdateOnStop:f.loop?f.shaderParticleUpdateRespawn:f.shaderParticleUpdateNoRespawn);f.material.setParameter("particleTexOUT",g);f.material.setParameter("particleTexIN",n);f.beenReset=!1;f.swapTex=!f.swapTex;e.setDepthTest(!0);e.setDepthWrite(!0);f.prevWorldBoundsSize.copy(f.worldBoundsSize);f.prevWorldBoundsCenter.copy(f.worldBounds.center);
f.pack8&&this._setInputBounds()};return{ParticleGPUUpdater:e}}());Object.assign(pc,function(){var d=!1,b=function(a,b,e){a instanceof pc.GraphicsDevice&&(a=pc.Application.getApplication(),d||(d=!0));this.app=a;var c=this.device=a.graphicsDevice;this.library=c.getProgramLibrary();this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.scene=null;this.drawCalls=[];this.layerComp=this.layer=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};var g=this;this._clearDepthOptions={depth:1,flags:pc.CLEARFLAG_DEPTH};this.clearDepthCommand=
new pc.Command(0,0,function(){c.clear(g._clearDepthOptions)});this.resize(b,e);this._ignoreOpacityFor=null};b.prototype.getSelection=function(a,b,e,f){var c=this.device;"object"===typeof a?(f=a,a=f.x,b=f.y,e=f.width,f=f.height):b=this.layer.renderTarget.height-(b+(f||1));e=e||1;f=f||1;var d=c.renderTarget;c.setRenderTarget(this.layer.renderTarget);c.updateBegin();var k=new Uint8Array(4*e*f);c.readPixels(a,b,e,f,k);c.updateEnd();c.setRenderTarget(d);a=[];b=this.layer.instances.visibleOpaque[0].list;
for(c=0;c<e*f;c++){d=k[4*c];var h=k[4*c+1];var m=k[4*c+2];d=d<<16|h<<8|m;16777215!==d&&(d=b[d],-1===a.indexOf(d)&&a.push(d))}return a};b.prototype.prepare=function(a,b,e){var c=this.device,g=this;a instanceof pc.Camera&&(a=a._component);this.scene=b;var d=null,k=null;e instanceof pc.Layer?d=e:k=e;if(!this.layer){var h=c.scope.resolve("uColor");this.layer=new pc.Layer({name:"Picker",shaderPass:pc.SHADER_PICK,opaqueSortMode:pc.SORTMODE_NONE,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(c,
{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:g.width,height:g.height});a.name="pick";a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.renderTarget=new pc.RenderTarget(c,a,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(a,b){g.pickColor[0]=(b>>16&255)/255;g.pickColor[1]=(b>>8&255)/255;g.pickColor[2]=
(b&255)/255;h.setValue(g.pickColor);c.setBlending(!1)}});this.layerComp=new pc.LayerComposition;this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;this._instancesVersion=-1}if(!d){this.layer.clearMeshInstances();e=b.layers.layerList;var m=b.layers.subLayerEnabled,l=b.layers.subLayerList;for(b=0;b<e.length;b++)e[b].overrideClear&&e[b]._clearDepthBuffer&&(e[b]._pickerCleared=!1);for(b=0;b<e.length;b++){var p=e[b];if(p.renderTarget===k&&p.enabled&&m[b]){var q=p.cameras.indexOf(a);
if(!(0>q)){p.overrideClear&&p._clearDepthBuffer&&!p._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),p._pickerCleared=!0);q=(q=l[b])?p.instances.transparentMeshInstances:p.instances.opaqueMeshInstances;var r=q.length;for(p=0;p<r;p++){var t=q[p];t.pick&&this.meshInstances.push(t)}}}}}else if(this._instancesVersion!==d._version){this.layer.clearMeshInstances();q=d.instances.opaqueMeshInstances;r=q.length;for(p=0;p<r;p++)t=q[p],t.pick&&this.meshInstances.push(t);q=d.instances.transparentMeshInstances;
r=q.length;for(p=0;p<r;p++)t=q[p],t.pick&&this.meshInstances.push(t);this._instancesVersion=d._version}this.layer.cameras[0]!==a&&(this.layer.clearCameras(),this.layer.addCamera(a));this.onLayerPreRender(this.layer,d,k);this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};b.prototype.onLayerPreRender=function(a,b,e){if(this.width!==a.renderTarget.width||this.height!==a.renderTarget.height)a.onDisable(),a.onEnable();a.oldClear=a.cameras[0].camera._clearOptions;a.oldAspectMode=
a.cameras[0].aspectRatioMode;a.oldAspect=a.cameras[0].aspectRatio;a.cameras[0].camera._clearOptions=this.clearOptions;a.cameras[0].aspectRatioMode=pc.ASPECT_MANUAL;a.cameras[0].aspectRatio=a.cameras[0].calculateAspectRatio(e?e:b?b.renderTarget:null);this.app.renderer.updateCameraFrustum(a.cameras[0].camera)};b.prototype.onLayerPostRender=function(a){a.cameras[0].camera._clearOptions=a.oldClear;a.cameras[0].aspectRatioMode=a.oldAspectMode;a.cameras[0].aspectRatio=a.oldAspect};b.prototype.resize=function(a,
b){this.width=a;this.height=b};Object.defineProperty(b.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}});return{Picker:b}}());var primitiveUv1Padding=.0625,primitiveUv1PaddingScale=1-2*primitiveUv1Padding;
pc.calculateNormals=function(d,b){var a=b.length/3,c=d.length/3,e,f=new pc.Vec3,g=new pc.Vec3,n=new pc.Vec3,k=new pc.Vec3,h=new pc.Vec3,m=new pc.Vec3,l=[];for(e=0;e<d.length;e++)l[e]=0;for(e=0;e<a;e++){var p=b[3*e];var q=b[3*e+1];var r=b[3*e+2];f.set(d[3*p],d[3*p+1],d[3*p+2]);g.set(d[3*q],d[3*q+1],d[3*q+2]);n.set(d[3*r],d[3*r+1],d[3*r+2]);k.sub2(g,f);h.sub2(n,f);m.cross(k,h).normalize();l[3*p]+=m.x;l[3*p+1]+=m.y;l[3*p+2]+=m.z;l[3*q]+=m.x;l[3*q+1]+=m.y;l[3*q+2]+=m.z;l[3*r]+=m.x;l[3*r+1]+=m.y;l[3*r+
2]+=m.z}for(e=0;e<c;e++)d=l[3*e],b=l[3*e+1],a=l[3*e+2],d=1/Math.sqrt(d*d+b*b+a*a),l[3*e]*=d,l[3*e+1]*=d,l[3*e+2]*=d;return l};
pc.calculateTangents=function(d,b,a,c){var e=c.length/3,f=d.length/3,g=new pc.Vec3,n=new pc.Vec3,k=new pc.Vec3,h=new pc.Vec3,m=new pc.Vec3,l=new pc.Vec2,p=new pc.Vec2,q=new pc.Vec2,r,t=new Float32Array(3*f),u=new Float32Array(3*f),x=[];for(r=0;r<e;r++){var v=c[3*r];var y=c[3*r+1];var A=c[3*r+2];k.set(d[3*v],d[3*v+1],d[3*v+2]);h.set(d[3*y],d[3*y+1],d[3*y+2]);m.set(d[3*A],d[3*A+1],d[3*A+2]);l.set(a[2*v],a[2*v+1]);p.set(a[2*y],a[2*y+1]);q.set(a[2*A],a[2*A+1]);var z=h.x-k.x;var E=m.x-k.x;var C=h.y-k.y;
var D=m.y-k.y;var F=h.z-k.z;var I=m.z-k.z;var G=p.x-l.x;var B=q.x-l.x;var w=p.y-l.y;var H=q.y-l.y;var M=G*H-B*w;0==M?(g.set(0,1,0),n.set(1,0,0)):(M=1/M,g.set((H*z-w*E)*M,(H*C-w*D)*M,(H*F-w*I)*M),n.set((G*E-B*z)*M,(G*D-B*C)*M,(G*I-B*F)*M));t[3*v]+=g.x;t[3*v+1]+=g.y;t[3*v+2]+=g.z;t[3*y]+=g.x;t[3*y+1]+=g.y;t[3*y+2]+=g.z;t[3*A]+=g.x;t[3*A+1]+=g.y;t[3*A+2]+=g.z;u[3*v]+=n.x;u[3*v+1]+=n.y;u[3*v+2]+=n.z;u[3*y]+=n.x;u[3*y+1]+=n.y;u[3*y+2]+=n.z;u[3*A]+=n.x;u[3*A+1]+=n.y;u[3*A+2]+=n.z}w=new pc.Vec3;H=new pc.Vec3;
d=new pc.Vec3;a=new pc.Vec3;for(r=0;r<f;r++)d.set(b[3*r],b[3*r+1],b[3*r+2]),w.set(t[3*r],t[3*r+1],t[3*r+2]),H.set(u[3*r],u[3*r+1],u[3*r+2]),c=d.dot(w),a.copy(d).scale(c),a.sub2(w,a).normalize(),x[4*r]=a.x,x[4*r+1]=a.y,x[4*r+2]=a.z,a.cross(d,w),x[4*r+3]=0>a.dot(H)?-1:1;return x};
pc.createMesh=function(d,b,a){var c=a&&void 0!==a.normals?a.normals:null,e=a&&void 0!==a.tangents?a.tangents:null,f=a&&void 0!==a.colors?a.colors:null,g=a&&void 0!==a.uvs?a.uvs:null,n=a&&void 0!==a.uvs1?a.uvs1:null,k=a&&void 0!==a.indices?a.indices:null,h=a&&void 0!==a.blendIndices?a.blendIndices:null,m=a&&void 0!==a.blendWeights?a.blendWeights:null;a=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}];null!==c&&a.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32});
null!==e&&a.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.TYPE_FLOAT32});null!==f&&a.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0});null!==g&&a.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32});null!==n&&a.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.TYPE_FLOAT32});null!==h&&a.push({semantic:pc.SEMANTIC_BLENDINDICES,components:2,type:pc.TYPE_UINT8});null!==m&&a.push({semantic:pc.SEMANTIC_BLENDWEIGHT,components:2,type:pc.TYPE_FLOAT32});
var l=new pc.VertexFormat(d,a);a=b.length/3;l=new pc.VertexBuffer(d,l,a);for(var p=new pc.VertexIterator(l),q=0;q<a;q++)p.element[pc.SEMANTIC_POSITION].set(b[3*q],b[3*q+1],b[3*q+2]),null!==c&&p.element[pc.SEMANTIC_NORMAL].set(c[3*q],c[3*q+1],c[3*q+2]),null!==e&&p.element[pc.SEMANTIC_TANGENT].set(e[4*q],e[4*q+1],e[4*q+2],e[4*q+3]),null!==f&&p.element[pc.SEMANTIC_COLOR].set(f[4*q],f[4*q+1],f[4*q+2],f[4*q+3]),null!==g&&p.element[pc.SEMANTIC_TEXCOORD0].set(g[2*q],g[2*q+1]),null!==n&&p.element[pc.SEMANTIC_TEXCOORD1].set(n[2*
q],n[2*q+1]),null!==h&&p.element[pc.SEMANTIC_BLENDINDICES].set(h[2*q],h[2*q+1]),null!==m&&p.element[pc.SEMANTIC_BLENDWEIGHT].set(m[2*q],m[2*q+1]),p.next();p.end();c=null;if(e=null!==k)c=new pc.IndexBuffer(d,pc.INDEXFORMAT_UINT16,k.length),(new Uint16Array(c.lock())).set(k),c.unlock();f=new pc.BoundingBox;f.compute(b);d=new pc.Mesh(d);d.vertexBuffer=l;d.indexBuffer[0]=c;d.primitive[0].type=pc.PRIMITIVE_TRIANGLES;d.primitive[0].base=0;d.primitive[0].count=e?k.length:a;d.primitive[0].indexed=e;d.aabb=
f;return d};
pc.createTorus=function(d,b){var a=b&&void 0!==b.tubeRadius?b.tubeRadius:.2,c=b&&void 0!==b.ringRadius?b.ringRadius:.3,e=b&&void 0!==b.segments?b.segments:30,f=b&&void 0!==b.sides?b.sides:20;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g,n,k=[],h=[],m=[],l=[];for(g=0;g<=f;g++)for(n=0;n<=e;n++){var p=Math.cos(2*Math.PI*n/e)*(c+a*Math.cos(2*Math.PI*g/f));var q=Math.sin(2*Math.PI*g/f)*a;var r=Math.sin(2*Math.PI*n/e)*(c+a*Math.cos(2*Math.PI*g/f));var t=Math.cos(2*Math.PI*n/e)*Math.cos(2*
Math.PI*g/f);var u=Math.sin(2*Math.PI*g/f);var x=Math.sin(2*Math.PI*n/e)*Math.cos(2*Math.PI*g/f);var v=g/f;var y=1-n/e;k.push(p,q,r);h.push(t,u,x);m.push(v,y);g<f&&n<e&&(p=g*(e+1)+n,q=(g+1)*(e+1)+n,r=g*(e+1)+(n+1),t=(g+1)*(e+1)+(n+1),l.push(p,q,r),l.push(q,t,r))}a={normals:h,uvs:m,indices:l};b&&(a.tangents=pc.calculateTangents(k,h,m,l));return pc.createMesh(d,k,a)};
pc._createConeData=function(d,b,a,c,e,f){var g,n,k=new pc.Vec3,h=new pc.Vec3;var m=new pc.Vec3;var l=[],p=[],q=[],r=[],t=[];if(0<a)for(g=0;g<=c;g++)for(n=0;n<=e;n++){var u=n/e*2*Math.PI-Math.PI;var x=Math.sin(u);u=Math.cos(u);var v=new pc.Vec3(x*d,-a/2,u*d);var y=new pc.Vec3(x*b,a/2,u*b);k.lerp(v,y,g/c);h.sub2(y,v).normalize();x=new pc.Vec3(u,0,-x);m.cross(x,h).normalize();l.push(k.x,k.y,k.z);p.push(m.x,m.y,m.z);y=n/e;v=g/c;q.push(y,v);x=v;v=y;y=x;y/=3;y=y*primitiveUv1PaddingScale+primitiveUv1Padding;
v=v*primitiveUv1PaddingScale+primitiveUv1Padding;r.push(y,v);g<c&&n<e&&(x=g*(e+1)+n,u=g*(e+1)+(n+1),y=(g+1)*(e+1)+n,v=(g+1)*(e+1)+(n+1),t.push(x,u,y),t.push(u,v,y))}if(f){d=Math.floor(e/2);g=a/2;for(a=0;a<=d;a++)for(u=a*Math.PI*.5/d,x=Math.sin(u),u=Math.cos(u),k=0;k<=e;k++)f=2*k*Math.PI/e-Math.PI/2,y=Math.sin(f),f=Math.cos(f),f*=x,n=u,m=y*x,y=1-k/e,v=1-a/d,l.push(f*b,n*b+g,m*b),p.push(f,n,m),q.push(y,v),y/=3,v/=3,y=y*primitiveUv1PaddingScale+primitiveUv1Padding,v=v*primitiveUv1PaddingScale+primitiveUv1Padding,
y+=1/3,r.push(y,v);h=(c+1)*(e+1);for(a=0;a<d;++a)for(k=0;k<e;++k)x=a*(e+1)+k,u=x+e+1,t.push(h+x+1,h+u,h+x),t.push(h+x+1,h+u+1,h+u);for(a=0;a<=d;a++)for(u=.5*Math.PI+a*Math.PI*.5/d,x=Math.sin(u),u=Math.cos(u),k=0;k<=e;k++)f=2*k*Math.PI/e-Math.PI/2,y=Math.sin(f),f=Math.cos(f),f*=x,n=u,m=y*x,y=1-k/e,v=1-a/d,l.push(f*b,n*b-g,m*b),p.push(f,n,m),q.push(y,v),y/=3,v/=3,y=y*primitiveUv1PaddingScale+primitiveUv1Padding,v=v*primitiveUv1PaddingScale+primitiveUv1Padding,y+=2/3,r.push(y,v);h=(c+1)*(e+1)+(e+1)*
(d+1);for(a=0;a<d;++a)for(k=0;k<e;++k)x=a*(e+1)+k,u=x+e+1,t.push(h+x+1,h+u,h+x),t.push(h+x+1,h+u+1,h+u)}else{h=(c+1)*(e+1);if(0<d)for(g=0;g<e;g++)u=g/e*2*Math.PI,f=Math.sin(u),n=-a/2,m=Math.cos(u),y=1-(f+1)/2,v=(m+1)/2,l.push(f*d,n,m*d),p.push(0,-1,0),q.push(y,v),y/=3,v/=3,y=y*primitiveUv1PaddingScale+primitiveUv1Padding,v=v*primitiveUv1PaddingScale+primitiveUv1Padding,y+=1/3,r.push(y,v),1<g&&t.push(h,h+g,h+g-1);h+=e;if(0<b)for(g=0;g<e;g++)u=g/e*2*Math.PI,f=Math.sin(u),n=a/2,m=Math.cos(u),y=1-(f+
1)/2,v=(m+1)/2,l.push(f*b,n,m*b),p.push(0,1,0),q.push(y,v),y/=3,v/=3,y=y*primitiveUv1PaddingScale+primitiveUv1Padding,v=v*primitiveUv1PaddingScale+primitiveUv1Padding,y+=2/3,r.push(y,v),1<g&&t.push(h,h+g-1,h+g)}return{positions:l,normals:p,uvs:q,uvs1:r,indices:t}};
pc.createCylinder=function(d,b){var a=b&&(b.radius||b.baseRadius);a=void 0!==a?a:.5;var c=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=pc._createConeData(a,a,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:20,!1);c&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(d,b.positions,b)};
pc.createCapsule=function(d,b){var a=b&&void 0!==b.radius?b.radius:.3,c=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=pc._createConeData(a,a,(b&&void 0!==b.height?b.height:1)-2*a,b&&void 0!==b.heightSegments?b.heightSegments:1,b&&void 0!==b.sides?b.sides:20,!0);c&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(d,b.positions,b)};
pc.createCone=function(d,b){var a=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=pc._createConeData(b&&void 0!==b.baseRadius?b.baseRadius:.5,b&&void 0!==b.peakRadius?b.peakRadius:0,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:18,!1);a&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(d,b.positions,b)};
pc.createSphere=function(d,b){var a=b&&void 0!==b.radius?b.radius:.5,c=b&&void 0!==b.latitudeBands?b.latitudeBands:16,e=b&&void 0!==b.longitudeBands?b.longitudeBands:16;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var f,g=[],n=[],k=[],h=[];for(f=0;f<=c;f++){var m=f*Math.PI/c;var l=Math.sin(m);var p=Math.cos(m);for(m=0;m<=e;m++){var q=2*m*Math.PI/e-Math.PI/2;var r=Math.sin(q);q=Math.cos(q);q*=l;var t=p;r*=l;var u=1-m/e;var x=1-f/c;g.push(q*a,t*a,r*a);n.push(q,t,r);k.push(u,x)}}for(f=0;f<
c;++f)for(m=0;m<e;++m)a=f*(e+1)+m,l=a+e+1,h.push(a+1,l,a),h.push(a+1,l+1,l);c={normals:n,uvs:k,uvs1:k,indices:h};b&&(c.tangents=pc.calculateTangents(g,n,k,h));return pc.createMesh(d,g,c)};
pc.createPlane=function(d,b){var a=b&&void 0!==b.halfExtents?b.halfExtents:new pc.Vec2(.5,.5),c=b&&void 0!==b.widthSegments?b.widthSegments:5,e=b&&void 0!==b.lengthSegments?b.lengthSegments:5;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var f,g,n=[],k=[],h=[],m=[],l=0;for(f=0;f<=c;f++)for(g=0;g<=e;g++){var p=-a.x+2*a.x*f/c;var q=-(-a.y+2*a.y*g/e);var r=f/c;var t=g/e;n.push(p,0,q);k.push(0,1,0);h.push(r,t);f<c&&g<e&&(m.push(l+e+1,l+1,l),m.push(l+e+1,l+e+2,l+1));l++}a={normals:k,uvs:h,uvs1:h,
indices:m};b&&(a.tangents=pc.calculateTangents(n,k,h,m));return pc.createMesh(d,n,a)};
pc.createBox=function(d,b){var a=b&&void 0!==b.halfExtents?b.halfExtents:new pc.Vec3(.5,.5,.5),c=b&&void 0!==b.widthSegments?b.widthSegments:1,e=b&&void 0!==b.lengthSegments?b.lengthSegments:1,f=b&&void 0!==b.heightSegments?b.heightSegments:1;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g=[new pc.Vec3(-a.x,-a.y,a.z),new pc.Vec3(a.x,-a.y,a.z),new pc.Vec3(a.x,a.y,a.z),new pc.Vec3(-a.x,a.y,a.z),new pc.Vec3(a.x,-a.y,-a.z),new pc.Vec3(-a.x,-a.y,-a.z),new pc.Vec3(-a.x,a.y,-a.z),new pc.Vec3(a.x,
a.y,-a.z)],n=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],k=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[],m=[],l=[],p=[],q=[],r=0;a=function(a,b,c){var e,f;for(e=0;e<=b;e++)for(f=0;f<=c;f++){var d=new pc.Vec3;var t=new pc.Vec3;var u=new pc.Vec3,x=new pc.Vec3;d.lerp(g[n[a][0]],g[n[a][1]],e/b);t.lerp(g[n[a][0]],g[n[a][2]],f/c);u.sub2(t,g[n[a][0]]);x.add2(d,u);d=e/b;t=f/c;h.push(x.x,x.y,x.z);m.push(k[a][0],k[a][1],k[a][2]);l.push(d,t);d/=3;t/=3;d=d*primitiveUv1PaddingScale+primitiveUv1Padding;
t=t*primitiveUv1PaddingScale+primitiveUv1Padding;d+=a%3/3;t+=Math.floor(a/3)/3;p.push(d,t);e<b&&f<c&&(q.push(r+c+1,r+1,r),q.push(r+c+1,r+c+2,r+1));r++}};a(0,c,f);a(1,c,f);a(2,c,e);a(3,c,e);a(4,e,f);a(5,e,f);c={normals:m,uvs:l,uvs1:p,indices:q};b&&(c.tangents=pc.calculateTangents(h,m,l,q));return pc.createMesh(d,h,c)};pc.getDefaultMaterial=function(){return pc.Application.getApplication().scene.defaultMaterial};Object.assign(pc,function(){function d(a,b){return a.priority-b.priority}function b(a,b){return b.key-a.key}var a,c,e,f,g=[null,function(a,b){return a.drawOrder-b.drawOrder},function(b,e){a=b._key[pc.SORTKEY_FORWARD];c=e._key[pc.SORTKEY_FORWARD];return a===c&&b.mesh&&e.mesh?e.mesh.id-b.mesh.id:c-a},function(a,b){return b.zdist-a.zdist},function(a,b){return a.zdist-b.zdist}],n=0,k=function(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=
[]};k.prototype.clearVisibleLists=function(a){this.visibleOpaque[a]&&(this.visibleOpaque[a].length=0,this.visibleOpaque[a].list.length=0);this.visibleTransparent[a]&&(this.visibleTransparent[a].length=0,this.visibleTransparent[a].list.length=0)};var h=function(a){a=a||{};void 0!==a.id?(this.id=a.id,n=Math.max(this.id+1,n)):this.id=n++;this.name=a.name;this._refCounter=(this._enabled=void 0===a.enabled?!0:a.enabled)?1:0;this.opaqueSortMode=void 0===a.opaqueSortMode?pc.SORTMODE_MATERIALMESH:a.opaqueSortMode;
this.transparentSortMode=void 0===a.transparentSortMode?pc.SORTMODE_BACK2FRONT:a.transparentSortMode;this.renderTarget=a.renderTarget;this.shaderPass=void 0===a.shaderPass?pc.SHADER_FORWARD:a.shaderPass;this.passThrough=void 0===a.passThrough?!1:a.passThrough;this.overrideClear=void 0===a.overrideClear?!1:a.overrideClear;this._clearColor=new pc.Color(0,0,0,1);a.clearColor&&this._clearColor.copy(a.clearColor);this._clearColorBuffer=void 0===a.clearColorBuffer?!1:a.clearColorBuffer;this._clearDepthBuffer=
void 0===a.clearDepthBuffer?!1:a.clearDepthBuffer;this._clearStencilBuffer=void 0===a.clearStencilBuffer?!1:a.clearStencilBuffer;this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?pc.CLEARFLAG_COLOR:0)|(this._clearDepthBuffer?pc.CLEARFLAG_DEPTH:0)|(this._clearStencilBuffer?pc.CLEARFLAG_STENCIL:0)};this.onPreCull=a.onPreCull;this.onPreRender=a.onPreRender;this.onPreRenderOpaque=a.onPreRenderOpaque;
this.onPreRenderTransparent=a.onPreRenderTransparent;this.onPostCull=a.onPostCull;this.onPostRender=a.onPostRender;this.onPostRenderOpaque=a.onPostRenderOpaque;this.onPostRenderTransparent=a.onPostRenderTransparent;this.onDrawCall=a.onDrawCall;this.onEnable=a.onEnable;this.onDisable=a.onDisable;if(this._enabled&&this.onEnable)this.onEnable();this.instances=(this.layerReference=a.layerReference)?a.layerReference.instances:new k;this.cullingMask=a.cullingMask?a.cullingMask:4294967295;this.opaqueMeshInstances=
this.instances.opaqueMeshInstances;this.transparentMeshInstances=this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this.customCalculateSortValues=this.customSortCallback=null;this._lightComponents=[];this._lights=[];this._sortedLights=[[],[],[]];this.cameras=[];this._dirtyCameras=this._dirtyLights=this._dirty=!1;this._staticLightHash=this._lightHash=this._cameraHash=0;this._needsStaticPrepare=!0;this._staticPrepareDone=!1;this._shaderVersion=-1;this._version=
0;this._lightCube=null};Object.defineProperty(h.prototype,"enabled",{get:function(){return this._enabled},set:function(a){if(a!==this._enabled)if(this._enabled=a){if(this.incrementCounter(),this.onEnable)this.onEnable()}else if(this.decrementCounter(),this.onDisable)this.onDisable()}});Object.defineProperty(h.prototype,"clearColor",{get:function(){return this._clearColor},set:function(a){this._clearColor.copy(a)}});h.prototype._updateClearFlags=function(){var a=0;this._clearColorBuffer&&(a|=pc.CLEARFLAG_COLOR);
this._clearDepthBuffer&&(a|=pc.CLEARFLAG_DEPTH);this._clearStencilBuffer&&(a|=pc.CLEARFLAG_STENCIL);this._clearOptions.flags=a};Object.defineProperty(h.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(a){this._clearColorBuffer=a;this._updateClearFlags()}});Object.defineProperty(h.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(a){this._clearDepthBuffer=a;this._updateClearFlags()}});Object.defineProperty(h.prototype,"clearStencilBuffer",
{get:function(){return this._clearStencilBuffer},set:function(a){this._clearStencilBuffer=a;this._updateClearFlags()}});h.prototype.incrementCounter=function(){if(0===this._refCounter&&(this._enabled=!0,this.onEnable))this.onEnable();this._refCounter++};h.prototype.decrementCounter=function(){if(1===this._refCounter){if(this._enabled=!1,this.onDisable)this.onDisable()}else if(0===this._refCounter)return;this._refCounter--};h.prototype.addMeshInstances=function(a,b){for(var c=this._shaderVersion,e,
f,g,d=this.shadowCasters,k=0;k<a.length;k++)e=a[k],g=e.material,f=g.blendType===pc.BLEND_NONE?this.opaqueMeshInstances:this.transparentMeshInstances,0>f.indexOf(e)&&f.push(e),!b&&e.castShadow&&0>d.indexOf(e)&&d.push(e),!this.passThrough&&0<=c&&g._shaderVersion!==c&&(g.updateShader!==pc.Material.prototype.updateShader&&(g.clearVariants(),g.shader=null),g._shaderVersion=c);this.passThrough||(this._dirty=!0)};h.prototype.removeMeshInstances=function(a,b){var c,e,f=this.opaqueMeshInstances,g=this.transparentMeshInstances,
d=this.shadowCasters;for(c=0;c<a.length;c++){var k=a[c];var h=-1;var n=0;var m=f.length;for(e=0;e<m;e++){var l=f[e];if(l===k){h=e;n=1;break}if(l._staticSource===k)0>h&&(h=e),n++;else if(0<=h)break}0<=h&&f.splice(h,n);h=-1;n=0;m=g.length;for(e=0;e<m;e++){l=g[e];if(l===k){h=e;n=1;break}if(l._staticSource===k)0>h&&(h=e),n++;else if(0<=h)break}0<=h&&g.splice(h,n);b||(e=d.indexOf(k),0<=e&&d.splice(e,1))}this._dirty=!0};h.prototype.clearMeshInstances=function(a){if(0!==this.opaqueMeshInstances.length||
0!==this.transparentMeshInstances.length||!a&&0!==this.shadowCasters.length)this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,a||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0)};h.prototype.addLight=function(a){0<=this._lightComponents.indexOf(a)||(this._lightComponents.push(a),this._lights.push(a.light),this._dirtyLights=!0,this._generateLightHash())};h.prototype.removeLight=function(a){var b=this._lightComponents.indexOf(a);0>b||(this._lightComponents.splice(b,
1),b=this._lights.indexOf(a.light),this._lights.splice(b,1),this._dirtyLights=!0,this._generateLightHash())};h.prototype.clearLights=function(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=!0};h.prototype.addShadowCasters=function(a){for(var b,c=this.shadowCasters,e=0;e<a.length;e++)b=a[e],b.castShadow&&0>c.indexOf(b)&&c.push(b);this._dirtyLights=!0};h.prototype.removeShadowCasters=function(a){for(var b,c=this.shadowCasters,e=0;e<a.length;e++)b=c.indexOf(a[e]),0<=b&&c.splice(b,
1);this._dirtyLights=!0};h.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(b);for(var a="",c="",e=0;e<this._lights.length;e++)this._lights[e].isStatic?c+=this._lights[e].key:a+=this._lights[e].key;this._lightHash=0===a.length?0:pc.hashCode(a);this._staticLightHash=0===c.length?0:pc.hashCode(c)}else this._staticLightHash=this._lightHash=0};h.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(d);for(var a="",b=0;b<this.cameras.length;b++)a+=
this.cameras[b].entity.getGuid();this._cameraHash=pc.hashCode(a)}else this._cameraHash=0;this._dirtyCameras=!0};h.prototype.addCamera=function(a){0<=this.cameras.indexOf(a)||(this.cameras.push(a),this._generateCameraHash())};h.prototype.removeCamera=function(a){a=this.cameras.indexOf(a);0>a||(this.cameras.splice(a,1),this._generateCameraHash(),this.instances.clearVisibleLists(a))};h.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0;this._dirtyCameras=!0};h.prototype._sortCameras=
function(){this._generateCameraHash()};h.prototype._calculateSortDistances=function(a,b,c,e){var f;for(f=0;f<b;f++){var g=a[f];if(!(g.command||g.layer<=pc.LAYER_FX))if(g.calculateSortDistance)g.zdist=g.calculateSortDistance(g,c,e);else{var d=g.aabb.center;var k=d.x-c.x;var h=d.y-c.y;d=d.z-c.z;g.zdist=k*e.x+h*e.y+d*e.z}}};h.prototype._sortVisible=function(a,b,c){var d=this.instances,k=a?this.transparentSortMode:this.opaqueSortMode;if(k!==pc.SORTMODE_NONE)if(a=a?d.visibleTransparent[c]:d.visibleOpaque[c],
k===pc.SORTMODE_CUSTOM)e=b.getPosition(),f=b.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,e,f),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback);else{if(k===pc.SORTMODE_BACK2FRONT||k===pc.SORTMODE_FRONT2BACK)e=b.getPosition(),f=b.forward,this._calculateSortDistances(a.list,a.length,e,f);a.list.length!==a.length&&(a.list.length=a.length);a.list.sort(g[k])}};return{Layer:h,InstanceList:k,VisibleInstanceList:function(){this.list=
[];this.length=0;this.done=!1}}}());Object.assign(pc,function(){var d=function(){pc.EventHandler.call(this);this.layerList=[];this.subLayerList=[];this.subLayerEnabled=[];this._opaqueOrder={};this._transparentOrder={};this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1;this._meshInstances=[];this._lights=[];this.cameras=[];this._sortedLights=[[],[],[]];this._lightShadowCasters=[];this._globalLightCameras=[];this._globalLightCameraIds=[];this._renderedRt=[];this._renderedByCam=[];this._renderedLayer=[];this._renderList=
[];this._renderListCamera=[]};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype._sortLights=function(b){var a=b._lights;b._sortedLights[pc.LIGHTTYPE_DIRECTIONAL].length=0;b._sortedLights[pc.LIGHTTYPE_POINT].length=0;for(var c=b._sortedLights[pc.LIGHTTYPE_SPOT].length=0;c<a.length;c++){var e=a[c];e.enabled&&b._sortedLights[e._type].push(e)}};d.prototype._update=function(){var b,a,c=this.layerList.length,e=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(b=
0;b<c;b++){var f=this.layerList[b];f._dirty&&(this._dirty=!0);f._dirtyLights&&(this._dirtyLights=!0);f._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){e|=pc.COMPUPDATED_INSTANCES;for(b=this._meshInstances.length=0;b<c;b++)if(f=this.layerList[b],!f.passThrough){var g=f.opaqueMeshInstances;for(a=0;a<g.length;a++){var d=g[a];0>this._meshInstances.indexOf(d)&&(this._meshInstances.push(d),d.material&&d.material._dirtyBlend&&(this._dirtyBlend=!0,d.material._dirtyBlend=!1))}g=f.transparentMeshInstances;
for(a=0;a<g.length;a++)d=g[a],0>this._meshInstances.indexOf(d)&&(this._meshInstances.push(d),d.material&&d.material._dirtyBlend&&(this._dirtyBlend=!0,d.material._dirtyBlend=!1))}for(b=0;b<c;b++)this.layerList[b]._dirty=!1,this.layerList[b]._version++;this._dirty=!1}if(this._dirtyBlend){e|=pc.COMPUPDATED_BLEND;for(b=0;b<c;b++)if(f=this.layerList[b],!f.passThrough){g=f.opaqueMeshInstances;d=f.transparentMeshInstances;var k=[];var h=[];for(a=0;a<g.length;a++)g[a].material&&g[a].material.blendType!==
pc.BLEND_NONE?h.push(g[a]):k.push(g[a]);for(a=0;a<d.length;a++)d[a].material&&d[a].material.blendType!==pc.BLEND_NONE?h.push(d[a]):k.push(d[a]);f.opaqueMeshInstances.length=k.length;for(a=0;a<k.length;a++)f.opaqueMeshInstances[a]=k[a];f.transparentMeshInstances.length=h.length;for(a=0;a<h.length;a++)f.transparentMeshInstances[a]=h[a]}this._dirtyBlend=!1}if(this._dirtyLights){e|=pc.COMPUPDATED_LIGHTS;this._lights.length=0;for(b=this._lightShadowCasters.length=0;b<c;b++)for(f=this.layerList[b],g=f._lights,
a=0;a<g.length;a++)k=g[a],d=this._lights.indexOf(k),0>d&&(this._lights.push(k),d=this._lights.length-1),(k=this._lightShadowCasters[d])||(this._lightShadowCasters[d]=[]);this._sortLights(this);this._dirtyLights=!1;for(b=0;b<c;b++)f=this.layerList[b],this._sortLights(f),f._dirtyLights=!1}if(e)for(b=0;b<c;b++)for(f=this.layerList[b],g=f._lights,a=0;a<g.length;a++){k=g[a];d=this._lights.indexOf(k);k=this._lightShadowCasters[d];h=f.shadowCasters;for(d=0;d<k.length;)0>this._meshInstances.indexOf(k[d])?
(k[d]=k[k.length-1],--k.length):d++;for(d=0;d<h.length;d++)0>k.indexOf(h[d])&&k.push(h[d])}if(e&pc.COMPUPDATED_LIGHTS||this._dirtyCameras)for(this._globalLightCameras.length=0,g=this._sortedLights[pc.LIGHTTYPE_DIRECTIONAL],a=0;a<g.length;a++)for(k=g[a],this._globalLightCameras[a]=[],b=0;b<c;b++)if(f=this.layerList[b],!(0>f._sortedLights[pc.LIGHTTYPE_DIRECTIONAL].indexOf(k)))for(d=0;d<f.cameras.length;d++)0<=this._globalLightCameras[a].indexOf(f.cameras[d])||this._globalLightCameras[a].push(f.cameras[d]);
if(this._dirtyCameras){e|=pc.COMPUPDATED_CAMERAS;for(b=this.cameras.length=0;b<c;b++)for(f=this.layerList[b],a=0;a<f.cameras.length;a++)g=f.cameras[a],d=this.cameras.indexOf(g),0>d&&this.cameras.push(g);this._renderList.length=0;for(b=d=this._renderListCamera.length=0;b<c;b++)if(d)d--;else if(f=this.layerList[b],0!==f.cameras.length||f.isPostEffect)if(k=f._cameraHash,0===k)this._renderList.push(b),this._renderListCamera.push(0);else{g=1;for(a=b+1;a<c;a++)if(h=this.layerList[a]._cameraHash,k!==h){g=
a-b-1;break}else a===c-1&&(g=a-b);if(1===g)for(k=0;k<f.cameras.length;k++)this._renderList.push(b),this._renderListCamera.push(k);else{for(k=0;k<f.cameras.length;k++)for(a=0;a<=g;a++)this._renderList.push(b+a),this._renderListCamera.push(k);d=g}}this._dirtyCameras=!1;for(b=0;b<c;b++)this.layerList[b]._dirtyCameras=!1}if(e&pc.COMPUPDATED_LIGHTS||e&pc.COMPUPDATED_CAMERAS)for(a=this._globalLightCameraIds.length=0;a<this._globalLightCameras.length;a++){g=[];for(b=0;b<this._globalLightCameras[a].length;b++)d=
this.cameras.indexOf(this._globalLightCameras[a][b]),0>d||g.push(d);this._globalLightCameraIds.push(g)}return e};d.prototype._isLayerAdded=function(b){return 0<=this.layerList.indexOf(b)?!0:!1};d.prototype._isSublayerAdded=function(b,a){for(var c=0;c<this.layerList.length;c++)if(this.layerList[c]===b&&this.subLayerList[c]===a)return!0;return!1};d.prototype.push=function(b){this._isLayerAdded(b)||(this.layerList.push(b),this.layerList.push(b),this._opaqueOrder[b.id]=this.subLayerList.push(!1)-1,this._transparentOrder[b.id]=
this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.prototype.insert=function(b,a){if(!this._isLayerAdded(b)){this.layerList.splice(a,0,b,b);this.subLayerList.splice(a,0,!1,!0);var c=this.layerList.length;this._updateOpaqueOrder(a,c-1);this._updateTransparentOrder(a,c-1);this.subLayerEnabled.splice(a,0,!0,!0);this._dirtyCameras=this._dirtyLights=this._dirty=!0;this.fire("add",b)}};d.prototype.remove=
function(b){var a=this.layerList.indexOf(b);delete this._opaqueOrder[a];for(delete this._transparentOrder[a];0<=a;)this.layerList.splice(a,1),this.subLayerList.splice(a,1),this.subLayerEnabled.splice(a,1),a=this.layerList.indexOf(b),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",b);b=this.layerList.length;this._updateOpaqueOrder(0,b-1);this._updateTransparentOrder(0,b-1)};d.prototype.pushOpaque=function(b){this._isSublayerAdded(b,!1)||(this.layerList.push(b),this._opaqueOrder[b.id]=
this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.prototype.insertOpaque=function(b,a){this._isSublayerAdded(b,!1)||(this.layerList.splice(a,0,b),this.subLayerList.splice(a,0,!1),this._updateOpaqueOrder(a,this.subLayerList.length-1),this.subLayerEnabled.splice(a,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.prototype.removeOpaque=function(b){for(var a=0,c=this.layerList.length;a<
c;a++)if(this.layerList[a]===b&&!this.subLayerList[a]){this.layerList.splice(a,1);this.subLayerList.splice(a,1);c--;this._updateOpaqueOrder(a,c-1);this.subLayerEnabled.splice(a,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(b)&&this.fire("remove",b);break}};d.prototype.pushTransparent=function(b){this._isSublayerAdded(b,!0)||(this.layerList.push(b),this._transparentOrder[b.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=
this._dirty=!0,this.fire("add",b))};d.prototype.insertTransparent=function(b,a){this._isSublayerAdded(b,!0)||(this.layerList.splice(a,0,b),this.subLayerList.splice(a,0,!0),this._updateTransparentOrder(a,this.subLayerList.length-1),this.subLayerEnabled.splice(a,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.prototype.removeTransparent=function(b){for(var a=0,c=this.layerList.length;a<c;a++)if(this.layerList[a]===b&&this.subLayerList[a]){this.layerList.splice(a,1);
this.subLayerList.splice(a,1);c--;this._updateTransparentOrder(a,c-1);this.subLayerEnabled.splice(a,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(b)&&this.fire("remove",b);break}};d.prototype._getSublayerIndex=function(b,a){var c=this.layerList.indexOf(b);return 0>c||this.subLayerList[c]!==a&&(c=this.layerList.indexOf(b,c+1),0>c||this.subLayerList[c]!==a)?-1:c};d.prototype.getOpaqueIndex=function(b){return this._getSublayerIndex(b,!1)};d.prototype.getTransparentIndex=
function(b){return this._getSublayerIndex(b,!0)};d.prototype.getLayerById=function(b){for(var a=0;a<this.layerList.length;a++)if(this.layerList[a].id===b)return this.layerList[a];return null};d.prototype.getLayerByName=function(b){for(var a=0;a<this.layerList.length;a++)if(this.layerList[a].name===b)return this.layerList[a];return null};d.prototype._updateOpaqueOrder=function(b,a){for(;b<=a;b++)!1===this.subLayerList[b]&&(this._opaqueOrder[this.layerList[b].id]=b)};d.prototype._updateTransparentOrder=
function(b,a){for(;b<=a;b++)!0===this.subLayerList[b]&&(this._transparentOrder[this.layerList[b].id]=b)};d.prototype._sortLayersDescending=function(b,a,c){var e,f=-1,g=-1;var d=0;for(e=b.length;d<e;d++){var k=b[d];c.hasOwnProperty(k)&&(f=Math.max(f,c[k]))}d=0;for(e=a.length;d<e;d++)k=a[d],c.hasOwnProperty(k)&&(g=Math.max(g,c[k]));return-1===f&&-1!==g?1:-1===g&&-1!==f?-1:g-f};d.prototype.sortTransparentLayers=function(b,a){return this._sortLayersDescending(b,a,this._transparentOrder)};d.prototype.sortOpaqueLayers=
function(b,a){return this._sortLayersDescending(b,a,this._opaqueOrder)};return{LayerComposition:d}}());Object.assign(pc,function(){pc.SPRITE_RENDERMODE_SIMPLE=0;pc.SPRITE_RENDERMODE_SLICED=1;pc.SPRITE_RENDERMODE_TILED=2;var d=[0,0,1,0,0,1,0,0,1,0,0,1],b=[0,1,3,2,3,1],a=function(a,b){pc.EventHandler.call(this);this._device=a;this._pixelsPerUnit=b&&void 0!==b.pixelsPerUnit?b.pixelsPerUnit:1;this._renderMode=b&&void 0!==b.renderMode?b.renderMode:pc.SPRITE_RENDERMODE_SIMPLE;this._atlas=b&&void 0!==b.atlas?b.atlas:null;this._frameKeys=b&&void 0!==b.frameKeys?b.frameKeys:null;this._meshes=[];this._meshesDirty=
this._updatingProperties=!1;this._atlas&&this._frameKeys&&this._createMeshes()};a.prototype=Object.create(pc.EventHandler.prototype);a.prototype.constructor=a;a.prototype._createMeshes=function(){var a;var b=0;for(a=this._meshes.length;b<a;b++){var f=this._meshes[b];if(f){f.vertexBuffer.destroy();for(var g=0,d=f.indexBuffer.length;g<d;g++)f.indexBuffer[g].destroy()}}a=this._frameKeys.length;this._meshes=Array(a);f=this.renderMode===pc.SPRITE_RENDERMODE_SLICED||this._renderMode===pc.SPRITE_RENDERMODE_TILED?
this._create9SliceMesh:this._createSimpleMesh;for(b=0;b<a;b++)g=this._atlas.frames[this._frameKeys[b]],this._meshes[b]=g?f.call(this,g):null;this.fire("set:meshes")};a.prototype._createSimpleMesh=function(a){var c=a.rect,f=this._atlas.texture.width,g=this._atlas.texture.height,n=c.z/this._pixelsPerUnit,k=c.w/this._pixelsPerUnit,h=a.pivot.x;a=a.pivot.y;var m=c.x/f,l=c.y/g;f=(c.x+c.z)/f;c=(c.y+c.w)/g;return pc.createMesh(this._device,[-h*n,-a*k,0,(1-h)*n,-a*k,0,(1-h)*n,(1-a)*k,0,-h*n,(1-a)*k,0],{uvs:[m,
l,f,l,f,c,m,c],normals:d,indices:b})};a.prototype._create9SliceMesh=function(){var a=pc.Vec2.ONE,b,f,g=[],d=[],k=[],h=[],m=0;for(b=0;3>=b;b++){var l=0===b||3===b?0:1;for(f=0;3>=f;f++){var p=-a.x+2*a.x*(1>=b?0:3)/3;var q=-(-a.y+2*a.y*(1>=f?0:3)/3);var r=0===f||3===f?0:1;g.push(-p,0,q);d.push(0,1,0);k.push(l,r);3>b&&3>f&&(h.push(m+3+1,m+1,m),h.push(m+3+1,m+3+2,m+1));m++}}return pc.createMesh(this._device,g,{normals:d,uvs:k,indices:h})};a.prototype._onSetFrames=function(a){this._updatingProperties?this._meshesDirty=
!0:this._createMeshes()};a.prototype._onFrameChanged=function(a,b){a=this._frameKeys.indexOf(a);0>a||(b?this.renderMode===pc.SPRITE_RENDERMODE_SIMPLE&&(this._meshes[a]=this._createSimpleMesh(b)):this._meshes[a]=null,this.fire("set:meshes"))};a.prototype._onFrameRemoved=function(a){a=this._frameKeys.indexOf(a);0>a||(this._meshes[a]=null,this.fire("set:meshes"))};a.prototype.startUpdate=function(){this._updatingProperties=!0;this._meshesDirty=!1};a.prototype.endUpdate=function(){this._updatingProperties=
!1;this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes();this._meshesDirty=!1};a.prototype.destroy=function(){var a;var b=0;for(a=this._meshes.length;b<a;b++){var f=this._meshes[b];if(f){f.vertexBuffer.destroy();for(var g=0,d=f.indexBuffer.length;g<d;g++)f.indexBuffer[g].destroy()}}this._meshes.length=0};Object.defineProperty(a.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(a){this._frameKeys=a;this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=
!0:this._createMeshes());this.fire("set:frameKeys",a)}});Object.defineProperty(a.prototype,"atlas",{get:function(){return this._atlas},set:function(a){a!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=a)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",
this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",a))}});Object.defineProperty(a.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=a,this.fire("set:pixelsPerUnit",a),this._atlas&&this._frameKeys&&this.renderMode===pc.SPRITE_RENDERMODE_SIMPLE&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}});Object.defineProperty(a.prototype,"renderMode",
{get:function(){return this._renderMode},set:function(a){if(this._renderMode!==a){var b=this._renderMode;this._renderMode=a;this.fire("set:renderMode",a);(b===pc.SPRITE_RENDERMODE_SIMPLE||a===pc.SPRITE_RENDERMODE_SIMPLE)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}});Object.defineProperty(a.prototype,"meshes",{get:function(){return this._meshes}});return{Sprite:a}}());Object.assign(pc,function(){var d=function(){this._index=[];this._values=[]};d.prototype.runSync=function(){for(var a=0,b=this._values.length;a<b;a++)this._values[a].syncHierarchy();this._values.length=0;this._index.length=0};d.prototype.erase=function(a){a=this._values.indexOf(a);0<=a&&(this._index.splice(a,1),this._values.splice(a,1))};var b=function(a,c,e,f){if(c===e)return c;var g=Math.floor((c+e)/2);return a[g]>f?b(a,c,g,f):a[g]<f?b(a,g+1,e,f):g};d.prototype.push=function(a,c){var e=b(this._index,
0,this._index.length,a);this._values.splice(e,0,c);this._index.splice(e,0,a)};return{SyncQueue:d}}());Object.assign(pc,function(){var d=function(){pc.EventHandler.call(this);this._frames=this._texture=null};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype.setFrame=function(b,a){var c=this._frames[b];c?(c.rect.copy(a.rect),c.pivot.copy(a.pivot),c.border.copy(a.border)):(c={rect:a.rect.clone(),pivot:a.pivot.clone(),border:a.border.clone()},this._frames[b]=c);this.fire("set:frame",b.toString(),c)};d.prototype.removeFrame=function(b){var a=this._frames[b];a&&
(delete this._frames[b],this.fire("remove:frame",b.toString(),a))};d.prototype.destroy=function(){this._texture&&this._texture.destroy()};Object.defineProperty(d.prototype,"texture",{get:function(){return this._texture},set:function(b){this._texture=b;this.fire("set:texture",b)}});Object.defineProperty(d.prototype,"frames",{get:function(){return this._frames},set:function(b){this._frames=b;this.fire("set:frames",b)}});return{TextureAtlas:d}}());Object.assign(pc,function(){var d=function(b){this.func=void 0===b.func?pc.FUNC_ALWAYS:b.func;this.ref=b.ref||0;this.readMask=void 0===b.readMask?255:b.readMask;this.writeMask=void 0===b.writeMask?255:b.writeMask;this.fail=b.fail||pc.STENCILOP_KEEP;this.zfail=b.zfail||pc.STENCILOP_KEEP;this.zpass=b.zpass||pc.STENCILOP_KEEP};d.prototype.clone=function(){return new pc.StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})};
return{StencilParameters:d}}());Object.assign(pc,function(){var d=function(a,b){this._components=a;this._data=b};Object.defineProperties(d.prototype,{components:{get:function(){return this._components}},data:{get:function(){return this._data}}});var b=function(){this._left=Infinity;this._right=-Infinity;this._t=this._p1=this._p0=this._recip=this._len=0;this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}};Object.assign(b.prototype,{update:function(a,b){if(a<this._left||a>=this._right){var c=b.length;c?a<b[0]?(this._left=-Infinity,this._right=
b[0],this._p0=this._p1=this._recip=this._len=0):a>=b[c-1]?(this._left=b[c-1],this._right=Infinity,this._recip=this._len=0,this._p0=this._p1=c-1):(c=this._findKey(a,b),this._left=b[c],this._right=b[c+1],this._len=this._right-this._left,b=1/this._len,this._recip=isFinite(b)?b:0,this._p0=c,this._p1=c+1):(this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?0:(a-this._left)*this._recip;this._hermite.valid=!1},_findKey:function(a,b){for(var c=0;a>=
b[c+1];)c++;return c},eval:function(a,b,c){var e=c._data;c=c._components;var f=this._p0*c,g;if(b===pc.INTERPOLATION_STEP)for(g=0;g<c;++g)a[g]=e[f+g];else{var d=this._t,k=this._p1*c;switch(b){case pc.INTERPOLATION_LINEAR:for(g=0;g<c;++g)a[g]=pc.math.lerp(e[f+g],e[k+g],d);break;case pc.INTERPOLATION_CUBIC:b=this._hermite;b.valid||(g=d*d,f=d+d,k=1-d,k*=k,b.valid=!0,b.p0=(1+f)*k,b.m0=d*k,b.p1=g*(3-f),b.m1=g*(d-1));d=(3*this._p0+1)*c;f=(3*this._p0+2)*c;k=(3*this._p1+1)*c;var h=3*this._p1*c;for(g=0;g<c;++g)a[g]=
b.p0*e[d+g]+b.m0*e[f+g]*this._len+b.p1*e[k+g]+b.m1*e[h+g]*this._len}}}});var a=function(a,b,c,e){this._paths=a;this._input=b;this._output=c;this._interpolation=e};Object.defineProperties(a.prototype,{paths:{get:function(){return this._paths}},input:{get:function(){return this._input}},output:{get:function(){return this._output}},interpolation:{get:function(){return this._interpolation}}});var c=function(a,b,c,e,f){this._name=a;this._duration=b;this._inputs=c;this._outputs=e;this._curves=f};Object.defineProperties(c.prototype,
{name:{get:function(){return this._name}},duration:{get:function(){return this._duration}},inputs:{get:function(){return this._inputs}},outputs:{get:function(){return this._outputs}},curves:{get:function(){return this._curves}}});Object.assign(c.prototype,{eval:function(a,b){b._time=a;var c=this._inputs,e=this._outputs,f=this._curves,g=b._cache;b=b._results;var d;for(d=0;d<c.length;++d)g[d].update(a,c[d]._data);for(d=0;d<f.length;++d)a=f[d],g[a._input].eval(b[d],a._interpolation,e[a._output])}});
var e=function(a){this._name=a.name+"Snapshot";this._time=-1;this._cache=[];this._results=[];var c;for(c=0;c<a._inputs.length;++c)this._cache[c]=new b;var e=a._curves;a=a._outputs;for(c=0;c<e.length;++c){for(var f=a[e[c]._output],g=[],d=0;d<f._components;++d)g[d]=0;this._results[c]=g}},f=function(a,b,c,f,g){this._name=a.name;this._track=a;this._snapshot=new e(a);this._playing=f;this._time=b;this._speed=c;this._loop=g;this._blendWeight=1;this._blendOrder=0};Object.defineProperties(f.prototype,{name:{get:function(){return this._name},
set:function(a){this._name=a}},track:{get:function(){return this._track}},snapshot:{get:function(){return this._snapshot}},time:{get:function(){return this._time},set:function(a){this._time=a}},speed:{get:function(){return this._speed},set:function(a){this._speed=a}},loop:{get:function(){return this._loop},set:function(a){this._loop=a}},blendWeight:{get:function(){return this._blendWeight},set:function(a){this._blendWeight=a}},blendOrder:{get:function(){return this._blendOrder},set:function(a){this._blendOrder=
a}}});Object.assign(f.prototype,{_update:function(a){if(this._playing){var b=this._time,c=this._track.duration,e=this._speed,f=this._loop;b+=e*a;0<=e?b>c&&(f?b=b%c||0:(b=this._track.duration,this.pause())):0>b&&(f?b=c+(b%c||0):(b=0,this.pause()));this._time=b}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)},play:function(){this._playing=!0;this._time=0},stop:function(){this._playing=!1;this._time=0},pause:function(){this._playing=!1},resume:function(){this._playing=!0},
reset:function(){this._time=0}});var g=function(a,b,c){this._func=a;this._type=b;this._components=c};Object.defineProperties(g.prototype,{func:{get:function(){return this._func}},type:{get:function(){return this._type}},components:{get:function(){return this._components}}});var n=function(){};n.joinPath=function(a){return a.map(function(a){return a.replace(/\\/g,"\\\\").replace(/\./g,"\\.")}).join(".")};n.splitPath=function(a){for(var b=[],c="",e=0;e<a.length;){var f=a[e++];"\\"===f&&e<a.length?(f=
a[e++],c="\\"===f||"."===f?c+f:c+("\\"+f)):"."===f?(b.push(c),c=""):c+=f}0<c.length&&b.push(c);return b};Object.assign(n.prototype,{resolve:function(a){return null},unresolve:function(a){},update:function(a){}});var k=function(a){var b={},c=function(a){b[a.name]={node:a,count:0};for(var e=0;e<a.children.length;++e)c(a.children[e])};c(a);this.nodes=b;this.activeNodes=[];this.handlers={translation:function(a){var b=a.localPosition;return new pc.AnimTarget(function(a){b.set.apply(b,a)},"vector",3)},
rotation:function(a){var b=a.localRotation;return new pc.AnimTarget(function(a){b.set.apply(b,a)},"quaternion",4)},scale:function(a){var b=a.localScale;return new pc.AnimTarget(function(a){b.set.apply(b,a)},"vector",3)},weights:function(a){for(var b=a;b&&b.constructor!==pc.Entity;)b=b.parent;if(!(b&&b.model&&b.model.model&&b.model.model.morphInstances&&b.model.model.morphInstances[0]))return null;b=b.model.model.morphInstances[0];return new pc.AnimTarget(function(a){for(var c=0;c<a.length;++c)b.setWeight(c,
a[c])},"vector",b.morph._targets.length)}}};Object.assign(k.prototype,{resolve:function(a){var b=this._getParts(a);if(!b)return null;a=this.nodes[b[0]];if(!a)return null;b=this.handlers[b[1]];if(!b)return null;b=b(a.node);if(!b)return null;0===a.count&&this.activeNodes.push(a.node);a.count++;return b},unresolve:function(a){if(a=this._getParts(a)){var b=this.nodes[a[0]];b.count--;if(0===b.count){a=this.activeNodes;b=a.indexOf(b.node);var c=a.length;b<c-1&&(a[b]=a[c-1]);a.pop()}}},update:function(a){a=
this.activeNodes;for(var b=0;b<a.length;++b)a[b]._dirtifyLocal()},_getParts:function(a){a=n.splitPath(a);return 2===a.length&&this.nodes.hasOwnProperty(a[0])&&this.handlers.hasOwnProperty(a[1])?a:null}});var h=function(a){this._binder=a;this._clips=[];this._inputs=[];this._outputs=[];this._targets={}};Object.defineProperties(h.prototype,{clips:{get:function(){return this._clips}}});h._dot=function(a,b){for(var c=a.length,e=0,f=0;f<c;++f)e+=a[f]*b[f];return e};h._normalize=function(a){var b=h._dot(a,
a);if(0<b){b=1/Math.sqrt(b);for(var c=a.length,e=0;e<c;++e)a[e]*=b}};h._set=function(a,b,c){var e=a.length;if("quaternion"===c){var f=h._dot(b,b);0<f&&(f=1/Math.sqrt(f));for(c=0;c<e;++c)a[c]=b[c]*f}else for(c=0;c<e;++c)a[c]=b[c]};h._blendVec=function(a,b,c){for(var e=1-c,f=a.length,g=0;g<f;++g)a[g]=a[g]*e+b[g]*c};h._blendQuat=function(a,b,c){var e=a.length,f=1-c;0>h._dot(a,b)&&(c=-c);for(var g=0;g<e;++g)a[g]=a[g]*f+b[g]*c;h._normalize(a)};h._blend=function(a,b,c,e){"quaternion"===e?h._blendQuat(a,
b,c):h._blendVec(a,b,c)};h._stableSort=function(a,b){for(var c=a.length,e=0;e<c-1;++e)for(var f=e+1;f<c;++f)if(b(a[f],a[e])){var g=a[e];a[e]=a[f];a[f]=g}};Object.assign(h.prototype,{addClip:function(a){for(var b=this._targets,c=a.track.curves,e=a.snapshot,f=[],g=[],d=0;d<c.length;++d)for(var k=c[d].paths,h=0;h<k.length;++h){var n=k[h],m=b[n];if(!m){var z=this._binder.resolve(n);if(z){m={target:z,value:[],curves:0,blendCounter:0};for(z=0;z<m.target.components;++z)m.value.push(0);b[n]=m}}m&&(m.curves++,
f.push(e._results[d]),g.push(m))}this._clips.push(a);this._inputs.push(f);this._outputs.push(g)},removeClip:function(a){for(var b=this._targets,c=this._clips,e=c[a].track.curves,f=0;f<e.length;++f)for(var g=e[f].paths,d=0;d<g.length;++d){var k=g[d],h=b[k];h&&(h.curves--,0===h.curves&&(this._binder.unresolve(k),delete b[k]))}c.splice(a,1);this._inputs.splice(a,1);this._outputs.splice(a,1)},removeClips:function(){for(;0<this._clips.length;)this.removeClip(0)},findClip:function(a){for(var b=this._clips,
c=0;c<b.length;++c){var e=b[c];if(e.name===a)return e}return null},update:function(a){var b=this._clips,c=b.map(function(a,b){return b});h._stableSort(c,function(a,c){return b[a].blendOrder<b[c].blendOrder});var e;for(e=0;e<b.length;++e){var f=c[e];var g=b[f];var d=this._inputs[f];f=this._outputs[f];var k=g.blendWeight;0<k&&g._update(a);if(1<=k)for(g=0;g<d.length;++g){var n=d[g];var m=f[g];var A=m.value;h._set(A,n,m.target.type);m.blendCounter++}else if(0<k)for(g=0;g<d.length;++g)n=d[g],m=f[g],A=
m.value,0===m.blendCounter?h._set(A,n,m.target.type):h._blend(A,n,k,m.target.type),m.blendCounter++}c=this._targets;for(var z in c)c.hasOwnProperty(z)&&(e=c[z],e.target.func(e.value),e.blendCounter=0);this._binder.update(a)}});return{INTERPOLATION_STEP:0,INTERPOLATION_LINEAR:1,INTERPOLATION_CUBIC:2,AnimData:d,AnimCurve:a,AnimTarget:g,AnimTrack:c,AnimSnapshot:e,AnimClip:f,AnimBinder:n,DefaultAnimBinder:k,AnimController:h}}());Object.assign(pc,function(){var d=function(){this.name="";this.duration=0;this._nodes=[];this._nodeDict={}};d.prototype.getDuration=function(){return this.duration};d.prototype.getName=function(){return this.name};d.prototype.getNode=function(b){return this._nodeDict[b]};Object.defineProperty(d.prototype,"nodes",{get:function(){return this._nodes}});d.prototype.getNodes=function(){return this._nodes};d.prototype.setDuration=function(b){this.duration=b};d.prototype.setName=function(b){this.name=b};
d.prototype.addNode=function(b){this._nodes.push(b);this._nodeDict[b._name]=b};return{Animation:d,Key:function(b,a,c,e){this.time=b;this.position=a;this.rotation=c;this.scale=e},Node:function(){this._name="";this._keys=[]}}}());Object.assign(pc,function(){function d(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}Object.assign(d.prototype,{getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}});var b=function(a){function b(a){var c=new d;c._name=a.name;e._interpolatedKeys.push(c);e._interpolatedKeyDict[a.name]=c;for(c=e._currKeyIndices[a.name]=0;c<a._children.length;c++)b(a._children[c])}this._animation=
null;this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var e=this;b(a)};b.prototype.addTime=function(a){if(null!==this._animation){var b=this._animation._nodes;var e=this._animation.duration;if(this._time!==e||this.looping){this._time+=a;if(this._time>e)for(this._time=this.looping?0:e,e=0;e<b.length;e++){var f=b[e];var g=f._name;this._currKeyIndices[g]=0}else if(0>this._time)for(this._time=this.looping?e:0,e=0;e<b.length;e++)f=
b[e],g=f._name,this._currKeyIndices[g]=f._keys.length-2;a=0<=a?1:-1;for(e=0;e<b.length;e++){f=b[e];g=f._name;f=f._keys;var d=this._interpolatedKeyDict[g];if(void 0!==d){var k=!1;if(1!==f.length)for(var h=this._currKeyIndices[g];h<f.length-1&&0<=h;h+=a){var m=f[h];var l=f[h+1];if(m.time<=this._time&&l.time>=this._time){k=(this._time-m.time)/(l.time-m.time);d._pos.lerp(m.position,l.position,k);d._quat.slerp(m.rotation,l.rotation,k);d._scale.lerp(m.scale,l.scale,k);d._written=!0;this._currKeyIndices[g]=
h;k=!0;break}}if(1===f.length||!k&&0===this._time&&this.looping)d._pos.copy(f[0].position),d._quat.copy(f[0].rotation),d._scale.copy(f[0].scale),d._written=!0}}}}};b.prototype.blend=function(a,b,e){for(var c=this._interpolatedKeys.length,g=0;g<c;g++){var d=a._interpolatedKeys[g],k=b._interpolatedKeys[g],h=this._interpolatedKeys[g];d._written&&k._written?(h._quat.slerp(d._quat,b._interpolatedKeys[g]._quat,e),h._pos.lerp(d._pos,b._interpolatedKeys[g]._pos,e),h._scale.lerp(d._scale,k._scale,e),h._written=
!0):d._written?(h._quat.copy(d._quat),h._pos.copy(d._pos),h._scale.copy(d._scale),h._written=!0):k._written&&(h._quat.copy(k._quat),h._pos.copy(k._pos),h._scale.copy(k._scale),h._written=!0)}};Object.defineProperty(b.prototype,"animation",{get:function(){return this._animation},set:function(a){this._animation=a;this.currentTime=0}});b.prototype.getAnimation=function(){return this._animation};Object.defineProperty(b.prototype,"currentTime",{get:function(){return this._time},set:function(a){this._time=
a;a=this._interpolatedKeys.length;for(var b=0;b<a;b++)this._currKeyIndices[this._interpolatedKeys[b]._name]=0;this.addTime(0);this.updateGraph()}});b.prototype.getCurrentTime=function(){return this._time};b.prototype.setCurrentTime=function(a){this.currentTime=a};Object.defineProperty(b.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}});b.prototype.getNumNodes=function(){return this._interpolatedKeys.length};b.prototype.setAnimation=function(a){this.animation=a};b.prototype.setGraph=
function(a){var b;if(this.graph=a)for(b=0;b<this._interpolatedKeys.length;b++){var e=a.findByName(this._interpolatedKeys[b]._name);this._interpolatedKeys[b].setTarget(e)}else for(b=0;b<this._interpolatedKeys.length;b++)this._interpolatedKeys[b].setTarget(null)};b.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var b=this._interpolatedKeys[a];if(b._written){var e=b.getTarget();e.localPosition.copy(b._pos);e.localRotation.copy(b._quat);e.localScale.copy(b._scale);
e._dirtyLocal||e._dirtifyLocal();b._written=!1}}};b.prototype.setLooping=function(a){this.looping=a};b.prototype.getLooping=function(){return this.looping};return{Skeleton:b}}());Object.assign(pc,function(){function d(){return"undefined"!==typeof Audio}function b(){return!("undefined"===typeof AudioContext&&"undefined"===typeof webkitAudioContext)}var a=function(a){pc.EventHandler.call(this);if(b()||a.forceWebAudioApi){if("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var c=this.context;this.resumeContext=function(){this.context.resume();window.removeEventListener("mousedown",
this.resumeContext);window.removeEventListener("touchend",this.resumeContext)}.bind(this);window.addEventListener("mousedown",this.resumeContext);window.addEventListener("touchend",this.resumeContext);if(pc.platform.ios){var f=function(){var a=c.createBuffer(1,1,44100),b=c.createBufferSource();b.buffer=a;b.connect(c.destination);b.start(0);b.disconnect();window.removeEventListener("touchend",f)};window.addEventListener("touchend",f)}}}else console.warn("No support for 3D audio found");d()||console.warn("No support for 2D audio found");
this.listener=new pc.Listener(this);this._volume=1;this.suspended=!1};a.prototype=Object.create(pc.EventHandler.prototype);a.prototype.constructor=a;a.hasAudio=d;a.hasAudioContext=b;Object.assign(a.prototype,{suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext);this.fire("destroy");this.context&&this.context.close&&
(this.context.close(),this.context=null)},playSound:function(a,b){b=b||{};var c=null;pc.Channel&&(c=new pc.Channel(this,a,b),c.play());return c},playSound3d:function(a,b,f){f=f||{};var c=null;pc.Channel3d&&(c=new pc.Channel3d(this,a,f),c.setPosition(b),f.volume&&c.setVolume(f.volume),f.loop&&c.setLoop(f.loop),f.maxDistance&&c.setMaxDistance(f.maxDistance),f.minDistance&&c.setMinDistance(f.minDistance),f.rollOffFactor&&c.setRollOffFactor(f.rollOffFactor),f.distanceModel&&c.setDistanceModel(f.distanceModel),
c.play());return c}});Object.defineProperty(a.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.fire("volumechange",a)}});return{SoundManager:a}}());Object.assign(pc,function(){var d=function(b){b instanceof Audio?this.audio=b:this.buffer=b};Object.defineProperty(d.prototype,"duration",{get:function(){var b=0;this.buffer?b=this.buffer.duration:this.audio&&(b=this.audio.duration);return b||0}});return{Sound:d}}());Object.assign(pc,function(){var d=function(b){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;pc.SoundManager.hasAudioContext()&&(this.listener=b.context.listener)};Object.assign(d.prototype,{getPosition:function(){return this.position},setPosition:function(b){this.position.copy(b);this.listener&&this.listener.setPosition(b.x,b.y,b.z)},getVelocity:function(){return this.velocity},setVelocity:function(b){this.velocity.copy(b);this.listener&&this.listener.setPosition(b.x,
b.y,b.z)},setOrientation:function(b){this.orientation.copy(b);this.listener&&this.listener.setOrientation(-b.data[8],-b.data[9],-b.data[10],b.data[4],b.data[5],b.data[6])},getOrientation:function(){return this.orientation}});return{Listener:d}}());Object.assign(pc,function(){if(pc.SoundManager.hasAudioContext()){var d=function(b,a,c){pc.EventHandler.call(this);c=c||{};this._volume=void 0!==c.volume?pc.math.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=a;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startedAt=
0;this._startOffset=null;this._currentOffset=this._currentTime=0;this._playWhenLoaded=!0;this._manager=b;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;this._initializeNodes();this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this._endedHandler=this._onEnded.bind(this);this.source=null};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;Object.assign(d.prototype,
{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop();this.source||this._createSource();var b=this._startOffset%this.duration||0;b=(this._startTime+b)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,b,this._duration):this.source.start(0,b);this._startedAt=this._manager.context.currentTime;this._currentTime=
0;this._currentOffset=b;this._state=0;this._playWhenLoaded=!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(0!==this._state||
!this.source)return!1;this._updateCurrentTime();this._state=1;this._suspendEndEvent=!0;this.source.stop(0);this.source=null;this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var b=this.currentTime;null!==this._startOffset&&(b=this._startOffset%this.duration||0,b=(this._startTime+b)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,b,this._duration):
this.source.start(0,b);this._state=0;this._startedAt=this._manager.context.currentTime;this._currentOffset=b;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this._onResume();return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",
this._onManagerDestroy,this);this._currentOffset=this._currentTime=this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this.source=null;this._state=2;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(b,a){if(b){a||(a=b);var c=this._manager.context.destination;this._firstNode!==b&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(c),this._firstNode=
b,this._connectorNode.connect(b));this._lastNode!==a&&(this._lastNode&&this._lastNode.disconnect(c),this._lastNode=a,this._lastNode.connect(c))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var b=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(b),this._lastNode=null);this._connectorNode.connect(b)},getExternalNodes:function(){return[this._firstNode,
this._lastNode]},_createSource:function(){if(!this._sound)return null;var b=this._manager.context;this._sound.buffer&&(this.source=b.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source},_updateCurrentTime:function(){this._currentTime=
((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}});Object.defineProperty(d.prototype,"volume",{get:function(){return this._volume},set:function(b){this._volume=b=pc.math.clamp(b,0,1);this.gain&&(this.gain.gain.value=b*this._manager.volume)}});Object.defineProperty(d.prototype,"pitch",{get:function(){return this._pitch},set:function(b){this._currentOffset=
this.currentTime;this._startedAt=this._manager.context.currentTime;this._pitch=Math.max(Number(b)||0,.01);this.source&&(this.source.playbackRate.value=this._pitch)}});Object.defineProperty(d.prototype,"loop",{get:function(){return this._loop},set:function(b){this._loop=!!b;this.source&&(this.source.loop=this._loop)}});Object.defineProperty(d.prototype,"sound",{get:function(){return this._sound},set:function(b){this._sound=b;2!==this._state?this.stop():this._createSource()}});Object.defineProperty(d.prototype,
"currentTime",{get:function(){if(null!==this._startOffset)return this._startOffset;if(1===this._state)return this._currentTime;if(2===this._state||!this.source)return 0;this._updateCurrentTime();return this._currentTime},set:function(b){if(!(0>b))if(0===this._state){this.stop();var a=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=b;this.play();this._suspendInstanceEvents=a}else this._currentTime=this._startOffset=b}})}else pc.SoundManager.hasAudio()?(d=function(b,a,c){pc.EventHandler.call(this);
c=c||{};this._volume=void 0!==c.volume?pc.math.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=a;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=b;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);
this._timeUpdateHandler=this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this.source=null;this._createSource()},d.prototype=Object.create(pc.EventHandler.prototype),d.prototype.constructor=d,Object.assign(d.prototype,{play:function(){2!==this._state&&this.stop();if(!this.source&&!this._createSource())return!1;this.volume=
this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=!1;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(!this.source||0!==this._state)return!1;
this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume());return!0},stop:function(){if(!this.source||2===this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",
this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);
this._isReady=!0;var b=this._startOffset%this.duration||0;b=(this._startTime+b)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=b},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler);return this.source},_onTimeUpdate:function(){this._duration&&
this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(d.prototype,"volume",{get:function(){return this._volume},set:function(b){this._volume=b=pc.math.clamp(b,0,1);this.source&&(this.source.volume=b*
this._manager.volume)}}),Object.defineProperty(d.prototype,"pitch",{get:function(){return this._pitch},set:function(b){this._pitch=Math.max(Number(b)||0,.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(d.prototype,"loop",{get:function(){return this._loop},set:function(b){this._loop=!!b;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(d.prototype,"sound",{get:function(){return this._sound},set:function(b){this.stop();this._sound=b}}),Object.defineProperty(d.prototype,
"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(b){0>b||(this._startOffset=b,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(b%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):d=function(){};Object.assign(d.prototype,{_onPlay:function(){this.fire("play");this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause");
this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume");this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop");this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||
(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(d.prototype,"startTime",{get:function(){return this._startTime},set:function(b){this._startTime=Math.max(0,Number(b)||0);b=0===this._state;this.stop();b&&this.play()}});Object.defineProperty(d.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(b){this._duration=Math.max(0,
Number(b)||0);b=0===this._state;this.stop();b&&this.play()}});Object.defineProperty(d.prototype,"isPlaying",{get:function(){return 0===this._state}});Object.defineProperty(d.prototype,"isPaused",{get:function(){return 1===this._state}});Object.defineProperty(d.prototype,"isStopped",{get:function(){return 2===this._state}});Object.defineProperty(d.prototype,"isSuspended",{get:function(){return this._suspended}});return{SoundInstance:d}}());Object.assign(pc,function(){if(pc.SoundManager.hasAudioContext()){var d=function(a,b,e){pc.SoundInstance.call(this,a,b,e);e=e||{};this._position=new pc.Vec3;e.position&&(this.position=e.position);this._velocity=new pc.Vec3;e.velocity&&(this.velocity=e.velocity);this.maxDistance=void 0!==e.maxDistance?Number(e.maxDistance):1E4;this.refDistance=void 0!==e.refDistance?Number(e.refDistance):1;this.rollOffFactor=void 0!==e.rollOffFactor?Number(e.rollOffFactor):1;this.distanceModel=void 0!==e.distanceModel?
e.distanceModel:pc.DISTANCE_LINEAR};d.prototype=Object.create(pc.SoundInstance.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}});Object.defineProperty(d.prototype,"position",{get:function(){return this._position},
set:function(a){this._position.copy(a);this.panner.setPosition(a.x,a.y,a.z)}});Object.defineProperty(d.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}});Object.defineProperty(d.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}});Object.defineProperty(d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(a){this.panner.refDistance=
a}});Object.defineProperty(d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(a){this.panner.rolloffFactor=a}});Object.defineProperty(d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(a){this.panner.distanceModel=a}})}else if(pc.SoundManager.hasAudio()){var b=new pc.Vec3;d=function(a,b,e){pc.SoundInstance.call(this,a,b,e);e=e||{};this._position=new pc.Vec3;e.position&&(this.position=e.position);this._velocity=new pc.Vec3;
e.velocity&&(this.velocity=e.velocity);this._maxDistance=void 0!==e.maxDistance?Number(e.maxDistance):1E4;this._refDistance=void 0!==e.refDistance?Number(e.refDistance):1;this._rollOffFactor=void 0!==e.rollOffFactor?Number(e.rollOffFactor):1;this._distanceModel=void 0!==e.distanceModel?e.distanceModel:pc.DISTANCE_LINEAR};d.prototype=Object.create(pc.SoundInstance.prototype);d.prototype.constructor=d;Object.defineProperty(d.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);
if(this.source){var c=this._manager.listener.getPosition();a=this.refDistance;var e=this.maxDistance,f=this.rollOffFactor,g=this.distanceModel;b=b.sub2(c,this._position);c=b.length();if(c<a)a=1;else if(c>e)a=0;else{var d=0;g===pc.DISTANCE_LINEAR?d=1-f*(c-a)/(e-a):g===pc.DISTANCE_INVERSE?d=a/(a+f*(c-a)):g===pc.DISTANCE_EXPONENTIAL&&(d=Math.pow(c/a,-f));a=pc.math.clamp(d,0,1)}this.source.volume=this.volume*a*this._manager.volume}}});Object.defineProperty(d.prototype,"velocity",{get:function(){return this._velocity},
set:function(a){this._velocity.copy(a)}});Object.defineProperty(d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(a){this._maxDistance=a}});Object.defineProperty(d.prototype,"refDistance",{get:function(){return this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(a){this._rollOffFactor=a}});Object.defineProperty(d.prototype,"distanceModel",{get:function(){return this._distanceModel},
set:function(a){this._distanceModel=a}})}else d=function(){};return{SoundInstance3d:d}}());Object.assign(pc,function(){if(pc.SoundManager.hasAudioContext()){var d=function(b,a,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=a;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=b;this.source=null;this.gain=b.context.createGain()};Object.assign(d.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();if(this.source&&(this.startTime=
this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,
this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,
this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(b){this.loop=b;this.source&&(this.source.loop=b)},setVolume:function(b){this.volume=b=pc.math.clamp(b,0,1);this.gain&&(this.gain.gain.value=b*this.manager.volume)},setPitch:function(b){this.pitch=b;this.source&&(this.source.playbackRate.value=b)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?
this.source.buffer.duration:0},_createSource:function(){var b=this.manager.context;this.sound.buffer&&(this.source=b.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(b.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})}else pc.SoundManager.hasAudio()?(d=function(b,a,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=a;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=b;a.audio&&(this.source=
a.audio.cloneNode(!1),this.source.pause())},Object.assign(d.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},
unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(b){this.volume=b=pc.math.clamp(b,0,1);this.source&&(this.source.volume=b*this.manager.volume)},setLoop:function(b){this.loop=b;this.source&&(this.source.loop=b)},setPitch:function(b){this.pitch=
b;this.source&&(this.source.playbackRate=b)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):d=function(){};Object.assign(d.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},
onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:d}}());Object.assign(pc,function(){if(pc.SoundManager.hasAudioContext()){var d=function(a,b,e){pc.Channel.call(this,a,b,e);this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()};d.prototype=Object.create(pc.Channel.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);
this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},
_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}})}else if(pc.SoundManager.hasAudio()){var b=new pc.Vec3;d=function(a,b){pc.Channel.call(this,a,b);this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=
pc.DISTANCE_INVERSE};d.prototype=Object.create(pc.Channel.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);if(this.source){var c=this.manager.listener.getPosition();a=this.minDistance;var e=this.maxDistance,f=this.rollOffFactor,g=this.distanceModel;b=b.sub2(c,this.position);c=b.length();if(c<a)a=1;else if(c>e)a=0;else{var d=0;g===pc.DISTANCE_LINEAR?d=1-f*(c-a)/(e-a):g===pc.DISTANCE_INVERSE?d=
a/(a+f*(c-a)):g===pc.DISTANCE_EXPONENTIAL&&(d=Math.pow(c/a,-f));a=pc.math.clamp(d,0,1)}e=this.getVolume();this.source.volume=e*a}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(a){this.rollOffFactor=
a},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(a){this.distanceModel=a}})}else d=function(){};return{Channel3d:d}}());(function(){var d={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",
EVENT_SELECT:"select",EVENT_SELECTSTART:"selectstart",EVENT_SELECTEND:"selectend",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,
KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,
KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,
PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};Object.assign(pc,d);pc.input={};Object.assign(pc.input,d)})();Object.assign(pc,function(){var d=function(a,b){var c={x:0,y:0};if(b){if(b instanceof d)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(pc.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheelDelta=0;"wheel"===b.type&&(0<b.deltaY?this.wheelDelta=1:0>b.deltaY&&(this.wheelDelta=-1));pc.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=
this.x-a._lastX,this.dy=this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:pc.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},b=function(a){pc.EventHandler.call(this);this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);
this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a)};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;b.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)};Object.assign(b.prototype,{attach:function(a){this._target=a;this._attached||(this._attached=
!0,a=pc.platform.passiveEvents?{passive:!1}:!1,window.addEventListener("mouseup",this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a))},detach:function(){if(this._attached){this._attached=!1;this._target=null;var a=pc.platform.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,a);window.removeEventListener("mousedown",this._downHandler,
a);window.removeEventListener("mousemove",this._moveHandler,a);window.removeEventListener("wheel",this._wheelHandler,a)}},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){if(document.body.requestPointerLock){var c=function(){a();document.removeEventListener("pointerlockchange",c)},f=function(){b();
document.removeEventListener("pointerlockerror",f)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",f,!1);document.body.requestPointerLock()}else b&&b()},disablePointerLock:function(a){if(document.exitPointerLock){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=
this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new d(this,a);a.event&&this.fire(pc.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new d(this,a);a.event&&this.fire(pc.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new d(this,a);a.event&&
(this.fire(pc.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new d(this,a);a.event&&this.fire(pc.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var b=this._target.getBoundingClientRect(),e=Math.floor(b.left);b=Math.floor(b.top);return a.clientX<e||a.clientX>=e+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-e,y:a.clientY-b}}});return{Mouse:b,MouseEvent:d}}());Object.assign(pc,function(){function d(a){c.key=a.keyCode;c.element=a.target;c.event=a;return c}function b(a){return"string"===typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){b?(this.key=b.keyCode,this.element=b.target,this.event=b):this.event=this.element=this.key=null},c=new a,e={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},f=function(a,b){pc.EventHandler.call(this);b=b||{};this._element=null;this._keyDownHandler=
this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};f.prototype=Object.create(pc.EventHandler.prototype);f.prototype.constructor=f;f.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",
this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};f.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};f.prototype.toKeyIdentifier=function(a){a=b(a);var c;if(c=e[a.toString()])return c;c=a.toString(16).toUpperCase();var f=c.length;for(a=0;a<4-f;a++)c="0"+c;return"U+"+
c};f.prototype._handleKeyDown=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),this._keymap[b]=!0,this.fire("keydown",d(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};f.prototype._handleKeyUp=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),delete this._keymap[b],this.fire("keyup",d(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};f.prototype._handleKeyPress=
function(a){this.fire("keypress",d(a));this.preventDefault&&a.preventDefault();this.stopPropagation&&a.stopPropagation()};f.prototype.update=function(){for(var a in this._lastmap)delete this._lastmap[a];for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};f.prototype.isPressed=function(a){a=b(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};f.prototype.wasPressed=function(a){a=b(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};f.prototype.wasReleased=
function(a){a=b(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};return{Keyboard:f,KeyboardEvent:a}}());Object.assign(pc,function(){var d=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=.25},b={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},a={"Product: 0268":"PS3"};Object.assign(d.prototype,{update:function(){var a,b;var f=0;for(b=this.current.length;f<b;f++){var g=this.current[f].pad.buttons;var d=g.length;for(a=0;a<d;a++)void 0===this.previous[f]&&(this.previous[f]=[]),this.previous[f][a]=g[a].pressed}a=this.poll();f=0;for(b=a.length;f<b;f++)this.current[f]=a[f]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():
navigator.webkitGetGamepads(),f,g=b.length;for(f=0;f<g;f++)b[f]&&a.push({map:this.getMap(b[f]),pad:b[f]})}return a},getMap:function(c){for(var e in a)if(0<=c.id.indexOf(e))return b[a[e]];return b.DEFAULT},isPressed:function(a,b){return this.current[a]?this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed:!1},wasPressed:function(a,b){if(!this.current[a])return!1;b=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[b].pressed&&!this.previous[a][b]},getAxis:function(a,
b){if(!this.current[a])return!1;a=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(a)<this.deadZone&&(a=0);return a}});return{GamePads:d}}());Object.assign(pc,function(){var d=function(a){var b=pc.getTouchTargetCoords(a);this.id=a.identifier;this.x=b.x;this.y=b.y;this.target=a.target;this.touch=a},b=function(a,b){this.element=b.target;this.event=b;this.touches=[];this.changedTouches=[];if(b){var c=b.touches.length;for(a=0;a<c;a++)this.touches.push(new d(b.touches[a]));c=b.changedTouches.length;for(a=0;a<c;a++)this.changedTouches.push(new d(b.changedTouches[a]))}};Object.assign(b.prototype,{getTouchById:function(a,b){var c,e=b.length;for(c=
0;c<e;c++)if(b[c].id===a)return b[c];return null}});var a=function(a){pc.EventHandler.call(this);this._element=null;this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a)};a.prototype=Object.create(pc.EventHandler.prototype);a.prototype.constructor=a;Object.assign(a.prototype,{attach:function(a){this._element&&this.detach();this._element=
a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,
!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",new b(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new b(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new b(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new b(this,a))}});return{getTouchTargetCoords:function(a){for(var b=0,c=0,g=a.target;!(g instanceof HTMLElement);)g=g.parentNode;
do b+=g.offsetLeft-g.scrollLeft,c+=g.offsetTop-g.scrollTop,g=g.offsetParent;while(g);return{x:a.pageX-b,y:a.pageY-c}},TouchDevice:a,TouchEvent:b}}());Object.assign(pc,function(){var d=function(b,a){a=a||{};this._keyboard=a.keyboard||null;this._mouse=a.mouse||null;this._gamepads=a.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};b&&this.attach(b)};d.prototype.attach=function(b){this._element=b;this._keyboard&&this._keyboard.attach(b);this._mouse&&this._mouse.attach(b)};d.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};d.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};d.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};d.prototype.update=function(b){this._keyboard&&this._keyboard.update(b);this._mouse&&this._mouse.update(b);this._gamepads&&this._gamepads.update(b);this._axesValues={};for(var a in this._axes)this._axesValues[a]=[]};d.prototype.registerKeys=function(b,a){this._keyboard||this._enableKeyboard();if(this._actions[b])throw Error(pc.string.format("Action: {0} already registered",
b));if(void 0===a)throw Error("Invalid button");a.length||(a=[a]);this._actions[b]?this._actions[b].push({type:pc.ACTION_KEYBOARD,keys:a}):this._actions[b]=[{type:pc.ACTION_KEYBOARD,keys:a}]};d.prototype.registerMouse=function(b,a){this._mouse||this._enableMouse();if(void 0===a)throw Error("Invalid button");this._actions[b]?this._actions[b].push({type:pc.ACTION_MOUSE,button:a}):this._actions[b]=[{type:pc.ACTION_MOUSE,button:-a}]};d.prototype.registerPadButton=function(b,a,c){if(void 0===c)throw Error("Invalid button");
this._actions[b]?this._actions[b].push({type:pc.ACTION_GAMEPAD,button:c,pad:a}):this._actions[b]=[{type:pc.ACTION_GAMEPAD,button:c,pad:a}]};d.prototype.registerAxis=function(b){var a=b.name;this._axes[a]||(this._axes[a]=[]);var c=this._axes[a].push(a);b=b||{};b.pad=b.pad||pc.PAD_1;var e=function(e,g,d,k){switch(g){case "mousex":e._mouse.on(pc.EVENT_MOUSEMOVE,function(b){e._axesValues[a][c]=b.dx/10});break;case "mousey":e._mouse.on(pc.EVENT_MOUSEMOVE,function(b){e._axesValues[a][c]=b.dy/10});break;
case "key":e._axes[a].push(function(){return e._keyboard.isPressed(k)?d:0});break;case "padrx":e._axes[a].push(function(){return e._gamepads.getAxis(b.pad,pc.PAD_R_STICK_X)});break;case "padry":e._axes[a].push(function(){return e._gamepads.getAxis(b.pad,pc.PAD_R_STICK_Y)});break;case "padlx":e._axes[a].push(function(){return e._gamepads.getAxis(b.pad,pc.PAD_L_STICK_X)});break;case "padly":e._axes[a].push(function(){return e._gamepads.getAxis(b.pad,pc.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");
}};e(this,b.positive,1,b.positiveKey);(b.negativeKey||b.negative!==b.positive)&&e(this,b.negative,-1,b.negativeKey)};d.prototype.isPressed=function(b){if(!this._actions[b])return!1;var a,c=this._actions[b].length;for(a=0;a<c;++a){var e=this._actions[b][a];switch(e.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var f,g=e.keys.length;for(f=0;f<g;f++)if(this._keyboard.isPressed(e.keys[f]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(e.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&
this._gamepads.isPressed(e.pad,e.button))return!0}}return!1};d.prototype.wasPressed=function(b){if(!this._actions[b])return!1;var a,c=this._actions[b].length;for(a=0;a<c;++a){var e=this._actions[b][a];switch(e.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var f,g=e.keys.length;for(f=0;f<g;f++)if(this._keyboard.wasPressed(e.keys[f]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,
e.button))return!0}}return!1};d.prototype.getAxis=function(b){var a=0;if(this._axes[b]){var c,e=this._axes[b].length;for(c=0;c<e;c++)if("function"===pc.type(this._axes[b][c])){var f=this._axes[b][c]();Math.abs(f)>Math.abs(a)&&(a=f)}else this._axesValues[b]&&Math.abs(this._axesValues[b][c])>Math.abs(a)&&(a=this._axesValues[b][c])}return a};d.prototype._enableMouse=function(){this._mouse=new pc.Mouse;if(!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)};
d.prototype._enableKeyboard=function(){this._keyboard=new pc.Keyboard;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};return{Controller:d}}());Object.assign(pc,function(){var d,b,a=new pc.Vec3,c=new pc.Vec3,e=new pc.Ray,f=new pc.Ray,g=new pc.Ray;e.end=new pc.Vec3;f.end=new pc.Vec3;g.end=new pc.Vec3;var n=new pc.Vec3,k=new pc.Vec3,h=new pc.Vec3,m=new pc.Vec3,l=new pc.Vec3,p=new pc.Vec3,q=new pc.Vec3,r=new pc.Vec2,t=new pc.Vec3,u=new pc.Vec3,x=new pc.Vec3,v=new pc.Vec3,y=new pc.Vec3,A=new pc.Vec3,z=new pc.Vec3,E=new pc.Vec3,C=new pc.Vec4,D=function(a,b,c){this.event=a;this.element=b;this.camera=c;this._stopPropagation=!1};Object.assign(D.prototype,
{stopPropagation:function(){this._stopPropagation=!0;this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}});var F=function(a,b,c,e,f,g,d){D.call(this,a,b,c);this.x=e;this.y=f;this.ctrlKey=a.ctrlKey||!1;this.altKey=a.altKey||!1;this.shiftKey=a.shiftKey||!1;this.metaKey=a.metaKey||!1;this.button=a.button;pc.Mouse.isPointerLocked()?(this.dx=a.movementX||a.webkitMovementX||a.mozMovementX||0,this.dy=a.movementY||a.webkitMovementY||a.mozMovementY||0):(this.dx=e-g,this.dy=f-
d);this.wheelDelta=0;"wheel"===a.type&&(0<a.deltaY?this.wheelDelta=1:0>a.deltaY&&(this.wheelDelta=-1))};F.prototype=Object.create(D.prototype);F.prototype.constructor=F;var I=function(a,b,c,e,f,g){D.call(this,a,b,c);this.touches=a.touches;this.changedTouches=a.changedTouches;this.x=e;this.y=f;this.touch=g};I.prototype=Object.create(D.prototype);I.prototype.constructor=I;var G=function(a,b,c,e){D.call(this,a,b,c);this.inputSource=e};G.prototype=Object.create(D.prototype);G.prototype.constructor=G;
var B=function(a,b){this._app=null;this._attached=!1;this._target=null;this._enabled=!0;this._lastY=this._lastX=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=this._handleTouchStart.bind(this);this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this);this._touchmoveHandler=this._handleTouchMove.bind(this);this._sortHandler=
this._sortElements.bind(this);this._elements=[];this._pressedElement=this._hoveredElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};this._selectedElements={};this._selectedPressedElements={};this._useMouse=!b||!1!==b.useMouse;this._useTouch=!b||!1!==b.useTouch;this._useXr=!b||!1!==b.useXr;this._selectEventsAttached=!1;pc.platform.touch&&(this._clickedEntities={});this.attach(a)};Object.assign(B.prototype,{attach:function(a){this._attached&&(this._attached=!1,this.detach());
this._target=a;this._attached=!0;a=pc.platform.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a));this._useTouch&&pc.platform.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,a),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",
this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1));this.attachSelectEvents()},attachSelectEvents:function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},detach:function(){if(this._attached){this._attached=!1;var a=pc.platform.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",
this._upHandler,a),window.removeEventListener("mousedown",this._downHandler,a),window.removeEventListener("mousemove",this._moveHandler,a),window.removeEventListener("wheel",this._wheelHandler,a));this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,a),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,
!1));this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this));this._target=null}},addElement:function(a){-1===this._elements.indexOf(a)&&this._elements.push(a)},removeElement:function(a){a=
this._elements.indexOf(a);-1!==a&&this._elements.splice(a,1)},_handleUp:function(a){this._enabled&&!pc.Mouse.isPointerLocked()&&(this._calcMouseCoords(a),null!==d&&this._onElementMouseEvent("mouseup",a))},_handleDown:function(a){this._enabled&&!pc.Mouse.isPointerLocked()&&(this._calcMouseCoords(a),null!==d&&this._onElementMouseEvent("mousedown",a))},_handleMove:function(a){this._enabled&&(this._calcMouseCoords(a),null!==d&&(this._onElementMouseEvent("mousemove",a),this._lastX=d,this._lastY=b))},_handleWheel:function(a){this._enabled&&
(this._calcMouseCoords(a),null!==d&&this._onElementMouseEvent("mousewheel",a))},_determineTouchedElements:function(a){var b={},c=this.app.systems.camera.cameras,e,f;for(e=c.length-1;0<=e;e--){var g=c[e],d=0;var k=0;for(f=a.changedTouches.length;k<f;k++)if(b[a.changedTouches[k].identifier])d++;else{var h=this._calcTouchCoords(a.changedTouches[k]),n=this._getTargetElement(g,h.x,h.y);n&&(d++,b[a.changedTouches[k].identifier]={element:n,camera:g,x:h.x,y:h.y})}if(d===f)break}return b},_handleTouchStart:function(a){if(this._enabled){for(var b=
this._determineTouchedElements(a),c=0,e=a.changedTouches.length;c<e;c++){var f=a.changedTouches[c],g=b[f.identifier],d=this._touchedElements[f.identifier];!g||d&&g.element===d.element||(this._fireEvent(a.type,new I(a,g.element,g.camera,g.x,g.y,f)),this._touchesForWhichTouchLeaveHasFired[f.identifier]=!1)}for(var k in b)this._touchedElements[k]=b[k]}},_handleTouchEnd:function(a){if(this._enabled){var b=this.app.systems.camera.cameras;for(c in this._clickedEntities)delete this._clickedEntities[c];var c=
0;for(var e=a.changedTouches.length;c<e;c++){var f=a.changedTouches[c],g=this._touchedElements[f.identifier];if(g){var d=g.element,k=g.camera,h=g.x;g=g.y;delete this._touchedElements[f.identifier];delete this._touchesForWhichTouchLeaveHasFired[f.identifier];this._fireEvent(a.type,new I(a,d,k,h,g,f));if(0===a.touches.length)for(var n=this._calcTouchCoords(f),m=b.length-1;0<=m;m--)this._getTargetElement(b[m],n.x,n.y)!==d||this._clickedEntities[d.entity.getGuid()]||(this._fireEvent("click",new I(a,d,
k,h,g,f)),this._clickedEntities[d.entity.getGuid()]=!0)}}}},_handleTouchMove:function(a){a.preventDefault();if(this._enabled)for(var b=this._determineTouchedElements(a),c=0,e=a.changedTouches.length;c<e;c++){var f=a.changedTouches[c],g=b[f.identifier],d=this._touchedElements[f.identifier];if(d){var k=this._calcTouchCoords(f);g&&g.element===d.element||this._touchesForWhichTouchLeaveHasFired[f.identifier]||(this._fireEvent("touchleave",new I(a,d.element,d.camera,k.x,k.y,f)),this._touchesForWhichTouchLeaveHasFired[f.identifier]=
!0);this._fireEvent("touchmove",new I(a,d.element,d.camera,k.x,k.y,f))}}},_onElementMouseEvent:function(a,c){var e,f=this._hoveredElement;this._hoveredElement=null;for(var g=this.app.systems.camera.cameras,k,h=g.length-1;0<=h&&!(k=g[h],e=this._getTargetElement(k,d,b));h--);e&&(this._fireEvent(a,new F(c,e,k,d,b,this._lastX,this._lastY)),this._hoveredElement=e,"mousedown"===a&&(this._pressedElement=e));f!==this._hoveredElement&&(f&&this._fireEvent("mouseleave",new F(c,f,k,d,b,this._lastX,this._lastY)),
this._hoveredElement&&this._fireEvent("mouseenter",new F(c,this._hoveredElement,k,d,b,this._lastX,this._lastY)));"mouseup"===a&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new F(c,this._hoveredElement,k,d,b,this._lastX,this._lastY))):this._pressedElement=null)},_onXrStart:function(){this.app.xr.on("end",this._onXrEnd,this);this.app.xr.on("update",
this._onXrUpdate,this);this.app.xr.input.on("selectstart",this._onSelectStart,this);this.app.xr.input.on("selectend",this._onSelectEnd,this);this.app.xr.input.on("remove",this._onXrInputRemove,this)},_onXrEnd:function(){this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",this._onSelectStart,this);this.app.xr.input.off("selectend",this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)},_onXrUpdate:function(){if(this._enabled)for(var a=this.app.xr.input.inputSources,
b=0;b<a.length;b++)this._onElementSelectEvent("selectmove",a[b],null)},_onXrInputRemove:function(a){var b=this._selectedElements[a.id];b&&(a._elementEntity=null,this._fireEvent("selectleave",new G(null,b,null,a)));delete this._selectedElements[a.id];delete this._selectedPressedElements[a.id]},_onSelectStart:function(a,b){this._enabled&&this._onElementSelectEvent("selectstart",a,b)},_onSelectEnd:function(a,b){this._enabled&&this._onElementSelectEvent("selectend",a,b)},_onElementSelectEvent:function(a,
b,c){var e,f=this._selectedElements[b.id],d=this.app.systems.camera.cameras;if(b.elementInput){g.set(b.getOrigin(),b.getDirection());for(var k=d.length-1;0<=k;k--){var h=d[k];if(e=this._getTargetElementByRay(g,h))break}}b._elementEntity=e||null;if(e)var n=this._selectedElements[b.id]=e;else delete this._selectedElements[b.id];f!==n&&(f&&this._fireEvent("selectleave",new G(c,f,h,b)),n&&this._fireEvent("selectenter",new G(c,n,h,b)));"selectstart"===a&&(this._selectedPressedElements[b.id]=n)&&this._fireEvent("selectstart",
new G(c,n,h,b));e=this._selectedPressedElements[b.id];!b.elementInput&&e&&(delete this._selectedPressedElements[b.id],f&&this._fireEvent("selectend",new G(c,f,h,b)));"selectend"===a&&b.elementInput&&(delete this._selectedPressedElements[b.id],f&&this._fireEvent("selectend",new G(c,f,h,b)),e&&e===f&&this._fireEvent("click",new G(c,e,h,b)))},_fireEvent:function(a,b){for(var c=b.element;;){c.fire(a,b);if(b._stopPropagation)break;if(!c.entity.parent)break;c=c.entity.parent.element;if(!c)break}},_calcMouseCoords:function(a){var c=
this._target.getBoundingClientRect(),e=Math.floor(c.left);c=Math.floor(c.top);a.clientX<e||a.clientX>=e+this._target.clientWidth||a.clientY<c||a.clientY>=c+this._target.clientHeight?b=d=null:(d=a.clientX-e,b=a.clientY-c)},_calcTouchCoords:function(a){for(var b=0,c=0,e=a.target;!(e instanceof HTMLElement);)e=e.parentNode;do b+=e.offsetLeft-e.scrollLeft,c+=e.offsetTop-e.scrollTop,e=e.offsetParent;while(e);return{x:a.pageX-b,y:a.pageY-c}},_sortElements:function(a,b){var c=this.app.scene.layers.sortTransparentLayers(a.layers,
b.layers);return 0!==c?c:a.screen&&!b.screen?-1:!a.screen&&b.screen?1:a.screen||b.screen?a.screen.screen.screenSpace&&!b.screen.screen.screenSpace?-1:b.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:b.drawOrder-a.drawOrder:0},_getTargetElement:function(a,b,c){var g=null;this._elements.sort(this._sortHandler);for(var d,k,h=0,n=this._elements.length;h<n;h++){var m=this._elements[h],q=!1;if(m.screen&&m.screen.screen.screenSpace){void 0===d&&(d=e,!1===this._calculateRayScreen(b,c,a,d)&&(d=
null));var l=d;q=!0}else void 0===k&&(k=f,!1===this._calculateRay3d(b,c,a,k)&&(k=null)),l=k;if(l&&this._checkElement(l,m,q)){g=m;break}}return g},_getTargetElementByRay:function(a,b){var c=null;e.origin.copy(a.origin);e.direction.copy(a.direction);e.end.copy(e.direction).scale(2*b.farClip).add(e.origin);this._elements.sort(this._sortHandler);a=0;for(b=this._elements.length;a<b;a++){var f=this._elements[a];if((!f.screen||!f.screen.screen.screenSpace)&&this._checkElement(e,f,!1)){c=f;break}}return c},
_buildHitCorners:function(a,b,c,e){if(a.entity&&a.entity.button){var f=a.entity.button.hitPadding||C;t.copy(a.entity.up);u.copy(t).scale(-1);v.copy(a.entity.right);x.copy(v).scale(-1);t.scale(f.w*e);u.scale(f.y*e);v.scale(f.z*c);x.scale(f.x*c);y.copy(b[0]).add(u).add(x);A.copy(b[1]).add(u).add(v);z.copy(b[2]).add(t).add(v);E.copy(b[3]).add(t).add(x);b=[y,A,z,E]}return b},_calculateScaleToScreen:function(a){var b=a.entity;a=a.screen.screen.scale;for(r.set(a,a);b&&!b.screen;)r.mul(b.getLocalScale()),
b=b.parent;return r},_calculateRayScreen:function(a,b,c,e){var f=this.app.graphicsDevice.width,g=this.app.graphicsDevice.height,d=c.rect.z*f,k=c.rect.w*g,h=c.rect.x*f;c=(1-c.rect.y)*g;var n=c-k;a=a*f/this._target.clientWidth;b=b*g/this._target.clientHeight;return a>=h&&a<=h+d&&b<=c&&b>=n?(e.origin.set(f*(a-h)/d,g-g*(b-n)/k,1),e.direction.set(0,0,-1),e.end.copy(e.direction).scale(2).add(e.origin),!0):!1},_calculateRay3d:function(b,e,f,g){var d=this._target.clientWidth,k=this._target.clientHeight,h=
f.rect.z*d,n=f.rect.w*k,m=f.rect.x*d,q=(1-f.rect.y)*k,l=q-n,p=e;return b>=m&&b<=m+h&&e<=q&&p>=l?(b=d*(b-m)/h,p=k*(p-l)/n,f.screenToWorld(b,p,f.nearClip,a),f.screenToWorld(b,p,f.farClip,c),g.origin.copy(a),g.direction.set(0,0,-1),g.end.copy(c),!0):!1},_checkElement:function(a,b,c){if(b.maskedBy&&!this._checkElement(a,b.maskedBy.element,c))return!1;var e=c?this._calculateScaleToScreen(b):b.entity.getWorldTransform().getScale();b=this._buildHitCorners(b,c?b.screenCorners:b.worldCorners,e.x,e.y);a:{c=
a.origin;n.sub2(a.end,c);k.sub2(b[0],c);h.sub2(b[1],c);m.sub2(b[2],c);p.cross(m,n);if(0<=k.dot(p)){if(0>-h.dot(p)){a=!1;break a}if(0>q.cross(n,h).dot(k)){a=!1;break a}}else if(l.sub2(b[3],c),0>l.dot(p)||0>q.cross(n,k).dot(l)){a=!1;break a}a=1E-8>n.sub2(b[0],b[2]).lengthSq()||1E-8>n.sub2(b[1],b[3]).lengthSq()?!1:!0}return a?!0:!1}});Object.defineProperty(B.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(B.prototype,"app",{get:function(){return this._app||
pc.app},set:function(a){this._app=a}});return{ElementInput:B,ElementInputEvent:D,ElementMouseEvent:F,ElementTouchEvent:I}}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);var a=this;this.isSupported=d.isSupported;this._index={};this.displays=[];this.display=null;this._app=b;this._onDisplayConnect=this._onDisplayConnect.bind(this);this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this);a._attach();this._getDisplays(function(b,e){if(b)a.fire("error",b);else{for(b=0;b<e.length;b++)a._addDisplay(e[b]);a.fire("ready",a.displays)}})};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=
d;d.isSupported="undefined"!==typeof navigator?!!navigator.getVRDisplays:!1;Object.assign(d.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var b=this.displays.length;
if(b)for(var a=0;a<b;a++)this.displays[a]._camera&&this.displays[a].poll()},_getDisplays:function(b){navigator.getVRDisplays?navigator.getVRDisplays().then(function(a){b&&b(null,a)}):b&&b(Error("WebVR not supported"))},_addDisplay:function(b){this._index[b.displayId]||(b=new pc.VrDisplay(this._app,b),this._index[b.id]=b,this.displays.push(b),this.display||(this.display=b),this.fire("displayconnect",b))},_onDisplayConnect:function(b){b.detail&&b.detail.display?this._addDisplay(b.detail.display):this._addDisplay(b.display)},
_onDisplayDisconnect:function(b){if(b=this._index[b.detail&&b.detail.display?b.detail.display.displayId:b.display.displayId]){b.destroy();delete this._index[b.id];var a=this.displays.indexOf(b);this.displays.splice(a,1);this.display===b&&(this.display=this.displays.length?this.displays[0]:null);this.fire("displaydisconnect",b)}}});return{VrManager:d}}());Object.assign(pc,function(){var d=function(b,a){pc.EventHandler.call(this);var c=this;this._app=b;this._device=b.graphicsDevice;this.id=a.displayId;this._frameData=null;window.VRFrameData&&(this._frameData=new window.VRFrameData);this.display=a;this._camera=null;this.sitToStandInv=new pc.Mat4;this.leftView=new pc.Mat4;this.leftProj=new pc.Mat4;this.leftViewInv=new pc.Mat4;this.leftPos=new pc.Vec3;this.rightView=new pc.Mat4;this.rightProj=new pc.Mat4;this.rightViewInv=new pc.Mat4;this.rightPos=new pc.Vec3;
this.combinedPos=new pc.Vec3;this.combinedView=new pc.Mat4;this.combinedProj=new pc.Mat4;this.combinedViewInv=new pc.Mat4;this.combinedAspect=this.combinedFov=0;this.presenting=!1;c._presentChange=function(a){if((a.display?a.display:a.detail&&a.detail.display?a.detail.display:a.detail&&a.detail.vrdisplay?a.detail.vrdisplay:c.display)===c.display){c.presenting=c.display&&c.display.isPresenting;if(c.presenting){a=c.display.getEyeParameters("left");var b=c.display.getEyeParameters("right");c._app.graphicsDevice.setResolution(2*
Math.max(a.renderWidth,b.renderWidth),Math.max(a.renderHeight,b.renderHeight));c._app._allowResize=!1}else c._app.setCanvasResolution(pc.RESOLUTION_AUTO),c._app._allowResize=!0;c.fire("beforepresentchange",c);c.fire("presentchange",c)}};window.addEventListener("vrdisplaypresentchange",c._presentChange,!1)};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange);
this._camera&&(this._camera.vrDisplay=null);this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData);this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var b=this.display.stageParameters;b?(this.sitToStandInv.set(b.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),
this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var a=this.leftProj.data[3]+this.leftProj.data[0],c=this.leftProj.data[11]+this.leftProj.data[8],e=1/Math.sqrt(a*a+c*c);b=-Math.atan2(c*e,a*e);a=this.rightProj.data[3]+this.rightProj.data[0];c=this.rightProj.data[11]+this.rightProj.data[8];e=1/Math.sqrt(a*a+c*c);b=Math.max(b,-Math.atan2(c*e,a*e));this.combinedFov=b*=2;this.combinedAspect=
a=this.rightProj.data[5]/this.rightProj.data[0];c=this.combinedView;c.copy(this.leftView);c.invert();this.leftViewInv.copy(c);e=this.combinedPos;e.x=this.leftPos.x=c.data[12];e.y=this.leftPos.y=c.data[13];e.z=this.leftPos.z=c.data[14];c.copy(this.rightView);c.invert();this.rightViewInv.copy(c);var f=e.x-c.data[12],g=e.y-c.data[13],d=e.z-c.data[14];f=Math.sqrt(f*f+g*g+d*d);this.rightPos.x=c.data[12];this.rightPos.y=c.data[13];this.rightPos.z=c.data[14];e.x+=c.data[12];e.y+=c.data[13];e.z+=c.data[14];
e.x*=.5;e.y*=.5;e.z*=.5;f=.5*f*Math.sin(Math.PI-(.5*Math.PI+.5*b));g=c.data[9];d=c.data[10];c.data[12]=e.x+c.data[8]*f;c.data[13]=e.y+g*f;c.data[14]=e.z+d*f;this.combinedViewInv.copy(c);c.invert();this.combinedProj.setPerspective(b*pc.math.RAD_TO_DEG,a,this.display.depthNear+f,this.display.depthFar+f,!0)}},requestPresent:function(b){this.display?this.presenting?b&&b(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){b&&b()},function(a){b&&
b(a)}):b&&b(Error("No VrDisplay to requestPresent"))},exitPresent:function(b){this.display||b&&b(Error("No VrDisplay to exitPresent"));this.presenting?this.display.exitPresent().then(function(){b&&b()},function(){b&&b(Error("exitPresent failed"))}):b&&b(Error("VrDisplay not presenting"))},requestAnimationFrame:function(b){this.display&&this.display.requestAnimationFrame(b)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(b,
a){this.display&&(this.display.depthNear=b,this.display.depthFar=a)},getFrameData:function(){if(this.display)return this._frameData}});Object.defineProperty(d.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}});return{VrDisplay:d}}());Object.assign(pc,function(){var d={XRTYPE_INLINE:"inline",XRTYPE_VR:"immersive-vr",XRTYPE_AR:"immersive-ar"},b=function(a){pc.EventHandler.call(this);var b=this;this.app=a;this._supported=!!navigator.xr;this._available={};for(var e in d)this._available[d[e]]=!1;this._referenceSpace=this._baseLayer=this._session=this._spaceType=this._type=null;this.input=new pc.XrInput(this);this.hitTest=new pc.XrHitTest(this);this._camera=null;this.views=[];this.viewsPool=[];this._localPosition=new pc.Vec3;this._localRotation=
new pc.Quat;this._depthNear=.1;this._depthFar=1E3;this._height=this._width=0;this._supported&&(navigator.xr.addEventListener("devicechange",function(){b._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;b.prototype.start=function(a,b,e,f){if(this._available[b])if(this._session)f&&f(Error("XR session is already started"));else{var c=this;this._camera=a;this._camera.camera.xr=this;this._type=b;this._spaceType=
e;this._setClipPlanes(a.nearClip,a.farClip);navigator.xr.requestSession(b,{requiredFeatures:[e]}).then(function(a){c._onSessionStart(a,e,f)}).catch(function(a){c._camera.camera.xr=null;c._camera=null;c._type=null;c._spaceType=null;f&&f(a);c.fire("error",a)})}else f&&f(Error("XR is not available"))};b.prototype.end=function(a){if(this._session){if(a)this.once("end",a);this._session.end()}else a&&a(Error("XR Session is not initialized"))};b.prototype.isAvailable=function(a){return this._available[a]};
b.prototype._deviceAvailabilityCheck=function(){for(var a in this._available)this._sessionSupportCheck(a)};b.prototype._sessionSupportCheck=function(a){var b=this;navigator.xr.isSessionSupported(a).then(function(c){b._available[a]!==c&&(b._available[a]=c,b.fire("available",a,c),b.fire("available:"+a,c))}).catch(function(a){b.fire("error",a)})};b.prototype._onSessionStart=function(a,b,e){var c=this,g=!1;this._session=a;var d=function(){c.fire("visibility:change",a.visibilityState)},k=function(){c._setClipPlanes(c._camera.nearClip,
c._camera.farClip)},h=function(){c._session=null;c._referenceSpace=null;c.views=[];c._width=0;c._height=0;c._type=null;c._spaceType=null;c._camera&&(c._camera.off("set_nearClip",k),c._camera.off("set_farClip",k),c._camera.camera.xr=null,c._camera=null);a.removeEventListener("end",h);a.removeEventListener("visibilitychange",d);g||c.fire("end");c.app.tick()};a.addEventListener("end",h);a.addEventListener("visibilitychange",d);this._camera.on("set_nearClip",k);this._camera.on("set_farClip",k);this._baseLayer=
new XRWebGLLayer(a,this.app.graphicsDevice.gl);a.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});a.requestReferenceSpace(b).then(function(a){c._referenceSpace=a;c.app.tick();e&&e(null);c.fire("start")}).catch(function(b){g=!0;a.end();e&&e(b);c.fire("error",b)})};b.prototype._setClipPlanes=function(a,b){if(this._depthNear!==a||this._depthFar!==b)this._depthNear=a,this._depthFar=b,this._session&&this._session.updateRenderState({depthNear:this._depthNear,
depthFar:this._depthFar})};b.prototype.update=function(a){if(this._session){var b,e=a.session.renderState.baseLayer.framebufferWidth;var f=a.session.renderState.baseLayer.framebufferHeight;if(this._width!==e||this._height!==f)this._width=e,this._height=f,this.app.graphicsDevice.setResolution(e,f);var g=(e=a.getViewerPose(this._referenceSpace))?e.views.length:0;if(g>this.views.length)for(f=0;f<=g-this.views.length;f++)(b=this.viewsPool.pop())||(b={viewport:new pc.Vec4,projMat:new pc.Mat4,viewMat:new pc.Mat4,
viewOffMat:new pc.Mat4,viewInvMat:new pc.Mat4,viewInvOffMat:new pc.Mat4,projViewOffMat:new pc.Mat4,viewMat3:new pc.Mat3,position:new Float32Array(3),rotation:new pc.Quat}),this.views.push(b);else if(g<=this.views.length)for(f=0;f<this.views.length-g;f++)this.viewsPool.push(this.views.pop());if(e){f=e.transform.position;b=e.transform.orientation;this._localPosition.set(f.x,f.y,f.z);this._localRotation.set(b.x,b.y,b.z,b.w);var d=a.session.renderState.baseLayer;for(f=0;f<e.views.length;f++){g=e.views[f];
b=this.views[f];var k=d.getViewport(g);b.viewport.x=k.x;b.viewport.y=k.y;b.viewport.z=k.width;b.viewport.w=k.height;b.projMat.set(g.projectionMatrix);b.viewMat.set(g.transform.inverse.matrix);b.viewInvMat.set(g.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition);this._camera.camera._node.setLocalRotation(this._localRotation);this.input.update(a);this._type===pc.XRTYPE_AR&&this.hitTest.supported&&this.hitTest.update(a);this.fire("update")}};Object.defineProperty(b.prototype,
"supported",{get:function(){return this._supported}});Object.defineProperty(b.prototype,"active",{get:function(){return!!this._session}});Object.defineProperty(b.prototype,"type",{get:function(){return this._type}});Object.defineProperty(b.prototype,"spaceType",{get:function(){return this._spaceType}});Object.defineProperty(b.prototype,"session",{get:function(){return this._session}});Object.defineProperty(b.prototype,"visibilityState",{get:function(){return this._session?this._session.visibilityState:
null}});Object.defineProperty(b.prototype,"camera",{get:function(){return this._camera?this._camera.entity:null}});b={XrManager:b};Object.assign(b,d);Object.assign(b,{XRSPACE_VIEWER:"viewer",XRSPACE_LOCAL:"local",XRSPACE_LOCALFLOOR:"local-floor",XRSPACE_BOUNDEDFLOOR:"bounded-floor",XRSPACE_UNBOUNDED:"unbounded"});return b}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);var a=this;this.manager=b;this._session=null;this._inputSources=[];this._onInputSourcesChangeEvt=function(b){a._onInputSourcesChange(b)};this.manager.on("start",this._onSessionStart,this);this.manager.on("end",this._onSessionEnd,this)};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype._onSessionStart=function(){this._session=this.manager.session;this._session.addEventListener("inputsourceschange",
this._onInputSourcesChangeEvt);var b=this;this._session.addEventListener("select",function(a){var c=b._getByInputSource(a.inputSource);c.update(a.frame);c.fire("select",a);b.fire("select",c,a)});this._session.addEventListener("selectstart",function(a){var c=b._getByInputSource(a.inputSource);c.update(a.frame);c._selecting=!0;c.fire("selectstart",a);b.fire("selectstart",c,a)});this._session.addEventListener("selectend",function(a){var c=b._getByInputSource(a.inputSource);c.update(a.frame);c._selecting=
!1;c.fire("selectend",a);b.fire("selectend",c,a)});for(var a=this._session.inputSources,c=0;c<a.length;c++)this._addInputSource(a[c])};d.prototype._onSessionEnd=function(){for(var b=this._inputSources.length;b--;){var a=this._inputSources[b];this._inputSources.splice(b,1);a.fire("remove");this.fire("remove",a)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);this._session=null};d.prototype._onInputSourcesChange=function(b){var a;for(a=0;a<b.removed.length;a++)this._removeInputSource(b.removed[a]);
for(a=0;a<b.added.length;a++)this._addInputSource(b.added[a])};d.prototype._getByInputSource=function(b){for(var a=0;a<this._inputSources.length;a++)if(this._inputSources[a].inputSource===b)return this._inputSources[a];return null};d.prototype._addInputSource=function(b){this._getByInputSource(b)||(b=new pc.XrInputSource(this.manager,b),this._inputSources.push(b),this.fire("add",b))};d.prototype._removeInputSource=function(b){for(var a=0;a<this._inputSources.length;a++)if(this._inputSources[a].inputSource===
b){b=this._inputSources[a];this._inputSources.splice(a,1);for(a=b.hitTestSources.length;a--;)b.hitTestSources[a].remove();b.fire("remove");this.fire("remove",b);break}};d.prototype.update=function(b){for(var a=0;a<this._inputSources.length;a++)this._inputSources[a].update(b)};Object.defineProperty(d.prototype,"inputSources",{get:function(){return this._inputSources}});return{XrInput:d}}());Object.assign(pc,function(){var d=new pc.Quat,b=0,a=function(a,e){pc.EventHandler.call(this);this._id=++b;this._manager=a;this._xrInputSource=e;this._ray=new pc.Ray;this._rayLocal=new pc.Ray;this._grip=!1;this._worldTransform=this._localTransform=null;this._position=new pc.Vec3;this._rotation=new pc.Quat;this._localRotation=this._localPosition=null;this._dirtyLocal=!0;this._selecting=!1;this._elementInput=!0;this._elementEntity=null;this._hitTestSources=[]};a.prototype=Object.create(pc.EventHandler.prototype);
a.prototype.constructor=a;a.prototype.update=function(a){var b=a.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);b&&(this._xrInputSource.gripSpace&&(a=a.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace))&&(this._grip||(this._grip=!0,this._localTransform=new pc.Mat4,this._worldTransform=new pc.Mat4,this._localPosition=new pc.Vec3,this._localRotation=new pc.Quat),this._dirtyLocal=!0,this._localPosition.copy(a.transform.position),this._localRotation.copy(a.transform.orientation)),
this._dirtyRay=!0,this._rayLocal.origin.copy(b.transform.position),this._rayLocal.direction.set(0,0,-1),d.copy(b.transform.orientation),d.transformVector(this._rayLocal.direction,this._rayLocal.direction))};a.prototype._updateTransforms=function(){if(this._dirtyLocal){var a=!0;this._dirtyLocal=!1;this._localTransform.setTRS(this._localPosition,this._localRotation,pc.Vec3.ONE)}var b=this._manager.camera.parent;if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),
this._worldTransform.mul2(a,this._localTransform)}else this._worldTransform.copy(this._localTransform)};a.prototype._updateRayTransforms=function(){var a=this._dirtyRay;this._dirtyRay=!1;var b=this._manager.camera.parent;if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),a.getTranslation(this._position),this._rotation.setFromMat4(a),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,
this._ray.direction)}else a&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))};a.prototype.getPosition=function(){if(!this._position)return null;this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};a.prototype.getLocalPosition=function(){return this._localPosition};a.prototype.getRotation=function(){if(!this._rotation)return null;this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);
return this._rotation};a.prototype.getLocalRotation=function(){return this._localRotation};a.prototype.getOrigin=function(){this._updateRayTransforms();return this._ray.origin};a.prototype.getDirection=function(){this._updateRayTransforms();return this._ray.direction};a.prototype.hitTestStart=function(a){var b=this;a=a||{};a.profile=this._xrInputSource.profiles[0];var c=a.callback;a.callback=function(a,e){if(e)b.onHitTestSourceAdd(e);c&&c(a,e)};this._manager.hitTest.start(a)};a.prototype.onHitTestSourceAdd=
function(a){this._hitTestSources.push(a);this.fire("hittest:add",a);a.on("result",function(b,c,g){g===this&&this.fire("hittest:result",a,b,c)},this);a.once("remove",function(){this.onHitTestSourceRemove(a);this.fire("hittest:remove",a)},this)};a.prototype.onHitTestSourceRemove=function(a){a=this._hitTestSources.indexOf(a);-1!==a&&this._hitTestSources.splice(a,1)};Object.defineProperty(a.prototype,"id",{get:function(){return this._id}});Object.defineProperty(a.prototype,"inputSource",{get:function(){return this._xrInputSource}});
Object.defineProperty(a.prototype,"targetRayMode",{get:function(){return this._xrInputSource.targetRayMode}});Object.defineProperty(a.prototype,"handedness",{get:function(){return this._xrInputSource.handedness}});Object.defineProperty(a.prototype,"profiles",{get:function(){return this._xrInputSource.profiles}});Object.defineProperty(a.prototype,"grip",{get:function(){return this._grip}});Object.defineProperty(a.prototype,"gamepad",{get:function(){return this._xrInputSource.gamepad||null}});Object.defineProperty(a.prototype,
"selecting",{get:function(){return this._selecting}});Object.defineProperty(a.prototype,"elementInput",{get:function(){return this._elementInput},set:function(a){this._elementInput!==a&&(this._elementInput=a,this._elementInput||(this._elementEntity=null))}});Object.defineProperty(a.prototype,"elementEntity",{get:function(){return this._elementEntity}});Object.defineProperty(a.prototype,"hitTestSources",{get:function(){return this._hitTestSources}});a={XrInputSource:a};Object.assign(a,{XRTARGETRAY_GAZE:"gaze",
XRTARGETRAY_SCREEN:"screen",XRTARGETRAY_POINTER:"tracked-pointer"});Object.assign(a,{XRHAND_NONE:"none",XRHAND_LEFT:"left",XRHAND_RIGHT:"right"});return a}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);this.manager=b;this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource);this._session=null;this.sources=[];this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype._onSessionStart=function(){this.manager.type===pc.XRTYPE_AR&&(this._session=this.manager.session)};
d.prototype._onSessionEnd=function(){if(this._session){this._session=null;for(var b=0;b<this.sources.length;b++)this.sources[b].onStop();this.sources=[]}};d.prototype.isAvailable=function(b,a){var c;this._supported||(c=Error("XR HitTest is not supported"));this._session||(c=Error("XR Session is not started (1)"));this.manager.type!==pc.XRTYPE_AR&&(c=Error("XR HitTest is available only for AR"));return c?(b&&b(c),a&&a.fire("error",c),!1):!0};d.prototype.start=function(b){var a=this;b=b||{};if(this.isAvailable(b.callback,
this)){b.profile||b.spaceType||(b.spaceType=pc.XRSPACE_VIEWER);var c,e=b.offsetRay;e&&(c=new XRRay(new DOMPoint(e.origin.x,e.origin.y,e.origin.z),new DOMPoint(e.direction.x,e.direction.y,e.direction.z)));var f=b.callback;b.spaceType?this._session.requestReferenceSpace(b.spaceType).then(function(e){a._session?a._session.requestHitTestSource({space:e,entityTypes:b.entityTypes||void 0,offsetRay:c}).then(function(b){a._onHitTestSource(b,!1,f)}).catch(function(b){f&&f(b);a.fire("error",b)}):(e=Error("XR Session is not started (2)"),
f&&f(e),a.fire("error",e))}).catch(function(b){f&&f(b);a.fire("error",b)}):this._session.requestHitTestSourceForTransientInput({profile:b.profile,entityTypes:b.entityTypes||void 0,offsetRay:c}).then(function(b){a._onHitTestSource(b,!0,f)}).catch(function(b){f&&f(b);a.fire("error",b)})}};d.prototype._onHitTestSource=function(b,a,c){this._session?(b=new pc.XrHitTestSource(this.manager,b,a),this.sources.push(b),c&&c(null,b),this.fire("add",b)):(b.cancel(),b=Error("XR Session is not started (3)"),c&&
c(b),this.fire("error",b))};d.prototype.update=function(b){for(var a=0;a<this.sources.length;a++)this.sources[a].update(b)};Object.defineProperty(d.prototype,"supported",{get:function(){return this._supported}});d={XrHitTest:d};Object.assign(d,{XRTRACKABLE_POINT:"point",XRTRACKABLE_PLANE:"plane",XRTRACKABLE_MESH:"mesh"});return d}());Object.assign(pc,function(){var d=[],b=[],a=function(a,b,f){pc.EventHandler.call(this);this.manager=a;this._xrHitTestSource=b;this._transient=f};a.prototype=Object.create(pc.EventHandler.prototype);a.prototype.constructor=a;a.prototype.remove=function(){if(this._xrHitTestSource){var a=this.manager.hitTest.sources,b=a.indexOf(this);-1!==b&&a.splice(b,1);this.onStop()}};a.prototype.onStop=function(){this._xrHitTestSource.cancel();this._xrHitTestSource=null;this.fire("remove");this.manager.hitTest.fire("remove",
this)};a.prototype.update=function(a){if(this._transient){a=a.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var b=0;b<a.length;b++){var c=a[b],g;c.inputSource&&(g=this.manager.input._getByInputSource(c.inputSource));this.updateHitResults(c.results,g)}}else this.updateHitResults(a.getHitTestResults(this._xrHitTestSource))};a.prototype.updateHitResults=function(a,e){for(var c=0;c<a.length;c++){var g=a[c].getPose(this.manager._referenceSpace),n=d.pop();n||(n=new pc.Vec3);n.copy(g.transform.position);
var k=b.pop();k||(k=new pc.Quat);k.copy(g.transform.orientation);this.fire("result",n,k,e);this.manager.hitTest.fire("result",this,n,k,e);d.push(n);b.push(k)}};return{XrHitTestSource:a}}());Object.assign(pc,function(){var d=function(){};d.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"};d.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};
d.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" ");d.retryDelay=100;Object.assign(d.prototype,{ContentType:d.ContentType,ResponseType:d.ResponseType,binaryExtensions:d.binaryExtensions,get:function(b,a,c){"function"===typeof a&&(c=a,a={});return this.request("GET",b,a,c)},post:function(b,a,c,e){"function"===typeof c&&(e=c,c={});c.postdata=a;return this.request("POST",b,c,e)},put:function(b,a,c,e){"function"===typeof c&&(e=c,c={});c.postdata=a;return this.request("PUT",
b,c,e)},del:function(b,a,c){"function"===typeof a&&(c=a,a={});return this.request("DELETE",b,a,c)},request:function(b,a,c,e){var f=!1;"function"===typeof c&&(e=c,c={});c.retry&&(c=Object.assign({retries:0,maxRetries:5},c));c.callback=e;null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)var g=c.postdata;else if(c.postdata instanceof FormData)g=c.postdata;else if(c.postdata instanceof Object)switch(g=c.headers["Content-Type"],void 0===g&&
(c.headers["Content-Type"]=d.ContentType.FORM_URLENCODED,g=c.headers["Content-Type"]),g){case d.ContentType.FORM_URLENCODED:g="";e=!0;for(n in c.postdata)c.postdata.hasOwnProperty(n)&&(e?e=!1:g+="&",g+=escape(n)+"="+escape(c.postdata[n]));break;default:case d.ContentType.JSON:null==g&&(c.headers["Content-Type"]=d.ContentType.JSON),g=JSON.stringify(c.postdata)}else g=c.postdata;if(!1===c.cache){e=pc.time.now();var n=new pc.URI(a);n.query=n.query?n.query+"&ts="+e:"ts="+e;a=n.toString()}c.query&&(n=
new pc.URI(a),e=pc.extend(n.getQuery(),c.query),n.setQuery(e),a=n.toString());var k=new XMLHttpRequest;k.open(b,a,c.async);k.withCredentials=void 0!==c.withCredentials?c.withCredentials:!1;k.responseType=c.responseType||this._guessResponseType(a);for(var h in c.headers)c.headers.hasOwnProperty(h)&&k.setRequestHeader(h,c.headers[h]);k.onreadystatechange=function(){this._onReadyStateChange(b,a,c,k)}.bind(this);k.onerror=function(){this._onError(b,a,c,k);f=!0}.bind(this);try{k.send(g)}catch(m){f||c.error(k.status,
k,m)}return k},_guessResponseType:function(b){b=new pc.URI(b);b=pc.path.getExtension(b.path);return 0<=d.binaryExtensions.indexOf(b)?d.ResponseType.ARRAY_BUFFER:".xml"===b?d.ResponseType.DOCUMENT:d.ResponseType.TEXT},_isBinaryContentType:function(b){return 0<=[d.ContentType.MP4,d.ContentType.WAV,d.ContentType.OGG,d.ContentType.MP3,d.ContentType.BIN,d.ContentType.DDS,d.ContentType.BASIS,d.ContentType.GLB].indexOf(b)?!0:!1},_onReadyStateChange:function(b,a,c,e){if(4===e.readyState)switch(e.status){case 0:"/"!=
a[0]?this._onSuccess(b,a,c,e):this._onError(b,a,c,e);break;case 200:case 201:case 206:case 304:this._onSuccess(b,a,c,e);break;default:this._onError(b,a,c,e)}},_onSuccess:function(b,a,c,e){if(b=e.getResponseHeader("Content-Type")){var f=b.split(";");f=f[0].trim()}try{if(f===this.ContentType.JSON||a.split("?")[0].endsWith(".json"))var g=JSON.parse(e.responseText);else this._isBinaryContentType(f)?g=e.response:(f&&logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",e.responseType,
f)),g=e.responseType===d.ResponseType.ARRAY_BUFFER?e.response:e.responseType===d.ResponseType.BLOB||e.responseType===d.ResponseType.JSON?e.response:e.responseType===d.ResponseType.DOCUMENT||f===this.ContentType.XML?e.responseXML:e.responseText);c.callback(null,g)}catch(n){c.callback(n)}},_onError:function(b,a,c,e){if(!c.retrying)if(c.retry&&c.retries<c.maxRetries){c.retries++;c.retrying=!0;var f=pc.math.clamp(Math.pow(2,c.retries)*d.retryDelay,0,c.maxRetryDelay||5E3);console.log(b+": "+a+" - Error "+
e.status+". Retrying in "+f+" ms");setTimeout(function(){c.retrying=!1;this.request(b,a,c,c.callback)}.bind(this),f)}else c.callback(0===e.status?"Network error":e.status,null)}});return{Http:d,http:new d}}());Object.assign(pc,function(){var d=function(a,b){if(pc.script.legacy)return null;if(d.reservedScripts[a])throw Error("script name: '"+a+"' is reserved, please change script name");var c=function(a){pc.ScriptType.call(this,a)};c.prototype=Object.create(pc.ScriptType.prototype);c.prototype.constructor=c;c.extend=pc.ScriptType.extend;c.attributes=new pc.ScriptAttributes(c);pc.registerScript(c,a,b);return c};d.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ");
var b={},a;for(a=0;a<d.reservedScripts.length;a++)b[d.reservedScripts[a]]=1;d.reservedScripts=b;d.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" ");b={};for(a=0;a<d.reservedAttributes.length;a++)b[d.reservedAttributes[a]]=1;d.reservedAttributes=b;return{createScript:d,registerScript:function(a,b,f){if(!pc.script.legacy){if("function"!==typeof a)throw Error("script class: '"+
a+"' must be a constructor function (i.e. class).");if(!(a.prototype instanceof pc.ScriptType))throw Error("script class: '"+pc.ScriptType.__getScriptName(a)+"' does not extend pc.ScriptType.");b=b||a.__name||pc.ScriptType.__getScriptName(a);if(d.reservedScripts[b])throw Error("script name: '"+b+"' is reserved, please change script name");a.__name=b;(f?f.scripts:pc.Application.getApplication().scripts).add(a);pc.ScriptHandler._push(a)}}}}());Object.assign(pc,function(){var d=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/,b=function(a){pc.EventHandler.call(this);var b=this.constructor;this.app=a.app;this.entity=a.entity;this._enabled="boolean"===typeof a.enabled?a.enabled:!0;this._enabledOld=this.enabled;this.__destroyed=!1;this.__attributes={};this.__attributesRaw=a.attributes||{};this.__scriptType=b;this.__executionOrder=-1};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;b.__name=null;b.__getScriptName=
function(a){if("function"===typeof a)return"name"in Function.prototype?a.name:a===Function||a===Function.prototype.constructor?"Function":(a=(""+a).match(d))?a[1]:void 0};Object.defineProperty(b,"scriptName",{get:function(){return this.__name}});Object.defineProperty(b,"attributes",{get:function(){this.hasOwnProperty("__attributes")||(this.__attributes=new pc.ScriptAttributes(this));return this.__attributes}});b.prototype.__initializeAttributes=function(a){if(a||this.__attributesRaw){for(var b in this.__scriptType.attributes.index)this.__attributesRaw&&
this.__attributesRaw.hasOwnProperty(b)?this[b]=this.__attributesRaw[b]:this.__attributes.hasOwnProperty(b)||(this.__scriptType.attributes.index[b].hasOwnProperty("default")?this[b]=this.__scriptType.attributes.index[b].default:this[b]=null);this.__attributesRaw=null}};b.extend=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.prototype[b]=a[b])};Object.defineProperty(b.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},
set:function(a){this._enabled=!!a;this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,pc.ScriptComponent.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&
this.entity.script._scriptMethod(this,pc.ScriptComponent.scriptMethods.postInitialize)))}});return{ScriptType:b}}());Object.assign(pc,function(){var d=["x","y","z","w"],b=function(a,b,f,g){switch(b.type){case "boolean":return!!f;case "number":if("number"===typeof f)break;else{if("string"===typeof f)return f=parseInt(f,10),isNaN(f)?null:f;if("boolean"===typeof f)return 0+f}return null;case "json":if("object"===typeof f)break;try{return JSON.parse(f)}catch(n){return null}case "asset":if(f instanceof pc.Asset)break;else{if("number"===typeof f)return a.assets.get(f)||null;if("string"===typeof f)return a.assets.get(parseInt(f,
10))||null}return null;case "entity":if(f instanceof pc.GraphNode)break;else if("string"===typeof f)return a.getEntityFromIndex(f);return null;case "rgb":case "rgba":if(f instanceof pc.Color)return g instanceof pc.Color?(g.copy(f),g):f.clone();if(f instanceof Array&&3<=f.length&&4>=f.length){for(a=0;a<f.length;a++)if("number"!==typeof f[a])return null;g||(g=new pc.Color);g.r=f[0];g.g=f[1];g.b=f[2];g.a=3===f.length?1:f[3];return g}return"string"===typeof f&&/#([0-9abcdef]{2}){3,4}/i.test(f)?(g||(g=
new pc.Color),g.fromString(f),g):null;case "vec2":case "vec3":case "vec4":b=parseInt(b.type.slice(3),10);if(f instanceof pc["Vec"+b])return g instanceof pc["Vec"+b]?(g.copy(f),g):f.clone();if(f instanceof Array&&f.length===b){for(a=0;a<f.length;a++)if("number"!==typeof f[a])return null;g||(g=new pc["Vec"+b]);for(a=0;a<b;a++)g[d[a]]=f[a];return g}return null;case "curve":if(f)return f instanceof pc.Curve||f instanceof pc.CurveSet?g=f.clone():(g=new (f.keys[0]instanceof Array?pc.CurveSet:pc.Curve)(f.keys),
g.type=f.type),g}return f},a=function(a){this.scriptType=a;this.index={}};a.prototype.add=function(a,e){this.index[a]||pc.createScript.reservedAttributes[a]||(this.index[a]=e,Object.defineProperty(this.scriptType.prototype,a,{get:function(){return this.__attributes[a]},set:function(c){var f=this.__attributes[a];if(e.array){if(this.__attributes[a]=[],c){var d;var k=0;for(d=c.length;k<d;k++)this.__attributes[a].push(b(this.app,e,c[k],f?f[k]:null))}}else this.__attributes[a]=b(this.app,e,c,f);this.fire("attr",
a,this.__attributes[a],f);this.fire("attr:"+a,this.__attributes[a],f)}}))};a.prototype.remove=function(a){if(!this.index[a])return!1;delete this.index[a];delete this.scriptType.prototype[a];return!0};a.prototype.has=function(a){return!!this.index[a]};a.prototype.get=function(a){return this.index[a]||null};return{ScriptAttributes:a}}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);this.app=b;this._scripts={};this._list=[]};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype.destroy=function(){this.app=null;this.off()};d.prototype.add=function(b){var a=this,c=b.__name;if(this._scripts.hasOwnProperty(c))return setTimeout(function(){if(b.prototype.swap){var e=a._list.indexOf(a._scripts[c]);a._list[e]=b;a._scripts[c]=b;a.fire("swap",c,b);a.fire("swap:"+c,b)}else console.warn("script registry already has '"+
c+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1;this._scripts[c]=b;this._list.push(b);this.fire("add",c,b);this.fire("add:"+c,b);setTimeout(function(){if(a._scripts.hasOwnProperty(c)&&a.app&&a.app.systems&&a.app.systems.script){var b=a.app.systems.script._components,f=[],g=[];for(b.loopIndex=0;b.loopIndex<b.length;b.loopIndex++){var d=b.items[b.loopIndex];if(d._scriptsIndex[c]&&d._scriptsIndex[c].awaiting){if(d._scriptsData&&d._scriptsData[c])var k=d._scriptsData[c].attributes;
(d=d.create(c,{preloading:!0,ind:d._scriptsIndex[c].ind,attributes:k}))&&f.push(d)}}for(b=0;b<f.length;b++)f[b].__initializeAttributes();for(b=0;b<f.length;b++)f[b].enabled&&(f[b]._initialized=!0,g.push(f[b]),f[b].initialize&&f[b].initialize());for(b=0;b<g.length;b++)g[b].enabled&&!g[b]._postInitialized&&(g[b]._postInitialized=!0,g[b].postInitialize&&g[b].postInitialize())}});return!0};d.prototype.remove=function(b){var a=b;"string"!==typeof b?b=a.__name:a=this.get(b);if(this.get(b)!==a)return!1;
delete this._scripts[b];var c=this._list.indexOf(a);this._list.splice(c,1);this.fire("remove",b,a);this.fire("remove:"+b,a);return!0};d.prototype.get=function(b){return this._scripts[b]||null};d.prototype.has=function(b){return"string"===typeof b?this._scripts.hasOwnProperty(b):b?this._scripts[b.__name]===b:!1};d.prototype.list=function(){return this._list};return{ScriptRegistry:d}}());Object.assign(pc,function(){var d=function(b){this._blobUrls={};for(var a=0,c=b.length;a<c;a++)b[a].url&&(this._blobUrls[b[a].name]=b[a].url)};d.prototype.hasBlobUrl=function(b){return!!this._blobUrls[b]};d.prototype.getBlobUrl=function(b){return this._blobUrls[b]};d.prototype.destroy=function(){for(var b in this._blobUrls)URL.revokeObjectURL(this._blobUrls[b]);this._blobUrls=null};return{Bundle:d}}());Object.assign(pc,function(){var d=function(b){this._assets=b;this._bundleAssets={};this._assetsInBundles={};this._urlsInBundles={};this._fileRequests={};this._assets.on("add",this._onAssetAdded,this);this._assets.on("remove",this._onAssetRemoved,this)};Object.assign(d.prototype,{_onAssetAdded:function(b){if("bundle"===b.type){this._bundleAssets[b.id]=b;this._registerBundleEventListeners(b.id);for(var a=0,c=b.data.assets.length;a<c;a++)this._indexAssetInBundle(b.data.assets[a],b)}else this._assetsInBundles[b.id]&&
this._indexAssetFileUrls(b)},_registerBundleEventListeners:function(b){this._assets.on("load:"+b,this._onBundleLoaded,this);this._assets.on("error:"+b,this._onBundleError,this)},_unregisterBundleEventListeners:function(b){this._assets.off("load:"+b,this._onBundleLoaded,this);this._assets.off("error:"+b,this._onBundleError,this)},_indexAssetInBundle:function(b,a){if(this._assetsInBundles[b]){var c=this._assetsInBundles[b];-1===c.indexOf(a)&&c.push(a)}else this._assetsInBundles[b]=[a];(b=this._assets.get(b))&&
this._indexAssetFileUrls(b)},_indexAssetFileUrls:function(b){var a=this._getAssetFileUrls(b);if(a)for(var c=0,e=a.length;c<e;c++)this._urlsInBundles[a[c]]=this._assetsInBundles[b.id]},_getAssetFileUrls:function(b){var a=b.getFileUrl();if(!a)return null;a=this._normalizeUrl(a);var c=[a];if("font"===b.type){b=b.data.info.maps.length;for(var e=1;e<b;e++)c.push(a.replace(".png",e+".png"))}return c},_normalizeUrl:function(b){return b&&b.split("?")[0]},_onAssetRemoved:function(b){if("bundle"===b.type){delete this._bundleAssets[b.id];
this._unregisterBundleEventListeners(b.id);var a;for(a in this._assetsInBundles){var c=this._assetsInBundles[a];var e=c.indexOf(b);if(-1!==e&&(c.splice(e,1),!c.length)){delete this._assetsInBundles[a];for(var f in this._urlsInBundles)this._urlsInBundles[f]===c&&delete this._urlsInBundles[f]}}this._onBundleError("Bundle "+b.id+" was removed",b)}else if(this._assetsInBundles[b.id])for(delete this._assetsInBundles[b.id],b=this._getAssetFileUrls(b),e=0,a=b.length;e<a;e++)delete this._urlsInBundles[b[e]]},
_onBundleLoaded:function(b){b.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var a in this._fileRequests){var c=this._urlsInBundles[a];if(c&&-1!==c.indexOf(b)){c=decodeURIComponent(a);var e=null;b.resource.hasBlobUrl(c)||(e="Bundle "+b.id+" does not contain URL "+a);for(var f=this._fileRequests[a],g=0,d=f.length;g<d;g++)if(e)f[g](e);else f[g](null,b.resource.getBlobUrl(c));delete this._fileRequests[a]}}}.bind(this)):this._onBundleError("Bundle "+b.id+" failed to load",b)},_onBundleError:function(b,
a){for(var c in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(c)){a=this._fileRequests[c];for(var e=0,f=a.length;e<f;e++)a[e](b);delete this._fileRequests[c]}},_findLoadedOrLoadingBundleForUrl:function(b){b=this._urlsInBundles[b];if(!b)return null;var a=b.length,c;for(c=0;c<a;c++)if(b[c].loaded&&b[c].resource)return b[c];for(c=0;c<a;c++)if(b[c].loading)return b[c];return null},listBundlesForAsset:function(b){return this._assetsInBundles[b.id]||null},list:function(){var b=[],a;for(a in this._bundleAssets)b.push(this._bundleAssets[a]);
return b},hasUrl:function(b){return!!this._urlsInBundles[b]},canLoadUrl:function(b){return!!this._findLoadedOrLoadingBundleForUrl(b)},loadUrl:function(b,a){var c=this._findLoadedOrLoadingBundleForUrl(b);if(c)if(c.loaded){var e=decodeURIComponent(b);c.resource.hasBlobUrl(e)?a(null,c.resource.getBlobUrl(e)):a("Bundle "+c.id+" does not contain URL "+b)}else this._fileRequests.hasOwnProperty(b)?this._fileRequests[b].push(a):this._fileRequests[b]=[a];else a("URL "+b+" not found in any bundles")},destroy:function(){this._assets.off("add",
this._onAssetAdded,this);this._assets.off("remove",this._onAssetRemoved,this);for(var b in this._bundleAssets)this._unregisterBundleEventListeners(b);this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}});return{BundleRegistry:d}}());Object.assign(pc,function(){var d=function(){};d.prototype._validate=function(b){if(!b.header)throw Error('pc.I18n#addData: Missing "header" field');if(!b.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==b.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!b.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(b.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var a=0,c=b.data.length;a<
c;a++){var e=b.data[a];if(!e.info)throw Error('pc.I18n#addData: missing "data['+a+'].info" field');if(!e.info.locale)throw Error('pc.I18n#addData: missing "data['+a+'].info.locale" field');if("string"!==typeof e.info.locale)throw Error('pc.I18n#addData: "data['+a+'].info.locale" must be a string');if(!e.messages)throw Error('pc.I18n#addData: missing "data['+a+'].messages" field');}};d.prototype.parse=function(b){return b.data};return{I18nParser:d}}());Object.assign(pc,function(){var d={},b=function(a,b){for(var c=0,e=a.length;c<e;c++)d[a[c]]=b},a=function(a){var b=a.indexOf("-");return-1!==b?a.substring(0,b):a},c={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};b("ja ko th vi zh id".split(" "),function(a){return 0});b(["fa","hi"],function(a){return 0<=a&&1>=a?0:1});b(["fr","pt"],function(a){return 0<=a&&2>a?0:1});b(["da"],function(a){return 1===a||!Number.isInteger(a)&&0<=
a&&1>=a?0:1});b("de en it el es tr fi sv nb no ur".split(" "),function(a){return 1===a?0:1});b(["ru","uk"],function(a){if(Number.isInteger(a)){var b=a%10;a%=100;if(1===b&&11!==a)return 0;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0===b||5<=b&&9>=b||11<=a&&14>=a)return 2}return 3});b(["pl"],function(a){if(Number.isInteger(a)){if(1===a)return 0;var b=a%10;a%=100;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0<=b&&1>=b||5<=b&&9>=b||12<=a&&14>=a)return 2}return 3});b(["ar"],function(a){if(0===a)return 0;if(1===
a)return 1;if(2===a)return 2;if(Number.isInteger(a)){a%=100;if(3<=a&&10>=a)return 3;if(11<=a&&99>=a)return 4}return 5});var e=d[a("en-US")];b=function(a){pc.EventHandler.call(this);this.locale="en-US";this._translations={};this._availableLangs={};this._app=a;this._assets=[];this._parser=new pc.I18nParser};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;b.findAvailableLocale=function(b,e){if(e[b])return b;var f=c[b];if(f&&e[f])return f;b=a(b);f=c[b];return e[f]?f:e[b]?
b:"en-US"};b.prototype.getText=function(b,c){var e=b;if(!c){c=this._locale;var f=this._lang}var d=this._translations[c];d||(f||(f=a(c)),c=this._findFallbackLocale(c,f),d=this._translations[c]);d&&d.hasOwnProperty(b)&&(e=d[b],Array.isArray(e)&&(e=e[0]),null===e||void 0===e)&&(e=b);return e};b.prototype.getPluralText=function(b,c,n){var f=b;if(n){var g=a(n);var m=d[g]||e}else n=this._locale,g=this._lang,m=this._pluralFn;var l=this._translations[n];l||(n=this._findFallbackLocale(n,g),g=a(n),m=d[g]||
e,l=this._translations[n]);l&&l[b]&&m&&(c=m(c),f=l[b][c],null===f||void 0===f)&&(f=b);return f};b.prototype.addData=function(b){try{var c=this._parser.parse(b)}catch(l){console.error(l);return}b=0;for(var e=c.length;b<e;b++){var f=c[b],d=f.info.locale;f=f.messages;if(!this._translations[d]){this._translations[d]={};var m=a(d);this._availableLangs[m]||(this._availableLangs[m]=d)}Object.assign(this._translations[d],f);this.fire("data:add",d,f)}};b.prototype.removeData=function(b){var c;try{var e=this._parser.parse(b)}catch(q){console.error(q);
return}b=0;for(var f=e.length;b<f;b++){var d=e[b],m=d.info.locale,l=this._translations[m];if(l){d=d.messages;for(c in d)delete l[c];var p=!1;for(c in l){p=!0;break}p||(delete this._translations[m],delete this._availableLangs[a(m)]);this.fire("data:remove",m,d)}}};b.prototype.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null;this.off()};Object.defineProperty(b.prototype,"locale",{get:function(){return this._locale},set:function(b){if(this._locale!==b){var c=
a(b);if("in"===c){c="id";var f=c,k=b.indexOf("-");b=-1!==k?f+b.substring(k):f;if(this._locale===b)return}f=this._locale;this._locale=b;this._lang=c;this._pluralFn=d[this._lang]||e;this.fire("set:locale",b,f)}}});Object.defineProperty(b.prototype,"assets",{get:function(){return this._assets},set:function(a){var b,c={};var e=0;for(b=a.length;e<b;e++){var f=a[e]instanceof pc.Asset?a[e].id:a[e];c[f]=!0}for(e=this._assets.length;e--;)f=this._assets[e],c[f]||(this._app.assets.off("add:"+f,this._onAssetAdd,
this),(a=this._app.assets.get(f))&&this._onAssetRemove(a),this._assets.splice(e,1));for(f in c)if(f=parseInt(f,10),-1===this._assets.indexOf(f))if(this._assets.push(f),a=this._app.assets.get(f))this._onAssetAdd(a);else this._app.assets.once("add:"+f,this._onAssetAdd,this)}});b.prototype._findFallbackLocale=function(a,b){return(a=c[a])&&this._translations[a]||(a=c[b])&&this._translations[a]?a:(a=this._availableLangs[b])&&this._translations[a]?a:"en-US"};b.prototype._onAssetAdd=function(a){a.on("load",
this._onAssetLoad,this);a.on("change",this._onAssetChange,this);a.on("remove",this._onAssetRemove,this);a.on("unload",this._onAssetUnload,this);a.resource&&this._onAssetLoad(a)};b.prototype._onAssetLoad=function(a){this.addData(a.resource)};b.prototype._onAssetChange=function(a){a.resource&&this.addData(a.resource)};b.prototype._onAssetRemove=function(a){a.off("load",this._onAssetLoad,this);a.off("change",this._onAssetChange,this);a.off("remove",this._onAssetRemove,this);a.off("unload",this._onAssetUnload,
this);a.resource&&this.removeData(a.resource);this._app.assets.once("add:"+a.id,this._onAssetAdd,this)};b.prototype._onAssetUnload=function(a){a.resource&&this.removeData(a.resource)};return{I18n:b}}());Object.assign(pc,function(){var d=function(b,a){this._app=b;this._data=a;this._expandedData={};this._templateRoot=null};d.prototype.instantiate=function(){this._templateRoot||this._parseTemplate();return this._templateRoot.clone()};d.prototype.getExpandedData=function(){this._expandedData.entities||(this._expandedData.entities=pc.TemplateUtils.expandTemplateEntities(this._app,this._data.entities));return this._expandedData};d.prototype._parseTemplate=function(){this._templateRoot=(new pc.SceneParser(this._app,
!0)).parse(this.getExpandedData())};return{Template:d}}());Object.assign(pc,function(){return{TemplateUtils:{waitForTemplatesInScene:function(d,b,a){if(d.collapsedInstances){var c=pc.TemplateUtils._getAllCollapsedEntities(d);pc.TemplateUtils.waitForTemplateAssets(c,b,a,d)}else a(null,d)},waitForTemplateAssets:function(d,b,a,c){d=pc.TemplateUtils._extractTemplateIds(d);(new pc.AssetListLoader(d,b)).load(function(b){a(b,c)})},_getAllCollapsedEntities:function(d){var b={};d.collapsedInstances.forEach(function(a){Object.assign(b,a.instanceEntities)});return b},
_extractTemplateIds:function(d){var b=[],a;for(a in d){var c=d[a].template_id;c&&b.push(c)}return b},expandTemplateEntities:function(d,b){var a={},c;for(c in b){var e=b[c];a[c]=e.collapsed_entity?pc.TemplateUtils.expandEntity(d,e):e}return a},expandEntity:function(d,b){}}}}());pc.script=function(){var d=!1,b=!1,a={app:null,create:function(a,b){if(d){var c=b(pc.script.app);c._pcScriptName=a;pc.ScriptHandler._push(c);this.fire("created",a,b)}},attribute:function(a,b,f,d){},createLoadingScreen:function(a){if(!b){b=!0;var c=pc.Application.getApplication();a(c)}}};Object.defineProperty(a,"legacy",{get:function(){return d},set:function(a){d=a}});pc.events.attach(a);return a}();Object.assign(pc,function(){var d=function(a,b){pc.EventHandler.call(this);b=b||{};pc.log.open();d._applications[a.id]=this;d._currentApplication=this;pc.app=this;this._time=0;this.timeScale=1;this.maxDeltaTime=.1;this.frame=0;this.autoRender=!0;this.renderNextFrame=!1;this.useLegacyScriptAttributeCloning=pc.script.legacy;this._librariesLoaded=!1;this._fillMode=pc.FILLMODE_KEEP_ASPECT;this._resolutionMode=pc.RESOLUTION_FIXED;this._allowResize=!0;this.context=this;b.graphicsDeviceOptions||(b.graphicsDeviceOptions=
{});b.graphicsDeviceOptions.xrCompatible=!0;this.graphicsDevice=new pc.GraphicsDevice(a,b.graphicsDeviceOptions);this.stats=new pc.ApplicationStats(this.graphicsDevice);this._soundManager=new pc.SoundManager(b);this.loader=new pc.ResourceLoader(this);this._entityIndex={};this.scene=new pc.Scene;this.root=new pc.Entity(this);this.root._enabledInHierarchy=!0;this._enableList=[];this._enableList.size=0;this.assets=new pc.AssetRegistry(this.loader);b.assetPrefix&&(this.assets.prefix=b.assetPrefix);this.bundles=
new pc.BundleRegistry(this.assets);this.enableBundles="undefined"!==typeof TextDecoder;this.scriptsOrder=b.scriptsOrder||[];this.scripts=new pc.ScriptRegistry(this);this.i18n=new pc.I18n(this);this.scenes=new pc.SceneRegistry(this);var e=this;this.defaultLayerWorld=new pc.Layer({name:"World",id:pc.LAYERID_WORLD});this.graphicsDevice.webgl2?(this.defaultLayerDepth=new pc.Layer({enabled:!1,name:"Depth",id:pc.LAYERID_DEPTH,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(e.graphicsDevice,
{format:pc.PIXELFORMAT_DEPTHSTENCIL,width:e.graphicsDevice.width,height:e.graphicsDevice.height});a.name="rt-depth2";a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.renderTarget=new pc.RenderTarget({colorBuffer:null,depthBuffer:a,autoResolve:!1});e.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),
this.renderTarget=null)},onPreRenderOpaque:function(a){var b=e.graphicsDevice.gl;this.srcFbo=b.getParameter(b.FRAMEBUFFER_BINDING);this.renderTarget&&this.renderTarget.width===e.graphicsDevice.width&&this.renderTarget.height===e.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear,
a=e.graphicsDevice.gl,e.graphicsDevice.setRenderTarget(this.renderTarget),e.graphicsDevice.updateBegin(),a.bindFramebuffer(a.READ_FRAMEBUFFER,this.srcFbo),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),a.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,a.DEPTH_BUFFER_BIT,a.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new pc.Layer({enabled:!1,name:"Depth",id:pc.LAYERID_DEPTH,
shaderPass:pc.SHADER_DEPTH,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:e.graphicsDevice.width,height:e.graphicsDevice.height});a.name="rt-depth1";a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.renderTarget=new pc.RenderTarget(e.graphicsDevice,a,{depth:!0,stencil:e.graphicsDevice.supportsStencil});e.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},
onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(a){var b=this.instances.visibleOpaque[a],c=b.list,f=0,d=e.scene.layers.layerList,g=e.scene.layers.subLayerEnabled,n=e.scene.layers.subLayerList,r=e.defaultLayerWorld.renderTarget;a=this.cameras[a];for(var t,u,x,v,y=0;y<d.length;y++){t=d[y];if(t===this)break;if(t.renderTarget===r&&t.enabled&&g[y]&&(u=t.cameras.indexOf(a),!(0>u)))for(u=(x=n[y])?t.instances.visibleTransparent[u]:
t.instances.visibleOpaque[u],x=u.length,u=u.list,t=0;t<x;t++)v=u[t],v.material&&v.material.depthWrite&&!v._noDepthDrawGl1&&(c[f]=v,f++)}b.length=f},onPreRenderOpaque:function(a){this.renderTarget&&this.renderTarget.width===e.graphicsDevice.width&&this.renderTarget.height===e.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){e.graphicsDevice.setColorWrite(!0,
!0,!0,!0)},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH});this.defaultLayerSkybox=new pc.Layer({enabled:!1,name:"Skybox",id:pc.LAYERID_SKYBOX,opaqueSortMode:pc.SORTMODE_NONE});this.defaultLayerUi=new pc.Layer({enabled:!0,name:"UI",id:pc.LAYERID_UI,transparentSortMode:pc.SORTMODE_MANUAL,passThrough:!1});
this.defaultLayerImmediate=new pc.Layer({enabled:!0,name:"Immediate",id:pc.LAYERID_IMMEDIATE,opaqueSortMode:pc.SORTMODE_NONE,passThrough:!0});this.defaultLayerComposition=new pc.LayerComposition;this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth);this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox);this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate);
this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerUi);this.scene.layers=this.defaultLayerComposition;this._immediateLayer=this.defaultLayerImmediate;this.scene.on("set:layers",function(a,b){a=b.layerList;for(var c=0;c<a.length;c++)switch(b=a[c],b.id){case pc.LAYERID_DEPTH:b.onEnable=e.defaultLayerDepth.onEnable;b.onDisable=e.defaultLayerDepth.onDisable;b.onPreRenderOpaque=e.defaultLayerDepth.onPreRenderOpaque;b.onPostRenderOpaque=
e.defaultLayerDepth.onPostRenderOpaque;b.depthClearOptions=e.defaultLayerDepth.depthClearOptions;b.rgbaDepthClearOptions=e.defaultLayerDepth.rgbaDepthClearOptions;b.shaderPass=e.defaultLayerDepth.shaderPass;b.onPostCull=e.defaultLayerDepth.onPostCull;b.onDrawCall=e.defaultLayerDepth.onDrawCall;break;case pc.LAYERID_UI:b.passThrough=e.defaultLayerUi.passThrough;break;case pc.LAYERID_IMMEDIATE:b.passThrough=e.defaultLayerImmediate.passThrough}});this.renderer=new pc.ForwardRenderer(this.graphicsDevice);
this.renderer.scene=this.scene;this.lightmapper=new pc.Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once("prerender",this._firstBake,this);this.batcher=new pc.BatchManager(this.graphicsDevice,this.root,this.scene);this.once("prerender",this._firstBatch,this);this.keyboard=b.keyboard||null;this.mouse=b.mouse||null;this.touch=b.touch||null;this.gamepads=b.gamepads||null;if(this.elementInput=b.elementInput||null)this.elementInput.app=this;this.vr=null;this.xr=
new pc.XrManager(this);this.elementInput&&this.elementInput.attachSelectEvents();this._inTools=!1;this._skyboxLast=0;this._scriptPrefix=b.scriptPrefix||"";this.enableBundles&&this.loader.addHandler("bundle",new pc.BundleHandler(this.assets));this.loader.addHandler("animation",new pc.AnimationHandler);this.loader.addHandler("model",new pc.ModelHandler(this.graphicsDevice,this.scene.defaultMaterial));this.loader.addHandler("material",new pc.MaterialHandler(this));this.loader.addHandler("texture",new pc.TextureHandler(this.graphicsDevice,
this.assets,this.loader));this.loader.addHandler("text",new pc.TextHandler);this.loader.addHandler("json",new pc.JsonHandler);this.loader.addHandler("audio",new pc.AudioHandler(this._soundManager));this.loader.addHandler("script",new pc.ScriptHandler(this));this.loader.addHandler("scene",new pc.SceneHandler(this));this.loader.addHandler("cubemap",new pc.CubemapHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("html",new pc.HtmlHandler);this.loader.addHandler("css",new pc.CssHandler);
this.loader.addHandler("shader",new pc.ShaderHandler);this.loader.addHandler("hierarchy",new pc.HierarchyHandler(this));this.loader.addHandler("scenesettings",new pc.SceneSettingsHandler(this));this.loader.addHandler("folder",new pc.FolderHandler);this.loader.addHandler("font",new pc.FontHandler(this.loader));this.loader.addHandler("binary",new pc.BinaryHandler);this.loader.addHandler("textureatlas",new pc.TextureAtlasHandler(this.loader));this.loader.addHandler("sprite",new pc.SpriteHandler(this.assets,
this.graphicsDevice));this.loader.addHandler("template",new pc.TemplateHandler(this));this.loader.addHandler("container",new pc.ContainerHandler(this.graphicsDevice,this.scene.defaultMaterial));this.systems=new pc.ComponentSystemRegistry;this.systems.add(new pc.RigidBodyComponentSystem(this));this.systems.add(new pc.CollisionComponentSystem(this));this.systems.add(new pc.AnimationComponentSystem(this));this.systems.add(new pc.ModelComponentSystem(this));this.systems.add(new pc.CameraComponentSystem(this));
this.systems.add(new pc.LightComponentSystem(this));pc.script.legacy?this.systems.add(new pc.ScriptLegacyComponentSystem(this)):this.systems.add(new pc.ScriptComponentSystem(this));this.systems.add(new pc.AudioSourceComponentSystem(this,this._soundManager));this.systems.add(new pc.SoundComponentSystem(this,this._soundManager));this.systems.add(new pc.AudioListenerComponentSystem(this,this._soundManager));this.systems.add(new pc.ParticleSystemComponentSystem(this));this.systems.add(new pc.ScreenComponentSystem(this));
this.systems.add(new pc.ElementComponentSystem(this));this.systems.add(new pc.ButtonComponentSystem(this));this.systems.add(new pc.ScrollViewComponentSystem(this));this.systems.add(new pc.ScrollbarComponentSystem(this));this.systems.add(new pc.SpriteComponentSystem(this));this.systems.add(new pc.LayoutGroupComponentSystem(this));this.systems.add(new pc.LayoutChildComponentSystem(this));this.systems.add(new pc.ZoneComponentSystem(this));this._visibilityChangeHandler=this.onVisibilityChange.bind(this);
"undefined"!==typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",
document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)));this.tick=c(this)};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d._currentApplication=null;d._applications={};d.getApplication=function(a){return a?d._applications[a]:d._currentApplication};var b=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return this.count===this.length}};Object.defineProperty(d.prototype,"fillMode",{get:function(){return this._fillMode}});
Object.defineProperty(d.prototype,"resolutionMode",{get:function(){return this._resolutionMode}});Object.assign(d.prototype,{configure:function(a,b){var c=this;pc.http.get(a,function(a,e){if(a)b(a);else{var f=e.scenes,d=e.assets;c._parseApplicationProperties(e.application_properties,function(a){c._parseScenes(f);c._parseAssets(d);a?b(a):b(null)})}})},preload:function(a){var c=this,e;c.fire("preload:start");var d=this.assets.list({preload:!0}),k=new b(d.length),h=!1,m=function(){c.graphicsDevice&&
!h&&k.done()&&(h=!0,c.fire("preload:end"),a())};var l=d.length;if(k.length){var p=function(a){k.inc();c.fire("preload:progress",k.count/l);k.done()&&m()},q=function(a,b){k.inc();c.fire("preload:progress",k.count/l);k.done()&&m()};for(e=0;e<d.length;e++)d[e].loaded?(k.inc(),c.fire("preload:progress",k.count/l),k.done()&&m()):(d[e].once("load",p),d[e].once("error",q),this.assets.load(d[e]))}else m()},getSceneUrl:function(a){return(a=this.scenes.find(a))?a.url:null},loadSceneHierarchy:function(a,b){this.scenes.loadSceneHierarchy(a,
b)},loadSceneSettings:function(a,b){this.scenes.loadSceneSettings(a,b)},loadScene:function(a,b){this.scenes.loadScene(a,b)},_preloadScripts:function(a,c){if(pc.script.legacy){var e=this;e.systems.script.preloading=!0;a=this._getScriptReferences(a);var f=0,d=a.length,h=new b(d),m=/^http(s)?:\/\//;if(d){var l=function(a,b){a&&console.error(a);h.inc();h.done()&&(e.systems.script.preloading=!1,c())};for(f=0;f<d;f++){var p=a[f];!m.test(p.toLowerCase())&&e._scriptPrefix&&(p=pc.path.join(e._scriptPrefix,
a[f]));this.loader.load(p,"script",l)}}else e.systems.script.preloading=!1,c()}else c()},_parseApplicationProperties:function(a,b){a.useDevicePixelRatio||(a.useDevicePixelRatio=a.use_device_pixel_ratio);a.resolutionMode||(a.resolutionMode=a.resolution_mode);a.fillMode||(a.fillMode=a.fill_mode);this._width=a.width;this._height=a.height;a.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio);this.setCanvasResolution(a.resolutionMode,this._width,this._height);this.setCanvasFillMode(a.fillMode,
this._width,this._height);if(a.layers&&a.layerOrder){var c=new pc.LayerComposition,e={};for(d in a.layers){var f=a.layers[d];f.id=parseInt(d,10);f.enabled=f.id!==pc.LAYERID_DEPTH;e[d]=new pc.Layer(f)}var d=0;for(f=a.layerOrder.length;d<f;d++){var m=a.layerOrder[d],l=e[m.layer];l&&(m.transparent?c.pushTransparent(l):c.pushOpaque(l),c.subLayerEnabled[d]=m.enabled)}this.scene.layers=c}if(a.batchGroups)for(d=0,f=a.batchGroups.length;d<f;d++)c=a.batchGroups[d],this.batcher.addGroup(c.name,c.dynamic,c.maxAabbSize,
c.id,c.layers);a.i18nAssets&&(this.i18n.assets=a.i18nAssets);this._loadLibraries(a.libraries,b)},_loadLibraries:function(a,b){var c=a.length,e=c,f=this,d=/^http(s)?:\/\//;if(c)for(var m=function(a,c){e--;a?b(a):0===e&&(f.onLibrariesLoaded(),b(null))},l=0;l<c;++l){var p=a[l];!d.test(p.toLowerCase())&&f._scriptPrefix&&(p=pc.path.join(f._scriptPrefix,p));this.loader.load(p,"script",m)}else f.onLibrariesLoaded(),b(null)},_parseScenes:function(a){if(a)for(var b=0;b<a.length;b++)this.scenes.add(a[b].name,
a[b].url)},_parseAssets:function(a){var b,c=[],e={},d={};if(pc.script.legacy){if(this.enableBundles)for(h in a)"bundle"===a[h].type&&(d[h]=!0,c.push(a[h]));for(h in a)d[h]||c.push(a[h])}else{for(b=0;b<this.scriptsOrder.length;b++){var h=this.scriptsOrder[b];a[h]&&(e[h]=!0,c.push(a[h]))}if(this.enableBundles)for(h in a)"bundle"===a[h].type&&(d[h]=!0,c.push(a[h]));for(h in a)e[h]||d[h]||c.push(a[h])}for(b=0;b<c.length;b++){a=c[b];h=new pc.Asset(a.name,a.type,a.file,a.data);h.id=parseInt(a.id,10);h.preload=
a.preload?a.preload:!1;h.loaded="script"===a.type&&a.data&&0<a.data.loadingType;h.tags.add(a.tags);if(a.i18n)for(var m in a.i18n)h.addLocalizedAssetId(m,a.i18n[m]);this.assets.add(h)}},_getScriptReferences:function(a){var b,c,e=[];a.settings.priority_scripts&&(e=a.settings.priority_scripts);var d=[],h={};for(b=0;b<e.length;b++)d.push(e[b]),h[e[b]]=!0;a=a.entities;for(c in a)if(a[c].components.script)for(e=a[c].components.script.scripts,b=0;b<e.length;b++)h[e[b].url]||(d.push(e[b].url),h[e[b].url]=
!0);return d},start:function(){this.frame=0;this.fire("start",{timestamp:pc.now(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();pc.ComponentSystem.initialize(this.root);this.fire("initialize");pc.ComponentSystem.postInitialize(this.root);this.fire("postinitialize");this.tick()},update:function(a){this.frame++;this.graphicsDevice.updateClientRect();this.vr&&this.vr.poll();pc.script.legacy&&pc.ComponentSystem.fixedUpdate(1/60,this._inTools);pc.ComponentSystem.update(a,this._inTools);
pc.ComponentSystem.postUpdate(a,this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)},render:function(){this.fire("prerender");this.root.syncHierarchy();this.batcher.updateAll();pc._skipRenderCounter=0;this.renderer.renderComposition(this.scene.layers);this.fire("postrender")},_fillFrameStats:function(a,b,c){var e=this.stats.frame;e.dt=b;e.ms=c;a>e._timeToCountFrames?
(e.fps=e._fpsAccum,e._fpsAccum=0,e._timeToCountFrames=a+1E3):e._fpsAccum++;e.cameras=this.renderer._camerasRendered;e.materials=this.renderer._materialSwitches;e.shaders=this.graphicsDevice._shaderSwitchesPerFrame;e.shadowMapUpdates=this.renderer._shadowMapUpdates;e.shadowMapTime=this.renderer._shadowMapTime;e.depthMapTime=this.renderer._depthMapTime;e.forwardTime=this.renderer._forwardTime;a=this.graphicsDevice._primsPerFrame;e.triangles=a[pc.PRIMITIVE_TRIANGLES]/3+Math.max(a[pc.PRIMITIVE_TRISTRIP]-
2,0)+Math.max(a[pc.PRIMITIVE_TRIFAN]-2,0);e.cullTime=this.renderer._cullTime;e.sortTime=this.renderer._sortTime;e.skinTime=this.renderer._skinTime;e.morphTime=this.renderer._morphTime;e.instancingTime=this.renderer._instancingTime;for(b=e.otherPrimitives=0;b<a.length;b++)b<pc.PRIMITIVE_TRIANGLES&&(e.otherPrimitives+=a[b]),a[b]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=
0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;e=this.stats.drawCalls;e.forward=this.renderer._forwardDrawCalls;e.culled=this.renderer._numDrawCallsCulled;e.depth=0;e.shadow=this.renderer._shadowDrawCalls;e.skinned=this.renderer._skinDrawCalls;e.immediate=0;e.instanced=0;e.removedByInstancing=0;e.total=this.graphicsDevice._drawCallsPerFrame;e.misc=
e.total-(e.forward+e.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._numDrawCallsCulled=0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;e=this.stats.particles;e.updatesPerFrame=e._updatesPerFrame;e.frameTime=
e._frameTime;e._updatesPerFrame=0;e._frameTime=0},setCanvasFillMode:function(a,b,c){this._fillMode=a;this.resizeCanvas(b,c)},setCanvasResolution:function(a,b,c){this._resolutionMode=a;a===pc.RESOLUTION_AUTO&&void 0===b&&(b=this.graphicsDevice.canvas.clientWidth,c=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(b,c)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},
resizeCanvas:function(a,b){if(this._allowResize&&(!this.xr||!this.xr.session)){var c=window.innerWidth,e=window.innerHeight;if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var f=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;f>c/e?(a=c,b=a/f):(b=e,a=b*f)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(a=c,b=e);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=b+"px";this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO);
return{width:a,height:b}}},onLibrariesLoaded:function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded();this.systems.collision.onLibraryLoaded()},applySceneSettings:function(a){if(this.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.physics.gravity;this.systems.rigidbody.gravity.set(b[0],b[1],b[2])}this.scene.applySettings(a);if(a.render.hasOwnProperty("skybox"))if(a.render.skybox)if(b=this.assets.get(a.render.skybox))this.setSkybox(b);else this.assets.once("add:"+a.render.skybox,
this.setSkybox,this);else this.setSkybox(null)},setSkybox:function(a){a?this._skyboxLast===a.id?0!==this.scene.skyboxMip||a.loadFaces?this._onSkyboxChange(a):this._skyboxLoad(a):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=a.id,this.assets.on("load:"+a.id,this._onSkyboxChange,this),this.assets.once("remove:"+a.id,
this._skyboxRemove,this),a.resource&&this.scene.setSkybox(a.resources),this._skyboxLoad(a)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},enableVr:function(){this.vr||(this.vr=new pc.VrManager(this))},disableVr:function(){this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(a){this.scene.setSkybox(a.resources)},_skyboxLoad:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a);this._onSkyboxChange(a)},_skyboxRemove:function(a){this._skyboxLast&&(this.assets.off("add:"+
a.id,this.setSkybox,this),this.assets.off("load:"+a.id,this._onSkyboxChange,this),this.assets.off("remove:"+a.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1);this.batcher.generate()},_processTimestamp:function(a){return a},destroy:function(){var a,
b=this.graphicsDevice.canvas.id;this.off("librariesloaded");document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1);this.onVisibilityChange=this._visibilityChangeHandler=null;this.root.destroy();this.root=null;this.mouse&&
(this.mouse.off(),this.mouse.detach(),this.mouse=null);this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null);this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null);this.elementInput&&(this.elementInput.detach(),this.elementInput=null);this.controller&&(this.controller=null);var c=this.systems.list;var n=0;for(a=c.length;n<a;n++)c[n].destroy();pc.ComponentSystem.destroy();a=this.assets.list();for(n=0;n<a.length;n++)a[n].unload(),a[n].off();this.assets.off();this.bundles.destroy();
this.bundles=null;this.i18n.destroy();this.i18n=null;for(var k in this.loader.getHandler("script")._cache)n=this.loader.getHandler("script")._cache[k],(a=n.parentNode)&&a.removeChild(n);this.loader.getHandler("script")._cache={};this.loader.destroy();this.loader=null;this.scene.destroy();this.scene=null;this.systems=[];this.context=null;this.scripts.destroy();this.scripts=null;this.scenes.destroy();this.scenes=null;this.lightmapper.destroy();this.lightmapper=null;this.batcher.destroyManager();this.batcher=
null;this._entityIndex={};this.defaultLayerDepth.onPreRenderOpaque=null;this.defaultLayerDepth.onPostRenderOpaque=null;this.defaultLayerDepth.onDisable=null;this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null;pc.destroyPostEffectQuad();this.vr&&(this.vr.destroy(),this.vr=null);this.xr.end();this.graphicsDevice.destroy();this.tick=this.renderer=this.graphicsDevice=null;this.off();this._soundManager&&(this._soundManager.destroy(),this._soundManager=null);pc.http=new pc.Http;
pc.script.app=null;pc.ParticleEmitter.DEFAULT_PARAM_TEXTURE=null;d._applications[b]=null;d._currentApplication===this&&(d._currentApplication=null)},getEntityFromIndex:function(a){return this._entityIndex[a]}});var a={},c=function(b){var c;return function(e,f){if(b.graphicsDevice){d._currentApplication=b;c&&(window.cancelAnimationFrame(c),c=null);pc.app=b;e=b._processTimestamp(e)||pc.now();var g=e-(b._time||e);var h=pc.math.clamp(g/1E3,0,b.maxDeltaTime);h*=b.timeScale;b._time=e;c=b.vr&&b.vr.display?
b.vr.display.requestAnimationFrame(b.tick):b.xr.session?b.xr.session.requestAnimationFrame(b.tick):window.requestAnimationFrame(b.tick);if(!b.graphicsDevice.contextLost){b.fire("frameupdate",g);f?(b.xr.update(f),b.graphicsDevice.defaultFramebuffer=f.session.renderState.baseLayer.framebuffer):b.graphicsDevice.defaultFramebuffer=null;b.update(h);b.fire("framerender");if(b.autoRender||b.renderNextFrame)b.render(),b.renderNextFrame=!1;a.timestamp=pc.now();a.target=b;b.fire("frameend",a);b.fire("frameEnd",
a);b.vr&&b.vr.display&&b.vr.display.presenting&&b.vr.display.submitFrame()}}}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:d}}());pc.ApplicationStats=function(d){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};
this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0};this.vram=d._vram;this.shaders=d._shaderStats;Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}});Object.defineProperty(this,"scene",{get:function(){return pc.Application._currentApplication.scene._stats}});Object.defineProperty(this,"lightmapper",{get:function(){return pc.Application._currentApplication.lightmapper._stats}});Object.defineProperty(this,"batcher",{get:function(){return pc.Application._currentApplication.batcher._stats}})};Object.assign(pc,function(){var d=function(b){this._app=b;this._list=[];this._index={};this._urlIndex={}};d.prototype.destroy=function(){this._app=null};d.prototype.list=function(){return this._list};d.prototype.add=function(b,a){if(this._index.hasOwnProperty(b))return!1;b=new pc.SceneRegistryItem(b,a);a=this._list.push(b);this._index[b.name]=a-1;this._urlIndex[b.url]=a-1;return!0};d.prototype.find=function(b){return this._index.hasOwnProperty(b)?this._list[this._index[b]]:null};d.prototype.findByUrl=
function(b){return this._urlIndex.hasOwnProperty(b)?this._list[this._urlIndex[b]]:null};d.prototype.remove=function(b){if(this._index.hasOwnProperty(b)){var a=this._index[b],c=this._list[a];delete this._urlIndex[c.url];delete this._index[b];this._list.splice(a,1);for(a=0;a<this._list.length;a++)c=this._list[a],this._index[c.name]=a,this._urlIndex[c.url]=a}};d.prototype.loadSceneHierarchy=function(b,a){var c=this,e=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&
!pc.ABSOLUTE_URL.test(b)&&(b=pc.path.join(this._app.assets.prefix,b));e.load(b,function(f,d){f?a&&a(f):c._app._preloadScripts(d,function(){c._app.systems.script.preloading=!0;var g=e.open(b,d);c._app.systems.script.preloading=!1;c._app.loader.clearCache(b,"hierarchy");c._app.root.addChild(g);pc.ComponentSystem.initialize(g);pc.ComponentSystem.postInitialize(g);a&&a(f,g)})})};d.prototype.loadSceneSettings=function(b,a){var c=this;this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(b)&&
(b=pc.path.join(this._app.assets.prefix,b));this._app.loader.load(b,"scenesettings",function(b,f){b?a&&a(b):(c._app.applySceneSettings(f),a&&a(null))})};d.prototype.loadScene=function(b,a){var c=this,e=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(b)&&(b=pc.path.join(this._app.assets.prefix,b));e.load(b,function(f,d){f?a&&a(f):c._app._preloadScripts(d,function(){c._app.systems.script.preloading=!0;var f=e.open(b,d);c._app.systems.script.preloading=
!1;c._app.loader.clearCache(b,"scene");c._app.loader.patch({resource:f,type:"scene"},c._app.assets);c._app.root.addChild(f.root);c._app.systems.rigidbody&&"undefined"!==typeof Ammo&&c._app.systems.rigidbody.gravity.set(f._gravity.x,f._gravity.y,f._gravity.z);a&&a(null,f)})})};return{SceneRegistry:d,SceneRegistryItem:function(b,a){this.name=b;this.url=a}}}());Object.assign(pc,function(){var d=function(){this.list=[]};Object.assign(d.prototype,{add:function(b){var a=b.id;if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;this.list.push(b)},remove:function(b){b=b.id;if(!this[b])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",b));delete this[b];b=this.list.indexOf(this[b]);-1!==b&&this.list.splice(b,1)}});return{ComponentSystemRegistry:d}}());Object.assign(pc,function(){function d(a,b){if(!a)return a;switch(b){case "rgb":return a instanceof pc.Color?a.clone():new pc.Color(a[0],a[1],a[2]);case "rgba":return a instanceof pc.Color?a.clone():new pc.Color(a[0],a[1],a[2],a[3]);case "vec2":return a instanceof pc.Vec2?a.clone():new pc.Vec2(a[0],a[1]);case "vec3":return a instanceof pc.Vec3?a.clone():new pc.Vec3(a[0],a[1],a[2]);case "vec4":return a instanceof pc.Vec4?a.clone():new pc.Vec4(a[0],a[1],a[2],a[3]);case "boolean":case "number":case "string":return a;
case "entity":return a;default:throw Error("Could not convert unhandled type: "+b);}}var b=function(a){pc.EventHandler.call(this);this.app=a;this.store={};this.schema=[]};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;Object.assign(b,{_helper:function(a,b){for(var c=0,f=a.length;c<f;c++)a[c].f.call(a[c].s,b)},initialize:function(a){this._helper(this._init,a)},postInitialize:function(a){this._helper(this._postInit,a);this.fire("postinitialize",a)},update:function(a,
b){this._helper(b?this._toolsUpdate:this._update,a)},fixedUpdate:function(a,b){this._helper(this._fixedUpdate,a)},postUpdate:function(a,b){this._helper(this._postUpdate,a)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_fixedUpdate:[],_postUpdate:[],bind:function(a,b,e){switch(a){case "initialize":this._init.push({f:b,s:e});break;case "postInitialize":this._postInit.push({f:b,s:e});break;case "update":this._update.push({f:b,s:e});break;case "postUpdate":this._postUpdate.push({f:b,s:e});break;case "fixedUpdate":this._fixedUpdate.push({f:b,
s:e});break;case "toolsUpdate":this._toolsUpdate.push({f:b,s:e});break;default:console.error("Component System does not support event",a)}},_erase:function(a,b,e){for(var c=0;c<a.length;c++)a[c].f===b&&a[c].s===e&&a.splice(c--,1)},unbind:function(a,b,e){switch(a){case "initialize":this._erase(this._init,b,e);break;case "postInitialize":this._erase(this._postInit,b,e);break;case "update":this._erase(this._update,b,e);break;case "postUpdate":this._erase(this._postUpdate,b,e);break;case "fixedUpdate":this._erase(this._fixedUpdate,
b,e);break;case "toolsUpdate":this._erase(this._toolsUpdate,b,e);break;default:console.error("Component System does not support event",a)}}});Object.assign(b.prototype,{addComponent:function(a,b){var c=new this.ComponentType(this,a),f=new this.DataType;b=b||{};this.store[a.getGuid()]={entity:a,data:f};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.store[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.store[a.getGuid()];
delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){a=this.store[a.getGuid()];return this.addComponent(b,a.data)},initializeComponentData:function(a,b,e){b=b||{};for(var c,g,n,k=0,h=e.length;k<h;k++)c=e[k],"object"===typeof c?(g=c.name,c=c.type):(g=c,c=void 0),n=b[g],void 0!==n?(void 0!==c&&(n=d(n,c)),a[g]=n):a[g]=a.data[g];if(a.enabled&&a.entity.enabled)a.onEnable()},getPropertiesOfType:function(a){var b=[];(this.schema||[]).forEach(function(c){c&&"object"===
typeof c&&c.type===a&&b.push(c)});return b},destroy:function(){this.off()}});pc.events.attach(b);b.destroy=function(){b.off("initialize");b.off("postInitialize");b.off("toolsUpdate");b.off("update");b.off("fixedUpdate");b.off("postUpdate")};return{ComponentSystem:b}}());Object.assign(pc,function(){var d=function(b,a){pc.EventHandler.call(this);this.system=b;this.entity=a;this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema);this.on("set",function(a,b,f){this.fire("set_"+a,a,b,f)});this.on("set_enabled",this.onSetEnabled,this)};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d._buildAccessors=function(b,a){a.forEach(function(a){var c="object"===typeof a?a.name:a;Object.defineProperty(b,c,{get:function(){return this.data[c]},
set:function(a){var b=this.data,e=b[c];b[c]=a;this.fire("set",c,e,a)},configurable:!0})});b._accessorsBuilt=!0};Object.assign(d.prototype,{buildAccessors:function(b){d._buildAccessors(this,b)},onSetEnabled:function(b,a,c){if(a!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}});Object.defineProperty(d.prototype,"data",{get:function(){var b=this.system.store[this.entity.getGuid()];return b?b.data:null}});
return{Component:d}}());Object.assign(pc,function(){return{ComponentData:function(){}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this.animationsIndex={};this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{play:function(b,a){if(this.enabled&&this.entity.enabled){var c=this.data;if(c.animations[b]){a=a||0;c.prevAnim=c.currAnim;c.currAnim=b;if(c.model){c.skeleton||c.animController||
this._createAnimationController();b=c.animations[c.prevAnim];var e=c.animations[c.currAnim];c.blending=0<a&&c.prevAnim;c.blending&&(c.blend=0,c.blendSpeed=1/a);c.skeleton&&(c.blending?(c.fromSkel.animation=b,c.fromSkel.addTime(c.skeleton._time),c.toSkel.animation=e):c.skeleton.animation=e);if(c.animController){a=c.animController;if(c.blending)for(;1<a.clips.length;)a.removeClip(0);else c.animController.removeClips();a=new pc.AnimClip(c.animations[c.currAnim],0,1,!0,c.loop);a.name=c.currAnim;a.blendWeight=
c.blending?0:1;a.reset();c.animController.addClip(a)}}c.playing=!0}}},getAnimation:function(b){return this.data.animations[b]},setModel:function(b){var a=this.data;b!==a.model&&(this._resetAnimationController(),a.model=b,a.animations&&a.currAnim&&a.animations[a.currAnim]&&this.play(a.currAnim))},_resetAnimationController:function(){var b=this.data;b.skeleton=null;b.fromSkel=null;b.toSkel=null;b.animController=null},_createAnimationController:function(){var b=this.data,a=b.model,c=b.animations,e=!1,
f=!1,d;for(d in c)c.hasOwnProperty(d)&&(c[d].constructor===pc.AnimTrack?f=!0:e=!0);a=a.getGraph();e?(b.fromSkel=new pc.Skeleton(a),b.toSkel=new pc.Skeleton(a),b.skeleton=new pc.Skeleton(a),b.skeleton.looping=b.loop,b.skeleton.setGraph(a)):f&&(b.animController=new pc.AnimController(new pc.DefaultAnimBinder(a)))},loadAnimationAssets:function(b){if(b&&b.length){var a=this,c=this.system.app.assets,e,f=b.length,d=function(b){if(1<b.resources.length)for(var c=0;c<b.resources.length;c++)a.animations[b.resources[c].name]=
b.resources[c],a.animationsIndex[b.id]=b.resources[c].name;else a.animations[b.name]=b.resource,a.animationsIndex[b.id]=b.name;a.animations=a.animations},n=function(b){b.off("change",a.onAssetChanged,a);b.on("change",a.onAssetChanged,a);b.off("remove",a.onAssetRemoved,a);b.on("remove",a.onAssetRemoved,a);b.resource?d(b):(b.once("load",d,a),a.enabled&&a.entity.enabled&&c.load(b))};for(e=0;e<f;e++){var k=c.get(b[e]);if(k)n(k);else c.on("add:"+b[e],n)}}},onAssetChanged:function(b,a,c,e){if("resource"===
a||"resources"===a)if(c){if(1<c.length){if(e&&1<e.length)for(a=0;a<e.length;a++)delete this.animations[e[a].name];else delete this.animations[b.name];e=!1;for(a=0;a<c.length;a++)this.animations[c[a].name]=c[a],!e&&this.data.currAnim===c[a].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(e=!0,this.play(c[a].name,0))}else{if(e&&1<e.length)for(a=0;a<e.length;a++)delete this.animations[e[a].name];this.animations[b.name]=c[0]||c;e=!1;this.data.currAnim===b.name&&this.data.playing&&this.data.enabled&&
this.entity.enabled&&(e=!0,this.play(b.name,0))}e||(this._stopCurrentAnimation(),this.onSetAnimations());this.animationsIndex[b.id]=b.name}else{if(1<e.length)for(a=0;a<e.length;a++)delete this.animations[e[a].name];else delete this.animations[b.name];delete this.animationsIndex[b.id]}},onAssetRemoved:function(b){b.off("remove",this.onAssetRemoved,this);if(this.animations){if(1<b.resources.length)for(var a=0;a<b.resources.length;a++)delete this.animations[b.resources[a].name],this.data.currAnim===
b.resources[a].name&&this._stopCurrentAnimation();else delete this.animations[b.name],this.data.currAnim===b.name&&this._stopCurrentAnimation();delete this.animationsIndex[b.id]}},_stopCurrentAnimation:function(){var b=this.data;b.currAnim=null;b.playing=!1;b.skeleton&&(b.skeleton.currentTime=0,b.skeleton.animation=null);b.animController&&b.animController.removeClips()},onSetAnimations:function(b,a,c){b=this.data;(a=this.entity.model)&&(a=a.model)&&a!==b.model&&this.setModel(a);if(!b.currAnim&&b.activate&&
b.enabled&&this.entity.enabled)for(var e in b.animations){this.play(e,0);break}},onSetAssets:function(b,a,c){if(a&&a.length)for(b=0;b<a.length;b++)if(a[b]){var e=this.system.app.assets.get(a[b]);if(e){e.off("change",this.onAssetChanged,this);e.off("remove",this.onAssetRemoved,this);var f=this.animationsIndex[e.id];this.data.currAnim===f&&this._stopCurrentAnimation();delete this.animations[f];delete this.animationsIndex[e.id]}}a=c.map(function(a){return a instanceof pc.Asset?a.id:a});this.loadAnimationAssets(a)},
onSetLoop:function(b,a,c){b=this.data;b.skeleton&&(b.skeleton.looping=b.loop);if(b.animController)for(a=0;a<b.animController.clips.length;++a)b.animController.clips[a].loop=b.loop},onSetCurrentTime:function(b,a,c){b=this.data;b.skeleton&&(a=b.skeleton,a.currentTime=c,a.addTime(0),a.updateGraph());if(b.animController)for(b=b.animController,a=0;a<b.clips.length;++a)b.clips[a].time=c},onEnable:function(){pc.Component.prototype.onEnable.call(this);var b=this.data,a=b.assets,c=this.system.app.assets;if(a)for(var e=
0,f=a.length;e<f;e++){var d=a[e];d instanceof pc.Asset||(d=c.get(d));d&&!d.resource&&c.load(d)}if(b.activate&&!b.currAnim)for(var n in b.animations){this.play(n,0);break}},onBeforeRemove:function(){for(var b=0;b<this.assets.length;b++){var a=this.system.app.assets.get(this.assets[b]);a&&(a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this))}b=this.data;delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel;delete b.animController}});Object.defineProperties(d.prototype,
{currentTime:{get:function(){return this.data.skeleton._time},set:function(b){var a=this.data;if(a.skeleton){var c=a.skeleton;c.currentTime=b;c.addTime(0);c.updateGraph()}if(a.animController)for(a=a.animController,c=0;c<a.clips.length;++c)a.clips[c].time=b}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});return{AnimationComponent:d}}());Object.assign(pc,function(){var d="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" "),b=function(a){pc.ComponentSystem.call(this,a);this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";this.ComponentType=pc.AnimationComponent;this.DataType=pc.AnimationComponentData;this.schema=d;this.on("beforeremove",this.onBeforeRemove,
this);this.on("update",this.onUpdate,this);pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.AnimationComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e=["activate","enabled","loop","speed","assets"];pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){var c;this.addComponent(b,{});b.animation.assets=
a.animation.assets.slice();b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;var f={},d=a.animation.animations;for(c in d)d.hasOwnProperty(c)&&(f[c]=d[c]);b.animation.animations=f;f={};a=a.animation.animationsIndex;for(c in a)a.hasOwnProperty(c)&&(f[c]=a[c]);b.animation.animationsIndex=f},onBeforeRemove:function(a,b){b.onBeforeRemove()},onUpdate:function(a){var b=this.store,e;
for(e in b)if(b.hasOwnProperty(e)){var f=b[e],d=f.data;if(d.enabled&&f.entity.enabled){d.blending&&(d.blend+=a*d.blendSpeed,1<=d.blend&&(d.blend=1));d.playing&&(f=d.skeleton,null!==f&&null!==d.model&&(d.blending?f.blend(d.fromSkel,d.toSkel,d.blend):(f.addTime(a*d.speed),0<d.speed&&f._time===f._animation.duration&&!d.loop?d.playing=!1:0>d.speed&&0===f._time&&!d.loop&&(d.playing=!1)),d.blending&&1===d.blend&&(f.animation=d.toSkel._animation),f.updateGraph()));if(f=d.animController){for(var n=0;n<f.clips.length;++n){var k=
f.clips[n];k.speed=d.speed;d.playing?k.resume():k.pause()}d.blending&&(f.clips[1].blendWeight=d.blend);f.update(a)}d.blending&&1===d.blend&&(d.blending=!1)}}}});return{AnimationComponentSystem:b}}());Object.assign(pc,function(){return{AnimationComponentData:function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.currAnim=this.prevAnim=this.model=null;this.blending=!1;this.blendSpeed=this.blend=0;this.playing=!1;this.animController=this.toSkel=this.fromSkel=this.skeleton=null}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this._type="asset";this._model=this._asset=null;this._mapping={};this._receiveShadows=this._castShadows=!0;this._materialAsset=null;this._material=b.defaultMaterial;this._castShadowsLightmap=!0;this._lightmapped=!1;this._lightmapSizeMultiplier=1;this._isStatic=!1;this._layers=[pc.LAYERID_WORLD];this._batchGroupId=-1;this._area=null;this._assetOld=0;this._materialEvents=null;this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=
!1;a.on("remove",this.onRemoveChild,this);a.on("insert",this.onInsertChild,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{setVisible:function(b){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=b},addModelToLayers:function(){for(var b,a=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(b=a.getLayerById(this._layers[c]))&&b.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(){for(var b,
a=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(b=a.getLayerById(this._layers[c]))&&b.removeMeshInstances(this.meshInstances)},onRemoveChild:function(){this._model&&this.removeModelFromLayers()},onInsertChild:function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null;this.materialAsset=null;this._unsetMaterialEvents();this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",
this.onInsertChild,this)},onLayersChanged:function(b,a){this.addModelToLayers();b.off("add",this.onLayerAdded,this);b.off("remove",this.onLayerRemoved,this);a.on("add",this.onLayerAdded,this);a.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(b){0>this.layers.indexOf(b.id)||b.addMeshInstances(this.meshInstances)},onLayerRemoved:function(b){0>this.layers.indexOf(b.id)||b.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(b,a,c,e){a=a+":"+c;this.system.app.assets.on(a,e,
this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[b]||(this._materialEvents[b]={});this._materialEvents[b][a]={id:c,handler:e}},_unsetMaterialEvents:function(){var b=this.system.app.assets,a=this._materialEvents;if(a){for(var c=0,e=a.length;c<e;c++)if(a[c]){var f=a[c],d;for(d in f)b.off(d,f[d].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(b){var a=null;isNaN(parseInt(b,10))?this.asset&&(b=this._getMaterialAssetUrl(b))&&(a=this.system.app.assets.getByUrl(b)):
a=this.system.app.assets.get(b);return a},_getMaterialAssetUrl:function(b){if(!this.asset)return null;var a=this.system.app.assets.get(this.asset);if(!a)return null;a=a.getFileUrl();a=pc.path.getDirectory(a);return pc.path.join(a,b)},_loadAndSetMeshInstanceMaterial:function(b,a,c){var e=this.system.app.assets;b&&(b.resource?(a.material=b.resource,this._setMaterialEvent(c,"remove",b.id,function(){a.material=this.system.defaultMaterial})):(this._setMaterialEvent(c,"load",b.id,function(e){a.material=
e.resource;this._setMaterialEvent(c,"remove",b.id,function(){a.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&e.load(b)))},onEnable:function(){var b=this.system.app,a=b.scene;a.on("set:layers",this.onLayersChanged,this);a.layers&&(a.layers.on("add",this.onLayerAdded,this),a.layers.on("remove",this.onLayerRemoved,this));a="asset"===this._type;var c;this._model?this.addModelToLayers():a&&this._asset&&(c=b.assets.get(this._asset))&&c.resource!==this._model&&this._bindModelAsset(c);
this._materialAsset&&(c=b.assets.get(this._materialAsset))&&c.resource!==this._material&&this._bindMaterialAsset(c);if(a&&this._mapping)for(var e in this._mapping)this._mapping[e]&&(c=this._getAssetByIdOrPath(this._mapping[e]))&&!c.resource&&b.assets.load(c);0<=this._batchGroupId&&b.batcher.insert(pc.BatchGroup.MODEL,this.batchGroupId,this.entity)},onDisable:function(){var b=this.system.app,a=b.scene;a.off("set:layers",this.onLayersChanged,this);a.layers&&(a.layers.off("add",this.onLayerAdded,this),
a.layers.off("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&b.batcher.remove(pc.BatchGroup.MODEL,this.batchGroupId,this.entity);this._model&&this.removeModelFromLayers()},hide:function(){if(this._model){var b,a=this._model.meshInstances;var c=0;for(b=a.length;c<b;c++)a[c].visible=!1}},show:function(){if(this._model){var b,a=this._model.meshInstances;var c=0;for(b=a.length;c<b;c++)a[c].visible=!0}},_bindMaterialAsset:function(b){b.on("load",this._onMaterialAssetLoad,this);b.on("unload",
this._onMaterialAssetUnload,this);b.on("remove",this._onMaterialAssetRemove,this);b.on("change",this._onMaterialAssetChange,this);b.resource?this._onMaterialAssetLoad(b):this.enabled&&this.entity.enabled&&this.system.app.assets.load(b)},_unbindMaterialAsset:function(b){b.off("load",this._onMaterialAssetLoad,this);b.off("unload",this._onMaterialAssetUnload,this);b.off("remove",this._onMaterialAssetRemove,this);b.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(b){this.system.app.assets.off("add:"+
b.id,this._onMaterialAssetAdd,this);this._materialAsset===b.id&&this._bindMaterialAsset(b)},_onMaterialAssetLoad:function(b){this._setMaterial(b.resource)},_onMaterialAssetUnload:function(b){this._setMaterial(this.system.defaultMaterial)},_onMaterialAssetRemove:function(b){this._onMaterialAssetUnload(b)},_onMaterialAssetChange:function(b){},_bindModelAsset:function(b){this._unbindModelAsset(b);b.on("load",this._onModelAssetLoad,this);b.on("unload",this._onModelAssetUnload,this);b.on("change",this._onModelAssetChange,
this);b.on("remove",this._onModelAssetRemove,this);b.resource?this._onModelAssetLoad(b):this.enabled&&this.entity.enabled&&this.system.app.assets.load(b)},_unbindModelAsset:function(b){b.off("load",this._onModelAssetLoad,this);b.off("unload",this._onModelAssetUnload,this);b.off("change",this._onModelAssetChange,this);b.off("remove",this._onModelAssetRemove,this)},_onModelAssetAdded:function(b){this.system.app.assets.off("add:"+b.id,this._onModelAssetAdd,this);b.id===this._asset&&this._bindModelAsset(b)},
_onModelAssetLoad:function(b){this.model=b.resource.clone();this._clonedModel=!0},_onModelAssetUnload:function(b){this.model=null},_onModelAssetChange:function(b,a,c,e){"data"===a&&(this.mapping=this._mapping)},_onModelAssetRemove:function(b){this.model=null},_setMaterial:function(b){if(this._material!==b){this._material=b;var a=this._model;if(a&&"asset"!==this._type){a=a.meshInstances;for(var c=0,e=a.length;c<e;c++)a[c].material=b}}}});Object.defineProperty(d.prototype,"meshInstances",{get:function(){return this._model?
this._model.meshInstances:null},set:function(b){this._model&&(this._model.meshInstances=b)}});Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(b){if(this._type!==b)if(this._area=null,this._type=b,"asset"===b)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var a=this.system,c=a.app.graphicsDevice;switch(b){case "box":a.box||(a.box=pc.createBox(c,{halfExtents:new pc.Vec3(.5,.5,.5)}));b=a.box;this._area={x:2,y:2,z:2,uv:2/3};break;case "capsule":a.capsule||
(a.capsule=pc.createCapsule(c,{radius:.5,height:2}));b=a.capsule;this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":a.cone||(a.cone=pc.createCone(c,{baseRadius:.5,peakRadius:0,height:1}));b=a.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":a.cylinder||(a.cylinder=pc.createCylinder(c,{radius:.5,height:1}));b=a.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":a.plane||(a.plane=pc.createPlane(c,{halfExtents:new pc.Vec2(.5,
.5),widthSegments:1,lengthSegments:1}));b=a.plane;this._area={x:0,y:1,z:0,uv:1};break;case "sphere":a.sphere||(a.sphere=pc.createSphere(c,{radius:.5}));b=a.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+b);}c=new pc.GraphNode;var e=new pc.Model;e.graph=c;e.meshInstances=[new pc.MeshInstance(c,b,this._material)];a._inTools&&e.generateWireframe();this.model=e;this._asset=null}}});Object.defineProperty(d.prototype,"asset",{get:function(){return this._asset},
set:function(b){var a=this.system.app.assets,c=b;b instanceof pc.Asset&&(c=b.id);this._asset!==c&&(this._asset&&(a.off("add:"+this._asset,this._onModelAssetAdded,this),(b=a.get(this._asset))&&this._unbindModelAsset(b)),(this._asset=c)?(c=a.get(this._asset))?this._bindModelAsset(c):(this.model=null,a.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}});Object.defineProperty(d.prototype,"model",{get:function(){return this._model},set:function(b){if(!(this._model===b||b&&b._immutable)&&
(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=b)){this._model._immutable=!0;var a=this._model.meshInstances;for(b=0;b<a.length;b++)a[b].castShadow=this._castShadows,a[b].receiveShadow=this._receiveShadows,a[b].isStatic=this._isStatic;this.lightmapped=this._lightmapped;this.entity.addChild(this._model.graph);this.enabled&&this.entity.enabled&&
this.addModelToLayers();this._model._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(this._model);"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}});Object.defineProperty(d.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(b){if(b!==this._lightmapped&&(this._lightmapped=b,this._model)){var a=this._model.meshInstances;if(b)for(b=0;b<a.length;b++){var c=a[b];var e=c.mask;c.mask=(e|pc.MASK_BAKED)&~(pc.MASK_DYNAMIC|pc.MASK_LIGHTMAP)}else for(b=
0;b<a.length;b++)c=a[b],c.deleteParameter("texture_lightMap"),c.deleteParameter("texture_dirLightMap"),c._shaderDefs&=~pc.SHADERDEF_LM,e=c.mask,c.mask=(e|pc.MASK_DYNAMIC)&~(pc.MASK_BAKED|pc.MASK_LIGHTMAP)}}});Object.defineProperty(d.prototype,"castShadows",{get:function(){return this._castShadows},set:function(b){if(this._castShadows!==b){var a,c,e=this._model;if(e){var f=this.layers,d=this.system.app.scene;if(this._castShadows&&!b)for(c=0;c<f.length;c++)(a=this.system.app.scene.layers.getLayerById(this.layers[c]))&&
a.removeShadowCasters(e.meshInstances);a=e.meshInstances;for(c=0;c<a.length;c++)a[c].castShadow=b;if(!this._castShadows&&b)for(c=0;c<f.length;c++)(a=d.layers.getLayerById(f[c]))&&a.addShadowCasters(e.meshInstances)}this._castShadows=b}}});Object.defineProperty(d.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(b){if(this._receiveShadows!==b&&(this._receiveShadows=b,this._model))for(var a=this._model.meshInstances,c=0,e=a.length;c<e;c++)a[c].receiveShadow=b}});Object.defineProperty(d.prototype,
"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(b){this._castShadowsLightmap=b}});Object.defineProperty(d.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(b){this._lightmapSizeMultiplier=b}});Object.defineProperty(d.prototype,"isStatic",{get:function(){return this._isStatic},set:function(b){if(this._isStatic!==b){this._isStatic=b;var a;if(this._model){var c=this._model.meshInstances;for(a=0;a<c.length;a++){var e=
c[a];e.isStatic=b}}}}});Object.defineProperty(d.prototype,"layers",{get:function(){return this._layers},set:function(b){var a,c,e=this.system.app.scene.layers;if(this.meshInstances)for(a=0;a<this._layers.length;a++)(c=e.getLayerById(this._layers[a]))&&c.removeMeshInstances(this.meshInstances);for(a=this._layers.length=0;a<b.length;a++)this._layers[a]=b[a];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(a=0;a<this._layers.length;a++)(c=e.getLayerById(this._layers[a]))&&c.addMeshInstances(this.meshInstances)}});
Object.defineProperty(d.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(b){if(this._batchGroupId!==b){var a=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&a.remove(pc.BatchGroup.MODEL,this.batchGroupId,this.entity);this.entity.enabled&&0<=b&&a.insert(pc.BatchGroup.MODEL,b,this.entity);0>b&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers();this._batchGroupId=b}}});Object.defineProperty(d.prototype,"materialAsset",
{get:function(){return this._materialAsset},set:function(b){var a=b;b instanceof pc.Asset&&(a=b.id);b=this.system.app.assets;if(a!==this._materialAsset){if(this._materialAsset){b.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var c=b.get(this._materialAsset);c&&this._unbindMaterialAsset(c)}(this._materialAsset=a)?(a=b.get(this._materialAsset))?this._bindMaterialAsset(a):(this._setMaterial(this.system.defaultMaterial),b.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this._setMaterial(this.system.defaultMaterial)}}});
Object.defineProperty(d.prototype,"material",{get:function(){return this._material},set:function(b){this._material!==b&&(this.materialAsset=null,this._setMaterial(b))}});Object.defineProperty(d.prototype,"mapping",{get:function(){return this._mapping},set:function(b){if("asset"===this._type&&(this._unsetMaterialEvents(),b||(b={}),this._mapping=b,this._model)){var a=this._model.meshInstances,c=this.asset?this.system.app.assets.get(this.asset):null;c=c?c.data.mapping:null;for(var e=null,f=0,d=a.length;f<
d;f++)if(void 0!==b[f])b[f]?(e=this.system.app.assets.get(b[f]),this._loadAndSetMeshInstanceMaterial(e,a[f],f)):a[f].material=this.system.defaultMaterial;else if(c)if(c[f]&&(c[f].material||c[f].path)){if(void 0!==c[f].material)e=this.system.app.assets.get(c[f].material);else if(void 0!==c[f].path){var n=this._getMaterialAssetUrl(c[f].path);n&&(e=this.system.app.assets.getByUrl(n))}this._loadAndSetMeshInstanceMaterial(e,a[f],f)}else a[f].material=this.system.defaultMaterial}}});return{ModelComponent:d}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="model";this.description="Renders a 3D model at the location of the Entity.";this.ComponentType=pc.ModelComponent;this.DataType=pc.ModelComponentData;this.schema=d;this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null;this.defaultMaterial=a.scene.defaultMaterial;this.on("beforeremove",this.onRemove,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=
b;pc.Component._buildAccessors(pc.ModelComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" ");if(null===b.batchGroupId||void 0===b.batchGroupId)b.batchGroupId=-1;b.layers&&b.layers.length&&(b.layers=b.layers.slice(0));for(var c=0;c<e.length;c++)b.hasOwnProperty(e[c])&&(a[e[c]]=b[e[c]]);pc.ComponentSystem.prototype.initializeComponentData.call(this,
a,b,["enabled"])},cloneComponent:function(a,b){var c={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,isStatic:a.model.isStatic,enabled:a.model.enabled,layers:a.model.layers,batchGroupId:a.model.batchGroupId,mapping:pc.extend({},a.model.mapping)},f=a.model.materialAsset;f instanceof pc.Asset||null==f||(f=this.app.assets.get(f));
var d=a.model.material;d&&d!==this.defaultMaterial&&f&&d!==f.resource||(c.materialAsset=f);b=this.addComponent(b,c);a.model.model&&"asset"===a.model.type&&!a.model.asset&&(b.model=a.model.model.clone(),b._clonedModel=!0);c.materialAsset||(b.material=d);if(a.model.model)for(a=a.model.model.meshInstances,c=b.model.meshInstances,d=0;d<a.length;d++)c[d].mask=a[d].mask,c[d].material=a[d].material,c[d].layer=a[d].layer,c[d].receiveShadow=a[d].receiveShadow},onRemove:function(a,b){b.onRemove()}});return{ModelComponentSystem:b}}());Object.assign(pc,function(){return{ModelComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this);this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,
this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_clearStencilBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this);this.on("set_scissorRect",this.onSetScissorRect,this);this.on("set_horizontalFov",this.onSetHorizontalFov,this);this.on("set_frustumCulling",this.onSetFrustumCulling,this);
this.on("set_calculateTransform",this.onSetCalculateTransform,this);this.on("set_calculateProjection",this.onSetCalculateProjection,this);this.on("set_cullFaces",this.onSetCullFaces,this);this.on("set_flipFaces",this.onSetFlipFaces,this);this.on("set_layers",this.onSetLayers,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.defineProperty(d.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(d.prototype,
"viewMatrix",{get:function(){return this.data.camera.getViewMatrix()}});Object.defineProperty(d.prototype,"frustum",{get:function(){return this.data.camera.frustum}});Object.defineProperty(d.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(b){if(this.data.camera.vrDisplay=b)b._camera=this.data.camera}});Object.defineProperty(d.prototype,"node",{get:function(){return this.data.camera._node}});Object.assign(d.prototype,{screenToWorld:function(b,a,c,e){var f=this.system.app.graphicsDevice;
return this.data.camera.screenToWorld(b,a,c,f.clientRect.width,f.clientRect.height,e)},onPrerender:function(){this.data.camera._viewMatDirty=!0;this.data.camera._viewProjMatDirty=!0},worldToScreen:function(b,a){var c=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(b,c.clientRect.width,c.clientRect.height,a)},onSetAspectRatioMode:function(b,a,c){this.data.camera.aspectRatioMode=c},onSetAspectRatio:function(b,a,c){this.data.camera.aspectRatio=c},onSetCamera:function(b,a,c){a&&(a._node=
null);c._node=this.entity},onSetClearColor:function(b,a,c){b=this.data.camera.clearColor;b[0]=c.r;b[1]=c.g;b[2]=c.b;b[3]=c.a},onSetFov:function(b,a,c){this.data.camera.fov=c},onSetOrthoHeight:function(b,a,c){this.data.camera.orthoHeight=c},onSetNearClip:function(b,a,c){this.data.camera.nearClip=c},onSetFarClip:function(b,a,c){this.data.camera.farClip=c},onSetHorizontalFov:function(b,a,c){this.data.camera.horizontalFov=c},onSetFrustumCulling:function(b,a,c){this.data.camera.frustumCulling=c},onSetCalculateTransform:function(b,
a,c){this._calculateTransform=c;this.camera.overrideCalculateTransform=!!c},onSetCalculateProjection:function(b,a,c){this._calculateProjection=c;this.camera._projMatDirty=!0;this.camera.overrideCalculateProjection=!!c},onSetCullFaces:function(b,a,c){this.camera._cullFaces=c},onSetFlipFaces:function(b,a,c){this.camera._flipFaces=c},onSetProjection:function(b,a,c){this.data.camera.projection=c},onSetPriority:function(b,a,c){for(a=0;a<this.layers.length;a++)(b=this.system.app.scene.layers.getLayerById(this.layers[a]))&&
b._sortCameras()},onSetLayers:function(b,a,c){var e;for(b=0;b<a.length;b++)(e=this.system.app.scene.layers.getLayerById(a[b]))&&e.removeCamera(this);if(this.enabled&&this.entity.enabled)for(b=0;b<c.length;b++)(e=this.system.app.scene.layers.getLayerById(c[b]))&&e.addCamera(this)},addCameraToLayers:function(){for(var b,a=0;a<this.layers.length;a++)(b=this.system.app.scene.layers.getLayerById(this.layers[a]))&&b.addCamera(this)},removeCameraFromLayers:function(){for(var b,a=0;a<this.layers.length;a++)(b=
this.system.app.scene.layers.getLayerById(this.layers[a]))&&b.removeCamera(this)},onLayersChanged:function(b,a){this.addCameraToLayers();b.off("add",this.onLayerAdded,this);b.off("remove",this.onLayerRemoved,this);a.on("add",this.onLayerAdded,this);a.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(b){0>this.layers.indexOf(b.id)||b.addCamera(this)},onLayerRemoved:function(b){0>this.layers.indexOf(b.id)||b.removeCamera(this)},updateClearFlags:function(){var b=0;this.clearColorBuffer&&(b|=
pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&(b|=pc.CLEARFLAG_DEPTH);this.clearStencilBuffer&&(b|=pc.CLEARFLAG_STENCIL);this.data.camera.clearFlags=b},onSetRenderTarget:function(b,a,c){this.data.camera.renderTarget=c},onSetRect:function(b,a,c){this.data.camera.setRect(c.x,c.y,c.z,c.w)},onSetScissorRect:function(b,a,c){this.data.camera.setScissorRect(c.x,c.y,c.z,c.w)},onEnable:function(){this.system.addCamera(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&
(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers();this.postEffects.enable()},onDisable:function(){this.postEffects.disable();this.removeCameraFromLayers();this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,
this));this.system.removeCamera(this)},onRemove:function(){this.onDisable();this.off()},calculateAspectRatio:function(b){b=b?b:this.system.app.graphicsDevice;var a=this.rect;return b.width*a.z/(b.height*a.w)},frameBegin:function(b){this.aspectRatioMode===pc.ASPECT_AUTO&&(this.aspectRatio=this.calculateAspectRatio(b));this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(b,a){b instanceof Function&&!a&&(a=b,b=null);if(this.system.app.vr)if(b||(b=this.system.app.vr.display),
b){var c=this;b.capabilities.canPresent?b.requestPresent(function(e){e||(c.vrDisplay=b,c.vrDisplay.once("beforepresentchange",function(a){a.presenting||(c.vrDisplay=null)}));a(e)}):(c.vrDisplay=b,a())}else a("No pc.VrDisplay to present");else a("VrManager not created. Enable VR in project settings.")},exitVr:function(b){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var a=this.vrDisplay;this.vrDisplay=null;a.exitPresent(b)}else this.vrDisplay=null,b();else b("Not presenting VR")},startXr:function(b,
a,c){this.system.app.xr.start(this,b,a,c)},endXr:function(b){this.camera.xr?this.camera.xr.end(b):b&&b(Error("Camera is not in XR"))}});return{CameraComponent:d}}());Object.assign(pc,function(){var d="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),b=function(a){pc.ComponentSystem.call(this,a);this.id="camera";this.description="Renders the scene from the location of the Entity.";this.ComponentType=pc.CameraComponent;
this.DataType=pc.CameraComponentData;this.schema=d;this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);this.app.on("prerender",this.onPrerender,this);pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.CameraComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ");
for(var c={},d=0,n=e.length;d<n;d++){var k=e[d];c[k]=b[k]}c.layers&&"array"===pc.type(c.layers)&&(c.layers=c.layers.slice(0));c.clearColor&&"array"===pc.type(c.clearColor)&&(b=c.clearColor,c.clearColor=new pc.Color(b[0],b[1],b[2],b[3]));c.rect&&"array"===pc.type(c.rect)&&(b=c.rect,c.rect=new pc.Vec4(b[0],b[1],b[2],b[3]));c.scissorRect&&"array"===pc.type(c.scissorRect)&&(b=c.scissorRect,c.scissorRect=new pc.Vec4(b[0],b[1],b[2],b[3]));c.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),
c.enabled=c.activate);c.camera=new pc.Camera;c._node=a.entity;c.camera._component=a;c.camera.calculateTransform=function(b,c){return a._calculateTransform?a._calculateTransform(b,c):null};c.camera.calculateProjection=function(b,c){return a._calculateProjection?a._calculateProjection(b,c):null};c.postEffects=new pc.PostEffectQueue(this.app,a);pc.ComponentSystem.prototype.initializeComponentData.call(this,a,c,e)},onBeforeRemove:function(a,b){this.removeCamera(b);b.onRemove()},onRemove:function(a,b){b.camera=
null},onUpdate:function(a){a=this.store;if(this.app.vr)for(var b in a){var e=a[b];var f=e.data;var d=f.camera;var n=d.vrDisplay;f.enabled&&e.entity.enabled&&n&&(n.setClipPlanes(d._nearClip,d._farClip),d._node&&(d._node.localTransform.copy(n.combinedViewInv),d._node._dirtyLocal=!1,d._node._dirtifyWorld()))}},onPrerender:function(){for(var a=0,b=this.cameras.length;a<b;a++)this.cameras[a].onPrerender()},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=
this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})}});return{CameraComponentSystem:b}}());Object.assign(pc,function(){return{CameraComponentData:function(){this.clearColor=new pc.Color(.722,.722,.722,1);this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.PROJECTION_PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.scissorRect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.cullFaces=!0;this.flipFaces=!1;this.layers=[pc.LAYERID_WORLD,pc.LAYERID_DEPTH,pc.LAYERID_SKYBOX,
pc.LAYERID_UI,pc.LAYERID_IMMEDIATE];this.camera=null;this.aspectRatio=16/9;this.aspectRatioMode=pc.ASPECT_AUTO;this.postEffects=this.renderTarget=null;this.isRendering=!1;this.calculateProjection=this.calculateTransform=null}}}());Object.assign(pc,function(){function d(a,b){var c=this;this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){c.resizeRenderTargets()};b.on("set_rect",this.onCameraRectChanged,this);this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}var b;Object.assign(d.prototype,{_createOffscreenTarget:function(a,b){var c=this.camera.rect,
f=Math.floor(c.z*this.app.graphicsDevice.width*this.renderTargetScale);c=Math.floor(c.w*this.app.graphicsDevice.height*this.renderTargetScale);var d=this.app.graphicsDevice,n=b?d.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8;b=this.app.graphicsDevice.supportsStencil;var k=a?d.samples:1;f=new pc.Texture(d,{format:n,width:f,height:c});f.name="posteffect #"+this.effects.length;f.minFilter=pc.FILTER_NEAREST;f.magFilter=pc.FILTER_NEAREST;f.addressU=pc.ADDRESS_CLAMP_TO_EDGE;f.addressV=pc.ADDRESS_CLAMP_TO_EDGE;
return new pc.RenderTarget(this.app.graphicsDevice,f,{depth:a,stencil:b,samples:k})},_resizeOffscreenTarget:function(a){var b=this.camera.rect,e=Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale);b=Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale);var f=this.app.graphicsDevice,d=a.colorBuffer.format;a._colorBuffer.destroy();e=new pc.Texture(f,{format:d,width:e,height:b});e.name="posteffect";e.minFilter=pc.FILTER_NEAREST;e.magFilter=pc.FILTER_NEAREST;e.addressU=
pc.ADDRESS_CLAMP_TO_EDGE;e.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a._colorBuffer=e;a.destroy()},_destroyOffscreenTarget:function(a){a._colorBuffer&&a._colorBuffer.destroy();a._depthBuffer&&a._depthBuffer.destroy();a.destroy()},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=this.effects,e={effect:a,inputTarget:this._createOffscreenTarget(0===this.effects.length,a.hdr),outputTarget:null};if(!this.layer){this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,
transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var a=0;a<this._commandList.length;a++)this._commandList[a]()}});var f=this.app.scene.layers.layerList,d=0,n,k=f.length-1;for(n=k;0<=n;n--)if(f[n].id===pc.LAYERID_UI){k=n-1;this._origOverrideClear=f[n].overrideClear;this._origClearColorBuffer=f[n].clearColorBuffer;this._origDepthColorBuffer=f[n].clearDepthBuffer;this._origStencilColorBuffer=f[n].clearStencilBuffer;
f[n].overrideClear=!0;f[n].clearColorBuffer=!1;f[n].clearDepthBuffer=this.camera.clearDepthBuffer;f[n].clearStencilBuffer=this.camera.clearStencilBuffer;break}this._sourceLayers=[];for(n=0;n<this.camera.layers.length;n++){f=this.camera.layers[n];var h=this.app.scene.layers.getLayerById(f),m=this.app.scene.layers.layerList.indexOf(h);m<=k&&(f!=pc.LAYERID_DEPTH&&(h.renderTarget=e.inputTarget,this._sourceLayers.push(h)),m>d&&(d=m))}this.app.scene.layers.insertOpaque(this.layer,d+1);this._sourceTarget=
e.inputTarget;this.layer._commandList=[];this.layer.isPostEffect=!0}b.push(e);d=b.length;1<d&&(b[d-2].outputTarget=e.inputTarget);this._newPostEffect=a;a.needsDepthBuffer&&this._requestDepthMap();this.enable();this._newPostEffect=void 0},removeEffect:function(a){var b,e=-1;var f=0;for(b=this.effects.length;f<b;f++)if(this.effects[f].effect===a){e=f;break}if(0<=e){if(0<e)this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||
(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),f=0;f<this._sourceLayers.length;f++)this._sourceLayers[f].renderTarget=this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[e].inputTarget);this.effects.splice(e,1)}this.enabled&&a.needsDepthBuffer&&this._releaseDepthMap();0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var a=
0,b=this.effects.length;a<b;a++){var e=this.effects[a].effect;this._newPostEffect!==e&&e.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this._releaseDepthMap()},_requestDepthMap:function(){b||(b=this.app.scene.layers.getLayerById(pc.LAYERID_DEPTH));b&&b.incrementCounter()},_releaseDepthMap:function(){b&&b.decrementCounter()},destroy:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();
this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this;this._requestDepthMaps();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=function(){if(a.enabled){var b=null,e=a.effects.length;if(e){a.layer.renderTarget=a.effects[0].inputTarget;for(var f=0;f<e;f++){var d=a.effects[f];f===e-1&&(b=a.camera.rect);d.effect.render(d.inputTarget,d.outputTarget,b)}}}};this.layer._commandList.push(this.command)}},
disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this._releaseDepthMaps();this._destroyOffscreenTarget(this._sourceTarget);var a=this.layer._commandList.indexOf(this.command);0<=a&&this.layer._commandList.splice(a,1);var b=this.app.scene.layers.layerList,e=b.length-1;for(a=0;a<=b.length;a++)if(b[a].id===pc.LAYERID_UI){e=a-1;b[a].overrideClear=this._origOverrideClear;b[a].clearColorBuffer=this._origClearColorBuffer;b[a].clearDepthBuffer=
this._origDepthColorBuffer;b[a].clearStencilBuffer=this._origStencilColorBuffer;break}for(a=e;0<=a;a--)0<=b[a].cameras.indexOf(this.camera)&&(b[a].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer);this.layer=null}},_onCanvasResized:function(a,b){a=this.camera.rect;b=this.app.graphicsDevice;this.camera.camera.aspectRatio=b.width*a.z/(b.height*a.w);this.resizeTimeout||(100<pc.now()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,
100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null);this.resizeLast=pc.now();var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*this.renderTargetScale);a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var e=this.effects,f=0,d=e.length;f<d;f++){var n=e[f];n.inputTarget.width===b&&n.inputTarget.height===a||this._resizeOffscreenTarget(n.inputTarget)}},onCameraRectChanged:function(a,b,e){this.enabled&&
this.resizeRenderTargets()}});return{PostEffectQueue:d}}());Object.assign(pc,function(){function d(d,m){this.app=d;this.srcRenderTarget=m.srcRenderTarget;this.hdr=m.hdr;this.blending=m.blending;this.shader=m.shader;this.setup=m.setup;var l=this,p=d.graphicsDevice;this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:m.name,onPostRender:function(){l.srcRenderTarget?(e.x=l.srcRenderTarget.width,e.y=l.srcRenderTarget.height,e.z=1/l.srcRenderTarget.width,e.w=1/l.srcRenderTarget.height):(e.x=p.width,e.y=
p.height,e.z=1/p.width,e.w=1/p.height);f[0]=e.x;f[1]=e.y;f[2]=e.z;f[3]=e.w;c.setValue(f);if(this._postEffectCombined&&0>this._postEffectCombined)l.setup&&l.setup(p,l,e,null,this.renderTarget);else{var g=this._postEffectCombinedSrc?this._postEffectCombinedSrc:l.srcRenderTarget?l.srcRenderTarget:b[this._backbufferRtId];1<g._samples&&g.resolve(!0,!1);var k=g._colorBuffer;k.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?pc.FILTER_LINEAR:pc.FILTER_NEAREST;
a.setValue(k);l.setup&&l.setup(p,l,e,g,this.renderTarget);(g=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&pc.drawQuadWithShader(p,this.renderTarget,g,null,null,l.blending);if(!l.srcRenderTarget)for(g=d.scene.layers.layerList,k=0;k<g.length&&g[k]!==l.layer;k++)if(g[k].renderTarget===b[0]||g[k].renderTarget===b[1])g[k].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=!0;this.layer.unmodifiedUvs=m.unmodifiedUvs;this.layer.postEffectBilinear=
m.bilinear;this.layer.postEffect=this;this.layer.shader=m.shader;this.layer.renderTarget=m.destRenderTarget;if(!a){a=p.scope.resolve("uColorBuffer");c=p.scope.resolve("uScreenSize");m=p.supportsMsaa?4:1;for(var B=0;2>B;B++)b[B]=new pc.RenderTarget({depth:!0,stencil:p.supportsStencil,samples:m,autoResolve:!1}),b[B].name="backbuffer"+B;d.on("prerender",function(){var a=d.scene.layers.layerList,c,e=0,f=0;h=k=n=!1;var m=pc.PIXELFORMAT_R8_G8_B8_A8;if(d.scene.layers._dirty){var l=0;for(c=0;c<a.length;c++){var w=
!1;var B;if((B=a[c].isPostEffect)&&!(B=0===l)&&(B=a[c].unmodifiedUvs&&a[c].shader)){a:{var H,M,G;var K=a;var V=g;var L=l,Q=I(a[c].shader.definition.fshader);if(0!==Q.length)for(G=0;G<L;G++)for(M=0;M<Q.length;M++){B=Q[M];var X=I(K[V[G]].shader.definition.fshader);for(H=0;H<X.length;H++)if(X[H]===B){B=!0;break a}}B=!1}B=!B}B?(g[l]=c,l++,c===a.length-1&&(w=!0)):0<l&&(w=!0);if(w){if(1<l){B="post_";for(w=0;w<l;w++)X=a[g[w]],B+=X.name?X.name:X.id,w<l-1&&(B+="_");X=p.programLib._cache[B];if(!X){H="vec4 shaderOutput;\n";
M="void main() {\n";G=[];for(w=0;w<l;w++){X=a[g[w]].shader.definition.fshader+"\n";X=X.replace(x,"//").replace(v,"//").replace(y,"//").replace(A,"shaderOutput");0<w&&(X=X.replace(z,"//").replace(E,"//").replace(C,"shaderOutput;//"));X=X.replace(D,"void main"+w);var ba;Q=X;V=G;var O=Q.length;var ca=0,W=ba=0;L="";for(K=0;K<O;K++){var da=Q.charAt(K);"{"===da?(0===ba&&(ca=K),ba++):"}"===da&&(1===ba&&(da=K,L+=Q.substr(W,ca-W+1),W=da),ba--)}L+=Q.substr(W,Q.length-W+1);ca=null;W=L.match(q)||[];for(K=0;K<
W.length;K++)for(Q=W[K].split(","),O=0;O<Q.length;O++)ba=Q[O].replace(r,"").trim(),0<=V.indexOf(ba)?(ca||(ca=[]),ca.push(ba)):V.push(ba);L=L.match(t)||[];for(K=0;K<L.length;K++)for(Q=L[K].split(","),O=0;O<Q.length;O++)ba=Q[O].replace(u,"").trim(),ba=V.indexOf(ba),0<=ba&&V.splice(ba,1);if(K=ca)for(V=0;V<K.length;V++)X=X.replace(new RegExp("\\b"+K[V]+"\\b","g"),K[V]+"NNNN"+w);H+=X;M+="main"+w+"();\n"}M+="gl_FragColor = shaderOutput;\n}\n";X=pc.shaderChunks.createShaderFromCode(p,pc.shaderChunks.fullscreenQuadVS,
H+M,B)}for(w=0;w<l;w++)a[g[w]]._postEffectCombined=w===l-1?1:-1;a[g[l-1]]._postEffectCombinedShader=X;a[g[l-1]]._postEffectCombinedBilinear=a[g[0]].postEffectBilinear;a[g[l-1]]._postEffectCombinedSrc=a[g[0]].postEffect.srcRenderTarget}g[0]=c;l=1}}}for(c=0;c<a.length;c++){if(a[c].isPostEffect&&(!a[c].postEffect.srcRenderTarget&&!a[c]._postEffectCombined||!a[c].postEffect._postEffectCombinedSrc&&0<=a[c]._postEffectCombined)){for(w=c-1;w>=e;w--)a[w].renderTarget||(a[w].renderTarget=b[f]);a[c]._backbufferRtId=
f;e=c;n=!0;1===f&&(k=!0);a[c].postEffect.hdr&&(m=p.webgl2&&p.textureFloatRenderable?pc.PIXELFORMAT_111110F:p.extTextureHalfFloatLinear&&p.textureHalfFloatRenderable?pc.PIXELFORMAT_RGBA16F:pc.PIXELFORMAT_R8_G8_B8_A8);a[c].postEffect.shader&&!a[c].renderTarget&&(f=1-f)}else a[c].isPostEffect||a[c].renderTarget||!n||(a[c].renderTarget=b[f]);a[c].isPostEffect&&!a[c].renderTarget&&(h=!0)}if(n)if(!b[0].colorBuffer)F(0,p,m);else if(b[0].width!==p.width||b[0].height!==p.height||b[0]._colorBuffer._format!==
m)b[0].colorBuffer.destroy(),b[0].destroy(),F(0,p,m);if(k)if(!b[1].colorBuffer)F(1,p,m);else if(b[1].width!==p.width||b[1].height!==p.height||b[1]._colorBuffer._format!==m)b[1].colorBuffer.destroy(),b[1].destroy(),F(1,p,m)},this);d.on("postrender",function(){var a=d.graphicsDevice;if(n&&!h){for(var c=d.scene.layers.layerList,e,f=c.length-1;0<=f&&(e=c[f].renderTarget,e!==b[0]&&e!==b[1]);f--);e&&(1<e._samples&&e.resolve(!0,!1),a.copyRenderTarget(e,null,!0,!1))}},this)}}var b=[null,null],a=null,c,e=
new pc.Vec4,f=new Float32Array(4),g=[],n=!1,k=!1,h=!1,m=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,l=/\S+[ \t\n\r]*;/,p=/[ \t\n\r]*;/,q=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,r=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,t=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,u=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,x=/#version/g,v=/out highp vec4 pc_fragColor;/g,
y=/#define gl_FragColor/g,A=/gl_FragColor/g,z=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,E=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,C=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,D=/void[ \t\n\r]+main/g,F=function(a,c,e){c=new pc.Texture(c,{format:e,width:c.width,height:c.height});c.name="posteffect-pass";c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;b[a]._colorBuffer=c},I=function(a){a=
a.match(m)||[];for(var b,c,e=[],f=0;f<a.length;f++)b=a[f].search(l),c=a[f].search(p),b=a[f].substr(b,c-b),"uColorBuffer"!==b&&e.push(b);return e};d.prototype.addToComposition=function(a){this.app.scene.layers.insertTransparent(this.layer,a)};return{PostEffectPass:d}}());Object.assign(pc,function(){var d=function(a,b){pc.Component.call(this,a,b);this._cookieAssetId=this._cookieAsset=null;this._cookieAssetAdd=!1;this._cookieMatrix=null};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;var b=[],a=[],c=function(c,f,g,n){var e=d.prototype;b.push(c);a.push(f);Object.defineProperty(e,c,{get:function(){return this.data[c]},set:function(a){var b=this.data,e=b[c];if(n||e!==a)b[c]=a,g&&g.call(this,a,e)},configurable:!0})};(function(){c("enabled",
!0,function(a,b){this.onSetEnabled(null,b,a)});c("light",null);c("type","directional",function(a,b){this.system.changeType(this,b,a);this.refreshProperties()});c("color",new pc.Color(1,1,1),function(a,b){this.light.setColor(a)},!0);c("intensity",1,function(a,b){this.light.intensity=a});c("castShadows",!1,function(a,b){this.light.castShadows=a});c("shadowDistance",40,function(a,b){this.light.shadowDistance=a});c("shadowResolution",1024,function(a,b){this.light.shadowResolution=a});c("shadowBias",.05,
function(a,b){this.light.shadowBias=-.01*a});c("normalOffsetBias",0,function(a,b){this.light.normalOffsetBias=a});c("range",10,function(a,b){this.light.attenuationEnd=a});c("innerConeAngle",40,function(a,b){this.light.innerConeAngle=a});c("outerConeAngle",45,function(a,b){this.light.outerConeAngle=a});c("falloffMode",pc.LIGHTFALLOFF_LINEAR,function(a,b){this.light.falloffMode=a});c("shadowType",pc.SHADOW_PCF3,function(a,b){this.light.shadowType=a});c("vsmBlurSize",11,function(a,b){this.light.vsmBlurSize=
a});c("vsmBlurMode",pc.BLUR_GAUSSIAN,function(a,b){this.light.vsmBlurMode=a});c("vsmBias",.0025,function(a,b){this.light.vsmBias=a});c("cookieAsset",null,function(a,b){if(!this._cookieAssetId||!(a instanceof pc.Asset&&a.id===this._cookieAssetId||a===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,a instanceof pc.Asset)this._cookieAssetId=this.data.cookieAsset=a.id,this.onCookieAssetAdd(a);else if("number"===typeof a)if(this._cookieAssetId=a,a=this.system.app.assets.get(a))this.onCookieAssetAdd(a);
else this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this)});c("cookie",null,function(a,b){this.light.cookie=a});c("cookieIntensity",1,function(a,b){this.light.cookieIntensity=a});c("cookieFalloff",!0,function(a,b){this.light.cookieFalloff=a});c("cookieChannel","rgb",function(a,b){this.light.cookieChannel=a});c("cookieAngle",0,function(a,b){if(0!==a||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);var c=b=1;this.cookieScale&&
(b=this.cookieScale.x,c=this.cookieScale.y);var e=Math.cos(a*pc.math.DEG_TO_RAD);a=Math.sin(a*pc.math.DEG_TO_RAD);this._cookieMatrix.set(e/b,-a/b,a/c,e/c);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});c("cookieScale",null,function(a,b){if(null!==a||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);b=a.x;a=a.y;var c=Math.cos(this.cookieAngle*pc.math.DEG_TO_RAD),e=Math.sin(this.cookieAngle*pc.math.DEG_TO_RAD);this._cookieMatrix.set(c/b,
-e/b,e/a,c/a);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0);c("cookieOffset",null,function(a,b){this.light.cookieOffset=a},!0);c("shadowUpdateMode",pc.SHADOWUPDATE_REALTIME,function(a,b){this.light.shadowUpdateMode=a});c("mask",1,function(a,b){this.light.mask=a});c("affectDynamic",!0,function(a,b){this.light.mask=a?this.light.mask|pc.MASK_DYNAMIC:this.light.mask&~pc.MASK_DYNAMIC});c("affectLightmapped",!1,function(a,b){a?(this.light.mask|=pc.MASK_BAKED,this.bake&&
(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP))});c("bake",!1,function(a,b){a?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED))});c("bakeDir",!0,function(a,b){this.light.bakeDir=a});c("isStatic",!1,function(a,b){this.light.isStatic=a});c("layers",[pc.LAYERID_WORLD],function(a,b){var c,e;for(c=
0;c<b.length;c++)(e=this.system.app.scene.layers.getLayerById(b[c]))&&e.removeLight(this);for(c=0;c<a.length;c++)(e=this.system.app.scene.layers.getLayerById(a[c]))&&this.enabled&&this.entity.enabled&&e.addLight(this)})})();Object.defineProperty(d.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=
a}});Object.assign(d.prototype,{addLightToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addLight(this)},removeLightFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeLight(this)},onLayersChanged:function(a,b){this.enabled&&this.entity.enabled&&this.addLightToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);
b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this.enabled&&this.entity.enabled&&a.addLight(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeLight(this)},refreshProperties:function(){for(var a,c=0;c<b.length;c++)a=b[c],this[a]=this[a];if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var a=!1;"cubemap"!==this._cookieAsset.type||
this._cookieAsset.loadFaces||(a=this._cookieAsset.loadFaces=!0);this._cookieAsset.resource&&!a||this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()},onCookieAssetAdd:function(a){if(this._cookieAssetId===a.id){this._cookieAsset=a;if(this.light.enabled)this.onCookieAssetSet();this._cookieAsset.on("load",this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)}},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&
(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0;this.system.app.scene.on("set:layers",this.onLayersChanged,
this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1;this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",
this.onLayerRemoved,this));this.removeLightFromLayers()},onRemove:function(){this.light.destroy();this.cookieAsset=null}});return{LightComponent:d,_lightProps:b,_lightPropsDefault:a}}());Object.assign(pc,function(){var d={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},b=function(a){pc.ComponentSystem.call(this,a);this.id="light";this.description="Enables the Entity to emit light.";this.ComponentType=pc.LightComponent;this.DataType=pc.LightComponentData;this.on("beforeremove",this._onRemoveComponent,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;Object.assign(b.prototype,{initializeComponentData:function(a,
b){for(var c=pc._lightProps,f={},g=0,n=c.length;g<n;g++){var k=c[g];f[k]=b[k]}f.type||(f.type=a.data.type);a.data.type=f.type;f.layers&&"array"===pc.type(f.layers)&&(f.layers=f.layers.slice(0));f.color&&"array"===pc.type(f.color)&&(f.color=new pc.Color(f.color[0],f.color[1],f.color[2]));f.cookieOffset&&f.cookieOffset instanceof Array&&(f.cookieOffset=new pc.Vec2(f.cookieOffset[0],f.cookieOffset[1]));f.cookieScale&&f.cookieScale instanceof Array&&(f.cookieScale=new pc.Vec2(f.cookieScale[0],f.cookieScale[1]));
f.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),f.enabled=f.enable);b=new pc.Light;b.type=d[f.type];b._node=a.entity;b._scene=this.app.scene;a.data.light=b;pc.ComponentSystem.prototype.initializeComponentData.call(this,a,f,c)},_onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.light;for(var c=[],f,d=pc._lightProps,n=0;n<d.length;n++)f=d[n],"light"!==f&&(c[f]=a[f]&&a[f].clone?a[f].clone():a[f]);this.addComponent(b,c)},changeType:function(a,
b,e){b!==e&&(a.light.type=d[e])}});return{LightComponentSystem:b}}());Object.assign(pc,function(){return{LightComponentData:function(){for(var d=pc._lightProps,b=pc._lightPropsDefault,a,c=0;c<d.length;c++)a=b[c],this[d[c]]=a&&a.clone?a.clone():a}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this._scripts=[];this._updateList=new pc.SortedLoopArray({sortBy:"__executionOrder"});this._postUpdateList=new pc.SortedLoopArray({sortBy:"__executionOrder"});this._scriptsIndex={};this._destroyedScripts=[];this._destroyed=!1;this._scriptsData=null;this._enabled=this._oldState=!0;this._isLoopingThroughScripts=this._beingEnabled=!1;this._executionOrder=-1;this.on("set_enabled",this._onSetEnabled,this)};d.prototype=Object.create(pc.Component.prototype);
d.prototype.constructor=d;d.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};Object.assign(d.prototype,{onEnable:function(){this._beingEnabled=!0;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var b,a=this._beginLooping(),c=0,e=this.scripts.length;c<e;c++)b=this.scripts[c],b._initialized&&!b._postInitialized&&
b.enabled&&(b._postInitialized=!0,b.postInitialize&&this._scriptMethod(b,d.scriptMethods.postInitialize));this._endLooping(a)},_beginLooping:function(){var b=this._isLoopingThroughScripts;this._isLoopingThroughScripts=!0;return b},_endLooping:function(b){(this._isLoopingThroughScripts=b)||this._removeDestroyedScripts()},_onSetEnabled:function(b,a,c){this._beingEnabled=!0;this._checkState();this._beingEnabled=!1},_checkState:function(){var b=this.enabled&&this.entity.enabled;if(b!==this._oldState){this._oldState=
b;this.fire(b?"enable":"disable");this.fire("state",b);b?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);b=this._beginLooping();for(var a,c=0,e=this.scripts.length;c<e;c++)a=this.scripts[c],a.enabled=a._enabled;this._endLooping(b)}},_onBeforeRemove:function(){this.fire("remove");for(var b=this._beginLooping(),a=0;a<this.scripts.length;a++){var c=this.scripts[a];c&&this.destroy(c.__scriptType.__name)}this._endLooping(b)},_removeDestroyedScripts:function(){var b=
this._destroyedScripts.length;if(b){var a;for(a=0;a<b;a++)this._removeScriptInstance(this._destroyedScripts[a]);this._destroyedScripts.length=0;this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var b=0,a=this.scripts.length;b<a;b++)this.scripts[b].__initializeAttributes()},_scriptMethod:function(b,a,c){b[a](c)},_onInitialize:function(){for(var b,a=this._scripts,c=this._beginLooping(),e=0,f=a.length;e<f;e++)b=a[e],!b._initialized&&b.enabled&&(b._initialized=
!0,b.initialize&&this._scriptMethod(b,d.scriptMethods.initialize));this._endLooping(c)},_onPostInitialize:function(){this.onPostStateChange()},_onUpdate:function(b){var a=this._updateList;if(a.length){var c=this._beginLooping();for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++){var e=a.items[a.loopIndex];e.enabled&&this._scriptMethod(e,d.scriptMethods.update,b)}this._endLooping(c)}},_onPostUpdate:function(b){var a=this._postUpdateList;if(a.length){var c=this._beginLooping();for(a.loopIndex=0;a.loopIndex<
a.length;a.loopIndex++){var e=a.items[a.loopIndex];e.enabled&&this._scriptMethod(e,d.scriptMethods.postUpdate,b)}this._endLooping(c)}},_insertScriptInstance:function(b,a,c){-1===a?(this._scripts.push(b),b.__executionOrder=c,b.update&&this._updateList.append(b),b.postUpdate&&this._postUpdateList.append(b)):(this._scripts.splice(a,0,b),b.__executionOrder=a,this._resetExecutionOrder(a+1,c+1),b.update&&this._updateList.insert(b),b.postUpdate&&this._postUpdateList.insert(b))},_removeScriptInstance:function(b){var a=
this._scripts.indexOf(b);if(-1===a)return a;this._scripts.splice(a,1);b.update&&this._updateList.remove(b);b.postUpdate&&this._postUpdateList.remove(b);return a},_resetExecutionOrder:function(b,a){for(;b<a;b++)this._scripts[b].__executionOrder=b},has:function(b){if("string"===typeof b)return!!this._scriptsIndex[b];if(!b)return!1;var a=this._scriptsIndex[b.__name];return(a&&a.instance)instanceof b},get:function(b){if("string"===typeof b)return(b=this._scriptsIndex[b])?b.instance:null;if(!b)return null;
var a=this._scriptsIndex[b.__name];a=a&&a.instance;return a instanceof b?a:null},create:function(b,a){var c=this;a=a||{};var e=b,f=b;"string"===typeof e?e=this.system.app.scripts.get(e):e&&(f=e.__name);if(e){if(!this._scriptsIndex[f]||!this._scriptsIndex[f].instance){b=new e({app:this.system.app,entity:this.entity,enabled:a.hasOwnProperty("enabled")?a.enabled:!0,attributes:a.attributes});e=this._scripts.length;var g=-1;"number"===typeof a.ind&&-1!==a.ind&&e>a.ind&&(g=a.ind);this._insertScriptInstance(b,
g,e);this._scriptsIndex[f]={instance:b,onSwap:function(){c.swap(f)}};this[f]=b;a.preloading||b.__initializeAttributes();this.fire("create",f,b);this.fire("create:"+f,b);this.system.app.scripts.on("swap:"+f,this._scriptsIndex[f].onSwap);a.preloading||(b.enabled&&!b._initialized&&(b._initialized=!0,b.initialize&&this._scriptMethod(b,d.scriptMethods.initialize)),b.enabled&&!b._postInitialized&&(b._postInitialized=!0,b.postInitialize&&this._scriptMethod(b,d.scriptMethods.postInitialize)));return b}console.warn("script '"+
f+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[f]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+f+"' is not found, awaiting it to be added to registry");return null},destroy:function(b){var a=b;"string"===typeof b?this.system.app.scripts.get(b):b&&(a=b.__name);b=this._scriptsIndex[a];delete this._scriptsIndex[a];if(!b)return!1;var c=b.instance;if(c&&!c._destroyed)if(c.enabled=!1,c._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(c);
else{var e=this._removeScriptInstance(c);0<=e&&this._resetExecutionOrder(e,this._scripts.length)}this.system.app.scripts.off("swap:"+a,b.onSwap);delete this[a];this.fire("destroy",a,c||null);this.fire("destroy:"+a,c||null);c&&c.fire("destroy");return!0},swap:function(b){var a=b;"string"===typeof b?b=this.system.app.scripts.get(b):b&&(a=b.__name);var c=this._scriptsIndex[a];if(!c||!c.instance)return!1;c=c.instance;var e=this._scripts.indexOf(c);b=new b({app:this.system.app,entity:this.entity,enabled:c.enabled,
attributes:c.__attributes});if(!b.swap)return!1;b.__initializeAttributes();this._scripts[e]=b;this._scriptsIndex[a].instance=b;this[a]=b;b.__executionOrder=e;c.update&&this._updateList.remove(c);c.postUpdate&&this._postUpdateList.remove(c);b.update&&this._updateList.insert(b);b.postUpdate&&this._postUpdateList.insert(b);this._scriptMethod(b,d.scriptMethods.swap,c);this.fire("swap",a,b);this.fire("swap:"+a,b);return!0},resolveDuplicatedEntityReferenceProperties:function(b,a){var c=this.entity.script,
e;for(e in b._scriptsIndex){var f=this.system.app.scripts.get(e);if(f){var d=b._scriptsIndex[e];if(d&&d.instance){var n=c[e].__attributesRaw,k=c[e].__attributes;if(n||k){d=d.instance.__attributes;for(var h in d)if(d[h]){var m=f.attributes.get(h);if(m&&"entity"===m.type)if(m.array){var l=d[h];if(m=l.length){l=l.slice();for(var p=0;p<m;p++){var q=l[p]instanceof pc.Entity?l[p].getGuid():l[p];a[q]&&(l[p]=n?a[q].getGuid():a[q])}n?n[h]=l:k[h]=l}}else{m=d[h];if(m instanceof pc.Entity)m=m.getGuid();else if("string"!==
typeof m)continue;a[m]&&(n?n[h]=a[m].getGuid():k[h]=a[m])}}}}}}},move:function(b,a){var c=this._scripts.length;if(a>=c||0>a)return!1;var e=b,f=b;"string"!==typeof f?f=b.__name:e=null;b=this._scriptsIndex[f];if(!b||!b.instance)return!1;b=b.instance;if(e&&!(b instanceof e))return!1;e=this._scripts.indexOf(b);if(-1===e||e===a)return!1;this._scripts.splice(a,0,this._scripts.splice(e,1)[0]);this._resetExecutionOrder(0,c);this._updateList.sort();this._postUpdateList.sort();this.fire("move",f,b,a,e);this.fire("move:"+
f,b,a,e);return!0}});Object.defineProperty(d.prototype,"enabled",{get:function(){return this._enabled},set:function(b){var a=this._enabled;this._enabled=b;this.fire("set","enabled",a,b)}});Object.defineProperty(d.prototype,"scripts",{get:function(){return this._scripts},set:function(b){this._scriptsData=b;for(var a in b)if(b.hasOwnProperty(a)){var c=this._scriptsIndex[a];if(c){if("boolean"===typeof b[a].enabled&&(c.enabled=!!b[a].enabled),"object"===typeof b[a].attributes)for(var e in b[a].attributes)if(!pc.createScript.reservedAttributes[e]){if(!c.__attributes.hasOwnProperty(e)){var f=
this.system.app.scripts.get(a);f&&f.attributes.add(e,{})}c[e]=b[a].attributes[e]}}else console.log(this.order)}}});return{ScriptComponent:d}}());Object.assign(pc,function(){var d=0,b=function(a){pc.ComponentSystem.call(this,a);this.id="script";this.app=a;this.ComponentType=pc.ScriptComponent;this.DataType=pc.ScriptComponentData;this._components=new pc.SortedLoopArray({sortBy:"_executionOrder"});this._enabledComponents=new pc.SortedLoopArray({sortBy:"_executionOrder"});this.preloading=!0;this.on("beforeremove",this._onBeforeRemove,this);pc.ComponentSystem.bind("initialize",this._onInitialize,this);pc.ComponentSystem.bind("postInitialize",this._onPostInitialize,
this);pc.ComponentSystem.bind("update",this._onUpdate,this);pc.ComponentSystem.bind("postUpdate",this._onPostUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;Object.assign(b.prototype,{initializeComponentData:function(a,b){a._executionOrder=d++;this._components.append(a);d>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder();a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:!0;a.enabled&&a.entity.enabled&&this._enabledComponents.append(a);if(b.hasOwnProperty("order")&&
b.hasOwnProperty("scripts")){a._scriptsData=b.scripts;for(var c=0;c<b.order.length;c++)a.create(b.order[c],{enabled:b.scripts[b.order[c]].enabled,attributes:b.scripts[b.order[c]].attributes,preloading:this.preloading})}},cloneComponent:function(a,b){var c,f,d=[],n={};for(c=0;c<a.script._scripts.length;c++){var k=a.script._scripts[c],h=k.__scriptType.__name;d.push(h);var m={};for(f in k.__attributes)m[f]=k.__attributes[f];n[h]={enabled:k._enabled,attributes:m}}for(f in a.script._scriptsIndex)f.awaiting&&
d.splice(f.ind,0,f);return this.addComponent(b,{enabled:a.script.enabled,order:d,scripts:n})},_resetExecutionOrder:function(){for(var a=d=0,b=this._components.length;a<b;a++)this._components.items[a]._executionOrder=d++},_callComponentMethod:function(a,b,e){for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++)a.items[a.loopIndex][b](e)},_onInitialize:function(){this.preloading=!1;this._callComponentMethod(this._components,"_onInitializeAttributes");this._callComponentMethod(this._enabledComponents,
"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},_onUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onUpdate",a)},_onPostUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",a)},_addComponentToEnabled:function(a){this._enabledComponents.insert(a)},_removeComponentFromEnabled:function(a){this._enabledComponents.remove(a)},_onBeforeRemove:function(a,b){0<=this._components.items.indexOf(b)&&
b._onBeforeRemove();this._removeComponentFromEnabled(b);this._components.remove(b)}});return{ScriptComponentSystem:b}}());Object.assign(pc,function(){return{ScriptComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this.on("set_scripts",this.onSetScripts,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{send:function(b,a){console.warn("DEPRECATED: ScriptLegacyComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,f;if(e&&
e[b]&&(f=e[b].instance[a]))return f.apply(e[b].instance,c)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(b,a,c){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(a,c)||(this.enabled&&
this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,b=c.map(function(a){return a.url}),this._loadFromCache(b)||this._loadScripts(b))},_updateScriptAttributes:function(b,a){var c=!0;if(b.length!==a.length)c=!1;else{var e,f=a.length;for(e=0;e<f;e++)if(b[e].url!==a[e].url){c=!1;break}}if(c)for(var d in this.instances)this.instances.hasOwnProperty(d)&&this.system._updateAccessors(this.entity,this.instances[d]);return c},_loadFromCache:function(b){var a,
c=[],e=this.system.app._scriptPrefix||"",f=/^http(s)?:\/\//i;var d=0;for(a=b.length;d<a;d++){var n=b[d];f.test(n)||(n=pc.path.join(e,n));n=this.system.app.loader.getFromCache(n,"script");if(!n)return!1;c.push(n)}d=0;for(a=c.length;d<a;d++)e=c[d],!0!==e&&e&&this.entity.script&&!this.entity.script.instances[e._pcScriptName]&&(f=new e(this.entity),this.system._preRegisterInstance(this.entity,b[d],e._pcScriptName,f));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),
this.system.onPostInitialize(this.entity));return!0},_loadScripts:function(b){var a=b.length,c=this.system.app._scriptPrefix||"";b.forEach(function(b){var e=null,d=null;b.toLowerCase().startsWith("http://")||b.toLowerCase().startsWith("https://")?e=d=b:(d=b,e=pc.path.join(c,b));this.system.app.loader.load(e,"script",function(b,c){a--;b?console.error(b):c&&this.entity.script&&!this.entity.script.instances[c._pcScriptName]&&(b=new c(this.entity),this.system._preRegisterInstance(this.entity,d,c._pcScriptName,
b));0===a&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});return{ScriptLegacyComponent:d}}());Object.assign(pc,function(){var d=["enabled","scripts","instances","runInTools"],b=function(a){pc.ComponentSystem.call(this,a);this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";this.ComponentType=pc.ScriptLegacyComponent;this.DataType=pc.ScriptLegacyComponentData;this.schema=d;this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",
this.onBeforeRemove,this);pc.ComponentSystem.bind("initialize",this.onInitialize,this);pc.ComponentSystem.bind("postInitialize",this.onPostInitialize,this);pc.ComponentSystem.bind("update",this.onUpdate,this);pc.ComponentSystem.bind("fixedUpdate",this.onFixedUpdate,this);pc.ComponentSystem.bind("postUpdate",this.onPostUpdate,this);pc.ComponentSystem.bind("toolsUpdate",this.onToolsUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ScriptLegacyComponent.prototype,
d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e=["runInTools","enabled","scripts"];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&"array"===pc.type(a.attributes)){for(var b={},c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=a.attributes[c];a.attributes=b}});pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){var c=this.store[a.getGuid()];a={runInTools:c.data.runInTools,scripts:[],enabled:c.data.enabled};
c=c.data.scripts;for(var f=0,d=c.length;f<d;f++){var n=c[f].attributes;n&&delete c[f].attributes;a.scripts.push(pc.extend({},c[f]));n&&(a.scripts[f].attributes=this._cloneAttributes(n),c[f].attributes=n)}return this.addComponent(b,a)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);a=a._children;var b,e=a.length;
for(b=0;b<e;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);a=a._children;var b,e=a.length;for(b=0;b<e;b++)if(a[b]instanceof pc.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){a=a.data.instances;for(var c in a)if(a.hasOwnProperty(c)){var f=a[c].instance;if(f[b])f[b]()}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");
a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var b=a.data.instances,e;for(e in b)if(b.hasOwnProperty(e)){var f=b[e].instance;f.destroy&&f.destroy();if(f.update){var d=this.instancesWithUpdate.indexOf(f);0<=d&&this.instancesWithUpdate.splice(d,1)}f.fixedUpdate&&(d=this.instancesWithFixedUpdate.indexOf(f),
0<=d&&this.instancesWithFixedUpdate.splice(d,1));f.postUpdate&&(d=this.instancesWithPostUpdate.indexOf(f),0<=d&&this.instancesWithPostUpdate.splice(d,1));f.toolsUpdate&&(d=this.instancesWithToolsUpdate.indexOf(f),0<=d&&this.instancesWithToolsUpdate.splice(d,1));a.instances[e].instance===a[e]&&delete a[e];delete a.instances[e]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,e){for(var c,d=0,n=b.length;d<
n;d++)if((c=b[d])&&c.entity&&c.entity.enabled&&c.entity.script.enabled)c[a](e)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn("DEPRECATED: ScriptLegacyComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");
var c=pc.makeArray(arguments).slice(2),f,d,n=this.store;for(f in n)if(n.hasOwnProperty(f)){var k=n[f].data;k.instances[a]&&(d=k.instances[a].instance[b])&&d.apply(k.instances[a].instance,c)}},_preRegisterInstance:function(a,b,e,f){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[e])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",e,b,a.script.data._instances[e].url,a.getGuid()));a.script.data._instances[e]=
{url:b,name:e,instance:f}}},_registerInstances:function(a){var b;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(b in a.script.instances){var e=a.script.instances[b];var f=e.instance;pc.events.attach(f);f.update&&this.instancesWithUpdate.push(f);f.fixedUpdate&&this.instancesWithFixedUpdate.push(f);f.postUpdate&&this.instancesWithPostUpdate.push(f);f.toolsUpdate&&this.instancesWithToolsUpdate.push(f);a.script.scripts&&this._createAccessors(a,e);if(a.script[b])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",
b));a.script[b]=f}delete a.script.data._instances}a=a._children;f=a.length;for(e=0;e<f;e++)a[e]instanceof pc.Entity&&this._registerInstances(a[e])},_cloneAttributes:function(a){var b={},e;for(e in a)if(a.hasOwnProperty(e))if("entity"!==a[e].type)b[e]=pc.extend({},a[e]);else{var f=a[e].value;delete a[e].value;b[e]=pc.extend({},a[e]);b[e].value=f;a[e].value=f}return b},_createAccessors:function(a,b){var c,f=a.script.scripts.length,d=b.url;for(c=0;c<f;c++){var n=a.script.scripts[c];if(n.url===d){c=n.attributes;
if(n.name&&c){for(var k in c)c.hasOwnProperty(k)&&this._createAccessor(c[k],b);a.script.data.attributes[n.name]=this._cloneAttributes(c)}break}}},_createAccessor:function(a,b){var c=this;a={name:a.name,value:a.value,type:a.type};c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(e){var f=a.value;a.value=e;c._convertAttributeValue(a);b.instance.fire("set",a.name,f,a.value)},configurable:!0})},_updateAccessors:function(a,b){var c,f=a.script.scripts.length,
d,n=b.url;for(c=0;c<f;c++){var k=a.script;var h=k.scripts[c];if(h.url===n){a=h.name;h=h.attributes;if(a){if(h)for(d in h)h.hasOwnProperty(d)&&this._createAccessor(h[d],b);if(c=k.data.attributes[a])for(d in c)if(f=c[d],!(d in h))delete b.instance[f.name];else if(h[d].value!==f.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(f.name,f.value,h[d].value);h?k.data.attributes[a]=this._cloneAttributes(h):delete k.data.attributes[a]}break}}},_convertAttributeValue:function(a){if("rgb"===
a.type||"rgba"===a.type)"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3]));else if("vec2"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec2(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec4(a.value[0],a.value[1],
a.value[2],a.value[3]));else if("entity"===a.type)null!==a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=new (a.value.keys[0]instanceof Array?pc.CurveSet:pc.Curve)(a.value.keys),a.value.type=a.value.type}});return{ScriptLegacyComponentSystem:b}}());Object.assign(pc,function(){return{ScriptLegacyComponentData:function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1}}}());Object.assign(pc,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"});Object.assign(pc,function(){var d={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new pc.Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},b=function(a,b,e){pc.EventHandler.call(this);e=e||{};this._component=a;this._assets=a.system.app.assets;this._manager=a.system.manager;this._name=b||"Untitled";this._volume=void 0!==e.volume?pc.math.clamp(Number(e.volume)||0,0,1):1;this._pitch=void 0!==e.pitch?Math.max(.01,
Number(e.pitch)||0):1;this._loop=!(void 0===e.loop||!e.loop);this._duration=0<e.duration?e.duration:null;this._startTime=Math.max(0,Number(e.startTime)||0);this._overlap=!!e.overlap;this._autoPlay=!!e.autoPlay;this._lastNode=this._firstNode=null;this._asset=e.asset;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this._onInstancePlayHandler=this._onInstancePlay.bind(this);this._onInstancePauseHandler=this._onInstancePause.bind(this);this._onInstanceResumeHandler=this._onInstanceResume.bind(this);
this._onInstanceStopHandler=this._onInstanceStop.bind(this);this._onInstanceEndHandler=this._onInstanceEnd.bind(this);this.instances=[]};b.prototype=Object.create(pc.EventHandler.prototype);b.prototype.constructor=b;Object.assign(b.prototype,{play:function(){this.overlap||this.stop();if(this.isLoaded||this._hasAsset()){var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var b=function(b){var c=a._playWhenLoaded;a.sound=b;c&&a.play()};this.off("load",b);this.once("load",
b);this.load()}return a}},pause:function(){for(var a=!1,b=this.instances,e=0,f=b.length;e<f;e++)b[e].pause()&&(a=!0);return a},resume:function(){for(var a=!1,b=this.instances,e=0,f=b.length;e<f;e++)b[e].resume()&&(a=!0);return a},stop:function(){for(var a=!1,b=this.instances,e=b.length;e--;)b[e].stop(),a=!0;b.length=0;return a},load:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,this),a.resource?this.fire("load",
a.resource):(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,b){if(a){if(b||(b=a),this._firstNode=a,this._lastNode=b,!this._overlap)for(var c=this.instances,f=0,d=c.length;f<d;f++)c[f].setExternalNodes(a,b)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){this._lastNode=
this._firstNode=null;if(!this._overlap)for(var a=this.instances,b=0,e=a.length;b<e;b++)a[b].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var a=this._component;var b=null;if(this._hasAsset()){var e=this._assets.get(this._asset);e&&(b=e.resource)}d.volume=this._volume*a.volume;d.pitch=this._pitch*a.pitch;d.loop=this._loop;d.startTime=this._startTime;d.duration=this._duration;d.onPlay=
this._onInstancePlayHandler;d.onPause=this._onInstancePauseHandler;d.onResume=this._onInstanceResumeHandler;d.onStop=this._onInstanceStopHandler;d.onEnd=this._onInstanceEndHandler;a.positional?(d.position.copy(a.entity.getPosition()),d.maxDistance=a.maxDistance,d.refDistance=a.refDistance,d.rollOffFactor=a.rollOffFactor,d.distanceModel=a.distanceModel,a=new pc.SoundInstance3d(this._manager,b,d)):a=new pc.SoundInstance(this._manager,b,d);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);
return a},_onInstancePlay:function(a){this.fire("play",a);this._component.fire("play",this,a)},_onInstancePause:function(a){this.fire("pause",a);this._component.fire("pause",this,a)},_onInstanceResume:function(a){this.fire("resume",a);this._component.fire("resume",this,a)},_onInstanceStop:function(a){var b=this.instances.indexOf(a);-1!==b&&this.instances.splice(b,1);this.fire("stop",a);this._component.fire("stop",this,a)},_onInstanceEnd:function(a){var b=this.instances.indexOf(a);-1!==b&&this.instances.splice(b,
1);this.fire("end",a);this._component.fire("end",this,a)},_onAssetAdd:function(a){this.load()},_onAssetLoad:function(a){this.load()},_onAssetRemoved:function(a){a.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,this);this.stop()},updatePosition:function(a){for(var b=this.instances,e=0,f=b.length;e<f;e++)b[e].position=a}});Object.defineProperty(b.prototype,"name",{get:function(){return this._name},set:function(a){this._name=a}});Object.defineProperty(b.prototype,
"volume",{get:function(){return this._volume},set:function(a){this._volume=pc.math.clamp(Number(a)||0,0,1);if(!this._overlap){a=this.instances;for(var b=0,e=a.length;b<e;b++)a[b].volume=this._volume*this._component.volume}}});Object.defineProperty(b.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);if(!this._overlap){a=this.instances;for(var b=0,e=a.length;b<e;b++)a[b].pitch=this.pitch*this._component.pitch}}});Object.defineProperty(b.prototype,
"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;a=this.instances;for(var b=0,e=a.length;b<e;b++)a[b].loop=this._loop}});Object.defineProperty(b.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(a){this._autoPlay=!!a}});Object.defineProperty(b.prototype,"overlap",{get:function(){return this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(b.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=
Math.max(0,Number(a)||0);if(!this._overlap){a=this.instances;for(var b=0,e=a.length;b<e;b++)a[b].startTime=this._startTime}}});Object.defineProperty(b.prototype,"duration",{get:function(){var a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap){a=this.instances;for(var b=0,e=a.length;b<e;b++)a[b].duration=this._duration}}});Object.defineProperty(b.prototype,
"asset",{get:function(){return this._asset},set:function(a){var b=this._asset;b&&(this._assets.off("add:"+b,this._onAssetAdd,this),(b=this._assets.get(b))&&b.off("remove",this._onAssetRemoved,this));this._asset=a;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}});Object.defineProperty(b.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});
Object.defineProperty(b.prototype,"isPlaying",{get:function(){for(var a=this.instances,b=0,e=a.length;b<e;b++)if(a[b].isPlaying)return!0;return!1}});Object.defineProperty(b.prototype,"isPaused",{get:function(){var a=this.instances,b=a.length;if(0===b)return!1;for(var e=0;e<b;e++)if(!a[e].isPaused)return!1;return!0}});Object.defineProperty(b.prototype,"isStopped",{get:function(){for(var a=this.instances,b=0,e=a.length;b<e;b++)if(!a[b].isStopped)return!1;return!0}});return{SoundSlot:b}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this.on("set_slots",this.onSetSlots,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_refDistance",this.onSetRefDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_positional",this.onSetPositional,this)};d.prototype=Object.create(pc.Component.prototype);
d.prototype.constructor=d;Object.assign(d.prototype,{onSetSlots:function(b,a,c){var e;if(a)for(e in a)a[e].stop();b={};for(e in c)c[e]instanceof pc.SoundSlot?b[c[e].name]=c[e]:c[e].name&&(b[c[e].name]=new pc.SoundSlot(this,c[e].name,c[e]));this.data.slots=b;if(this.enabled&&this.entity.enabled)this.onEnable()},onSetVolume:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap)for(var f=a.instances,d=0,n=f.length;d<n;d++)f[d].volume=a.volume*c},onSetPitch:function(b,a,c){b=this.data.slots;
for(var e in b)if(a=b[e],!a.overlap)for(var f=a.instances,d=0,n=f.length;d<n;d++)f[d].pitch=a.pitch*c},onSetRefDistance:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap){a=a.instances;for(var f=0,d=a.length;f<d;f++)a[f].refDistance=c}},onSetMaxDistance:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap){a=a.instances;for(var f=0,d=a.length;f<d;f++)a[f].maxDistance=c}},onSetRollOffFactor:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap){a=
a.instances;for(var f=0,d=a.length;f<d;f++)a[f].rollOffFactor=c}},onSetDistanceModel:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap){a=a.instances;for(var f=0,d=a.length;f<d;f++)a[f].distanceModel=c}},onSetPositional:function(b,a,c){b=this.data.slots;for(var e in b)if(a=b[e],!a.overlap){c=a.instances;for(var f=0,d=c.length;f<d;f++){var n=c[f].isPlaying||c[f].isSuspended,k=c[f].currentTime;n&&c[f].stop();c[f]=a._createInstance();n&&(c[f].play(),c[f].currentTime=k)}}},onEnable:function(){if(!this.system._inTools){var b=
this.data.slots,a=this.data.playingBeforeDisable,c;for(c in b){var e=b[c];e.autoPlay&&e.isStopped?e.play():a[c]?e.resume():e.isLoaded||e.load()}}},onDisable:function(){var b=this.data.slots,a={},c;for(c in b)!b[c].overlap&&b[c].isPlaying&&(b[c].pause(),a[c]=!0);this.data.playingBeforeDisable=a},onRemove:function(){this.off()},addSlot:function(b,a){var c=this.data.slots;if(c[b])return logWARNING("A sound slot with name "+b+" already exists on Entity "+this.entity.path),null;a=new pc.SoundSlot(this,
b,a);c[b]=a;a.autoPlay&&this.enabled&&this.entity.enabled&&a.play();return a},removeSlot:function(b){var a=this.data.slots;a[b]&&(a[b].stop(),delete a[b])},slot:function(b){return this.data.slots[b]},play:function(b){if(!this.enabled||!this.entity.enabled)return null;var a=this.slots[b];return a?a.play():(logWARNING("Trying to play sound slot with name "+b+" which does not exist"),null)},pause:function(b){var a=this.data.slots;if(b)(a=a[b])?a.pause():logWARNING("Trying to pause sound slot with name "+
b+" which does not exist");else for(var c in a)a[c].pause()},resume:function(b){var a=this.data.slots;if(b)(a=a[b])?a.isPaused&&a.resume():logWARNING("Trying to resume sound slot with name "+b+" which does not exist");else for(var c in a)a[c].resume()},stop:function(b){var a=this.data.slots;if(b)(a=a[b])?a.stop():logWARNING("Trying to stop sound slot with name "+b+" which does not exist");else for(var c in a)a[c].stop()}});return{SoundComponent:d}}());Object.assign(pc,function(){var d="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" "),b=function(a,b){pc.ComponentSystem.call(this,a);this.id="sound";this.description="Allows an Entity to play sounds";this.ComponentType=pc.SoundComponent;this.DataType=pc.SoundComponentData;this.schema=d;this.manager=b;pc.ComponentSystem.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);
b.prototype.constructor=b;pc.Component._buildAccessors(pc.SoundComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" ");pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){var c;a=a.sound.data;var f={};for(c in a)a.hasOwnProperty(c)&&(f[c]=a[c]);f.slots={};for(c in a.slots){var d=a.slots[c];f.slots[c]=d instanceof
pc.SoundSlot?{name:d.name,volume:d.volume,pitch:d.pitch,loop:d.loop,duration:d.duration,startTime:d.startTime,overlap:d.overlap,autoPlay:d.autoPlay,asset:d.asset}:d}f.playingBeforeDisable={};return this.addComponent(b,f)},onUpdate:function(a){a=this.store;for(var b in a)if(a.hasOwnProperty(b)){var e=a[b],f=e.entity;e=e.data;if(e.enabled&&f.enabled&&e.positional){f=f.getPosition();e=e.slots;for(var d in e)e[d].updatePosition(f)}}},onBeforeRemove:function(a,b){a=b.slots;for(var c in a)a[c].overlap||
a[c].stop();b.onRemove()}});Object.defineProperty(b.prototype,"volume",{get:function(){return this.manager.volume},set:function(a){this.manager.volume=a}});Object.defineProperty(b.prototype,"context",{get:function(){return pc.SoundManager.hasAudioContext()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}});return{SoundComponentSystem:b}}());pc.SoundComponentData=function(){this.enabled=!0;this.pitch=this.volume=1;this.positional=!0;this.refDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_LINEAR;this.slots={};this.playingBeforeDisable={}};Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_3d",this.onSet3d,this)};
d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{play:function(b){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var a=this.data;if(a.sources[b]){if(a["3d"]){var c=this.entity.getPosition();c=this.system.manager.playSound3d(a.sources[b],c,a)}else c=this.system.manager.playSound(a.sources[b],a);a.currentSource=b;a.channel=c}}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&
this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(b,a,c){b=[];var e,f=c.length;if(a&&a.length)for(e=0;e<a.length;e++)if(a[e]){var d=this.system.app.assets.get(a[e]);d&&(d.off("change",this.onAssetChanged,this),d.off("remove",this.onAssetRemoved,this),this.currentSource===d.name&&this.stop())}if(f)for(e=0;e<f;e++)0>a.indexOf(c[e])&&(c[e]instanceof pc.Asset?b.push(c[e].id):b.push(c[e]));!this.system._inTools&&b.length&&this.loadAudioSourceAssets(b)},
onAssetChanged:function(b,a,c,e){"resource"===a&&this.data.sources&&(this.data.sources[b.name]=c,this.data.currentSource===b.name&&this.channel&&(this.channel.paused?(this.play(b.name),this.pause()):this.play(b.name)))},onAssetRemoved:function(b){b.off("remove",this.onAssetRemoved,this);this.data.sources[b.name]&&(delete this.data.sources[b.name],this.data.currentSource===b.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(b,a,c){a!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(b,
a,c){a!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(b,a,c){a!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(b,a,c){a!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(c)},onSetMinDistance:function(b,a,c){a!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(b,a,c){a!=c&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(c)},onSetDistanceModel:function(b,a,c){a!==c&&this.channel instanceof
pc.Channel3d&&this.channel.setDistanceModel(c)},onSet3d:function(b,a,c){a!==c&&this.system.initialized&&this.currentSource&&(a=b=!1,this.channel&&(b=this.channel.paused,a=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=b,this.channel.suspended=a))},onEnable:function(){var b=this.data.assets;if(b)for(var a=this.system.app.assets,c=0,e=b.length;c<e;c++){var f=b[c];f instanceof pc.Asset||(f=a.get(f));f&&!f.resource&&a.load(f)}this.system.initialized&&(this.data.activate&&
!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(b){var a=this,c=b.map(function(a){return this.system.app.assets.get(a)},this),e={},f=null,d=c.length,n=function(a){d--},k=function(){this.data.sources=e;this.data.currentSource=f;if(this.enabled&&this.activate&&f)this.onEnable()}.bind(this);c.forEach(function(c,g){c?(f=f||c.name,c.off("change",this.onAssetChanged,this),c.on("change",this.onAssetChanged,this),c.off("remove",
this.onAssetRemoved,this),c.on("remove",this.onAssetRemoved,this),c.off("error",n,this),c.on("error",n,this),c.ready(function(a){e[a.name]=a.resource;d--;0===d&&k()}),!c.resource&&a.enabled&&a.entity.enabled&&this.system.app.assets.load(c)):(d--,0===d&&k(),this.system.app.assets.on("add:"+b[g],function(b){b.ready(function(b){a.data.sources[b.name]=b.resource});b.resource||a.system.app.assets.load(b)}))},this)}});return{AudioSourceComponent:d}}());Object.assign(pc,function(){var d="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" "),b=function(a,b){pc.ComponentSystem.call(this,a);this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";this.ComponentType=pc.AudioSourceComponent;this.DataType=pc.AudioSourceComponentData;this.schema=d;this.manager=b;this.initialized=!1;pc.ComponentSystem.bind("initialize",
this.onInitialize,this);pc.ComponentSystem.bind("update",this.onUpdate,this);this.on("remove",this.onRemove,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.AudioSourceComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");pc.ComponentSystem.prototype.initializeComponentData.call(this,
a,b,e);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&a.enabled&&a.audiosource.enabled&&a.audiosource.activate&&a.audiosource.play(a.audiosource.currentSource);a=a._children;var b,e=a.length;for(b=0;b<e;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b]);this.initialized=!0},onUpdate:function(a){a=this.store;for(var b in a)if(a.hasOwnProperty(b)){var e=a[b],f=e.entity;e=e.data;e.enabled&&f.enabled&&e.channel instanceof pc.Channel3d&&(f=f.getPosition(),e.channel.setPosition(f))}},
onRemove:function(a,b){b.channel&&(b.channel.stop(),b.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:b}}());pc.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_INVERSE;this.paused=!0;this.sources={};this.channel=this.currentSource=null};Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var b=this.system.current.getPosition();this.system.manager.listener.setPosition(b)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=
null)}});return{AudioListenerComponent:d}}());Object.assign(pc,function(){var d=["enabled"],b=function(a,b){pc.ComponentSystem.call(this,a);this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";this.ComponentType=pc.AudioListenerComponent;this.DataType=pc.AudioListenerComponentData;this.schema=d;this.manager=b;this.current=null;pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.AudioListenerComponent.prototype,
d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){e=["enabled"];pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},onUpdate:function(a){this.current&&(a=this.current.getPosition(),this.manager.listener.setPosition(a),a=this.current.getWorldTransform(),this.manager.listener.setOrientation(a))}});return{AudioListenerComponentSystem:b}}());Object.assign(pc,function(){return{AudioListenerComponentData:function(){this.enabled=!0}}}());Object.assign(pc,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,
BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});Object.assign(pc,function(){var d,b,a,c,e,f=function(f,n){pc.Component.call(this,f,n);"undefined"===typeof Ammo||d||(d=new Ammo.btTransform,b=new Ammo.btVector3,a=new Ammo.btVector3,c=new Ammo.btQuaternion,e=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,
this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)};f.prototype=Object.create(pc.Component.prototype);f.prototype.constructor=f;Object.defineProperty(f.prototype,
"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(f.prototype,"linearVelocity",{get:function(){if(!this.isKinematic()&&this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z())}return this._linearVelocity},set:function(a){this.activate();!this.isKinematic()&&
this.body&&(b.setValue(a.x,a.y,a.z),this.body.setLinearVelocity(b));this._linearVelocity.copy(a)}});Object.defineProperty(f.prototype,"angularVelocity",{get:function(){if(!this.isKinematic()&&this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z())}return this._angularVelocity},set:function(a){this.activate();!this.isKinematic()&&this.body&&(b.setValue(a.x,a.y,a.z),this.body.setAngularVelocity(b));this._angularVelocity.copy(a)}});Object.assign(f.prototype,{createBody:function(){var a=
this.entity;if(a.collision){var e=a.collision.shape;a.trigger&&(a.trigger.destroy(),delete a.trigger)}if(e){if(this.body)this.system.onRemove(this.entity,this);var f=this.isStaticOrKinematic(),d=f?0:this.mass,m=new Ammo.btVector3(0,0,0);f||e.calculateLocalInertia(d,m);var l=a.getPosition();f=a.getRotation();c.setValue(f.x,f.y,f.z,f.w);f=new Ammo.btTransform;f.setIdentity();var p=f.getOrigin();p.setValue(l.x,l.y,l.z);f.setRotation(c);l=new Ammo.btDefaultMotionState(f);e=new Ammo.btRigidBodyConstructionInfo(d,
l,e,m);Ammo.destroy(m);Ammo.destroy(p);Ammo.destroy(f);m=new Ammo.btRigidBody(e);Ammo.destroy(e);m.setRestitution(this.restitution);m.setFriction(this.friction);m.setDamping(this.linearDamping,this.angularDamping);e=this.linearFactor;b.setValue(e.x,e.y,e.z);m.setLinearFactor(b);e=this.angularFactor;b.setValue(e.x,e.y,e.z);m.setAngularFactor(b);m.entity=a;this.isKinematic()&&(m.setCollisionFlags(m.getCollisionFlags()|pc.BODYFLAG_KINEMATIC_OBJECT),m.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));
a.rigidbody.body=m;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),
this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var a=this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){switch(arguments.length){case 1:var c=arguments[0].x;var f=arguments[0].y;var d=arguments[0].z;break;case 2:c=arguments[0].x;f=arguments[0].y;d=arguments[0].z;var h=arguments[1].x;var m=arguments[1].y;var l=arguments[1].z;break;
case 3:c=arguments[0];f=arguments[1];d=arguments[2];break;case 6:c=arguments[0],f=arguments[1],d=arguments[2],h=arguments[3],m=arguments[4],l=arguments[5]}var p=this.body;p&&(p.activate(),b.setValue(c,f,d),void 0!==h?(a.setValue(h,m,l),p.applyForce(b,a)):p.applyForce(b,e))},applyTorque:function(){switch(arguments.length){case 1:var a=arguments[0].x;var c=arguments[0].y;var e=arguments[0].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),
b.setValue(a,c,e),f.applyTorque(b))},applyImpulse:function(){switch(arguments.length){case 1:var c=arguments[0].x;var f=arguments[0].y;var d=arguments[0].z;break;case 2:c=arguments[0].x;f=arguments[0].y;d=arguments[0].z;var h=arguments[1].x;var m=arguments[1].y;var l=arguments[1].z;break;case 3:c=arguments[0];f=arguments[1];d=arguments[2];break;case 6:c=arguments[0];f=arguments[1];d=arguments[2];h=arguments[3];m=arguments[4];l=arguments[5];break;default:return}var p=this.body;p&&(p.activate(),b.setValue(c,
f,d),void 0!==h?(a.setValue(h,m,l),p.applyImpulse(b,a)):p.applyImpulse(b,e))},applyTorqueImpulse:function(){switch(arguments.length){case 1:var a=arguments[0].x;var c=arguments[0].y;var e=arguments[0].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),b.setValue(a,c,e),f.applyTorqueImpulse(b))},isStatic:function(){return this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},
isKinematic:function(){return this.type===pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),e=this.entity.getRotation(),f=a.getWorldTransform(),d=f.getOrigin();d.setValue(b.x,b.y,b.z);c.setValue(e.x,e.y,e.z,e.w);f.setRotation(c);this.isKinematic()&&(b=this.body.getMotionState())&&b.setWorldTransform(f);Ammo.destroy(d);Ammo.destroy(f);a.activate()}},syncBodyToEntity:function(){var a=this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(d);
a=d.getOrigin();var b=d.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));
this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){a=this.entity.getPosition();var b=this.entity.getRotation();d.getOrigin().setValue(a.x,a.y,a.z);c.setValue(b.x,b.y,b.z,b.w);d.setRotation(c);this.body.getMotionState().setWorldTransform(d)}},
onEnable:function(){this.body||this.createBody();this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var e=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,e);a.setMassProps(c,e);a.updateInertiaTensor();Ammo.destroy(e);b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,
b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(a,c,e){if(a=this.data.body)b.setValue(e.x,e.y,e.z),a.setLinearFactor(b)},onSetAngularFactor:function(a,c,e){if(a=this.data.body)b.setValue(e.x,e.y,e.z),a.setAngularFactor(b)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),c===pc.BODYTYPE_DYNAMIC?(this.data.group=
pc.BODYGROUP_DYNAMIC,this.data.mask=pc.BODYMASK_ALL):c===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(a,b,c){this.body&&this.data.simulationEnabled&&this.body.activate()}});return{RigidBodyComponent:f}}());Object.assign(pc,function(){var d,b,a={},c={},e=!1,f=function(a,b,c){this.entity=a;this.point=b;this.normal=c},g=function(a,b,c){0===arguments.length?(this.b=this.a=null,this.localPointA=new pc.Vec3,this.localPointB=new pc.Vec3,this.pointA=new pc.Vec3,this.pointB=new pc.Vec3,this.normal=new pc.Vec3):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)},n=function(a,b,c,e,f){0===arguments.length?(this.localPoint=
new pc.Vec3,this.localPointOther=new pc.Vec3,this.point=new pc.Vec3,this.pointOther=new pc.Vec3,this.normal=new pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=c,this.pointOther=e,this.normal=f)},k=function(a,b){this.other=a;this.contacts=b},h="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" "),m=function(a){pc.ComponentSystem.call(this,a);this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";
this._stats=a.stats.frame;this.ComponentType=pc.RigidBodyComponent;this.DataType=pc.RigidBodyComponentData;this.contactPointPool=new pc.AllocatePool(n,1);this.contactResultPool=new pc.AllocatePool(k,1);this.singleContactResultPool=new pc.AllocatePool(g,1);this.schema=h;this.maxSubSteps=10;this.fixedTimeStep=1/60;this.gravity=new pc.Vec3(0,-9.81,0);this.on("remove",this.onRemove,this)};m.prototype=Object.create(pc.ComponentSystem.prototype);m.prototype.constructor=m;pc.Component._buildAccessors(pc.RigidBodyComponent.prototype,
h);Object.assign(m.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);if(this.dynamicsWorld.setInternalTickCallback){var a=
Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(a)}d=new Ammo.btVector3;b=new Ammo.btVector3;pc.ComponentSystem.bind("update",this.onUpdate,this)}else pc.ComponentSystem.unbind("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");for(var e={},f=0,d=c.length;f<d;f++){var g=c[f];e[g]=b[g]}b.bodyType&&(e.type=
b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));e.linearFactor&&"array"===pc.type(e.linearFactor)&&(e.linearFactor=new pc.Vec3(e.linearFactor[0],e.linearFactor[1],e.linearFactor[2]));e.angularFactor&&"array"===pc.type(e.angularFactor)&&(e.angularFactor=new pc.Vec3(e.angularFactor[0],e.angularFactor[1],e.angularFactor[2]));pc.ComponentSystem.prototype.initializeComponentData.call(this,a,e,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,
mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){if(a=b.body){this.removeBody(a);var c=a.getMotionState();
c&&Ammo.destroy(c);Ammo.destroy(a);b.body=null}},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,b,c):this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},raycastFirst:function(a,c){var g=null;d.setValue(a.x,a.y,a.z);b.setValue(c.x,c.y,c.z);var k=new Ammo.ClosestRayResultCallback(d,
b);this.dynamicsWorld.rayTest(d,b,k);if(k.hasHit()){var h=k.get_m_collisionObject();if(h=Ammo.castObject(h,Ammo.btRigidBody)){g=k.get_m_hitPointWorld();var m=k.get_m_hitNormalWorld();g=new f(h.entity,new pc.Vec3(g.x(),g.y(),g.z()),new pc.Vec3(m.x(),m.y(),m.z()));2<arguments.length&&((0,arguments[2])(g),e||(console.warn("[DEPRECATED]: pc.RigidBodyComponentSystem#rayCastFirst no longer requires a callback. The result of the raycast is returned by the function instead."),e=!0))}}Ammo.destroy(k);return g},
raycastAll:function(a,c){var e=[];d.setValue(a.x,a.y,a.z);b.setValue(c.x,c.y,c.z);a=new Ammo.AllHitsRayResultCallback(d,b);this.dynamicsWorld.rayTest(d,b,a);if(a.hasHit()){c=a.get_m_collisionObjects();for(var g=a.get_m_hitPointWorld(),k=a.get_m_hitNormalWorld(),h=c.size(),m=0;m<h;m++){var n=Ammo.castObject(c.at(m),Ammo.btRigidBody);if(n){var l=g.at(m),p=k.at(m);n=new f(n.entity,new pc.Vec3(l.x(),l.y(),l.z()),new pc.Vec3(p.x(),p.y(),p.z()));e.push(n)}}}Ammo.destroy(a);return e},_storeCollision:function(b,
e){var f=!1,d=b.getGuid();a[d]=a[d]||{others:[],entity:b};0>a[d].others.indexOf(e)&&(a[d].others.push(e),f=!0);c[d]=c[d]||{others:[],entity:b};c[d].others.push(e);return f},_createContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),e=a.getPositionWorldOnA(),f=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var d=this.contactPointPool.allocate();d.localPoint.set(b.x(),b.y(),b.z());d.localPointOther.set(c.x(),c.y(),c.z());d.point.set(e.x(),e.y(),e.z());d.pointOther.set(f.x(),
f.y(),f.z());d.normal.set(a.x(),a.y(),a.z());return d},_createReverseContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),e=a.getPositionWorldOnA(),f=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var d=this.contactPointPool.allocate();d.localPointOther.set(b.x(),b.y(),b.z());d.localPoint.set(c.x(),c.y(),c.z());d.pointOther.set(e.x(),e.y(),e.z());d.point.set(f.x(),f.y(),f.z());d.normal.set(a.x(),a.y(),a.z());return d},_createSingleContactResult:function(a,b,c){var e=
this.singleContactResultPool.allocate();e.a=a;e.b=b;e.localPointA=c.localPoint;e.localPointB=c.localPointOther;e.pointA=c.point;e.pointB=c.pointOther;e.normal=c.normal;return e},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var b in a)if(a.hasOwnProperty(b)){var e=c[b],f=a[b],d=f.entity,g=d.collision,k=d.rigidbody;f=f.others;for(var h=f.length;h--;){var m=f[h];if(!e||0>e.others.indexOf(m))f.splice(h,1),
d.trigger?(g&&g.fire("triggerleave",m),m.rigidbody&&m.rigidbody.fire("triggerleave",d)):m.trigger||(k&&k.fire("collisionend",m),g&&g.fire("collisionend",m))}0===f.length&&delete a[b]}},_hasContactEvent:function(a){var b=a.collision;return b&&(b.hasEvent("collisionstart")||b.hasEvent("collisionend")||b.hasEvent("contact"))?!0:(a=a.rigidbody)&&(a.hasEvent("collisionstart")||a.hasEvent("collisionend")||a.hasEvent("contact"))},_checkForCollisions:function(a,b){a=this.dynamicsWorld.getDispatcher();b=a.getNumManifolds();
var e;c={};for(e=0;e<b;e++){var f=a.getManifoldByIndexInternal(e),d=f.getBody0(),g=f.getBody1(),k=Ammo.castObject(d,Ammo.btRigidBody),h=Ammo.castObject(g,Ammo.btRigidBody);g=k.entity;d=h.entity;if(g&&d){var m=k.getCollisionFlags();var n=h.getCollisionFlags(),l=f.getNumContacts(),p=[],C=[];if(0<l)if(m&pc.BODYFLAG_NORESPONSE_OBJECT||n&pc.BODYFLAG_NORESPONSE_OBJECT){h=g.collision&&(g.collision.hasEvent("triggerenter")||g.collision.hasEvent("triggerleave"));k=d.collision&&(d.collision.hasEvent("triggerenter")||
d.collision.hasEvent("triggerleave"));f=g.rigidbody&&(g.rigidbody.hasEvent("triggerenter")||g.rigidbody.hasEvent("triggerleave"));C=d.rigidbody&&(d.rigidbody.hasEvent("triggerenter")||d.rigidbody.hasEvent("triggerleave"));if(h){var D=this._storeCollision(g,d);!D||n&pc.BODYFLAG_NORESPONSE_OBJECT||g.collision.fire("triggerenter",d)}k&&(D=this._storeCollision(d,g),!D||m&pc.BODYFLAG_NORESPONSE_OBJECT||d.collision.fire("triggerenter",g));f&&(D||(D=this._storeCollision(d,g)),D&&g.rigidbody.fire("triggerenter",
d));C&&(D||(D=this._storeCollision(g,d)),D&&d.rigidbody.fire("triggerenter",g))}else if(h=this._hasContactEvent(g),k=this._hasContactEvent(d),(n=this.hasEvent("contact"))||h||k){for(m=0;m<l;m++){var F=f.getContactPoint(m),I=this._createContactPointFromAmmo(F);if(h||k)F=this._createReverseContactPointFromAmmo(F),p.push(I),C.push(F);n&&(I=this._createSingleContactResult(g,d,I),this.fire("contact",I))}h&&(f=this._createContactResult(d,p),D=this._storeCollision(g,d),g.collision&&(g.collision.fire("contact",
f),D&&g.collision.fire("collisionstart",f)),g.rigidbody&&(g.rigidbody.fire("contact",f),D&&g.rigidbody.fire("collisionstart",f)));k&&(f=this._createContactResult(g,C),D=this._storeCollision(d,g),d.collision&&(d.collision.fire("contact",f),D&&d.collision.fire("collisionstart",f)),d.rigidbody&&(d.rigidbody.fire("contact",f),D&&d.rigidbody.fire("collisionstart",f)))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()},onUpdate:function(a){var b=
this.dynamicsWorld.getGravity();if(b.x()!==this.gravity.x||b.y()!==this.gravity.y||b.z()!==this.gravity.z)b.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(b);this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);b=this.store;for(var c in b)if(b.hasOwnProperty(c)){var e=b[c].entity,f=b[c].data;f.body&&f.body.isActive()&&f.enabled&&e.enabled&&(f.type===pc.BODYTYPE_DYNAMIC?e.rigidbody.syncBodyToEntity():f.type===pc.BODYTYPE_KINEMATIC&&e.rigidbody._updateKinematic(a))}this.dynamicsWorld.setInternalTickCallback||
this._checkForCollisions(this.dynamicsWorld,a)},destroy:function(){"undefined"!==typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=this.solver=this.dynamicsWorld=null)}});return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,
RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:m}}());Object.assign(pc,function(){return{RigidBodyComponentData:function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1}}}());Object.assign(pc,function(){var d,b,a=function(a,e,f){this.entity=e.entity;this.component=e;this.app=a;"undefined"===typeof Ammo||d||(d=new Ammo.btVector3,b=new Ammo.btQuaternion);this.initialize(f)};Object.assign(a.prototype,{initialize:function(a){var c=this.entity,f=a.shape;if(f&&"undefined"!==typeof Ammo){c.trigger&&c.trigger.destroy();a=new Ammo.btVector3(0,0,0);f.calculateLocalInertia(1,a);var g=c.getPosition(),n=c.getRotation();b.setValue(n.x,n.y,n.z,n.w);n=new Ammo.btTransform;n.setIdentity();
var k=n.getOrigin();k.setValue(g.x,g.y,g.z);n.setRotation(b);g=new Ammo.btDefaultMotionState(n);f=new Ammo.btRigidBodyConstructionInfo(1,g,f,a);Ammo.destroy(a);Ammo.destroy(k);Ammo.destroy(n);this.body=a=new Ammo.btRigidBody(f);Ammo.destroy(f);a.setRestitution(0);a.setFriction(0);a.setDamping(0,0);d.setValue(0,0,0);a.setLinearFactor(d);a.setAngularFactor(d);a.setCollisionFlags(a.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);a.entity=c;this.component.enabled&&c.enabled&&this.enable()}},destroy:function(){this.body&&
(this.app.systems.rigidbody.removeBody(this.body),Ammo.destroy(this.body))},syncEntityToBody:function(){var a=this.body;if(a){var e=this.entity.getPosition(),f=this.entity.getRotation(),d=a.getWorldTransform(),n=d.getOrigin();n.setValue(e.x,e.y,e.z);b.setValue(f.x,f.y,f.z,f.w);d.setRotation(b);a.activate();Ammo.destroy(n);Ammo.destroy(d)}},enable:function(){var a=this.body;a&&(this.app.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER),a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG),
a.activate(),this.syncEntityToBody())},disable:function(){var a=this.body;a&&(this.app.systems.rigidbody.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION))}});return{Trigger:a}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this._compoundParent=null;this.entity.on("insert",this._onInsert,this);this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);this.on("set_model",this.onSetModel,this)};d.prototype=Object.create(pc.Component.prototype);
d.prototype.constructor=d;Object.assign(d.prototype,{onSetType:function(b,a,c){a!==c&&this.system.changeType(this,a,c)},onSetHalfExtents:function(b,a,c){b=this.data.type;this.data.initialized&&"box"===b&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(b,a,c){b=this.data.type;!this.data.initialized||"sphere"!==b&&"capsule"!==b&&"cylinder"!==b&&"cone"!==b||this.system.recreatePhysicalShapes(this)},onSetHeight:function(b,a,c){b=this.data.type;!this.data.initialized||"capsule"!==b&&"cylinder"!==
b&&"cone"!==b||this.system.recreatePhysicalShapes(this)},onSetAxis:function(b,a,c){b=this.data.type;!this.data.initialized||"capsule"!==b&&"cylinder"!==b&&"cone"!==b||this.system.recreatePhysicalShapes(this)},onSetAsset:function(b,a,c){b=this.system.app.assets;a&&(a=b.get(a))&&a.off("remove",this.onAssetRemoved,this);c&&(c instanceof pc.Asset&&(this.data.asset=c.id),a=b.get(this.data.asset))&&(a.off("remove",this.onAssetRemoved,this),a.on("remove",this.onAssetRemoved,this));this.data.initialized&&
"mesh"===this.data.type&&(c||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(b,a,c){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(b){b.off("remove",this.onAssetRemoved,this);this.data.asset===b.id&&(this.asset=null)},_getCompoundChildShapeIndex:function(b){for(var a=this.data.shape,c=a.getNumChildShapes(),e=0;e<c;e++)if(a.getChildShape(e).ptr===b.ptr)return e;return null},
_onInsert:function(b){if("undefined"!==typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(b=this.entity.parent;b;){if(b.collision&&"compound"===b.collision.type){0===b.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(b.collision):this.system.recreatePhysicalShapes(this);break}b=b.parent}},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var b=this.system.app.assets.get(this.data.asset);
if(b&&(!b.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.rigidbody?this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(b=this.system._getNodeTransform(this.entity,this._compoundParent.entity),this._compoundParent.shape.addChildShape(b,this.data.shape),Ammo.destroy(b),this._compoundParent.entity.rigidbody&&
this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.enable()},onDisable:function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},onBeforeRemove:function(){this.entity.off("insert",
this._onInsert,this)}});return{CollisionComponent:d}}());Object.assign(pc,function(){var d=new pc.Mat4,b=new pc.Vec3,a=new pc.Quat,c="enabled type halfExtents radius axis height asset shape model".split(" "),e=function(a){this.system=a};Object.assign(e.prototype,{beforeInitialize:function(a,b){b.shape=null;b.model=new pc.Model;b.model.graph=new pc.GraphNode},afterInitialize:function(a,b){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=
a.entity,c=a.data;if("undefined"!==typeof Ammo){b.trigger&&(b.trigger.destroy(),delete b.trigger);c.shape&&(a._compoundParent&&(this.system._removeCompoundChild(a._compoundParent,c.shape),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()),Ammo.destroy(c.shape),c.shape=null);c.shape=this.createPhysicalShape(a.entity,c);var e=!a._compoundParent;if("compound"===c.type&&(!a._compoundParent||a===a._compoundParent))a._compoundParent=a,b.forEach(this._addEachDescendant,a);
else if("compound"!==c.type&&(a._compoundParent&&a===a._compoundParent&&b.forEach(this.system.implementations.compound._updateEachDescendant,a),!a.rigidbody)){a._compoundParent=null;for(var f=b.parent;f;){if(f.collision&&"compound"===f.collision.type){a._compoundParent=f.collision;break}f=f.parent}}a._compoundParent&&a!==a._compoundParent&&(e&&0===a._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a._compoundParent):(this.system.updateCompoundChildTransform(b),a._compoundParent.entity.rigidbody&&
a._compoundParent.entity.rigidbody.activate()));b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&b.rigidbody.enabled&&b.rigidbody.enableSimulation()):a._compoundParent||(b.trigger?b.trigger.initialize(c):b.trigger=new pc.Trigger(this.system.app,a,c))}},createPhysicalShape:function(a,b){},updateTransform:function(a,b,c,e){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},beforeRemove:function(a,b){b.data.shape&&(b._compoundParent&&!b._compoundParent.entity._destroying&&
(this.system._removeCompoundChild(b._compoundParent,b.data.shape),b._compoundParent.entity.rigidbody&&b._compoundParent.entity.rigidbody.activate()),b._compoundParent=null,Ammo.destroy(b.data.shape),b.data.shape=null)},remove:function(a,b){var c=this.system.app;a.rigidbody&&a.rigidbody.body&&(c.systems.rigidbody.removeBody(a.rigidbody.body),a.rigidbody.disableSimulation());a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},
clone:function(a,b){a=this.system.store[a.getGuid()];return this.system.addComponent(b,{enabled:a.data.enabled,type:a.data.type,halfExtents:[a.data.halfExtents.x,a.data.halfExtents.y,a.data.halfExtents.z],radius:a.data.radius,axis:a.data.axis,height:a.data.height,asset:a.data.asset,model:a.data.model})}});var f=function(a){this.system=a};f.prototype=Object.create(e.prototype);f.prototype.constructor=f;Object.assign(f.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return a=
b.halfExtents,a=new Ammo.btVector3(a?a.x:.5,a?a.y:.5,a?a.z:.5),b=new Ammo.btBoxShape(a),Ammo.destroy(a),b}});var g=function(a){this.system=a};g.prototype=Object.create(e.prototype);g.prototype.constructor=g;Object.assign(g.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)}});var n=function(a){this.system=a};n.prototype=Object.create(e.prototype);n.prototype.constructor=n;Object.assign(n.prototype,{createPhysicalShape:function(a,b){a=
null;var c=void 0!==b.axis?b.axis:1,e=b.radius||.5;b=Math.max((b.height||2)-2*e,0);if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btCapsuleShapeX(e,b);break;case 1:a=new Ammo.btCapsuleShape(e,b);break;case 2:a=new Ammo.btCapsuleShapeZ(e,b)}return a}});var k=function(a){this.system=a};k.prototype=Object.create(e.prototype);k.prototype.constructor=k;Object.assign(k.prototype,{createPhysicalShape:function(a,b){var c=a=null,e=void 0!==b.axis?b.axis:1,f=void 0!==b.radius?b.radius:.5;b=void 0!==
b.height?b.height:1;if("undefined"!==typeof Ammo)switch(e){case 0:a=new Ammo.btVector3(.5*b,f,f);c=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(f,.5*b,f);c=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(f,f,.5*b),c=new Ammo.btCylinderShapeZ(a)}a&&Ammo.destroy(a);return c}});var h=function(a){this.system=a};h.prototype=Object.create(e.prototype);h.prototype.constructor=h;Object.assign(h.prototype,{createPhysicalShape:function(a,b){a=null;var c=void 0!==b.axis?b.axis:
1,e=void 0!==b.radius?b.radius:.5;b=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btConeShapeX(e,b);break;case 1:a=new Ammo.btConeShape(e,b);break;case 2:a=new Ammo.btConeShapeZ(e,b)}return a}});var m=function(a){this.system=a};m.prototype=Object.create(e.prototype);m.prototype.constructor=m;Object.assign(m.prototype,{beforeInitialize:function(a,b){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model;b=new Ammo.btCompoundShape;
var e,f;for(e=0;e<c.meshInstances.length;e++){var d=c.meshInstances[e],g=d.mesh;if(this.system._triMeshCache[g.id])var k=this.system._triMeshCache[g.id];else{k=g.indexBuffer[pc.RENDERSTYLE_SOLID];var h=g.vertexBuffer,m=h.getFormat(),n=m.size/4,l;for(f=0;f<m.elements.length;f++){var q=m.elements[f];q.name===pc.SEMANTIC_POSITION&&(l=new Float32Array(h.lock(),q.offset))}h=new Uint16Array(k.lock());m=g.primitive[0].count/3;q=new Ammo.btVector3;var p=new Ammo.btVector3,r=new Ammo.btVector3,B=g.primitive[0].base;
k=new Ammo.btTriangleMesh;this.system._triMeshCache[g.id]=k;for(f=0;f<m;f++){g=h[B+3*f]*n;var w=h[B+3*f+1]*n;var H=h[B+3*f+2]*n;q.setValue(l[g],l[g+1],l[g+2]);p.setValue(l[w],l[w+1],l[w+2]);r.setValue(l[H],l[H+1],l[H+2]);k.addTriangle(q,p,r,!0)}Ammo.destroy(q);Ammo.destroy(p);Ammo.destroy(r)}f=new Ammo.btBvhTriangleMeshShape(k,!0);n=this.system._getNodeScaling(d.node);f.setLocalScaling(n);Ammo.destroy(n);d=this.system._getNodeTransform(d.node);b.addChildShape(d,f);Ammo.destroy(d)}a=a.getWorldTransform().getScale();
l=new Ammo.btVector3;l.setValue(a.x,a.y,a.z);b.setLocalScaling(l);Ammo.destroy(l);return b}},recreatePhysicalShapes:function(a){null!==a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)},loadModelAsset:function(a){var b=this,c=a.data.asset,e=a.data,f=this.system.app.assets,d=f.get(c);if(d)d.ready(function(c){e.model=c.resource;b.doRecreatePhysicalShape(a)}),f.load(d);else f.once("add:"+c,function(c){c.ready(function(c){e.model=c.resource;b.doRecreatePhysicalShape(a)});
f.load(c)})},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(this.destroyShape(c),c.shape=this.createPhysicalShape(b,c),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&b.rigidbody.enabled&&b.rigidbody.enableSimulation()):b.trigger?b.trigger.initialize(c):b.trigger=new pc.Trigger(this.system.app,a,c)):(this.beforeRemove(b,a),this.remove(b,c))},updateTransform:function(a,b,c,e){if(a.shape){var f=a.entity.getWorldTransform().getScale(),d=a.shape.getLocalScaling();
f.x===d.x()&&f.y===d.y()&&f.z===d.z()||this.doRecreatePhysicalShape(a)}pc.CollisionSystemImpl.prototype.updateTransform.call(this,a,b,c,e)},destroyShape:function(a){if(a.shape){for(var b=a.shape.getNumChildShapes(),c=0;c<b;c++){var e=a.shape.getChildShape(c);Ammo.destroy(e)}Ammo.destroy(a.shape);a.shape=null}},remove:function(a,b){this.destroyShape(b);e.prototype.remove.call(this,a,b)}});var l=function(a){this.system=a};l.prototype=Object.create(e.prototype);l.prototype.constructor=l;Object.assign(l.prototype,
{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btCompoundShape},_addEachDescendant:function(a){a.collision&&!a.rigidbody&&(a.collision._compoundParent=this,a!==this.entity&&a.collision.system.recreatePhysicalShapes(a.collision))},_updateEachDescendant:function(a){a.collision&&a.collision._compoundParent===this&&(a.collision._compoundParent=null,a===this.entity||a.rigidbody||a.collision.system.recreatePhysicalShapes(a.collision))},_updateEachDescendantTransform:function(a){a.collision&&
a.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(a)}});var p=function(a){pc.ComponentSystem.call(this,a);this.id="collision";this.description="Specifies a collision volume.";this.ComponentType=pc.CollisionComponent;this.DataType=pc.CollisionComponentData;this.schema=c;this.implementations={};this._triMeshCache={};this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);pc.ComponentSystem.bind("update",this.onUpdate,
this)};p.prototype=Object.create(pc.ComponentSystem.prototype);p.prototype.constructor=p;pc.Component._buildAccessors(pc.CollisionComponent.prototype,c);Object.assign(p.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.ComponentSystem.unbind("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){c="type halfExtents radius axis height shape model asset enabled".split(" ");for(var e={},f=0,d=c.length;f<d;f++){var g=c[f];e[g]=b[g]}b.hasOwnProperty("asset")?(b=c.indexOf("model"),
-1!==b&&c.splice(b,1)):b.hasOwnProperty("model")&&(b=c.indexOf("asset"),-1!==b&&c.splice(b,1));e.type||(e.type=a.data.type);a.data.type=e.type;e.halfExtents&&"array"===pc.type(e.halfExtents)&&(e.halfExtents=new pc.Vec3(e.halfExtents[0],e.halfExtents[1],e.halfExtents[2]));b=this._createImplementation(e.type);b.beforeInitialize(a,e);pc.ComponentSystem.prototype.initializeComponentData.call(this.system,a,e,c);b.afterInitialize(a,e)},_createImplementation:function(a){if(void 0===this.implementations[a]){switch(a){case "box":var b=
new f(this);break;case "sphere":b=new g(this);break;case "capsule":b=new n(this);break;case "cylinder":b=new k(this);break;case "cone":b=new h(this);break;case "mesh":b=new m(this);break;case "compound":b=new l(this)}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,b)},onBeforeRemove:function(a,b){this.implementations[b.data.type].beforeRemove(a,
b);b.onBeforeRemove()},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(a){var b,c=this.store;for(b in c){a=c[b].entity;var e=c[b].data;if(e.enabled&&a.enabled&&!a.rigidbody)if(a.collision._compoundParent&&a._dirtyWorld){e=a._dirtyLocal;for(var f=a;f&&!e&&(!f.collision||f.collision!=a.collision._compoundParent);)f._dirtyLocal&&(e=!0),f=f.parent;e&&(a.forEach(this.implementations.compound._updateEachDescendantTransform,a),a.collision._compoundParent.entity.rigidbody&&
a.collision._compoundParent.entity.rigidbody.activate())}else a.trigger&&a.trigger.syncEntityToBody()}},updateCompoundChildTransform:function(a){this._removeCompoundChild(a.collision._compoundParent,a.collision.data.shape);if(a.enabled&&a.collision.enabled){var b=this._getNodeTransform(a,a.collision._compoundParent.entity);a.collision._compoundParent.shape.addChildShape(b,a.collision.data.shape);Ammo.destroy(b)}},_removeCompoundChild:function(a,b){a.shape.removeChildShape?a.shape.removeChildShape(b):
(b=a._getCompoundChildShapeIndex(b),null!==b&&a.shape.removeChildShapeByIndex(b))},onTransformChanged:function(a,b,c,e){this.implementations[a.data.type].updateTransform(a,b,c,e)},changeType:function(a,b,c){this.implementations[b].beforeRemove(a.entity,a);this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)},_calculateNodeRelativeTransform:function(a,b){a===b?(a=
a.getWorldTransform().getScale(),d.setScale(a.x,a.y,a.z)):(this._calculateNodeRelativeTransform(a.parent,b),d.mul(a.getLocalTransform()))},_getNodeScaling:function(a){a=a.getWorldTransform().getScale();return new Ammo.btVector3(a.x,a.y,a.z)},_getNodeTransform:function(c,e){e?(this._calculateNodeRelativeTransform(c,e),e=b,c=a,d.getTranslation(e),c.setFromMat4(d)):(e=c.getPosition(),c=c.getRotation());var f=new Ammo.btTransform;f.setIdentity();var g=f.getOrigin();g.setValue(e.x,e.y,e.z);e=new Ammo.btQuaternion;
e.setValue(c.x,c.y,c.z,c.w);f.setRotation(e);Ammo.destroy(e);Ammo.destroy(g);return f},destroy:function(){for(var a in this._triMeshCache)Ammo.destroy(this._triMeshCache[a]);this._triMeshCache=null;pc.ComponentSystem.prototype.destroy.call(this)}});return{CollisionComponentSystem:p}}());Object.assign(pc,function(){return{CollisionComponentData:function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1}}}());Object.assign(pc,function(){var d="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),b="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace orientation".split(" "),a="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),
c=["colorMapAsset","normalMapAsset","meshAsset"],e,f=function(c,e){pc.Component.call(this,c,e);this.on("set_colorMapAsset",this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_meshAsset",this.onSetMeshAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);this.on("set_depthSoftening",this.onSetDepthSoftening,this);this.on("set_layers",this.onSetLayers,this);d.forEach(function(a){this.on("set_"+
a,this.onSetSimpleProperty,this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this));this._requestedDepth=!1};f.prototype=Object.create(pc.Component.prototype);f.prototype.constructor=f;Object.assign(f.prototype,{addModelToLayers:function(){if(this.data.model)for(var a,b=0;b<this.layers.length;b++)if(a=this.system.app.scene.layers.getLayerById(this.layers[b]))a.addMeshInstances(this.data.model.meshInstances),
this.emitter._layer=a},removeModelFromLayers:function(a){if(this.data.model)for(var b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(a,b,c){if(this.data.model){var e;for(a=0;a<b.length;a++)(e=this.system.app.scene.layers.getLayerById(b[a]))&&e.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(e=this.system.app.scene.layers.getLayerById(c[a]))&&
e.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(a,b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.data.model.meshInstances))},
_bindColorMapAsset:function(a){a.on("load",this._onColorMapAssetLoad,this);a.on("unload",this._onColorMapAssetUnload,this);a.on("remove",this._onColorMapAssetRemove,this);a.on("change",this._onColorMapAssetChange,this);a.resource?this._onColorMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindColorMapAsset:function(a){a.off("load",this._onColorMapAssetLoad,this);a.off("unload",this._onColorMapAssetUnload,this);a.off("remove",this._onColorMapAssetRemove,this);
a.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(a){this.colorMap=a.resource},_onColorMapAssetUnload:function(a){this.colorMap=null},_onColorMapAssetRemove:function(a){this._onColorMapAssetUnload(a)},_onColorMapAssetChange:function(a){},onSetColorMapAsset:function(a,b,c){var e=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindColorMapAsset(b);if(c)if(c instanceof pc.Asset&&(c=this.data.colorMapAsset=c.id),b=a.get(c))e._bindColorMapAsset(b);else a.once("add:"+
c,function(a){e._bindColorMapAsset(a)});else this.colorMap=null},_bindNormalMapAsset:function(a){a.on("load",this._onNormalMapAssetLoad,this);a.on("unload",this._onNormalMapAssetUnload,this);a.on("remove",this._onNormalMapAssetRemove,this);a.on("change",this._onNormalMapAssetChange,this);a.resource?this._onNormalMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindNormalMapAsset:function(a){a.off("load",this._onNormalMapAssetLoad,this);a.off("unload",this._onNormalMapAssetUnload,
this);a.off("remove",this._onNormalMapAssetRemove,this);a.off("change",this._onNormalMapAssetChange,this)},_onNormalMapAssetLoad:function(a){this.normalMap=a.resource},_onNormalMapAssetUnload:function(a){this.normalMap=null},_onNormalMapAssetRemove:function(a){this._onNormalMapAssetUnload(a)},_onNormalMapAssetChange:function(a){},onSetNormalMapAsset:function(a,b,c){var e=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindNormalMapAsset(b);if(c)if(c instanceof pc.Asset&&(c=this.data.normalMapAsset=
c.id),b=a.get(c))e._bindNormalMapAsset(b);else a.once("add:"+c,function(a){e._bindNormalMapAsset(a)});else this.normalMap=null},_bindMeshAsset:function(a){a.on("load",this._onMeshAssetLoad,this);a.on("unload",this._onMeshAssetUnload,this);a.on("remove",this._onMeshAssetRemove,this);a.on("change",this._onMeshAssetChange,this);a.resource?this._onMeshAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindMeshAsset:function(a){a.off("load",this._onMeshAssetLoad,this);a.off("unload",
this._onMeshAssetUnload,this);a.off("remove",this._onMeshAssetRemove,this);a.off("change",this._onMeshAssetChange,this)},_onMeshAssetLoad:function(a){this._onMeshChanged(a.resource)},_onMeshAssetUnload:function(a){this.mesh=null},_onMeshAssetRemove:function(a){this._onMeshAssetUnload(a)},_onMeshAssetChange:function(a){},onSetMeshAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindMeshAsset(b);if(c){if(c instanceof pc.Asset&&(c=this.data.meshAsset=c.id),b=a.get(c))this._bindMeshAsset(b),
b.resource?this._onMeshChanged(b.resource):a.load(b)}else this._onMeshChanged(null)},onSetMesh:function(a,b,c){!c||c instanceof pc.Asset||"number"===typeof c?this.meshAsset=c:this._onMeshChanged(c)},_onMeshChanged:function(a){!a||a instanceof pc.Mesh||(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,
b,c){this.emitter&&(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(e||(e=this.system.app.scene.layers.getLayerById(pc.LAYERID_DEPTH)),e&&(e.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&e&&(e.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(a,b,c){b!==c&&(c?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&
this._releaseDepth(),this.emitter&&(this.emitter[a]=c),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial(),this.rebuild(),this.reset())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var a=
this.data,b=0,e=c.length;b<e;b++){var f=a[c[b]];if(f){if(!(f instanceof pc.Asset))if(0<=parseInt(f,10))f=this.system.app.assets.get(f);else continue;f&&!f.resource&&this.system.app.assets.load(f)}}this.emitter||(b=a.mesh,b instanceof pc.Mesh||(b=null),this.emitter=new pc.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:a.numParticles,emitterExtents:a.emitterExtents,emitterExtentsInner:a.emitterExtentsInner,emitterRadius:a.emitterRadius,emitterRadiusInner:a.emitterRadiusInner,emitterShape:a.emitterShape,
initialVelocity:a.initialVelocity,wrap:a.wrap,localSpace:a.localSpace,wrapBounds:a.wrapBounds,lifetime:a.lifetime,rate:a.rate,rate2:a.rate2,orientation:a.orientation,particleNormal:a.particleNormal,animTilesX:a.animTilesX,animTilesY:a.animTilesY,animStartFrame:a.animStartFrame,animNumFrames:a.animNumFrames,animNumAnimations:a.animNumAnimations,animIndex:a.animIndex,randomizeAnimIndex:a.randomizeAnimIndex,animSpeed:a.animSpeed,animLoop:a.animLoop,startAngle:a.startAngle,startAngle2:a.startAngle2,scaleGraph:a.scaleGraph,
scaleGraph2:a.scaleGraph2,colorGraph:a.colorGraph,colorGraph2:a.colorGraph2,alphaGraph:a.alphaGraph,alphaGraph2:a.alphaGraph2,localVelocityGraph:a.localVelocityGraph,localVelocityGraph2:a.localVelocityGraph2,velocityGraph:a.velocityGraph,velocityGraph2:a.velocityGraph2,rotationSpeedGraph:a.rotationSpeedGraph,rotationSpeedGraph2:a.rotationSpeedGraph2,radialSpeedGraph:a.radialSpeedGraph,radialSpeedGraph2:a.radialSpeedGraph2,colorMap:a.colorMap,normalMap:a.normalMap,loop:a.loop,preWarm:a.preWarm,sort:a.sort,
stretch:a.stretch,alignToMotion:a.alignToMotion,lighting:a.lighting,halfLambert:a.halfLambert,intensity:a.intensity,depthSoftening:a.depthSoftening,scene:this.system.app.scene,mesh:b,depthWrite:a.depthWrite,noFog:a.noFog,node:this.entity,blendType:a.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new pc.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],a.model=this.psys,this.emitter.psys=this.psys,a.autoPlay||(this.pause(),
this.emitter.meshInstance.visible=!1));a.model&&this.emitter.colorMap&&this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&a.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&
(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth());this.emitter&&(this.emitter.camera=null)},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=
!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a},onRemove:function(){var a=
this.data;a.model&&(this.entity.removeChild(a.model.getGraph()),a.model.destroy(),a.model=null);this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var b=0;b<c.length;b++){var e=c[b];a[e]&&(this[e]=null)}this.off()}});return{ParticleSystemComponent:f}}());Object.assign(pc,function(){var d="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" "),
b=function(a){pc.ComponentSystem.call(this,a);this.id="particlesystem";this.description="Updates and renders particle system in the scene.";this.ComponentType=pc.ParticleSystemComponent;this.DataType=pc.ParticleSystemComponentData;this.schema=d;this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",
alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};this.on("beforeremove",this.onRemove,this);pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ParticleSystemComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){var c=
{};e=[];var d=this.propertyTypes;if(b.mesh instanceof pc.Asset||"number"===typeof b.mesh)b.meshAsset=b.mesh,delete b.mesh;for(var n in b){b.hasOwnProperty(n)&&(e.push(n),c[n]=b[n]);if("vec3"===d[n])"array"===pc.type(c[n])&&(c[n]=new pc.Vec3(c[n][0],c[n][1],c[n][2]));else if("curve"===d[n]){if(!(c[n]instanceof pc.Curve)){var k=c[n].type;c[n]=new pc.Curve(c[n].keys);c[n].type=k}}else"curveset"!==d[n]||c[n]instanceof pc.CurveSet||(k=c[n].type,c[n]=new pc.CurveSet(c[n].keys),c[n].type=k);c.layers&&"array"===
pc.type(c.layers)&&(c.layers=c.layers.slice(0))}pc.ComponentSystem.prototype.initializeComponentData.call(this,a,c,e)},cloneComponent:function(a,b){a=a.particlesystem.data;for(var c=this.schema,f={},d=0,n=c.length;d<n;d++){var k=c[d],h=a[k];h instanceof pc.Vec3||h instanceof pc.Curve||h instanceof pc.CurveSet?(h=h.clone(),f[k]=h):"layers"===k?f.layers=a.layers.slice(0):null!==h&&void 0!==h&&(f[k]=h)}return this.addComponent(b,f)},onUpdate:function(a){var b=this.store,e,f=this.app.stats.particles,
d;for(d in b)if(b.hasOwnProperty(d)){var n=b[d];var k=n.entity;var h=n.data;if(h.enabled&&k.enabled){var m=h.model.emitter;if(m.meshInstance.visible){if(m.lighting){var l=h.layers;for(k=0;k<l.length;k++)if(n=this.app.scene.layers.getLayerById(l[k])){n._lightCube||(n._lightCube=new Float32Array(18));var p=n._lightCube;for(k=0;6>k;k++)p[3*k]=this.app.scene.ambientLight.r,p[3*k+1]=this.app.scene.ambientLight.g,p[3*k+2]=this.app.scene.ambientLight.b;var q=n._sortedLights[pc.LIGHTTYPE_DIRECTIONAL];for(e=
0;e<q.length;e++)for(n=0;6>n;n++){var r=Math.max(m.lightCubeDir[n].dot(q[e]._direction),0)*q[e]._intensity;p[3*n]+=q[e]._color.r*r;p[3*n+1]+=q[e]._color.g*r;p[3*n+2]+=q[e]._color.b*r}}m.constantLightCube.setValue(p)}if(!h.paused){m.simTime+=a;if(m.simTime>m.fixedTimeStep){var t=Math.floor(m.simTime/m.fixedTimeStep);m.simTime-=t*m.fixedTimeStep}if(t){t=Math.min(t,m.maxSubSteps);for(k=0;k<t;k++)m.addTime(m.fixedTimeStep,!1);f._updatesPerFrame+=t;f._frameTime+=m._addTimeTime;m._addTimeTime=0}m.finishFrame()}}}}},
onRemove:function(a,b){b.onRemove()}});return{ParticleSystemComponentSystem:b}}());Object.assign(pc,function(){return{ParticleSystemComponentData:function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new pc.Vec3;this.emitterExtentsInner=new pc.Vec3;this.emitterRadiusInner=this.emitterRadius=0;this.emitterShape=pc.EMITTERSHAPE_BOX;this.initialVelocity=0;this.wrapBounds=new pc.Vec3;this.localSpace=!1;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;
this.sort=0;this.mode=pc.PARTICLEMODE_GPU;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=this.meshAsset=null;this.noFog=this.depthWrite=!1;this.orientation=pc.PARTICLEORIENTATION_SCREEN;this.particleNormal=new pc.Vec3(0,1,0);this.animTilesY=this.animTilesX=1;this.animStartFrame=0;this.animNumAnimations=this.animNumFrames=1;this.animIndex=0;this.randomizeAnimIndex=!1;this.animSpeed=1;this.animLoop=!0;this.radialSpeedGraph2=
this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=!1;this.autoPlay=!0;this.layers=[pc.LAYERID_WORLD]}}}());Object.assign(pc,function(){var d=function(b,a){pc.EventHandler.call(this);this._component=b;this._frame=0;this._spriteAsset=this._sprite=null;this.spriteAsset=a.spriteAsset;this.name=a.name;this.fps=a.fps||0;this.loop=a.loop||!1;this._paused=this._playing=!1;this._time=0};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{_onSpriteAssetAdded:function(b){this._component.system.app.assets.off("add:"+b.id,this._onSpriteAssetAdded,this);this._spriteAsset===
b.id&&this._bindSpriteAsset(b)},_bindSpriteAsset:function(b){b.on("load",this._onSpriteAssetLoad,this);b.on("remove",this._onSpriteAssetRemove,this);b.resource?this._onSpriteAssetLoad(b):this._component.system.app.assets.load(b)},_unbindSpriteAsset:function(b){b.off("load",this._onSpriteAssetLoad,this);b.off("remove",this._onSpriteAssetRemove,this);b.resource&&b.resource.atlas&&this._component.system.app.assets.off("load:"+b.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(b){if(b.resource)if(b.resource.atlas)this.sprite=
b.resource;else{b=b.data.textureAtlasAsset;var a=this._component.system.app.assets;a.off("load:"+b,this._onTextureAtlasLoad,this);a.once("load:"+b,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(b){b=this._spriteAsset;b instanceof pc.Asset?this._onSpriteAssetLoad(b):this._onSpriteAssetLoad(this._component.system.app.assets.get(b))},_onSpriteAssetRemove:function(b){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},
_onSpritePpuChanged:function(){this._component.currentClip===this&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SIMPLE&&this._component._showFrame(this.frame)},_update:function(b){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var a=this._time+b*this._component.speed*(0>this.fps?-1:1),c=this.duration;b=a>c||0>a;this._setTime(a);a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/c):0;a!==this._frame&&this._setFrame(a);b&&(this.loop?(this.fire("loop"),this._component.fire("loop",
this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(b){this._time=b;b=this.duration;0>this._time?this._time=this.loop?this._time%b+b:0:this._time>b&&(this._time=this.loop?this._time%b:b)},_setFrame:function(b){this._frame=this._sprite?pc.math.clamp(b,0,this._sprite.frameKeys.length-1):b;this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null);this._spriteAsset&&(this.spriteAsset=
null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}});
Object.defineProperty(d.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(b){var a=this._component.system.app.assets,c=b;b instanceof pc.Asset&&(c=b.id);this._spriteAsset!==c&&(this._spriteAsset&&(b=a.get(this._spriteAsset))&&this._unbindSpriteAsset(b),(this._spriteAsset=c)?(c=a.get(this._spriteAsset))?this._bindSpriteAsset(c):(this.sprite=null,a.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}});Object.defineProperty(d.prototype,"sprite",
{get:function(){return this._sprite},set:function(b){this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this));if(this._sprite=b)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),
this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this);if(this._component.currentClip===this){var a;if(b&&b.atlas){if(b.atlas.texture){if(a=this._component._meshInstance)a.setParameter("texture_emissiveMap",b.atlas.texture),a.setParameter("texture_opacityMap",b.atlas.texture);this._component.enabled&&this._component.entity.enabled&&this._component._showModel()}this.time&&this.fps?this.time=this.time:this.frame=
this.frame}else{if(a=this._component._meshInstance)a.deleteParameter("texture_emissiveMap"),a.deleteParameter("texture_opacityMap");this._component._hideModel()}}}});Object.defineProperty(d.prototype,"frame",{get:function(){return this._frame},set:function(b){this._setFrame(b);this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}});Object.defineProperty(d.prototype,"isPlaying",{get:function(){return this._playing}});Object.defineProperty(d.prototype,"isPaused",{get:function(){return this._paused}});
Object.defineProperty(d.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}});Object.defineProperty(d.prototype,"time",{get:function(){return this._time},set:function(b){this._setTime(b);this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):0}});return{SpriteAnimationClip:d}}());Object.assign(pc,function(){pc.SPRITETYPE_SIMPLE="simple";pc.SPRITETYPE_ANIMATED="animated";var d=function(b,a){pc.Component.call(this,b,a);this._type=pc.SPRITETYPE_SIMPLE;this._material=b.defaultMaterial;this._color=new pc.Color(1,1,1,1);this._colorUniform=new Float32Array(3);this._speed=1;this._flipY=this._flipX=!1;this._height=this._width=1;this._drawOrder=0;this._layers=[pc.LAYERID_WORLD];this._outerScale=new pc.Vec2(1,1);this._outerScaleUniform=new Float32Array(2);this._innerOffset=new pc.Vec4;
this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new pc.Vec4;this._atlasRectUniform=new Float32Array(4);this._batchGroupId=-1;this._batchGroup=null;this._node=new pc.GraphNode;this._model=new pc.Model;this._model.graph=this._node;this._meshInstance=null;a.addChild(this._model.graph);this._model._entity=a;this._updateAabbFunc=this._updateAabb.bind(this);this._addedModel=!1;this._autoPlayClip=null;this._clips={};this._currentClip=this._defaultClip=new pc.SpriteAnimationClip(this,{name:this.entity.name,
fps:0,loop:!1,spriteAsset:null})};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{onEnable:function(){var b=this.system.app,a=b.scene;a.on("set:layers",this._onLayersChanged,this);a.layers&&(a.layers.on("add",this._onLayerAdded,this),a.layers.on("remove",this._onLayerRemoved,this));this._showModel();this._autoPlayClip&&this._tryAutoPlay();0<=this._batchGroupId&&b.batcher.insert(pc.BatchGroup.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var b=
this.system.app,a=b.scene;a.off("set:layers",this._onLayersChanged,this);a.layers&&(a.layers.off("add",this._onLayerAdded,this),a.layers.off("remove",this._onLayerRemoved,this));this.stop();this._hideModel();0<=this._batchGroupId&&b.batcher.remove(pc.BatchGroup.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){this._currentClip=null;this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(var b in this._clips)this._clips[b]._destroy();this._clips=null;this._hideModel();
this._model=null;this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null);this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var b,a=[this._meshInstance];var c=0;for(b=this._layers.length;c<b;c++){var e=this.system.app.scene.layers.getLayerById(this._layers[c]);e&&e.addMeshInstances(a)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&
this._meshInstance){var b,a=[this._meshInstance];var c=0;for(b=this._layers.length;c<b;c++){var e=this.system.app.scene.layers.getLayerById(this._layers[c]);e&&e.removeMeshInstances(a)}this._addedModel=!1}},_showFrame:function(b){if(this.sprite){var a=this.sprite.meshes[b];if(a){var c=this.system.defaultMaterial;this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?c=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED&&(c=this.system.default9SlicedMaterialTiledMode);
this._meshInstance||(this._meshInstance=new pc.MeshInstance(this._node,a,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&
this.entity.enabled&&this._showModel());this._meshInstance.material!==c&&(this._meshInstance.material=c);this._meshInstance.mesh!==a&&(this._meshInstance.mesh=a,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1);this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"));
!this.sprite.atlas||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(b=this.sprite.atlas.frames[this.sprite.frameKeys[b]])?(a=2/b.rect.z,c=2/b.rect.w,this._innerOffset.set(b.border.x*a,b.border.y*c,b.border.z*a,b.border.w*c),a=this.sprite.atlas.texture,this._atlasRect.set(b.rect.x/a.width,b.rect.y/a.height,b.rect.z/a.width,b.rect.w/a.height)):this._innerOffset.set(0,
0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform));
this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var b=this.flipX?-1:1,a=this.flipY?-1:1,c=0,e=0;if(this.sprite&&(this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED||this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED)){var f=1,d=1;if(this.sprite.atlas){var n=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];n&&(f=n.rect.z,d=n.rect.w,c=(.5-n.pivot.x)*this._width,e=(.5-n.pivot.y)*this._height)}f/=
this.sprite.pixelsPerUnit;d/=this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*f),Math.max(this._height,this._innerOffset.y*d));a*=d;this._outerScale.x/=f;this._outerScale.y/=d;b=b*f*pc.math.clamp(this._width/(this._innerOffset.x*f),1E-4,1);a*=pc.math.clamp(this._height/(this._innerOffset.y*d),1E-4,1);this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform,
4294967295))}this._node.setLocalScale(b,a,1);this._node.setLocalPosition(c,e,0)},_updateAabb:function(b){b.center.set(0,0,0);b.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);b.setFromTransformedAabb(b,this._node.getWorldTransform());return b},_tryAutoPlay:function(){if(this._autoPlayClip&&this.type===pc.SPRITETYPE_ANIMATED){var b=this._clips[this._autoPlayClip];!b||b.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(b.name)}},
_onLayersChanged:function(b,a){b.off("add",this.onLayerAdded,this);b.off("remove",this.onLayerRemoved,this);a.on("add",this.onLayerAdded,this);a.on("remove",this.onLayerRemoved,this);this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(b){0>this.layers.indexOf(b.id)||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&b.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(b){this._meshInstance&&(0>this.layers.indexOf(b.id)||b.removeMeshInstances([this._meshInstance]))},
removeModelFromLayers:function(){for(var b,a=0;a<this.layers.length;a++)(b=this.system.app.scene.layers.getLayerById(this.layers[a]))&&b.removeMeshInstances([this._meshInstance])},addClip:function(b){var a=new pc.SpriteAnimationClip(this,{name:b.name,fps:b.fps,loop:b.loop,spriteAsset:b.spriteAsset});this._clips[b.name]=a;a.name&&a.name===this._autoPlayClip&&this._tryAutoPlay();return a},removeClip:function(b){delete this._clips[b]},clip:function(b){return this._clips[b]},play:function(b){var a=this._clips[b],
c=this._currentClip;c&&c!==a&&(c._playing=!1);(this._currentClip=a)?(this._currentClip=a,this._currentClip.play()):logWARNING("Trying to play sprite animation "+b+" which does not exist.");return a},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}});
Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(b){this._type!==b&&(this._type=b,this._type===pc.SPRITETYPE_SIMPLE?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===pc.SPRITETYPE_ANIMATED&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?
this._showModel():this._hideModel()))}});Object.defineProperty(d.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(b){this._currentClip.frame=b}});Object.defineProperty(d.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(b){this._defaultClip.spriteAsset=b}});Object.defineProperty(d.prototype,"sprite",{get:function(){return this._currentClip.sprite},set:function(b){this._currentClip.sprite=b}});Object.defineProperty(d.prototype,
"material",{get:function(){return this._material},set:function(b){this._material=b;this._meshInstance&&(this._meshInstance.material=b)}});Object.defineProperty(d.prototype,"color",{get:function(){return this._color},set:function(b){this._color.r=b.r;this._color.g=b.g;this._color.b=b.b;this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}});Object.defineProperty(d.prototype,
"opacity",{get:function(){return this._color.a},set:function(b){this._color.a=b;this._meshInstance&&this._meshInstance.setParameter("material_opacity",b)}});Object.defineProperty(d.prototype,"clips",{get:function(){return this._clips},set:function(b){var a,c;if(b){for(a in this._clips){var e=!1;for(c in b)if(b[c].name===a){e=!0;this._clips[a].fps=b[c].fps;this._clips[a].loop=b[c].loop;b[c].hasOwnProperty("sprite")?this._clips[a].sprite=b[c].sprite:b[c].hasOwnProperty("spriteAsset")&&(this._clips[a].spriteAsset=
b[c].spriteAsset);break}e||this.removeClip(a)}for(c in b)this._clips[b[c].name]||this.addClip(b[c]);this._autoPlayClip&&this._tryAutoPlay();this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(a in this._clips)this.removeClip(a)}});Object.defineProperty(d.prototype,"currentClip",{get:function(){return this._currentClip}});Object.defineProperty(d.prototype,"speed",{get:function(){return this._speed},set:function(b){this._speed=b}});Object.defineProperty(d.prototype,"flipX",{get:function(){return this._flipX},
set:function(b){this._flipX!==b&&(this._flipX=b,this._updateTransform())}});Object.defineProperty(d.prototype,"flipY",{get:function(){return this._flipY},set:function(b){this._flipY!==b&&(this._flipY=b,this._updateTransform())}});Object.defineProperty(d.prototype,"width",{get:function(){return this._width},set:function(b){b!==this._width&&(this._width=b,this._outerScale.x=this._width,!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED||
this._updateTransform())}});Object.defineProperty(d.prototype,"height",{get:function(){return this._height},set:function(b){b!==this._height&&(this._height=b,this._outerScale.y=this.height,!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED||this._updateTransform())}});Object.defineProperty(d.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(b){if(this._batchGroupId!==b){var a=this._batchGroupId;this._batchGroupId=
b;this.entity.enabled&&0<=a&&this.system.app.batcher.remove(pc.BatchGroup.SPRITE,a,this.entity);this.entity.enabled&&0<=b?this.system.app.batcher.insert(pc.BatchGroup.SPRITE,b,this.entity):0<=a&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}});Object.defineProperty(d.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(b){this._autoPlayClip=b instanceof pc.SpriteAnimationClip?b.name:b;this._tryAutoPlay()}});Object.defineProperty(d.prototype,
"drawOrder",{get:function(){return this._drawOrder},set:function(b){this._drawOrder=b;this._meshInstance&&(this._meshInstance.drawOrder=b)}});Object.defineProperty(d.prototype,"layers",{get:function(){return this._layers},set:function(b){this._addedModel&&this._hideModel();this._layers=b;this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}});Object.defineProperty(d.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}});return{SpriteComponent:d}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="sprite";this.app=a;this.ComponentType=pc.SpriteComponent;this.DataType=pc.SpriteComponentData;this.schema=d;this._defaultTexture=new pc.Texture(a.graphicsDevice,{width:1,height:1,format:pc.PIXELFORMAT_R8_G8_B8_A8});a=this._defaultTexture.lock();var b=new Uint8Array(4);b[0]=255;b[1]=255;b[2]=255;b[3]=255;a.set(b);this._defaultTexture.name="sprite";this._defaultTexture.unlock();this.defaultMaterial=
new pc.StandardMaterial;this.defaultMaterial.diffuse=new pc.Color(0,0,0,1);this.defaultMaterial.emissive=new pc.Color(.5,.5,.5,1);this.defaultMaterial.emissiveMap=this._defaultTexture;this.defaultMaterial.emissiveMapTint=!0;this.defaultMaterial.opacityMap=this._defaultTexture;this.defaultMaterial.opacityMapChannel="a";this.defaultMaterial.opacityTint=!0;this.defaultMaterial.opacity=0;this.defaultMaterial.useLighting=!1;this.defaultMaterial.useGammaTonemap=!1;this.defaultMaterial.useFog=!1;this.defaultMaterial.useSkybox=
!1;this.defaultMaterial.blendType=pc.BLEND_PREMULTIPLIED;this.defaultMaterial.depthWrite=!1;this.defaultMaterial.pixelSnap=!1;this.defaultMaterial.cull=pc.CULLFACE_NONE;this.defaultMaterial.update();this.default9SlicedMaterialSlicedMode=this.defaultMaterial.clone();this.default9SlicedMaterialSlicedMode.nineSlicedMode=pc.SPRITE_RENDERMODE_SLICED;this.default9SlicedMaterialSlicedMode.update();this.default9SlicedMaterialTiledMode=this.defaultMaterial.clone();this.default9SlicedMaterialTiledMode.nineSlicedMode=
pc.SPRITE_RENDERMODE_TILED;this.default9SlicedMaterialTiledMode.update();pc.ComponentSystem.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.SpriteComponent.prototype,d);Object.assign(b.prototype,{destroy:function(){this._defaultTexture.destroy();this._defaultTexture=null},initializeComponentData:function(a,b,e){void 0!==b.enabled&&(a.enabled=b.enabled);
a.type=b.type;b.layers&&"array"===pc.type(b.layers)&&(a.layers=b.layers.slice(0));void 0!==b.drawOrder&&(a.drawOrder=b.drawOrder);void 0!==b.color&&(b.color instanceof pc.Color?a.color.set(b.color.r,b.color.g,b.color.b,void 0!==b.opacity?b.opacity:1):a.color.set(b.color[0],b.color[1],b.color[2],void 0!==b.opacity?b.opacity:1),a.color=a.color);void 0!==b.opacity&&(a.opacity=b.opacity);void 0!==b.flipX&&(a.flipX=b.flipX);void 0!==b.flipY&&(a.flipY=b.flipY);void 0!==b.width&&(a.width=b.width);void 0!==
b.height&&(a.height=b.height);void 0!==b.spriteAsset&&(a.spriteAsset=b.spriteAsset);b.sprite&&(a.sprite=b.sprite);void 0!==b.frame&&(a.frame=b.frame);if(b.clips)for(var c in b.clips)a.addClip(b.clips[c]);void 0!==b.speed&&(a.speed=b.speed);b.autoPlayClip&&(a.autoPlayClip=b.autoPlayClip);a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){a=a.sprite;return this.addComponent(b,
{enabled:a.enabled,type:a.type,spriteAsset:a.spriteAsset,sprite:a.sprite,frame:a.frame,color:a.color.clone(),opacity:a.opacity,flipX:a.flipX,flipY:a.flipY,speed:a.speed,clips:a.clips,autoPlayClip:a.autoPlayClip,batchGroupId:a.batchGroupId,drawOrder:a.drawOrder,layers:a.layers.slice(0)})},onUpdate:function(a){var b=this.store,e;for(e in b)if(b.hasOwnProperty(e)){var f=b[e];f.data.enabled&&f.entity.enabled&&(f=f.entity.sprite,f._currentClip&&f._currentClip._update(a))}},onBeforeRemove:function(a,b){b.onDestroy()}});
return{SpriteComponentSystem:b}}());Object.assign(pc,function(){return{SpriteComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){pc.SCALEMODE_NONE="none";pc.SCALEMODE_BLEND="blend";var d=function(a,b){pc.Component.call(this,a,b);this._resolution=new pc.Vec2(640,320);this._referenceResolution=new pc.Vec2(640,320);this._scaleMode=pc.SCALEMODE_NONE;this.scale=1;this._scaleBlend=.5;this._priority=0;this.cull=this._screenSpace=!1;this._screenMatrix=new pc.Mat4;a.app.graphicsDevice.on("resizecanvas",this._onResize,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;var b=
new pc.Mat4;Object.assign(d.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(a,b){if(!(a instanceof pc.Entity))return b;if(a.element){var c=a.element.drawOrder;a.element.drawOrder=b++;0<=a.element._batchGroupId&&c!=a.element.drawOrder&&this.system.app.batcher.markGroupDirty(a.element._batchGroupId)}a=a.children;for(c=0;c<a.length;c++)b=this._recurseDrawOrderSync(a[c],b);return b},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,
1);this.fire("syncdraworder")},_calcProjectionMatrix:function(){var a=this._resolution.x/this.scale,c=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,a,-c,0,1,-1);this._screenSpace||(b.setScale(.5*a,.5*c,1),this._screenMatrix.mul2(b,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(a,b){return Math.pow(2,Math.log2(a.x/b.x)*(1-this._scaleBlend)+Math.log2(a.y/b.y)*this._scaleBlend)},_onResize:function(a,
b){this._screenSpace&&(this._resolution.set(a,b),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove");this.off()}});Object.defineProperty(d.prototype,"resolution",{set:function(a){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();
this.fire("set:resolution",this._resolution)},get:function(){return this._resolution}});Object.defineProperty(d.prototype,"referenceResolution",{set:function(a){this._referenceResolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===pc.SCALEMODE_NONE?this._resolution:this._referenceResolution}});Object.defineProperty(d.prototype,"screenSpace",
{set:function(a){(this._screenSpace=a)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this.resolution=this._resolution;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}});Object.defineProperty(d.prototype,"scaleMode",{set:function(a){a!==pc.SCALEMODE_NONE&&a!==pc.SCALEMODE_BLEND&&(a=pc.SCALEMODE_NONE);this._screenSpace||a===pc.SCALEMODE_NONE||(a=pc.SCALEMODE_NONE);
this._scaleMode=a;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}});Object.defineProperty(d.prototype,"scaleBlend",{set:function(a){this._scaleBlend=a;this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}});Object.defineProperty(d.prototype,"priority",{get:function(){return this._priority},set:function(a){255<
a&&(a=255);this._priority=a}});return{ScreenComponent:d}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="screen";this.app=a;this.ComponentType=pc.ScreenComponent;this.DataType=pc.ScreenComponentData;this.schema=d;this.windowResolution=new pc.Vec2;this._drawOrderSyncQueue=new pc.IndexedList;this.app.graphicsDevice.on("resizecanvas",this._onResize,this);pc.ComponentSystem.bind("update",this._onUpdate,this);this.on("beforeremove",this.onRemoveComponent,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);
b.prototype.constructor=b;pc.Component._buildAccessors(pc.ScreenComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){void 0!==b.priority&&(a.priority=b.priority);void 0!==b.screenSpace&&(a.screenSpace=b.screenSpace);a.cull=a.screenSpace;void 0!==b.scaleMode&&(a.scaleMode=b.scaleMode);void 0!==b.scaleBlend&&(a.scaleBlend=b.scaleBlend);void 0!==b.resolution&&(b.resolution instanceof pc.Vec2?a._resolution.copy(b.resolution):a._resolution.set(b.resolution[0],b.resolution[1]),
a.resolution=a._resolution);void 0!==b.referenceResolution&&(b.referenceResolution instanceof pc.Vec2?a._referenceResolution.copy(b.referenceResolution):a._referenceResolution.set(b.referenceResolution[0],b.referenceResolution[1]),a.referenceResolution=a._referenceResolution);a.syncDrawOrder();pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},destroy:function(){this.off();this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(a){var b=this.store,e;
for(e in b)b[e].entity.screen.update&&b[e].entity.screen.update(a)},_onResize:function(a,b){this.windowResolution.x=a;this.windowResolution.y=b},cloneComponent:function(a,b){a=a.screen;return this.addComponent(b,{enabled:a.enabled,screenSpace:a.screenSpace,scaleMode:a.scaleMode,resolution:a.resolution.clone(),referenceResolution:a.referenceResolution.clone()})},onRemoveComponent:function(a,b){b.onRemove()},processDrawOrderSyncQueue:function(){for(var a=this._drawOrderSyncQueue.list(),b=0;b<a.length;b++){var e=
a[b];e.callback.call(e.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(a,b,e){if(!this._drawOrderSyncQueue.list().length)this.app.once("prerender",this.processDrawOrderSyncQueue,this);this._drawOrderSyncQueue.has(a)||this._drawOrderSyncQueue.push(a,{callback:b,scope:e})}});return{ScreenComponentSystem:b}}());Object.assign(pc,function(){return{ScreenComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){pc.ELEMENTTYPE_GROUP="group";pc.ELEMENTTYPE_IMAGE="image";pc.ELEMENTTYPE_TEXT="text";var d=new pc.Vec3,b=new pc.Vec3,a=new pc.Mat4,c=new pc.Mat4,e=new pc.Mat4,f=new pc.Mat4,g=function(a,b){pc.Component.call(this,a,b);this._beingInitialized=!1;this._anchor=new pc.Vec4;this._localAnchor=new pc.Vec4;this._pivot=new pc.Vec2;this._height=this._calculatedHeight=this._width=this._calculatedWidth=32;this._margin=new pc.Vec4(0,0,-32,-32);this._modelTransform=new pc.Mat4;this._screenToWorld=
new pc.Mat4;this._anchorTransform=new pc.Mat4;this._anchorDirty=!0;this._parentWorldTransform=new pc.Mat4;this._screenTransform=new pc.Mat4;this._screenCorners=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];this._canvasCorners=[new pc.Vec2,new pc.Vec2,new pc.Vec2,new pc.Vec2];this._worldCorners=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0;this.entity.on("insert",this._onInsert,this);this._patch();this.screen=null;this._type=
pc.ELEMENTTYPE_GROUP;this._group=this._text=this._image=null;this._drawOrder=0;this._useInput=!1;this._layers=[pc.LAYERID_UI];this._addedModels=[];this._batchGroupId=-1;this._offsetReadAt=0;this._maskOffset=.5;this._maskedBy=null};g.prototype=Object.create(pc.Component.prototype);g.prototype.constructor=g;Object.assign(g.prototype,{_patch:function(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=
pc.Entity.prototype._sync;this.entity.setPosition=pc.Entity.prototype.setPosition;this.entity.setLocalPosition=pc.Entity.prototype.setLocalPosition},_setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(c,e,f){if(!this.element.screen)return pc.Entity.prototype.setPosition.call(this,c,e,f);c instanceof pc.Vec3?a.copy(c):a.set(c,e,f);this.getWorldTransform();b.copy(this.element._screenToWorld).invert();b.transformPoint(a,this.localPosition);this._dirtyLocal||this._dirtifyLocal()}}(),
_setLocalPosition:function(a,b,c){a instanceof pc.Vec3?this.localPosition.copy(a):this.localPosition.set(a,b,c);a=this.element;b=this.localPosition;c=a._pivot;a._margin.x=b.x-a._calculatedWidth*c.x;a._margin.z=a._localAnchor.z-a._localAnchor.x-a._calculatedWidth-a._margin.x;a._margin.y=b.y-a._calculatedHeight*c.y;a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y;this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var f=this.element,g=f.screen;if(g){if(f._anchorDirty){var m=
0,n=1;if(this._parent&&this._parent.element){var p=this._parent.element.calculatedWidth;var q=this._parent.element.calculatedHeight;m=this._parent.element.pivot.x;n=this._parent.element.pivot.y}else q=g.screen.resolution,p=q.x/g.screen.scale,q=q.y/g.screen.scale;f._anchorTransform.setTranslate(p*(f.anchor.x-m),-(q*(n-f.anchor.y)),0);f._anchorDirty=!1;f._calculateLocalAnchors()}f._sizeDirty&&f._calculateSize(!1,!1)}this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,
this.localScale),p=this.localPosition,m=f._pivot,f._margin.x=p.x-f._calculatedWidth*m.x,f._margin.z=f._localAnchor.z-f._localAnchor.x-f._calculatedWidth-f._margin.x,f._margin.y=p.y-f._calculatedHeight*m.y,f._margin.w=f._localAnchor.w-f._localAnchor.y-f._calculatedHeight-f._margin.y,this._dirtyLocal=!1);if(!g)return this._dirtyWorld&&(f._cornersDirty=!0,f._canvasCornersDirty=!0,f._worldCornersDirty=!0),pc.Entity.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):
(this._parent.element?f._screenToWorld.mul2(this._parent.element._modelTransform,f._anchorTransform):f._screenToWorld.copy(f._anchorTransform),f._modelTransform.mul2(f._screenToWorld,this.localTransform),g?(f._screenToWorld.mul2(g.screen._screenMatrix,f._screenToWorld),g.screen.screenSpace||f._screenToWorld.mul2(g.worldTransform,f._screenToWorld),this.worldTransform.mul2(f._screenToWorld,this.localTransform),p=f._parentWorldTransform,p.setIdentity(),(m=this._parent)&&m.element&&m!==g&&(a.setTRS(pc.Vec3.ZERO,
m.getLocalRotation(),m.getLocalScale()),p.mul2(m.element._parentWorldTransform,a)),d.set(0,0,this.localPosition.z),b.set(f._absLeft+f._pivot.x*f.calculatedWidth,f._absBottom+f._pivot.y*f.calculatedHeight,0),a.setTranslate(-b.x,-b.y,-b.z),c.setTRS(d,this.getLocalRotation(),this.getLocalScale()),e.setTranslate(b.x,b.y,b.z),f._screenTransform.mul2(f._parentWorldTransform,e).mul(c).mul(a),f._cornersDirty=!0,f._canvasCornersDirty=!0,f._worldCornersDirty=!0):this.worldTransform.copy(f._modelTransform)),
this._dirtyWorld=!1)},_onInsert:function(a){a=this._parseUpToScreen();this.entity._dirtifyWorld();this._updateScreen(a.screen);this._dirtifyMask()},_dirtifyMask:function(){for(var a=this.entity;a;){var b=a.parent;if((null===b||b.screen)&&a.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var c=this.system._prerender.indexOf(this.entity);0<=c&&this.system._prerender.splice(c,1);0>this.system._prerender.indexOf(a)&&
this.system._prerender.push(a)}a=b}},_onPrerender:function(){for(var a=0;a<this.system._prerender.length;a++){var b=this.system._prerender[a];b.element&&b.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(a){a.on("set:resolution",this._onScreenResize,this);a.on("set:referenceresolution",this._onScreenResize,this);a.on("set:scaleblend",this._onScreenResize,this);a.on("set:screenspace",this._onScreenSpaceChange,this);a.on("remove",this._onScreenRemove,this)},_unbindScreen:function(a){a.off("set:resolution",
this._onScreenResize,this);a.off("set:referenceresolution",this._onScreenResize,this);a.off("set:scaleblend",this._onScreenResize,this);a.off("set:screenspace",this._onScreenSpaceChange,this);a.off("remove",this._onScreenRemove,this)},_updateScreen:function(a){this.screen&&this.screen!==a&&this._unbindScreen(this.screen.screen);var b=this.screen;(this.screen=a)&&this._bindScreen(this.screen.screen);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen,
b);this._anchorDirty=!0;b=this.entity.children;for(var c=0,e=b.length;c<e;c++)b[c].element&&b[c].element._updateScreen(a);this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(a){var b=this._parseUpToScreen();this._updateMask(b.mask,a)},_setMaskedBy:function(a){var b=this._image||this._text;if(a){var c=new pc.StencilParameters({ref:a.element._image._maskRef,func:pc.FUNC_EQUAL});b&&b._setStencil&&b._setStencil(c);this._maskedBy=a}else b&&b._setStencil&&b._setStencil(null),this._maskedBy=
null},_updateMask:function(a,b){var c;a?(this._setMaskedBy(a),this.mask&&(a=new pc.StencilParameters({ref:a.element._image._maskRef,func:pc.FUNC_EQUAL,zpass:pc.STENCILOP_INCREMENT}),this._image._setStencil(a),this._image._maskRef=b,b++,a=this.entity)):(this._setMaskedBy(null),this.mask&&(a=new pc.StencilParameters({ref:b,func:pc.FUNC_ALWAYS,zpass:pc.STENCILOP_REPLACE}),this._image._setStencil(a),this._image._maskRef=b,b++,a=this.entity));var e=this.entity.children;var f=0;for(c=e.length;f<c;f++)e[f].element&&
e[f].element._updateMask(a,b)},_parseUpToScreen:function(){for(var a={screen:null,mask:null},b=this.entity._parent;b&&!b.screen;)b.element&&b.element.mask&&!a.mask&&(a.mask=b),b=b.parent;b&&b.screen&&(a.screen=b);return a},_onScreenResize:function(a){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("screen:set:resolution",a)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},
_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var a=1E3,b=1E3,c=this.entity._parent;c&&c.element?(a=c.element.calculatedWidth,b=c.element.calculatedHeight):this.screen&&(b=this.screen.screen.resolution,c=this.screen.screen.scale,a=b.x/c,b=b.y/c);this._localAnchor.set(this._anchor.x*a,this._anchor.y*b,this._anchor.z*a,this._anchor.w*b)},getOffsetPosition:function(a,b){var c=this.entity.getLocalPosition().clone();c.x+=a;
c.y+=b;this._screenToWorld.transformPoint(c,c);return c},onLayersChanged:function(a,b){this.addModelToLayers(this._image?this._image._model:this._text._model);a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||(this._image?a.addMeshInstances(this._image._model.meshInstances):this._text&&a.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(a){0>
this.layers.indexOf(a.id)||(this._image?a.removeMeshInstances(this._image._model.meshInstances):this._text&&a.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();if(this._group)this._group.onEnable();this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",
this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&this.system.app.batcher.insert(pc.BatchGroup.ELEMENT,this.batchGroupId,this.entity);this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));if(this._image)this._image.onDisable();
if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);0<=this._batchGroupId&&this.system.app.batcher.remove(pc.BatchGroup.ELEMENT,this.batchGroupId,this.entity);this.fire("disableelement")},onRemove:function(){this.entity.off("insert",this._onInsert,this);this._unpatch();this._image&&this._image.destroy();this._text&&this._text.destroy();this.system.app.elementInput&&this.useInput&&
this.system.app.elementInput.removeElement(this);this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder());this.off()},_calculateSize:function(a,b){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var c=this._absRight-this._absLeft,e=this._absTop-this._absBottom;a?this._setWidth(c):this._setCalculatedWidth(c,!1);b?this._setHeight(e):this._setCalculatedHeight(e,!1);a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*
this._pivot.x;a.y=this._margin.y+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(a);this._sizeDirty=!1}},_setWidth:function(a){this._width=a;this._setCalculatedWidth(a,!1);this.fire("set:width",this._width)},_setHeight:function(a){this._height=a;this._setCalculatedHeight(a,!1);this.fire("set:height",this._height)},_setCalculatedWidth:function(a,b){1E-4>=Math.abs(a-this._calculatedWidth)||(this._calculatedWidth=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.x=
a.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_setCalculatedHeight:function(a,b){1E-4>=Math.abs(a-this._calculatedHeight)||(this._calculatedHeight=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.y=a.y-this._calculatedHeight*this._pivot.y,
this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_flagChildrenAsDirty:function(){var a,b=this.entity._children;var c=0;for(a=b.length;c<a;c++)b[c].element&&(b[c].element._anchorDirty=!0,b[c].element._sizeDirty=!0)},addModelToLayers:function(a){var b;this._addedModels.push(a);for(var c=0;c<this.layers.length;c++)(b=
this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.addMeshInstances(a.meshInstances)},removeModelFromLayers:function(a){var b=this._addedModels.indexOf(a);0<=b&&this._addedModels.splice(b,1);for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.removeMeshInstances(a.meshInstances)},getMaskOffset:function(){var a=this.system.app.frame;this._offsetReadAt!==a&&(this._maskOffset=.5,this._offsetReadAt=a);a=this._maskOffset;this._maskOffset-=.001;
return a},isVisibleForCamera:function(a){if(this.maskedBy){a=this.maskedBy.element.screenCorners;var b=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x));var c=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x));var e=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y));a=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y))}else{b=this.system.app.graphicsDevice.width;var f=this.system.app.graphicsDevice.height;c=a._rect.width*b;e=a._rect.height*f;b*=a._rect.x;c=b+c;a=(1-a._rect.y)*
f;e=a-e}f=this.screenCorners;var d=Math.min(Math.min(f[0].x,f[1].x),Math.min(f[2].x,f[3].x)),g=Math.min(Math.min(f[0].y,f[1].y),Math.min(f[2].y,f[3].y)),k=Math.max(Math.max(f[0].y,f[1].y),Math.max(f[2].y,f[3].y));return Math.max(Math.max(f[0].x,f[1].x),Math.max(f[2].x,f[3].x))<b||d>c||g>a||k<e?!1:!0},_isScreenSpace:function(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1},_isScreenCulled:function(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}});Object.defineProperty(g.prototype,
"type",{get:function(){return this._type},set:function(a){a!==this._type&&(this._type=a,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),a===pc.ELEMENTTYPE_IMAGE?this._image=new pc.ImageElement(this):a===pc.ELEMENTTYPE_TEXT&&(this._text=new pc.TextElement(this)))}});Object.defineProperty(g.prototype,"layers",{get:function(){return this._layers},set:function(a){var b,c,e;if(this._addedModels.length)for(b=0;b<this._layers.length;b++)if(e=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=
0;c<this._addedModels.length;c++)e.removeMeshInstances(this._addedModels[c].meshInstances);this._layers=a;if(this.enabled&&this.entity.enabled&&this._addedModels.length)for(b=0;b<this._layers.length;b++)if(e=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=0;c<this._addedModels.length;c++)e.addMeshInstances(this._addedModels[c].meshInstances)}});Object.defineProperty(g.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(a){var b=0;this.screen&&(b=this.screen.screen.priority);
16777215<a&&(a=16777215);this._drawOrder=(b<<24)+a;this.fire("set:draworder",this._drawOrder)}});Object.defineProperty(g.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}});Object.defineProperty(g.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}});Object.defineProperty(g.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}});Object.defineProperty(g.prototype,"_absBottom",{get:function(){return this._localAnchor.y+
this._margin.y}});Object.defineProperty(g.prototype,"margin",{get:function(){return this._margin},set:function(a){this._margin.copy(a);this._calculateSize(!0,!0);this.fire("set:margin",this._margin)}});Object.defineProperty(g.prototype,"left",{get:function(){return this._margin.x},set:function(a){this._margin.x=a;var b=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.x+a));b.x=a+this._calculatedWidth*this._pivot.x;this.entity.setLocalPosition(b)}});Object.defineProperty(g.prototype,
"right",{get:function(){return this._margin.z},set:function(a){this._margin.z=a;var b=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-a-this._absLeft);b.x=this._localAnchor.z-this._localAnchor.x-a-this._calculatedWidth*(1-this._pivot.x);this.entity.setLocalPosition(b)}});Object.defineProperty(g.prototype,"top",{get:function(){return this._margin.w},set:function(a){this._margin.w=a;var b=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-a-this._absBottom);b.y=this._localAnchor.w-
this._localAnchor.y-a-this._calculatedHeight*(1-this._pivot.y);this.entity.setLocalPosition(b)}});Object.defineProperty(g.prototype,"bottom",{get:function(){return this._margin.y},set:function(a){this._margin.y=a;var b=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+a));b.y=a+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(b)}});Object.defineProperty(g.prototype,"width",{get:function(){return this._width},set:function(a){this._width=a;this._hasSplitAnchorsX||
this._setCalculatedWidth(a,!0);this.fire("set:width",this._width)}});Object.defineProperty(g.prototype,"height",{get:function(){return this._height},set:function(a){this._height=a;this._hasSplitAnchorsY||this._setCalculatedHeight(a,!0);this.fire("set:height",this._height)}});Object.defineProperty(g.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(a){this._setCalculatedWidth(a,!0)}});Object.defineProperty(g.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},
set:function(a){this._setCalculatedHeight(a,!0)}});Object.defineProperty(g.prototype,"pivot",{get:function(){return this._pivot},set:function(a){var b=this._pivot.x,c=this._pivot.y;a instanceof pc.Vec2?this._pivot.set(a.x,a.y):this._pivot.set(a[0],a[1]);a=this._margin.x+this._margin.z;b=this._pivot.x-b;this._margin.x+=a*b;this._margin.z-=a*b;b=this._margin.y+this._margin.w;c=this._pivot.y-c;this._margin.y+=b*c;this._margin.w-=b*c;this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(!1,
!1);this._flagChildrenAsDirty();this.fire("set:pivot",this._pivot)}});Object.defineProperty(g.prototype,"anchor",{get:function(){return this._anchor},set:function(a){a instanceof pc.Vec4?this._anchor.set(a.x,a.y,a.z,a.w):this._anchor.set(a[0],a[1],a[2],a[3]);this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors();this._anchorDirty=!0;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:anchor",this._anchor)}});
Object.defineProperty(g.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}});Object.defineProperty(g.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}});Object.defineProperty(g.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}});Object.defineProperty(g.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;
var a=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var b=this.screen.screen.screenSpace,c=0;4>c;c++)this._screenTransform.transformPoint(this._screenCorners[c],this._screenCorners[c]),b&&this._screenCorners[c].scale(this.screen.screen.scale),
a&&this._screenCorners[c].add(a);this._cornersDirty=!1;this._worldCornersDirty=this._canvasCornersDirty=!0;return this._screenCorners}});Object.defineProperty(g.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var a=this.system.app.graphicsDevice,b=this.screenCorners,c=a.canvas.clientWidth/a.width,e=a.canvas.clientHeight/a.height,f=0;4>f;f++)this._canvasCorners[f].set(b[f].x*c,(a.height-b[f].y)*e);
this._canvasCornersDirty=!1;return this._canvasCorners}});Object.defineProperty(g.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var b=this.screenCorners;if(!this.screen.screen.screenSpace){a.copy(this.screen.screen._screenMatrix);a.data[13]=-a.data[13];a.mul2(this.screen.getWorldTransform(),a);for(var g=0;4>g;g++)a.transformPoint(b[g],this._worldCorners[g])}}else b=this.entity.getLocalPosition(),a.setTranslate(-b.x,-b.y,-b.z),c.setTRS(pc.Vec3.ZERO,
this.entity.getLocalRotation(),this.entity.getLocalScale()),e.setTranslate(b.x,b.y,b.z),f.copy(this.entity.parent.getWorldTransform()),f.mul(e).mul(c).mul(a),d.set(b.x-this.pivot.x*this.calculatedWidth,b.y-this.pivot.y*this.calculatedHeight,b.z),f.transformPoint(d,this._worldCorners[0]),d.set(b.x+(1-this.pivot.x)*this.calculatedWidth,b.y-this.pivot.y*this.calculatedHeight,b.z),f.transformPoint(d,this._worldCorners[1]),d.set(b.x+(1-this.pivot.x)*this.calculatedWidth,b.y+(1-this.pivot.y)*this.calculatedHeight,
b.z),f.transformPoint(d,this._worldCorners[2]),d.set(b.x-this.pivot.x*this.calculatedWidth,b.y+(1-this.pivot.y)*this.calculatedHeight,b.z),f.transformPoint(d,this._worldCorners[3]);this._worldCornersDirty=!1;return this._worldCorners}});Object.defineProperty(g.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}});Object.defineProperty(g.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}});Object.defineProperty(g.prototype,"useInput",{get:function(){return this._useInput},
set:function(a){this._useInput!==a&&(this._useInput=a,this.system.app.elementInput&&(a?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",a))}});Object.defineProperty(g.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){this._batchGroupId!==a&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(pc.BatchGroup.ELEMENT,this.batchGroupId,this.entity),
this.entity.enabled&&0<=a&&this.system.app.batcher.insert(pc.BatchGroup.ELEMENT,a,this.entity),0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=a)}});Object.defineProperty(g.prototype,"maskedBy",{get:function(){return this._maskedBy}});var n=function(a){Object.defineProperty(g.prototype,a,{get:function(){return this._text?
this._text[a]:this._image?this._image[a]:null},set:function(b){this._text?this._text[a]=b:this._image&&(this._image[a]=b)}})};n("fontSize");n("minFontSize");n("maxFontSize");n("maxLines");n("autoFitWidth");n("autoFitHeight");n("color");n("font");n("fontAsset");n("spacing");n("lineHeight");n("wrapLines");n("lines");n("alignment");n("autoWidth");n("autoHeight");n("rtlReorder");n("unicodeConverter");n("text");n("key");n("texture");n("textureAsset");n("material");n("materialAsset");n("sprite");n("spriteAsset");
n("spriteFrame");n("pixelsPerUnit");n("opacity");n("rect");n("mask");n("outlineColor");n("outlineThickness");n("shadowColor");n("shadowOffset");n("enableMarkup");n("rangeStart");n("rangeEnd");return{ElementComponent:g}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="element";this.app=a;this.ComponentType=pc.ElementComponent;this.DataType=pc.ElementComponentData;this.schema=d;this._rtlReorder=this._unicodeConverter=null;this._defaultTexture=new pc.Texture(a.graphicsDevice,{width:1,height:1,format:pc.PIXELFORMAT_R8_G8_B8_A8});this._defaultTexture.name="element-system";a=this._defaultTexture.lock();var b=new Uint8Array(4);b[0]=255;b[1]=255;b[2]=255;b[3]=255;a.set(b);
this._defaultTexture.unlock();this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=
this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null;this.defaultImageMaterials=[];this.on("beforeremove",this.onRemoveComponent,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ElementComponent.prototype,d);Object.assign(b.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(a,b,e){a._beingInitialized=!0;void 0!==b.anchor&&(b.anchor instanceof
pc.Vec4?a.anchor.copy(b.anchor):a.anchor.set(b.anchor[0],b.anchor[1],b.anchor[2],b.anchor[3]));void 0!==b.pivot&&(b.pivot instanceof pc.Vec2?a.pivot.copy(b.pivot):a.pivot.set(b.pivot[0],b.pivot[1]));var c=.001<Math.abs(a.anchor.x-a.anchor.z),d=.001<Math.abs(a.anchor.y-a.anchor.w),n=!1;void 0!==b.margin&&(b.margin instanceof pc.Vec4?a.margin.copy(b.margin):a._margin.set(b.margin[0],b.margin[1],b.margin[2],b.margin[3]),n=!0);void 0!==b.left&&(a._margin.x=b.left,n=!0);void 0!==b.bottom&&(a._margin.y=
b.bottom,n=!0);void 0!==b.right&&(a._margin.z=b.right,n=!0);void 0!==b.top&&(a._margin.w=b.top,n=!0);n&&(a.margin=a._margin);n=!1;void 0===b.width||c?c&&(n=!0):a.width=b.width;void 0===b.height||d?d&&(n=!0):a.height=b.height;n&&(a.anchor=a.anchor);void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.useInput&&(a.useInput=b.useInput);a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;b.layers&&"array"===pc.type(b.layers)&&(a.layers=b.layers.slice(0));a.type=b.type;a.type===
pc.ELEMENTTYPE_IMAGE?(void 0!==b.rect&&(a.rect=b.rect),void 0!==b.color&&(c=b.color,c instanceof pc.Color||(c=new pc.Color(b.color[0],b.color[1],b.color[2])),a.color=c),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.textureAsset&&(a.textureAsset=b.textureAsset),b.texture&&(a.texture=b.texture),void 0!==b.spriteAsset&&(a.spriteAsset=b.spriteAsset),b.sprite&&(a.sprite=b.sprite),void 0!==b.spriteFrame&&(a.spriteFrame=b.spriteFrame),void 0!==b.pixelsPerUnit&&null!==b.pixelsPerUnit&&(a.pixelsPerUnit=
b.pixelsPerUnit),void 0!==b.materialAsset&&(a.materialAsset=b.materialAsset),b.material&&(a.material=b.material),void 0!==b.mask&&(a.mask=b.mask)):a.type===pc.ELEMENTTYPE_TEXT&&(void 0!==b.autoWidth&&(a.autoWidth=b.autoWidth),void 0!==b.autoHeight&&(a.autoHeight=b.autoHeight),void 0!==b.rtlReorder&&(a.rtlReorder=b.rtlReorder),void 0!==b.unicodeConverter&&(a.unicodeConverter=b.unicodeConverter),null!==b.text&&void 0!==b.text?a.text=b.text:null!==b.key&&void 0!==b.key&&(a.key=b.key),void 0!==b.color&&
(c=b.color,c instanceof pc.Color||(c=new pc.Color(c[0],c[1],c[2])),a.color=c),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.spacing&&(a.spacing=b.spacing),void 0!==b.fontSize&&(a.fontSize=b.fontSize,b.lineHeight||(a.lineHeight=b.fontSize)),void 0!==b.lineHeight&&(a.lineHeight=b.lineHeight),void 0!==b.maxLines&&(a.maxLines=b.maxLines),void 0!==b.wrapLines&&(a.wrapLines=b.wrapLines),void 0!==b.minFontSize&&(a.minFontSize=b.minFontSize),void 0!==b.maxFontSize&&(a.maxFontSize=b.maxFontSize),b.autoFitWidth&&
(a.autoFitWidth=b.autoFitWidth),b.autoFitHeight&&(a.autoFitHeight=b.autoFitHeight),void 0!==b.fontAsset&&(a.fontAsset=b.fontAsset),void 0!==b.font&&(a.font=b.font),void 0!==b.alignment&&(a.alignment=b.alignment),void 0!==b.outlineColor&&(a.outlineColor=b.outlineColor),void 0!==b.outlineThickness&&(a.outlineThickness=b.outlineThickness),void 0!==b.shadowColor&&(a.shadowColor=b.shadowColor),void 0!==b.shadowOffset&&(a.shadowOffset=b.shadowOffset),void 0!==b.enableMarkup&&(a.enableMarkup=b.enableMarkup));
c=a._parseUpToScreen();c.screen&&a._updateScreen(c.screen);pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e);a._beingInitialized=!1;a.type===pc.ELEMENTTYPE_IMAGE&&a._image._meshDirty&&a._image._updateMesh(a._image.mesh)},onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.element;var c={enabled:a.enabled,width:a.width,height:a.height,anchor:a.anchor.clone(),pivot:a.pivot.clone(),margin:a.margin.clone(),alignment:a.alignment&&a.alignment.clone()||a.alignment,
autoWidth:a.autoWidth,autoHeight:a.autoHeight,type:a.type,rect:a.rect&&a.rect.clone()||a.rect,rtlReorder:a.rtlReorder,unicodeConverter:a.unicodeConverter,materialAsset:a.materialAsset,material:a.material,color:a.color&&a.color.clone()||a.color,opacity:a.opacity,textureAsset:a.textureAsset,texture:a.texture,spriteAsset:a.spriteAsset,sprite:a.sprite,spriteFrame:a.spriteFrame,pixelsPerUnit:a.pixelsPerUnit,spacing:a.spacing,lineHeight:a.lineHeight,wrapLines:a.wrapLines,layers:a.layers,fontSize:a.fontSize,
minFontSize:a.minFontSize,maxFontSize:a.maxFontSize,autoFitWidth:a.autoFitWidth,autoFitHeight:a.autoFitHeight,maxLines:a.maxLines,fontAsset:a.fontAsset,font:a.font,useInput:a.useInput,batchGroupId:a.batchGroupId,mask:a.mask,outlineColor:a.outlineColor&&a.outlineColor.clone()||a.outlineColor,outlineThickness:a.outlineThickness,shadowColor:a.shadowColor&&a.shadowColor.clone()||a.shadowColor,shadowOffset:a.shadowOffset&&a.shadowOffset.clone()||a.shadowOffset,enableMarkup:a.enableMarkup};void 0!==a.key&&
null!==a.key?c.key=a.key:c.text=a.text;return this.addComponent(b,c)},getTextElementMaterial:function(a,b){if(a){if(b)return this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new pc.StandardMaterial,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=
!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=pc.BLEND_PREMULTIPLIED,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial;
this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new pc.StandardMaterial,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,
this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=pc.BLEND_PREMULTIPLIED,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=
!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update());return this.defaultScreenSpaceBitmapTextMaterial}if(b)return this.defaultTextMaterial||(this.defaultTextMaterial=new pc.StandardMaterial,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=
!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=pc.BLEND_PREMULTIPLIED,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial;this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new pc.StandardMaterial,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,
.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,
0,0),this.defaultBitmapTextMaterial.blendType=pc.BLEND_PREMULTIPLIED,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update());return this.defaultBitmapTextMaterial},_createBaseImageMaterial:function(){var a=new pc.StandardMaterial;a.diffuse.set(0,0,0);a.emissive.set(.5,.5,.5);a.emissiveMap=this._defaultTexture;a.emissiveTint=!0;a.opacityMap=this._defaultTexture;a.opacityMapChannel="a";a.opacityTint=!0;a.opacity=0;a.useLighting=
!1;a.useGammaTonemap=!1;a.useFog=!1;a.useSkybox=!1;a.blendType=pc.BLEND_PREMULTIPLIED;a.depthWrite=!1;return a},getImageElementMaterial:function(a,b,e,f){if(a){if(b){if(e)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_SLICED,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=
!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial;if(f)return this.defaultScreenSpaceImageMask9TiledMaterial||
(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_TILED,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=
!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",
this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial));return this.defaultScreenSpaceImageMaskMaterial}if(e)return this.defaultScreenSpaceImage9SlicedMaterial||
(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_SLICED,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;if(f)return this.defaultScreenSpaceImage9TiledMaterial||
(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_TILED,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;this.defaultScreenSpaceImageMaterial||
(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial));return this.defaultScreenSpaceImageMaterial}if(b){if(e)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name=
"defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_SLICED,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;
if(f)return this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_TILED,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=
!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial;this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=
!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial));return this.defaultImageMaskMaterial}if(e)return this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_SLICED,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),
this.defaultImage9SlicedMaterial;if(f)return this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=pc.SPRITE_RENDERMODE_TILED,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial;this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),
this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial));return this.defaultImageMaterial},registerUnicodeConverter:function(a){this._unicodeConverter=a},registerRtlReorder:function(a){this._rtlReorder=a},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}});return{ElementComponentSystem:b}}());Object.assign(pc,function(){return{ElementComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){var d=function(a,b,e){this._entity=a;this._element=a.element;this.model=new pc.Model;this.node=new pc.GraphNode;this.model.graph=this.node;this.mesh=b;this.meshInstance=new pc.MeshInstance(this.node,this.mesh,e);this.meshInstance.name="ImageElement: "+a.name;this.meshInstance.castShadow=!1;this._meshDirty=this.meshInstance.receiveShadow=!1;this.model.meshInstances.push(this.meshInstance);this._entity.addChild(this.model.graph);this.model._entity=this._entity;this.unmaskMeshInstance=
null};d.prototype.destroy=function(){this.setMaterial(null);this._element.removeModelFromLayers(this.model);this.model.destroy();this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null};d.prototype.setMesh=function(a){this.meshInstance&&(this.mesh=a,this.meshInstance.mesh=a,this.meshInstance.visible=!!a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=a),this.forceUpdateAabb())};d.prototype.setMask=function(a){if(this.meshInstance){if(a){this.unmaskMeshInstance=new pc.MeshInstance(this.node,
this.mesh,this.meshInstance.material);this.unmaskMeshInstance.name="Unmask: "+this._entity.name;this.unmaskMeshInstance.castShadow=!1;this.unmaskMeshInstance.receiveShadow=!1;this.unmaskMeshInstance.pick=!1;this.model.meshInstances.push(this.unmaskMeshInstance);for(var b in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(b,this.meshInstance.parameters[b].data)}else a=this.model.meshInstances.indexOf(this.unmaskMeshInstance),0<=a&&this.model.meshInstances.splice(a,1),this.unmaskMeshInstance=
null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}};d.prototype.setMaterial=function(a){this.meshInstance&&(this.meshInstance.material=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=a))};d.prototype.setParameter=function(a,b){this.meshInstance&&(this.meshInstance.setParameter(a,b),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(a,b))};d.prototype.deleteParameter=function(a){this.meshInstance&&
(this.meshInstance.deleteParameter(a),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(a))};d.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var a=function(b){var c;b=b.children;var e=b.length;if(e){for(var d=0;d<e;d++)b[d].element&&(c=b[d]);return c?(b=a(c))?b:c:null}return null};if(this.unmaskMeshInstance){var b=a(this._entity);this.unmaskMeshInstance.drawOrder=b&&b.element?b.element.drawOrder+b.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}};
d.prototype.setDrawOrder=function(a){this.meshInstance&&(this.meshInstance.drawOrder=a)};d.prototype.setCull=function(a){if(this.meshInstance){var b=this._element,e=null;a&&b._isScreenCulled()&&(e=function(a){return b.isVisibleForCamera(a)});this.meshInstance.cull=a;this.meshInstance.isVisibleFunc=e;this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=a,this.unmaskMeshInstance.isVisibleFunc=e)}};d.prototype.setScreenSpace=function(a){this.meshInstance&&(this.meshInstance.screenSpace=a,this.unmaskMeshInstance&&
(this.unmaskMeshInstance.screenSpace=a))};d.prototype.setLayer=function(a){this.meshInstance&&(this.meshInstance.layer=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=a))};d.prototype.forceUpdateAabb=function(a){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))};d.prototype.setAabbFunc=function(a){this.meshInstance&&(this.meshInstance._updateAabbFunc=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=a))};var b=
function(a){this._element=a;this._entity=a.entity;this._system=a.system;this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new pc.Vec4(0,0,1,1);this._mask=!1;this._maskRef=0;this._outerScale=new pc.Vec2;this._outerScaleUniform=new Float32Array(2);this._innerOffset=new pc.Vec4;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new pc.Vec4;this._atlasRectUniform=new Float32Array(4);
this._defaultMesh=this._createMesh();this._renderable=new d(this._entity,this._defaultMesh,this._material);this._color=new pc.Color(1,1,1,1);this._colorUniform=new Float32Array([1,1,1]);this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",1);this._updateAabbFunc=this._updateAabb.bind(this);this._onScreenChange(this._element.screen);this._element.on("resize",this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,
this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)};Object.assign(b.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null;this._renderable.setMesh(this._defaultMesh);this._renderable.destroy();this._defaultMesh=null;this._element.off("resize",this._onParentResizeOrPivotChange,
this);this._element.off("set:pivot",this._onParentResizeOrPivotChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(a){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},
_onScreenChange:function(a,b){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(a){this._renderable.setDrawOrder(a);if(this.mask&&this._element.screen)this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(this.sprite.renderMode===
pc.SPRITE_RENDERMODE_SLICED||this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED)},_updateMaterial:function(a){var b=!!this._mask,e=!(!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED),f=!(!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(a,b,e,f));this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(a),this._renderable.setLayer(a?
pc.LAYER_HUD:pc.LAYER_WORLD))},_createMesh:function(){var a=this._element,b=a.calculatedWidth;a=a.calculatedHeight;var e=this._rect,f=new ArrayBuffer(128),d=new Float32Array(f);d[5]=1;d[6]=e.x;d[7]=e.y;d[8]=b;d[13]=1;d[14]=e.x+e.z;d[15]=e.y;d[16]=b;d[17]=a;d[21]=1;d[22]=e.x+e.z;d[23]=e.y+e.w;d[25]=a;d[29]=1;d[30]=e.x;d[31]=e.y+e.w;e=this._system.app.graphicsDevice;d=new pc.VertexFormat(e,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32},
{semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32}]);f=new pc.VertexBuffer(e,d,4,pc.BUFFER_STATIC,f);e=new pc.Mesh(e);e.vertexBuffer=f;e.primitive[0].type=pc.PRIMITIVE_TRIFAN;e.primitive[0].base=0;e.primitive[0].count=4;e.primitive[0].indexed=!1;e.aabb.setMinMax(pc.Vec3.ZERO,new pc.Vec3(b,a,0));this._updateMesh(e);return e},_updateMesh:function(a){var b=this._element,e=b.calculatedWidth,f=b.calculatedHeight,d=b._isScreenSpace();this._updateMaterial(d);this._renderable&&this._renderable.forceUpdateAabb();
if(!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED){var n=a.vertexBuffer,k=new Float32Array(n.lock());d=b.pivot.x;b=b.pivot.y;k[0]=-(d*e);k[1]=-(b*f);k[8]=e-d*e;k[9]=-(b*f);k[16]=e-d*e;k[17]=f-b*f;k[24]=-(d*e);k[25]=f-b*f;var h=1,m=1,l=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var p=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];p&&(l=p.rect,h=this._sprite.atlas.texture.width,
m=this._sprite.atlas.texture.height)}k[6]=l.x/h;k[7]=l.y/m;k[14]=(l.x+l.z)/h;k[15]=l.y/m;k[22]=(l.x+l.z)/h;k[23]=(l.y+l.w)/m;k[30]=l.x/h;k[31]=(l.y+l.w)/m;n.unlock();n=new pc.Vec3(-(d*e),-(b*f),0);e=new pc.Vec3(e-d*e,f-b*f,0);a.aabb.setMinMax(n,e);this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],d=2/a.rect.z,n=2/a.rect.w,this._innerOffset.set(a.border.x*
d,a.border.y*n,a.border.z*d,a.border.w*n),d=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/d.width,a.rect.y/d.height,a.rect.z/d.width,a.rect.w/d.height),n=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,d=a.rect.z/n,a=a.rect.w/n,this._outerScale.set(Math.max(e,this._innerOffset.x*d),Math.max(f,this._innerOffset.y*a)),n=a,this._outerScale.x/=d,this._outerScale.y/=a,d*=pc.math.clamp(e/(this._innerOffset.x*d),1E-4,1),n*=pc.math.clamp(f/(this._innerOffset.y*a),1E-4,1),
this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),
this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(d,n,1),this._renderable.node.setLocalPosition((.5-b.pivot.x)*e,(.5-b.pivot.y)*f,0));this._meshDirty=!1},_updateSprite:function(){var a=!1,b=null;this._sprite&&this._sprite.atlas&&(b=this._sprite.meshes[this.spriteFrame],a=this._sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED||
this._sprite.renderMode===pc.SPRITE_RENDERMODE_TILED);if(this.mesh=a?b:this._defaultMesh)this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._renderable.node.getWorldTransform());return a},_toggleMask:function(){this._element._dirtifyMask();var a=this._element._isScreenSpace();this._updateMaterial(a);this._renderable.setMask(!!this._mask)},
_onMaterialLoad:function(a){this.material=a.resource},_onMaterialAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onMaterialAdded,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_bindMaterialAsset:function(a){this._entity.enabled&&(a.on("load",this._onMaterialLoad,this),a.on("change",this._onMaterialChange,this),a.on("remove",this._onMaterialRemove,this),a.resource?this._onMaterialLoad(a):this._system.app.assets.load(a))},_unbindMaterialAsset:function(a){a.off("load",
this._onMaterialLoad,this);a.off("change",this._onMaterialChange,this);a.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onTextureAdded,this);this._textureAsset===a.id&&this._bindTextureAsset(a)},_bindTextureAsset:function(a){this._entity.enabled&&(a.on("load",this._onTextureLoad,this),a.on("change",this._onTextureChange,this),a.on("remove",this._onTextureRemove,this),
a.resource?this._onTextureLoad(a):this._system.app.assets.load(a))},_unbindTextureAsset:function(a){a.off("load",this._onTextureLoad,this);a.off("change",this._onTextureChange,this);a.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(a){this.texture=a.resource},_onTextureChange:function(a){},_onTextureRemove:function(a){},_onSpriteAssetAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){this._entity.enabled&&
(a.on("load",this._onSpriteAssetLoad,this),a.on("change",this._onSpriteAssetChange,this),a.on("remove",this._onSpriteAssetRemove,this),a.resource?this._onSpriteAssetLoad(a):this._system.app.assets.load(a))},_unbindSpriteAsset:function(a){a.off("load",this._onSpriteAssetLoad,this);a.off("change",this._onSpriteAssetChange,this);a.off("remove",this._onSpriteAssetRemove,this);a.data.textureAtlasAsset&&this._system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(a){if(a&&
a.resource)if(a.resource.atlas)this.sprite=a.resource;else{if(a=a.data.textureAtlasAsset){var b=this._system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(a){this._onSpriteAssetLoad(a)},_onSpriteAssetRemove:function(a){},_bindSprite:function(a){a.on("set:meshes",this._onSpriteMeshesChange,this);a.on("set:pixelsPerUnit",this._onSpritePpuChange,this);a.on("set:atlas",this._onAtlasTextureChange,
this);if(a.atlas)a.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(a){a.off("set:meshes",this._onSpriteMeshesChange,this);a.off("set:pixelsPerUnit",this._onSpritePpuChange,this);a.off("set:atlas",this._onAtlasTextureChange,this);a.atlas&&a.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&(this._spriteFrame=pc.math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()},_onSpritePpuChange:function(){this.sprite.renderMode!==
pc.SPRITE_RENDERMODE_SIMPLE&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof
pc.Asset?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._system.app.assets.get(a))},onEnable:function(){var a;this._materialAsset&&(a=this._system.app.assets.get(this._materialAsset))&&a.resource!==this._material&&this._bindMaterialAsset(a);this._textureAsset&&(a=this._system.app.assets.get(this._textureAsset))&&a.resource!==this._texture&&this._bindTextureAsset(a);this._spriteAsset&&(a=this._system.app.assets.get(this._spriteAsset))&&a.resource!==this._sprite&&this._bindSpriteAsset(a);this._element.addModelToLayers(this._renderable.model)},
onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(a){this._renderable.meshInstance.stencilFront=a;this._renderable.meshInstance.stencilBack=a;a=0;this._element.maskedBy&&(a=this._element.maskedBy.element._image._maskRef);this._renderable.unmaskMeshInstance&&(a=new pc.StencilParameters({ref:a+1,func:pc.FUNC_EQUAL,zpass:pc.STENCILOP_DECREMENT}),this._renderable.unmaskMeshInstance.stencilFront=a,this._renderable.unmaskMeshInstance.stencilBack=a)}});
Object.defineProperty(b.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,e=a.g;a=a.b;if(this._color.r!==b||this._color.g!==e||this._color.b!==a)this._color.r=b,this._color.g=e,this._color.b=a,this._colorUniform[0]=b,this._colorUniform[1]=e,this._colorUniform[2]=a,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color)}});Object.defineProperty(b.prototype,"opacity",{get:function(){return this._color.a},
set:function(a){a!==this._color.a&&(this._color.a=a,this._renderable.setParameter("material_opacity",a),this._element&&this._element.fire("set:opacity",a))}});Object.defineProperty(b.prototype,"rect",{get:function(){return this._rect},set:function(a){if(a instanceof pc.Vec4){var b=a.x;var e=a.y;var f=a.z;a=a.w}else b=a[0],e=a[1],f=a[2],a=a[3];if(b!==this._rect.x||e!==this._rect.y||f!==this._rect.z||a!==this._rect.w)this._rect.set(b,e,f,a),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=
!0:this._updateMesh(this._renderable.mesh))}});Object.defineProperty(b.prototype,"material",{get:function(){return this._material},set:function(a){this._material!==a&&(a||(a=this._element._isScreenSpace(),a=this.mask?a?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:a?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=a)&&(this._renderable.setMaterial(a),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),
this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}});Object.defineProperty(b.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=this._system.app.assets,e=a;a instanceof pc.Asset&&(e=a.id);this._materialAsset!==
e&&(this._materialAsset&&(b.off("add:"+this._materialAsset,this._onMaterialAdded,this),a=b.get(this._materialAsset))&&(a.off("load",this._onMaterialLoad,this),a.off("change",this._onMaterialChange,this),a.off("remove",this._onMaterialRemove,this)),(this._materialAsset=e)?(e=b.get(this._materialAsset))?this._bindMaterialAsset(e):(this.material=null,b.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}});Object.defineProperty(b.prototype,"texture",{get:function(){return this._texture},
set:function(a){if(this._texture!==a){if(this._textureAsset){var b=this._system.app.assets.get(this._textureAsset);b&&b.resource!==a&&(this.textureAsset=null)}(this._texture=a)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",
this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}});Object.defineProperty(b.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(a){var b=this._system.app.assets,e=a;a instanceof pc.Asset&&(e=a.id);this._textureAsset!==e&&(this._textureAsset&&(b.off("add:"+this._textureAsset,this._onTextureAdded,this),a=b.get(this._textureAsset))&&
(a.off("load",this._onTextureLoad,this),a.off("change",this._onTextureChange,this),a.off("remove",this._onTextureRemove,this)),(this._textureAsset=e)?(e=b.get(this._textureAsset))?this._bindTextureAsset(e):(this.texture=null,b.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}});Object.defineProperty(b.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._system.app.assets,e=a;a instanceof pc.Asset&&(e=a.id);this._spriteAsset!==e&&
(this._spriteAsset&&(b.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(a=b.get(this._spriteAsset))&&this._unbindSpriteAsset(a)),(this._spriteAsset=e)?(a=b.get(this._spriteAsset))?this._bindSpriteAsset(a):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",e))}});Object.defineProperty(b.prototype,"sprite",{get:function(){return this._sprite},set:function(a){if(this._sprite!==a){this._sprite&&
this._unbindSprite(this._sprite);if(this._spriteAsset){var b=this._system.app.assets.get(this._spriteAsset);b&&b.resource!==a&&(this.spriteAsset=null)}if(this._sprite=a)this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null);this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),
this._renderable.deleteParameter("texture_opacityMap"));this._sprite&&(this._spriteFrame=pc.math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()}}});Object.defineProperty(b.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(a){var b=this._spriteFrame;this._spriteFrame=this._sprite?pc.math.clamp(a,0,this._sprite.frameKeys.length-1):a;this._spriteFrame!==b&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",a))}});Object.defineProperty(b.prototype,
"mesh",{get:function(){return this._renderable.mesh},set:function(a){this._renderable.setMesh(a);this._defaultMesh===a?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}});Object.defineProperty(b.prototype,"mask",{get:function(){return this._mask},set:function(a){this._mask!==a&&(this._mask=a,this._toggleMask())}});Object.defineProperty(b.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=
a,!this._sprite||this._sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this._sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED||this._updateSprite())}});Object.defineProperty(b.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}});return{ImageElement:b}}());Object.assign(pc,function(){var d=function(){this.quad=this.count=0;this.lines={};this.positions=[];this.normals=[];this.uvs=[];this.colors=[];this.indices=[];this.meshInstance=null},b=function(a){this._element=a;this._system=a.system;this._entity=a.entity;this._text="";this._symbols=[];this._colorPalette=[];this._i18nKey=this._symbolColors=null;this._fontAsset=new pc.LocalizedAsset(this._system.app);this._fontAsset.disableLocalization=!0;this._fontAsset.on("load",this._onFontLoad,this);this._fontAsset.on("change",
this._onFontChange,this);this._fontAsset.on("remove",this._onFontRemove,this);this._font=null;this._color=new pc.Color(1,1,1,1);this._colorUniform=new Float32Array(3);this._spacing=1;this._fontSize=32;this._fontMaxY=this._fontMinY=0;this._maxFontSize=this._originalFontSize=32;this._minFontSize=8;this._autoFitHeight=this._autoFitWidth=!1;this._maxLines=-1;this._scaledLineHeight=this._lineHeight=32;this._wrapLines=!1;this._drawOrder=0;this._alignment=new pc.Vec2(.5,.5);this._autoHeight=this._autoWidth=
!0;this.height=this.width=0;this._node=new pc.GraphNode;this._model=new pc.Model;this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=null;this._aabbDirty=!0;this._aabb=new pc.BoundingBox;this._noResize=!1;this._maskedMaterialSrc=this._currentMaterialType=null;this._rtl=this._unicodeConverter=this._rtlReorder=!1;this._outlineColor=new pc.Color(0,0,0,1);this._outlineColorUniform=new Float32Array(4);this._outlineThicknessScale=.2;this._outlineThickness=0;this._shadowColor=
new pc.Color(0,0,0,1);this._shadowColorUniform=new Float32Array(4);this._shadowOffsetScale=.005;this._shadowOffset=new pc.Vec2(0,0);this._shadowOffsetUniform=new Float32Array(2);this._enableMarkup=!1;this._onScreenChange(this._element.screen);a.on("resize",this._onParentResize,this);a.on("set:screen",this._onScreenChange,this);a.on("screen:set:screenspace",this._onScreenSpaceChange,this);a.on("set:draworder",this._onDrawOrderChange,this);a.on("set:pivot",this._onPivotChange,this);this._system.app.i18n.on("set:locale",
this._onLocaleSet,this);this._system.app.i18n.on("data:add",this._onLocalizationData,this);this._system.app.i18n.on("data:remove",this._onLocalizationData,this);this._rangeEnd=this._rangeStart=0},a=/^[\r\n]$/,c=/^[ \t]$/,e=/^[ \t\-]$/;Object.assign(b.prototype,{destroy:function(){this._setMaterial(null);this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null);this._fontAsset.destroy();this.font=null;this._element.off("resize",this._onParentResize,this);
this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this);this._system.app.i18n.off("set:locale",this._onLocaleSet,this);this._system.app.i18n.off("data:add",this._onLocalizationData,this);this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(a,b){this._noResize||
this._font&&this._updateText()},_onScreenChange:function(a){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},_onDrawOrderChange:function(a){this._drawOrder=a;if(this._model){var b;var c=0;for(b=this._model.meshInstances.length;c<b;c++)this._model.meshInstances[c].drawOrder=a}},_onPivotChange:function(a){this._font&&this._updateText()},_onLocaleSet:function(a){this._i18nKey&&(this.fontAsset&&(a=this._system.app.assets.get(this.fontAsset),
a&&a.resource&&a.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(a,b){this._i18nKey&&b[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(a){if(this.unicodeConverter){var b=this._system.getUnicodeConverter();b?a=b(a):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==a&&(this._font&&
this._updateText(a),this._text=a)},_updateText:function(a){var b;void 0===a&&(a=this._text);this._symbols=pc.string.getSymbols(a);0===this._symbols.length&&(this._symbols=[" "]);if(this._enableMarkup){a=pc.Markup.evaluate(this._symbols);this._symbols=a.symbols;var c=a.tags}this._rtlReorder?(a=this._system.app.systems.element.getRtlReorder())?(a=a(this._symbols),this._rtl=a.rtl,this._symbols=a.mapping.map(function(a){return this._symbols[a]},this),c&&(c=a.mapping.map(function(a){return c[a]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):
this._rtl=!1;if(c){var e={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)];this._symbolColors=[];a=e[this._color.toString(!1).toLowerCase()]=0;for(b=this._symbols.length;a<b;++a){var f=c[a],d=0;f&&f.color&&f.color.value&&(f=f.color.value,7===f.length&&"#"===f[0]&&(f=f.substring(1).toLowerCase(),e.hasOwnProperty(f)?d=e[f]:/^([0-9a-f]{2}){3}$/.test(f)&&(d=this._colorPalette.length/3,e[f]=d,this._colorPalette.push(parseInt(f.substring(0,
2),16)),this._colorPalette.push(parseInt(f.substring(2,4),16)),this._colorPalette.push(parseInt(f.substring(4,6),16)))));this._symbolColors.push(d)}}else this._colorPalette=[],this._symbolColors=null;e=this._calculateCharsPerTexture();d=!1;var l=this._element;f=l._isScreenSpace();var p=l._isScreenCulled(),q=function(a){return l.isVisibleForCamera(a)};a=0;for(b=this._meshInfo.length;a<b;a++){var r=e[a]||0,t=this._meshInfo[a];if(t.count!==r)if(d||(l.removeModelFromLayers(this._model),d=!0),t.count=
r,t.positions.length=t.normals.length=12*r,t.indices.length=6*r,t.uvs.length=8*r,t.colors.length=16*r,t.meshInstance&&(this._removeMeshInstance(t.meshInstance),t.meshInstance.material=null),0===r)t.meshInstance=null;else{for(var u=0;u<r;u++)t.indices[6*u]=4*u,t.indices[6*u+1]=4*u+1,t.indices[6*u+2]=4*u+3,t.indices[6*u+3]=4*u+2,t.indices[6*u+4]=4*u+3,t.indices[6*u+5]=4*u+1,t.normals[12*u]=0,t.normals[12*u+1]=0,t.normals[12*u+2]=-1,t.normals[12*u+3]=0,t.normals[12*u+4]=0,t.normals[12*u+5]=-1,t.normals[12*
u+6]=0,t.normals[12*u+7]=0,t.normals[12*u+8]=-1,t.normals[12*u+9]=0,t.normals[12*u+10]=0,t.normals[12*u+11]=-1;r=pc.createMesh(this._system.app.graphicsDevice,t.positions,{uvs:t.uvs,normals:t.normals,colors:t.colors,indices:t.indices});r=new pc.MeshInstance(this._node,r,this._material);r.name="Text Element: "+this._entity.name;r.castShadow=!1;r.receiveShadow=!1;r.cull=!f;r.screenSpace=f;r.drawOrder=this._drawOrder;p&&(r.cull=!0,r.isVisibleFunc=q);this._setTextureParams(r,this._font.textures[a]);this._symbolColors?
(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b);r.setParameter("material_emissive",this._colorUniform);r.setParameter("material_opacity",this._color.a);r.setParameter("font_sdfIntensity",this._font.intensity);r.setParameter("font_pxrange",this._getPxRange(this._font));r.setParameter("font_textureWidth",this._font.data.info.maps[a].width);this._outlineColorUniform[0]=
this._outlineColor.r;this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;r.setParameter("outline_color",this._outlineColorUniform);r.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;
r.setParameter("shadow_color",this._shadowColorUniform);u=this._font.data.info.maps[a].width/this._font.data.info.maps[a].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=u*this._shadowOffsetScale*this._shadowOffset.y;r.setParameter("shadow_offset",this._shadowOffsetUniform);t.meshInstance=r;this._model.meshInstances.push(r)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy);d&&this._element.enabled&&this._entity.enabled&&
this._element.addModelToLayers(this._model);this._updateMeshes();this._rangeStart=0;this._rangeEnd=this._symbols.length;this._updateRenderRange()},_removeMeshInstance:function(a){var b,c=a.mesh;if(c&&(c.vertexBuffer&&c.vertexBuffer.destroy(),c.indexBuffer)){var e=0;for(b=c.indexBuffer.length;e<b;e++)c.indexBuffer[e].destroy()}a=this._model.meshInstances.indexOf(a);-1!==a&&this._model.meshInstances.splice(a,1)},_setMaterial:function(a){var b;this._material=a;if(this._model){var c=0;for(b=this._model.meshInstances.length;c<
b;c++)this._model.meshInstances[c].material=a}},_updateMaterial:function(a){var b=this._element,c=b._isScreenCulled(),e=function(a){return b.isVisibleForCamera(a)};this._material=this._system.getTextElementMaterial(a,this._font&&this._font.type===pc.FONT_MSDF);if(this._model)for(var f=0,d=this._model.meshInstances.length;f<d;f++){var l=this._model.meshInstances[f];l.cull=!a;l.material=this._material;l.screenSpace=a;c?(l.cull=!0,l.isVisibleFunc=e):l.isVisibleFunc=null}},_updateMeshes:function(){function b(b,
c,e){n._lineWidths.push(Math.abs(e));b=b.slice(y>c?c+1:y,y>c?y+1:c);if(E)for(e=b.length;e--&&0<E;)a.test(b[e])&&(b.splice(e,1),E--);n._lineContents.push(b.join(""));p=0;q-=n._scaledLineHeight;u++;x=E=z=A=0;y=c}var d=this._font.data,n=this,k=Math.min(this._minFontSize,this._maxFontSize),h=this._maxFontSize,m=this._shouldAutoFit();m&&(this._fontSize=this._maxFontSize);var l=this._symbols.length,p=0,q=0,r=0,t=0,u=1,x=0,v=0,y=0,A=0,z=0,E=0,C=1E-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),
D=this._element.calculatedWidth;if(this.autoWidth&&!C||!this._wrapLines)D=Number.POSITIVE_INFINITY;var F=0;C=0;for(var I=1,G,B,w,H=!0;H;){H=!1;this._scaledLineHeight=m?this._lineHeight*this._fontSize/(this._maxFontSize||1E-4):this._lineHeight;this.height=this.width=0;this._lineWidths=[];this._lineContents=[];t=r=q=p=0;u=1;E=z=A=y=v=x=0;I=this._fontSize/32;F=this._fontMinY*I;C=this._fontMaxY*I;for(w=0;w<this._meshInfo.length;w++)this._meshInfo[w].quad=0,this._meshInfo[w].lines={};var M=255,aa=255,
R=255;for(w=0;w<l;w++){G=this._symbols[w];var T=0,ea=0,J=0,Z=1;B=d.chars[G];if(!B)if(d.chars[" "])B=d.chars[" "];else for(var N in d.chars){B=d.chars[N];break}if(B){var S=0;0<z&&(J=this._font.data.kerning)&&(J=J[pc.string.getCodePoint(this._symbols[w-1])||0])&&(S=J[pc.string.getCodePoint(this._symbols[w])||0]||0);J=B.scale||1;var P=(B.width+B.height)/2;Z=I*P/J;J=(B.xadvance+S)*I;T=(B.xoffset-S)*I;ea=B.yoffset*I}else console.error("Couldn't substitute missing character: '"+G+"'");if(P=a.test(G)){if(E++,
0>this._maxLines||u<this._maxLines)b(this._symbols,w,t),v=w+1,y=w+1}else{var Y=c.test(G);S=this._meshInfo[B&&B.map||0];var U=p+this._spacing*J;if(U>D&&0<z&&!Y&&(0>this._maxLines||u<this._maxLines))if(0===A)v=w,b(this._symbols,w,t);else{B=Math.max(w-v,0);if(1>=this._meshInfo.length)S.lines[u-1]-=B,S.quad-=B;else for(S=w,G=v;G<S;G++)J=d.chars[this._symbols[G]],J=this._meshInfo[J&&J.map||0],--J.lines[u-1],--J.quad;w-=B+1;b(this._symbols,v,x);continue}B=S.quad;S.lines[u-1]=B;var K=p-T,V=K+Z;ea=q-ea;var L=
ea+Z;this._rtl&&(Z=Z-T-this._spacing*J-T,K-=Z,V-=Z);S.positions[12*B]=K;S.positions[12*B+1]=ea;S.positions[12*B+2]=r;S.positions[12*B+3]=V;S.positions[12*B+4]=ea;S.positions[12*B+5]=r;S.positions[12*B+6]=V;S.positions[12*B+7]=L;S.positions[12*B+8]=r;S.positions[12*B+9]=K;S.positions[12*B+10]=L;S.positions[12*B+11]=r;this.width=Math.max(this.width,U);if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Z=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||
1E-4)),Z=pc.math.clamp(Z,k,h),Z!==this._element.fontSize)){this._fontSize=Z;H=!0;break}this.height=Math.max(this.height,C-(q+F));if(this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Z=pc.math.clamp(this._fontSize-1,k,h),Z!==this._element.fontSize)){this._fontSize=Z;H=!0;break}p+=this._spacing*J;Y||P||(t=p);e.test(G)&&(A++,x=t,v=w+1);z++;G=this._getUv(G);S.uvs[8*B]=G[0];S.uvs[8*B+1]=G[1];S.uvs[8*B+2]=G[2];S.uvs[8*B+3]=G[1];S.uvs[8*B+4]=G[2];S.uvs[8*B+5]=G[3];S.uvs[8*B+6]=G[0];
S.uvs[8*B+7]=G[3];this._symbolColors&&(R=3*this._symbolColors[w],M=this._colorPalette[R],aa=this._colorPalette[R+1],R=this._colorPalette[R+2]);S.colors[16*B]=M;S.colors[16*B+1]=aa;S.colors[16*B+2]=R;S.colors[16*B+3]=255;S.colors[16*B+4]=M;S.colors[16*B+5]=aa;S.colors[16*B+6]=R;S.colors[16*B+7]=255;S.colors[16*B+8]=M;S.colors[16*B+9]=aa;S.colors[16*B+10]=R;S.colors[16*B+11]=255;S.colors[16*B+12]=M;S.colors[16*B+13]=aa;S.colors[16*B+14]=R;S.colors[16*B+15]=255;S.quad++}}H||y<l&&b(this._symbols,l,p)}this._noResize=
!0;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=!1;d=this._element.pivot.x;k=this._element.pivot.y;h=this._alignment.x;m=this._alignment.y;for(w=0;w<this._meshInfo.length;w++)if(0!==this._meshInfo[w].count){N=0;for(var Q in this._meshInfo[w].lines){l=this._meshInfo[w].lines[Q];D=this._lineWidths[parseInt(Q,10)];D=-d*this._element.calculatedWidth+h*(this._element.calculatedWidth-D)*(this._rtl?-1:1);r=(1-k)*this._element.calculatedHeight-C-(1-m)*(this._element.calculatedHeight-
this.height);for(B=N;B<=l;B++)this._meshInfo[w].positions[12*B]+=D,this._meshInfo[w].positions[12*B+3]+=D,this._meshInfo[w].positions[12*B+6]+=D,this._meshInfo[w].positions[12*B+9]+=D,this._meshInfo[w].positions[12*B+1]+=r,this._meshInfo[w].positions[12*B+4]+=r,this._meshInfo[w].positions[12*B+7]+=r,this._meshInfo[w].positions[12*B+10]+=r;if(this._rtl)for(B=N;B<=l;B++){N=12*B;for(r=0;4>r;++r)this._meshInfo[w].positions[N+3*r]=this._element.calculatedWidth-this._meshInfo[w].positions[N+3*r]+2*D;r=
this._meshInfo[w].positions[N+3];t=this._meshInfo[w].positions[N+6];this._meshInfo[w].positions[N+3]=this._meshInfo[w].positions[N+0];this._meshInfo[w].positions[N+6]=this._meshInfo[w].positions[N+9];this._meshInfo[w].positions[N+0]=r;this._meshInfo[w].positions[N+9]=t}N=l+1}l=4*this._meshInfo[w].count;D=4*this._meshInfo[w].quad;B=new pc.VertexIterator(this._meshInfo[w].meshInstance.mesh.vertexBuffer);for(N=0;N<l;N++)N>=D?(B.element[pc.SEMANTIC_POSITION].set(0,0,0),B.element[pc.SEMANTIC_TEXCOORD0].set(0,
0),B.element[pc.SEMANTIC_COLOR].set(0,0,0,0)):(B.element[pc.SEMANTIC_POSITION].set(this._meshInfo[w].positions[3*N],this._meshInfo[w].positions[3*N+1],this._meshInfo[w].positions[3*N+2]),B.element[pc.SEMANTIC_TEXCOORD0].set(this._meshInfo[w].uvs[2*N],this._meshInfo[w].uvs[2*N+1]),B.element[pc.SEMANTIC_COLOR].set(this._meshInfo[w].colors[4*N],this._meshInfo[w].colors[4*N+1],this._meshInfo[w].colors[4*N+2],this._meshInfo[w].colors[4*N+3])),B.next();B.end();this._meshInfo[w].meshInstance.mesh.aabb.compute(this._meshInfo[w].positions);
this._meshInfo[w].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(a){this.font!==a.resource&&(this.font=a.resource)},_onFontChange:function(a,b,c,e){if("data"===b)for(this._font.data=c,a=this._font.data.info.maps.length,b=0;b<a;b++)this._meshInfo[b]&&(c=this._meshInfo[b].meshInstance)&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",
this._font.data.info.maps[b].width))},_onFontRemove:function(a){},_setTextureParams:function(a,b){this._font&&(this._font.type===pc.FONT_MSDF?(a.deleteParameter("texture_emissiveMap"),a.deleteParameter("texture_opacityMap"),a.setParameter("texture_msdfMap",b)):this._font.type===pc.FONT_BITMAP&&(a.deleteParameter("texture_msdfMap"),a.setParameter("texture_emissiveMap",b),a.setParameter("texture_opacityMap",b)))},_getPxRange:function(a){a=Object.keys(this._font.data.chars);for(var b=0;b<a.length;b++){var c=
this._font.data.chars[a[b]];if(c.range)return(c.scale||1)*c.range}return 2},_getUv:function(a){var b=this._font.data;if(!b.chars[a])return b.chars[" "]?this._getUv(" "):[0,0,0,0];var c=b.chars[a].map,e=b.info.maps[c].width;c=b.info.maps[c].height;var f=b.chars[a].x,d=b.chars[a].y,l=1-b.chars[a].height/c;return[f/e,l-d/c,(f+b.chars[a].width)/e,l-(d-b.chars[a].height)/c]},onEnable:function(){this._fontAsset.autoLoad=!0;this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=
!1;this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(a){if(this._model)for(var b=this._model.meshInstances,c=0;c<b.length;c++)b[c].stencilFront=a,b[c].stencilBack=a},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(a){var b=
{};void 0===a&&(a=this._symbols.length);var c;for(c=0;c<a;c++){var e=this._symbols[c];e=this._font.data.chars[e];e||(e=this._font.data.chars[" "])||(e=this._font.data.chars[Object.keys(this._font.data.chars)[0]]);e=e.map;b[e]?b[e]++:b[e]=1}return b},_updateRenderRange:function(){var a=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),b=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),c;var e=0;for(c=this._meshInfo.length;e<c;e++){var d=a[e]||0,m=b[e]||0,l=
this._meshInfo[e].meshInstance;l&&(l=l.mesh)&&(l.primitive[0].base=6*d,l.primitive[0].count=6*(m-d))}}});Object.defineProperty(b.prototype,"text",{get:function(){return this._text},set:function(a){this._i18nKey=null;this._setText(a&&a.toString()||"")}});Object.defineProperty(b.prototype,"key",{get:function(){return this._i18nKey},set:function(a){a=null!==a?a.toString():null;this._i18nKey!==a&&((this._i18nKey=a)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=
!0)}});Object.defineProperty(b.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,c=a.g;a=a.b;if(this._color.r!==b||this._color.g!==c||this._color.b!==a)if(this._color.r=b,this._color.g=c,this._color.b=a,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("material_emissive",
this._colorUniform)}});Object.defineProperty(b.prototype,"opacity",{get:function(){return this._color.a},set:function(a){if(this._color.a!==a&&(this._color.a=a,this._model))for(var b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("material_opacity",a)}});Object.defineProperty(b.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(a){var b=this._lineHeight;this._scaledLineHeight=this._lineHeight=a;b!==a&&this._font&&this._updateText()}});
Object.defineProperty(b.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(a){var b=this._wrapLines;this._wrapLines=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(b.prototype,"lines",{get:function(){return this._lineContents}});Object.defineProperty(b.prototype,"spacing",{get:function(){return this._spacing},set:function(a){var b=this._spacing;this._spacing=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(b.prototype,"fontSize",{get:function(){return this._fontSize},
set:function(a){var b=this._fontSize;this._originalFontSize=this._fontSize=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(b.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},set:function(a){this._fontAsset.defaultAsset=a}});Object.defineProperty(b.prototype,"font",{get:function(){return this._font},set:function(a){if(this._font){var b=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}this._font=a;this._fontMaxY=this._fontMinY=
0;if(a){var c=this._font.data,e;for(e in c.chars){var f=c.chars[e];f.bounds&&(this._fontMinY=Math.min(this._fontMinY,f.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,f.bounds[3]))}if(this._font.on)this._font.on("render",this._onFontRender,this);this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null);a.type!==b&&(a=this._element._isScreenSpace(),this._updateMaterial(a));a=0;for(b=this._font.textures.length;a<
b;a++)if(this._meshInfo[a]){if(c=this._meshInfo[a].meshInstance)c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[a].width),this._setTextureParams(c,this._font.textures[a])}else this._meshInfo[a]=new d;b=!1;for(a=this._font.textures.length;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(b||(this._element.removeModelFromLayers(this._model),b=!0),this._removeMeshInstance(this._meshInfo[a].meshInstance));
this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length);this._updateText()}}});Object.defineProperty(b.prototype,"alignment",{get:function(){return this._alignment},set:function(a){a instanceof pc.Vec2?this._alignment.set(a.x,a.y):this._alignment.set(a[0],a[1]);this._font&&this._updateText()}});Object.defineProperty(b.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(a){var b=this._autoWidth;(this._autoWidth=a)&&1E-4>Math.abs(this._element.anchor.x-
this._element.anchor.z)&&(this._element.width=this.width);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,a!==this._fontSize&&(this._fontSize=a,this._font&&this._updateText()))}});Object.defineProperty(b.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(a){var b=this._autoHeight;(this._autoHeight=a)&&1E-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:
this._originalFontSize,a!==this._fontSize&&(this._fontSize=a,this._font&&this._updateText()))}});Object.defineProperty(b.prototype,"rtlReorder",{get:function(){return this._rtlReorder},set:function(a){this._rtlReorder!==a&&(this._rtlReorder=a,this._font&&this._updateText())}});Object.defineProperty(b.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(a){this._unicodeConverter!==a&&(this._unicodeConverter=a,this._setText(this._text))}});Object.defineProperty(b.prototype,
"aabb",{get:function(){if(this._aabbDirty){for(var a=!1,b=0;b<this._meshInfo.length;b++)this._meshInfo[b].meshInstance&&(a?this._aabb.add(this._meshInfo[b].meshInstance.aabb):(this._aabb.copy(this._meshInfo[b].meshInstance.aabb),a=!0));this._aabbDirty=!1}return this._aabb}});Object.defineProperty(b.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(a){var b=a instanceof pc.Color?a.r:a[0],c=a instanceof pc.Color?a.g:a[1],e=a instanceof pc.Color?a.b:a[2];a=a instanceof
pc.Color?a.a:a[3];if(this._outlineColor.r!==b||this._outlineColor.g!==c||this._outlineColor.b!==e||this._outlineColor.a!==a)if(this._outlineColor.r=b,this._outlineColor.g=c,this._outlineColor.b=e,this._outlineColor.a=a,this._model)for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("outline_color",
this._outlineColorUniform)}});Object.defineProperty(b.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(a){var b=this._outlineThickness;this._outlineThickness=a;if(b!==a&&this._font&&this._model)for(a=0,b=this._model.meshInstances.length;a<b;a++)this._model.meshInstances[a].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}});Object.defineProperty(b.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(a){var b=
a instanceof pc.Color?a.r:a[0],c=a instanceof pc.Color?a.g:a[1],e=a instanceof pc.Color?a.b:a[2];a=a instanceof pc.Color?a.a:a[3];if(this._shadowColor.r!==b||this._shadowColor.g!==c||this._shadowColor.b!==e||this._shadowColor.a!==a)if(this._shadowColor.r=b,this._shadowColor.g=c,this._shadowColor.b=e,this._shadowColor.a=a,this._model)for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=
this._shadowColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("shadow_color",this._shadowColorUniform)}});Object.defineProperty(b.prototype,"shadowOffset",{get:function(){return this._shadowOffset},set:function(a){var b=a instanceof pc.Vec2?a.x:a[0];a=a instanceof pc.Vec2?a.y:a[1];if(this._shadowOffset.x!==b||this._shadowOffset.y!==a)if(this._shadowOffset.set(b,a),this._font&&this._model)for(b=0,a=this._model.meshInstances.length;b<a;b++){var c=this._font.data.info.maps[b].width/
this._font.data.info.maps[b].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[b].setParameter("shadow_offset",this._shadowOffsetUniform)}}});Object.defineProperty(b.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(a){this._minFontSize!==a&&(this._minFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(b.prototype,
"maxFontSize",{get:function(){return this._maxFontSize},set:function(a){this._maxFontSize!==a&&(this._maxFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(b.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},set:function(a){this._autoFitWidth!==a&&(this._autoFitWidth=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(b.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},
set:function(a){this._autoFitHeight!==a&&(this._autoFitHeight=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(b.prototype,"maxLines",{get:function(){return this._maxLines},set:function(a){this._maxLines===a||null===a&&-1===this._maxLines||(this._maxLines=null===a?-1:a,this.font&&this._wrapLines&&this._updateText())}});Object.defineProperty(b.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(a){a=
!!a;this._enableMarkup!==a&&(this._enableMarkup=a,this.font&&this._updateText())}});Object.defineProperty(b.prototype,"symbols",{get:function(){return this._symbols}});Object.defineProperty(b.prototype,"symbolColors",{get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(a){return this._colorPalette.slice(3*a,3*a+3)},this)}});Object.defineProperty(b.prototype,"rtl",{get:function(){return this._rtl}});Object.defineProperty(b.prototype,"rangeStart",{get:function(){return this._rangeStart},
set:function(a){a=Math.max(0,Math.min(a,this._symbols.length));a!==this._rangeStart&&(this._rangeStart=a,this._updateRenderRange())}});Object.defineProperty(b.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(a){a=Math.max(this._rangeStart,Math.min(a,this._symbols.length));a!==this._rangeEnd&&(this._rangeEnd=a,this._updateRenderRange())}});return{TextElement:b}}());Object.assign(pc,function(){function d(a,b){for(var c in b)if(b.hasOwnProperty(c)){var e=b[c];e instanceof Object?(a.hasOwnProperty(c)||(a[c]={}),d(a[c],b[c])):a[c]=e}}function b(a){if(0===a.length)return null;for(var b={},c=0;c<a.length;++c){var e=a[c],f={};f[e.name]={value:e.value,attributes:e.attributes};d(b,f)}return b}function a(a,c){function e(a){n=n.filter(function(b){return void 0===a.find(function(a){return a===b})})}function d(a){for(var b=0;b<a.length;++b)n.push(a[b])}var f;if(0===a.length)return null;
var g={};for(f=0;f<a.length;++f){var k=a[f];g.hasOwnProperty(k.start)?null===g[k.start].open?g[k.start].open=[k]:g[k.start].open.push(k):g[k.start]={open:[k],close:null};g.hasOwnProperty(k.end)?null===g[k.end].close?g[k.end].close=[k]:g[k.end].close.push(k):g[k.end]={open:null,close:[k]}}var n=[];k=Object.keys(g).sort(function(a,b){return a-b});a=[];for(f=0;f<k.length;++f){var t=g[k[f]];null!==t.close&&e(t.close);null!==t.open&&d(t.open);a.push({start:k[f],tags:b(n)})}g=[];k=null;for(f=0;f<a.length;++f){for(t=
a[f];g.length<t.start;)g.push(k?k.tags:null);k=t}for(;g.length<c;)g.push(null);return g}function c(b){var c=new f(b),e=[],d=[];if(!c.parse(e,d))return console.warn(c.error()),{symbols:b,tags:null};if(c=d.find(function(a){return null===a.end}))return console.warn("Markup error: found unclosed tag='"+c.name+"'"),{symbols:b,tags:null};b=a(d,e.length);return{symbols:e,tags:b}}var e=function(a){this._symbols=a;this._last=this._index=0;this._cur=0<this._symbols.length?this._symbols[0]:null;this._buf=[];
this._mode="text";this._error=null};Object.assign(e.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var a=this._read();a===this.WHITESPACE_TOKEN;)a=this._read();a!==this.EOF_TOKEN&&a!==this.ERROR_TOKEN&&(this._last=this._index);return a},buf:function(){return this._buf},last:function(){return this._last},
error:function(){return this._error},debugPrint:function(){for(var a="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),b=this.read(),c="";;){c+=(0<c.length?"\n":"")+a[b]+" '"+this.buf().join("")+"'";if(b===this.EOF_TOKEN||b===this.ERROR_TOKEN)break;b=this.read()}return c},_read:function(){this._buf=[];return this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?
this.TEXT_TOKEN:this.EOF_TOKEN;case "[":return this._mode="tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case "\\":this._next();switch(this._cur){case "[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case "[":return this._store(),this.OPEN_BRACKET_TOKEN;case "]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case "=":return this._store(),
this.EQUALS_TOKEN;case " ":case "\t":case "\n":case "\r":case "\v":case "\f":return this._whitespace();case '"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",
this.ERROR_TOKEN;case '"':return this._next(),this.STRING_TOKEN;default:this._store()}},_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(a){return 1===a.length&&null!==a.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null);return this._cur},_store:function(){this._buf.push(this._cur);
return this._next()},_output:function(a){this._buf.push(a)}});var f=function(a){this._scanner=new e(a);this._error=null};Object.assign(f.prototype,{parse:function(a,b){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(a,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(a,b))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+
this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},_parseTag:function(a,b){var c=this._scanner.read();if(c!==this._scanner.IDENTIFIER_TOKEN)return this._error="expected identifier",!1;c=this._scanner.buf().join("");if("/"===c[0]){for(var e=b.length-1;0<=e;--e)if(c==="/"+b[e].name&&null===b[e].end)return b[e].end=a.length,c=this._scanner.read(),c!==this._scanner.CLOSE_BRACKET_TOKEN?(this._error="expected close bracket",!1):!0;this._error="failed to find matching tag";return!1}a=
{name:c,value:null,attributes:{},start:a.length,end:null};c=this._scanner.read();if(c===this._scanner.EQUALS_TOKEN){c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;a.value=this._scanner.buf().join("");c=this._scanner.read()}for(;;){switch(c){case this._scanner.CLOSE_BRACKET_TOKEN:return b.push(a),!0;case this._scanner.IDENTIFIER_TOKEN:e=this._scanner.buf().join("");c=this._scanner.read();if(c!==this._scanner.EQUALS_TOKEN)return this._error="expected equals",
!1;c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;c=this._scanner.buf().join("");a.attributes[e]=c;break;default:return this._error="expected close bracket or identifier",!1}c=this._scanner.read()}}});var g=function(){};g.evaluate=function(a){return c(a)};return{Markup:g}}());Object.assign(pc,function(){var d=new pc.Vec2,b=new pc.Vec3,a=new pc.Vec3,c=new pc.Vec3,e=new pc.Vec3,f=new pc.Vec3,g=new pc.Quat,n={x:"y",y:"x"},k=function(a,b){pc.EventHandler.call(this);if(!(a&&a instanceof pc.ElementComponent))throw Error("Element was null or not an ElementComponent");if(b&&"x"!==b&&"y"!==b)throw Error("Unrecognized axis: "+b);this._element=a;this._app=a.system.app;this._axis=b||null;this._enabled=!0;this._dragScale=new pc.Vec3;this._dragStartMousePosition=new pc.Vec3;this._dragStartHandlePosition=
new pc.Vec3;this._deltaMousePosition=new pc.Vec3;this._deltaHandlePosition=new pc.Vec3;this._isDragging=!1;this._toggleLifecycleListeners("on")};k.prototype=Object.create(pc.EventHandler.prototype);k.prototype.constructor=k;Object.assign(k.prototype,{_toggleLifecycleListeners:function(a){this._element[a]("mousedown",this._onMouseDownOrTouchStart,this);this._element[a]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(a){var b="on"===a,c=b?"addEventListener":"removeEventListener";
this._hasDragListeners&&b||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[a]("mousemove",this._onMove,this),window[c]("mouseup",this._handleMouseUpOrTouchEnd,!1)),pc.platform.touch&&(this._app.touch[a]("touchmove",this._onMove,this),window[c]("touchend",this._handleMouseUpOrTouchEnd,!1),window[c]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=b)},_onMouseDownOrTouchStart:function(a){this._element&&
!this._isDragging&&this.enabled&&(this._dragCamera=a.camera,this._calculateDragScale(),a=this._screenToLocal(a))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(a),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(b){this._determineInputPosition(b);this._chooseRayOriginAndDirection();
e.copy(this._element.entity.getPosition());f.copy(this._element.entity.forward).scale(-1);b=f.dot(c);return 0<Math.abs(b)?(b=e.sub(a).dot(f)/b,b=a.add(c.scale(b)),g.copy(this._element.entity.getRotation()).invert().transformVector(b,b),b.mul(this._dragScale),b):null},_determineInputPosition:function(a){var b=this._app.graphicsDevice.maxPixelRatio;"undefined"!==typeof a.x&&"undefined"!==typeof a.y?(d.x=a.x*b,d.y=a.y*b):a.changedTouches?(d.x=a.changedTouches[0].x*b,d.y=a.changedTouches[0].y*b):console.warn("Could not determine position from input event")},
_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(a.set(d.x,-d.y,0),c.set(0,0,-1)):(b.copy(this._dragCamera.screenToWorld(d.x,d.y,1)),a.copy(this._dragCamera.entity.getPosition()),c.copy(b).sub(a).normalize())},_calculateDragScale:function(){var a=this._element.entity.parent,b=this._element.screen&&this._element.screen.screen,c=b&&b.screenSpace;b=c?b.scale:1;var e=this._dragScale;for(e.set(b,b,b);a&&(e.mul(a.getLocalScale()),a=a.parent,!c||!a.screen););
e.x=1/e.x;e.y=1/e.y;e.z=1/e.z},_onMove:function(a){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(a=this._screenToLocal(a),this._dragStartMousePosition&&a)){this._deltaMousePosition.copy(a).sub(this._dragStartMousePosition);this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition);if(this._axis){a=this._element.entity.getLocalPosition();var b=n[this._axis];this._deltaHandlePosition[b]=a[b]}this._element.entity.setLocalPosition(this._deltaHandlePosition);
this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off");this._toggleDragListeners("off")}});Object.defineProperty(k.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(k.prototype,"isDragging",{get:function(){return this._isDragging}});return{ElementDragHelper:k}}());Object.assign(pc,{BUTTON_TRANSITION_MODE_TINT:0,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:1});Object.assign(pc,function(){var d={DEFAULT:"_defaultTint",HOVER:"hoverTint",PRESSED:"pressedTint",INACTIVE:"inactiveTint"},b={DEFAULT:"_defaultSpriteAsset",HOVER:"hoverSpriteAsset",PRESSED:"pressedSpriteAsset",INACTIVE:"inactiveSpriteAsset"},a={DEFAULT:"_defaultSpriteFrame",HOVER:"hoverSpriteFrame",PRESSED:"pressedSpriteFrame",INACTIVE:"inactiveSpriteFrame"},c=function(a,b){pc.Component.call(this,a,b);this._visualState="DEFAULT";this._isHovering=!1;this._hoveringCounter=0;this._isPressed=!1;this._defaultTint=
new pc.Color(1,1,1,1);this._defaultSpriteAsset=null;this._defaultSpriteFrame=0;this._imageReference=new pc.EntityReference(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame});this._toggleLifecycleListeners("on",a)};c.prototype=Object.create(pc.Component.prototype);c.prototype.constructor=
c;Object.assign(c.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_active",this._onSetActive,this);this[a]("set_transitionMode",this._onSetTransitionMode,this);this[a]("set_hoverTint",this._onSetTransitionValue,this);this[a]("set_pressedTint",this._onSetTransitionValue,this);this[a]("set_inactiveTint",this._onSetTransitionValue,this);this[a]("set_hoverSpriteAsset",this._onSetTransitionValue,this);this[a]("set_hoverSpriteFrame",this._onSetTransitionValue,this);this[a]("set_pressedSpriteAsset",
this._onSetTransitionValue,this);this[a]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(a,b,c){b!==c&&this._updateVisualState()},_onSetTransitionMode:function(a,b,c){b!==c&&(this._cancelTween(),
this._resetToDefaultVisualState(b),this._forceReapplyVisualState())},_onSetTransitionValue:function(a,b,c){b!==c&&this._forceReapplyVisualState()},_onElementComponentRemove:function(a){this.entity===a&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(a){this.entity===a&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween();this._resetToDefaultVisualState(this.transitionMode)},_onImageElementGain:function(){this._storeDefaultVisualState();
this._forceReapplyVisualState()},_toggleHitElementListeners:function(a){if(this.entity.element){var b="on"===a;b&&this._hasHitElementListeners||(this.entity.element[a]("mouseenter",this._onMouseEnter,this),this.entity.element[a]("mouseleave",this._onMouseLeave,this),this.entity.element[a]("mousedown",this._onMouseDown,this),this.entity.element[a]("mouseup",this._onMouseUp,this),this.entity.element[a]("touchstart",this._onTouchStart,this),this.entity.element[a]("touchend",this._onTouchEnd,this),this.entity.element[a]("touchleave",
this._onTouchLeave,this),this.entity.element[a]("touchcancel",this._onTouchCancel,this),this.entity.element[a]("selectstart",this._onSelectStart,this),this.entity.element[a]("selectend",this._onSelectEnd,this),this.entity.element[a]("selectenter",this._onSelectEnter,this),this.entity.element[a]("selectleave",this._onSelectLeave,this),this.entity.element[a]("click",this._onClick,this),this._hasHitElementListeners=b)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&
(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(a){this._defaultTint.r=a.r;this._defaultTint.g=a.g;this._defaultTint.b=a.b},_storeDefaultOpacity:function(a){this._defaultTint.a=a},_storeDefaultSpriteAsset:function(a){this._defaultSpriteAsset=
a},_storeDefaultSpriteFrame:function(a){this._defaultSpriteFrame=a},_onSetColor:function(a){this._isApplyingTint||(this._storeDefaultColor(a),this._forceReapplyVisualState())},_onSetOpacity:function(a){this._isApplyingTint||(this._storeDefaultOpacity(a),this._forceReapplyVisualState())},_onSetSpriteAsset:function(a){this._isApplyingSprite||(this._storeDefaultSpriteAsset(a),this._forceReapplyVisualState())},_onSetSpriteFrame:function(a){this._isApplyingSprite||(this._storeDefaultSpriteFrame(a),this._forceReapplyVisualState())},
_onMouseEnter:function(a){this._isHovering=!0;this._updateVisualState();this._fireIfActive("mouseenter",a)},_onMouseLeave:function(a){this._isPressed=this._isHovering=!1;this._updateVisualState();this._fireIfActive("mouseleave",a)},_onMouseDown:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("mousedown",a)},_onMouseUp:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("mouseup",a)},_onTouchStart:function(a){this._isPressed=!0;this._updateVisualState();
this._fireIfActive("touchstart",a)},_onTouchEnd:function(a){a.event.preventDefault();this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchend",a)},_onTouchLeave:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchleave",a)},_onTouchCancel:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchcancel",a)},_onSelectStart:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("selectstart",a)},_onSelectEnd:function(a){this._isPressed=
!1;this._updateVisualState();this._fireIfActive("selectend",a)},_onSelectEnter:function(a){this._hoveringCounter++;1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState());this._fireIfActive("selectenter",a)},_onSelectLeave:function(a){this._hoveringCounter--;0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState());this._fireIfActive("selectleave",a)},_onClick:function(a){this._fireIfActive("click",a)},_fireIfActive:function(a,b){this.data.active&&
this.fire(a,b)},_updateVisualState:function(c){var e=this._visualState,g=this._determineVisualState();if((e!==g||c)&&this.enabled)switch(this._visualState=g,"HOVER"===e&&this._fireIfActive("hoverend"),"PRESSED"===e&&this._fireIfActive("pressedend"),"HOVER"===g&&this._fireIfActive("hoverstart"),"PRESSED"===g&&this._fireIfActive("pressedstart"),this.transitionMode){case pc.BUTTON_TRANSITION_MODE_TINT:this._applyTint(this[d[this._visualState]]);break;case pc.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this[b[this._visualState]],
this[a[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(a){if(this._imageReference.hasComponent("element"))switch(a){case pc.BUTTON_TRANSITION_MODE_TINT:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;case pc.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){if(this.active){if(this._isPressed)return"PRESSED";if(this._isHovering)return"HOVER"}else return"INACTIVE";
return"DEFAULT"},_applySprite:function(a,b){b=b||0;this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=a,this._imageReference.entity.element.spriteFrame=b,this._isApplyingSprite=!1)},_applyTint:function(a){this._cancelTween();0===this.fadeDuration?this._applyTintImmediately(a):this._applyTintWithTween(a)},_applyTintImmediately:function(a){this._imageReference.hasComponent("element")&&a&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=
new pc.Color(a.r,a.g,a.b),this._imageReference.entity.element.opacity=a.a,this._isApplyingTint=!1)},_applyTintWithTween:function(a){if(this._imageReference.hasComponent("element")&&a){var b=this._imageReference.entity.element.color,c=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:pc.now(),from:new pc.Color(b.r,b.g,b.b,c),to:a.clone(),lerpColor:new pc.Color}}},_updateTintTween:function(){var a=pc.now()-this._tweenInfo.startTime;a=0===this.fadeDuration?1:a/this.fadeDuration;
a=pc.math.clamp(a,0,1);if(1E-5<Math.abs(a-1)){var b=this._tweenInfo.lerpColor;b.lerp(this._tweenInfo.from,this._tweenInfo.to,a);this._applyTintImmediately(new pc.Color(b.r,b.g,b.b,b.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._imageReference.onParentComponentEnable();this._toggleHitElementListeners("on");this._forceReapplyVisualState()},
onDisable:function(){this._toggleHitElementListeners("off");this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system);this.onDisable()}});return{ButtonComponent:c}}());Object.assign(pc,function(){var d=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],b=function(a){pc.ComponentSystem.call(this,a);this.id="button";this.app=a;this.ComponentType=pc.ButtonComponent;this.DataType=
pc.ButtonComponentData;this.schema=d;this.on("beforeremove",this._onRemoveComponent,this);pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ButtonComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,d)},onUpdate:function(a){a=this.store;for(var b in a){var e=a[b].entity,d=e.button;
if(d.enabled&&e.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});return{ButtonComponentSystem:b}}());Object.assign(pc,function(){return{ButtonComponentData:function(){this.active=this.enabled=!0;this.imageEntity=null;this.hitPadding=new pc.Vec4;this.transitionMode=pc.BUTTON_TRANSITION_MODE_TINT;this.hoverTint=new pc.Color(.75,.75,.75);this.pressedTint=new pc.Color(.5,.5,.5);this.inactiveTint=new pc.Color(.25,.25,.25);this.fadeDuration=0;this.hoverSpriteAsset=null;this.hoverSpriteFrame=0;this.pressedSpriteAsset=null;this.pressedSpriteFrame=0;this.inactiveSpriteAsset=null;this.inactiveSpriteFrame=
0}}}());Object.assign(pc,{SCROLL_MODE_CLAMP:0,SCROLL_MODE_BOUNCE:1,SCROLL_MODE_INFINITE:2,SCROLLBAR_VISIBILITY_SHOW_ALWAYS:0,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:1});Object.assign(pc,function(){var d=new pc.Vec2,b=function(a,b){pc.Component.call(this,a,b);this._viewportReference=new pc.EntityReference(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize});this._contentReference=new pc.EntityReference(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize});this._scrollbarUpdateFlags={};this._scrollbarReferences=
{};this._scrollbarReferences[pc.ORIENTATION_HORIZONTAL]=new pc.EntityReference(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain});this._scrollbarReferences[pc.ORIENTATION_VERTICAL]=new pc.EntityReference(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain});this._prevContentSizes={};this._prevContentSizes[pc.ORIENTATION_HORIZONTAL]=
null;this._prevContentSizes[pc.ORIENTATION_VERTICAL]=null;this._scroll=new pc.Vec2;this._velocity=new pc.Vec3;this._dragStartPosition=new pc.Vec3;this._disabledContentInput=!1;this._disabledContentInputEntities=[];this._toggleLifecycleListeners("on",a);this._toggleElementListeners("on")};b.prototype=Object.create(pc.Component.prototype);b.prototype.constructor=b;Object.assign(b.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_horizontal",this._onSetHorizontalScrollingEnabled,this);
this[a]("set_vertical",this._onSetVerticalScrollingEnabled,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(a){!this.entity.element||"on"===a&&this._hasElementListeners||(this.entity.element[a]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===a)},_onElementComponentAdd:function(a){this.entity===a&&this._toggleElementListeners("on")},_onElementComponentRemove:function(a){this.entity===
a&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper();this._contentDragHelper=new pc.ElementDragHelper(this._contentReference.entity.element);this._contentDragHelper.on("drag:start",this._onContentDragStart,this);this._contentDragHelper.on("drag:end",this._onContentDragEnd,this);this._contentDragHelper.on("drag:move",this._onContentDragMove,this);this._prevContentSizes[pc.ORIENTATION_HORIZONTAL]=null;this._prevContentSizes[pc.ORIENTATION_VERTICAL]=
null;this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=null;this._enableContentInput()},_onContentDragMove:function(a){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(a),
this._setVelocityFromContentPositionDelta(a),!this._disabledContentInput)){var b=a.y-this._dragStartPosition.y;(Math.abs(a.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(b)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(a){!this._scrollbarUpdateFlags[pc.ORIENTATION_HORIZONTAL]&&this.enabled&&this.entity.enabled&&this._onSetScroll(a,null)},_onSetVerticalScrollbarValue:function(a){!this._scrollbarUpdateFlags[pc.ORIENTATION_VERTICAL]&&
this.enabled&&this.entity.enabled&&this._onSetScroll(null,a)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(pc.ORIENTATION_HORIZONTAL)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(pc.ORIENTATION_VERTICAL)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(pc.ORIENTATION_HORIZONTAL);this._syncScrollbarPosition(pc.ORIENTATION_HORIZONTAL)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(pc.ORIENTATION_VERTICAL);
this._syncScrollbarPosition(pc.ORIENTATION_VERTICAL)},_onSetScroll:function(a,b,e){!1!==e&&this._velocity.set(0,0,0);a=0|this._updateAxis(a,"x",pc.ORIENTATION_HORIZONTAL);(a|=this._updateAxis(b,"y",pc.ORIENTATION_VERTICAL))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(a,b,e){var c=null!==a&&1E-5<Math.abs(a-this._scroll[b]);if(c||this._isDragging()||0===a)this._scroll[b]=this._determineNewScrollValue(a,b,e),this._syncContentPosition(e),this._syncScrollbarPosition(e);return c},_determineNewScrollValue:function(a,
b,e){if(!this._getScrollingEnabled(e))return this._scroll[b];switch(this.scrollMode){case pc.SCROLL_MODE_CLAMP:return pc.math.clamp(a,0,this._getMaxScrollValue(e));case pc.SCROLL_MODE_BOUNCE:return this._setVelocityFromOvershoot(a,b,e),a;case pc.SCROLL_MODE_INFINITE:return a;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),a}},_syncAll:function(){this._syncContentPosition(pc.ORIENTATION_HORIZONTAL);this._syncContentPosition(pc.ORIENTATION_VERTICAL);this._syncScrollbarPosition(pc.ORIENTATION_HORIZONTAL);
this._syncScrollbarPosition(pc.ORIENTATION_VERTICAL);this._syncScrollbarEnabledState(pc.ORIENTATION_HORIZONTAL);this._syncScrollbarEnabledState(pc.ORIENTATION_VERTICAL)},_syncContentPosition:function(a){var b=this._getAxis(a),e=this._getSign(a),d=this._contentReference.entity;if(d){var g=this._prevContentSizes[a],n=this._getContentSize(a);if(null!==g&&1E-4<Math.abs(g-n)){g=this._getMaxOffset(a,g);var k=this._getMaxOffset(a,n);this._scroll[b]=0===k?1:pc.math.clamp(this._scroll[b]*g/k,0,1)}g=this._scroll[b]*
this._getMaxOffset(a);k=d.getLocalPosition();k[b]=g*e;d.setLocalPosition(k);this._prevContentSizes[a]=n}},_syncScrollbarPosition:function(a){var b=this._getAxis(a),e=this._scrollbarReferences[a].entity;e&&e.scrollbar&&(this._scrollbarUpdateFlags[a]=!0,e.scrollbar.value=this._scroll[b],e.scrollbar.handleSize=this._getScrollbarHandleSize(b,a),this._scrollbarUpdateFlags[a]=!1)},_syncScrollbarEnabledState:function(a){var b=this._scrollbarReferences[a].entity;if(b){var e=this._getScrollingEnabled(a),d=
this._getScrollbarVisibility(a);switch(d){case pc.SCROLLBAR_VISIBILITY_SHOW_ALWAYS:b.enabled=e;break;case pc.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:b.enabled=e&&this._contentIsLargerThanViewport(a);break;default:console.warn("Unhandled scrollbar visibility:"+d),b.enabled=e}}},_contentIsLargerThanViewport:function(a){return this._getContentSize(a)>this._getViewportSize(a)},_contentPositionToScrollValue:function(a){var b=this._getMaxOffset(pc.ORIENTATION_HORIZONTAL),e=this._getMaxOffset(pc.ORIENTATION_VERTICAL);
d.x=0===b?0:a.x/b;d.y=0===e?0:a.y/-e;return d},_getMaxOffset:function(a,b){b=void 0===b?this._getContentSize(a):b;var c=this._getViewportSize(a);return b<c?-this._getViewportSize(a):c-b},_getMaxScrollValue:function(a){return this._contentIsLargerThanViewport(a)?1:0},_getScrollbarHandleSize:function(a,b){var c=this._getViewportSize(b),d=this._getContentSize(b);if(.001>Math.abs(d))return 1;c=Math.min(c/d,1);a=this._toOvershoot(this._scroll[a],b);return 0===a?c:c/(1+Math.abs(a))},_getViewportSize:function(a){return this._getSize(a,
this._viewportReference)},_getContentSize:function(a){return this._getSize(a,this._contentReference)},_getSize:function(a,b){return b.entity&&b.entity.element?b.entity.element[this._getCalculatedDimension(a)]:0},_getScrollingEnabled:function(a){if(a===pc.ORIENTATION_HORIZONTAL)return this.horizontal;if(a===pc.ORIENTATION_VERTICAL)return this.vertical;console.warn("Unrecognized orientation: "+a)},_getScrollbarVisibility:function(a){if(a===pc.ORIENTATION_HORIZONTAL)return this.horizontalScrollbarVisibility;
if(a===pc.ORIENTATION_VERTICAL)return this.verticalScrollbarVisibility;console.warn("Unrecognized orientation: "+a)},_getSign:function(a){return a===pc.ORIENTATION_HORIZONTAL?1:-1},_getAxis:function(a){return a===pc.ORIENTATION_HORIZONTAL?"x":"y"},_getCalculatedDimension:function(a){return a===pc.ORIENTATION_HORIZONTAL?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),
this._syncScrollbarEnabledState(pc.ORIENTATION_HORIZONTAL),this._syncScrollbarEnabledState(pc.ORIENTATION_VERTICAL))},_updateVelocity:function(){if(!this._isDragging()&&(this.scrollMode===pc.SCROLL_MODE_BOUNCE&&(this._hasOvershoot("x",pc.ORIENTATION_HORIZONTAL)&&this._setVelocityFromOvershoot(this.scroll.x,"x",pc.ORIENTATION_HORIZONTAL),this._hasOvershoot("y",pc.ORIENTATION_VERTICAL)&&this._setVelocityFromOvershoot(this.scroll.y,"y",pc.ORIENTATION_VERTICAL)),this._velocity.x*=1-this.friction,this._velocity.y*=
1-this.friction,1E-4<Math.abs(this._velocity.x)||1E-4<Math.abs(this._velocity.y))){var a=this._contentReference.entity.getLocalPosition();a.x+=this._velocity.x;a.y+=this._velocity.y;this._contentReference.entity.setLocalPosition(a);this._setScrollFromContentPosition(a)}},_hasOvershoot:function(a,b){return.001<Math.abs(this._toOvershoot(this.scroll[a],b))},_toOvershoot:function(a,b){b=this._getMaxScrollValue(b);return 0>a?a:a>b?a-b:0},_setVelocityFromOvershoot:function(a,b,e){a=this._toOvershoot(a,
e)*this._getMaxOffset(e)*this._getSign(e);0<Math.abs(a)&&(this._velocity[b]=-a/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(a){this._prevContentDragPosition?(this._velocity.sub2(a,this._prevContentDragPosition),this._prevContentDragPosition.copy(a)):(this._velocity.set(0,0,0),this._prevContentDragPosition=a.clone())},_setScrollFromContentPosition:function(a){a=this._contentPositionToScrollValue(a);this._isDragging()&&(a=this._applyScrollValueTension(a));this._onSetScroll(a.x,
a.y,!1)},_applyScrollValueTension:function(a){var b=this._getMaxScrollValue(pc.ORIENTATION_HORIZONTAL);var e=this._toOvershoot(a.x,pc.ORIENTATION_HORIZONTAL);0<e?a.x=b+1*Math.log10(1+e):0>e&&(a.x=-1*Math.log10(1-e));b=this._getMaxScrollValue(pc.ORIENTATION_VERTICAL);e=this._toOvershoot(a.y,pc.ORIENTATION_VERTICAL);0<e?a.y=b+1*Math.log10(1+e):0>e&&(a.y=-1*Math.log10(1-e));return a},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(a){this._scrollbarReferences[pc.ORIENTATION_HORIZONTAL].hasComponent("scrollbar")&&
(this._scrollbarReferences[pc.ORIENTATION_HORIZONTAL].entity.scrollbar.enabled=a);this._scrollbarReferences[pc.ORIENTATION_VERTICAL].hasComponent("scrollbar")&&(this._scrollbarReferences[pc.ORIENTATION_VERTICAL].entity.scrollbar.enabled=a)},_setContentDraggingEnabled:function(a){this._contentDragHelper&&(this._contentDragHelper.enabled=a)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var a=this._disabledContentInputEntities.pop();a.element&&(a.element.useInput=!0)}this._disabledContentInput=
!1},_disableContentInput:function(){var a=this,b=function(c){c.element&&c.element.useInput&&(a._disabledContentInputEntities.push(c),c.element.useInput=!1);c=c.children;var e;var d=0;for(e=c.length;d<e;d++)b(c[d])},e=this._contentReference.entity;if(e){e=e.children;var d,g=e.length;for(d=0;d<g;d++)b(e[d])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable();this._contentReference.onParentComponentEnable();this._scrollbarReferences[pc.ORIENTATION_HORIZONTAL].onParentComponentEnable();
this._scrollbarReferences[pc.ORIENTATION_VERTICAL].onParentComponentEnable();this._setScrollbarComponentsEnabled(!0);this._setContentDraggingEnabled(!0);this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1);this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",this.system);this._toggleElementListeners("off");this._destroyDragHelper()}});Object.defineProperty(b.prototype,"scroll",{get:function(){return this._scroll},set:function(a){this._onSetScroll(a.x,
a.y)}});return{ScrollViewComponent:b}}());Object.assign(pc,function(){var d=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},
{name:"verticalScrollbarEntity",type:"entity"}],b=function(a){pc.ComponentSystem.call(this,a);this.id="scrollview";this.app=a;this.ComponentType=pc.ScrollViewComponent;this.DataType=pc.ScrollViewComponentData;this.schema=d;this.on("beforeremove",this._onRemoveComponent,this);pc.ComponentSystem.bind("update",this.onUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ScrollViewComponent.prototype,d);Object.assign(b.prototype,
{initializeComponentData:function(a,b,e){void 0===b.dragThreshold&&(b.dragThreshold=10);pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,d)},onUpdate:function(a){a=this.store;for(var b in a){var e=a[b].entity,d=e.scrollview;if(d.enabled&&e.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});return{ScrollViewComponentSystem:b}}());Object.assign(pc,function(){return{ScrollViewComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this._app=b.app;this._handleReference=new pc.EntityReference(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment});this._toggleLifecycleListeners("on")};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,
{_toggleLifecycleListeners:function(b){this[b]("set_value",this._onSetValue,this);this[b]("set_handleSize",this._onSetHandleSize,this);this[b]("set_orientation",this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper();this._handleDragHelper=new pc.ElementDragHelper(this._handleReference.entity.element,this._getAxis());this._handleDragHelper.on("drag:move",this._onHandleDrag,this);this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},
_onHandleDrag:function(b){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(b[this._getAxis()]))},_onSetValue:function(b,a,c){1E-5<Math.abs(c-a)&&(this.data.value=pc.math.clamp(c,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(b,a,c){1E-5<Math.abs(c-a)&&(this.data.handleSize=pc.math.clamp(c,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},
_onSetOrientation:function(b,a,c){c!==a&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var b=this._handleReference.entity,a=b&&b.element;b&&(b=b.getLocalPosition(),b[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(b));a&&(a[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(b){return b*this._getSign()/this._getUsableTrackLength()},
_scrollValueToHandlePosition:function(b){return b*this._getSign()*this._getUsableTrackLength()},_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_getTrackLength:function(){return this.entity.element?this.orientation===pc.ORIENTATION_HORIZONTAL?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},
_getSign:function(){return this.orientation===pc.ORIENTATION_HORIZONTAL?1:-1},_getAxis:function(){return this.orientation===pc.ORIENTATION_HORIZONTAL?"x":"y"},_getDimension:function(){return this.orientation===pc.ORIENTATION_HORIZONTAL?"width":"height"},_getOppositeDimension:function(){return this.orientation===pc.ORIENTATION_HORIZONTAL?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(b){this._handleDragHelper&&
(this._handleDragHelper.enabled=b)},onEnable:function(){this._handleReference.onParentComponentEnable();this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},onRemove:function(){this._destroyDragHelper();this._toggleLifecycleListeners("off")}});return{ScrollbarComponent:d}}());Object.assign(pc,function(){var d=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}],b=function(a){pc.ComponentSystem.call(this,a);this.id="scrollbar";this.app=a;this.ComponentType=pc.ScrollbarComponent;this.DataType=pc.ScrollbarComponentData;this.schema=d;this.on("beforeremove",this._onRemoveComponent,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=
b;pc.Component._buildAccessors(pc.ScrollbarComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,d)},_onRemoveComponent:function(a,b){b.onRemove()}});return{ScrollbarComponentSystem:b}}());Object.assign(pc,function(){return{ScrollbarComponentData:function(){this.enabled=!0}}}());Object.assign(pc,{FITTING_NONE:0,FITTING_STRETCH:1,FITTING_SHRINK:2,FITTING_BOTH:3});Object.assign(pc,function(){function d(a){return a.element}function b(a){return a.enabled&&a.element&&a.element.enabled}function a(a){var b="_"+a;Object.defineProperty(c.prototype,a,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this[b]=a,this._scheduleReflow())}})}var c=function(a,b){pc.Component.call(this,a,b);this._orientation=pc.ORIENTATION_HORIZONTAL;this._reverseX=!1;this._reverseY=!0;this._alignment=new pc.Vec2(0,1);this._padding=new pc.Vec4;this._spacing=new pc.Vec2;this._heightFitting=
this._widthFitting=pc.FITTING_NONE;this._wrap=!1;this._layoutCalculator=new pc.LayoutCalculator;this._listenForReflowEvents(this.entity,"on");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"on")}.bind(this));this.entity.on("childinsert",this._onChildInsert,this);this.entity.on("childremove",this._onChildRemove,this);a.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this);a.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this);a.app.systems.layoutchild.on("add",
this._onElementOrLayoutComponentAdd,this);a.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)};c.prototype=Object.create(pc.Component.prototype);c.prototype.constructor=c;Object.assign(c.prototype,{_isSelfOrChild:function(a){return a===this.entity||-1!==this.entity.children.indexOf(a)},_listenForReflowEvents:function(a,b){a.element&&(a.element[b]("enableelement",this._scheduleReflow,this),a.element[b]("disableelement",this._scheduleReflow,this),a.element[b]("resize",
this._scheduleReflow,this),a.element[b]("set:pivot",this._scheduleReflow,this));a.layoutchild&&(a.layoutchild[b]("set_enabled",this._scheduleReflow,this),a.layoutchild[b]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"off"),this._scheduleReflow())},_onChildInsert:function(a){this._listenForReflowEvents(a,
"on");this._scheduleReflow()},_onChildRemove:function(a){this._listenForReflowEvents(a,"off");this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var a=this.entity.element,c=this.entity.children.filter(b).map(d);a&&0!==c.length&&(a={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,
widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new pc.Vec2(Math.max(a.calculatedWidth,0),Math.max(a.calculatedHeight,0))},this._isPerformingReflow=!0,c=this._layoutCalculator.calculateLayout(c,a),this._isPerformingReflow=!1,this.fire("reflow",c))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this);this.entity.off("childremove",this._onChildRemove,this);this._listenForReflowEvents(this.entity,
"off");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}});a("orientation");a("reverseX");a("reverseY");
a("alignment");a("padding");a("spacing");a("widthFitting");a("heightFitting");a("wrap");return{LayoutGroupComponent:c}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="layoutgroup";this.app=a;this.ComponentType=pc.LayoutGroupComponent;this.DataType=pc.LayoutGroupComponentData;this.schema=d;this._reflowQueue=[];this.on("beforeremove",this._onRemoveComponent,this);pc.ComponentSystem.bind("postUpdate",this._onPostUpdate,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.LayoutGroupComponent.prototype,
d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.orientation&&(a.orientation=b.orientation);void 0!==b.reverseX&&(a.reverseX=b.reverseX);void 0!==b.reverseY&&(a.reverseY=b.reverseY);void 0!==b.alignment&&(b.alignment instanceof pc.Vec2?a.alignment.copy(b.alignment):a.alignment.set(b.alignment[0],b.alignment[1]),a.alignment=a.alignment);void 0!==b.padding&&(b.padding instanceof pc.Vec4?a.padding.copy(b.padding):a.padding.set(b.padding[0],
b.padding[1],b.padding[2],b.padding[3]),a.padding=a.padding);void 0!==b.spacing&&(b.spacing instanceof pc.Vec2?a.spacing.copy(b.spacing):a.spacing.set(b.spacing[0],b.spacing[1]),a.spacing=a.spacing);void 0!==b.widthFitting&&(a.widthFitting=b.widthFitting);void 0!==b.heightFitting&&(a.heightFitting=b.heightFitting);void 0!==b.wrap&&(a.wrap=b.wrap);pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){a=a.layoutgroup;return this.addComponent(b,{enabled:a.enabled,
orientation:a.orientation,reverseX:a.reverseX,reverseY:a.reverseY,alignment:a.alignment,padding:a.padding,spacing:a.spacing,widthFitting:a.widthFitting,heightFitting:a.heightFitting,wrap:a.wrap})},scheduleReflow:function(a){-1===this._reflowQueue.indexOf(a)&&this._reflowQueue.push(a)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var a=0;0<this._reflowQueue.length;){var b=this._reflowQueue.slice();this._reflowQueue.length=0;
b.sort(function(a,b){return a.entity.graphDepth-b.entity.graphDepth});for(var e=0;e<b.length;++e)b[e].reflow();if(100<=++a){console.warn("Max reflow iterations limit reached, bailing.");break}}},_onRemoveComponent:function(a,b){b.onRemove()}});return{LayoutGroupComponentSystem:b}}());Object.assign(pc,function(){return{LayoutGroupComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){function d(){}function b(b){function d(a){a=a.entity.layoutchild;return!a||!a.enabled||!a.excludeFromLayout}function k(a,b,c){switch(a){case pc.FITTING_NONE:return f.NONE;case pc.FITTING_STRETCH:return b<c?f.APPLY_STRETCHING:f.NONE;case pc.FITTING_SHRINK:return b>=c?f.APPLY_SHRINKING:f.NONE;case pc.FITTING_BOTH:return b<c?f.APPLY_STRETCHING:b>=c?f.APPLY_SHRINKING:f.NONE;default:throw Error("Unrecognized fitting mode: "+a);}}function l(a,b){return x(a,b.size)+(a.length-
1)*C.spacing[b.axis]}function n(a,b,c){var e=y(a,c.maxSize),d=v(a,c.fittingProportion),f=E(d,e);b=g[c.axis]-b;for(var h=0;h<a.length;++h){var k=e[h],m=r(k,b,d,f),l=a[k][c.size]+m,n=Math.min(l,a[k][c.maxSize]);a[k][c.size]=n;b-=m-Math.max(l-n,0)}}function q(a,b,c){var e=y(a,c.minSize,!0);var d=v(a,c.fittingProportion);if(1===d.length)d=[1];else{for(var f=[],h=d.length,k=0;k<h;++k)f.push((1-d[k])/(h-1));d=f}f=E(d,e);b-=g[c.axis];for(h=0;h<a.length;++h){k=e[h];var m=r(k,b,d,f),l=a[k][c.size]-m,n=Math.max(l,
a[k][c.minSize]);a[k][c.size]=n;b-=m-Math.max(n-l,0)}}function r(a,b,c,e){c=c[a];a=e[a];return 1E-5>Math.abs(c)&&1E-5>Math.abs(a)?b:b*c/a}function t(a){for(var b=[],c=0;c<a.length;++c){var e=a[c],d=Math.max(u(e,"minWidth"),0),f=Math.max(u(e,"minHeight"),0),g=Math.max(u(e,"maxWidth"),d),h=Math.max(u(e,"maxHeight"),f);var k=u(e,"width");k=Math.min(Math.max(k,d),g);var m=u(e,"height");m=Math.min(Math.max(m,f),h);var l=u(e,"fitWidthProportion");e=u(e,"fitHeightProportion");b.push({minWidth:d,minHeight:f,
maxWidth:g,maxHeight:h,width:k,height:m,fitWidthProportion:l,fitHeightProportion:e})}return b}function u(a,b){var c=a.entity.layoutchild;return c&&c.enabled&&void 0!==c[b]&&null!==c[b]?c[b]:void 0!==a[b]?a[b]:e[b]}function x(a,b){return a.reduce(function(a,c){return a+c[b]},0)}function v(a,b){var c=x(a,b),e=[],d=a.length,f;if(0===c)for(f=0;f<d;++f)e.push(1/d);else for(f=0;f<d;++f)e.push(a[f][b]/c);return e}function y(a,b,c){a.forEach(A);return a.slice().sort(function(a,e){return c?e[b]-a[b]:a[b]-
e[b]}).map(z)}function A(a,b){a.index=b}function z(a){return a.index}function E(a,b){var c=[];c[b[a.length-1]]=a[b[a.length-1]];for(var e=a.length-2;0<=e;--e)c[b[e]]=c[b[e+1]]+a[b[e]];return c}var C,D=a[b],F=a[c[b]];return function(a,b){a=a.filter(d);C=b;g.x=C.containerSize.x-C.padding.x-C.padding.z;g.y=C.containerSize.y-C.padding.y-C.padding.w;b=a;for(var c=0;c<b.length;++c){var e=b[c],h=e.anchor;if(0!==h.x||0!==h.y||0!==h.z||0!==h.w)e.anchor=pc.Vec4.ZERO}if(C.wrap){b=[[]];c=t(a);e=0;h=C[D.fitting]===
pc.FITTING_SHRINK;for(var m=0;m<a.length;++m){0<b[b.length-1].length&&(e+=C.spacing[D.axis]);var p=c[m][D.size];e+=p;!h&&e>g[D.axis]&&0!==b[b.length-1].length&&(e=p,b.push([]));b[b.length-1].push(a[m]);h&&e>g[D.axis]&&m!==a.length-1&&(e=0,b.push([]))}a=b}else a=[a];b=C.orientation===pc.ORIENTATION_HORIZONTAL&&C.reverseX||C.orientation===pc.ORIENTATION_VERTICAL&&C.reverseY;c=C.orientation===pc.ORIENTATION_HORIZONTAL&&C.reverseY||C.orientation===pc.ORIENTATION_VERTICAL&&C.reverseX;if(b)for(e=0;e<a.length;++e)b&&
a[e].reverse();c&&a.reverse();b=[];for(c=0;c<a.length;++c)e=t(a[c]),h=l(e,D),m=k(C[D.fitting],h,g[D.axis]),m===f.APPLY_STRETCHING?n(e,h,D):m===f.APPLY_SHRINKING&&q(e,h,D),b.push(e);p=[];m=[];for(e=0;e<a.length;++e){h=a[e];h.largestElement=null;h.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(c=0;c<h.length;++c){var r=b[e][c];r[F.size]>h.largestSize[F.size]&&(h.largestElement=h[c],h.largestSize=r)}p.push(h.largestElement);m.push(h.largestSize)}c=l(m,F);e=k(C[F.fitting],
c,g[F.axis]);e===f.APPLY_STRETCHING?n(m,c,F):e===f.APPLY_SHRINKING&&q(m,c,F);for(e=0;e<a.length;++e)for(h=a[e],c=0;c<h.length;++c)m=b[e][c],p=1===a.length?g[F.axis]:h.largestSize[F.size],r=k(C[F.fitting],m[F.size],p),r===f.APPLY_STRETCHING?m[F.size]=Math.min(p,m[F.maxSize]):r===f.APPLY_SHRINKING&&(m[F.size]=Math.max(p,m[F.minSize]));a:{c={};c[D.axis]=0;c[F.axis]=0;a[D.size]=Number.NEGATIVE_INFINITY;e=[];for(h=0;h<a.length;++h){m=a[h];if(0===m.length){c=void 0;break a}p=[];r=b[h];for(var u=0;u<m.length;++u){var v=
m[u],x=r[u];c[F.axis]-=-x[F.size]*v.pivot[F.axis];c[D.axis]-=-x[D.size]*v.pivot[D.axis];p[u]={};p[u][D.axis]=c[D.axis];p[u][F.axis]=c[F.axis];c[F.axis]+=-x[F.size]*v.pivot[F.axis];c[D.axis]+=x[D.size]*(1-v.pivot[D.axis])+C.spacing[D.axis]}m[D.size]=c[D.axis]-C.spacing[D.axis];m[F.size]=m.largestSize[F.size];a[D.size]=Math.max(a[D.size],m[D.size]);c[D.axis]=0;c[F.axis]+=m[F.size]+C.spacing[F.axis];e.push(p)}a[F.size]=c[F.axis]-C.spacing[F.axis];c=e}e=c;h=C.alignment[D.axis];m=C.alignment[F.axis];p=
C.padding[D.axis];r=C.padding[F.axis];for(u=0;u<a.length;++u){v=a[u];x=b[u];for(var y=e[u],A=(g[D.axis]-v[D.size])*h+p,z=(g[F.axis]-a[F.size])*m+r,E=0;E<v.length;++E){var G=(v[F.size]-x[E][F.size])*C.alignment[F.axis];y[E][D.axis]+=A;y[E][F.axis]+=z+G}}for(e=0;e<a.length;++e)for(h=a[e],m=b[e],p=c[e],r=0;r<h.length;++r)u=h[r],u[D.calculatedSize]=m[r][D.size],u[F.calculatedSize]=m[r][F.size],C.orientation===pc.ORIENTATION_HORIZONTAL?u.entity.setLocalPosition(p[r][D.axis],p[r][F.axis],u.entity.getLocalPosition().z):
u.entity.setLocalPosition(p[r][F.axis],p[r][D.axis],u.entity.getLocalPosition().z);b=a.width;a=a.height;return{bounds:new pc.Vec4((g.x-b)*C.alignment.x+C.padding.x,(g.y-a)*C.alignment.y+C.padding.y,b,a)}}}var a={};a[pc.ORIENTATION_HORIZONTAL]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};a[pc.ORIENTATION_VERTICAL]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",
maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};var c={};c[pc.ORIENTATION_HORIZONTAL]=pc.ORIENTATION_VERTICAL;c[pc.ORIENTATION_VERTICAL]=pc.ORIENTATION_HORIZONTAL;var e={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},f={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},g=new pc.Vec2,n={};n[pc.ORIENTATION_HORIZONTAL]=b(pc.ORIENTATION_HORIZONTAL);
n[pc.ORIENTATION_VERTICAL]=b(pc.ORIENTATION_VERTICAL);Object.assign(d.prototype,{calculateLayout:function(a,b){var c=n[b.orientation];if(c)return c(a,b);throw Error("Unrecognized orientation value: "+b.orientation);}});return{LayoutCalculator:d}}());Object.assign(pc,function(){function d(a){var c="_"+a;Object.defineProperty(b.prototype,a,{get:function(){return this[c]},set:function(a){this[c]!==a&&(this[c]=a,this.fire("resize"))}})}var b=function(a,b){pc.Component.call(this,a,b);this._minHeight=this._minWidth=0;this._maxHeight=this._maxWidth=null;this._fitHeightProportion=this._fitWidthProportion=0;this._excludeFromLayout=!1};b.prototype=Object.create(pc.Component.prototype);b.prototype.constructor=b;d("minWidth");d("minHeight");d("maxWidth");
d("maxHeight");d("fitWidthProportion");d("fitHeightProportion");d("excludeFromLayout");return{LayoutChildComponent:b}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="layoutchild";this.app=a;this.ComponentType=pc.LayoutChildComponent;this.DataType=pc.LayoutChildComponentData;this.schema=d};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.LayoutChildComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.minWidth&&
(a.minWidth=b.minWidth);void 0!==b.minHeight&&(a.minHeight=b.minHeight);void 0!==b.maxWidth&&(a.maxWidth=b.maxWidth);void 0!==b.maxHeight&&(a.maxHeight=b.maxHeight);void 0!==b.fitWidthProportion&&(a.fitWidthProportion=b.fitWidthProportion);void 0!==b.fitHeightProportion&&(a.fitHeightProportion=b.fitHeightProportion);void 0!==b.excludeFromLayout&&(a.excludeFromLayout=b.excludeFromLayout);pc.ComponentSystem.prototype.initializeComponentData.call(this,a,b,e)},cloneComponent:function(a,b){a=a.layoutchild;
return this.addComponent(b,{enabled:a.enabled,minWidth:a.minWidth,minHeight:a.minHeight,maxWidth:a.maxWidth,maxHeight:a.maxHeight,fitWidthProportion:a.fitWidthProportion,fitHeightProportion:a.fitHeightProportion,excludeFromLayout:a.excludeFromLayout})}});return{LayoutChildComponentSystem:b}}());Object.assign(pc,function(){return{LayoutChildComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){pc.FONT_MSDF="msdf";pc.FONT_BITMAP="bitmap";var d=function(b,a){this.type=a?a.type||pc.FONT_MSDF:pc.FONT_MSDF;this.em=1;this.textures=b;this.intensity=0;this._data=null;this.data=a};Object.defineProperty(d.prototype,"data",{get:function(){return this._data},set:function(b){if(this._data=b)if(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||2>this._data.version)if(this._data.info.maps=[{width:this._data.info.width,
height:this._data.info.height}],this._data.chars)for(var a in this._data.chars)this._data.chars[a].map=0}});return{FONT_MSDF:pc.FONT_MSDF,Font:d}}());Object.assign(pc,function(){var d=function(b,a){pc.EventHandler.call(this);this.type="bitmap";this.app=b;this.intensity=0;a=a||{};this.fontWeight=a.fontWeight||"normal";this.glyphSize=this.fontSize=parseInt(a.fontSize,10);this.fontName=a.fontName||"Arial";this.color=a.color||new pc.Color(1,1,1);this.padding=a.padding||0;b=4096<a.width?4096:a.width||512;var c=4096<a.height?4096:a.height||512;a=document.createElement("canvas");a.height=c;a.width=b;b=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,
autoMipmap:!0});b.name="font";b.setSource(a);b.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;b.magFilter=pc.FILTER_LINEAR;b.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.textures=[b];this.chars="";this.data={}};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype.createTextures=function(b){b=this._normalizeCharsSet(b);if(b.length!==this.chars.length)this._renderAtlas(b);else for(var a=0;a<b.length;a++)if(b[a]!==this.chars[a]){this._renderAtlas(b);
break}};d.prototype.updateTextures=function(b){b=this._normalizeCharsSet(b);for(var a=[],c=0;c<b.length;c++){var e=b[c];this.data.chars[e]||a.push(e)}0<a.length&&this._renderAtlas(this.chars.concat(a))};d.prototype.destroy=function(){for(var b=0;b<this.textures.length;b++)this.textures[b].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null};d.prototype._getAndClearContext=function(b,a){var c=b.width,e=b.height;
b=b.getContext("2d",{alpha:!0});b.clearRect(0,0,c,e);b.fillStyle=a;b.fillRect(0,0,c,e);return b};d.prototype._colorToRgbString=function(b,a){var c=Math.round(255*b.r),e=Math.round(255*b.g),d=Math.round(255*b.b);return a?"rgba("+c+", "+e+", "+d+", "+b.a+")":"rgb("+c+", "+e+", "+d+")"};d.prototype.renderCharacter=function(b,a,c,e,d){b.fillStyle=d;b.fillText(a,c,e)};d.prototype._renderAtlas=function(b){this.chars=b;b=1;var a=this.textures[b-1].getSource(),c=a.width,e=a.height,d=this._colorToRgbString(this.color,
!1),g=this.color.a;this.color.a=1/255;var n=this._colorToRgbString(this.color,!0);this.color.a=g;g=this._getAndClearContext(a,n);g.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName;g.textAlign="center";g.textBaseline="alphabetic";this.data=this._createJson(this.chars,this.fontName,c,e);var k=pc.string.getSymbols(this.chars.join("")),h=this.textures.length,m=0,l=0,p={},q;for(q=0;q<k.length;q++)a=k[q],p[a]=this._getTextMetrics(a),m=Math.max(m,p[a].height),l=Math.max(l,p[a].descent);
this.glyphSize=Math.max(this.glyphSize,m);m=this.glyphSize+2*this.padding;var r=this.glyphSize+2*this.padding,t=this.glyphSize/2+this.padding,u=r-l-this.padding,x=0,v=0;for(q=0;q<k.length;q++){a=k[q];var y=pc.string.getCodePoint(k[q]),A=this.fontSize;g.font=this.fontWeight+" "+A.toString()+"px "+this.fontName;g.textAlign="center";g.textBaseline="alphabetic";var z=g.measureText(a).width;z>A&&(A=this.fontSize*this.fontSize/z,g.font=this.fontWeight+" "+A.toString()+"px "+this.fontName,z=this.fontSize);
this.renderCharacter(g,a,x+t,v+u,d);this._addChar(this.data,a,y,x,v,m,r,this.padding+(this.glyphSize-z)/2,-this.padding+p[a].descent-l,z,b-1,c,e);x+=m;x+m>c&&(x=0,v+=r,v+r>e&&(this.textures[b-1].upload(),b++,v=0,b>h?(a=document.createElement("canvas"),a.height=e,a.width=c,g=this._getAndClearContext(a,n),y=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0}),y.name="font-atlas",y.setSource(a),y.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,y.magFilter=pc.FILTER_LINEAR,
y.addressU=pc.ADDRESS_CLAMP_TO_EDGE,y.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.textures.push(y)):(a=this.textures[b-1].getSource(),g=this._getAndClearContext(a,n))))}this.textures[b-1].upload();if(b<h){for(q=b;q<h;q++)this.textures[q].destroy();this.textures.splice(b)}this.fire("render")};d.prototype._createJson=function(b,a,c,e){return{version:3,intensity:this.intensity,info:{face:a,width:c,height:e,maps:[{width:c,height:e}]},chars:{}}};d.prototype._addChar=function(b,a,c,e,d,g,n,k,h,m,l,p,q){b.info.maps.length<
l+1&&b.info.maps.push({width:p,height:q});p=this.fontSize/32;b.chars[a]={id:c,letter:a,x:e,y:d,width:g,height:n,xadvance:m/p,xoffset:k/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:l,bounds:[0,0,g/p,n/p]}};d.prototype._normalizeCharsSet=function(b){var a=this.app.systems.element.getUnicodeConverter();a&&(b=a(b));a={};b=pc.string.getSymbols(b);var c;for(c=0;c<b.length;c++){var e=b[c];a[e]||(a[e]=e)}return Object.keys(a).sort()};d.prototype._getTextMetrics=function(b){var a=document.createElement("span");
a.id="content-span";a.innerHTML=b;b=document.createElement("div");b.id="content-block";b.style.display="inline-block";b.style.width="1px";b.style.height="0px";var c=document.createElement("div");c.appendChild(a);c.appendChild(b);c.style.font=this.fontName;c.style.fontSize=this.fontSize+"px";document.body.appendChild(c);var e=-1,d=-1,g=-1;try{b.style["vertical-align"]="baseline",e=b.offsetTop-a.offsetTop,b.style["vertical-align"]="bottom",g=b.offsetTop-a.offsetTop,d=g-e}finally{document.body.removeChild(c)}return{ascent:e,
descent:d,height:g}};return{CanvasFont:d}}());Object.assign(pc,function(){var d=function(b,a){pc.Component.call(this,b,a);this._oldState=!0;this._size=new pc.Vec3;this.on("set_enabled",this._onSetEnabled,this)};d.prototype=Object.create(pc.Component.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{onEnable:function(){this._checkState()},onDisable:function(){this._checkState()},_onSetEnabled:function(b,a,c){this._checkState()},_checkState:function(){var b=this.enabled&&this.entity.enabled;b!==this._oldState&&(this._oldState=b,this.fire("enable"),
this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}});Object.defineProperty(d.prototype,"size",{set:function(b){b instanceof pc.Vec3?this._size.copy(b):b instanceof Array&&3<=b.length&&this.size.set(b[0],b[1],b[2])},get:function(){return this._size}});return{ZoneComponent:d}}());Object.assign(pc,function(){var d=["enabled"],b=function(a){pc.ComponentSystem.call(this,a);this.id="zone";this.app=a;this.ComponentType=pc.ZoneComponent;this.DataType=pc.ZoneComponentData;this.schema=d;this.on("beforeremove",this._onBeforeRemove,this)};b.prototype=Object.create(pc.ComponentSystem.prototype);b.prototype.constructor=b;pc.Component._buildAccessors(pc.ZoneComponent.prototype,d);Object.assign(b.prototype,{initializeComponentData:function(a,b,e){a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:
!0;b.size&&(b.size instanceof pc.Vec3?a.size.copy(b.size):b.size instanceof Array&&3<=b.size.length&&a.size.set(b.size[0],b.size[1],b.size[2]))},cloneComponent:function(a,b){return this.addComponent(b,{size:a.zone.size})},_onBeforeRemove:function(a,b){b._onBeforeRemove()}});return{ZoneComponentSystem:b}}());Object.assign(pc,function(){return{ZoneComponentData:function(){this.enabled=!0}}}());Object.assign(pc,function(){function d(a,b,e,f){var c;if(b instanceof pc.Entity){var n=b.c,k;for(k in n){var h=n[k],m=h.system.getPropertiesOfType("entity");var l=0;for(c=m.length;l<c;l++){var p=m[l].name,q=h[p];a.findByGuid(q)&&((q=f[q].getGuid())?e.c[k][p]=q:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}n.script&&!e._app.useLegacyScriptAttributeCloning&&e.script.resolveDuplicatedEntityReferenceProperties(n.script,f);b=b.children.filter(function(a){return a instanceof
pc.Entity});e=e.children.filter(function(a){return a instanceof pc.Entity});l=0;for(c=b.length;l<c;l++)d(a,b[l],e[l],f)}}var b=function(a,b){pc.GraphNode.call(this,a);a instanceof pc.Application&&(b=a);this._batchHandle=null;this.c={};this._app=b;if(!b&&(this._app=pc.Application.getApplication(),!this._app))throw Error("Couldn't find current application");this._guid=null;this._destroying=!1};b.prototype=Object.create(pc.GraphNode.prototype);b.prototype.constructor=b;b.prototype.addComponent=function(a,
b){var c=this._app.systems[a];return!c||this.c[a]?null:c.addComponent(this,b)};b.prototype.removeComponent=function(a){var b=this._app.systems[a];b&&this.c[a]&&b.removeComponent(this)};b.prototype.findComponent=function(a){var b=this.findOne(function(b){return b.c&&b.c[a]});return b&&b.c[a]};b.prototype.findComponents=function(a){return this.find(function(b){return b.c&&b.c[a]}).map(function(b){return b.c[a]})};b.prototype.getGuid=function(){this._guid||this.setGuid(pc.guid.create());return this._guid};
b.prototype.setGuid=function(a){var b=this._app._entityIndex;this._guid&&delete b[this._guid];this._guid=a;b[this._guid]=this};b.prototype._notifyHierarchyStateChanged=function(a,b){var c=!1;a===this&&0===this._app._enableList.length&&(c=!0);a._beingEnabled=!0;a._onHierarchyStateChanged(b);a._onHierarchyStatePostChanged&&this._app._enableList.push(a);var d,g=a._children;var n=0;for(d=g.length;n<d;n++)g[n]._enabled&&this._notifyHierarchyStateChanged(g[n],b);a._beingEnabled=!1;if(c){for(n=0;n<this._app._enableList.length;n++)this._app._enableList[n]._onHierarchyStatePostChanged();
this._app._enableList.length=0}};b.prototype._onHierarchyStateChanged=function(a){pc.GraphNode.prototype._onHierarchyStateChanged.call(this,a);var b=this.c,e;for(e in b)if(b.hasOwnProperty(e)){var d=b[e];if(d.enabled)if(a)d.onEnable();else d.onDisable()}};b.prototype._onHierarchyStatePostChanged=function(){var a=this.c,b;for(b in a)if(a.hasOwnProperty(b))a[b].onPostStateChange()};b.prototype.findByGuid=function(a){return this._guid===a?this:(a=this._app._entityIndex[a])&&(a===this||a.isDescendantOf(this))?
a:null};b.prototype.destroy=function(){this._destroying=!0;for(a in this.c)this.c[a].enabled=!1;for(a in this.c)this.c[a].system.removeComponent(this);this._parent&&this._parent.removeChild(this);var a=this._children;for(var b=a.shift();b;)b instanceof pc.Entity&&b.destroy(),b._parent=null,b=a.shift();this.fire("destroy",this);this.off();this._guid&&delete this._app._entityIndex[this._guid];this._destroying=!1};b.prototype.clone=function(){var a={},b=this._cloneRecursively(a);a[this.getGuid()]=b;
d(this,this,b,a);return b};b.prototype._cloneRecursively=function(a){var b=new pc.Entity(this._app);pc.GraphNode.prototype._cloneInternal.call(this,b);for(var e in this.c)this.c[e].system.cloneComponent(this,b);for(e=0;e<this._children.length;e++){var d=this._children[e];if(d instanceof pc.Entity){var g=d._cloneRecursively(a);b.addChild(g);a[d.getGuid()]=g}}return b};return{Entity:b}}());Object.assign(pc,function(){function d(b,a,c){if(b&&b instanceof pc.Component){if(!a||"string"!==typeof a)throw Error("The propertyName argument is required and must be a string");if(c&&"object"!==typeof c)throw Error("If provided, the eventConfig argument must be an object");}else throw Error("The parentComponent argument is required and must be a Component");this._parentComponent=b;this._entityPropertyName=a;this._entity=null;this._app=b.system.app;this._configureEventListeners(c||{},{"entity#destroy":this._onEntityDestroy});
this._toggleLifecycleListeners("on")}Object.assign(d.prototype,{_configureEventListeners:function(b,a){b=this._parseEventListenerConfig(b,"external",this._parentComponent);a=this._parseEventListenerConfig(a,"internal",this);this._eventListenerConfigs=b.concat(a);this._listenerStatusFlags={};this._gainListeners={};this._loseListeners={}},_parseEventListenerConfig:function(b,a,c){return Object.keys(b).map(function(e,d){var f=e.split("#"),n=f[0],k=f[1],h=b[e];if(2!==f.length||"string"!==typeof n||0===
n.length||"string"!==typeof k||0===k.length)throw Error("Invalid event listener description: `"+e+"`");if("function"!==typeof h)throw Error("Invalid or missing callback for event listener `"+e+"`");return{id:a+"_"+d+"_"+e,sourceName:n,eventName:k,callback:h,scope:c}},this)},_toggleLifecycleListeners:function(b){this._parentComponent[b]("set_"+this._entityPropertyName,this._onSetEntity,this);this._parentComponent.system[b]("beforeremove",this._onParentComponentRemove,this);pc.ComponentSystem[b]("postinitialize",
this._onPostInitialize,this);this._app[b]("tools:sceneloaded",this._onSceneLoaded,this);for(var a=[],c=0;c<this._eventListenerConfigs.length;++c){var e=this._eventListenerConfigs[c],d=this._app.systems[e.sourceName];d&&(-1===a.indexOf(d)&&a.push(d),d&&"gain"===e.eventName&&(this._gainListeners[e.sourceName]=e),d&&"lose"===e.eventName&&(this._loseListeners[e.sourceName]=e))}for(c=0;c<a.length;++c)a[c][b]("add",this._onComponentAdd,this),a[c][b]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(b,
a,c){c instanceof pc.Entity?this._updateEntityReference():null!==c&&void 0!==c&&"string"!==typeof c?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof c+"'"):a!==c&&this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var b=this._parentComponent.data[this._entityPropertyName];
if(b instanceof pc.Entity){var a=b;b=a.getGuid();this._parentComponent.data[this._entityPropertyName]=b}else a=this._parentComponent.system.app.root,a=this._parentComponent.entity.isDescendantOf(a)&&b?a.findByGuid(b):null;this._entity!==a&&(this._entity&&this._onBeforeEntityChange(),(this._entity=a)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off");this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on");
this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(b,a){a=a.system.id;b===this._entity&&(this._callGainOrLoseListener(a,this._gainListeners),this._toggleComponentListeners("on",a))},_onComponentRemove:function(b,a){a=a.system.id;b===this._entity&&(this._callGainOrLoseListener(a,this._loseListeners),this._toggleComponentListeners("off",a,!0))},_callAllGainOrLoseListeners:function(b){for(var a in this._entity.c)this._callGainOrLoseListener(a,b)},_callGainOrLoseListener:function(b,
a){this._entity.c.hasOwnProperty(b)&&a[b]&&(b=a[b],b.callback.call(b.scope))},_toggleEntityListeners:function(b,a){if(this._entity)for(var c=0;c<this._eventListenerConfigs.length;++c)this._safeToggleListener(b,this._eventListenerConfigs[c],a)},_toggleComponentListeners:function(b,a,c){for(var e=0;e<this._eventListenerConfigs.length;++e){var d=this._eventListenerConfigs[e];d.sourceName===a&&this._safeToggleListener(b,d,c)}},_safeToggleListener:function(b,a,c){var e="on"===b;if(!e||!this._listenerStatusFlags[a.id])if(c=
this._getEventSource(a.sourceName,c))c[b](a.eventName,a.callback,a.scope),this._listenerStatusFlags[a.id]=e},_getEventSource:function(b,a){if("entity"===b)return this._entity;var c=this._entity[b];if(c)return c;a||console.warn("Entity has no component with name "+b);return null},_onEntityDestroy:function(b){this._entity===b&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(b,a){a===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",
!0))},hasComponent:function(b){return this._entity&&this._entity.c?!!this._entity.c[b]:!1}});Object.defineProperty(d.prototype,"entity",{get:function(){return this._entity}});return{EntityReference:d}}());Object.assign(pc,function(){var d=function(b){this._sortBy=b.sortBy;this.items=[];this.length=0;this.loopIndex=-1;this._sortHandler=this._doSort.bind(this)};d.prototype._binarySearch=function(b){var a=0,c=this.items.length-1;b=b[this._sortBy];for(var e,d;a<=c;)e=Math.floor((a+c)/2),d=this.items[e][this._sortBy],d<=b?a=e+1:d>b&&(c=e-1);return a};d.prototype._doSort=function(b,a){var c=this._sortBy;return b[c]-a[c]};d.prototype.insert=function(b){var a=this._binarySearch(b);this.items.splice(a,0,b);
this.length++;this.loopIndex>=a&&this.loopIndex++};d.prototype.append=function(b){this.items.push(b);this.length++};d.prototype.remove=function(b){b=this.items.indexOf(b);0>b||(this.items.splice(b,1),this.length--,this.loopIndex>=b&&this.loopIndex--)};d.prototype.sort=function(){var b=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler);null!==b&&(this.loopIndex=this.items.indexOf(b))};return{SortedLoopArray:d}}());Object.assign(pc,function(){var d=function(b){this._handlers={};this._requests={};this._cache={};this._app=b};Object.assign(d.prototype,{addHandler:function(b,a){this._handlers[b]=a;a._loader=this},removeHandler:function(b){delete this._handlers[b]},getHandler:function(b){return this._handlers[b]},load:function(b,a,c,e){var d=this._handlers[a];if(d){var g=b+a;if(void 0!==this._cache[g])c(null,this._cache[g]);else if(this._requests[g])this._requests[g].push(c);else{this._requests[g]=[c];var n=this,
k=function(a,b){a?n._onFailure(g,a):d.load(b,function(a,c,f){if(n._requests[g])if(a)n._onFailure(g,a);else try{n._onSuccess(g,d.open(b.original,c,e),f)}catch(r){n._onFailure(g,r)}},e)};a=b.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(a)?this._app.bundles.canLoadUrl(a)?this._app.bundles.loadUrl(a,function(a,c){k(a,{load:c,original:b})}):k("Bundle for "+b+" not loaded yet"):k(null,{load:b,original:b})}}else c("No handler for asset type: "+a)},_onSuccess:function(b,a,c){this._cache[b]=
a;for(var e=0;e<this._requests[b].length;e++)this._requests[b][e](null,a,c);delete this._requests[b]},_onFailure:function(b,a){console.error(a);if(this._requests[b]){for(var c=0;c<this._requests[b].length;c++)this._requests[b][c](a);delete this._requests[b]}},open:function(b,a){var c=this._handlers[b];return c?c.open(null,a):(console.warn("No resource handler found for: "+b),a)},patch:function(b,a){var c=this._handlers[b.type];c?c.patch&&c.patch(b,a):console.warn("No resource handler found for: "+
b.type)},clearCache:function(b,a){delete this._cache[b+a]},getFromCache:function(b,a){if(this._cache[b+a])return this._cache[b+a]},enableRetry:function(){for(var b in this._handlers)this._handlers[b].retryRequests=!0},disableRetry:function(){for(var b in this._handlers)this._handlers[b].retryRequests=!1},destroy:function(){this._handlers={};this._requests={};this._cache={}}});return{ResourceLoader:d}}());Object.assign(pc,function(){var d=function(){};Object.assign(d.prototype,{load:function(b,a,c){throw Error("not implemented");},open:function(b,a,c){throw Error("not implemented");},patch:function(b,a){}});return{ResourceHandler:d}}());Object.assign(pc,function(){var d=function(b){this._assets=b;this._worker=null;this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this;pc.http.get(b.load,{responseType:pc.Http.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(e,d){if(e)a("Error loading bundle resource "+b.original+": "+e);else try{c._untar(d,a)}catch(g){a("Error loading bundle resource "+b.original+": "+g)}})},_untar:function(b,a){var c=this;pc.platform.workers?
(c._worker||(c._worker=new pc.UntarWorker(c._assets.prefix)),c._worker.untar(b,function(b,d){a(b,d);c._worker.hasPendingRequests()||(c._worker.destroy(),c._worker=null)})):(b=(new pc.Untar(b)).untar(c._assets.prefix),a(null,b))},open:function(b,a){return new pc.Bundle(a)},patch:function(b,a){}});return{BundleHandler:d}}());Object.assign(pc,function(){function d(a){function c(a){this._fields=a}if("undefined"!==typeof TextDecoder){var e=new TextDecoder("utf-8");var d=new TextDecoder("windows-1252")}else console.warn("TextDecoder not supported - pc.Untar module will not work");c.parse=function(a,b,d){for(var f=new Uint8Array(a,b,d),g=0,h=[];g<d;){var k;for(k=g;k<d&&32!=f[k];k++);if(k>=d)throw Error("Invalid PAX header data format.");var m=parseInt(e.decode(new Uint8Array(a,b+g,k-g)),10);k=e.decode(new Uint8Array(a,b+k+
1,m-(k-g)-2)).split("=");if(2!==k.length)throw Error("Invalid PAX header data format.");0===k[1].length&&(k[1]=null);h.push({name:k[0],value:k[1]});g+=m}return new c(h)};c.prototype.applyHeader=function(a){for(var b=0;b<this._fields.length;b++){var c=this._fields[b].name,e=this._fields[b].value;"path"===c&&(c="name");null===e?delete a[c]:a[c]=e}};var k=function(a){this._arrayBuffer=a||new ArrayBuffer(0);this._bufferView=new DataView(this._arrayBuffer);this._paxHeader=this._globalPaxHeader=null;this._bytesRead=
0};a||(b=k);k.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)};k.prototype._readNextFile=function(){var b=new DataView(this._arrayBuffer,this._bytesRead,512),e=d.decode(b);this._bytesRead+=512;b=e.substr(0,100).replace(/\0/g,"");var f=e.substr(257,6),g=parseInt(e.substr(124,12),8),k=e.substr(156,1),n=this._bytesRead,t=null,u=!1;switch(k){case "0":case "":u=!0;a||(t=new Blob([this._arrayBuffer.slice(this._bytesRead,
this._bytesRead+g)]),t=URL.createObjectURL(t));break;case "g":this._globalPaxHeader=c.parse(this._arrayBuffer,this._bytesRead,g);break;case "x":this._paxHeader=c.parse(this._arrayBuffer,this._bytesRead,g)}this._bytesRead+=g;k=g%512;0!==k&&(this._bytesRead+=512-k);if(!u)return null;-1!==f.indexOf("ustar")&&(e=e.substr(345,155).replace(/\0/g,""),0<e.length&&(b=e.trim()+b.trim()));b={name:b,start:n,size:g,url:t};this._globalPaxHeader&&this._globalPaxHeader.applyHeader(b);this._paxHeader&&(this._paxHeader.applyHeader(b),
this._paxHeader=null);return b};k.prototype.untar=function(a){if(!e)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];for(var b=[];this._hasNext();){var c=this._readNextFile();c&&(a&&c.name&&(c.name=a+c.name),b.push(c))}return b};a&&(self.onmessage=function(a){var b=a.data.id;try{var c=(new k(a.data.arrayBuffer)).untar(a.data.prefix);postMessage({id:b,files:c,arrayBuffer:a.data.arrayBuffer},[a.data.arrayBuffer])}catch(p){postMessage({id:b,error:p.toString()})}})}
var b,a=null,c=function(b){this._requestId=0;this._pendingRequests={};this._filenamePrefix=b;b=Worker;if(!a){var c=new Blob(["("+d.toString()+")(true)\n\n"],{type:"application/javascript"});a=URL.createObjectURL(c)}this._worker=new b(a);this._worker.addEventListener("message",this._onMessage.bind(this))};c.prototype._onMessage=function(a){var b=a.data.id;if(this._pendingRequests[b]){var c=this._pendingRequests[b];delete this._pendingRequests[b];if(a.data.error)c(a.data.error);else{b=a.data.arrayBuffer;
for(var e=0,d=a.data.files.length;e<d;e++){var h=a.data.files[e],m=new Blob([b.slice(h.start,h.start+h.size)]);h.url=URL.createObjectURL(m)}c(null,a.data.files)}}};c.prototype.untar=function(a,b){var c=this._requestId++;this._pendingRequests[c]=b;this._worker.postMessage({id:c,prefix:this._filenamePrefix,arrayBuffer:a},[a])};c.prototype.hasPendingRequests=function(){for(var a in this._pendingRequests)return!0;return!1};c.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=
this._worker=null)};d();return{Untar:b,UntarWorker:c}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:this.retryRequests};b.load.startsWith("blob:")&&(".glb"===pc.path.getExtension(b.original).toLowerCase()?c.responseType=pc.Http.ResponseType.ARRAY_BUFFER:c.responseType=pc.Http.ResponseType.JSON);pc.http.get(b.load,c,function(c,d){c?a(pc.string.format("Error loading animation resource: {0} [{1}]",b.original,c)):a(null,d)})},open:function(b,
a){return".glb"===pc.path.getExtension(b).toLowerCase()?(b=pc.GlbParser.parse("filename.glb",a,null))?b.animations:null:this["_parseAnimationV"+a.animation.version](a)},_parseAnimationV3:function(b){b=b.animation;var a=new pc.Animation;a.setName(b.name);a.duration=b.duration;for(var c=0;c<b.nodes.length;c++){var e=new pc.Node,d=b.nodes[c];e._name=d.name;for(var g=0;g<d.keys.length;g++){var n=d.keys[g],k=n.time,h=n.pos,m=n.rot;n=n.scale;h=new pc.Vec3(h[0],h[1],h[2]);m=(new pc.Quat).setFromEulerAngles(m[0],
m[1],m[2]);n=new pc.Vec3(n[0],n[1],n[2]);k=new pc.Key(k,h,m,n);e._keys.push(k)}a.addNode(e)}return a},_parseAnimationV4:function(b){b=b.animation;var a=new pc.Animation;a.setName(b.name);a.duration=b.duration;for(var c=0;c<b.nodes.length;c++){var e=new pc.Node,d=b.nodes[c];e._name=d.name;for(var g=d.defaults.p,n=d.defaults.r,k=d.defaults.s,h=0;h<d.keys.length;h++){var m=d.keys[h],l=m.t,p=g?g:m.p,q=n?n:m.r;m=k?k:m.s;p=new pc.Vec3(p[0],p[1],p[2]);q=(new pc.Quat).setFromEulerAngles(q[0],q[1],q[2]);m=
new pc.Vec3(m[0],m[1],m[2]);l=new pc.Key(l,p,q,m);e._keys.push(l)}a.addNode(e)}return a}});return{AnimationHandler:d}}());Object.assign(pc,function(){var d=function(){if("undefined"===typeof window)return!1;var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return 0<b?parseInt(a.substring(b+5,a.indexOf(".",b)),10):0<a.indexOf("Trident/")?(b=a.indexOf("rv:"),parseInt(a.substring(b+3,a.indexOf(".",b)),10)):!1}(),b=function(a){this.manager=a;this.retryRequests=!1};Object.assign(b.prototype,{_isSupported:function(a){return{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",
".mp4":"audio/mp4",".aac":"audio/aac"}[pc.path.getExtension(a)]?!0:!1},load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=function(a){b(null,new pc.Sound(a))},d=function(c){var e="Error loading audio url: "+a.original;c&&(e+=": "+(c.message||c));console.warn(e);b(e)};this._createSound?this._isSupported(a.original)?this._createSound(a.load,c,d):d(pc.string.format("Audio format for {0} not supported",a.original)):d(null)},open:function(a,b){return b}});pc.SoundManager.hasAudioContext()?
b.prototype._createSound=function(a,b,e){var c=this.manager;if(c.context){var d={retry:this.retryRequests};a.startsWith("blob:")&&(d.responseType=pc.Http.ResponseType.ARRAY_BUFFER);pc.http.get(a,d,function(a,d){a?e(a):c.context.decodeAudioData(d,b,e)})}else e("Audio manager has no audio context")}:pc.SoundManager.hasAudio()&&(b.prototype._createSound=function(a,b,e){var c=null;try{c=new Audio}catch(n){e("No support for Audio element");return}d&&document.body.appendChild(c);var g=function(){c.removeEventListener("canplaythrough",
g);d&&document.body.removeChild(c);b(c)};c.onerror=function(){c.onerror=null;d&&document.body.removeChild(c);e()};c.addEventListener("canplaythrough",g);c.src=a});return{AudioHandler:b}}());Object.assign(pc,function(){var d=function(b,a,c){this._device=b;this._assets=a;this._loader=c};Object.assign(d.prototype,{load:function(b,a){},open:function(b,a){},patch:function(b,a){var c=this,e=!1;b.resources[0]||(b.resources[0]=new pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,cubemap:!0,mipmaps:!0,fixCubemapSeams:!!b._dds}),b.resources[0].name="cubemap",e=!0);if(!b.file)delete b._dds;else if(b.file&&!b._dds){var d=b.getFileUrl();a._loader.load(d+"?t="+b.file.hash,"texture",function(e,
d){e?(a.fire("error",e,b),a.fire("error:"+b.id,e,b),b.fire("error",e,b)):(a._loader.patch({resource:d,type:"texture",data:b.data},a),b._dds=d,c.patch(b,a))})}if((!b.file||!b._dds)&&b.resources[1])b.resources=[b.resources[0]],e=!0;else if(b._dds&&!b.resources[1]){b.resources=[b.resources[0]];b._dds.fixCubemapSeams=!0;b._dds.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b._dds.addressV=pc.ADDRESS_CLAMP_TO_EDGE;e=0;this._device.useTexCubeLod&&(b.resources.push(b._dds),e=1);for(;6>e;e++)d=new pc.Texture(this._device,
{cubemap:!0,fixCubemapSeams:!0,mipmaps:!0,format:b._dds.format,rgbm:b._dds.rgbm,width:Math.pow(2,7-e),height:Math.pow(2,7-e)}),d.name="cubemap-mip",d._levels[0]=b._dds._levels[e],d.upload(),b.resources.push(d);e=!0}d=b.resource;d.name!==b.name&&(d.name=b.name);var g=!!b.data.rgbm;b.data.hasOwnProperty("rgbm")&&d.rgbm!==g&&(d.rgbm=g);d.fixCubemapSeams=!!b._dds;b.data.hasOwnProperty("minFilter")&&d.minFilter!==b.data.minFilter&&(d.minFilter=b.data.minFilter);b.data.hasOwnProperty("magFilter")&&d.magFilter!==
b.data.magFilter&&(d.magFilter=b.data.magFilter);b.data.hasOwnProperty("anisotropy")&&d.anisotropy!==b.data.anisotropy&&(d.anisotropy=b.data.anisotropy);d.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(d.addressU=pc.ADDRESS_CLAMP_TO_EDGE);d.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(d.addressV=pc.ADDRESS_CLAMP_TO_EDGE);this._patchTextureFaces(b,a);e&&(a.fire("load",b),a.fire("load:"+b.id,b),b.fire("load",b))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},
_patchTextureFaces:function(b,a){if(b.loadFaces||!b.file){var c=b.resource,e=[],d=0,g=!1,n=this;b._levelsEvents||(b._levelsEvents=[null,null,null,null,null,null]);b.data.textures.forEach(function(f,h){var k=function(f){d++;e[h]=f&&f.resource.getSource()||null;var k=b._levelsEvents[h];if(k!==f){k&&k.off("load",n._patchTexture,b);if(f)f.on("load",n._patchTexture,b);b._levelsEvents[h]=f||null}e[h]!==c._levels[0][h]&&(g=!0);6===d&&g&&(c.setSource(e),a.fire("load",b),a.fire("load:"+b.id,b),b.fire("load",
b))},l=function(b){b.ready(k);a.load(b)},p=a.get(f);p?(p.ready(k),a.load(p)):f?(a.once("load:"+f,k),a.once("add:"+f,l)):k(null)})}}});return{CubemapHandler:d}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:this.retryRequests};b.load.startsWith("blob:")&&(c.responseType=pc.Http.ResponseType.JSON);pc.http.get(b.load,c,function(c,d){c?a(pc.string.format("Error loading JSON resource: {0} [{1}]",b.original,c)):a(null,d)})},open:function(b,a){return a},patch:function(b,a){}});return{JsonHandler:d}}());Object.assign(pc,function(){var d={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},b=function(a){this._assets=a.assets;this._device=a.graphicsDevice;this._placeholderTextures=null;this._parser=new pc.JsonStandardMaterialParser;this.retryRequests=!1};Object.assign(b.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});pc.http.get(a.load,
{retry:this.retryRequests},function(c,d){c?b&&b(pc.string.format("Error loading material: {0} [{1}]",a.original,c)):b&&(d._engine=!0,b(null,d))})},open:function(a,b){a=this._parser.parse(b);b._engine&&(a._data=b,delete b._engine);return a},_createPlaceholders:function(){this._placeholderTextures={};var a={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]},b;for(b in a)if(a.hasOwnProperty(b)){this._placeholderTextures[b]=new pc.Texture(this._device,{width:2,
height:2,format:pc.PIXELFORMAT_R8_G8_B8_A8});this._placeholderTextures[b].name="placeholder";for(var e=this._placeholderTextures[b].lock(),d=0;4>d;d++)for(var g=0;4>g;g++)e[4*d+g]=a[b][g];this._placeholderTextures[b].unlock()}},patch:function(a,b){a.resource._data&&(a._data=a.resource._data,delete a.resource._data);a.data.name=a.name;a.resource.name=a.name;this._bindAndAssignAssets(a,b);a.off("unload",this._onAssetUnload,this);a.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(a){delete a.data.parameters;
delete a.data.chunks;delete a.data.name},_assignTexture:function(a,b,e){b.data[a]=e;b.resource[a]=e},_assignPlaceholderTexture:function(a,b){this._placeholderTextures||this._createPlaceholders();b.resource[a]=this._placeholderTextures[d[a]]},_onTextureLoad:function(a,b,e){this._assignTexture(a,b,e.resource);b.resource.update()},_onTextureAdd:function(a,b,e){this._assets.load(e)},_onTextureRemove:function(a,b,e){var c=b.resource;c[a]===e.resource&&(this._assignTexture(a,b,null),c.update())},_assignCubemap:function(a,
b,e){b.data[a]=e[0];7===e.length&&(b.data.prefilteredCubeMap128=e[1],b.data.prefilteredCubeMap64=e[2],b.data.prefilteredCubeMap32=e[3],b.data.prefilteredCubeMap16=e[4],b.data.prefilteredCubeMap8=e[5],b.data.prefilteredCubeMap4=e[6])},_onCubemapLoad:function(a,b,e){this._assignCubemap(a,b,e.resources);this._parser.initialize(b.resource,b.data)},_onCubemapAdd:function(a,b,e){b.data.shadingModel===pc.SPECULAR_PHONG&&(b.loadFaces=!0);this._assets.load(e)},_onCubemapRemove:function(a,b,e){var c=b.resource;
c[a]===e.resource&&(this._assignCubemap(a,b,[null,null,null,null,null,null,null]),c.update())},_bindAndAssignAssets:function(a,b){var c=this._parser.migrate(a.data),d=a.resource,g="path"===c.mappingFormat,n=pc.StandardMaterial.TEXTURE_PARAMETERS,k;g&&(k=pc.path.getDirectory(a.getFileUrl()));var h;for(h=0;h<n.length;h++){var m=n[h];var l=d._assetReferences[m];!c[m]||c[m]instanceof pc.Texture?l&&(g?l.url=null:l.id=null):(l||(l=new pc.AssetReference(m,a,b,{load:this._onTextureLoad,add:this._onTextureAdd,
remove:this._onTextureRemove},this),d._assetReferences[m]=l),g?l.url=pc.path.join(k,c[m]):l.id=c[m],l.asset&&(l.asset.resource?this._assignTexture(m,a,l.asset.resource):this._assignPlaceholderTexture(m,a),b.load(l.asset)))}n=pc.StandardMaterial.CUBEMAP_PARAMETERS;for(h=0;h<n.length;h++)m=n[h],l=d._assetReferences[m],!c[m]||c[m]instanceof pc.Texture||(l||(l=new pc.AssetReference(m,a,b,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),d._assetReferences[m]=l),g?l.url=
c[m]:l.id=c[m],l.asset&&(l.asset.resource&&this._assignCubemap(m,a,l.asset.resources),b.load(l.asset)));this._parser.initialize(d,c)}});return{MaterialHandler:b}}());Object.assign(pc,function(){var d=function(b,a){this._device=b;this._parsers=[];this._defaultMaterial=a;this.retryRequests=!1;this.addParser(new pc.JsonModelParser(this._device),function(a,b){return".json"===pc.path.getExtension(a)});this.addParser(new pc.GlbModelParser(this._device),function(a,b){return".glb"===pc.path.getExtension(a)})};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:this.retryRequests};b.load.startsWith("blob:")&&(".glb"===
pc.path.getExtension(b.original).toLowerCase()?c.responseType=pc.Http.ResponseType.ARRAY_BUFFER:c.responseType=pc.Http.ResponseType.JSON);pc.http.get(b.load,c,function(c,d){a&&(c?a(pc.string.format("Error loading model: {0} [{1}]",b.original,c)):a(null,d))})},open:function(b,a){for(var c=0;c<this._parsers.length;c++){var e=this._parsers[c];if(e.decider(b,a))return e.parser.parse(a)}logWARNING(pc.string.format("No model parser found for: {0}",b));return null},patch:function(b,a){if(b.resource){var c=
b.data,e=this;b.resource.meshInstances.forEach(function(d,g){if(c.mapping){var f=function(b){b.resource?d.material=b.resource:(b.once("load",f),a.load(b));b.once("remove",function(a){d.material===a.resource&&(d.material=e._defaultMaterial)})};if(c.mapping[g]){var k=c.mapping[g].material,h=c.mapping[g].path;if(void 0!==k)if(k)if(g=a.get(k))f(g);else a.once("add:"+k,f);else d.material=e._defaultMaterial;else if(h)if(k=b.getFileUrl(),k=pc.path.getDirectory(k),k=pc.path.join(k,c.mapping[g].path),g=a.getByUrl(k))f(g);
else a.once("add:url:"+k,f)}else d.material=e._defaultMaterial}})}},addParser:function(b,a){this._parsers.push({parser:b,decider:a})}});return{ModelHandler:d}}());Object.assign(pc,function(){var d=function(b){this._app=b;this._scripts={};this._cache={}};d._types=[];d._push=function(b){pc.script.legacy&&0<d._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):d._types.push(b)};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this;pc.script.app=this._app;this._loadScript(b.original,function(b,f,g){if(b)a(b);else if(pc.script.legacy)b=null,d._types.length&&(b=d._types.pop()),b?this._scripts[f]=
b:b=null,a(null,b,g);else{b={};for(var e=0;e<d._types.length;e++)b[d._types[e].name]=d._types[e];d._types.length=0;a(null,b,g);delete c._loader._cache[f+"script"]}}.bind(this))},open:function(b,a){return a},patch:function(b,a){},_loadScript:function(b,a){var c=document.head,e=document.createElement("script");this._cache[b]=e;e.async=!1;e.addEventListener("error",function(b){a(pc.string.format("Script: {0} failed to load",b.target.src))},!1);var d=!1;e.onload=e.onreadystatechange=function(){d||this.readyState&&
"loaded"!=this.readyState&&"complete"!=this.readyState||(d=!0,a(null,b,e))};e.src=b;c.appendChild(e)}});return{ScriptHandler:d}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{retry:this.retryRequests},function(c,e){c?a(pc.string.format("Error loading text resource: {0} [{1}]",b.original,c)):a(null,e)})},open:function(b,a){return a},patch:function(b,a){}});return{TextHandler:d}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{responseType:pc.Http.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(c,e){c?a(pc.string.format("Error loading binary resource: {0} [{1}]",b.original,c)):a(null,e)})},open:function(b,a){return a},patch:function(b,a){}});return{BinaryHandler:d}}());Object.assign(pc,function(){var d=function(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)},b=d("DDS "),a=d("DXT1"),c=d("DXT5"),e=d("DX10"),f=d("ETC1"),g=d("P231"),n=d("P241"),k=d("P431"),h=d("P441"),m={};m[116]=pc.PIXELFORMAT_RGBA32F;m[a]=pc.PIXELFORMAT_DXT1;m[c]=pc.PIXELFORMAT_DXT5;m[f]=pc.PIXELFORMAT_ETC1;m[g]=pc.PIXELFORMAT_PVRTC_2BPP_RGB_1;m[n]=pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1;m[k]=pc.PIXELFORMAT_PVRTC_4BPP_RGB_1;m[h]=pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1;
return{DdsParser:function(d){var l=new Uint32Array(d,0,32);if(l[0]!==b)return null;var q=l[1],r=l[2],t=l[3],u=l[4],x=Math.max(l[7],1),v=l[22],y=l[28];if(124!==q)return null;q=4+q;var A=l[21];l[20]&4&&A===e&&(new Uint32Array(d,128,5),q+=20);y=(l=65024===y)?6:1;r=r&131072?x:1;x=[];if(l)for(var z=0;z<r;z++)x.push([]);for(z=0;z<y;z++)for(var E=u,C=t,D=0;D<r;D++){if(A===a||A===c||A===f)var F=Math.floor((E+3)/4)*Math.floor((C+3)/4)*(A===c?16:8);else if(A===g||A===n)F=Math.max(E,16)*Math.max(C,8)/4;else if(A===
k||A===h)F=Math.max(E,8)*Math.max(C,8)/2;else if(32===v)F=E*C*4;else return null;var I=116===A?new Float32Array(d,q,F):new Uint8Array(d,q,F);l?x[D][z]=I:x.push(I);q+=116===A?4*F:F;E=Math.max(.5*E,1);C=Math.max(.5*C,1)}this.format=m[A]||pc.PIXELFORMAT_R8_G8_B8_A8;this.width=u;this.height=t;this.levels=x;this.cubemap=l}}}());Object.assign(pc,function(){var d=[1481919403,3140563232,169478669],b={33776:pc.PIXELFORMAT_DXT1,33778:pc.PIXELFORMAT_DXT3,33779:pc.PIXELFORMAT_DXT5,36196:pc.PIXELFORMAT_ETC1,37492:pc.PIXELFORMAT_ETC2_RGB,37496:pc.PIXELFORMAT_ETC2_RGBA,35840:pc.PIXELFORMAT_PVRTC_4BPP_RGB_1,35841:pc.PIXELFORMAT_PVRTC_2BPP_RGB_1,35842:pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1,35843:pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1};return{KtxParser:function(a){var c=new Uint32Array(a,0,16);if(d[0]!==c[0]||d[1]!==c[1]||d[2]!==c[2])return null;
var e=c[6],f=c[7],g=c[9],n=c[10],k=c[12],h=c[13],m=c[14];if(1<c[11]||1<k||0!==e||!b[f])return null;c=64+c[15];e=[];k=!1;for(var l=0;l<(m||1);l++){var p=(new Uint32Array(a.slice(c,c+4)))[0];c+=4;p/=h||1;1<h&&(k=!0,e.push([]));for(var q=0;q<h;q++){var r=new Uint8Array(a,c,p);1<h?e[l].push(r):e.push(r);c+=p}c+=3-(c+3)%4}this.format=b[f];this.width=g;this.height=n;this.levels=e;this.cubemap=k}}}());Object.assign(pc,function(){var d={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},b={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},a=function(a){var b=Math.log2(Math.max(a._width,a._height))+1,c=function(a){return a instanceof HTMLCanvasElement||a instanceof
HTMLImageElement||a instanceof HTMLVideoElement};if(!(a._format!==pc.PIXELFORMAT_R8_G8_B8_A8&&a._format!==pc.PIXELFORMAT_RGBA32F||a._volume||a._compressed||1===a._levels.length||a._levels.length===b||c(a._cubemap?a._levels[0][0]:a._levels[0]))){c=function(a,b,c){var e=Math.max(1,a>>1),d=Math.max(1,b>>1),f=new c.constructor(e*d*4),g=Math.floor(a/e);b=Math.floor(b/d);for(var h=g*b,k=0;k<d;++k)for(var m=0;m<e;++m)for(var l=0;4>l;++l){for(var n=0,p=0;p<b;++p)for(var q=0;q<g;++q)n+=c[4*(m*g+q+(k*b+p)*
a)+l];f[4*(m+k*e)+l]=n/h}return f};for(var e=a._levels.length;e<b;++e){var d=Math.max(1,a._width>>e-1),h=Math.max(1,a._height>>e-1);if(a._cubemap){for(var m=[],l=0;6>l;++l)m.push(c(d,h,a._levels[e-1][l]));a._levels.push(m)}else a._levels.push(c(d,h,a._levels[e-1]))}a._levelsUpdated=a._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}},c=function(a,b,c){this._device=a;this._assets=b;this._loader=c;this.crossOrigin=void 0;b.prefix&&(this.crossOrigin="anonymous");this.retryRequests=!1};Object.assign(c.prototype,{load:function(a,
b,c){"string"===typeof a&&(a={load:a,original:a});var e=0<=a.original.indexOf("?")?a.original.split("?")[0]:a.original;var d=pc.path.getExtension(e).toLowerCase();if(".dds"===d||".ktx"===d)e={cache:!0,responseType:"arraybuffer",retry:this.retryRequests},pc.http.get(a.load,e,b);else if(".basis"===d)e={cache:!0,responseType:"arraybuffer",retry:this.retryRequests},pc.http.get(a.load,e,function(e,d){if(e)b(e,d);else{if(e="pvr"===pc.basisTargetFormat()&&c&&c.file&&c.file.variants&&c.file.variants.basis&&
0!==(c.file.variants.basis.opt&8))c.file.variants.basis.opt&=-9;pc.basisTranscode(a.load,d,b,{unswizzleGGGR:e})}});else if(".jpg"===d||".jpeg"===d||".gif"===d||".png"===d){if(void 0!==this.crossOrigin&&pc.ABSOLUTE_URL.test(a.original))var f=this.crossOrigin;this._loadImage(a.load,a.original,f,b)}else f=e.indexOf("blob:"),0<=f?(a=e=e.substr(f),this._loadImage(a,a,null,b)):setTimeout(function(){b(pc.string.format("Error loading Texture: format not supported: '{0}'",d))},0)},_loadImage:function(a,b,
c,d){var e=new Image;c&&(e.crossOrigin=c);var f=0,g,l=this.retryRequests;e.onload=function(){d(null,e)};e.onerror=function(){if(!g)if(l&&5>=++f){var c=100*Math.pow(2,f);console.log(pc.string.format("Error loading Texture from: '{0}' - Retrying in {1}ms...",b,c));var h=0<=a.indexOf("?")?"&":"?";g=setTimeout(function(){e.src=a+h+"retry="+Date.now();g=null},c)}else d(pc.string.format("Error loading Texture from: '{0}'",b))};e.src=a},open:function(b,c){if(b){var e=pc.path.getExtension(b).toLowerCase();
if(c instanceof Image||c instanceof HTMLImageElement)e=".jpg"===e||".jpeg"===e?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8,e=new pc.Texture(this._device,{width:c.width,height:c.height,format:e}),e.name=b,e.setSource(c);else if(".dds"===e){var d=this._device;if(".crn"===pc.path.getExtension(b).toLowerCase()){e=c.byteLength;var f=new Uint8Array(c);c=Module._malloc(e);var h=Module.HEAPU8,m,l=c/4,p=e%4,q=new Uint32Array(f.buffer,0,(e-p)/4),r=new Uint32Array(h.buffer);for(m=0;m<q.length;m++)r[l+
m]=q[m];for(m=e-p;m<e;m++)h[c+m]=f[m];f=Module._crn_decompress_get_data(c,e);c=Module._crn_decompress_get_size(c,e);c=Module.HEAPU8.buffer.slice(f,f+c)}var t=new Uint32Array(c,0,32);e=t[4];f=t[3];h=Math.max(t[7],1);var u=t[21],x=t[22];m=65024===t[28];var v=r=q=p=l=!1,y=null;if(4===t[20])if(827611204===u)y=pc.PIXELFORMAT_DXT1,l=!0;else if(894720068===u)y=pc.PIXELFORMAT_DXT5,l=!0;else if(116===u)y=pc.PIXELFORMAT_RGBA32F,p=!0;else if(826496069===u)y=pc.PIXELFORMAT_ETC1,q=l=!0;else if(825438800===u||
825504336===u)y=825438800===u?pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1,r=l=!0;else{if(825439312===u||825504848===u)y=825439312===u?pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1,v=l=!0}else 32===x&&(y=pc.PIXELFORMAT_R8_G8_B8_A8);if(y){d=new pc.Texture(d,{width:e,height:f,format:y,cubemap:m});m&&(d.addressU=pc.ADDRESS_CLAMP_TO_EDGE,d.addressV=pc.ADDRESS_CLAMP_TO_EDGE);t=128;x=m?6:1;u=827611204===u?8:16;for(y=0;y<x;y++)for(var A=e,z=f,E=0;E<h;E++){if(l)if(q)var C=
Math.floor((A+3)/4)*Math.floor((z+3)/4)*8;else if(r)C=Math.max(A,16)*Math.max(z,8)/4;else if(v)C=Math.max(A,8)*Math.max(z,8)/2;else{C=Math.floor((A+4-1)/4);var D=Math.floor((z+4-1)/4);C*=D;C*=u}else C=A*z*4;D=p?new Float32Array(c,t,C):new Uint8Array(c,t,C);m?(d._levels[E]||(d._levels[E]=[]),d._levels[E][y]=D):d._levels[E]=D;t+=p?4*C:C;A=Math.max(.5*A,1);z=Math.max(.5*z,1)}d.name=b;d.upload()}else d=new pc.Texture(d,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8}),d.name="dds-legacy-empty";e=d}else{if(".basis"===
e)f=c;else if(c instanceof ArrayBuffer)switch(e){case ".dds":f=new pc.DdsParser(c);break;case ".ktx":f=new pc.KtxParser(c);break;case ".pvr":console.warn("PVR container not supported.")}if(!f)return e=new pc.Texture(this._device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8}),e.name="unsupported-empty",e;e=new pc.Texture(this._device,{addressU:f.cubemap?pc.ADDRESS_CLAMP_TO_EDGE:pc.ADDRESS_REPEAT,addressV:f.cubemap?pc.ADDRESS_CLAMP_TO_EDGE:pc.ADDRESS_REPEAT,width:f.width,height:f.height,format:f.format,
cubemap:f.cubemap,levels:f.levels});e.name=b;e.upload()}a(e);return e}},patch:function(a,c){if(c=a.resource){c.name!==a.name&&(c.name=a.name);a.data.hasOwnProperty("minfilter")&&c.minFilter!==b[a.data.minfilter]&&(c.minFilter=b[a.data.minfilter]);a.data.hasOwnProperty("magfilter")&&c.magFilter!==b[a.data.magfilter]&&(c.magFilter=b[a.data.magfilter]);a.data.hasOwnProperty("addressu")&&c.addressU!==d[a.data.addressu]&&(c.addressU=d[a.data.addressu]);a.data.hasOwnProperty("addressv")&&c.addressV!==d[a.data.addressv]&&
(c.addressV=d[a.data.addressv]);a.data.hasOwnProperty("mipmaps")&&c.mipmaps!==a.data.mipmaps&&(c.mipmaps=a.data.mipmaps);a.data.hasOwnProperty("anisotropy")&&c.anisotropy!==a.data.anisotropy&&(c.anisotropy=a.data.anisotropy);var e=!!a.data.rgbm;a.data.hasOwnProperty("rgbm")&&c.rgbm!==e&&(c.rgbm=e);a.file&&a.getPreferredFile&&(a=a.getPreferredFile())&&a.opt&&0!==(a.opt&8)&&(c.swizzleGGGR=!0)}}});return{TextureHandler:c}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{retry:this.retryRequests},function(c,e){c?a(pc.string.format("Error loading html resource: {0} [{1}]",b.original,c)):a(null,e)})},open:function(b,a){return a},patch:function(b,a){}});return{HtmlHandler:d}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{retry:this.retryRequests},function(c,e){c?a(pc.string.format("Error loading css resource: {0} [{1}]",b.original,c)):a(null,e)})},open:function(b,a){return a},patch:function(b,a){}});return{CssHandler:d,createStyle:function(b){var a=document.createElement("style");a.type="text/css";a.styleSheet?a.styleSheet.cssText=b:a.appendChild(document.createTextNode(b));
return a}}}());Object.assign(pc,function(){var d=function(){this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{retry:this.retryRequests},function(c,e){c?a(pc.string.format("Error loading shader resource: {0} [{1}]",b.original,c)):a(null,e)})},open:function(b,a){return a},patch:function(b,a){}});return{ShaderHandler:d}}());Object.assign(pc,function(){var d=function(b){this._app=b;this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;pc.http.get(b.load,{retry:this.retryRequests},function(e,d){e?(d="Error while loading scene "+b.original,e.message?(d+=": "+e.message,e.stack&&(d+="\n"+e.stack)):d+=": "+e,a(d)):pc.TemplateUtils.waitForTemplatesInScene(d,c,a)})},open:function(b,a){this._app.systems.script.preloading=!0;b=(new pc.SceneParser(this._app,
!1)).parse(a);var c=this._app.scene;c.root=b;this._app.applySceneSettings(a.settings);this._app.systems.script.preloading=!1;return c},patch:function(b,a){}});return{SceneHandler:d}}());Object.assign(pc,function(){var d=function(b){this._app=b;this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;pc.http.get(b.load,{retry:this.retryRequests},function(e,d){e?(d="Error while loading scene "+b.original,e.message?(d+=": "+e.message,e.stack&&(d+="\n"+e.stack)):d+=": "+e,a(d)):pc.TemplateUtils.waitForTemplatesInScene(d,c,a)})},open:function(b,a){this._app.systems.script.preloading=!0;b=(new pc.SceneParser(this._app,
!1)).parse(a);this._app.systems.script.preloading=!1;return b}});return{HierarchyHandler:d}}());Object.assign(pc,function(){var d=function(b){this._app=b;this.retryRequests=!1};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});pc.http.get(b.load,{retry:this.retryRequests},function(c,e){c?(e="Error while loading scene settings "+b.original,c.message?(e+=": "+c.message,c.stack&&(e+="\n"+c.stack)):e+=": "+c,a(e)):a(null,e)})},open:function(b,a){return a.settings}});return{SceneSettingsHandler:d}}());Object.assign(pc,function(){var d=function(b){this._app=b};Object.assign(d.prototype,{load:function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;pc.http.get(b.load,function(e,d){e?a("Error requesting template: "+b.original):pc.TemplateUtils.waitForTemplateAssets(d.entities,c,a,d)})},open:function(b,a){return new pc.Template(this._app,a)}});return{TemplateHandler:d}}());Object.assign(pc,function(){var d=function(){};Object.assign(d.prototype,{load:function(b,a){a(null,null)},open:function(b,a){return a}});return{FolderHandler:d}}());Object.assign(pc,function(){function d(a){3>a.version&&(2>a.version&&(a.info.maps=a.info.maps||[{width:a.info.width,height:a.info.height}]),a.chars=Object.keys(a.chars||{}).reduce(function(b,e){var c=a.chars[e];e=void 0!==c.letter?c.letter:pc.string.fromCodePoint(e);2>a.version&&(c.map=c.map||0);b[e]=c;return b},{}),a.version=3);return a}var b=function(a){this._loader=a;this.retryRequests=!1};Object.assign(b.prototype,{load:function(a,b,e){"string"===typeof a&&(a={load:a,original:a});var c=this;".json"===
pc.path.getExtension(a.original)?pc.http.get(a.load,{retry:this.retryRequests},function(e,f){var g=d(f);e?b(pc.string.format("Error loading font resource: {0} [{1}]",a.original,e)):c._loadTextures(a.original.replace(".json",".png"),g,function(a,c){if(a)return b(a);b(null,{data:g,textures:c})})}):(e&&e.data&&(e.data=d(e.data)),this._loadTextures(a.original,e&&e.data,b))},_loadTextures:function(a,b,e){var c=b.info.maps.length,d=0,n=null,k=Array(c),h=this._loader;b=function(b){var f=function(a,f){if(!n){if(a)return n=
a,e(a);f.upload();k[b]=f;d++;d===c&&e(null,k)}};0===b?h.load(a,"texture",f):h.load(a.replace(".png",b+".png"),"texture",f)};for(var m=0;m<c;m++)b(m)},open:function(a,b,e){return b.textures?new pc.Font(b.textures,b.data):new pc.Font(b,null)},patch:function(a,b){b=a.resource;!b.data&&a.data?b.data=a.data:!a.data&&b.data&&(a.data=b.data);a.data&&(a.data=d(a.data))}});return{FontHandler:b}}());Object.assign(pc,function(){var d={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},b={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},a=/^data\.frames\.(\d+)$/,c=function(a){this._loader=a;this.retryRequests=!1};Object.assign(c.prototype,{load:function(a,
b){"string"===typeof a&&(a={load:a,original:a});var c=this,e=this._loader.getHandler("texture");if(".json"===pc.path.getExtension(a.original))pc.http.get(a.load,{retry:this.retryRequests},function(e,d){e?b(e):(e=a.original.replace(".json",".png"),c._loader.load(e,"texture",function(a,c){a?b(a):b(null,{data:d,texture:c})}))});else return e.load(a,b)},open:function(a,b){var c=new pc.TextureAtlas;if(b.texture&&b.data)c.texture=b.texture,c.__data=b.data;else{a=this._loader.getHandler("texture").open(a,
b);if(!a)return null;c.texture=a}return c},patch:function(a,c){a.resource.__data&&(void 0!==a.resource.__data.minfilter&&(a.data.minfilter=a.resource.__data.minfilter),void 0!==a.resource.__data.magfilter&&(a.data.magfilter=a.resource.__data.magfilter),void 0!==a.resource.__data.addressu&&(a.data.addressu=a.resource.__data.addressu),void 0!==a.resource.__data.addressv&&(a.data.addressv=a.resource.__data.addressv),void 0!==a.resource.__data.mipmaps&&(a.data.mipmaps=a.resource.__data.mipmaps),void 0!==
a.resource.__data.anisotropy&&(a.data.anisotropy=a.resource.__data.anisotropy),void 0!==a.resource.__data.rgbm&&(a.data.rgbm=!!a.resource.__data.rgbm),a.data.frames=a.resource.__data.frames,delete a.resource.__data);if(c=a.resource.texture){c.name=a.name;a.data.hasOwnProperty("minfilter")&&c.minFilter!==b[a.data.minfilter]&&(c.minFilter=b[a.data.minfilter]);a.data.hasOwnProperty("magfilter")&&c.magFilter!==b[a.data.magfilter]&&(c.magFilter=b[a.data.magfilter]);a.data.hasOwnProperty("addressu")&&c.addressU!==
d[a.data.addressu]&&(c.addressU=d[a.data.addressu]);a.data.hasOwnProperty("addressv")&&c.addressV!==d[a.data.addressv]&&(c.addressV=d[a.data.addressv]);a.data.hasOwnProperty("mipmaps")&&c.mipmaps!==a.data.mipmaps&&(c.mipmaps=a.data.mipmaps);a.data.hasOwnProperty("anisotropy")&&c.anisotropy!==a.data.anisotropy&&(c.anisotropy=a.data.anisotropy);var e=!!a.data.rgbm;a.data.hasOwnProperty("rgbm")&&c.rgbm!==e&&(c.rgbm=e)}a.resource.texture=c;c={};for(var f in a.data.frames)e=a.data.frames[f],c[f]={rect:new pc.Vec4(e.rect),
pivot:new pc.Vec2(e.pivot),border:new pc.Vec4(e.border)};a.resource.frames=c;a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_onAssetChange:function(b,c,d){if("data"===c||"data.frames"===c){var e={};for(f in d.frames)c=d.frames[f],e[f]={rect:new pc.Vec4(c.rect),pivot:new pc.Vec2(c.pivot),border:new pc.Vec4(c.border)};b.resource.frames=e}else if(c=c.match(a)){var f=c[1];d?(b.resource.frames[f]?(c=b.resource.frames[f],c.rect.set(d.rect[0],d.rect[1],d.rect[2],d.rect[3]),
c.pivot.set(d.pivot[0],d.pivot[1]),c.border.set(d.border[0],d.border[1],d.border[2],d.border[3])):b.resource.frames[f]={rect:new pc.Vec4(d.rect),pivot:new pc.Vec2(d.pivot),border:new pc.Vec4(d.border)},b.resource.fire("set:frame",f,b.resource.frames[f])):b.resource.frames[f]&&(delete b.resource.frames[f],b.resource.fire("remove:frame",f))}}});return{TextureAtlasHandler:c}}());Object.assign(pc,function(){var d=function(a,b){this._assets=a;this._device=b;this.retryRequests=!1},b=function(a){this.resource&&(this.resource.atlas=a.resource)},a=function(a){this.registry.load(a)};Object.assign(d.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});".json"===pc.path.getExtension(a.original)&&pc.http.get(a.load,{retry:this.retryRequests},function(a,c){a?b(a):b(null,c)})},open:function(a,b){var c=new pc.Sprite(this._device);a&&(c.__data=b);return c},patch:function(a,
b){var c=a.resource;c.__data&&(a.data.pixelsPerUnit=c.__data.pixelsPerUnit,a.data.renderMode=c.__data.renderMode,a.data.frameKeys=c.__data.frameKeys,c.__data.textureAtlasAsset&&((b=b.getByUrl(c.__data.textureAtlasAsset))?a.data.textureAtlasAsset=b.id:console.warn("Could not find textureatlas with url: "+c.__data.textureAtlasAsset)));c.startUpdate();c.renderMode=a.data.renderMode;c.pixelsPerUnit=a.data.pixelsPerUnit;c.frameKeys=a.data.frameKeys;this._updateAtlas(a);c.endUpdate();a.off("change",this._onAssetChange,
this);a.on("change",this._onAssetChange,this)},_updateAtlas:function(c){var e=c.resource;if(c.data.textureAtlasAsset){this._assets.off("load:"+c.data.textureAtlasAsset,b,c);this._assets.on("load:"+c.data.textureAtlasAsset,b,c);var d=this._assets.get(c.data.textureAtlasAsset);d&&d.resource?e.atlas=d.resource:d?this._assets.load(d):(this._assets.off("add:"+c.data.textureAtlasAsset,a,c),this._assets.on("add:"+c.data.textureAtlasAsset,a,c))}else e.atlas=null},_onAssetChange:function(c,e,d,g){"data"===
e&&d&&d.textureAtlasAsset&&g&&d.textureAtlasAsset!==g.textureAtlasAsset&&(this._assets.off("load:"+g.textureAtlasAsset,b,c),this._assets.off("add:"+g.textureAtlasAsset,a,c))}});return{SpriteHandler:d}}());Object.assign(pc,function(){var d={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},b={int8:pc.TYPE_INT8,uint8:pc.TYPE_UINT8,int16:pc.TYPE_INT16,uint16:pc.TYPE_UINT16,int32:pc.TYPE_INT32,uint32:pc.TYPE_UINT32,float32:pc.TYPE_FLOAT32},a=function(a){this._device=a;this._defaultMaterial=pc.getDefaultMaterial()};Object.assign(a.prototype,
{parse:function(a){var b=a.model;if(!b||1>=b.version)return null;b=this._parseNodes(a);var c=this._parseSkins(a,b),d=this._parseMorphs(a,b),n=this._parseVertexBuffers(a),k=this._parseIndexBuffers(a,n);k=this._parseMeshes(a,c.skins,d.morphs,n,k.buffer,k.data);this._initMorphs(a,d.morphs,n,k);a=this._parseMeshInstances(a,b,k,c.skins,c.instances,d.morphs,d.instances);n=new pc.Model;n.graph=b[0];n.meshInstances=a;n.skinInstances=c.instances;n.morphInstances=d.instances;n.getGraph().syncHierarchy();return n},
_parseNodes:function(a){a=a.model;var b=[],c;for(c=0;c<a.nodes.length;c++){var d=a.nodes[c],n=new pc.GraphNode(d.name);n.setLocalPosition(d.position[0],d.position[1],d.position[2]);n.setLocalEulerAngles(d.rotation[0],d.rotation[1],d.rotation[2]);n.setLocalScale(d.scale[0],d.scale[1],d.scale[2]);n.scaleCompensation=!!d.scaleCompensation;b.push(n)}for(c=1;c<a.parents.length;c++)b[a.parents[c]].addChild(b[c]);return b},_parseSkins:function(a,b){a=a.model;var c=[],e=[],d;if(!this._device.supportsBoneTextures&&
0<a.skins.length){var k=this._device.getBoneLimit();pc.partitionSkin(a,null,k)}for(k=0;k<a.skins.length;k++){var h=a.skins[k],m=[];for(d=0;d<h.inverseBindMatrices.length;d++){var l=h.inverseBindMatrices[d];m[d]=(new pc.Mat4).set(l)}h=new pc.Skin(this._device,m,h.boneNames);c.push(h);m=new pc.SkinInstance(h);l=[];for(d=0;d<h.boneNames.length;d++){var p=b[0].findByName(h.boneNames[d]);l.push(p)}m.bones=l;e.push(m)}return{skins:c,instances:e}},_parseMorphs:function(a,b){a=a.model;b=[];var c=[],e,d;if(a.morphs)for(e=
0;e<a.morphs.length;e++){var k=a.morphs[e].targets;var h=[];for(d=0;d<k.length;d++){var m=k[d].aabb;var l=m.min;m=m.max;l=new pc.BoundingBox(new pc.Vec3(.5*(m[0]+l[0]),.5*(m[1]+l[1]),.5*(m[2]+l[2])),new pc.Vec3(.5*(m[0]-l[0]),.5*(m[1]-l[1]),.5*(m[2]-l[2])));l=new pc.MorphTarget({indices:k[d].indices,deltaPositions:k[d].deltaPositions,deltaNormals:k[d].deltaNormals,name:k[d].name,aabb:l});h.push(l)}d=new pc.Morph(h);b.push(d);d=new pc.MorphInstance(d);c.push(d)}return{morphs:b,instances:c}},_calculateTangentsMorphTarget:function(a,
b,d,g,n,k,h,m){var c;var e=g.length/3;for(c=0;c<e;c++){var f=g[3*c];var r=g[3*c+1];var t=g[3*c+2];var u=a[3*f];var x=a[3*f+1];var v=a[3*f+2];var y=a[3*r];var A=a[3*r+1];var z=a[3*r+2];var E=a[3*t];var C=a[3*t+1];var D=a[3*t+2];var F=d[2*f];var I=d[2*f+1];var G=d[2*r];var B=d[2*r+1];var w=d[2*t];var H=d[2*t+1];y-=u;u=E-u;A-=x;x=C-x;z-=v;v=D-v;G-=F;F=w-F;B-=I;D=H-I;I=G*D-F*B;0==I?(I=0,H=1,B=0,y=1,v=x=0):(w=1/I,I=(D*y-B*u)*w,H=(D*A-B*x)*w,B=(D*z-B*v)*w,y=(G*u-F*y)*w,x=(G*x-F*A)*w,v=(G*v-F*z)*w);n[3*
f]+=I;n[3*f+1]+=H;n[3*f+2]+=B;n[3*r]+=I;n[3*r+1]+=H;n[3*r+2]+=B;n[3*t]+=I;n[3*t+1]+=H;n[3*t+2]+=B;k[3*f]+=y;k[3*f+1]+=x;k[3*f+2]+=v;k[3*r]+=y;k[3*r+1]+=x;k[3*r+2]+=v;k[3*t]+=y;k[3*t+1]+=x;k[3*t+2]+=v}I=h.length;for(t=0;t<I;t++)c=h[t],z=b[3*c],H=b[3*c+1],A=b[3*c+2],a=n[3*c],d=n[3*c+1],g=n[3*c+2],e=k[3*c],f=k[3*c+1],r=k[3*c+2],v=z*a+H*d+A*g,u=z*v,x=H*v,v*=A,y=H*g-d*A,A=A*a-g*z,z=z*d-a*H,a-=u,d-=x,g-=v,v=1/Math.sqrt(a*a+d*d+g*g),a*=v,d*=v,g*=v,m[4*c]=a,m[4*c+1]=d,m[4*c+2]=g,m[4*c+3]=0>y*e+A*f+z*r?-1:
1;return m},_initMorphs:function(a,b,d,g){a=a.model;var c,e,f,m=[],l=[];for(d=0;d<g.length;d++){var p=a.meshes[d].vertices;if(!l[p]){var q=a.vertices[p];if(q.tangent){var r=new Float32Array(q.tangent.data);l[p]=!0;if(q.position&&q.normal&&q.texCoord0){var t=[];for(c=0;c<a.meshes.length;c++)a.meshes[c].vertices===p&&(t=t.concat(a.meshes[c].indices));p=q.position.data;var u=q.normal.data;var x=q.texCoord0.data;var v=p.length/3;var y=t.length;var A=new Float32Array(4*v),z=new Float32Array(3*v),E=new Float32Array(3*
v);var C=new Float32Array(3*v);C.set(p);var D=new Float32Array(3*v);D.set(u);for(c=0;c<b.length;c++)if(a.meshes[d].morph===c)for(e=0;e<b[c]._targets.length;e++){q=b[c]._targets[e];var F=q.indices,I=F.length;if(0!==I){q.deltaTangents=new Float32Array(4*I);if(!G||G.length<v)var G=new Uint8Array(v);else for(f=0;f<v;f++)G[f]=0;for(f=0;f<I;f++){var B=F[f];G[B]=1}var w=0;for(f=0;f<y;f+=3){B=t[f];var H=t[f+1];var M=t[f+2];if(G[B]||G[H]||G[M])m[w]=B,m[w+1]=H,m[w+2]=M,w+=3}m.length=w;H=q.deltaPositions;M=
q.deltaNormals;for(f=0;f<I;f++)B=F[f],C[3*B]+=H[3*f],C[3*B+1]+=H[3*f+1],C[3*B+2]+=H[3*f+2],D[3*B]+=M[3*f],D[3*B+1]+=M[3*f+1],D[3*B+2]+=M[3*f+2];this._calculateTangentsMorphTarget(C,D,x,m,z,E,F,A);H=q.deltaTangents;for(f=0;f<I;f++)B=F[f],H[4*f]=A[4*f]-r[4*B],H[4*f+1]=A[4*f+1]-r[4*B+1],H[4*f+2]=A[4*f+2]-r[4*B+2],H[4*f+3]=A[4*f+3]-r[4*B+3];if(e!==b[c]._targets.length-1){for(f=0;f<y;f+=3)B=t[f],H=t[f+1],M=t[f+2],z[3*B]=0,z[3*B+1]=0,z[3*B+2]=0,z[3*H]=0,z[3*H+1]=0,z[3*H+2]=0,z[3*M]=0,z[3*M+1]=0,z[3*M+2]=
0,E[3*B]=0,E[3*B+1]=0,E[3*B+2]=0,E[3*H]=0,E[3*H+1]=0,E[3*H+2]=0,E[3*M]=0,E[3*M+1]=0,E[3*M+2]=0;for(f=0;f<I;f++)B=q.indices[f],C[3*B]=p[3*B],C[3*B+1]=p[3*B+1],C[3*B+2]=p[3*B+2],D[3*B]=u[3*B],D[3*B+1]=u[3*B+1],D[3*B+2]=u[3*B+2]}}}}}}}},_parseVertexBuffers:function(a){a=a.model;var c=[],d,g={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,
texCoord1:pc.SEMANTIC_TEXCOORD1,texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7},n,k;for(n=0;n<a.vertices.length;n++){var h=a.vertices[n],m=[];for(d in h){var l=h[d];m.push({semantic:g[d],components:l.components,type:b[l.type],normalize:g[d]===pc.SEMANTIC_COLOR})}l=new pc.VertexFormat(this._device,m);m=h.position.data.length/h.position.components;var p=new pc.VertexBuffer(this._device,
l,m),q=new pc.VertexIterator(p);for(k=0;k<m;k++){for(d in h)switch(l=h[d],l.components){case 1:q.element[g[d]].set(l.data[k]);break;case 2:q.element[g[d]].set(l.data[2*k],l.data[2*k+1]);break;case 3:q.element[g[d]].set(l.data[3*k],l.data[3*k+1],l.data[3*k+2]);break;case 4:q.element[g[d]].set(l.data[4*k],l.data[4*k+1],l.data[4*k+2],l.data[4*k+3])}q.next()}q.end();c.push(p)}return c},_parseIndexBuffers:function(a,b){var c=a.model,e=a=null,d,k=0;for(d=0;d<c.meshes.length;d++){var h=c.meshes[d];void 0!==
h.indices&&(k+=h.indices.length)}for(d=c=0;d<b.length;d++)c=Math.max(c,b[d].numVertices);0<k&&(65535<c&&this._device.extUintElement?(a=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT32,k),e=new Uint32Array(a.lock())):(a=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,k),e=new Uint16Array(a.lock())));return{buffer:a,data:e}},_parseMeshes:function(a,b,f,g,n,k){a=a.model;var c=[],e=0,l;for(l=0;l<a.meshes.length;l++){var p=a.meshes[l],q=p.aabb,r=q.min;q=q.max;r=new pc.BoundingBox(new pc.Vec3(.5*
(q[0]+r[0]),.5*(q[1]+r[1]),.5*(q[2]+r[2])),new pc.Vec3(.5*(q[0]-r[0]),.5*(q[1]-r[1]),.5*(q[2]-r[2])));q=void 0!==p.indices;var t=new pc.Mesh(this._device);t.vertexBuffer=g[p.vertices];t.indexBuffer[0]=q?n:null;t.primitive[0].type=d[p.type];t.primitive[0].base=q?p.base+e:p.base;t.primitive[0].count=p.count;t.primitive[0].indexed=q;t.skin=void 0!==p.skin?b[p.skin]:null;t.morph=void 0!==p.morph?f[p.morph]:null;t.aabb=r;q&&(k.set(p.indices,e),e+=p.indices.length);c.push(t)}null!==n&&n.unlock();return c},
_parseMeshInstances:function(a,b,d,g,n,k,h){a=a.model;var c=[],e;for(e=0;e<a.meshInstances.length;e++){var f=a.meshInstances[e],q=d[f.mesh];f=new pc.MeshInstance(b[f.node],q,this._defaultMaterial);if(q.skin){var r=g.indexOf(q.skin);f.skinInstance=n[r]}q.morph&&(q=k.indexOf(q.morph),f.morphInstance=h[q]);c.push(f)}return c}});return{JsonModelParser:a}}());Object.assign(pc,function(){var d=function(a){switch(a){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":return 3;case "VEC4":return 4;case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16;default:return 3}},b=function(a){switch(a){case 5120:return pc.TYPE_INT8;case 5121:return pc.TYPE_UINT8;case 5122:return pc.TYPE_INT16;case 5123:return pc.TYPE_UINT16;case 5124:return pc.TYPE_INT32;case 5125:return pc.TYPE_UINT32;case 5126:return pc.TYPE_FLOAT32;default:return 0}},a=function(a){switch(a){case 5120:return 1;
case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},c=function(a,b,c){if(a.hasOwnProperty("sparse")){var e=a.sparse.values.bufferView;var f=a.sparse.count}else e=a.bufferView,f=a.count;b=b[e];c=c[b.buffer];e=a.hasOwnProperty("byteOffset")?a.byteOffset:0;b=b.hasOwnProperty("byteOffset")?b.byteOffset:0;b=c.byteOffset+e+b;f*=d(a.type);switch(a.componentType){case 5120:return new Int8Array(c.buffer,b,f);case 5121:return new Uint8Array(c.buffer,
b,f);case 5122:return new Int16Array(c.buffer,b,f);case 5123:return new Uint16Array(c.buffer,b,f);case 5124:return new Int32Array(c.buffer,b,f);case 5125:return new Uint32Array(c.buffer,b,f);case 5126:return new Float32Array(c.buffer,b,f);default:return null}},e=function(a,b,c){b=b[a.sparse.indices.bufferView];c=c[b.buffer];b=b.hasOwnProperty("byteOffset")?b.byteOffset:0;b=c.byteOffset+b;var e=a.sparse.count;switch(a.sparse.indices.componentType){case 5120:return new Int8Array(c.buffer,b,e);case 5121:return new Uint8Array(c.buffer,
b,e);case 5122:return new Int16Array(c.buffer,b,e);case 5123:return new Uint16Array(c.buffer,b,e);case 5124:return new Int32Array(c.buffer,b,e);case 5125:return new Uint32Array(c.buffer,b,e);case 5126:return new Float32Array(c.buffer,b,e);default:return null}},f=function(a){if(!a.hasOwnProperty("mode"))return pc.PRIMITIVE_TRIANGLES;switch(a.mode){case 0:return pc.PRIMITIVE_POINTS;case 1:return pc.PRIMITIVE_LINES;case 2:return pc.PRIMITIVE_LINELOOP;case 3:return pc.PRIMITIVE_LINESTRIP;case 4:return pc.PRIMITIVE_TRIANGLES;
case 5:return pc.PRIMITIVE_TRISTRIP;case 6:return pc.PRIMITIVE_TRIFAN;default:return pc.PRIMITIVE_TRIANGLES}},g=function(a,b,c,e,d){if(!d){d=new Uint16Array(e);for(var f=0;f<e;f++)d[f]=f}c=pc.calculateNormals(c,d);d=new Float32Array(c.length);d.set(c);b.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32});a[pc.SEMANTIC_NORMAL]={buffer:d.buffer,size:12,offset:0,stride:12,count:e}},n=function(a,b,c,e,d){var f=[pc.SEMANTIC_POSITION,pc.SEMANTIC_NORMAL,pc.SEMANTIC_TANGENT,pc.SEMANTIC_BINORMAL,
pc.SEMANTIC_COLOR,pc.SEMANTIC_BLENDINDICES,pc.SEMANTIC_BLENDWEIGHT,pc.SEMANTIC_TEXCOORD0,pc.SEMANTIC_TEXCOORD1];c.sort(function(a,b){a=f.indexOf(a.semantic);b=f.indexOf(b.semantic);return a<b?-1:b<a?1:0});a=new pc.VertexBuffer(a,new pc.VertexFormat(a,c),b,pc.BUFFER_STATIC);var g,h=!0;for(c=0;c<a.format.elements.length;++c){var k=a.format.elements[c];var m=d[k.name];var l=m.offset-e.offset;if(m.buffer!==e.buffer||m.stride!==k.stride||m.size!==k.size||l!==k.offset){h=!1;break}}c=a.lock();l=new Uint32Array(c);
if(h)e=new Uint32Array(e.buffer,e.offset,b*a.format.size/4),l.set(e);else for(c=0;c<a.format.elements.length;++c){k=a.format.elements[c];h=k.stride/4;m=d[k.name];e=new Uint32Array(m.buffer,m.offset,m.count*m.stride/4);var n=m.stride/4;var p=0,q=k.offset/4;for(k=0;k<b;++k){for(g=0;g<m.size/4;++g)l[q+g]=e[p+g];p+=n;q+=h}}a.unlock();return a},k=function(e,f,h,k,m,l,p){var q=[],r={};for(y in f)if(f.hasOwnProperty(y)){var t=k[f[y]],u=m[t.bufferView];if(p.hasOwnProperty(y)){var w=p[y].semantic;q.push({semantic:w,
components:d(t.type),type:b(t.componentType),normalize:t.normalized});var v=d(t.type)*a(t.componentType),x=l[u.buffer];r[w]={buffer:x.buffer,size:v,offset:(t.hasOwnProperty("byteOffset")?t.byteOffset:0)+(u.hasOwnProperty("byteOffset")?u.byteOffset:0)+x.byteOffset,stride:u.hasOwnProperty("byteStride")?u.byteStride:v,count:t.count}}}p=r[pc.SEMANTIC_POSITION];var y=p.count;r.hasOwnProperty(pc.SEMANTIC_NORMAL)||(f=c(k[f.POSITION],m,l),g(r,q,f,y,h));return n(e,y,q,p,r)},h=function(a,b,c,e,d,f,h){var k=
b.num_points(),m=[],l={};c=c.attributes;for(var p in c)if(c.hasOwnProperty(p)&&f.hasOwnProperty(p)){var q=f[p].semantic;var r=e.GetAttributeByUniqueId(b,c[p]);var t=k*r.num_components();switch(r.data_type()){case d.DT_UINT8:var u=pc.TYPE_UINT8;var w=1;var v=d._malloc(t*w);e.GetAttributeDataArrayForAllPoints(b,r,d.DT_UINT8,t*w,v);t=(new Uint8Array(d.HEAPU8.buffer,v,t)).slice();break;case d.DT_UINT16:u=pc.TYPE_UINT16;w=2;v=d._malloc(t*w);e.GetAttributeDataArrayForAllPoints(b,r,d.DT_UINT16,t*w,v);t=
(new Uint16Array(d.HEAPU16.buffer,v,t)).slice();break;default:u=pc.TYPE_FLOAT32,w=4,v=d._malloc(t*w),e.GetAttributeDataArrayForAllPoints(b,r,d.DT_FLOAT32,t*w,v),t=(new Float32Array(d.HEAPF32.buffer,v,t)).slice()}d._free(v);v=t;t=r.num_components();r=r.normalized();m.push({semantic:q,components:t,type:u,normalize:r});r=t*w;l[q]={values:v,buffer:v.buffer,size:r,offset:0,stride:r,count:k}}b=l[pc.SEMANTIC_POSITION];e=b.count;l.hasOwnProperty(pc.SEMANTIC_NORMAL)||g(l,m,b.values,e,h);return n(a,e,m,b,l)},
m=new pc.Mat4,l=new pc.Vec3,p=function(a,b,d,g,m,l){var n=[],p={POSITION:{semantic:pc.SEMANTIC_POSITION},NORMAL:{semantic:pc.SEMANTIC_NORMAL},TANGENT:{semantic:pc.SEMANTIC_TANGENT},BINORMAL:{semantic:pc.SEMANTIC_BINORMAL},COLOR_0:{semantic:pc.SEMANTIC_COLOR},JOINTS_0:{semantic:pc.SEMANTIC_BLENDINDICES},WEIGHTS_0:{semantic:pc.SEMANTIC_BLENDWEIGHT},TEXCOORD_0:{semantic:pc.SEMANTIC_TEXCOORD0},TEXCOORD_1:{semantic:pc.SEMANTIC_TEXCOORD1}};b.primitives.forEach(function(q){var r=null,t=new pc.Mesh(a);if(q.hasOwnProperty("extensions")){var u=
q.extensions;if(u.hasOwnProperty("KHR_draco_mesh_compression")){var w=window.DracoDecoderModule;if(w&&(u=u.KHR_draco_mesh_compression,u.hasOwnProperty("attributes"))){var v=g[u.bufferView],x=m[v.buffer];x=new Uint8Array(x.buffer,x.byteOffset+v.byteOffset,v.byteLength);v=new w.DecoderBuffer;v.Init(x,x.length);x=new w.Decoder;var y=x.GetEncodedGeometryType(v);switch(y){case w.POINT_CLOUD:var A=pc.PRIMITIVE_POINTS;var B=new w.PointCloud;var z=x.DecodeBufferToPointCloud(v,B);break;case w.TRIANGULAR_MESH:A=
pc.PRIMITIVE_TRIANGLES,B=new w.Mesh,z=x.DecodeBufferToMesh(v,B)}if(!z||!z.ok()||0==B.ptr){l("Failed to decode draco compressed asset: "+(z?z.error_msg():"Mesh asset - invalid draco compressed geometry type: "+y));return}z=B.num_faces();if(y==w.TRIANGULAR_MESH){r=65535<B.num_points();y=3*z;var M=y*(r?4:2);z=w._malloc(M);r?(x.GetTrianglesUInt32Array(B,M,z),r=(new Uint32Array(w.HEAPU32.buffer,z,y)).slice()):(x.GetTrianglesUInt16Array(B,M,z),r=(new Uint16Array(w.HEAPU16.buffer,z,y)).slice());w._free(z)}y=
h(a,B,u,x,w,p,r);w.destroy(B);w.destroy(x);w.destroy(v)}}}y||(r=q.hasOwnProperty("indices")?c(d[q.indices],g,m):null,y=k(a,q.attributes,r,d,g,m,p),A=f(q));t.vertexBuffer=y;t.primitive[0].type=A;t.primitive[0].base=0;t.primitive[0].indexed=null!==r;null!==r?(A=new pc.IndexBuffer(a,r instanceof Uint8Array?pc.INDEXFORMAT_UINT8:r instanceof Uint16Array?pc.INDEXFORMAT_UINT16:pc.INDEXFORMAT_UINT32,r.length,pc.BUFFER_STATIC,r),t.indexBuffer[0]=A,t.primitive[0].count=r.length):t.primitive[0].count=y.numVertices;
t.materialIndex=q.material;var H=d[q.attributes.POSITION];A=H.min;w=H.max;A=new pc.BoundingBox(new pc.Vec3((w[0]+A[0])/2,(w[1]+A[1])/2,(w[2]+A[2])/2),new pc.Vec3((w[0]-A[0])/2,(w[1]-A[1])/2,(w[2]-A[2])/2));t.aabb=A;if(q.hasOwnProperty("targets")){var R=[];q.targets.forEach(function(a,f){var h={};a.hasOwnProperty("POSITION")&&(H=d[a.POSITION],h.deltaPositions=c(H,g,m),H.hasOwnProperty("min")&&H.hasOwnProperty("max")&&(h.aabb=new pc.BoundingBox,h.aabb.setMinMax(new pc.Vec3(H.min),new pc.Vec3(H.max))),
H.sparse&&(h.indices=e(H,g,m)));a.hasOwnProperty("NORMAL")&&(H=d[a.NORMAL],h.deltaNormals=c(H,g,m));b.hasOwnProperty("extras")&&b.extras.hasOwnProperty("targetNames")?h.name=b.extras.targetNames[f]:h.name=R.length.toString(10);R.push(new pc.MorphTarget(h))});t.morph=new pc.Morph(R);if(b.hasOwnProperty("weights"))for(q=0;q<b.weights.length;++q)R[q].defaultWeight=b.weights[q]}n.push(t)});return n},q={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},r=function(a,b,c,e){var d=function(a){switch(a){case 9728:return pc.FILTER_NEAREST;
case 9729:return pc.FILTER_LINEAR;case 9984:return pc.FILTER_NEAREST_MIPMAP_NEAREST;case 9985:return pc.FILTER_LINEAR_MIPMAP_NEAREST;case 9986:return pc.FILTER_NEAREST_MIPMAP_LINEAR;case 9987:return pc.FILTER_LINEAR_MIPMAP_LINEAR;default:return pc.FILTER_LINEAR}},f=function(a){switch(a){case 33071:return pc.ADDRESS_CLAMP_TO_EDGE;case 33648:return pc.ADDRESS_MIRRORED_REPEAT;case 10497:return pc.ADDRESS_REPEAT;default:return pc.ADDRESS_REPEAT}};c=c?c[b.sampler]:q;d={name:b.name,minFilter:d(c.minFilter),
magFilter:d(c.magFilter),addressU:f(c.wrapS),addressV:f(c.wrapT),flipY:!1};a=new pc.Texture(a,d);a.setSource(e[b.source]);return a},t=function(a,b,e,f,g,h){var k=function(a){var b=c(a,f,h);return new pc.AnimData(d(a.type),new b.constructor(b))},m={STEP:pc.INTERPOLATION_STEP,LINEAR:pc.INTERPOLATION_LINEAR,CUBICSPLINE:pc.INTERPOLATION_CUBIC},l={},n=[],p={},q=[],r=[],t;for(t=0;t<a.samplers.length;++t){var u=a.samplers[t];l.hasOwnProperty(u.input)||(l[u.input]=n.length,n.push(k(e[u.input])));p.hasOwnProperty(u.output)||
(p[u.output]=q.length,q.push(k(e[u.output])));var w=u.hasOwnProperty("interpolation")&&m.hasOwnProperty(u.interpolation)?m[u.interpolation]:pc.INTERPOLATION_LINEAR;r.push(new pc.AnimCurve([],l[u.input],p[u.output],w))}e=[];for(t=0;t<a.channels.length;++t)m=a.channels[t],k=m.target,m=r[m.sampler],m._paths.push(pc.AnimBinder.joinPath([g[k.node].name,k.path])),k.path.startsWith("rotation")&&m.interpolation!==pc.INTERPOLATION_CUBIC?e.push(m.output):k.path.startsWith("weights")&&(q[m.output]._components=
q[m.output].data.length/n[m.input].data.length);e.sort();k=null;for(t=0;t<e.length;++t)if(g=e[t],0===t||g!==k){k=q[g];if(4===k.components)for(k=k.data,m=k.length-4,l=0;l<m;l+=4)0>k[l+0]*k[l+4]+k[l+1]*k[l+5]+k[l+2]*k[l+6]+k[l+3]*k[l+7]&&(k[l+4]*=-1,k[l+5]*=-1,k[l+6]*=-1,k[l+7]*=-1);k=g}t=n.reduce(function(a,b){b=b._data;return Math.max(a,0===b.length?0:b[b.length-1])},0);return new pc.AnimTrack(a.hasOwnProperty("name")?a.name:"animation_"+b,t,n,q,r)},u=function(a,b){var c=new pc.GraphNode;a.hasOwnProperty("name")?
c.name=a.name:c.name="node_"+b;a.hasOwnProperty("matrix")&&(m.data.set(a.matrix),m.getTranslation(l),c.setLocalPosition(l),m.getEulerAngles(l),c.setLocalEulerAngles(l),m.getScale(l),c.setLocalScale(l));a.hasOwnProperty("rotation")&&(b=a.rotation,c.setLocalRotation(b[0],b[1],b[2],b[3]));a.hasOwnProperty("translation")&&(b=a.translation,c.setLocalPosition(b[0],b[1],b[2]));a.hasOwnProperty("scale")&&(a=a.scale,c.setLocalScale(a[0],a[1],a[2]));return c},x=function(a,b,e,d){return b.hasOwnProperty("skins")&&
0!==b.skins.length?b.skins.map(function(f){var g=b.accessors,h=b.bufferViews,k,m=f.joints,l=m.length,n=[];if(f.hasOwnProperty("inverseBindMatrices")){h=c(g[f.inverseBindMatrices],h,d);var p=[];for(g=0;g<l;g++){for(k=0;16>k;k++)p[k]=h[16*g+k];k=new pc.Mat4;k.set(p);n.push(k)}}else for(g=0;g<l;g++)k=new pc.Mat4,n.push(k);h=[];for(g=0;g<l;g++)h[g]=e[m[g]].name;f=f.skeleton;n=new pc.Skin(a,n,h);n.skeleton=e[f];n.bones=[];for(g=0;g<m.length;g++)n.bones[g]=e[m[g]];return n}):[]},v=function(a,b,c,e){return b.hasOwnProperty("meshes")&&
0!==b.meshes.length&&b.hasOwnProperty("accessors")&&0!==b.accessors.length&&b.hasOwnProperty("bufferViews")&&0!==b.bufferViews.length?b.meshes.map(function(d){return p(a,d,b.accessors,b.bufferViews,c,e)}):[]},y=function(a,b){return a.hasOwnProperty("materials")&&0!==a.materials.length?a.materials.map(function(a){var c=new pc.StandardMaterial;c.occludeSpecular=!0;c.diffuseTint=!0;c.diffuseVertexColor=!0;c.specularTint=!0;c.specularVertexColor=!0;a.hasOwnProperty("name")&&(c.name=a.name);if(a.hasOwnProperty("extensions")&&
a.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var e=a.extensions.KHR_materials_pbrSpecularGlossiness;if(e.hasOwnProperty("diffuseFactor")){var d=e.diffuseFactor;c.diffuse.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2));c.opacity=null!=d[3]?d[3]:1}else c.diffuse.set(1,1,1),c.opacity=1;if(e.hasOwnProperty("diffuseTexture")){var f=e.diffuseTexture;d=b[f.index];c.diffuseMap=d;c.diffuseMapChannel="rgb";c.opacityMap=d;c.opacityMapChannel="a";f.hasOwnProperty("texCoord")&&
(c.diffuseMapUv=f.texCoord,c.opacityMapUv=f.texCoord);f.hasOwnProperty("extensions")&&f.extensions.hasOwnProperty("KHR_texture_transform")&&(d=f.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.diffuseMapTiling=new pc.Vec2(d.scale[0],d.scale[1]),c.opacityMapTiling=new pc.Vec2(d.scale[0],d.scale[1])),d.hasOwnProperty("offset")&&(c.diffuseMapOffset=new pc.Vec2(d.offset[0],d.offset[1]),c.opacityMapOffset=new pc.Vec2(d.offset[0],d.offset[1])))}c.useMetalness=!1;e.hasOwnProperty("specularFactor")?
(d=e.specularFactor,c.specular.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2))):c.specular.set(1,1,1);e.hasOwnProperty("glossinessFactor")?c.shininess=100*e.glossinessFactor:c.shininess=100;e.hasOwnProperty("specularGlossinessTexture")&&(d=e.specularGlossinessTexture,c.specularMap=b[d.index],c.specularMapChannel="rgb",c.glossMap=b[d.index],c.glossMapChannel="a",d.hasOwnProperty("texCoord")&&(c.glossMapUv=d.texCoord,c.metalnessMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")&&
(d=d.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.glossMapTiling=new pc.Vec2(d.scale[0],d.scale[1]),c.metalnessMapTiling=new pc.Vec2(d.scale[0],d.scale[1])),d.hasOwnProperty("offset")&&(c.glossMapOffset=new pc.Vec2(d.offset[0],d.offset[1]),c.metalnessMapOffset=new pc.Vec2(d.offset[0],d.offset[1]))));c.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n\n    #ifdef MAPTEXTURE\n        vec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n        dSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n    #endif\n\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n}"}else a.hasOwnProperty("pbrMetallicRoughness")&&
(e=a.pbrMetallicRoughness,e.hasOwnProperty("baseColorFactor")?(d=e.baseColorFactor,c.diffuse.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2)),c.opacity=d[3]):(c.diffuse.set(1,1,1),c.opacity=1),e.hasOwnProperty("baseColorTexture")&&(f=e.baseColorTexture,d=b[f.index],c.diffuseMap=d,c.diffuseMapChannel="rgb",c.opacityMap=d,c.opacityMapChannel="a",f.hasOwnProperty("texCoord")&&(c.diffuseMapUv=f.texCoord,c.opacityMapUv=f.texCoord),f.hasOwnProperty("extensions")&&f.extensions.hasOwnProperty("KHR_texture_transform")&&
(d=f.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.diffuseMapTiling=new pc.Vec2(d.scale[0],d.scale[1]),c.opacityMapTiling=new pc.Vec2(d.scale[0],d.scale[1])),d.hasOwnProperty("offset")&&(c.diffuseMapOffset=new pc.Vec2(d.offset[0],d.offset[1]),c.opacityMapOffset=new pc.Vec2(d.offset[0],d.offset[1])))),c.useMetalness=!0,e.hasOwnProperty("metallicFactor")?c.metalness=e.metallicFactor:c.metalness=1,e.hasOwnProperty("roughnessFactor")?c.shininess=100*e.roughnessFactor:c.shininess=100,
e.hasOwnProperty("metallicRoughnessTexture")&&(d=e.metallicRoughnessTexture,c.metalnessMap=b[d.index],c.metalnessMapChannel="b",c.glossMap=b[d.index],c.glossMapChannel="g",d.hasOwnProperty("texCoord")&&(c.glossMapUv=d.texCoord,c.metalnessMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")&&(d=d.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.glossMapTiling=new pc.Vec2(d.scale[0],d.scale[1]),c.metalnessMapTiling=new pc.Vec2(d.scale[0],
d.scale[1])),d.hasOwnProperty("offset")&&(c.glossMapOffset=new pc.Vec2(d.offset[0],d.offset[1]),c.metalnessMapOffset=new pc.Vec2(d.offset[0],d.offset[1])))),c.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n    dGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n    dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n    dGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n    dGlossiness = 1.0 - dGlossiness;\n\n    dGlossiness += 0.0000001;\n}");
a.hasOwnProperty("normalTexture")&&(d=a.normalTexture,c.normalMap=b[d.index],d.hasOwnProperty("texCoord")&&(c.normalMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")&&(e=d.extensions.KHR_texture_transform,e.hasOwnProperty("scale")&&(c.normalMapTiling=new pc.Vec2(e.scale[0],e.scale[1])),e.hasOwnProperty("offset")&&(c.normalMapOffset=new pc.Vec2(e.offset[0],e.offset[1]))),d.hasOwnProperty("scale")&&(c.bumpiness=d.scale));a.hasOwnProperty("occlusionTexture")&&
(d=a.occlusionTexture,c.aoMap=b[d.index],c.aoMapChannel="r",d.hasOwnProperty("texCoord")&&(c.aoMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")&&(d=d.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.aoMapTiling=new pc.Vec2(d.scale[0],d.scale[1])),d.hasOwnProperty("offset")&&(c.aoMapOffset=new pc.Vec2(d.offset[0],d.offset[1]))));a.hasOwnProperty("emissiveFactor")?(d=a.emissiveFactor,c.emissive.set(Math.pow(d[0],1/2.2),Math.pow(d[1],
1/2.2),Math.pow(d[2],1/2.2)),c.emissiveTint=!0):(c.emissive.set(0,0,0),c.emissiveTint=!1);a.hasOwnProperty("emissiveTexture")&&(d=a.emissiveTexture,c.emissiveMap=b[d.index],d.hasOwnProperty("texCoord")&&(c.emissiveMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")&&(d=d.extensions.KHR_texture_transform,d.hasOwnProperty("scale")&&(c.emissiveMapTiling=new pc.Vec2(d.scale[0],d.scale[1])),d.hasOwnProperty("offset")&&(c.emissiveMapOffset=new pc.Vec2(d.offset[0],
d.offset[1]))));if(a.hasOwnProperty("alphaMode"))switch(a.alphaMode){case "MASK":c.blendType=pc.BLEND_NONE;a.hasOwnProperty("alphaCutoff")?c.alphaTest=a.alphaCutoff:c.alphaTest=.5;break;case "BLEND":c.blendType=pc.BLEND_NORMAL;break;default:case "OPAQUE":c.blendType=pc.BLEND_NONE}else c.blendType=pc.BLEND_NONE;a.hasOwnProperty("doubleSided")?(c.twoSidedLighting=a.doubleSided,c.cull=a.doubleSided?pc.CULLFACE_NONE:pc.CULLFACE_BACK):(c.twoSidedLighting=!1,c.cull=pc.CULLFACE_BACK);a.hasOwnProperty("extensions")&&
a.extensions.hasOwnProperty("KHR_materials_unlit")&&(c.useLighting=!1,c.emissive.copy(c.diffuse),c.emissiveTint=c.diffuseTint,c.emissiveMap=c.diffuseMap,c.emissiveMapUv=c.diffuseMapUv,c.emissiveMapTiling.copy(c.diffuseMapTiling),c.emissiveMapOffset.copy(c.diffuseMapOffset),c.emissiveMapChannel=c.diffuseMapChannel,c.emissiveVertexColor=c.diffuseVertexColor,c.emissiveVertexColorChannel=c.diffuseVertexColorChannel,c.diffuse.set(0,0,0),c.diffuseTint=!1,c.diffuseMap=null,c.diffuseVertexColor=!1);c.update();
return c}):[]},A=function(a,b,c){return b.hasOwnProperty("textures")&&0!==b.textures.length?b.textures.map(function(d){return r(a,d,b.samplers,c)}):[]},z=function(a,b,c){return a.hasOwnProperty("animations")&&0!==a.animations.length?a.animations.map(function(d,e){return t(d,e,a.accessors,a.bufferViews,b,c)}):[]},E=function(a,b,c,d,e){if(b.hasOwnProperty("nodes")&&0!==b.nodes.length){var f=b.nodes.map(u);for(var g=0;g<b.nodes.length;++g){var h=b.nodes[g];if(h.hasOwnProperty("children"))for(var k=0;k<
h.children.length;++k){var m=f[g],l=f[h.children[k]];l.parent||m.addChild(l)}}}else f=[];g=z(b,f,c);d=A(a,b,d);h=y(b,d);k=v(a,b,c,e);a=x(a,b,f,c);e(null,{gltf:b,nodes:f,animations:g,textures:d,materials:h,meshes:k,skins:a})},C=function(a,b,c,d,e){var f=[];if(b.hasOwnProperty("images")&&0!==b.images.length&&b.hasOwnProperty("textures")&&0!==b.textures.length)for(var g=b.images.length,h=function(c,d){a:{var h=b.textures;var k=b.samplers,m=c.height,l=c.width;if(!(l&&0===(l&l-1)&&m&&0===(m&m-1)||a.webgl2))for(m=
0;m<h.length;++m){var n=h[m];if(n.hasOwnProperty("source")&&n.hasOwnProperty("sampler")&&n.source===d){l=[10497,33648];var p=[9984,9985,9986,9987];n=k?k[n.sampler]:q;if(-1!==l.indexOf(n.wrapS)||-1!==l.indexOf(n.wrapT)||-1!==p.indexOf(n.minFilter)){h=!0;break a}}}h=!1}h?(d=document.createElement("canvas"),d.width=Math.pow(2,Math.round(Math.log(c.width)/Math.log(2))),d.height=Math.pow(2,Math.round(Math.log(c.height)/Math.log(2))),d.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,d.width,d.height),
d=d.toDataURL(),c.src=d):(c.removeEventListener("load",c.loadEvent,!1),f[d]=c,0===--g&&e(null,f))},k=0;k<b.images.length;++k){var m=new Image;m.loadEvent=h.bind(null,m,k);m.addEventListener("load",m.loadEvent,!1);var l=b.images[k];if(l.hasOwnProperty("uri"))/^data:.*,.*$/i.test(l.uri)?m.src=l.uri:(m.crossOrigin="anonymous",m.src=pc.path.join(d,l.uri));else if(l.hasOwnProperty("bufferView")&&l.hasOwnProperty("mimeType")){var n=b.bufferViews[l.bufferView],p=n.hasOwnProperty("byteOffset")?n.byteOffset:
0,r=c[n.buffer];n=new Uint8Array(r.buffer,r.byteOffset+p,n.byteLength);l=new Blob([n],{type:l.mimeType});m.src=URL.createObjectURL(l)}else{e("Invalid image found in gltf (neither uri or bufferView found). index="+k);break}}else e(null,f)},D=function(a,b,c,d){var e=[];if(null===a.buffers||0===a.buffers.length)d(null,e);else for(var f=a.buffers.length,g=function(a,b){e[b]=a;0===--f&&d(null,e)},h=function(a){return function(b,c){b?d(b):g(new Uint8Array(c),a)}},k=0;k<a.buffers.length;++k){var m=a.buffers[k];
if(m.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(m.uri)){m=atob(m.uri.split(",")[1]);var l=new ArrayBuffer(m.length);l=new Uint8Array(l);for(var n=0;n<m.length;n++)l[n]=m.charCodeAt(n);g(l,k)}else pc.http.get(pc.path.join(c,m.uri),{cache:!0,responseType:"arraybuffer",retry:!1},h(k));else g(b,k)}},F=function(a,b){a=JSON.parse(function(a){if("undefined"!==typeof TextDecoder)return(new TextDecoder).decode(a);a=a.reduce(function(a,b){return a+=String.fromCharCode(b)},"");return decodeURIComponent(escape(a))}(a));
a.asset&&a.asset.version&&2>Number.parseFloat(a.asset.version)?b("Invalid gltf version. Expected version 2.0 or above but found version '"+a.asset.version+"'."):b(null,a)},I=function(a,b,c){if(a&&a.toLowerCase().endsWith(".glb")){a=new DataView(b);var d=a.getUint32(0,!0),e=a.getUint32(4,!0),f=a.getUint32(8,!0);if(1179937895!==d)c("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+d.toString(16));else if(2!==e)c("Invalid version number found in glb header. Expected 2, found "+
e);else if(0>=f||f>b.byteLength)c("Invalid length found in glb header. Found "+f);else{d=[];for(e=12;e<f;){var g=a.getUint32(e,!0);if(e+g+8>b.byteLength)throw Error("Invalid chunk length found in glb. Found "+g);var h=a.getUint32(e+4,!0),k=new Uint8Array(b,e+8,g);d.push({length:g,type:h,data:k});e+=g+8}1!==d.length&&2!==d.length?c("Invalid number of chunks found in glb file."):1313821514!==d[0].type?c("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+d[0].type.toString(16)):1<
d.length&&5130562!==d[1].type?c("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+d[1].type.toString(16)):c(null,{gltfChunk:d[0].data,binaryChunk:2===d.length?d[1].data:null})}}else c(null,{gltfChunk:b,binaryChunk:null})},G=function(){};G.parseAsync=function(a,b,c,d,e){I(a,c,function(a,c){a?e(a):F(c.gltfChunk,function(a,f){a?e(a):D(f,c.binaryChunk,b,function(a,c){a?e(a):C(d,f,c,b,function(a,b){a?e(a):E(d,f,c,b,e)})})})})};G.parse=function(a,b,c){var d=null;I(a,b,function(a,b){a?
console.error(a):F(b.gltfChunk,function(a,e){a?console.error(a):E(c,e,[b.binaryChunk],[],function(a,b){a?console.error(a):d=b})})});return d};G.createModel=function(a,b){var c=new pc.Model,d,e=[];for(d=0;d<a.nodes.length;d++){var f=a.nodes[d];null===f.parent&&e.push(f);var g=a.gltf.nodes[d];if(g.hasOwnProperty("mesh"))for(var h=a.meshes[g.mesh],k=0;k<h.length;k++){var m=c,l=h[k],n=a.skins,p=g,q=new pc.MeshInstance(f,l,void 0===l.materialIndex?b:a.materials[l.materialIndex]);if(l.morph){var r=new pc.MorphInstance(l.morph);
r.updateBounds(q.mesh);if(l.weights)for(var t=0;t<l.weights.length;t++)r.setWeight(t,l.weights[t]);q.morphInstance=r;m.morphInstances.push(r)}p.hasOwnProperty("skin")&&(n=n[p.skin],l.skin=n,l=new pc.SkinInstance(n),l.bones=n.bones,q.skinInstance=l,m.skinInstances.push(l));m.meshInstances.push(q)}}if(1===e.length)c.graph=e[0];else for(c.graph=new pc.GraphNode("SceneGroup"),d=0;d<e.length;++d)c.graph.addChild(e[d]);return c};return{GlbParser:G}}());Object.assign(pc,function(){var d=function(b){this._device=b;this._defaultMaterial=pc.getDefaultMaterial()};Object.assign(d.prototype,{parse:function(b){return(b=pc.GlbParser.parse("filename.glb",b,this._device))?pc.GlbParser.createModel(b,this._defaultMaterial):null}});return{GlbModelParser:d}}());Object.assign(pc,function(){var d=function(b,a){this._app=b;this._isTemplate=a};Object.assign(d.prototype,{parse:function(b){var a={},c,d,f=null;b.collapsedInstances&&this._addCollapsedToEntities(this._app,b);for(c in b.entities)a[c]=this._createEntity(b.entities[c]),null===b.entities[c].parent&&(f=a[c]);for(c in b.entities){var g=b.entities[c].children.length;for(d=0;d<g;d++){var n=b.entities[c].children[d];a[n]&&a[c].addChild(a[n])}}this._openComponentData(f,b.entities);return f},_createEntity:function(b){var a=
new pc.Entity,c=b.position,d=b.rotation,f=b.scale;a.name=b.name;a.setGuid(b.resource_id);a.setLocalPosition(c[0],c[1],c[2]);a.setLocalEulerAngles(d[0],d[1],d[2]);a.setLocalScale(f[0],f[1],f[2]);a._enabled=void 0!==b.enabled?b.enabled:!0;this._isTemplate||(a._enabledInHierarchy=a._enabled);a.template=b.template;if(b.tags)for(c=0;c<b.tags.length;c++)a.tags.add(b.tags[c]);b.labels&&b.labels.forEach(function(b){a.addLabel(b)});return a},_openComponentData:function(b,a){var c=this._app.systems.list,d,
f=c.length,g=a[b.getGuid()];for(d=0;d<f;d++){var n=c[d],k=g.components[n.id];k&&n.addComponent(b,k)}f=g.children.length;c=b._children;for(d=0;d<f;d++)c[d]=this._openComponentData(c[d],a);return b},_addCollapsedToEntities:function(b,a){a.collapsedInstances.forEach(function(c){c=pc.TemplateUtils.expandTemplateEntities(b,c.instanceEntities);Object.assign(a.entities,c)})}});return{SceneParser:d}}());Object.assign(pc,function(){var d=function(){this._validator=null};d.prototype.parse=function(b){b=this.migrate(b);b=this._validate(b);var a=new pc.StandardMaterial;this.initialize(a,b);return a};d.prototype.initialize=function(b,a){a.validated||(this._validator||(this._validator=new pc.StandardMaterialValidator),this._validator.validate(a));a.chunks&&b.chunks.copy(a.chunks);for(var c in a){var d=pc.StandardMaterial.PARAMETER_TYPES[c],f=a[c];"vec2"===d?b[c]=new pc.Vec2(f[0],f[1]):"rgb"===d?b[c]=new pc.Color(f[0],
f[1],f[2]):"texture"===d?f instanceof pc.Texture?b[c]=f:b[c]instanceof pc.Texture&&"number"===typeof f&&0<f||(b[c]=null):"cubemap"===d?f instanceof pc.Texture?b[c]=f:b[c]instanceof pc.Texture&&"number"===typeof f&&0<f||(b[c]=null):"boundingbox"===d?(d=new pc.Vec3(f.center[0],f.center[1],f.center[2]),f=new pc.Vec3(f.halfExtents[0],f.halfExtents[1],f.halfExtents[2]),b[c]=new pc.BoundingBox(d,f)):b[c]=a[c]}b.update()};d.prototype.migrate=function(b){void 0===b.shadingModel&&(b.shadingModel="blinn"===
b.shader?pc.SPECULAR_BLINN:pc.SPECULAR_PHONG);b.shader&&delete b.shader;b.mapping_format&&(b.mappingFormat=b.mapping_format,delete b.mapping_format);var a,c=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor",
"glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(a=0;a<c.length;a++){var d=c[a][0],f=c[a][1];void 0!==b[d]&&void 0===b[f]&&(b[f]=b[d],delete b[d])}c=["fresnelFactor","shadowSampleType"];for(a=0;a<c.length;a++)d=c[a],b.hasOwnProperty(d)&&delete b[d];return b};d.prototype._validate=function(b){this._validator||(this._validator=new pc.StandardMaterialValidator);
this._validator.validate(b);return b};return{JsonStandardMaterialParser:d}}());Object.assign(pc,function(){var d=function(){var a={astc:10,dxt:2,etc2:0,etc1:0,pvr:8,atc:11,none:14},b={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},c={};c[0]=pc.PIXELFORMAT_ETC1;c[1]=pc.PIXELFORMAT_ETC2_RGBA;c[2]=pc.PIXELFORMAT_DXT1;c[3]=pc.PIXELFORMAT_DXT5;c[8]=pc.PIXELFORMAT_PVRTC_4BPP_RGB_1;c[9]=pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1;c[10]=pc.PIXELFORMAT_ASTC_4x4;c[11]=pc.PIXELFORMAT_ATC_RGB;c[12]=pc.PIXELFORMAT_ATC_RGBA;c[13]=pc.PIXELFORMAT_R8_G8_B8_A8;c[14]=pc.PIXELFORMAT_R5_G6_B5;c[16]=pc.PIXELFORMAT_R4_G4_B4_A4;
var d="undefined"!==typeof performance,e=function(e,f,g,h,k){var m=d?performance.now():0,l=new e.BasisFile(new Uint8Array(h));e=l.getImageWidth(0,0);h=l.getImageHeight(0,0);var n=l.getNumImages(),p=l.getNumLevels(0),q=!!l.getHasAlpha();if(!(e&&h&&n&&p))throw l.close(),l.delete(),Error("Invalid image dimensions url="+f+" width="+e+" height="+h+" images="+n+" levels="+p);g=q?b[g]:a[g];if(8===g||9===g)if(0!==(e&e-1)||e!==h)g=8===g?14:13;k&&k.unswizzleGGGR&&(g=13);if(!l.startTranscoding())throw l.close(),
l.delete(),Error("Failed to start transcoding url="+f);q=[];for(var r=0;r<p;++r){var t=l.getImageTranscodedSizeInBytes(0,r,g),u=new Uint8Array(t);if(!l.transcodeImage(u,0,r,g,1,0))throw l.close(),l.delete(),Error("Failed to transcode image url="+f);if(14===g||16===g){var v=new Uint16Array(t/2);for(n=0;n<t/2;++n)v[n]=u[2*n]+256*u[2*n+1];u=v}q.push(u)}l.close();l.delete();if(k&&k.unswizzleGGGR)for(g=14,n=0;n<q.length;++n){k=n;l=q[n];for(p=0;p<l.length;p+=4)t=l[p+3],r=l[p+1],l[p+0]=t,t=2/255*t-1,r=2/
255*r-1,l[p+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,t*t+r*r))+1)))),l[p+3]=255;p=new Uint16Array(l.length/4);for(r=0;r<l.length;r+=4)p[r/4]=(l[r+0]&248)<<8|(l[r+1]&252)<<3|l[r+2]>>3;q[k]=p}return{format:c[g],width:e+3&-4,height:h+3&-4,levels:q,cubemap:!1,mipmaps:!0,transcodeTime:d?performance.now()-m:0,url:f}},f=null,g=[],h=function(a,b,c,d){try{var g=e(f,a,b,c,d);g.levels=g.levels.map(function(a){return a.buffer});self.postMessage({url:a,data:g},g.levels)}catch(B){self.postMessage({url:a.toString(),
err:B.toString()})}},k=function(a){var b=function(b,c){WebAssembly.instantiate(a,b).then(function(a){c(a)});return{}};self.BASIS(a?{instantiateWasm:b}:null).then(function(a){f=a;f.initializeBasis();for(a=0;a<g.length;++a)h(g[a].url,g[a].format,g[a].data,g[a].options);g=[]})};self.onmessage=function(a){a=a.data;switch(a.type){case "init":k(a.module);break;case "transcode":f?h(a.url,a.format,a.data,a.options):g.push(a)}}},b=function(){try{if("object"===typeof WebAssembly&&"function"===typeof WebAssembly.instantiate){var a=
new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(a instanceof WebAssembly.Module)return new WebAssembly.Instance(a)instanceof WebAssembly.Instance}}catch(t){}return!1}(),a=!1,c=null,e={},f=null,g=[],n=function(){if(!f){var a=pc.app.graphicsDevice;f=a.extCompressedTextureASTC?"astc":a.extCompressedTextureS3TC?"dxt":a.extCompressedTextureETC?"etc2":a.extCompressedTextureETC1?"etc1":a.extCompressedTexturePVRTC?"pvr":a.extCompressedTextureATC?"atc":"none"}return f},k=function(a){var b=a.data.url,
c=a.data.err;a=a.data.data;var d=e[b];if(d){var f;if(c)for(f=0;f<d.length;++f)d[f](c);else{a.levels=a.format===pc.PIXELFORMAT_R5_G6_B5||a.format===pc.PIXELFORMAT_R4_G4_B4_A4?a.levels.map(function(a){return new Uint16Array(a)}):a.levels.map(function(a){return new Uint8Array(a)});for(f=0;f<d.length;++f)d[f](null,a);delete e[b]}}else console.error("internal logical error encountered in basis transcoder")},h=function(a,b,d,f){e.hasOwnProperty(a)?e[a].push(d):(e[a]=[d],c.postMessage({type:"transcode",
url:a,format:n(),data:b,options:f},[b]))},m=function(){var a={},b;for(b in pc)pc.hasOwnProperty(b)&&b.startsWith("PIXELFORMAT_")&&(a[b]=pc[b]);return a},l=function(a,b,e){a=["/* basis.js */",a,"/* mappings */","var pc="+JSON.stringify(m())+";\n"," /* worker */","("+d.toString()+")()\n\n"].join("\n");a=new Blob([a],{type:"application/javascript"});a=URL.createObjectURL(a);c=new Worker(a);c.addEventListener("message",k);c.postMessage({type:"init",module:b});e&&e();for(b=0;b<g.length;++b)e=g[b],h(e.url,
e.data,e.callback,e.options)},p=function(c,d,e,f){a&&console.warn("basis module is being downloaded more than once");a=!0;if(b){var g=null,h=null,k=function(){g&&h&&l(g,h,f)},m=function(){pc.http.get(d,{cache:!0,responseType:"arraybuffer",retry:!1},function(a,b){b&&WebAssembly.compile(b).then(function(a){h=a;k()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(d)).then(function(a){h=a;k()}).catch(function(a){console.error(a);console.warn("compileStreaming() failed for "+d+", falling back to arraybuffer download...");
m()}):m();pc.http.get(c,{cache:!0,responseType:"text",retry:!1},function(a,b){g=b;k()})}else pc.http.get(e,{cache:!0,responseType:"text",retry:!1},function(a,b){b&&l(b,null,f)})},q=function(a){var b=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(a){return"BASIS"===a.moduleName});if(b){var c=window.ASSET_PREFIX?window.ASSET_PREFIX:"";p(c+b.glueUrl,c+b.wasmUrl,c+b.fallbackUrl,a)}};return{basisTargetFormat:n,basisInitialize:l,basisDownload:p,basisDownloadFromConfig:q,
basisTranscode:function(b,d,e,f){c?h(b,d,e,f):(g.push({url:b,data:d,callback:e,options:f}),a||q())}}}());Object.assign(pc,function(){var d=function(a){this.data=a;this.model=null;this.materials=[];this.textures=[];this.animations=[];this.registry=null};Object.assign(d.prototype,{destroy:function(){var a=this.registry,b=function(b){a.remove(b);b.unload()},d=function(a){a.forEach(function(a){b(a)})};this.animations&&(d(this.animations),this.animations=null);this.textures&&(d(this.textures),this.textures=null);this.materials&&(d(this.materials),this.materials=null);this.model&&(b(this.model),this.model=
null);this.assets=this.data=null}});var b=function(a,b){this._device=a;this._defaultMaterial=b};Object.assign(b.prototype,{load:function(a,b,e){"string"===typeof a&&(a={load:a,original:a});var c=this;pc.http.get(a.load,{responseType:pc.Http.ResponseType.ARRAY_BUFFER,retry:!1},function(f,n){b&&(f?b(pc.string.format("Error loading model: {0} [{1}]",a.original,f)):pc.GlbParser.parseAsync(e.file&&e.file.filename?e.file.filename:e.name,pc.path.extractPath(a.original),n,c._device,function(a,c){a?b(a):b(null,
new d(c))}))})},open:function(a,b,d){return b},patch:function(a,b){var c=function(c,d,e){c=new pc.Asset(a.name+"/"+c+"/"+e,c,{url:""});c.resource=d;c.loaded=!0;b.add(c);return c},d=a.resource,g=d.data,n,k=c("model",pc.GlbParser.createModel(g,this._defaultMaterial),0),h=[];for(n=0;n<g.materials.length;++n)h.push(c("material",g.materials[n],n));var m=[];for(n=0;n<g.textures.length;++n)m.push(c("texture",g.textures[n],n));var l=[];for(n=0;n<g.animations.length;++n)l.push(c("animation",g.animations[n],
n));d.data=null;d.model=k;d.materials=h;d.textures=m;d.animations=l;d.registry=b}});return{ContainerResource:d,ContainerHandler:b}}());Object.assign(pc,function(){var d=-1,b=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:)/i,a={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},c=["pvr","dxt","etc2","etc1","basis"],e=function(a,b,c,e){pc.EventHandler.call(this);this._id=d--;this.name=a||"";this.type=b;this.tags=new pc.Tags(this);this._preload=!1;this.variants=new pc.AssetVariants(this);this._file=null;this._data=e||{};this._resources=[];this._i18n=
{};this.loading=this.loaded=!1;this.registry=null;c&&(this.file=c)};e.prototype=Object.create(pc.EventHandler.prototype);e.prototype.constructor=e;Object.assign(e.prototype,{getFileUrl:function(){var a=this.getPreferredFile();if(!a||!a.url)return null;var c=a.url;this.registry&&this.registry.prefix&&!b.test(c)&&(c=this.registry.prefix+c);if("script"!==this.type&&a.hash){var d=-1!==c.indexOf("?")?"&":"?";c+=d+"t="+a.hash}return c},getPreferredFile:function(){if(!this.file)return null;if("texture"===
this.type||"textureatlas"===this.type||"bundle"===this.type)for(var b=this.registry._loader._app,d=b.graphicsDevice,e=0,k=c.length;e<k;e++){var h=c[e];if(d[a[h]]){if(this.file.variants[h])return this.file.variants[h];if(b.enableBundles){var m=b.bundles.listBundlesForAsset(this);if(m)for(var l=0,p=m.length;l<p;l++)if(m[l].file&&m[l].file.variants&&m[l].file.variants[h])return this.file}}}return this.file},getLocalizedAssetId:function(a){a=pc.I18n.findAvailableLocale(a,this._i18n);return this._i18n[a]||
null},addLocalizedAssetId:function(a,b){this._i18n[a]=b;this.fire("add:localized",a,b)},removeLocalizedAssetId:function(a){var b=this._i18n[a];b&&(delete this._i18n[a],this.fire("remove:localized",a,b))},ready:function(a,b){b=b||this;if(this.resource)a.call(b,this);else this.once("load",function(c){a.call(b,c)})},reload:function(){this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))},unload:function(){if(this.loaded||this.resource)this.fire("unload",
this),this.registry.fire("unload:"+this.id,this),this.resource&&this.resource.destroy&&this.resource.destroy(),this.resource=null,this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type)}});Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a}});Object.defineProperty(e.prototype,"file",{get:function(){return this._file},set:function(a){var b;if(!!a!==!!this._file||a&&this._file&&a.hash!==this._file)if(a){this._file||(this._file=
{});this._file.url=a.url;this._file.filename=a.filename;this._file.hash=a.hash;this._file.size=a.size;this._file.variants=this.variants;if(a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b]);this.fire("change",this,"file",this._file,this._file);this.reload()}else this._file=null,this.variants.clear();else if(a&&this._file&&a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&
(this.variants[b]=a.variants[b])}});Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(a){var b=this._data;this._data=a;a!==b&&(this.fire("change",this,"data",a,b),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(e.prototype,"resource",{get:function(){return this._resources[0]},set:function(a){var b=this._resources[0];this._resources[0]=a;this.fire("change",this,"resource",a,b)}});Object.defineProperty(e.prototype,"resources",
{get:function(){return this._resources},set:function(a){var b=this._resources;this._resources=a;this.fire("change",this,"resources",a,b)}});Object.defineProperty(e.prototype,"preload",{get:function(){return this._preload},set:function(a){a=!!a;this._preload!==a&&(this._preload=a)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}});return{Asset:e,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",
ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SHADER:"shader",ASSET_CSS:"css",ASSET_HTML:"html",ASSET_SCRIPT:"script",ABSOLUTE_URL:b}}());Object.assign(pc,function(){var d=[],b=function(a){this.asset=a},a=function(a){var c="_"+a;d.push(c);Object.defineProperty(b.prototype,a,{get:function(){return this[c]||null},set:function(a){if(!!this[c]!==!!a||this[c]&&a&&this[c].hash!==a.hash)this[c]=a?{url:a.url,filename:a.filename,size:a.size,hash:a.hash,opt:a.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload())}})};a("dxt");a("pvr");a("etc1");a("etc2");a("basis");b.prototype.clear=
function(){for(var a=0;a<d.length;a++)this[d[a]]=null};return{AssetVariants:b}}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);this._loader=b;this._assets=[];this._cache={};this._names={};this._tags=new pc.TagsCache("_id");this._urls={};this.prefix=null};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;Object.assign(d.prototype,{list:function(b){b=b||{};return this._assets.filter(function(a){var c=!0;void 0!==b.preload&&(c=a.preload===b.preload);return c})},add:function(b){var a=this._assets.push(b)-1;this._cache[b.id]=
a;this._names[b.name]||(this._names[b.name]=[]);this._names[b.name].push(a);if(b.file){var c=b.file.url;this._urls[c]=a}b.registry=this;this._tags.addItem(b);b.tags.on("add",this._onTagAdd,this);b.tags.on("remove",this._onTagRemove,this);this.fire("add",b);this.fire("add:"+b.id,b);c&&this.fire("add:url:"+c,b);b.preload&&this.load(b)},remove:function(b){var a=this._cache[b.id],c=b.file?b.file.url:null;if(void 0!==a){this._assets.splice(a,1);delete this._cache[b.id];this._names={};this._urls=[];a=0;
for(var d=this._assets.length;a<d;a++){var f=this._assets[a];this._cache[f.id]=a;this._names[f.name]||(this._names[f.name]=[]);this._names[f.name].push(a);f.file&&(this._urls[f.file.url]=a)}this._tags.removeItem(b);b.tags.off("add",this._onTagAdd,this);b.tags.off("remove",this._onTagRemove,this);b.fire("remove",b);this.fire("remove",b);this.fire("remove:"+b.id,b);c&&this.fire("remove:url:"+c,b);return!0}return!1},get:function(b){return this._assets[this._cache[b]]},getByUrl:function(b){return this._assets[this._urls[b]]},
load:function(b){if(!b.loading){var a=this;if(b.loaded)"cubemap"===b.type&&a._loader.patch(b,this);else{var c=!!b.file,d=b.getPreferredFile(),f=function(){var c=b.getFileUrl();b.loading=!0;a._loader.load(c,b.type,function(c,e,f){b.loaded=!0;b.loading=!1;c?(a.fire("error",c,b),a.fire("error:"+b.id,c,b),b.fire("error",c,b)):(e instanceof Array?b.resources=e:b.resource=e,pc.script.legacy||"script"!==b.type||(c=a._loader.getHandler("script"),c._cache[b.id]&&c._cache[b.id].parentNode===document.head&&
document.head.removeChild(c._cache[b.id]),c._cache[b.id]=f),a._loader.patch(b,a),a.fire("load",b),a.fire("load:"+b.id,b),d&&d.url&&a.fire("load:url:"+d.url,b),b.fire("load",b))},b)},g=function(){var c=a._loader.open(b.type,b.data);c instanceof Array?b.resources=c:b.resource=c;b.loaded=!0;a._loader.patch(b,a);a.fire("load",b);a.fire("load:"+b.id,b);d&&d.url&&a.fire("load:url:"+d.url,b);b.fire("load",b)};if(d&&"cubemap"===b.type){c=!1;var n=b.getFileUrl();this._loader.load(n,"texture",function(c,d){c?
(a.fire("error",c,b),a.fire("error:"+b.id,c,b),b.fire("error",c,b)):(a._loader.patch({resource:d,type:"texture",data:b.data},a),b._dds=d,g())})}d?c&&(this.fire("load:start",b),this.fire("load:"+b.id+":start",b),f()):g()}}},loadFromUrl:function(b,a,c){this.loadFromUrlAndFilename(b,null,a,c)},loadFromUrlAndFilename:function(b,a,c,d){var e=this,g=pc.path.getBasename(a||b);a={filename:a||g,url:b};var n={};b=e.getByUrl(b);b||(b=new pc.Asset(g,c,a,n),e.add(b));g=function(a){"material"===c?e._loadTextures([a],
function(b,c){b?d(b):d(null,a)}):d(null,a)};b.resource?g(b):"model"===c?e._loadModel(b,d):(b.once("load",g),b.once("error",function(a){d(a)}),e.load(b))},_loadModel:function(b,a){var c=this,d=b.getFileUrl(),f=pc.path.getDirectory(d),g=pc.path.getBasename(d);d=pc.path.getExtension(d);var n=function(d){b.once("load",function(b){a(null,b)});b.once("error",function(b){a(b)});c.load(d)};".json"===d||".glb"===d?(g=pc.path.join(f,g.replace(d,".mapping.json")),this._loader.load(g,"json",function(a,d){a?(b.data=
{mapping:[]},n(b)):c._loadMaterials(f,d,function(a,c){b.data=d;n(b)})})):n(b)},_loadMaterials:function(b,a,c){b&&(b+="/",this.prefix&&b.startsWith(this.prefix)&&(b=b.slice(this.prefix.length)));var d,f=a.mapping.length,g=[];0===f&&c(null,g);var n=function(a,b){g.push(b);f--;0===f&&c(null,g)};for(d=0;d<a.mapping.length;d++){var k=a.mapping[d].path;k?(k=pc.path.join(b,k),this.loadFromUrl(k,"material",n)):f--}},_loadTextures:function(b,a){var c,d={},f=[],g=[],n=0;for(c=0;c<b.length;c++){var k=b[c].data;
if("path"!==k.mappingFormat)console.warn("Skipping: "+b[c].name+', material files must be mappingFormat: "path" to be loaded from URL');else{var h=b[c].getFileUrl();if(h=pc.path.getDirectory(h))h+="/",this.prefix&&h.startsWith(this.prefix)&&(h=h.slice(this.prefix.length));for(var m,l=0;l<pc.StandardMaterial.TEXTURE_PARAMETERS.length;l++)m=pc.StandardMaterial.TEXTURE_PARAMETERS[l],k[m]&&"string"===typeof k[m]&&(m=pc.path.join(h,k[m]),d[m]||(d[m]=!0,f.push(m),n++))}}if(n)for(b=function(b,c){g.push(c);
n--;b&&console.error(b);0===n&&a(null,g)},c=0;c<f.length;c++)this.loadFromUrl(f[c],"texture",b);else a(null,g)},findAll:function(b,a){var c=this;return(b=this._names[b])?(b=b.map(function(a){return c._assets[a]}),a?b.filter(function(b){return b.type===a}):b):[]},_onTagAdd:function(b,a){this._tags.add(b,a)},_onTagRemove:function(b,a){this._tags.remove(b,a)},findByTag:function(){return this._tags.find(arguments)},filter:function(b){for(var a=[],c=0,d=this._assets.length;c<d;c++)b(this._assets[c])&&
a.push(this._assets[c]);return a},find:function(b,a){return(b=this.findAll(b,a))?b[0]:null}});return{AssetRegistry:d}}());Object.assign(pc,function(){var d=function(b,a,c,d,f){this.propertyName=b;this.parent=a;this._scope=f;this._registry=c;this.asset=this.url=this.id=null;this._onAssetLoad=d.load;this._onAssetAdd=d.add;this._onAssetRemove=d.remove};d.prototype._bind=function(){if(this.id){if(this._onAssetLoad)this._registry.on("load:"+this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:"+this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:"+this.id,this._onRemove,this)}if(this.url){if(this._onAssetLoad)this._registry.on("load:url:"+
this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:url:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:url:"+this.url,this._onRemove,this)}};d.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this));this.url&&(this._onAssetLoad&&this._registry.off("load:"+
this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))};d.prototype._onLoad=function(b){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,b)};d.prototype._onAdd=function(b){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,b)};d.prototype._onRemove=function(b){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,b)};Object.defineProperty(d.prototype,
"id",{get:function(){return this._id},set:function(b){if(this.url)throw Error("Can't set id and url");this._unbind();this._id=b;this.asset=this._registry.get(this._id);this._bind()}});Object.defineProperty(d.prototype,"url",{get:function(){return this._url},set:function(b){if(this.id)throw Error("Can't set id and url");this._unbind();this._url=b;this.asset=this._registry.getByUrl(this._url);this._bind()}});return{AssetReference:d}}());Object.assign(pc,function(){var d=function(b){pc.EventHandler.call(this);this._app=b;b.i18n.on("set:locale",this._onSetLocale,this);this._disableLocalization=this._autoLoad=!1;this._localizedAsset=this._defaultAsset=null};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype._bindDefaultAsset=function(){var b=this._app.assets.get(this._defaultAsset);if(b)this._onDefaultAssetAdd(b);else this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)};
d.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var b=this._app.assets.get(this._defaultAsset);b&&(b.off("add:localized",this._onLocaleAdd,this),b.off("remove:localized",this._onLocaleRemove,this),b.off("remove",this._onDefaultAssetRemove,this))}};d.prototype._onDefaultAssetAdd=function(b){this._defaultAsset===b.id&&(b.on("add:localized",this._onLocaleAdd,this),b.on("remove:localized",this._onLocaleRemove,
this),b.once("remove",this._onDefaultAssetRemove,this))};d.prototype._onDefaultAssetRemove=function(b){this._defaultAsset===b.id&&(b.off("add:localized",this._onLocaleAdd,this),b.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))};d.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var b=this._app.assets.get(this._localizedAsset);b&&(b.on("load",this._onLocalizedAssetLoad,this),b.on("change",this._onLocalizedAssetChange,
this),b.on("remove",this._onLocalizedAssetRemove,this),b.resource?this._onLocalizedAssetLoad(b):this._app.assets.load(b))}};d.prototype._unbindLocalizedAsset=function(){var b=this._app.assets.get(this._localizedAsset);b&&(b.off("load",this._onLocalizedAssetLoad,this),b.off("change",this._onLocalizedAssetChange,this),b.off("remove",this._onLocalizedAssetRemove,this))};d.prototype._onLocalizedAssetAdd=function(b){this._localizedAsset===b.id&&this._bindLocalizedAsset()};d.prototype._onLocalizedAssetLoad=
function(b){this.fire("load",b)};d.prototype._onLocalizedAssetChange=function(b,a,c,d){this.fire("change",b,a,c,d)};d.prototype._onLocalizedAssetRemove=function(b){this._localizedAsset===b.id&&(this.localizedAsset=this._defaultAsset);this.fire("remove",b)};d.prototype._onLocaleAdd=function(b,a){this._app.i18n.locale===b&&this._onSetLocale(b)};d.prototype._onLocaleRemove=function(b,a){this._app.i18n.locale===b&&this._onSetLocale(b)};d.prototype._onSetLocale=function(b){if(this._defaultAsset){var a=
this._app.assets.get(this._defaultAsset);this.localizedAsset=!a||this._disableLocalization?this._defaultAsset:(b=a.getLocalizedAssetId(b))?b:this._defaultAsset}else this.localizedAsset=null};d.prototype.destroy=function(){this.defaultAsset=null;this._app.i18n.off("set:locale",this._onSetLocale,this);this.off()};Object.defineProperty(d.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(b){b=b instanceof pc.Asset?b.id:b;this._defaultAsset!==b&&(this._defaultAsset&&this._unbindDefaultAsset(),
(this._defaultAsset=b)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}});Object.defineProperty(d.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(b){b=b instanceof pc.Asset?b.id:b;if(this._localizedAsset!==b&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=b))if(this._app.assets.get(this._localizedAsset))this._bindLocalizedAsset();
else this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}});Object.defineProperty(d.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(b){this._autoLoad!==b&&(this._autoLoad=b)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}});Object.defineProperty(d.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(b){this._disableLocalization!==b&&(this._disableLocalization=b,this._onSetLocale(this._app.i18n.locale))}});
return{LocalizedAsset:d}}());Object.assign(pc,function(){var d=function(b,a){pc.EventHandler.call(this);this._assets=[];this._registry=a;this._loaded=!1;this._total=this._count=0;this._failed=[];this._waitingAssets=[];if(b.length&&b[0]instanceof pc.Asset)this._assets=b;else for(var c=0;c<b.length;c++){var d=a.get(b[c]);d?this._assets.push(d):(this._waitForAsset(b[c]),this._total++)}};d.prototype=Object.create(pc.EventHandler.prototype);d.prototype.constructor=d;d.prototype.destroy=function(){var b=this;this._registry.off("load",
this._onLoad);this._registry.off("error",this._onError);this._waitingAssets.forEach(function(a){b._registry.off("add:"+a,this._onAddAsset)});this.off("progress");this.off("load")};d.prototype.load=function(b,a){var c=this._assets.length;this._count=0;this._failed=[];this._callback=b;this._scope=a;this._registry.on("load",this._onLoad,this);this._registry.on("error",this._onError,this);for(b=0;b<c;b++)a=this._assets[b],a.loading||a.loaded||(this._registry.load(a),this._total++)};d.prototype.ready=
function(b,a){a=a||this;if(this._loaded)b.call(a,this._assets);else this.once("load",function(c){b.call(a,c)})};d.prototype._loadingComplete=function(){this._loaded=!0;this._registry.off("load",this._onLoad,this);this._registry.off("error",this._onError,this);this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))};
d.prototype._onLoad=function(b){var a=this;0<=this._assets.indexOf(b)&&(this._count++,this.fire("progress",b));this._count===this._total&&setTimeout(function(){a._loadingComplete(a._failed)},0)};d.prototype._onError=function(b,a){var c=this;0<=this._assets.indexOf(a)&&(this._count++,this._failed.push(a));this._count===this._total&&setTimeout(function(){c._loadingComplete(c._failed)},0)};d.prototype._onAddAsset=function(b){var a=this._waitingAssets.indexOf(b);0<=a&&this._waitingAssets.splice(a,1);
this._assets.push(b);var c=this._assets.length;for(a=0;a<c;a++)b=this._assets[a],b.loading||b.loaded||this._registry.load(b)};d.prototype._waitForAsset=function(b){this._waitingAssets.push(b);this._registry.once("add:"+b,this._onAddAsset,this)};return{AssetListLoader:d}}());Object.assign(pc,function(){return{inherits:function(d,b){var a=function(){},c=function(a,c,g,n,k,h,m,l){b.call(this,a,c,g,n,k,h,m,l);d.call(this,a,c,g,n,k,h,m,l)};c._super=b.prototype;a.prototype=b.prototype;c.prototype=new a;return c}}}());pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton};
pc.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};pc.audio={AudioManager:pc.SoundManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound};
pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}};
Object.assign(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,VertexIterator:pc.VertexIterator});
(function(){function d(a){this.name="UnsupportedBrowserError";this.message=a||""}function b(a){this.name="ContextCreationError";this.message=a||""}d.prototype=Error.prototype;b.prototype=Error.prototype;pc.ContextCreationError=b;pc.UnsupportedBrowserError=d})();
Object.assign(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent});pc.math.INV_LOG2=Math.LOG2E;pc.math.intToBytes=pc.math.intToBytes32;pc.math.bytesToInt=pc.math.bytesToInt32;
pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue};
Object.assign(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,
Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.StandardMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance});pc.shape={Aabb:pc.BoundingBox,Sphere:pc.BoundingSphere,Plane:pc.Plane};pc.string.startsWith=function(d,b){return d.startsWith(b)};pc.string.endsWith=function(d,b){return d.endsWith(b)};pc.time={now:pc.now,Timer:pc.Timer};
pc.PhongMaterial=pc.StandardMaterial;pc.BoundingSphere.prototype.intersectRay=pc.BoundingSphere.prototype.intersectsRay;pc.ELEMENTTYPE_INT8=pc.TYPE_INT8;pc.ELEMENTTYPE_UINT8=pc.TYPE_UINT8;pc.ELEMENTTYPE_INT16=pc.TYPE_INT16;pc.ELEMENTTYPE_UINT16=pc.TYPE_UINT16;pc.ELEMENTTYPE_INT32=pc.TYPE_INT32;pc.ELEMENTTYPE_UINT32=pc.TYPE_UINT32;pc.ELEMENTTYPE_FLOAT32=pc.TYPE_FLOAT32;Object.defineProperty(pc.shaderChunks,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+pc.shaderChunks.transformVS}});
Object.defineProperty(pc.Vec2.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(2));this._data[0]=this.x;this._data[1]=this.y;return this._data}});Object.defineProperty(pc.Vec3.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(3));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;return this._data}});
Object.defineProperty(pc.Vec4.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;this._data[3]=this.w;return this._data}});Object.defineProperty(pc.Color.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.r;this._data[1]=this.g;this._data[2]=this.b;this._data[3]=this.a;return this._data}});
Object.defineProperty(pc.Color.prototype,"data3",{get:function(){this._data3||(this._data3=new Float32Array(3));this._data3[0]=this.r;this._data3[1]=this.g;this._data3[2]=this.b;return this._data3}});pc.Application.prototype.isFullscreen=function(){return!!document.fullscreenElement};
pc.Application.prototype.enableFullscreen=function(d,b,a){d=d||this.graphicsDevice.canvas;var c=function(){b();document.removeEventListener("fullscreenchange",c)},e=function(){a();document.removeEventListener("fullscreenerror",e)};b&&document.addEventListener("fullscreenchange",c,!1);a&&document.addEventListener("fullscreenerror",e,!1);d.requestFullscreen?d.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):a()};
pc.Application.prototype.disableFullscreen=function(d){var b=function(){d();document.removeEventListener("fullscreenchange",b)};d&&document.addEventListener("fullscreenchange",b,!1);document.exitFullscreen()};pc.AssetRegistry.prototype.getAssetById=function(d){return this.get(d)};pc.AudioManager=pc.SoundManager;pc.GraphNode.prototype._dirtify=function(d){d?this._dirtifyLocal():this._dirtifyWorld()};pc.GraphNode.prototype.addLabel=function(d){this._labels[d]=!0};pc.GraphNode.prototype.getLabels=function(){return Object.keys(this._labels)};
pc.GraphNode.prototype.hasLabel=function(d){return!!this._labels[d]};pc.GraphNode.prototype.removeLabel=function(d){delete this._labels[d]};pc.GraphNode.prototype.findByLabel=function(d,b){var a,c=this._children.length;b=b||[];this.hasLabel(d)&&b.push(this);for(a=0;a<c;++a)b=this._children[a].findByLabel(d,b);return b};pc.GraphNode.prototype.getChildren=function(){return this.children};pc.GraphNode.prototype.getName=function(){return this.name};pc.GraphNode.prototype.getPath=function(){return this.path};
pc.GraphNode.prototype.getRoot=function(){return this.root};pc.GraphNode.prototype.getParent=function(){return this.parent};pc.GraphNode.prototype.setName=function(d){this.name=d};pc.Material.prototype.getName=function(){return this.name};pc.Material.prototype.setName=function(d){this.name=d};pc.Material.prototype.getShader=function(){return this.shader};pc.Material.prototype.setShader=function(d){this.shader=d};
pc.RigidBodyComponentSystem.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};pc.SoundManager.prototype.getListener=function(){return this.listener};pc.SoundManager.prototype.getVolume=function(){return this.volume};pc.SoundManager.prototype.setVolume=function(d){this.volume=d};Object.defineProperty(pc.ElementInput.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});
Object.defineProperty(pc.MouseEvent.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});Object.defineProperty(pc.XrInputSource.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(pc.XrInputSource.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(pc.XrInputSource.prototype,"rotation",{get:function(){return this._localRotation}});Object.assign(pc.Application.prototype,function(){var d=new pc.GraphNode,b=new pc.GraphNode,a=[],c=!1,e=function(a){this.lineVertexFormat=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}]);this.lineBatches=[];this.layers=[];this.layerToBatch={};this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null;this.identityGraphNode=new pc.GraphNode};e.prototype.addLayer=function(a){0>this.layers.indexOf(a)&&
this.layers.push(a)};e.prototype.getLayerIdx=function(a){return this.layerToBatch[a.id]};e.prototype.addLayerIdx=function(a,b){this.layerToBatch[b.id]=a};var f=function(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.layer=this.meshInstance=this.material=null};Object.assign(f.prototype,{init:function(a,c,d,e){this.mesh||(this.mesh=new pc.Mesh(a),this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=
new pc.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=pc.BLEND_NORMAL,this.material.update());for(this.layer=d;this.linesUsed+e>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=c;this.vb||(this.vb=new pc.VertexBuffer(a,c,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(b.worldTransform=pc.Mat4.IDENTITY,b._dirtyWorld=
b._dirtyNormal=!1,this.meshInstance=new pc.MeshInstance(b,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(a,b){for(var c=!!b.length,d=2*this.linesUsed*this.vertexFormat.size,e,f=0;f<a.length;f++)this.vbRam.setFloat32(d,a[f].x,!0),d+=4,this.vbRam.setFloat32(d,a[f].y,!0),d+=4,this.vbRam.setFloat32(d,a[f].z,!0),d+=4,e=c?b[f]:b,this.vbRam.setUint8(d,255*e.r),d+=1,this.vbRam.setUint8(d,255*e.g),d+=1,this.vbRam.setUint8(d,255*e.b),d+=1,this.vbRam.setUint8(d,255*e.a),d+=1;this.linesUsed+=
a.length/2},finalize:function(){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,a[0]=this.meshInstance,this.layer.addMeshInstances(a,!0),this.linesUsed=0)}});return{renderMeshInstance:function(b,c){c||(c={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});this._initImmediate();this._immediateData.addLayer(c.layer);a[0]=b;c.layer.addMeshInstances(a,!0)},renderMesh:function(b,c,e,f){f||(f={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});
this._initImmediate();d.worldTransform=e;d._dirtyWorld=d._dirtyNormal=!1;b=new pc.MeshInstance(d,b,c);b.cull=!1;f.mask&&(b.mask=f.mask);this._immediateData.addLayer(f.layer);a[0]=b;f.layer.addMeshInstances(a,!0)},renderLine:function(a,b,d,e,f){var g=d;if(e instanceof pc.Color)if(g=e,"number"===typeof f){c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),c=!0);var h=f===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:
{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}}else h=f;else"number"===typeof e?(c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),c=!0),g=d,h=e===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):e&&(h=e);this._addLines([a,b],[d,g],h)},renderLines:function(a,b,d){d?"number"===typeof d&&(c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
c=!0),d=d===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):d={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0};b.length&&a.length!==b.length?pc.log.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?pc.log.error("renderLines: array length is not divisible by 2"):this._addLines(a,b,d)},renderQuad:function(b,c,e){e||(e={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});
this._initImmediate();if(!this._immediateData.quadMesh){var f=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}]);f=new pc.VertexBuffer(this.graphicsDevice,f,4);var g=new pc.VertexIterator(f);g.element[pc.SEMANTIC_POSITION].set(-.5,-.5,0);g.next();g.element[pc.SEMANTIC_POSITION].set(.5,-.5,0);g.next();g.element[pc.SEMANTIC_POSITION].set(-.5,.5,0);g.next();g.element[pc.SEMANTIC_POSITION].set(.5,.5,0);g.end();this._immediateData.quadMesh=new pc.Mesh(this.graphicsDevice);
this._immediateData.quadMesh.vertexBuffer=f;this._immediateData.quadMesh.primitive[0].type=pc.PRIMITIVE_TRISTRIP;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=!1}d.worldTransform=b;d._dirtyWorld=d._dirtyNormal=!1;b=new pc.MeshInstance(d,this._immediateData.quadMesh,c);b.cull=!1;a[0]=b;this._immediateData.addLayer(e.layer);e.layer.addMeshInstances(a,!0)},renderWireCube:function(a,b,c){var d;this._initImmediate();
this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new pc.Vec3(-.5,-.5,-.5),new pc.Vec3(-.5,.5,-.5),new pc.Vec3(.5,.5,-.5),new pc.Vec3(.5,-.5,-.5),new pc.Vec3(-.5,-.5,.5),new pc.Vec3(-.5,.5,.5),new pc.Vec3(.5,.5,.5),new pc.Vec3(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3]);var e=this._immediateData.cubeLocalPos,f=this._immediateData.cubeWorldPos;for(d=0;8>d;d++)a.transformPoint(e[d],
f[d]);this.renderLines([f[0],f[1],f[1],f[2],f[2],f[3],f[3],f[0],f[4],f[5],f[5],f[6],f[6],f[7],f[7],f[4],f[0],f[4],f[1],f[5],f[2],f[6],f[3],f[7]],b,c)},_addLines:function(a,b,c){var d=c&&c.layer?c.layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),e=c&&void 0!==c.depthTest?c.depthTest:!0;c=c&&c.mask?c.mask:void 0;this._initImmediate();this._immediateData.addLayer(d);var g=this._immediateData.getLayerIdx(d);void 0===g?(g=new f,g.init(this.graphicsDevice,this._immediateData.lineVertexFormat,
d,a.length/2),g.material.depthTest=e,c&&(g.meshInstance.mask=c),g=this._immediateData.lineBatches.push(g)-1,this._immediateData.addLayerIdx(g,d)):(this._immediateData.lineBatches[g].init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),this._immediateData.lineBatches[g].material.depthTest=e,c&&(this._immediateData.lineBatches[g].meshInstance.mask=c));this._immediateData.lineBatches[g].addLines(a,b)},_initImmediate:function(){this._immediateData||(this._immediateData=new e(this.graphicsDevice),
this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_preRenderImmediate:function(){for(var a=0;a<this._immediateData.lineBatches.length;a++)this._immediateData.lineBatches[a]&&this._immediateData.lineBatches[a].finalize()},_postRenderImmediate:function(){for(var a=0;a<this._immediateData.layers.length;a++)this._immediateData.layers[a].clearMeshInstances(!0);this._immediateData.layers.length=0}}}());Object.assign(pc,function(){function d(a,b,c,e){if(a.enabled){var f;if(a.model&&a.model.model&&a.model.enabled&&(e&&e.push(a),a.model.lightmapped&&b)){var g=!0,h=a.model.model.meshInstances;for(f=0;f<h.length;f++)if(!h[f].mesh.vertexBuffer.format.hasUv1){g=!1;break}if(g){var k=[];for(f=0;f<h.length;f++){var m=!1;for(g=0;g<h.length;g++)f!==g&&h[f].mesh===h[g].mesh&&(m=!0);m?(b.push(a),c.push([h[f]])):k.push(h[f])}0<k.length&&(b.push(a),c.push(k))}}for(f=0;f<a._children.length;f++)d(a._children[f],
b,c,e)}}var b=[],a=[],c,e=new pc.Vec3,f=new pc.BoundingBox,g=new pc.BoundingBox,n={},k=["texture_lightMap","texture_dirLightMap"],h=[],m=function(a,b,c,d,e){this.device=a;this.root=b;this.scene=c;this.renderer=d;this.assets=e};Object.assign(m.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(a){var b=this.scene.lightmapSizeMultiplier||16,c=1,d=1,f=1,g=1;if(a.model.asset){var h=this.assets.get(a.model.asset).data;h.area&&(c=
h.area.x,d=h.area.y,f=h.area.z,g=h.area.uv)}else a.model._area&&(h=a.model,h._area&&(c=h._area.x,d=h._area.y,f=h._area.z,g=h._area.uv));h=a.model.lightmapSizeMultiplier||1;c*=h;d*=h;f*=h;e.copy(a.localScale);for(a=a._parent;a;)e.mul(a.localScale),a=a._parent;e.x=Math.abs(e.x);e.y=Math.abs(e.y);e.z=Math.abs(e.z);c=c*e.y*e.z+d*e.x*e.z+f*e.x*e.y;c=Math.sqrt(c/g);return Math.min(pc.math.nextPowerOfTwo(c*b),this.scene.lightmapMaxResolution||2048)},bake:function(m,p){var l,r,t=this.device,u=this.scene,
x=1;void 0===p&&(p=pc.BAKE_COLORDIR);p===pc.BAKE_COLORDIR&&(x=2);var v;p=[];var y=[];if(m){var A;for(l=a.length-1;0<=l;l--)for(r=0;r<m.length;r++)if(a[l]===m[r]){for(A=0;A<b[l].length;A++)b[l][A].destroy();b.splice(l,1);a.splice(l,1)}A=[];for(l=0;l<m.length;l++)d(m[l],A,y);m=A;d(this.root,null,null,p)}else{for(l=0;l<b.length;l++)for(r=0;r<b[l].length;r++)b[l][r].destroy();b=[];a=[];m=[];d(this.root,m,y,p)}if(0===m.length)t.fire("lightmapper:end",{timestamp:pc.now(),target:this});else{A=!1;u._needsStaticPrepare&&
(u._needsStaticPrepare=!1,A=!0);var z=[],E=[[],[]],C={};r=new pc.Texture(this.device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8_A8,rgbm:!0});r.name="lightmap";for(l=0;l<m.length;l++){var D=this.calculateLightmapSize(m[l]);z.push(D);for(v=0;v<x;v++){var F=new pc.Texture(t,{width:D,height:D,format:pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,rgbm:0===v,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST});F.name="lightmap";E[v].push(F)}if(!C[D]){var I=new pc.Texture(t,{width:D,height:D,format:pc.PIXELFORMAT_R8_G8_B8_A8,
mipmaps:!1,rgbm:!0,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST});I.name="lightmap";I=new pc.RenderTarget(t,I,{depth:!1});C[D]=I}}var G=u.layers;G._update();z=[];D=[];I=[];var B=[],w=G._lights;for(l=0;l<w.length;l++)w[l].enabled&&(F=w[l].mask,0!==(F&4)&&(D.push(F),I.push(w[l].shadowUpdateMode),w[l].mask=4294967295,w[l].shadowUpdateMode=w[l]._type===pc.LIGHTTYPE_DIRECTIONAL?pc.SHADOWUPDATE_REALTIME:pc.SHADOWUPDATE_THISFRAME,z.push(w[l]),w[l].isStatic=!1)),B.push(w[l].enabled),w[l].enabled=
!1;var H=pc.shaderChunks,M="#define UV1LAYOUT\n"+H.transformVS,aa=H.bakeLmEndPS;F=H.createShaderFromCode(t,H.fullscreenQuadVS,H.dilatePS,"lmDilate");var R=t.scope.resolve("source"),T=t.scope.resolve("pixelOffset"),ea=t.scope.resolve("bakeDir"),J=new Float32Array(2);G=G._meshInstances;for(l=0;l<G.length;l++)G[l].node&&G[l].node.getWorldTransform();G=u.fog;var Z=u.ambientLight.r,N=u.ambientLight.g,S=u.ambientLight.b;u.fog=pc.FOG_NONE;u.ambientLight.set(0,0,0);c||(c=new pc.Camera,c._node=new pc.GraphNode,
c.clearColor[0]=0,c.clearColor[1]=0,c.clearColor[2]=0,c.clearColor[3]=0,c.clearDepth=1,c.clearFlags=pc.CLEARFLAG_COLOR,c.clearStencil=null,c.frustumCulling=!1);var P,Y=[];Y.length=a.length;for(P=0;P<p.length;P++){var U=p[P].model.model.meshInstances;var K=[];for(l=0;l<U.length;l++)K.push(U[l]._shaderDefs),U[l]._shaderDefs&=~(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM);for(l=0;l<a.length;l++)if(a[l]===p[P]){Y[l]=K;break}}K=[];var V=[];for(P=0;P<p.length;P++)if(K[P]=p[P].model.castShadows,p[P].model.castShadows=
p[P].model.castShadowsLightmap,p[P].model.castShadowsLightmap){var L=p[P].model.meshInstances;for(l=0;l<L.length;l++)L[l].visibleThisFrame=!0,V.push(L[l])}this.renderer.updateCpuSkinMatrices(V);this.renderer.gpuUpdate(V);var Q=[],X=[];L=[[],[]];var ba=[];ba.length=m.length;for(v=0;v<x;v++)h[v]||(l=new pc.StandardMaterial,l.chunks.transformVS=M,0===v?(l.chunks.endPS=aa,l.ambient=new pc.Color(0,0,0),l.ambientTint=!0,l.lightMap=r):(l.chunks.basePS=H.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",
l.chunks.endPS=H.bakeDirLmEndPS),l.chunks.outputAlphaPS="\n",l.chunks.outputAlphaOpaquePS="\n",l.chunks.outputAlphaPremulPS="\n",l.cull=pc.CULLFACE_NONE,l.forceUv1=!0,l.update(),l.updateShader(t,u),l.name="lmMaterial"+v,h[v]=l);for(P=0;P<m.length;P++){U=y[P];ba[P]=0;if(0<U.length)for(f.copy(U[0].aabb),l=0;l<U.length;l++)U[l].node.getWorldTransform(),f.add(U[l].aabb);l=new pc.BoundingBox;l.copy(f);X.push(l);for(l=0;l<U.length;l++){var O=U[l];O._shaderDefs&=~(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM);O.mask=
4;O.deleteParameter("texture_lightMap");O.deleteParameter("texture_dirLightMap");O.setParameter("texture_lightMap",O.material.lightMap?O.material.lightMap:r);O.setParameter("texture_dirLightMap",r)}for(v=0;v<x;v++){var ca=E[v][P];var W=new pc.RenderTarget(t,ca,{depth:!1});L[v].push(W)}}for(r=0;r<z.length;r++)z[r].enabled=!1;H=[[],[],[]];M=!1;for(l=0;l<z.length;l++){z[l].enabled=!0;aa=!1;z[l]._cacheShadowMap=!0;z[l]._type!==pc.LIGHTTYPE_DIRECTIONAL&&(z[l]._node.getWorldTransform(),z[l].getBoundingSphere(n),
g.center=n.center,g.halfExtents.x=n.radius,g.halfExtents.y=n.radius,g.halfExtents.z=n.radius);if(z[l]._type===pc.LIGHTTYPE_SPOT){r=z[l];var da=this.renderer.getShadowCamera(t,r);da._node.setPosition(r._node.getPosition());da._node.setRotation(r._node.getRotation());da._node.rotateLocal(-90,0,0);da.projection=pc.PROJECTION_PERSPECTIVE;da.nearClip=r.attenuationEnd/1E3;da.farClip=r.attenuationEnd;da.aspectRatio=1;da.fov=2*r._outerConeAngle;this.renderer.updateCameraFrustum(da)}0<y.length&&this.renderer.updateShaders(y[0]);
for(P=0;P<m.length;P++){U=y[P];f=X[P];if(z[l]._type===pc.LIGHTTYPE_DIRECTIONAL)e.copy(f.center),e.y+=f.halfExtents.y,c._node.setPosition(e),c._node.setEulerAngles(-90,0,0),r=Math.max(f.halfExtents.x,f.halfExtents.z),c.projection=pc.PROJECTION_ORTHOGRAPHIC,c.nearClip=0,c.farClip=2*f.halfExtents.y,c.aspectRatio=1,c.orthoHeight=r;else if(!g.intersects(f))continue;if(z[l]._type===pc.LIGHTTYPE_SPOT){v=!1;for(r=0;r<U.length;r++)if(this.renderer._isVisible(da,U[r])){v=!0;break}if(!v)continue}z[l]._type===
pc.LIGHTTYPE_DIRECTIONAL?(H[pc.LIGHTTYPE_DIRECTIONAL][0]=z[l],H[pc.LIGHTTYPE_POINT].length=0,H[pc.LIGHTTYPE_SPOT].length=0,!aa&&z[l].castShadows&&(this.renderer.cullDirectionalShadowmap(z[l],V,c,0),this.renderer.renderShadows(H[pc.LIGHTTYPE_DIRECTIONAL],0),aa=!0)):(H[pc.LIGHTTYPE_DIRECTIONAL].length=0,z[l]._type===pc.LIGHTTYPE_POINT?(H[pc.LIGHTTYPE_POINT][0]=z[l],H[pc.LIGHTTYPE_SPOT].length=0,!aa&&z[l].castShadows&&(this.renderer.cullLocalShadowmap(z[l],V),this.renderer.renderShadows(H[pc.LIGHTTYPE_POINT]),
aa=!0)):(H[pc.LIGHTTYPE_POINT].length=0,H[pc.LIGHTTYPE_SPOT][0]=z[l],!aa&&z[l].castShadows&&(this.renderer.cullLocalShadowmap(z[l],V),this.renderer.renderShadows(H[pc.LIGHTTYPE_SPOT]),aa=!0)));for(r=0;r<U.length;r++)Q[r]=U[r].material;for(v=0;v<x;v++){ca=E[v][P];W=L[v][P];O=C[ca.width];var fa=O.colorBuffer;0===v?M=u.updateShaders:M&&(u.updateShaders=!0);for(r=0;r<U.length;r++)U[r].material=h[v];1<x&&this.renderer.updateShaders(U);this.renderer.setCamera(c,O,!0);1===v&&ea.setValue(z[l].bakeDir?1:0);
this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(c,U,U.length,H,pc.SHADER_FORWARDHDR);E[v][P]=fa;L[v][P]=O;C[ca.width]=W;for(r=0;r<U.length;r++)O=U[r],O.setParameter(k[v],fa),O._shaderDefs|=pc.SHADERDEF_LM}ba[P]++;for(r=0;r<U.length;r++)U[r].material=Q[r]}z[l].enabled=!1;z[l]._cacheShadowMap=!1;z[l]._isCachedShadowMap&&z[l]._destroyShadowMap()}for(P=0;P<m.length;P++){U=y[P];da=[];for(v=0;v<x;v++){ca=E[v][P];W=L[v][P];O=C[ca.width];fa=O.colorBuffer;J[0]=1/ca.width;
J[1]=1/ca.height;T.setValue(J);for(l=0;4>l;l++)R.setValue(ca),pc.drawQuadWithShader(t,O,F),R.setValue(fa),pc.drawQuadWithShader(t,W,F);for(l=0;l<U.length;l++)O=U[l],O.mask=2,U[l].setParameter(k[v],ca),1===v&&(U[l]._shaderDefs|=pc.SHADERDEF_DIRLM);da[v]=ca;v===x-1&&W.destroy()}b.push(da);a.push(m[P])}for(var ha in C)C.hasOwnProperty(ha)&&(C[ha].colorBuffer.destroy(),C[ha].destroy());for(l=0;l<b.length;l++)for(r=0;r<b[l].length;r++)F=b[l][r],F.minFilter=pc.FILTER_LINEAR,F.magFilter=pc.FILTER_LINEAR;
for(P=0;P<p.length;P++)p[P].model.castShadows=K[P];for(l=0;l<Y.length;l++)if(Y[l])for(U=a[l].model.model.meshInstances,r=0;r<U.length;r++)U[r]._shaderDefs|=Y[l][r]&(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM);for(l=0;l<z.length;l++)z[l].mask=D[l],z[l].shadowUpdateMode=I[l];for(l=0;l<w.length;l++)w[l].enabled=B[l];u.fog=G;u.ambientLight.set(Z,N,S);A&&(u._needsStaticPrepare=!0)}}});return{Lightmapper:m}}());Object.assign(pc,function(){function d(a,b){if(a&&!b||!a&&b)return!1;a=a.data;b=b.data;if(a===b)return!0;if(a instanceof Float32Array&&b instanceof Float32Array){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}return!1}function b(a,b){for(var c in a)if(a.hasOwnProperty(c)&&!d(a[c],b[c]))return!1;for(c in b)if(b.hasOwnProperty(c)&&!d(b[c],a[c]))return!1;return!0}function a(a,b){var c;for(c=0;c<a.length;c++)if(0>b.indexOf(a[c]))return!1;for(c=0;c<b.length;c++)if(0>
a.indexOf(b[c]))return!1;return!0}function c(a){a=a.node.worldTransform;a.getX(n);a.getY(k);a.getZ(h);n.cross(n,k);return 0<=n.dot(h)?1:-1}var e=function(a,b,c,d,e){this.dynamic=c;this.maxAabbSize=d;this.id=a;this.name=b;this.layers=void 0===e?[pc.LAYERID_WORLD]:e;this._sprite=this._ui=!1;this._obj={model:[],element:[],sprite:[]}};e.MODEL="model";e.ELEMENT="element";e.SPRITE="sprite";var f=function(a,b,c){this.device=a;this.rootNode=c;this._dirty=!0;this.bones=b;b=b.length;a.supportsBoneTextures?
(b=256<b?64:64<b?32:16<b?16:8,this.boneTexture=new pc.Texture(a,{width:b,height:b,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),this.boneTexture.name="batching",this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*b)};Object.assign(f.prototype,{updateMatrices:function(a){},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,c,d=this.bones.length-1;0<=d;d--)a=this.bones[d].getWorldTransform().data,c=16*d,b[c]=
a[0],b[c+1]=a[1],b[c+2]=a[2],b[c+3]=a[3],b[c+4]=a[4],b[c+5]=a[5],b[c+6]=a[6],b[c+7]=a[7],b[c+8]=a[8],b[c+9]=a[9],b[c+10]=a[10],b[c+11]=a[11],b[c+12]=a[12],b[c+13]=a[13],b[c+14]=a[14],b[c+15]=a[15];this.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}});var g=function(a,b,c){this.device=a;this.rootNode=b;this.scene=c;this._init=!1;this._batchGroups={};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]};g.prototype.destroyManager=function(){this.scene=
this.rootNode=this.device=null;this._batchGroups={};this._batchList=[];this._dirtyGroups=[]};g.prototype.addGroup=function(a,b,c,d,e){void 0===d&&(d=this._batchGroupCounter,this._batchGroupCounter++);if(!this._batchGroups[d])return this._batchGroups[d]=a=new pc.BatchGroup(d,a,b,c,e)};g.prototype.removeGroup=function(a){if(this._batchGroups[a]){for(var b=[],c=0;c<this._batchList.length;c++)this._batchList[c].batchGroupId!==a?b.push(this._batchList[c]):this.destroy(this._batchList[c]);this._batchList=
b;this._removeModelsFromBatchGroup(this.rootNode,a);delete this._batchGroups[a]}};g.prototype.markGroupDirty=function(a){0>this._dirtyGroups.indexOf(a)&&this._dirtyGroups.push(a)};g.prototype.getGroupByName=function(a){var b=this._batchGroups,c;for(c in b)if(b.hasOwnProperty(c)&&b[c].name===a)return b[c];return null};g.prototype.getBatches=function(a){for(var b=[],c=this._batchList.length,d=0;d<c;d++){var e=this._batchList[d];e.batchGroupId===a&&b.push(e)}return b};g.prototype._removeModelsFromBatchGroup=
function(a,b){if(a.enabled){a.model&&a.model.batchGroupId===b&&(a.model.batchGroupId=-1);a.element&&a.element.batchGroupId===b&&(a.element.batchGroupId=-1);a.sprite&&a.sprite.batchGroupId===b&&(a.sprite.batchGroupId=-1);for(var c=0;c<a._children.length;c++)this._removeModelsFromBatchGroup(a._children[c],b)}};g.prototype.insert=function(a,b,c){var d=this._batchGroups[b];d&&0>d._obj[a].indexOf(c)&&(d._obj[a].push(c),this.markGroupDirty(b))};g.prototype.remove=function(a,b,c){var d=this._batchGroups[b];
d&&(c=d._obj[a].indexOf(c),0<=c&&(d._obj[a].splice(c,1),this.markGroupDirty(b)))};g.prototype._extractModel=function(a,b,c,d){if(!a.model||!a.model.model)return b;if(a.model.isStatic){d=this.scene.drawCalls;var e=a.model.meshInstances;for(c=0;c<d.length;c++)d[c]._staticSource&&(0>e.indexOf(d[c]._staticSource)||b.push(d[c]));for(c=0;c<e.length;c++)0<=d.indexOf(e[c])&&b.push(e[c])}else b=d[a.model.batchGroupId]=b.concat(a.model.meshInstances);a.model.removeModelFromLayers();return b};g.prototype._extractElement=
function(a,b,c){if(a.element){var d=!1;a.element._text&&0<a.element._text._model.meshInstances.length?(b.push(a.element._text._model.meshInstances[0]),a.element.removeModelFromLayers(a.element._text._model),d=!0):a.element._image&&(b.push(a.element._image._renderable.meshInstance),a.element.removeModelFromLayers(a.element._image._renderable.model),a.element._image._renderable.unmaskMeshInstance&&(b.push(a.element._image._renderable.unmaskMeshInstance),a.element._image._renderable.unmaskMeshInstance.stencilFront&&
a.element._image._renderable.unmaskMeshInstance.stencilBack||(a.element._dirtifyMask(),a.element._onPrerender())),d=!0);d&&(c._ui=!0)}};g.prototype._collectAndRemoveModels=function(a,b){for(var c,d,e,f=0;f<b.length;f++)if(c=b[f],d=this._batchGroups[c]){(e=a[c])||(e=a[c]=[]);for(c=0;c<d._obj.model.length;c++)e=this._extractModel(d._obj.model[c],e,d,a);for(c=0;c<d._obj.element.length;c++)this._extractElement(d._obj.element[c],e,d);for(var g=0;g<d._obj.sprite.length;g++)c=d._obj.sprite[g],c.sprite&&
c.sprite._meshInstance&&(d.dynamic||c.sprite.sprite._renderMode===pc.SPRITE_RENDERMODE_SIMPLE)&&(e.push(c.sprite._meshInstance),c.sprite.removeModelFromLayers(),d._sprite=!0,c.sprite._batchGroup=d)}};g.prototype.generate=function(a){var b,c={};a||(a=Object.keys(this._batchGroups));var d=[];for(b=0;b<this._batchList.length;b++)0>a.indexOf(this._batchList[b].batchGroupId)?d.push(this._batchList[b]):this.destroy(this._batchList[b]);this._batchList=d;this._collectAndRemoveModels(c,a);if(a===this._dirtyGroups)this._dirtyGroups.length=
0;else{d=[];for(b=0;b<this._dirtyGroups.length;b++)0>a.indexOf(this._dirtyGroups[b])&&d.push(this._dirtyGroups[b]);this._dirtyGroups=d}var e,f;for(f in c)if(c.hasOwnProperty(f)&&(b=c[f],a=this._batchGroups[f])){var g=this.prepare(b,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(b=0;b<g.length;b++)if(e=this.create(g[b],a.dynamic,parseInt(f,10)))for(d=0;d<a.layers.length;d++){var h=this.scene.layers.getLayerById(a.layers[d]);h&&h.addMeshInstances(e.model.meshInstances)}}};var n=new pc.Vec3,k=new pc.Vec3,
h=new pc.Vec3;g.prototype.prepare=function(d,e,f,g){if(0===d.length)return[];void 0===f&&(f=Number.POSITIVE_INFINITY);f*=.5;var h=this.device.supportsBoneTextures?1024:this.device.boneLimit,k=this.device.extUintElement?4294967295:65535,l=new pc.BoundingBox,m=new pc.BoundingBox,n=null,p,q=[],z,E=0;g&&d.sort(function(a,b){return a.drawOrder-b.drawOrder});for(var C=d,D,F=g?function(a){n?n.add(a.aabb):n=a.aabb.clone();D.push(a)}:function(a){D.push(a)};0<C.length;){q[E]=[C[0]];D=[];d=C[0].material;var I=
C[0].layer;var G=C[0]._shaderDefs;var B=C[0].parameters;var w=C[0].stencilFront;var H=C[0]._staticLightList;var M=C[0].mesh.vertexBuffer.getNumVertices();var aa=C[0].drawOrder;l.copy(C[0].aabb);var R=c(C[0]);var T=C[0].mesh.vertexBuffer.format.batchingHash;var ea=C[0].mesh.primitive[0].indexed;n=null;for(z=1;z<C.length;z++){var J=C[z];if(e&&q[E].length>=h){D=D.concat(C.slice(z));break}if(d!==J.material||I!==J.layer||T!==J.mesh.vertexBuffer.format.batchingHash||ea!==J.mesh.primitive[0].indexed||G!==
J._shaderDefs||M+J.mesh.vertexBuffer.getNumVertices()>k)F(J);else if(m.copy(l),m.add(J.aabb),m.halfExtents.x>f||m.halfExtents.y>f||m.halfExtents.z>f)F(J);else if(!w||(p=J.stencilFront)&&w.func==p.func&&w.zpass==p.zpass)if(R!=c(J))F(J);else if(b(B,J.parameters)){var Z=J._staticLightList;if(H&&Z){if(!a(H,Z)){F(J);continue}}else if(H||Z){F(J);continue}g&&n&&n.intersects(J.aabb)&&J.drawOrder!==aa?F(J):(l.add(J.aabb),M+=J.mesh.vertexBuffer.getNumVertices(),q[E].push(J))}else F(J);else F(J)}E++;C=D}return q};
g.prototype.create=function(a,b,d){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+pc.shaderChunks.transformVS,this.skinTexVS=pc.shaderChunks.skinBatchTexVS,this.skinConstVS=pc.shaderChunks.skinBatchConstVS,this.vertexFormats={},this._init=!0);var e,g,h=null,k=null,l=0,m=0,n=null;for(e=0;e<a.length;e++)if(a[e].visible){var p=a[e].mesh;var z=p.vertexBuffer.numVertices;l+=z;m+=p.primitive[0].indexed?p.primitive[0].count:p.primitive[0].type==
pc.PRIMITIVE_TRIFAN&&4===p.primitive[0].count?6:0;if(!h){k=a[e].material;h={};z=p.vertexBuffer.format.elements;for(g=0;g<z.length;g++){var E=z[g].name;h[E]={numComponents:z[g].numComponents,dataType:z[g].dataType,normalize:z[g].normalize,count:0}}b&&(h[pc.SEMANTIC_BLENDINDICES]={numComponents:1,dataType:pc.ELEMENTTYPE_FLOAT32,normalize:!1,count:0})}}if(h){n=new pc.Batch(a,b,d);this._batchList.push(n);var C=0,D=0,F,I=new pc.Vec3;m=new (65535>=l?Uint16Array:Uint32Array)(m);for(E in h){var G=h[E];G.typeArrayType=
pc.typedArrayTypes[G.dataType];G.elementByteSize=pc.typedArrayTypesByteSize[G.dataType];G.buffer=new G.typeArrayType(l*G.numComponents)}for(e=0;e<a.length;e++)if(a[e].visible){p=a[e].mesh;z=p.vertexBuffer.numVertices;b||(F=a[e].node.getWorldTransform());for(E in h)if(E!==pc.SEMANTIC_BLENDINDICES){G=h[E];l=new G.typeArrayType(G.buffer.buffer,G.elementByteSize*G.count);var B=p.getVertexStream(E,l)*G.numComponents;G.count+=B;if(!b&&3<=G.numComponents&&(E==pc.SEMANTIC_POSITION||E==pc.SEMANTIC_NORMAL||
E==pc.SEMANTIC_TANGENT))for(F.transformFunction=E==pc.SEMANTIC_POSITION?pc.Mat4.prototype.transformPoint:pc.Mat4.prototype.transformVector,g=0;g<B;g+=G.numComponents)I.set(l[g],l[g+1],l[g+2]),F.transformFunction(I,I),l[g]=I.x,l[g+1]=I.y,l[g+2]=I.z}if(b)for(G=h[pc.SEMANTIC_BLENDINDICES],g=0;g<z;g++)G.buffer[G.count++]=e;if(p.primitive[0].indexed)G=p.primitive[0].base,l=p.primitive[0].count,g=p.indexBuffer[0].getFormat(),p=new pc.typedArrayIndexFormats[g](p.indexBuffer[0].storage);else if(p.primitive[0].type==
pc.PRIMITIVE_TRIFAN&&4===p.primitive[0].count)G=0,l=6,p=[0,1,3,2,3,1];else continue;for(g=0;g<l;g++)m[g+D]=p[G+g]+C;D+=l;C+=z}p=new pc.Mesh(this.device);for(E in h)G=h[E],p.setVertexStream(E,G.buffer,G.numComponents,void 0,G.dataType,G.normalize);0<m.length&&p.setIndices(m);p.update(pc.PRIMITIVE_TRIANGLES,!1);b&&(k=k.clone(),k.chunks.transformVS=this.transformVS,k.chunks.skinTexVS=this.skinTexVS,k.chunks.skinConstVS=this.skinConstVS,k.update());a=new pc.MeshInstance(this.rootNode,p,k);a.castShadow=
n.origMeshInstances[0].castShadow;a.parameters=n.origMeshInstances[0].parameters;a.isStatic=n.origMeshInstances[0].isStatic;a.layer=n.origMeshInstances[0].layer;a._staticLightList=n.origMeshInstances[0]._staticLightList;a._shaderDefs=n.origMeshInstances[0]._shaderDefs;a.cull=n.origMeshInstances[0].cull;(e=this._batchGroups[d])&&e._ui&&(a.cull=!1);if(b){b=[];for(e=0;e<n.origMeshInstances.length;e++)b.push(n.origMeshInstances[e].node);a.skinInstance=new f(this.device,b,this.rootNode)}a._updateAabb=
!1;a.drawOrder=n.origMeshInstances[0].drawOrder;a.stencilFront=n.origMeshInstances[0].stencilFront;a.stencilBack=n.origMeshInstances[0].stencilBack;a.flipFaces=0>c(n.origMeshInstances[0]);n.meshInstance=a;this.update(n);b=new pc.Model;b.meshInstances=[n.meshInstance];b.castShadows=n.origMeshInstances[0].castShadows;n.model=b}return n};g.prototype.update=function(a){a._aabb.copy(a.origMeshInstances[0].aabb);for(var b=1;b<a.origMeshInstances.length;b++)a._aabb.add(a.origMeshInstances[b].aabb);a.meshInstance.aabb=
a._aabb;a._aabb._radiusVer=-1;a.meshInstance._aabbVer=0};g.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var a=0;a<this._batchList.length;a++)this._batchList[a].dynamic&&this.update(this._batchList[a])};g.prototype.clone=function(a,b){var c=new pc.Batch(b,a.dynamic,a.batchGroupId);this._batchList.push(c);for(var d=[],e=0;e<b.length;e++)d.push(b[e].node);c.meshInstance=new pc.MeshInstance(a.meshInstance.node,a.meshInstance.mesh,a.meshInstance.material);
c.meshInstance._updateAabb=!1;c.meshInstance.parameters=b[0].parameters;c.meshInstance.isStatic=b[0].isStatic;c.meshInstance.cull=b[0].cull;c.meshInstance.layer=b[0].layer;c.meshInstance._staticLightList=b[0]._staticLightList;a.dynamic&&(c.meshInstance.skinInstance=new f(this.device,d,this.rootNode));c.meshInstance.castShadow=a.meshInstance.castShadow;c.meshInstance._shader=a.meshInstance._shader;b=new pc.Model;b.meshInstances=[c.meshInstance];b.castShadows=a.origMeshInstances[0].castShadows;c.model=
b;return c};g.prototype.destroy=function(a){a.refCounter=0;if(a.model){for(var b=this._batchGroups[a.batchGroupId].layers,c=0;c<b.length;c++){var d=this.scene.layers.getLayerById(b[c]);d&&d.removeMeshInstances(a.model.meshInstances)}a.model.destroy()}};g.prototype.decrement=function(a){a.refCounter--;0===a.refCounter&&this.destroy(a)};return{Batch:function(a,b,c){this.origMeshInstances=a;this._aabb=new pc.BoundingBox;this.model=this.meshInstance=null;this.dynamic=b;this.batchGroupId=c;this.refCounter=
0},BatchGroup:e,BatchManager:g}}());

return pc;
}));

